
<!--Preface-->

<div class="frontmatters">
<div class="page-frontmatter preface front set-front-matter">
<div class="title-name">
<h2 id="maintitle">Python Automation Cookbook</h2>
</div>

<p>Explore the world of automation using Python recipes that will enhance your skills</p>
<p>Jaime Buelta</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000065.png" class="lazyload" /></p>
<p><strong><strong>BIRMINGHAM - MUMBAI</strong></strong></p>
<p>Copyright &copy; 2018 Packt Publishing</p>
<p>All rights reserved. No part of this book may be reproduced, stored in a retrieval system, or transmitted in any form or by any means, without the prior written permission of the publisher, except in the case of brief quotations embedded in critical articles or reviews.</p>
<p>Every effort has been made in the preparation of this book to ensure the accuracy of the information presented. However, the information contained in this book is sold without warranty, either express or implied. Neither the author, nor Packt Publishing or its dealers and distributors, will be held liable for any damages caused or alleged to have been caused directly or indirectly by this book.</p>
<p>Packt Publishing has endeavored to provide trademark information about all of the companies and products mentioned in this book by the appropriate use of capitals. However, Packt Publishing cannot guarantee the accuracy of this information.</p>
<p><strong>Commissioning Editor:</strong>&nbsp;Aaron Lazar<br /><strong>Acquisition Editor:</strong> Shriram Shekhar<br /><strong>Content Development Editor:</strong> Manjusha Mantri<br /><strong>Technical Editor:</strong> Adhithya Haridas<br /><strong>Copy Editor:</strong> Safis Editing<br /><strong>Project Coordinator:</strong> Prajakta Naik<br /><strong>Proofreader:</strong> Safis Editing<br /><strong>Indexer:&nbsp;</strong>Mariammal Chettiyar<br /><strong>Graphics:</strong> Jisha Chirayil<br /><strong>Production Coordinator:</strong> Shantanu Zagade</p>
<p>First published: September 2018</p>
<p>Production reference: 1260918</p>
<p>Published by Packt Publishing Ltd.<br />Livery Place<br />35 Livery Street<br />Birmingham<br />B3 2PB, UK.</p>
<p>ISBN 978-1-78913-380-6</p>
<p><a href="http://www.packtpub.com" target="_blank" rel="noopener">www.packtpub.com</a></p>
<p><em>&nbsp;</em></p>
<p>In loving memory of Banjo</p>

<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000071.png" class="lazyload" /></p>

<p><a href="https://mapt.io/" target="_blank" rel="noopener">mapt.io</a></p>
<p>Mapt is an online digital library that gives you full access to over 5,000 books and videos, as well as industry leading tools to help you plan your personal development and advance your career. For more information, please visit our website.</p>

<h3>PacktPub.com</h3>
<p>Did you know that Packt offers eBook versions of every book published, with PDF and ePub files available? You can upgrade to the eBook version at <a href="http://www.packt.com" target="_blank" rel="noopener">www.packt.com</a> and as a print book customer, you are entitled to a discount on the eBook copy. Get in touch with us at <kbd>customercare@packtpub.com</kbd> for more details.</p>
<p>At <a href="http://www.packt.com" target="_blank" rel="noopener">www.packt.com</a>, you can also read a collection of free technical articles, sign up for a range of free newsletters, and receive exclusive discounts and offers on Packt books and eBooks.</p>
<h2>Contributors</h2>
<h3>About the author</h3>
<p><strong>Jaime Buelta</strong> has been a professional programmer and a full-time Python developer and has been exposed to a lot of different technologies over his career. He has developed software for a variety of fields and industries, including aerospace, networking and communications, industrial SCADA systems, video game online services, and finance services. As part of these companies, he worked closely with various areas, such as marketing, management, sales, and game design, helping the companies achieve to their goals. He is a strong proponent of automating everything and making computers do most of the heavy lifting so users can focus on the important stuff. He is currently living in Dublin, Ireland, and has been a regular speaker at PyCon Ireland.</p>
<blockquote>
<p>This book could not have happened without the support and encouragement of my amazing wife, Dana. I also want to thank the team at Packt, especially Manjusha for her huge help in the process, and Shriram for encouraging me to write the book. Also, great thanks to Mario for reviewing the book and improving it. Finally, I'd like to thank the whole Python community. I can't overstate what a joy it is to work as a developer in the Python world.</p>
</blockquote>
<h3>About the reviewer</h3>

<p><strong>Mario Corchero</strong> is a senior software developer at Bloomberg. He leads the Python infrastructure team in London, enabling the company to work effectively in Python and building company-wide libraries and tools. His professional experience is mainly in C++ and Python, and he has contributed some patches to multiple Python open source projects. He is a PSF fellow, having received the Q3 2018 PSF Community Award, is vice president of Python Espa&ntilde;a (the Python Spain association), and has served as Chair of PyLondinium, PyConES17, and PyCon Charlas at PyCon 2018. Mario is passionate about the Python community, open source, and inner source.</p>

<h3>Packt is searching for authors like you</h3>
<p>If you're interested in becoming an author for Packt, please visit <a href="http://authors.packtpub.com" target="_blank" rel="noopener">authors.packtpub.com</a> and apply today. We have worked with thousands of developers and tech professionals, just like you, to help them share their insight with the global tech community. You can make a general application, apply for a specific hot topic that we are recruiting an author for, or submit your own idea.</p>


<h2>Preface</h2>
<p>We are all probably spending time doing small manual tasks that don't add much value. It may be scanning through information sources in search of the small bits of relevant information, working with spreadsheets to generate the same graph over and over, or searching files one by one until find the data we're looking for. Some&mdash;probably most&mdash;of those tasks are, in fact, automatable. There's an investment upfront, but for the tasks that get repeated over and over, we can use computers to do these kinds of menial tasks and focus our own efforts instead on what humans are good for&mdash;high-level analysis and decision making based on the result. This book will explain how to use the Python language to automatize common business tasks that can be greatly sped up if a computer is doing them.</p>
<p>Given the expressiveness and ease of use of Python, it's surprisingly simple to start making small programs to perform these actions and combine them into more integrated systems. Throughout the book, we will show small, easy-to-follow recipes that can be adapted to your specific needs, and we will combine them to perform more complex actions. We will perform common actions, such as detecting opportunities by scraping the web, analyzing information to generate automatic spreadsheet reports with graphs, communicating with automatically generated emails, getting notifications via text messages, and learning how to run tasks while your mind is focused on other more important stuff.</p>
<p>Though some Python knowledge is required, the book is written with non-programmers in mind, giving clear and instructive recipes that will further the reader's proficiency while being oriented to specific day-to-day goals.</p>
<h1>Who this book is for</h1>
<p>This book is for Python beginners, not necessarily developers, that want to use and expand their knowledge to automate tasks. Most of the examples in the book are aimed at marketing, sales, and other non-tech areas. The reader needs to know a little of the Python language, including its basic concepts.</p>
<h2>What this book covers</h2>
<p>Chapter 1, <em>Let Us Begin Our Automation Journey,&nbsp;</em>&nbsp;presents some basic content that will be used all through the book. It describes how to install and manage third-party tools through virtual environments, how to do effective string manipulation, how to use command-line arguments, and introduces you to regular expressions and other methods of text processing.</p>
<p>Chapter 2,&nbsp;<em>Automating Tasks Made Easy</em>, shows how to prepare and automatically run tasks. It covers how to program tasks to be executed when they should, instead of running them manually; how to be notified with the result of a task that's run automatically;&nbsp;and how to be notified if there has been an error in an automated process.</p>
<p>Chapter 3, <em>Building Your First Web Scraping Application</em>,&nbsp;explores sending web requests to communicate with external websites in different formats, such as raw HTML content; structured feeds; RESTful APIs; and even automating a browser to execute steps without manual intervention. It also covers how to process results to extract relevant information.&nbsp;</p>
<p>Chapter 4, <em>Searching and Reading Local Files</em>, explains how to search through local files and directories and analyze the information stored there. You will learn how to filter through relevant files in different encodings and read files in several common formats, such as CSVs, PDFs, Word documents, and even images.</p>
<p>Chapter 5, <em>Generating Fantastic Reports</em>, looks at how to display information given in text format in multiple formats. This includes creating templates to produce text files, as well as creating richly formatted and properly styled Word and PDF documents.</p>
<p>Chapter 6, <em>Fun with Spreadsheets</em>,&nbsp;explores how to read and write spreadsheets in the CSV format; in rich Microsoft Excel, including with formatting and charts; and in LibreOffice, a free alternative to Microsoft Excel.&nbsp;</p>
<p>Chapter 7, <em>Developing Stunning Graphs</em>, explain how to produce beautiful charts, including common examples such as pie, line, and bar charts, as well as other advanced cases, such as stacked bars and even maps. It also explains how multiple graphs can be combined and styled to generate rich graphics and show relevant information in an understandable format.</p>
<p>Chapter 8, <em>Dealing with Communication Channels</em>, explains how to send messages in multiple channels, using external tools to do the most of the heavy lifting. This chapter goes into sending and receiving emails individually&nbsp;as well as <em>en masse</em>, communicating through SMS messages, and creating a bot in Telegram.</p>
<p>Chapter 9, <em>Why Not Automate Your Marketing Campaign?</em>,&nbsp;combines the different recipes included in the book to generate a full marketing campaign, including steps such as detection of opportunity, generation of promotion, communication to potential customers, and analyzing and reporting sales produced by promotion. This chapter shows how to combine different elements to create powerful systems.</p>
<p>Chapter 10, <em>Debugging Techniques</em>,&nbsp;features different methods and tips to help in the debugging process and ensure the quality of your software. It leverages the great introspection capabilities of Python and its out-of-the-box debugging tools for fixing problems and producing solid automated software.</p>
<h2>To get the most out of this book</h2>
<p>Before reading this book, readers need to know the basics of the Python language. We do not assume that the reader is an expert in the language.</p>
<p>The reader needs to know how to input commands in the command line (Terminal, Bash, or equivalent).</p>
<p>To understand the code in this book, you need a text editor, which will enable you to read and edit the code. You can use an IDE that supports the Python language, such as PyCharm and PyDev&mdash;which you choose is up to you. Check out this link for ideas about IDEs:&nbsp;<a href="https://realpython.com/python-ides-code-editors-guide/">https://realpython.com/python-ides-code-editors-guide/</a>.</p>
<h3>Download the example code files</h3>
<p>You can download the example code files for this book from your account at <a href="http://www.packt.com" target="_blank" rel="noopener">www.packt.com</a>. If you purchased this book elsewhere, you can visit <a href="http://www.packt.com/support" target="_blank" rel="noopener">www.packt.com/support</a> and register to have the files emailed directly to you.</p>
<p>You can download the code files by following these steps:</p>
<ol>
<li>Log in or register at <a href="http://www.packt.com/support" target="_blank" rel="noopener">www.packt.com</a>.</li>
<li>Select the SUPPORT tab.</li>
<li>Click on Code Downloads &amp; Errata.</li>
<li>Enter the name of the book in the Search box and follow the onscreen instructions.</li>
</ol>
<p>Once the file is downloaded, please make sure that you unzip or extract the folder using the latest version of:</p>
<ul>
<li>WinRAR/7-Zip for Windows</li>
<li>Zipeg/iZip/UnRarX for Mac</li>
<li>7-Zip/PeaZip for Linux</li>
</ul>
<p>The code bundle for the book is also hosted on GitHub at <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook">https://github.com/PacktPublishing/Python-Automation-Cookbook</a>.&nbsp;In case there's an update to the code, it will be updated on the existing GitHub repository.</p>
<p>We also have other code bundles from our rich catalog of books and videos available at&nbsp;<strong><a href="https://github.com/PacktPublishing/" target="_blank" rel="noopener">https://github.com/PacktPublishing/</a></strong>. Check them out!</p>
<h1>Download the color images</h1>
<p>We also provide a PDF file that has color images of the screenshots/diagrams used in this book. You can download it <a href="https://www.packtpub.com/sites/default/files/downloads/9781789133806_ColorImages.pdf">https://www.packtpub.com/sites/default/files/downloads/9781789133806_ColorImages.pdf</a>.</p>
<h2>Conventions used</h2>
<p>There are a number of text conventions used throughout this book.</p>
<p><kbd>CodeInText</kbd>: Indicates code words in text, object names, module names, folder names, filenames, file extensions, pathnames, dummy URLs and user input. Here is an example: "For this recipe, we need to import the&nbsp;<kbd>requests</kbd> module."</p>
<p>A block of code is set as follows:</p>
<pre><code class="lang-python"># IMPORTS
from sale_log import SaleLog

def get_logs_from_file(shop, log_filename):
def main(log_dir, output_filename):
    ...

if __name__ == '__main__':
  # PARSE COMMAND LINE ARGUMENTS AND CALL main()</code></pre>
<p>Note that code may be edited for concision and clarity. Refer to the full code when necessary, which is available at GitHub.</p>
<p>Any command-line input or output is written as follows (notice the <kbd>$</kbd> symbol):</p>
<pre><code class="lang-python">$ python execute_script.py parameters</code></pre>
<p>Any input in the Python interpreter is written as follows (notice the <kbd>&gt;&gt;&gt;</kbd> symbol):</p>
<pre><code class="lang-python">&gt;&gt;&gt; import delorean
&gt;&gt;&gt; timestamp = delorean.utcnow().datetime.isoformat()</code></pre>
<p>To enter inside the Python interpreter, call the&nbsp;<kbd>python3</kbd>&nbsp;command with no parameters:</p>
<pre><code class="lang-python">$ python3 
Python 3.7.0 (default, Aug 22 2018, 15:22:33)
[Clang 9.1.0 (clang-902.0.39.2)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt;</code></pre>
<p><strong>Verify that the Python interpreter is Python 3.7 or higher</strong>. It may be necessary to call <kbd>python</kbd>&nbsp;or <kbd>python3.7</kbd>, depending on your operating system and installation options. See Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey,</em> specifically the&nbsp;<em>Creating a virtual environment</em>&nbsp;recipe&mdash;for further details about the use of different Python interpreters.</p>
<p><strong>Bold</strong>: Indicates a new term, an important word, or words that you see onscreen. For example, words in menus or dialog boxes appear in the text like this. Here is an example: "Go to&nbsp;Account&nbsp;|&nbsp;Extras&nbsp;|&nbsp;API keys&nbsp;and create a new one:"</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Warnings or important notes appear like this.</p>
</div>
</div>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Tips and tricks appear like this.</p>
</div>
</div>
<h2>Sections</h2>
<p>In this book, you will find several headings that appear frequently (<em>Getting ready</em>,&nbsp;<em>How to do it...</em>,&nbsp;<em>How it works...</em>,&nbsp;<em>There's more...</em>, and&nbsp;<em>See also</em>).</p>
<h3>Getting ready</h3>
<p>This section tells you what to expect in the recipe and describes how to set up any software or any preliminary settings required for the recipe.</p>
<h3>How to do it...</h3>
<p>This section contains the steps required to follow the recipe.</p>
<h3>How it works...</h3>
<p>This section usually consists of a detailed explanation of what happened in the previous section.</p>
<h3>There's more...</h3>
<p>This section consists of additional information about the recipe in order to make you more knowledgeable about the recipe.</p>
<h3>See also</h3>
<p>This section provides helpful links to other useful information for the recipe.</p>
<h3>Get in touch</h3>
<p>Feedback from our readers is always welcome.</p>
<p><strong>General feedback</strong>: If you have questions about any aspect of this book, please email us at <kbd>customercare@packtpub.com</kbd>.</p>
<p><strong>Errata</strong>: Although we have taken every care to ensure the accuracy of our content, mistakes do happen. If you have found a mistake in this book, we would be grateful if you would report this to us. Please visit <a href="http://www.packt.com/submit-errata" target="_blank" rel="noopener">www.packt.com/submit-errata</a>, selecting your book, clicking on the Errata Submission Form link, and entering the details.</p>
<p><strong>Piracy</strong>: If you come across any illegal copies of our works in any form on the Internet, we would be grateful if you would provide us with the location address or website name. Please contact us at <kbd>copyright@packt.com</kbd> with a link to the material.</p>
<p><strong>If you are interested in becoming an author</strong>: If there is a topic that you have expertise in and you are interested in either writing or contributing to a book, please visit <a href="http://authors.packtpub.com/" target="_blank" rel="noopener">authors.packtpub.com</a>.</p>
<h2>Reviews</h2>
<p>Please leave a review. Once you have read and used this book, why not leave a review on the site that you purchased it from? Potential readers can then see and use your unbiased opinion to make purchase decisions, we at Packt can understand what you think about our products, and our authors can see your feedback on their book. Thank you!</p>
<p>For more information about Packt, please visit&nbsp;<a href="https://www.packt.com/" target="_blank" rel="noopener">packt.com</a>.</p>
</div>
</div>


<!--Chapter 1-->


<div class="chapter" data-chapter-number="1">
<div class="chapter-start">
<div class="ch-head">Chapter <span class="chapter-number"> 1 </span></div>
<h1 class="chaptertitle">Let Us Begin Our Automation Journey</h1>
<h3 class="author">Jaime Buelta</h3>
</div>

<p>In this chapter, we'll cover the following recipes:</p>
<ul>
<li>Creating a virtual environment</li>
<li>Installing third-party packages</li>
<li>Creating strings with formatted values</li>
<li>Manipulating strings</li>
<li>Extracting data from structured strings</li>
<li>Using a third-party tool&mdash;parse</li>
<li>Introducing regular expressions</li>
<li>Going deeper into regular expressions</li>
<li>Adding command-line arguments</li>
</ul>
<h2>Introduction</h2>
<p>The objective of this chapter is to lay down some of the basic techniques that will be useful through this book. The main idea is to be able to create a good Python environment to run the automation tasks that will follow, and be able to parse text inputs into structured data.</p>
<p>Python has a good amount of tools installed by default, but it also makes it easy to install third-party tools that can simplify common operations when processing texts. In this chapter, we'll see how to import modules from external sources and use them to leverage the full potential of Python.</p>
<p>The ability to structure input data is critical in any automation task. Most of the data that we will process in this book will come from unformatted sources such as web pages or text files. As the old computer adage says,&nbsp;<em>garbage in, garbage out</em>,&nbsp;making the sanitizing of inputs a very important task.</p>
<h2>Creating a virtual environment</h2>
<p>As a first step when working with Python, it is a good practice to explicitly&nbsp;define&nbsp;the working environment. This helps with detaching from the operative system interpreter and environment, and properly defining the dependencies that will be used. Not doing so tends to generate chaotic scenarios. Remember, <em>explicit is better than implicit!</em></p>
<p>This is especially important in two scenarios:</p>
<ul>
<li>When dealing with multiple projects on the same computer, as they can have different dependencies that clash at some point. For example, two versions of the same module cannot be installed in the same environment.</li>
<li>When working on a project that will be used on a different computer, for example, developing some code in a personal laptop that will ultimately run in a remote server.</li>
</ul>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>A common joke among developers is responding to a bug with <em>it runs on my machine</em>,&nbsp;meaning that it appears to work on their laptop, but not on the production servers. Although a huge number of factors can produce this error, a good practice is to produce an automatically replicable environment, reducing uncertainty over what dependencies are really being used.</p>
</div>
</div>
<p>This is easy to achieve using the <kbd>virtualenv</kbd> module, which&nbsp;sets up a virtual environment, so none of the installed dependencies will be shared with the Python version installed on the machine.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>In Python3, the&nbsp;<kbd>virtualenv</kbd>&nbsp;tool&nbsp;is installed automatically, which was not the case in previous versions.</p>
</div>
</div>
<h3>Getting ready</h3>
<p>To create a new virtual environment, do the following:</p>
<ol>
<li>Go to the main directory that contains the project.</li>
<li>Type the following command:</li>
</ol>
<pre><code class="lang-python">$ python3 -m venv .venv</code></pre>
<p>This creates a subdirectory called&nbsp;<kbd>.venv</kbd>&nbsp;that contains the virtual environment.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The directory containing the virtual environment can be located anywhere. Keeping it on the same root keeps it handy, and adding a dot in front of it avoids it being displayed when running <kbd>ls</kbd> or other commands.</p>
</div>
</div>
<ol start="3">
<li>Before activating the virtual environment, check the version installed in <kbd>pip</kbd>. This is different depending on your operative system, for example, 9.0.3 for MacOS High Sierra 10.13.4. It will be upgraded later. Also check the referenced Python interpreter, which will be the main operating system one:</li>
</ol>
<pre><code class="lang-python">$ pip --version
pip 9.0.3 from /usr/local/lib/python3.6/site-packages/pip (python 3.6)
$ which python3
/usr/local/bin/python3</code></pre>
<p>Now, your virtual environment is ready to go.</p>
<h3>How to do it...</h3>
<ol>
<li>Activate the virtual environment by running this:</li>
</ol>
<pre><code class="lang-python">$ source .venv/bin/activate</code></pre>
<p>You'll notice that the prompt will display <kbd>(.venv)</kbd>, showing that the virtual environment is active.</p>
<ol start="2">
<li>Notice that the Python interpreter used&nbsp;is the one inside the virtual environment, and not the general operative system one from step 3 of <em>Getting ready</em>. Checking the location within a virtual environment:</li>
</ol>
<pre><code class="lang-python">(.venv) $ which python
/root_dir/.venv/bin/python
(.venv) $ which pip
/root_dir/.venv/bin/pip</code></pre>
<ol start="3">
<li>Upgrade the version of <kbd>pip</kbd> and check the version:</li>
</ol>
<pre><code class="lang-python">(.venv) $ pip install --upgrade pip
...
Successfully installed pip-10.0.1
(.venv) $ pip --version
pip 10.0.1 from /root_dir/.venv/lib/python3.6/site-packages/pip (python 3.6)</code></pre>
<ol start="4">
<li>Get out of the environment and run <kbd>pip</kbd> to check the version, which will return the previous environment. Check the&nbsp;<kbd>pip</kbd> version and the Python interpreter to show the ones before activating the virtual environment ones, as shown in step 3 of the&nbsp;<em>Getting ready</em> section. Note that they are different pip versions!</li>
</ol>
<pre><code class="lang-python">(.venv) $ deactivate 
$ which python3
/usr/local/bin/python3
$ pip --version
pip 9.0.3 from /usr/local/lib/python3.6/site-packages/pip (python 3.6)</code></pre>
<h3>How it works...</h3>
<p>Notice that inside the virtual environment you can use <kbd>python</kbd> instead of <kbd>python3</kbd>, although <kbd>python3</kbd> is available as well. This will use the Python interpreter defined in the environment.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>In some systems like Linux, it's possible that you need to use <kbd>python3.7</kbd> instead of <kbd>python3</kbd>. Verify that the Python interpreter you're using is 3.7 or higher.</p>
</div>
</div>
<p>Inside the virtual environment, step 3 of the&nbsp;<em>How to do it...</em>&nbsp;section installs the most recent version of <kbd>pip</kbd>, without affecting the external installation.</p>
<p>The virtual environment contains all the Python data in the <kbd>.venv</kbd> directory, and the <kbd>activate</kbd> script points all the environment variables there. The best thing about it is that it can be deleted and recreated very easily, removing the fear of experimenting in a self-contained sandbox.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Remember that the directory name is displayed in the prompt. If you need to differentiate the environment, use a descriptive directory name, such as <kbd>.my_automate_recipe</kbd>,&nbsp;or use the <kbd>--prompt</kbd> option.</p>
</div>
</div>
<h3>There's more...</h3>
<p>To remove a virtual environment, deactivate it and remove the directory:</p>
<pre><code class="lang-python">(.venv) $ deactivate
$ rm -rf .venv</code></pre>
<p>The <kbd>venv</kbd> module has more options, which can be shown with the <kbd>-h</kbd> flag:</p>
<pre><code class="lang-python">$ python3 -m venv -h
usage: venv [-h] [--system-site-packages] [--symlinks | --copies] [--clear]
 [--upgrade] [--without-pip] [--prompt PROMPT]
 ENV_DIR [ENV_DIR ...]
Creates virtual Python environments in one or more target directories.
positional arguments:
 ENV_DIR A directory to create the environment in.

optional arguments:
 -h, --help show this help message and exit
 --system-site-packages
 Give the virtual environment access to the system
 site-packages dir.
 --symlinks Try to use symlinks rather than copies, when symlinks
 are not the default for the platform.
 --copies Try to use copies rather than symlinks, even when
 symlinks are the default for the platform.
 --clear Delete the contents of the environment directory if it
 already exists, before environment creation.
 --upgrade Upgrade the environment directory to use this version
 of Python, assuming Python has been upgraded in-place.
 --without-pip Skips installing or upgrading pip in the virtual
 environment (pip is bootstrapped by default)
 --prompt PROMPT Provides an alternative prompt prefix for this
 environment.
Once an environment has been created, you may wish to activate it, for example, by
sourcing an activate script in its bin directory.</code></pre>
<p>A convenient way of dealing with virtual environments, especially if you&nbsp;often&nbsp;have to swap between them, is using the &nbsp;<kbd>virtualenvwrapper</kbd> module:</p>
<ol>
<li>To install it, run this:</li>
</ol>
<pre><code class="lang-python">$ pip install virtualenvwrapper</code></pre>
<ol start="2">
<li>Then, add the following variables to your sheet startup script, these normally being&nbsp;<kbd>.bashrc</kbd> or <kbd>.bash_profile</kbd>. The virtual environments will be installed under the <kbd>WORKON_HOME</kbd> directory instead of the same directory as the project, as shown previously:</li>
</ol>
<pre><code class="lang-python">export WORKON_HOME=~/.virtualenvs
source /usr/local/bin/virtualenvwrapper.sh</code></pre>
<p>Sourcing the startup script or opening a new Terminal will allow you to create new virtual environments:</p>
<pre><code class="lang-python">$ mkvirtualenv automation_cookbook
...
Installing setuptools, pip, wheel...done.
(automation_cookbook) $ deactivate
$ workon automation_cookbook
(automation_cookbook) $</code></pre>
<p>For more information, check the documentation of&nbsp;<kbd>virtualenvwrapper</kbd>&nbsp;at:&nbsp;<a href="https://virtualenvwrapper.readthedocs.io/en/latest/index.html">https://virtualenvwrapper.readthedocs.io/en/latest/index.html</a>.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Hitting the <em>Tab</em> key after <kbd>workon</kbd> autocompletes with the available environments.&nbsp;</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The <em>Installing third-party packages</em> recipe</li>
<li>The <em>Using a third-party tool&mdash;parse</em> recipe</li>
</ul>
<h2>Installing third-party packages</h2>
<p>One of the strongest capabilities of Python is the ability to use an impressive catalog of third-party packages that cover an amazing amount of ground in different areas, from modules specialized in performing numerical operations, machine learning, and network communications, to command-line convenience tools, database access, image processing, and much more!</p>
<p>Most of them are available on the official Python Package Index&nbsp;(<a href="https://pypi.org/">https://pypi.org/</a>), which has more than 130,000 packages ready to use. In this book, we'll install some of them, and in general spending a little time researching external tools when trying to solve a problem is time well spent. It's very likely that someone else has created a tool that solves all, or at least part, of the problem.</p>
<p>As important as finding and installing a package is keeping track of which packages are being used. This greatly helps with <strong>replicability</strong>, meaning the ability to start the whole environment from scratch in any situation.</p>
<h3>Getting ready</h3>
<p>The starting point is to find a package that will be of use in our project.</p>
<p>A great one is <kbd>requests</kbd>, a module that deals with HTTP requests and is known for its easy and intuitive interface, as well as its great documentation. Take a look at the documentation, which can be found here:&nbsp;<a href="http://docs.python-requests.org/en/master/">http://docs.python-requests.org/en/master/</a>.</p>
<p>We'll use <kbd>requests</kbd> throughout this book when dealing with HTTP connections.</p>
<p>The next step will be to choose the version to use. In this case, the latest (2.18.4, at the time of&nbsp;writing)&nbsp;will be perfect. If the version of the module is not specified, by default, it will install the latest version, which can lead to inconsistencies in different environments.&nbsp;</p>
<p>We'll also use the great <kbd>delorean</kbd> module for time handling (version 1.0.0&nbsp;<a href="http://delorean.readthedocs.io/en/latest/">http://delorean.readthedocs.io/en/latest/</a>).</p>
<h3>How to do it...</h3>
<ol>
<li>Create a <kbd>requirements.txt</kbd> file in our main directory, which will specify all the requirements for our project. Let's start with&nbsp;<kbd>delorean</kbd> and <kbd>requests</kbd>:</li>
</ol>
<pre><code class="lang-python">delorean==1.0.0
requests==2.18.4</code></pre>
<ol start="2">
<li>Install all the requirements with the&nbsp;<kbd>pip</kbd> command:</li>
</ol>
<pre><code class="lang-python">$ pip install -r requirements.txt
...
Successfully installed babel-2.5.3 certifi-2018.4.16 chardet-3.0.4 delorean-1.0.0 humanize-0.5.1 idna-2.6 python-dateutil-2.7.2 pytz-2018.4 requests-2.18.4 six-1.11.0 tzlocal-1.5.1 urllib3-1.22</code></pre>
<ol start="3">
<li>You can now use both modules when using the virtual environment:</li>
</ol>
<pre><code class="lang-python">$ python
Python 3.6.5 (default, Mar 30 2018, 06:41:53)
[GCC 4.2.1 Compatible Apple LLVM 9.0.0 (clang-900.0.39.2)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; import delorean
&gt;&gt;&gt; import requests</code></pre>
<h3>How it works...</h3>
<p>The <kbd>requirements.txt</kbd> file specifies the module and version, and <kbd>pip</kbd> performs a search on <a href="http://pypi.org">pypi.org</a>.</p>
<p>Note that creating a new virtual environment from scratch and running the following&nbsp;will completely recreate your environment, which makes replicability very straightforward:</p>
<pre><code class="lang-python">$ pip install -r requirements.txt</code></pre>
<p>Note that step 2 of the&nbsp;<em>How to do it...</em> section&nbsp;automatically&nbsp;installs other modules that are dependencies, such as&nbsp;<kbd>urllib3</kbd>.</p>
<h3>There's more...</h3>
<p>If any of the modules need to be changed to a different version because a new version is available, change it using requirements and run the <kbd>install</kbd> command again:</p>
<pre><code class="lang-python">$ pip install -r requirements.txt</code></pre>
<p>This is also applicable when a new module needs to be included.</p>
<p>At any point, the <kbd>freeze</kbd>&nbsp;command&nbsp;can be used to display all installed modules. <kbd>freeze</kbd> returns the modules in a format compatible with <kbd>requirements.txt</kbd>, making it possible to do this&nbsp;to generate a file with our current environment:</p>
<pre><code class="lang-python">$ pip freeze &gt; requirements.txt</code></pre>
<p>This will include dependencies, so expect a lot more modules in the file.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Finding great third-party modules is not easy sometimes. Searching for specific functionality can work well, but sometimes there are great modules that are a surprise because they do things you never thought of. A great curated list is <strong>Awesome Python</strong> (<a href="https://awesome-python.com/">https://awesome-python.com/</a>), which covers a lot of great tools for common Python use cases, such as cryptography, database access, date and time handling, and&nbsp; so on.</p>
</div>
</div>
<p>In some cases, installing packages may require additional tools, such as compilers or a specific library that supports some functionality (for example, a particular database driver). If that's the case, the documentation will normally explain the dependencies.</p>
<h3>See also</h3>
<ul>
<li>The <em>Creating a virtual environment</em> recipe</li>
<li>The <em>Using a third-party tool&mdash;parse</em> recipe</li>
</ul>
<h2>Creating strings with formatted values</h2>
<p>One of the basic abilities when dealing with creating text and documents is to be able to properly format the values into structured strings. Python is quite smart in presenting good defaults, such as properly rendering a number, but there are a lot of options and possibilities.</p>
<p>We'll discuss some of the common options when creating formatted text with the example of a table.</p>
<h3>Getting ready</h3>
<p>The main tool to format strings in Python is the <kbd>format</kbd> method. It works with a defined mini-language to render variables this way:</p>
<pre><code class="lang-python">result = template.format(*parameters)</code></pre>
<p>The <kbd>template</kbd> is a string that gets interpreted based on the mini-language. At its easiest, it replaces the values between curly brackets with the parameters. Here are a couple of examples:</p>
<pre><code class="lang-python">&gt;&gt;&gt; 'Put the value of the string here: {}'.format('STRING')
"Put the value of the string here: STRING"
&gt;&gt;&gt; 'It can be any type ({}) and more than one ({})'.format(1.23, str)
"It can be any type (1.23) and more than one (&lt;class 'str'&gt;)"
&gt;&gt; 'Specify the order: {1}, {0}'.format('first', 'second')
'Specify the order: second, first'
&gt;&gt;&gt; 'Or name parameters: {first}, {second}'.format(second='SECOND', first='FIRST')
'Or name parameters: FIRST, SECOND'</code></pre>
<p>In 95% of cases, this formatting will be all that's required; keeping things simple is great! But for complicated times, such as when aligning the strings automatically and creating good looking text tables, the mini-language&nbsp;format&nbsp;has more options.</p>
<h3>How to do it...</h3>
<ol>
<li>Write the following script, <kbd>recipe_format_strings_step1.py</kbd>, to &nbsp;print an aligned table:</li>
</ol>
<pre><code class="lang-python"># INPUT DATA
data = [
    (1000, 10),
    (2000, 17),
    (2500, 170),
    (2500, -170),
]
# Print the header for reference
print('REVENUE | PROFIT | PERCENT')

# This template aligns and displays the data in the proper format
TEMPLATE = '{revenue:&gt;7,} | {profit:&gt;+7} | {percent:&gt;7.2%}'

# Print the data rows
for revenue, profit in data:
    row = TEMPLATE.format(revenue=revenue, profit=profit, percent=profit / revenue)
    print(row)</code></pre>
<ol start="2">
<li>Run it to display the following aligned table. Note that <kbd>PERCENT</kbd> is correctly displayed as a percentage:</li>
</ol>
<pre><code class="lang-python">REVENUE | PROFIT | PERCENT
  1,000 |    +10 |   1.00%
  2,000 |    +17 |   0.85%
  2,500 |   +170 |   6.80%
  2,500 |   -170 |  -6.80%</code></pre>
<h3>How it works...</h3>
<p>The <kbd>TEMPLATE</kbd> constant contains three columns, each one properly named (<kbd>REVENUE</kbd>, <kbd>PROFIT</kbd>, <kbd>PERCENT</kbd>). This makes it more explicit and straightforward to apply the template on the format call.</p>
<p>After the name of the parameter, there's a colon that separates the format definition. Note that all inside the curly brackets. In all columns, the format specification sets the width to seven characters and aligns the values to the right with the <kbd>&gt;</kbd>&nbsp;symbol:</p>
<ul>
<li>Revenue adds a thousands separator with the <kbd>,</kbd>&nbsp;symbol&mdash;<kbd>[{revenue:&gt;7,}]</kbd>.</li>
<li>Profit adds a <kbd>+</kbd>&nbsp;sign for positive values. A <kbd>-</kbd>&nbsp;for negatives is added automatically&mdash;<kbd>[{profit:&gt;+7}]</kbd>.</li>
<li>Percent displays a percent value, with a precision of two decimal places&mdash;<kbd>[{percent:&gt;7.2%}]</kbd>. This is done through 0.2 (precision) and adding a <kbd>%</kbd>&nbsp;symbol for the percentage.</li>
</ul>
<h3>There's more...</h3>
<p>You may have&nbsp;also&nbsp;seen the available Python formatting with the <kbd>%</kbd> operator. While it works for simple formatting, it is less flexible than the formated mini-language, and it is not recommended for use.</p>
<p>A great new feature since Python 3.6 is to use f-strings, which perform a format action using defined variables this way:</p>
<pre><code class="lang-python">&gt;&gt;&gt; param1 = 'first'
&gt;&gt;&gt; param2 = 'second'
&gt;&gt;&gt; f'Parameters {param1}:{param2}'
'Parameters first:second'</code></pre>
<p>This simplifies a lot of the code and allows us to create very descriptive and readable code.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Be careful when using f-strings to ensure that the string is replaced at the proper time. A common problem is that the variable defined to be rendered is not yet defined. For example, <kbd>TEMPLATE</kbd>, defined previously, won't be defined as an f-string, as <kbd>revenue</kbd>&nbsp;and the rest of the parameters are not available at that point.&nbsp;</p>
</div>
</div>

<p>If you need to write a curly bracket, you'll need to repeat it twice. Note that each duplication will be displayed as a single curly bracket, plus a curly bracket for the value replacement, making a total of three brackets:</p>
<pre><code class="lang-python">value = 'VALUE'
&gt;&gt;&gt; f'This is the value, in curly brackets {{{value}}}'
'This is the value, in curly brackets {VALUE}'</code></pre>
<p>This allows us to create meta templates&mdash;templates that produce templates. In some cases, that will be useful, but try to limit their use, as they'll get complicated very quickly, producing code that will be difficult to read.</p>

<p>The Python Format Specification mini-language has more options than the ones shown here.&nbsp;</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>As the language tries to be quite concise, sometimes it can be difficult to determine the position of the symbols. You may sometimes ask yourself questions like&mdash;<em>Is the <kbd>+</kbd> symbol before or after than the width parameters.?</em>&nbsp;Read the documentation with care and remember to always include a colon before the format specification.</p>
</div>
</div>
<p>Please check the full documentation and examples on the Python website (<a href="https://docs.python.org/3/library/string.html#formatspec">https://docs.python.org/3/library/string.html#formatspec</a>).</p>
<h3>See also</h3>
<ul>
<li>The <em>Template Reports</em>&nbsp;recipe in&nbsp;Chapter 5, <em>Generating Fantastic Reports</em></li>
<li>The <em>Manipulating strings</em> recipe</li>
</ul>
<h2>Manipulating strings</h2>
<p>A basic ability when dealing with text is to be able to properly manipulate that text. That means to be able to join it, split it into regular chunks, or change it to be uppercase or lowercase. We'll discuss more advanced methods for parsing text and separating it later, but in lots of cases it is useful to divide a paragraph into lines, sentences, or even words. Other times, words will have to have some characters removed or replaced with a canonical version to be able to compare it with a determined value.</p>
<h3>Getting ready</h3>
<p>We'll define a basic text to transform it into its main components, and then we'll reconstruct it. As an example, a report needs to be transformed into a new format to be sent via email.</p>
<p>The input format we'll use in this example will be this:</p>
<pre><code class="lang-python">    AFTER THE CLOSE OF THE SECOND QUARTER, OUR COMPANY, CASTA&Ntilde;ACORP
    HAS ACHIEVED A GROWTH IN THE REVENUE OF 7.47%. THIS IS IN LINE
    WITH THE OBJECTIVES FOR THE YEAR. THE MAIN DRIVER OF THE SALES HAS BEEN
    THE NEW PACKAGE DESIGNED UNDER THE SUPERVISION OF OUR MARKETING DEPARTMENT.
    OUR EXPENSES HAS BEEN CONTAINED, INCREASING ONLY BY 0.7%, THOUGH THE BOARD
    CONSIDERS IT NEEDS TO BE FURTHER REDUCED. THE EVALUATION IS SATISFACTORY
    AND THE FORECAST FOR THE NEXT QUARTER IS OPTIMISTIC. THE BOARD EXPECTS
    AN INCREASE IN PROFIT OF AT LEAST 2 MILLION DOLLARS.</code></pre>
<p>We need to redact the text to eliminate any references to numbers. It needs to be properly formatted by adding a new line after each period, justified with 80 characters, and transformed into ASCII for compatibility reasons.</p>
<p>The text will be stored in the <kbd>INPUT_TEXT</kbd> variable in the interpreter.</p>
<h3>How to do it...</h3>
<ol>
<li>After entering the text, split it into individual words:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; INPUT_TEXT = '''
...     AFTER THE CLOSE OF THE SECOND QUARTER, OUR COMPANY, CASTA&Ntilde;ACORP
...     HAS ACHIEVED A GROWTH IN THE REVENUE OF 7.47%. THIS IS IN LINE
...
'''
&gt;&gt;&gt; words = INPUT_TEXT.split()</code></pre>
<ol start="2">
<li>Replace any numerical digits with an <kbd>'X'</kbd>&nbsp;character:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; redacted = [''.join('X' if w.isdigit() else w for w in word) for word in words]</code></pre>
<ol start="3">
<li>Transform the text into pure ASCII (note that the name of the company contains a letter, <kbd>&ntilde;</kbd>, which is not ASCII):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; ascii_text = [word.encode('ascii', errors='replace').decode('ascii')
...               for word in redacted]</code></pre>
<ol start="4">
<li>Group the words into 80-character lines:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; newlines = [word + '\n' if word.endswith('.') else word for word in ascii_text]
&gt;&gt;&gt; LINE_SIZE = 80
&gt;&gt;&gt; lines = []
&gt;&gt;&gt; line = ''
&gt;&gt;&gt; for word in newlines:
...     if line.endswith('\n') or len(line) + len(word) + 1 &gt; LINE_SIZE:
...         lines.append(line)
...         line = ''
...     line = line + ' ' + word</code></pre>
<ol start="5">
<li>Format all lines as titles and join them as a single piece of text:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; lines = [line.title() for line in lines]
&gt;&gt;&gt; result = '\n'.join(lines)</code></pre>
<ol start="6">
<li>Print the result:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; print(result)
 After The Close Of The Second Quarter, Our Company, Casta?Acorp Has Achieved A
 Growth In The Revenue Of X.Xx%.

 This Is In Line With The Objectives For The Year.

 The Main Driver Of The Sales Has Been The New Package Designed Under The
 Supervision Of Our Marketing Department.

 Our Expenses Has Been Contained, Increasing Only By X.X%, Though The Board
 Considers It Needs To Be Further Reduced.

 The Evaluation Is Satisfactory And The Forecast For The Next Quarter Is
 Optimistic.</code></pre>
<h3>How it works...</h3>
<p>Each of the steps performs a specific transformation of the text:</p>
<ul>
<li>The first one splits the text on the default separators, whitespaces, and new lines. This splits it into individual words with no lines or multiple spaces for separation.&nbsp;</li>
<li>To replace the digits, we go through every character of each word. For each one, if it's a digit, an <kbd>'X'</kbd> is returned instead. This is done with two list comprehensions, one to run on the list, and another on each word, replacing only if there's a digit&mdash;<kbd>['X' if w.isdigit() else w for w in word]</kbd>. Note that the words are joined together again.</li>
<li>Each of the words is encoded into an ASCII byte sequence and decoded back again into the Python string type. Note the use of the <kbd>errors</kbd>&nbsp;parameter to force the replacement of unknown characters such as <kbd>&ntilde;</kbd>.</li>
</ul>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The difference between strings and bytes is not very intuitive at first, especially if you never have to worry about multiple languages or encoding transformation.&nbsp;In Python 3, there's a strong separation between strings (internal Python representation) and bytes, so most of the tools applicable to strings won't be available in byte objects. Unless you have a good idea of why you need a byte object, always&nbsp;work&nbsp;with Python strings. If you need to perform transformations like the one in this task, encode and decode in the same line so that you keep your objects in the comfortable&nbsp;realm of Python strings. If you are interested in learning more about encodings, you can check out this brief article (<a href="https://eli.thegreenplace.net/2012/01/30/the-bytesstr-dichotomy-in-python-3">https://eli.thegreenplace.net/2012/01/30/the-bytesstr-dichotomy-in-python-3</a>) and this other longer and more detailed one (<a href="http://www.diveintopython3.net/strings.html">http://www.diveintopython3.net/strings.html</a>).</p>
</div>
</div>
<ul>
<li>This step first adds an extra newline character (the <kbd>\n</kbd>&nbsp;character) for all words ending with a period. This marks the different paragraphs. After that, it creates a line and adds the words one by one. If an extra word will make it go over 80 characters, it finishes the line and starts a new one. If the line already ends with a new line, it finishes it and starts another one as well. Note that there's an extra space added to separate the words.</li>
<li>Finally, each of the lines is capitalized as a Title (the first letter of each word is upper cased) and all the lines are joined through new lines.</li>
</ul>
<h3>There's more...</h3>
<p>Some other useful operations that can be performed on strings are as follows:</p>
<ul>
<li>Strings can be sliced like any other list. This means that <kbd>'word'[0:2]</kbd> will return <kbd>'wo'</kbd>.</li>
<li>Use <kbd>.splitlines()</kbd> to separate lines by newline character.</li>
<li>There are <kbd>.upper()</kbd> and <kbd>.lower()</kbd> methods, which return a copy with all the characters set to uppercase or lowercase. Their use is very similar to&nbsp;<kbd>.title()</kbd>:</li>
</ul>
<pre><code class="lang-python">&gt;&gt;&gt; 'UPPERCASE'.lower()
'uppercase'</code></pre>
<ul>
<li>For easy replacements (for example, change all <kbd>A</kbd>&nbsp;to&nbsp;<kbd>B</kbd>&nbsp;or change <kbd>mine</kbd>&nbsp;to <kbd>ours</kbd>), use <kbd>.replace()</kbd>. This method is useful for very simple cases, but replacements can get tricky easily. Be careful with the order of replacements to avoid collisions and case sensitivity issues. Note the wrong replacement in the following example:</li>
</ul>
<pre><code class="lang-python">&gt;&gt;&gt; 'One ring to rule them all, one ring to find them, One ring to bring them all and in the darkness bind them.'.replace('ring', 'necklace')
'One necklace to rule them all, one necklace to find them, One necklace to bnecklace them all and in the darkness bind them.'</code></pre>
<p>This&nbsp;is similar to the issues we'll see with regular expressions matching unexpected parts of your code.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>There are more examples to follow later. Refer to the regular expressions recipes for more information.</p>
</div>
</div>
<p>If you work with multiple languages, or with any kind of non-English input, it is very useful to learn the basics of Unicode and encodings. In a nutshell, given the vast amount of characters in all the different languages in the world, including alphabets not related to the Latin one, such as Chinese or Arabic, there's a standard to try and cover all of them so that computers can properly understand them.&nbsp;Python 3 greatly improved this situation, making the strings internal objects to deal with all of those characters.&nbsp;The encoding that Python uses, and the most common and compatible one, is currently UTF-8.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>A good article to learn about the basics of UTF-8 is this blog post: (<a href="https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/">https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/</a>).</p>
</div>
</div>
<p>Dealing with encodings is still relevant when reading from external files that can be encoded in different encodings (for example,&nbsp;CP-1252 or windows-1252, which is a common encoding produced by legacy Microsoft systems, or ISO 8859-15, which is the industry standard).&nbsp;</p>
<h3>See also</h3>
<ul>
<li>The <em>Creating strings with formatted values</em> recipe</li>
<li>The <em>Introducing regular expressions</em> recipe</li>
<li>The <em>Going deeper into regular expressions</em> recipe</li>
<li>The <em>Dealing with Encodings</em> recipe in Chapter 4, <em>Searching and Reading Local Files</em></li>
</ul>
<h2>Extracting data from structured strings</h2>
<p>In a lot of automated tasks, we'll need to treat input text that's in a particular format and extract the relevant information. For example, a spreadsheet may define a percentage in text (such as 37.4%) that we want to retrieve in numerical format to apply it later (0.374, as a float).</p>
<p>In this recipe, we'll see how to process sale logs that contain inline information about a product, such as sold, price, profit, and some other information.</p>
<h3>Getting ready</h3>
<p>Imagine that we need to parse information stored in sales logs. We'll use a sales log with the following structure:</p>
<pre><code class="lang-python">[&lt;Timestamp in iso format&gt;] - SALE - PRODUCT: &lt;product id&gt; - PRICE: $&lt;price of the sale&gt;</code></pre>
<p>For example, a specific log may look like this:</p>
<pre><code class="lang-python">[2018-05-05T10:58:41.504054] - SALE - PRODUCT: 1345 - PRICE: $09.99</code></pre>
<p>Note that the price has a leading zero. All prices will have two digits for the dollars, and two for&nbsp;the cents.</p>
<p>We need to activate our virtual environment before we start:</p>
<pre><code class="lang-python">$ source .venv/bin/activate</code></pre>
<h3>How to do it...</h3>
<ol>
<li>In the Python interpreter, make the following imports. Remember to activate your <kbd>virtualenv</kbd>,&nbsp; as described in the <em>Creating a virtual environment</em>&nbsp;recipe:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import delorean
&gt;&gt;&gt; from decimal import Decimal</code></pre>
<ol start="2">
<li>Enter the log to parse:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; log = '[2018-05-05T11:07:12.267897] - SALE - PRODUCT: 1345 - PRICE: $09.99'</code></pre>
<ol start="3">
<li>Split the log into its parts, which are divided by <kbd>&nbsp;-</kbd> &nbsp;(note the space before and after the dash). We ignore the <kbd>SALE</kbd>&nbsp;part&nbsp;as it doesn't add any relevant information:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; divide_it = log.split(' - ')
&gt;&gt;&gt; timestamp_string, _, product_string, price_string = divide_it</code></pre>
<ol start="4">
<li>Parse the <kbd>timestamp</kbd> into a datetime object:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; timestamp = delorean.parse(tmp_string.strip('[]'))</code></pre>
<ol start="5">
<li>Parse the <kbd>product_id</kbd>&nbsp;into a integer:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; product_id = int(product_string.split(':')[-1])</code></pre>
<ol start="6">
<li>Parse the price into a <kbd>Decimal</kbd> type:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; price = Decimal(price_string.split('$')[-1])</code></pre>
<ol start="7">
<li>Now, you have all the values in native Python formats:</li>
</ol>
<pre><code class="lang-python">timestamp, product_id, price
(Delorean(datetime=datetime.datetime(2018, 5, 5, 11, 7, 12, 267897), timezone='UTC'), 1345, Decimal('9.99'))</code></pre>
<h3>How it works...</h3>
<p>The basic working of this is to isolate each of the elements and then parse them in to the proper type. The first step is to split the full log into smaller parts. The <kbd>-</kbd>&nbsp;string&nbsp;is a good divider, as it splits it into four parts&mdash;a timestamp one, one with just the word <kbd>SALE</kbd>, the product, and the price.</p>
<p>In the case of the timestamp, we need to isolate the ISO format, which is in brackets in the log. That's why it's stripped off the brackets. We use the <kbd>delorean</kbd>&nbsp;module&nbsp;(introduced earlier) to parse it in to a <kbd>datetime</kbd> object.</p>
<p>The word <kbd>SALE</kbd>&nbsp;is ignored. There's no relevant information there.</p>
<p>To isolate the product ID, we split the product part at the colon. Then, we parse the last element as an integer:</p>
<pre><code class="lang-python">&gt;&gt;&gt; product_string.split(':')
['PRODUCT', ' 1345']
&gt;&gt;&gt; int(' 1345')
1345</code></pre>
<p>To divide the price, we use the dollar sign as a separator, and parse it as a <kbd>Decimal</kbd> character:</p>
<pre><code class="lang-python">&gt;&gt;&gt; price_string.split('$')
['PRICE: ', '09.99']
&gt;&gt;&gt; Decimal('09.99')
Decimal('9.99')</code></pre>
<p>As described in the next section, do not parse this value into a float type.</p>
<h3>There's more...</h3>
<p>These log elements can be combined together into a single object, helping with parsing and aggregating them. For example, we could define a class in Python code in the following way:</p>
<pre><code class="lang-python">class PriceLog(object):
  def __init__(self, timestamp, product_id, price):
    self.timestamp = timestamp
    self.product_id = product_id
    self.price = price
  def __repr__(self):
    return '&lt;PriceLog ({}, {}, {})&gt;'.format(self.timestamp,
                                            self.product_id,
                                            self.price)
  @classmethod
  def parse(cls, text_log):
    '''
    Parse from a text log with the format
    [&lt;Timestamp&gt;] - SALE - PRODUCT: &lt;product id&gt; - PRICE: $&lt;price&gt;
    to a PriceLog object
    '''
    divide_it = text_log.split(' - ')
    tmp_string, _, product_string, price_string = divide_it
    timestamp = delorean.parse(tmp_string.strip('[]'))
    product_id = int(product_string.split(':')[-1])
    price = Decimal(price_string.split('$')[-1])
    return cls(timestamp=timestamp, product_id=product_id, price=price)</code></pre>
<p>So, the parsing can be done as follows:</p>
<pre><code class="lang-python">&gt;&gt;&gt; log = '[2018-05-05T12:58:59.998903] - SALE - PRODUCT: 897 - PRICE: $17.99'
&gt;&gt;&gt; PriceLog.parse(log)
&lt;PriceLog (Delorean(datetime=datetime.datetime(2018, 5, 5, 12, 58, 59, 998903), timezone='UTC'), 897, 17.99)&gt;</code></pre>
<p>Avoid using float types for prices. Floats numbers have precision problems that may produce strange errors when aggregating multiple prices, for example:</p>
<pre><code class="lang-python">&gt;&gt;&gt; 0.1 + 0.1 + 0.1 
0.30000000000000004</code></pre>
<p>Try these two options to avoid problems:</p>
<ul>
<li><strong>Use integer cents as the base unit</strong>: This&nbsp;means multiplying currency inputs by 100 and transforming them into integers (or whatever fractional unit is correct for the currency&nbsp;used). You may still want to change the base when displaying them.</li>
<li><strong>Parse into the Decimal type</strong>: The <kbd>Decimal</kbd> type keeps the fixed&nbsp;precision and works as you'd expect. You can find further information about the&nbsp;<kbd>Decimal</kbd> type in the Python docs at&nbsp;<a href="https://docs.python.org/3.6/library/decimal.html">https://docs.python.org/3.6/library/decimal.html</a>.</li>
</ul>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>If you use the&nbsp;<kbd>Decimal</kbd> type, parse the results directly into <kbd>Decimal</kbd> from the string. If transforming it first into a float, you can carry the precision errors to the new type.</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The <em>Creating a virtual environment</em> recipe</li>
<li>The <em>Using a third-party tool&mdash;parse</em> recipe</li>
<li>The <em>Introducing regular expressions</em> recipe</li>
<li>The <em>Going deeper into regular expressions</em> recipe</li>
</ul>
<h2>Using a third-party tool&mdash;parse</h2>
<p>While manually parsing data, as seen in the previous recipe, works very well for small strings, it can be very laborious to tweak the&nbsp;exact&nbsp;formula to work with a variety of input. What if the input has an extra dash sometimes? Or it has a variable length header depending on the size of one of the fields?</p>
<p>A more advanced option is to use regular expressions, as we'll see in the next recipe. But there's a great module in Python called <kbd>parse</kbd>&nbsp;(<a href="https://github.com/r1chardj0n3s/parse">https://github.com/r1chardj0n3s/parse</a>) that allows us to reverse format strings. It is a fantastic tool, that's powerful, easy to use, and&nbsp;greatly&nbsp;improves the readability of the code.</p>
<h3>Getting ready</h3>
<p>Add the parse module to the <kbd>requirements.txt</kbd> file in our virtual environment and reinstall the dependencies, as shown in the <em>Creating a virtual environment</em>&nbsp;recipe.</p>
<p>The <kbd>requirements.txt</kbd> file should look like this:</p>
<pre><code class="lang-python">delorean==1.0.0
requests==2.18.3
parse==1.8.2</code></pre>
<p>Then,&nbsp;reinstall&nbsp;the modules in the virtual environment:</p>
<pre><code class="lang-python">$ pip install -r requirements.txt
...
Collecting parse==1.8.2 (from -r requirements.txt (line 3))
  Using cached https://files.pythonhosted.org/packages/13/71/e0b5c968c552f75a938db18e88a4e64d97dc212907b4aca0ff71293b4c80/parse-1.8.2.tar.gz
...
Installing collected packages: parse
  Running setup.py install for parse ... done
Successfully installed parse-1.8.2</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Import the&nbsp;<kbd>parse</kbd> function:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from parse import parse</code></pre>
<ol start="2">
<li>Define the log to parse, in the same format as in the <em>Extracting data from structured strings</em> recipe:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; LOG = '[2018-05-06T12:58:00.714611] - SALE - PRODUCT: 1345 - PRICE: $09.99'</code></pre>
<ol start="3">
<li>Analyze it and describe it as you'll do when trying to print it, like this:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; FORMAT = '[{date}] - SALE - PRODUCT: {product} - PRICE: ${price}'</code></pre>
<ol start="4">
<li>Run <kbd>parse</kbd> and check the results:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; result = parse(FORMAT, LOG)
&gt;&gt;&gt; result
&lt;Result () {'date': '2018-05-06T12:58:00.714611', 'product': '1345', 'price': '09.99'}&gt;
&gt;&gt;&gt; result['date']
'2018-05-06T12:58:00.714611'
&gt;&gt;&gt; result['product']
'1345'
&gt;&gt;&gt; result['price']
'09.99'</code></pre>
<ol start="5">
<li>Note the results are all strings. Define the types to be parsed:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; FORMAT = '[{date:ti}] - SALE - PRODUCT: {product:d} - PRICE: ${price:05.2f}'</code></pre>
<ol start="6">
<li>Parse once again:</li>
</ol>
<pre><code class="lang-python">result = parse(FORMAT, LOG)
&gt;&gt;&gt; result
&lt;Result () {'date': datetime.datetime(2018, 5, 6, 12, 58, 0, 714611), 'product': 1345, 'price': 9.99}&gt;
&gt;&gt;&gt; result['date']
datetime.datetime(2018, 5, 6, 12, 58, 0, 714611)
&gt;&gt;&gt; result['product']
1345
&gt;&gt;&gt; result['price']
9.99</code></pre>
<ol start="7">
<li>Define a custom type for the price to avoid issues with the float type:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from decimal import Decimal
&gt;&gt;&gt; def price(string):
...   return Decimal(string)
...
&gt;&gt;&gt; FORMAT = '[{date:ti}] - SALE - PRODUCT: {product:d} - PRICE: ${price:price}'
&gt;&gt;&gt; parse(FORMAT, LOG, {'price': price})
&lt;Result () {'date': datetime.datetime(2018, 5, 6, 12, 58, 0, 714611), 'product': 1345, 'price': Decimal('9.99')}&gt;</code></pre>
<h3>How it works...</h3>
<p>The <kbd>parse</kbd> module allows us to define a format, such as string, that reverses the format method when parsing values. A lot of the concepts that we discussed when creating strings applies here&mdash;put values in brackets, define the type after a colon, and so on.</p>
<p>By default, as seen in step 4, the values are parsed as strings. This is a good starting point when analyzing text. The values can be parsed into more useful native types, as shown in steps 5 and 6 in the <em>How to do it...</em> section. Please note that while most of the parsing types are the same as the ones in the Python Format Specification mini-language, there are some others available, such as&nbsp;<kbd>ti</kbd> for timestamps in ISO format.&nbsp;</p>
<p>If native types are not enough, our own parsing can be defined, as demonstrated in step 7 in the <em>How to do it...</em> section. Note that the definition of the price function gets a string and returns the proper format, in this case a <kbd>Decimal</kbd> type.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>All the issues about floats and price information described in the <em>There's more</em> section of the <em>Extracting data from structured strings</em>&nbsp;recipe&nbsp;apply here as well.</p>
</div>
</div>
<h3>There's more...</h3>
<p>The timestamp can also be translated into a <kbd>delorean</kbd> object for consistency. Also, <kbd>delorean</kbd> objects carry over timezone information. Adding the same structure as in the previous recipe gives the following object, which is capable of parsing logs:</p>
<pre><code class="lang-python">class PriceLog(object):
  def __init__(self, timestamp, product_id, price):
    self.timestamp = timestamp
    self.product_id = product_id
    self.price = price
  def __repr__(self):
    return '&lt;PriceLog ({}, {}, {})&gt;'.format(self.timestamp,
                                            self.product_id,
                                            self.price)
  @classmethod
  def parse(cls, text_log):
    '''
    Parse from a text log with the format
    [&lt;Timestamp&gt;] - SALE - PRODUCT: &lt;product id&gt; - PRICE: $&lt;price&gt;
    to a PriceLog object
    '''
    def price(string):
      return Decimal(string)
    def isodate(string):
      return delorean.parse(string)
    FORMAT = ('[{timestamp:isodate}] - SALE - PRODUCT: {product:d} - '
              'PRICE: ${price:price}')
    formats = {'price': price, 'isodate': isodate}
    result = parse.parse(FORMAT, text_log, formats)
    return cls(timestamp=result['timestamp'],
               product_id=result['product'],
               price=result['price'])</code></pre>
<p>So, parsing it returns similar results:</p>
<pre><code class="lang-python">&gt;&gt;&gt; log = '[2018-05-06T14:58:59.051545] - SALE - PRODUCT: 827 - PRICE: $22.25'
&gt;&gt;&gt; PriceLog.parse(log)
&lt;PriceLog (Delorean(datetime=datetime.datetime(2018, 6, 5, 14, 58, 59, 51545), timezone='UTC'), 827, 22.25)&gt;</code></pre>
<p>This code is contained in the GitHub file <kbd>Chapter01/price_log.py</kbd>.</p>
<p>All&nbsp;<kbd>parse</kbd>&nbsp;supported types can be found in the documentation at <a href="https://github.com/r1chardj0n3s/parse#format-specification">https://github.com/r1chardj0n3s/parse#format-specification</a>.&nbsp;</p>
<h3>See also</h3>
<ul>
<li>The <em>Extracting data from structured strings</em> recipe</li>
<li>The <em>Introducing regular expressions</em>&nbsp;recipe</li>
<li>The <em>Going deeper into regular expressions</em>&nbsp;recipe</li>
</ul>
<h2>Introducing regular expressions</h2>
<p>A <strong>regular expression</strong>, or <strong>regex</strong>, is a pattern to <em>match</em> text. In&nbsp;other words, it allows us to define an <strong>abstract string</strong> (typically the definition of a structured kind of text) to check with other strings to see if they match or not.</p>
<p>It is better to describe them with an example. Think of defining a pattern of text as <em>a word that starts with an uppercase A and contains only lowercase Ns and As after that</em>. The word <em>Anna</em>&nbsp;matches it, but <em>Bob</em>, <em>Alice</em>, and <em>James&nbsp;</em>does not. The words <em>Aaan</em>, <em>Ana</em>, <em>Annnn</em>, and <em>Aaaan</em> will also be matches, but <em>ANNA</em>&nbsp;won't.</p>
<p>If this sounds complicated, that's because it is. Regexes can be notoriously complicated because they may be incredibly intricate and difficult to follow. But they are very useful, because they allow us to perform incredibly powerful pattern matching.</p>
<p>Some common uses of regexes are as follow:</p>
<ul>
<li><strong>Validating input data</strong>: For example, that a phone number is only numbers, dashes, and brackets.</li>
<li><strong>String parsing</strong>: Retrieve data from structured strings, such as logs or URLs. This is similar to what's described in the previous recipe.</li>
<li><strong>Scrapping</strong>: Find the occurrences of something in a long text. For example, find all emails in a web page.</li>
<li><strong>Replacement</strong>: Find and replace a word or words with others. For example, replace <em>the owner</em>&nbsp;with <em>John Smith</em>.</li>
</ul>
<blockquote>
<p>"Some people, when confronted with a problem, think "I know, I'll use regular expressions." Now they have two problems."<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&ndash; Jamie Zawinski</p>
</blockquote>
<p>Regular expressions are at their best when they are kept very simple.&nbsp;In general, if there is a specific tool to do it, prefer it over regexes. A very clear example of this is HTML parsing; check Chapter 3, <em>Building Your First Web Scraping Application,</em>&nbsp;for better tools to achieve this.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Some text editors allow us to search using regexes as well. While most are editors aimed at writing code, such as Vim, BBEdit, or Notepad++, they're also present in more general tools, such as MS Office, Open Office, or Google Documents. But be careful, as the particular syntax may be slightly different.</p>
</div>
</div>
<h3>Getting ready</h3>
<p>The <kbd>python</kbd> module to deal with regexes is called <kbd>re</kbd>. The main function we'll cover is <kbd>re.search()</kbd>, which returns a <em>match&nbsp;</em>object with information about what matched the pattern.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>As regex patterns are also defined as strings, we'll differentiate them by prefixing them with an <em>r</em>, such as <kbd>r'pattern'</kbd>. This is the Python way of labeling a text as raw string literals, meaning that the string within is taken literally, without any escaping. This means that a <kbd>\</kbd> is used as a backslash instead of a sequence. For example, without the r prefix, <kbd>\n</kbd> means newline character.</p>
</div>
</div>
<p>Some characters are special, and refer to concepts such as <em>the end of the string</em>, <em>any digit</em>, <em>any character</em>,&nbsp;<em>any whitespace character</em>, and so on.</p>
<p>The&nbsp;simplest form&nbsp;is just a literal string. For example, the regex pattern <kbd>r'LOG'</kbd> matches the string <kbd>'LOGS'</kbd>, but not the string <kbd>'NOT A MATCH'</kbd>. If there's not a match, search returns&nbsp;<kbd>None</kbd>:</p>
<pre><code class="lang-python">&gt;&gt;&gt; import re
&gt;&gt;&gt; re.search(r'LOG', 'LOGS')
&lt;_sre.SRE_Match object; span=(0, 3), match='LOG'&gt;
&gt;&gt;&gt; re.search(r'LOG', 'NOT A MATCH')
&gt;&gt;&gt;</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>re</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import re</code></pre>
<ol start="2">
<li>Then, match a pattern that is not at the start of the string:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; re.search(r'LOG', 'SOME LOGS')
&lt;_sre.SRE_Match object; span=(5, 8), match='LOG'&gt;</code></pre>
<ol start="3">
<li>Match a pattern that is only at the start of the string. Note the <kbd>^</kbd> character:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; re.search(r'^LOG', 'LOGS')
&lt;_sre.SRE_Match object; span=(0, 3), match='LOG'&gt;
&gt;&gt;&gt; re.search(r'^LOG', 'SOME LOGS')
&gt;&gt;&gt;</code></pre>
<ol start="4">
<li>Match a pattern only at the end of the string. Note the <kbd>$</kbd> character:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; re.search(r'LOG$', 'SOME LOG')
&lt;_sre.SRE_Match object; span=(5, 8), match='LOG'&gt;
&gt;&gt;&gt; re.search(r'LOG$', 'SOME LOGS')
&gt;&gt;&gt;</code></pre>
<ol start="5">
<li>Match the word <kbd>'thing'</kbd> (not excluding <kbd>things</kbd>), but not <kbd>something</kbd>&nbsp;or <kbd>anything</kbd>. Note the <kbd>\b</kbd> at the start of the&nbsp;second&nbsp;pattern:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; STRING = 'something in the things she shows me'
&gt;&gt;&gt; match = re.search(r'thing', STRING)
&gt;&gt;&gt; STRING[:match.start()], STRING[match.start():match.end()], STRING[match.end():]
('some', 'thing', ' in the things she shows me')
&gt;&gt;&gt; match = re.search(r'\bthing', STRING)
&gt;&gt;&gt; STRING[:match.start()], STRING[match.start():match.end()], STRING[match.end():]
('something in the ', 'thing', 's she shows me')

</code></pre>
<ol start="6">
<li>Match a pattern that's only numbers and dashes (for example, a phone number). Retrieve the matched string:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; re.search(r'[0123456789-]+', 'the phone number is 1234-567-890')
&lt;_sre.SRE_Match object; span=(20, 32), match='1234-567-890'&gt;
&gt;&gt;&gt; re.search(r'[0123456789-]+', 'the phone number is 1234-567-890').group()
'1234-567-890'</code></pre>
<ol start="7">
<li>Match an email address naively:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; re.search(r'\S+@\S+', 'my email is email.123@test.com').group()
'email.123@test.com'</code></pre>
<h3>How it works...</h3>
<p>The <kbd>re.search</kbd>&nbsp;function&nbsp;matches a pattern, no matter its position in the string. As explained previously, this will return&nbsp;<kbd>None</kbd> if the pattern is not found, or a <kbd>match</kbd> object.</p>
<p>The following special characters are used:</p>
<ul>
<li><kbd>^</kbd>: Marks the start of the string</li>
<li><kbd>$</kbd>: Marks the end of the string</li>
</ul>
<ul>
<li><kbd>\b</kbd>: Marks the start or end of a word</li>
<li><kbd>\S</kbd>: Marks any character that's not a whitespace, including special characters</li>
</ul>
<p>More special characters are shown in the next recipe.</p>
<p>In step 6 in the <em>How to do it...</em> section, the <kbd>r'[0123456789-]+'</kbd>&nbsp;pattern&nbsp;is composed of two parts. The first one is between square brackets, and matches any single character between <kbd>0</kbd> and <kbd>9</kbd> (any number) and the dash (<kbd>-</kbd>) character. The <kbd>+</kbd> sign after that means that this character can be present one or more times. This is called a <strong>quantifier</strong> in regexes. This makes a match on any combination of numbers and dashes, no matter how long it is.</p>
<p>Step 7 again uses the <kbd>+</kbd> sign to match as many characters as necessary before the <kbd>@</kbd> and again after it. In this case, the character match is <kbd>\S</kbd>, which matches any non-whitespace character.</p>
<p>Please note that the naive pattern for emails described here is <em>very</em> naive, as it will match invalid emails such as <kbd>john@smith@test.com</kbd>. A better regex for most uses is <kbd>r"(^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$)"</kbd>. You can go to&nbsp;<a href="http://emailregex.com/">http://emailregex.com/</a>&nbsp;for find it and links to more information.&nbsp;</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Note that parsing a valid email including corner cases is actually a difficult and challenging problem. The previous regex should be fine for most uses covered in this book, but in a general framework project such as Django, email validation is a very long and very unreadable regex.</p>
</div>
</div>
<p>The resulting matching object returns the position where the matched pattern starts and ends (using the&nbsp;<kbd>start</kbd> and <kbd>end</kbd>&nbsp;methods), as shown in step 5, which splits the string into matched parts, showing the distinction between the two matching patterns.&nbsp;</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The difference displayed in step 5 is a very common one. Trying to capture GP can end up capturing eg<strong>gp</strong>lant and ba<strong>gp</strong>ipe! Similarly, <kbd>things\b</kbd> won't capture things. Be sure to test and make the proper adjustments, such as capturing <kbd>\bGP\b</kbd> for just the word GP.</p>
</div>
</div>
<p>The specific matched pattern can be retrieved by calling <kbd>group()</kbd>, as shown in step 6. Note that the result will always be a string. It can be further processed using any of the methods that we've previously seen, such as by splitting the phone number into groups by dashes, for example:</p>
<pre><code class="lang-python">&gt;&gt;&gt; match = re.search(r'[0123456789-]+', 'the phone number is 1234-567-890')
&gt;&gt;&gt; [int(n) for n in match.group().split('-')]
[1234, 567, 890]</code></pre>
<h3>There's more...</h3>
<p>Dealing with regexes can be difficult and complex. Please allow time to test your matches and be sure that they work as you expect in order to avoid nasty surprises.</p>
<p>You can check your regexes interactively with some tools. A good one that's freely available online is&nbsp;<a href="https://regex101.com/">https://regex101.com/</a>, which displays each of the elements and explains the regex. Double-check that you're using the Python flavor:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000054.png" class="lazyload" /></p>
<p>See that the EXPLANATION describes that <kbd>\b</kbd> matches a word boundary (start or end of a word), and that <em>thing</em> matches literally these characters.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Regexes, in some cases, can be very slow, or even produce what's called <strong>regex denial-of-service</strong>, a string created to confuse a particular regex so that it takes an enormous amount of time, even in the worst case blocking the computer. While automating tasks probably won't get you into those problems, keep an eye out in case a regex takes too long.</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The <em>Extracting data from structured strings</em> recipe</li>
<li>The <em>Using a third-party tool&mdash;parse</em> recipe</li>
<li>The <em>Going deeper into regular expressions</em> recipe</li>
</ul>
<h2>Going deeper into regular expressions</h2>
<p>In this recipe, we'll see more about how to deal with regular expressions. After introducing the basics, we will dig a little deeper into pattern elements, introduce groups as a better way to retrieve and parse strings, see&nbsp;how to search for multiple occurrences of the same string, and deal with longer texts.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>re</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import re</code></pre>
<ol start="2">
<li>Match a phone pattern as part of a group (in brackets). Note the use of <kbd>\d</kbd> as a special character for <em>any digit</em>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; match = re.search(r'the phone number is ([\d-]+)', '37: the phone number is 1234-567-890')
&gt;&gt;&gt; match.group()
'the phone number is 1234-567-890'
&gt;&gt;&gt; match.group(1)
'1234-567-890'</code></pre>
<ol start="3">
<li>Compile a pattern and capture a case insensitive pattern with a&nbsp;<kbd>yes|no</kbd>&nbsp;option:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; pattern = re.compile(r'The answer to question (\w+) is (yes|no)', re.IGNORECASE)
&gt;&gt;&gt; pattern.search('Naturaly, the answer to question 3b is YES')
&lt;_sre.SRE_Match object; span=(10, 42), match='the answer to question 3b is YES'&gt;
&gt;&gt;&gt; _.groups()
('3b', 'YES')</code></pre>
<ol start="4">
<li>Match all the occurrences of cities and state abbreviations in the text. Note that they are separated by a single character and the name of the city always starts with an uppercase letter. Only four states are matched for simplicity:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; PATTERN = re.compile(r'([A-Z][\w\s]+).(TX|OR|OH|MI)')
&gt;&gt;&gt; TEXT ='the jackalopes are the team of Odessa,TX while the knights are native of Corvallis OR and the mud hens come from Toledo.OH; the whitecaps have their base in Grand Rapids,MI'
&gt;&gt;&gt; list(PATTERN.finditer(TEXT))
[&lt;_sre.SRE_Match object; span=(31, 40), match='Odessa,TX'&gt;, &lt;_sre.SRE_Match object; span=(73, 85), match='Corvallis OR'&gt;, &lt;_sre.SRE_Match object; span=(113, 122), match='Toledo.OH'&gt;, &lt;_sre.SRE_Match object; span=(157, 172), match='Grand Rapids,MI'&gt;]
&gt;&gt;&gt; _[0].groups()
('Odessa', 'TX')</code></pre>
<h3>How it works...</h3>
<p>The new special characters that were introduced are as follows. Note that the same letter in uppercase or lowercase means the opposite match, for example&nbsp;<kbd>\d</kbd> matches a digit, while <kbd>\D</kbd> matches a non digit.:</p>
<ul>
<li><kbd>\d</kbd>: Marks any digit (0 to 9).</li>
<li><kbd>\s</kbd>: Marks any character that's a whitespace, including tabs and other whitespace special characters. Note that this is the reverse of <kbd>\S</kbd>, introduced in the previous recipe<strong>.</strong></li>
<li><kbd>\w</kbd>: Marks any letter (includes digits, but excludes characters such as periods).</li>
<li><kbd>.</kbd>: Marks any character.</li>
</ul>
<p>To define groups, put the defined groups in brackets. Groups can be retrieved individually, making them perfect for matching a bigger pattern that contains a variable part that we'll treat later, as demonstrated in step 2. Note the difference with the step 6 pattern in the previous recipe. In this case, the pattern is not only the number, but includes the prefix, even if we then extract the number. Check out this difference, where there's a number that's not the number we want to capture:</p>
<pre><code class="lang-python">&gt;&gt;&gt; re.search(r'the phone number is ([\d-]+)', '37: the phone number is 1234-567-890')
&lt;_sre.SRE_Match object; span=(4, 36), match='the phone number is 1234-567-890'&gt;
&gt;&gt;&gt; _.group(1)
'1234-567-890'
&gt;&gt;&gt; re.search(r'[0123456789-]+', '37: the phone number is 1234-567-890')
&lt;_sre.SRE_Match object; span=(0, 2), match='37'&gt;
&gt;&gt;&gt; _.group()
'37'</code></pre>
<p>Remember that group 0 (<kbd>.group()</kbd> or &nbsp;<kbd>.group(0)</kbd>) is always the whole match. The rest of the groups are ordered as they appear.</p>
<p>Patterns can be compiled as well. This saves some time if the pattern needs to be matched over and over. To use it that way, compile the pattern and then use that object to perform searches, as shown in steps 3 and 4. Some extra flags can be added, such as making the pattern case insensitive.</p>
<p>Step 4's pattern requires a little bit of information. It's composed of two groups, separated by a single character. The special character <kbd>.</kbd>&nbsp;means it matches everything, in our example a period, a whitespace, and a comma. The second group is a straightforward selection of defined options, in this case US state abbreviations.</p>
<p>The first group starts with an uppercase letter (<kbd>[A-Z]</kbd>), and accepts any combination of letters or spaces (<kbd>[\w\s]+</kbd>), but not punctuation marks such as periods or commas. This matches the cities, including when composed of more than one word.</p>
<p>Note that this pattern starts on any uppercase letter and keeps matching until finding a state, unless separated by a punctuation mark, which may not be what's expected, for example:</p>
<pre><code class="lang-python">&gt;&gt;&gt; re.search(r'([A-Z][\w\s]+).(TX|OR|OH|MI)', 'This is a test, Escanaba MI')
&lt;_sre.SRE_Match object; span=(16, 27), match='Escanaba MI'&gt;
&gt;&gt;&gt; re.search(r'([A-Z][\w\s]+).(TX|OR|OH|MI)', 'This is a test with Escanaba MI')
&lt;_sre.SRE_Match object; span=(0, 31), match='This is a test with Escanaba MI'&gt;</code></pre>
<p>Step 4 also shows how to find more than one occurrence in a long text. While the <kbd>.findall()</kbd>&nbsp;method&nbsp;exists, it doesn't return the full match object, while <kbd>.findalliter()</kbd>&nbsp;does. Commonplace now in Python 3, <kbd>.findalliter()</kbd> returns an iterator that can be used in a for loop or list comprehension. Note that <kbd>.search()</kbd>&nbsp;returns only the first occurrence of the pattern, even if more matches appear:</p>
<pre><code class="lang-python">&gt;&gt;&gt; PATTERN.search(TEXT)
&lt;_sre.SRE_Match object; span=(31, 40), match='Odessa,TX'&gt;
&gt;&gt;&gt; PATTERN.findall(TEXT)
[('Odessa', 'TX'), ('Corvallis', 'OR'), ('Toledo', 'OH')]</code></pre>
<h3>There's more...</h3>
<p>The special characters can be reversed if they are case swapped. For example, the reverse of the ones we used are as follows:</p>
<ul>
<li><kbd>\D</kbd>: Marks any non-digit</li>
<li><kbd>\W</kbd>: Marks any non-letter</li>
<li><kbd>\B</kbd>: Marks any character that's not at the start or end of a word</li>
</ul>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The most commonly used special characters are typically <kbd>\d</kbd> (digits) and&nbsp;<kbd>\w</kbd> (letters and digits), as they mark common patterns to search for, and the plus sign for one or more.</p>
</div>
</div>
<p>Groups can be assigned names as well. This makes them more explicit at the expense of making the group more verbose in the following shape&mdash;<kbd>(?P&lt;groupname&gt;PATTERN)</kbd>. Groups can be referred to by name with&nbsp;<kbd>.group(groupname)</kbd> or by calling <kbd>.groupdict()</kbd>&nbsp;while maintaining its numeric position.</p>
<p>For example, the step 4 pattern can be described as follows:</p>
<pre><code class="lang-python">&gt;&gt;&gt; PATTERN = re.compile(r'(?P&lt;city&gt;[A-Z][\w\s]+?).(?P&lt;state&gt;TX|OR|OH|MN)')
&gt;&gt;&gt; match = PATTERN.search(TEXT)
&gt;&gt;&gt; match.groupdict()
{'city': 'Odessa', 'state': 'TX'}
&gt;&gt;&gt; match.group('city')
'Odessa'
&gt;&gt;&gt; match.group('state')
'TX'
&gt;&gt;&gt; match.group(1), match.group(2)
('Odessa', 'TX')</code></pre>
<p>Regular expressions are a very extensive topic. There are whole technical books devoted to them and they can be notoriously deep. The Python documentation is good to be used as reference (<a href="https://docs.python.org/3/library/re.html">https://docs.python.org/3/library/re.html</a>) and to learn more.</p>
<p>If you feel a little intimidated at the start, it's a perfectly natural feeling.&nbsp;Analyze each of the patterns with care, dividing it into different parts, and they will start to make sense. Don't be afraid to run a regex interactive analyzer!</p>
<p>Regexes can be really powerful and generic, but they may not be the proper tool for what you are trying to achieve. We've seen some caveats and patterns that have subtleties. As a rule of thumb, if a pattern starts to feel complicated, it's time to search for a different tool. Remember the previous recipes as well and the options they presented, such as&nbsp;<kbd>parse</kbd>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Introducing regular expressions</em> recipe</li>
<li>The <em>Using a third-party tool&mdash;parse</em> recipe</li>
</ul>
<h2>Adding command-line arguments</h2>
<p>A lot of tasks can be best structured as a command-line interface that accepts different parameters to change the way it works, for example, scrapping one web page or another. Python includes a powerful <kbd>argparse</kbd> module in the standard library to create rich command-line argument parsing with minimal effort.</p>
<h3>Getting ready</h3>
<p>The basic use of <kbd>argparse</kbd> in a script can be shown in three steps:</p>
<ol>
<li>Define the arguments that your script is going to accept, generating a new parser.</li>
<li>Call the defined parser, returning an object with all the resulting arguments.</li>
<li>Use the arguments to call the entry point of your script, which will apply the defined behavior.</li>
</ol>
<p>Try to use the following general structure for your scripts:</p>
<pre><code class="lang-python">IMPORTS

def main(main parameters):
  DO THINGS

if __name__ == '__main__':
    DEFINE ARGUMENT PARSER
    PARSE ARGS
    VALIDATE OR MANIPULATE ARGS, IF NEEDED
    main(arguments)</code></pre>
<p>The <kbd>main</kbd> function makes it easy to know what the entry point for the code is. The section under the <kbd>if</kbd> statement is only executed if the file is called directly, but not if it's imported. We'll follow this for all the steps.</p>
<h3>How to do it...</h3>
<ol>
<li>Create a script that will accept a single integer as a positional argument, and will print a hash symbol&nbsp;that amount of times. The <kbd>recipe_cli_step1.py</kbd>&nbsp;script is as follows, but note we are following the structure presented previously, and the <kbd>main</kbd> function is just printing the argument:</li>
</ol>
<pre><code class="lang-python">import argparse

def main(number):
    print('#' * number)

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('number', type=int, help='A number')
    args = parser.parse_args()
    
    main(args.number)</code></pre>
<ol start="2">
<li>Call the script and see how the parameter is presented. Calling the script with no arguments displays the automatic help. Use the automatic argument <kbd>-h</kbd> to display the extended help:</li>
</ol>
<pre><code class="lang-python">$ python3 recipe_cli_step1.py
usage: recipe_cli_step1.py [-h] number
recipe_cli_step1.py: error: the following arguments are required: number
$ python3 recipe_cli_step1.py -h
usage: recipe_cli_step1.py [-h] number
positional arguments:
 number A number
optional arguments:
 -h, --help show this help message and exit</code></pre>
<ol start="3">
<li>Calling the script with the extra parameters works as expected:</li>
</ol>
<pre><code class="lang-python">$ python3 recipe_cli_step1.py 4
####
$ python3 recipe_cli_step1.py not_a_number
usage: recipe_cli_step1.py [-h] number
recipe_cli_step1.py: error: argument number: invalid int value: 'not_a_number'</code></pre>
<ol start="4">
<li>Change the script to accept an optional argument for the character to print. The default will be <kbd>'#'</kbd>.&nbsp;The <kbd>recipe_cli_step2.py&nbsp;</kbd>&nbsp;script will look like this:</li>
</ol>
<pre><code class="lang-python">import argparse

def main(character, number):
    print(character * number)

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('number', type=int, help='A number')
    parser.add_argument('-c', type=str, help='Character to print',
                        default='#')

args = parser.parse_args()
main(args.c, args.number)</code></pre>
<ol start="5">
<li>The help is&nbsp;updated, and using the <kbd>-c</kbd> flag allows us to print different characters:</li>
</ol>
<pre><code class="lang-python">$ python3 recipe_cli_step2.py -h
usage: recipe_cli_step2.py [-h] [-c C] number

positional arguments:
 number A number

optional arguments:
 -h, --help show this help message and exit
 -c C Character to print
$ python3 recipe_cli_step2.py 4
####
$ python3 recipe_cli_step2.py 5 -c m
mmmmm</code></pre>
<ol start="6">
<li>Add a flag that changes the behavior when present.&nbsp;The <kbd>recipe_cli_step3.py</kbd> script is as follows:</li>
</ol>
<pre><code class="lang-python">import argparse

def main(character, number):
    print(character * number)

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('number', type=int, help='A number')
    parser.add_argument('-c', type=str, help='Character to print',
                        default='#')
    parser.add_argument('-U', action='store_true', default=False,
                        dest='uppercase',
                        help='Uppercase the character')
    args = parser.parse_args()

    if args.uppercase:
        args.c = args.c.upper()

    main(args.c, args.number)</code></pre>
<ol start="7">
<li>Calling it uppercases the character if the <kbd>-U</kbd>&nbsp;flag&nbsp;is added:</li>
</ol>
<pre><code class="lang-python">$ python3 recipe_cli_step3.py 4 -c f
ffff
$ python3 recipe_cli_step3.py 4 -c f -U
FFFF</code></pre>
<h3>How it works...</h3>
<p>As described in step 1 in the <em>How to do it&hellip;</em> section, the arguments are added to the parser through <kbd>.add_arguments</kbd>. Once all arguments are defined, calling <kbd>parse_args()</kbd> returns an object that contains the results (or exits if there's an error).</p>
<p>Each argument should add a help description, but their behavior can change greatly:</p>
<ul>
<li>If an argument starts with a <kbd>-</kbd>, it is considered an optional parameter, like the <kbd>-c</kbd>&nbsp;argument in step 4. If not, it's a positional argument, like the <kbd>number</kbd>&nbsp;argument in step 1.</li>
</ul>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>For clarity, always define a default value for optional parameters. It will be <kbd>None</kbd> if you don't, but this may be confusing.</p>
</div>
</div>
<ul>
<li>Remember to always add&nbsp;a help parameter with a description of the parameter; help is automatically generated, as shown in step 2.</li>
<li>If a type is present, it will be validated, for example, <kbd>number</kbd>&nbsp;in step 3. By default, the type will be string.</li>
<li>The actions <kbd>store_true</kbd>&nbsp;and <kbd>store_false</kbd>&nbsp;can be used to generate flags, arguments that don't require any extra parameters. Set the corresponding default value as the opposite Boolean. This is demonstrated in the <kbd>U</kbd>&nbsp;argument in steps 6 and 7.</li>
<li>The name of the property in the <kbd>args</kbd> object will be, by default, the name of the argument (without the dash, if it's present). You can change it with <kbd>dest</kbd>. For example, in step 6, the command-line argument <kbd>-U</kbd> is described as <kbd>uppercase</kbd>.</li>
</ul>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Changing the name of an argument for internal usage is very useful when using short arguments, such as single letters. A good command-line interface will use <kbd>-c</kbd>, but internally it's probably a good idea to use a more verbose label, such as <kbd>configuration_file</kbd>. Explicit is better than implicit!</p>
</div>
</div>
<ul>
<li>Some arguments can work in coordination with others, as shown in step 3. Perform all required operations to pass the main function as clear and concise parameters. For example, in step 3, only two parameters are passed, but one may have been modified.</li>
</ul>
<h3>There's more...</h3>
<p>You can create long arguments as well with double dashes, for example:</p>
<pre><code class="lang-python"> parser.add_argument('-v', '--verbose', action='store_true', default=False, 
                     help='Enable verbose output')</code></pre>
<p>This will accept both <kbd>-v</kbd> and&nbsp;<kbd>--verbose</kbd>, and it will store the name <kbd>verbose</kbd>.&nbsp;</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Adding long names is a good way of making the interface more intuitive and easy to remember. It's easy to remember after a couple of times that there's a verbose option, and it starts with a <kbd>v</kbd>.</p>
</div>
</div>
<p>The main inconvenience when dealing with command-line arguments may be ending up with too many of them. This creates confusion. Try to make your arguments as independent as possible and not make too many dependencies between them, or handling the combinations can be tricky.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>In particular, try to not create more than a couple of positional arguments, as they won't have mnemonics. Positional arguments also accept default values, but most of the time that won't be the expected behavior.</p>
</div>
</div>
<p>For advanced details, check the Python documentation of <kbd>argparse</kbd> (<a href="https://docs.python.org/3/library/argparse.html">https://docs.python.org/3/library/argparse.html</a>).</p>
<h3>See also</h3>
<ul>
<li>The <em>Creating a virtual environment</em> recipe</li>
<li>The <em>Installing third-party packages</em> recipe</li>
</ul>

</div>


<!--Chapter 2-->

<div class="chapter" data-chapter-number="2">
<div class="chapter-start">
<div class="ch-head">Chapter <span class="chapter-number"> 2 </span></div>
<h1 class="chaptertitle">Automating Tasks Made Easy</h1>
<h3 class="author">Jaime Buelta</h3>
</div>

<p>In this chapter, we'll cover the following recipes:</p>
<ul>
<li>Preparing a task</li>
<li>Setting up a cron job</li>
<li>Capturing errors and problems</li>
<li>Sending email notifications</li>
</ul>
<h2>Introduction</h2>
<p>To properly automate tasks, we need a platform so that they run automatically at the proper times. A task that needs to be run manually is not really fully automated.</p>
<p>But, in order to be able to leave them running in the background while worrying about more pressing issues, the task will need to be adequate to run in <em>fire-and-forget</em>&nbsp;mode. We should be able to monitor that it runs correctly, be sure that we are capturing future actions (such as receiving notifications if something interesting arises), and know whether there have been any errors while running it.</p>
<p>Ensuring that a piece of software runs consistently with a high reliability is actually a very big deal&nbsp;and is one area that, to be done properly, requires specialized knowledge and staff,&nbsp;which typically go by the names of sysadmin, operations, or <strong>SRE</strong> (<strong>Site Reliability Engineering</strong>). Sites&nbsp;like Amazon and Google require huge investment in ensuring that everything works 24/7.</p>
<p>The objective for this book is way more modest than that. You probably don't require a downtime lower than a few seconds per year. Running a task with reasonable reliability is a much easier thing to do. But, be aware that there's maintenance to be done, so be prepared for that.</p>
<h2>Preparing a task</h2>
<p>It all starts with defining exactly what task needs to be run, and designing it in a way that doesn't require human intervention to run.</p>
<p>Some ideal characteristic points are as follows:</p>
<ol>
<li><strong>Single, clear entry point</strong>:&nbsp;No confusion on what the task to run is.</li>
<li><strong>Clear parameters</strong>:&nbsp;If there are any parameters, they should be very explicit.</li>
<li><strong>No interactivity</strong>:&nbsp;Stopping the execution to request information from the user is not possible.</li>
<li><strong>The result should be stored</strong>: To be able to be checked at a different time than when it runs.</li>
<li><strong>Clear result</strong>:&nbsp;If we are working interactively in a result, we accept more verbose results, or progress reports. But, for an automated task, the final result should be as concise and to the point as possible.</li>
<li><strong>Errors should be logged</strong>: To analyze what went wrong.&nbsp;</li>
</ol>
<p>A command-line program has a lot of those characteristics already. It has a clear way of running, with defined parameters, and the result can be stored, even if just in text format. But, it can be improved with a config file to clarify the parameters, and an output file.</p>
<p>Note that point&nbsp;6&nbsp;is the objective of the <em>Capturing errors and problems</em> recipe, and will be covered there.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>To avoid interactivity, do not use any command that stops for the user to input, like <kbd>input</kbd>. Remember to delete breakpoints for debugging!</p>
</div>
</div>
<h3>Getting ready</h3>
<p>We'll start by following a structure in which a main function will serve as the entry point, and all parameters are supplied to it.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>This&nbsp;is the same the basic structure&nbsp;the was presented in the <em>Adding command-line arguments</em> recipe in Chapter 1,&nbsp;<em>Let's Begin Our Automation Journey</em>.</p>
</div>
</div>
<p>The definition of a main function will all the explicit arguments covers points 1 and 2.&nbsp;Point 3 is not difficult to achieve.</p>
<p>To improve point 2 and 5, we'll look at retrieving the configuration from a file and storing the result in another. Another option is to send a notification, such as an email, which will be covered later in this chapter.</p>
<h3>How to do it...</h3>
<ol>
<li>Prepare the following task&nbsp;and save it as&nbsp;<kbd>prepare_task_step1.py</kbd>:</li>
</ol>
<pre><code class="lang-python">import argparse


def main(number, other_number):
    result = number * other_number
    print(f'The result is {result}')


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-n1', type=int, help='A number', default=1)
    parser.add_argument('-n2', type=int, help='Another number', default=1)

    args = parser.parse_args()

    main(args.n1, args.n2)</code></pre>
<ol start="2">
<li>Update the file to define a config file that contains both arguments, and save it as <kbd>prepare_task_step2.py</kbd>. Note that defining a config file overwrites any command-line parameters:</li>
</ol>
<pre><code class="lang-python">import argparse
import configparser


def main(number, other_number):
    result = number * other_number
    print(f'The result is {result}')


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-n1', type=int, help='A number', default=1)
    parser.add_argument('-n2', type=int, help='Another number', default=1)

    parser.add_argument('--config', '-c', type=argparse.FileType('r'),
                        help='config file')

    args = parser.parse_args()
    if args.config:
        config = configparser.ConfigParser()
        config.read_file(args.config)
        # Transforming values into integers
        args.n1 = int(config['DEFAULT']['n1'])
        args.n2 = int(config['DEFAULT']['n2'])

    main(args.n1, args.n2)</code></pre>
<ol start="3">
<li>Create the config file <kbd>config.ini</kbd>:</li>
</ol>
<pre><code class="lang-python">[ARGUMENTS]
n1=5
n2=7</code></pre>
<ol start="4">
<li>Run the command with the config file. Note that the config file overwrites the command-line parameters, as described in step 2:</li>
</ol>
<pre><code class="lang-python">$ python3 prepare_task_step2.py -c config.ini
The result is 35
$ python3 prepare_task_step2.py -c config.ini -n1 2 -n2 3
The result is 35</code></pre>
<ol start="5">
<li>Add a parameter&nbsp;to store the result in a file, and save it as <kbd>prepare_task_step5.py</kbd>:</li>
</ol>
<pre><code class="lang-python">import argparse
import sys
import configparser


def main(number, other_number, output):
    result = number * other_number
    print(f'The result is {result}', file=output)


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-n1', type=int, help='A number', default=1)
    parser.add_argument('-n2', type=int, help='Another number', default=1)

    parser.add_argument('--config', '-c', type=argparse.FileType('r'),
                        help='config file')
    parser.add_argument('-o', dest='output', type=argparse.FileType('w'),
                        help='output file',
                        default=sys.stdout)

    args = parser.parse_args()
    if args.config:
        config = configparser.ConfigParser()
        config.read_file(args.config)
        # Transforming values into integers
        args.n1 = int(config['DEFAULT']['n1'])
        args.n2 = int(config['DEFAULT']['n2'])

    main(args.n1, args.n2, args.output)</code></pre>
<ol start="6">
<li>Run the result to check that it's sending the output to the defined file. Note that there's no output outside the result files:</li>
</ol>
<pre><code class="lang-python">$ python3 prepare_task_step5.py -n1 3 -n2 5 -o result.txt
$ cat result.txt
The result is 15
$ python3 prepare_task_step5.py -c config.ini -o result2.txt
$ cat result2.txt
The result is 35</code></pre>
<h3>How it works...</h3>
<p>Note that the <kbd>argparse</kbd> module allows us to define files as parameters, with the&nbsp;<kbd>argparse.FileType</kbd> type, and opens them automatically. This is very handy, and will raise an error if the file is not valid.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Remember to open the file in the correct mode. In Step 5, the config file is opened in read mode (<kbd>r</kbd>) and the output file in write mode (<kbd>w</kbd>), which will overwrite the file if it exists. You may find the append mode (<kbd>a</kbd>), which will add the next piece of data at the end of an existing file.</p>
</div>
</div>
<p>The <kbd>configparser</kbd> module allows us to use config files with ease. As demonstrated in Step 2, the parsing of the file is as simple as follows:</p>
<pre><code class="lang-python">config = configparser.ConfigParser()
config.read_file(file)</code></pre>
<p>The config will then be accessible as a dictionary divided by sections, and then values. Note that the values are always stored in string format, requiring to be transformed into other types, such as integers:</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>If you need to obtain boolean values, do not perform <kbd>value = bool(config[raw_value])</kbd>&nbsp;as it will be transformed into <kbd>True</kbd> no matter what; for instance, the string <kbd>False</kbd> is a true string, as it's not empty. Use the <kbd>.getboolean</kbd> method instead, for example, <kbd>value = config.getboolean(raw_value)</kbd>.</p>
</div>
</div>
<p>Python3 allows us to pass a <kbd>file</kbd> parameter to the <kbd>print</kbd> function, which will write to that file. Step 5 shows the usage to redirect all the printed information to a file.&nbsp;</p>
<p>Note that the default parameter is <kbd>sys.stdout</kbd>, which will print the value to the Terminal (standard output). This makes it so that calling the script without an <kbd>-o</kbd> parameter will display the information on the screen, which is helpful in debugging:</p>
<pre><code class="lang-python">$ python3 prepare_task_step5.py -c config.ini
The result is 35
$ python3 prepare_task_step5.py -c config.ini -o result.txt
$ cat result.txt
The result is 35</code></pre>
<h3>There's more...</h3>
<p>Please check out the full documentation of <kbd>configparse</kbd> in the official Python documentation:&nbsp;<a href="https://docs.python.org/3/library/configparser.html">https://docs.python.org/3/library/configparser.html.</a></p>
<p>In most cases, this configuration parser should be good enough, but if more power is needed, you can use YAML files as configuration files. YAML files (<a href="https://learn.getgrav.org/advanced/yaml">https://learn.getgrav.org/advanced/yaml</a>) are very common as configuration files, and are better structured and can be parsed directly, taking into account data types.</p>
<ol>
<li>Add PyYAML to the <kbd>requirements.txt</kbd> file and install it:&nbsp;</li>
</ol>
<pre><code class="lang-python">PyYAML==3.12</code></pre>
<ol start="2">
<li>Create the <kbd>prepare_task_yaml.py</kbd> file:</li>
</ol>
<pre><code class="lang-python">import yaml
import argparse
import sys


def main(number, other_number, output):
    result = number * other_number
    print(f'The result is {result}', file=output)


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-n1', type=int, help='A number', default=1)
    parser.add_argument('-n2', type=int, help='Another number', default=1)

    parser.add_argument('-c', dest='config', type=argparse.FileType('r'),
 help='config file in YAML format',
 default=None)
    parser.add_argument('-o', dest='output', type=argparse.FileType('w'),
                        help='output file',
                        default=sys.stdout)

    args = parser.parse_args()
    if args.config:
        config = yaml.load(args.config)
        # No need to transform values
        args.n1 = config['ARGUMENTS']['n1']
        args.n2 = config['ARGUMENTS']['n2']

    main(args.n1, args.n2, args.output)</code></pre>
<ol start="3">
<li>Define the config file <kbd>config.yaml,</kbd> available in GitHub&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter02/config.yaml">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter02/config.yaml</a><a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/chapter2/config.yaml">&nbsp;</a>:</li>
</ol>
<pre><code class="lang-python">ARGUMENTS:
    n1: 7
    n2: 4</code></pre>
<ol start="4">
<li>Then, run the following:</li>
</ol>
<pre><code class="lang-python">$ python3 prepare_task_yaml.py -c config.yaml
The result is 28

</code></pre>
<p>There's also the possibility of setting a default config file, as well as a default output file. This can be handy to create a pure task that requires no input parameters.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>As a general rule, try to avoid creating too many input and configuration parameters if the task has a very specific objective in mind. Try to limit the input parameters to different executions of the task. A parameter that never changes is probably fine being defined as a <strong>constant</strong>. A high number of parameters will make config files or command-line arguments complicated and will create more maintenance in the long run. On the other hand, if your objective is to create a very flexible tool to be used in very different situations, then creating more parameters is probably a good idea. Try to find your own proper balance!</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The <em>Command-line arguments</em> recipe in Chapter 1,&nbsp;<em>Let's Begin Our Automation Journey</em></li>
<li>The <em>Sending email notifications</em> recipe</li>
<li>The <em>Debugging with breakpoints</em> recipe in Chapter 10,&nbsp;<em>Debugging Techniques</em></li>
</ul>
<h2>Setting up a cron job</h2>
<p>Cron is an old-fashioned but reliable way of executing commands. It has been around since the 70s in Unix, and it's an old favorite in system administration to perform maintenance, such as freeing space, rotating logs, making backups, and other common operations.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>This recipe is Unix-specific, so it will work in Linux and MacOS. While it's possible to schedule a task in Windows, it's very different and uses Task Scheduler, which won't be described here. If you have access to a Linux server, it can be a good way of scheduling periodic tasks.</p>
</div>
</div>
<p>The main advantages are as follows:</p>
<ul>
<li>It's present in virtually all Unix or Linux systems and configured to run automatically.</li>
<li>It's easy to use, though a little deceptive.</li>
<li>It's well-known. Almost anyone involved with admin tasks will have a general idea on how to use it.</li>
<li>It allows for easy periodic commands, with good precision.</li>
</ul>
<p>But, it also has&nbsp;some disadvantages, as follows:</p>
<ul>
<li>By default, it may not give much feedback. Retrieving the output, logging execution, and errors is critical.</li>
<li>The task should be as self-contained as possible to avoid problems with environment variables, such as using the wrong Python interpreter, or what path should execute.</li>
<li>It is Unix-specific.</li>
<li>Only fixed periodic times are available.</li>
<li>It doesn't control how many tasks run at the same time. Each time the countdown goes off, it creates a new task. For example, a task that takes one hour to complete, and that is scheduled to run once every 45 minutes, will have 15 minutes of overlap where two tasks will be running.</li>
</ul>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Don't understate the latest effect. Running multiple expensive tasks at the same time can have bad effects on performance. Having expensive tasks overlapping may result in a race condition where each task is making the others never finish! Allow ample time for your tasks to finish and keep an eye on them.</p>
</div>
</div>
<h3>Getting ready</h3>
<p>We will produce a script, called &nbsp;<kbd>cron.py</kbd>:</p>
<pre><code class="lang-python">import argparse
import sys
from datetime import datetime
import configparser


def main(number, other_number, output):
    result = number * other_number
    print(f'[{datetime.utcnow().isoformat()}] The result is {result}', 
          file=output)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    parser.add_argument('--config', '-c', type=argparse.FileType('r'),
                        help='config file',
                        default='/etc/automate.ini')
    parser.add_argument('-o', dest='output', type=argparse.FileType('a'),
                        help='output file',
                        default=sys.stdout)

    args = parser.parse_args()
    if args.config:
        config = configparser.ConfigParser()
        config.read_file(args.config)
        # Transforming values into integers
        args.n1 = int(config['DEFAULT']['n1'])
        args.n2 = int(config['DEFAULT']['n2'])

    main(args.n1, args.n2, args.output)</code></pre>
<p>Note the following details:</p>
<ol>
<li>The config file, is by default,&nbsp;<kbd>/etc/automate.ini</kbd>.&nbsp;Reuse&nbsp;<kbd>config.ini</kbd> from the previous recipe.</li>
<li>A timestamp has been added to the output. This will make it explicit when the task is run.</li>
<li>The result is being added to the file, as shown with the <kbd>'a'</kbd> mode where the file is open.</li>
<li>The <kbd>ArgumentDefaultsHelpFormatter</kbd> parameter automatically adds information about default values when printing the help using the <kbd>-h</kbd> argument.</li>
</ol>
<p>Check that the task is producing the expected result and that you can log to a known file:</p>
<pre><code class="lang-python">$ python3 cron.py
[2018-05-15 22:22:31.436912] The result is 35
$ python3 cron.py -o /path/automate.log
$ cat /path/automate.log
[2018-05-15 22:28:08.833272] The result is 35</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Obtain the full path of the Python interpreter. This is the interpreter that's on your virtual environment:</li>
</ol>
<pre><code class="lang-python">$ which python
/your/path/.venv/bin/python</code></pre>
<ol start="2">
<li>Prepare the cron to be executed. Get the full path and check that it can be executed with no problem. Execute it a couple of times:</li>
</ol>
<pre><code class="lang-python">$ /your/path/.venv/bin/python /your/path/cron.py -o /path/automate.log
$ /your/path/.venv/bin/python /your/path/cron.py -o /path/automate.log

</code></pre>
<ol start="3">
<li>Check that the result is being added correctly to the result file:</li>
</ol>
<pre><code class="lang-python">$ cat /path/automate.log
[2018-05-15 22:28:08.833272] The result is 35
[2018-05-15 22:28:10.510743] The result is 35</code></pre>
<ol start="4">
<li>Edit the crontab file to run the task once every five minutes:</li>
</ol>
<pre><code class="lang-python">$ crontab -e

*/5 * * * * /your/path/.venv/bin/python /your/path/cron.py -o /path/automate.log</code></pre>
<p>Note that this opens an editing Terminal with your default command-line editor.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>If you haven't set up your default command-line editor, by default, it is likely Vim. This can be disconcerting if you don't have experience with Vim. Press <em>I</em> to start inserting text and <em>Esc&nbsp;</em>when you're done. Then, exit after saving the file with <kbd>:wq</kbd>. For more information about Vim, see this introduction: <a href="https://null-byte.wonderhowto.com/how-to/intro-vim-unix-text-editor-every-hacker-should-be-familiar-with-0174674">https://null-byte.wonderhowto.com/how-to/intro-vim-unix-text-editor-every-hacker-should-be-familiar-with-0174674</a>.<br />For information on how to change the default command-line editor, see the following: <a href="https://www.a2hosting.com/kb/developer-corner/linux/setting-the-default-text-editor-in-linux">https://www.a2hosting.com/kb/developer-corner/linux/setting-the-default-text-editor-in-linux.</a></p>
</div>
</div>
<ol start="5">
<li>Check the crontab contents. Note that this displays the crontab contents, but doesn't set it to edit:</li>
</ol>
<pre><code class="lang-python">$ contab -l
*/5 * * * * /your/path/.venv/bin/python /your/path/cron.py -o /path/automate.log</code></pre>
<ol start="6">
<li>Wait and check the result file to see how the task is being executed:</li>
</ol>
<pre><code class="lang-python">$ tail -F /path/automate.log
[2018-05-17 21:20:00.611540] The result is 35
[2018-05-17 21:25:01.174835] The result is 35
[2018-05-17 21:30:00.886452] The result is 35</code></pre>
<h3>How it works...</h3>
<p>The crontab line consists of a line describing how often to run the task (first six elements), plus the task. Each of the initial six elements mean a different unit of time to execute. Most of them are stars, meaning <em>any</em>:</p>
<pre><code class="lang-python">* * * * * *
| | | | | | 
| | | | | +-- Year              (range: 1900-3000)
| | | | +---- Day of the Week   (range: 1-7, 1 standing for Monday)
| | | +------ Month of the Year (range: 1-12)
| | +-------- Day of the Month  (range: 1-31)
| +---------- Hour              (range: 0-23)
+------------ Minute            (range: 0-59)</code></pre>
<p>Therefore, our line, <kbd>*/5 * * * * *</kbd>, means <em>every time the minute is divisible by 5, in all hours, all days... all years</em>.</p>
<p>Here are some examples:</p>
<pre><code class="lang-python">30  15 * * * * means "every day at 15:30"
30   * * * * * means "every hour, at 30 minutes"
0,30 * * * * * means "every hour, at 0 minutes and 30 minutes"
*/30 * * * * * means "every half hour"
0    0 * * 1 * means "every Monday at 00:00"</code></pre>
<p>Do not try to guess too much. Use a cheat sheet like&nbsp;<a href="https://crontab.guru/">https://crontab.guru/</a> for examples and tweaks. Most of the common usages will be described there directly. You can also edit a formula and get a descriptive text on how it's going to run.</p>
<p>After the description of how to run the cron job, include the line to execute the task, as prepared in Step 2 in the <em>How to do it&hellip;</em> section.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Note that the task is described with all the full paths for every related file&mdash;the interpreter, the script, and the output file. This removes all ambiguity related to paths and reduces the chances of possible errors. A very common one is not being able to determine one (or more) of the three elements.</p>
</div>
</div>
<h3>There's more...</h3>
<p>If there's any problem in the execution of the crontab, you should receive a system mail. This will show up as a message in the Terminal, like this:</p>
<pre><code class="lang-python">You have mail.
$</code></pre>
<p>This can be read with <kbd>mail</kbd>:</p>
<pre><code class="lang-python">$ mail
Mail version 8.1 6/6/93. Type ? for help.
"/var/mail/jaime": 1 message 1 new
&gt;N 1 jaime@Jaimes-iMac-5K Thu May 17 21:15 19/914 "Cron &lt;jaime@Jaimes-iM"
? 1
Message 1:
...
/usr/local/Cellar/python/3.7.0/Frameworks/Python.framework/Versions/3.7/Resources/Python.app/Contents/MacOS/Python: can't open file 'cron.py': [Errno 2] No such file or directory</code></pre>
<p>In the next recipe, we will see methods to capture the errors independently so that the task can run smoothly.</p>
<h3>See also</h3>
<ul>
<li>The <em>Adding command-line options</em> recipe in Chapter 1, <em>Let's Begin Our Automation Journey</em></li>
<li>The <em>Capturing errors and problems</em> recipe</li>
</ul>
<h2>Capturing errors and problems</h2>
<p>An automated task's main characteristic is its <em>fire-and-forget</em>&nbsp;quality. We are not actively looking at the result, but making it run in the background.</p>
<p>Also, as most of the recipes in this book deal with external information, such as web pages or other reports, the likelihood of finding an unexpected problem when running it is high. This recipe will present an automated task that will safely store unexpected behaviors in a log file that can be checked afterwards.</p>
<h3>Getting ready</h3>
<p>As a starting point, we'll use a task that will divide two numbers, as described in the command line.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>This task is very similar to the one presented in Step 5 in the <em>How to do it&hellip;</em> section, but instead of multiplying two numbers, we'll divide them.</p>
</div>
</div>
<h3>How to do it...</h3>
<ol>
<li>Create the <kbd>task_with_error_handling_step1.py</kbd> file, as follows:</li>
</ol>
<pre><code class="lang-python">import argparse
import sys

def main(number, other_number, output):
    result = number / other_number
    print(f'The result is {result}', file=output)

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-n1', type=int, help='A number', default=1)
    parser.add_argument('-n2', type=int, help='Another number', default=1)      
    parser.add_argument('-o', dest='output', type=argparse.FileType('w'),
                        help='output file', default=sys.stdout)

    args = parser.parse_args()

    main(args.n1, args.n2, args.output)</code></pre>
<ol start="2">
<li>Execute it a couple of times to see that it divides two numbers:</li>
</ol>
<pre><code class="lang-python">$ python3 task_with_error_handling_step1.py -n1 3 -n2 2
The result is 1.5
$ python3 task_with_error_handling_step1.py -n1 25 -n2 5
The result is 5.0</code></pre>
<ol start="3">
<li>Check that dividing by <kbd>0</kbd> produces an error, and that the error is not logged on the result file:</li>
</ol>
<pre><code class="lang-python">$ python task_with_error_handling_step1.py -n1 5 -n2 1 -o result.txt
$ cat result.txt
The result is 5.0
$ python task_with_error_handling_step1.py -n1 5 -n2 0 -o result.txt
Traceback (most recent call last):
 File "task_with_error_handling_step1.py", line 20, in &lt;module&gt;
 main(args.n1, args.n2, args.output)
 File "task_with_error_handling_step1.py", line 6, in main
 result = number / other_number
ZeroDivisionError: division by zero
$ cat result.txt</code></pre>
<ol start="4">
<li>Create the <kbd>task_with_error_handling_step4.py</kbd> file:</li>
</ol>
<pre><code class="lang-python">import logging
import sys
import logging

LOG_FORMAT = '%(asctime)s %(name)s %(levelname)s %(message)s'
LOG_LEVEL = logging.DEBUG


def main(number, other_number, output):
    logging.info(f'Dividing {number} between {other_number}')
    result = number / other_number
    print(f'The result is {result}', file=output)


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-n1', type=int, help='A number', default=1)
    parser.add_argument('-n2', type=int, help='Another number', default=1)

    parser.add_argument('-o', dest='output', type=argparse.FileType('w'),
                        help='output file', default=sys.stdout)
    parser.add_argument('-l', dest='log', type=str, help='log file',
                        default=None)

    args = parser.parse_args()
    if args.log:
        logging.basicConfig(format=LOG_FORMAT, filename=args.log,
                            level=LOG_LEVEL)
    else:
        logging.basicConfig(format=LOG_FORMAT, level=LOG_LEVEL)

    try:
        main(args.n1, args.n2, args.output)
    except Exception as exc:
        logging.exception("Error running task")
        exit(1)</code></pre>
<ol start="5">
<li>Run it to check that it displays the proper <kbd>INFO</kbd> and <kbd>ERROR</kbd> log, and that it stores it on the log file:</li>
</ol>
<pre><code class="lang-python">$ python3 task_with_error_handling_step4.py -n1 5 -n2 0
2018-05-19 14:25:28,849 root INFO Dividing 5 between 0
2018-05-19 14:25:28,849 root ERROR division by zero
Traceback (most recent call last):
  File "task_with_error_handling_step4.py", line 31, in &lt;module&gt;
    main(args.n1, args.n2, args.output)
  File "task_with_error_handling_step4.py", line 10, in main
    result = number / other_number
ZeroDivisionError: division by zero
$ python3 task_with_error_handling_step4.py -n1 5 -n2 0 -l error.log
$ python3 task_with_error_handling_step4.py -n1 5 -n2 0 -l error.log
$ cat error.log
2018-05-19 14:26:15,376 root INFO Dividing 5 between 0
2018-05-19 14:26:15,376 root ERROR division by zero
Traceback (most recent call last):
  File "task_with_error_handling_step4.py", line 33, in &lt;module&gt;
    main(args.n1, args.n2, args.output)
  File "task_with_error_handling_step4.py", line 11, in main
    result = number / other_number
ZeroDivisionError: division by zero
2018-05-19 14:26:19,960 root INFO Dividing 5 between 0
2018-05-19 14:26:19,961 root ERROR division by zero
Traceback (most recent call last):
  File "task_with_error_handling_step4.py", line 33, in &lt;module&gt;
    main(args.n1, args.n2, args.output)
  File "task_with_error_handling_step4.py", line 11, in main
    result = number / other_number
ZeroDivisionError: division by zero</code></pre>
<h3>How it works...</h3>
<p>To properly capture any unexpected exceptions, the main function should be wrapped into a <kbd>try-except</kbd> block, as done in Step 4 in the <em>How to do it&hellip;</em> section. Compare this to how Step 1 is not wrapping the code:</p>
<pre><code class="lang-python">    try:
        main(...)
    except Exception as exc:
        # Something went wrong
        logging.exception("Error running task")
        exit(1)</code></pre>
<p>Note that logging the exception is important for getting information on what went wrong.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>This kind of exception is nicknamed <em>Pok&eacute;mon</em>, because it can <em>catch'em all</em>, as it will capture any unexpected error at the highest level. Do not use it in other areas of the code, as capturing everything can hide unexpected errors. At the very least, any unexpected exception should be logged to allow for further analysis.</p>
</div>
</div>
<p>The extra step to exit with status 1 with the <kbd>exit(1)</kbd> call informs the operating system that something went wrong with our script.</p>
<p>The <kbd>logging</kbd> module allows us to log. Note the basic configuration, which includes an optional file to store the logs, the format, and the level of the logs to display.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The available level for logs are, from less critical to more critical&mdash;<kbd>DEBUG</kbd>, <kbd>INFO</kbd>, <kbd>WARNING</kbd>, <kbd>ERROR</kbd>, and <kbd>CRITICAL</kbd>. The logging level will set the minimal severity required to log the message. For example, an <kbd>INFO</kbd> log won't be stored if the severity is set to <kbd>WARNING</kbd>.</p>
</div>
</div>
<p>Creating logs is easy. You can do this by making a call to the method&nbsp;<kbd>logging.&lt;logging level&gt;</kbd>, (where <kbd>logging level</kbd> is <kbd>debug</kbd>, <kbd>info</kbd>, and so on). For example:</p>
<pre><code class="lang-python">&gt;&gt;&gt; import logging
&gt;&gt;&gt; logging.basicConfig(level=logging.INFO)
&gt;&gt;&gt; logging.warning('a warning message')
WARNING:root:a warning message
&gt;&gt;&gt; logging.info('an info message')
INFO:root:an info message
&gt;&gt;&gt; logging.debug('a debug message')
&gt;&gt;&gt;</code></pre>
<p>Note how logs with a&nbsp;severity lower than <kbd>INFO</kbd> are not displayed. Use the level definition to tweak how much information to display. This may change, for example, how <kbd>DEBUG</kbd> logs may be used only while developing the task, but not be displayed when running it. Notice that&nbsp;<kbd>task_with_error_handling_step4.py</kbd> is defining the logging level to be <kbd>DEBUG</kbd>, by default.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>A good definition of log levels is key to displaying relevant information, while reducing spam. It is not easy to set up sometimes, but especially if more than one person is involved, try to agree on exactly what <kbd>WARNING</kbd> versus <kbd>ERROR</kbd> means to avoid misinterpretations.</p>
</div>
</div>
<p><kbd>logging.exception()</kbd> is a special case that will create an <kbd>ERROR</kbd> log, but it will also include information about the exception, such as the <strong>stack trace</strong>.</p>
<p>Remember to check logs to discover errors. A useful reminder is to add a note on the results file, like this:</p>
<pre><code class="lang-python">try:
    main(args.n1, args.n2, args.output)
except Exception as exc:
    logging.exception(exc)
    print('There has been an error. Check the logs', file=args.output)</code></pre>
<h3>There's more...</h3>
<p>The Python <kbd>logging</kbd> module has a lot of capabilities, such as the following:</p>
<ul>
<li>Further tweaks the format of the log, for example, including the file and line number of the log that was produced.</li>
<li>Defines different logger objects, each one with its own configuration, like logging level and format. This allows to produce logs to different systems in different ways, though is normally not used for simplicity.</li>
<li>Sends logs to multiple places, such as that standard output and file, or even a remote logger.</li>
<li>Automatically rotates logs, creating new log files after a certain time or size. This is handy in keeping logs organized by day, and allowing for the compression or removal of old logs.</li>
<li>Reads standard logging configurations from files.</li>
</ul>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Instead of creating complex rules, try to log&nbsp; extensively, but&nbsp;with the proper level, and then filter.</p>
</div>
</div>
<p>For comprehensive detail, check the Python docs of the module at <a href="https://docs.python.org/3.7/library/logging.html">https://docs.python.org/3.7/library/logging.html</a>, or the tutorial at <a href="https://docs.python.org/3.7/howto/logging.html">https://docs.python.org/3.7/howto/logging.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Adding command-line options</em> recipe in Chapter 1,&nbsp;<em>Let's Begin Our Automation Journey</em></li>
<li>The <em>Preparing a task</em> recipe</li>
</ul>
<h2>Sending email notifications</h2>
<p>Email has become an inescapable tool that everyone uses everyday. It's probably the best place to send a notification if an automated task has detected something. On the other hand, email inboxes are already too filled up with spam messages, so be careful.&nbsp;</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Spam filters are also a reality. Be careful with who to send emails to and the number of emails to be sent. An email server or address can be labelled as <em>spam,</em> and all emails will be quietly dropped by the internet.</p>
</div>
</div>
<p>This recipe will show how to send a single email, using an already existing email account.</p>
<p>This approach is viable for spare emails sent to a couple of people, as a result from an automated task, but no more than that.</p>
<h3>Getting ready</h3>
<p>For this recipe, we require&nbsp;a valid email account set up, which includes the following:</p>
<ul>
<li>A valid email server</li>
<li>A port to connect to</li>
<li>An address</li>
<li>A password</li>
</ul>
<p>These four elements should be enough to be able to send an email.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Some email services, for example, Gmail, will encourage you to set up 2FA, meaning that a password is not enough to send an email. Typically, they'll allow you to create an specific password for apps to use, bypassing the 2FA request. Check your email provider's information for options.</p>
</div>
</div>
<p>The email provider to use should indicate what the SMTP server is and port to use in their documentation. They can be retrieved from email clients as well, as they are the same parameters. Check your provider documentation. In the following example, we will use a Gmail account.</p>
<h3>How to do it...</h3>
<ol>
<li>Create the <kbd>email_task.py</kbd> file, as follows:</li>
</ol>
<pre><code class="lang-python">import argparse
import configparser

import smtplib 
from email.message import EmailMessage


def main(to_email, server, port, from_email, password):
    print(f'With love, from {from_email} to {to_email}')

    # Create the message
    subject = 'With love, from ME to YOU'
    text = '''This is an example test'''
    msg = EmailMessage()
    msg.set_content(text)
    msg['Subject'] = subject
    msg['From'] = from_email
    msg['To'] = to_email

    # Open communication and send
    server = smtplib.SMTP_SSL(server, port)
    server.login(from_email, password)
    server.send_message(msg)
    server.quit()


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('email', type=str, help='destination email')
    parser.add_argument('-c', dest='config', type=argparse.FileType('r'),
                        help='config file', default=None)

    args = parser.parse_args()
    if not args.config:
        print('Error, a config file is required')
        parser.print_help()
        exit(1)

    config = configparser.ConfigParser()
    config.read_file(args.config)

    main(args.email,
         server=config['DEFAULT']['server'],
         port=config['DEFAULT']['port'],
         from_email=config['DEFAULT']['email'],
         password=config['DEFAULT']['password'])</code></pre>
<ol start="2">
<li>Create a configuration file called <kbd>email_conf.ini</kbd> with the specifics of your email account. For example, for a Gmail account, fill the following template. The template is available in GitHub <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter02/email_conf.ini">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter02/email_conf.ini</a>, but be sure to fill it with your data:</li>
</ol>
<pre><code class="lang-python">[DEFAULT]
email = EMAIL@gmail.com
server = smtp.gmail.com
port = 465
password = PASSWORD</code></pre>
<ol start="3">
<li>Ensure that the file cannot be read or written by other users on the system, setting the permissions of the file to allow only our user. <kbd>600</kbd> permissions means read and write access for our user, and no access to anyone else:</li>
</ol>
<pre><code class="lang-python">$ chmod 600 email_config.ini</code></pre>
<ol start="4">
<li>Run the script to send a test email:</li>
</ol>
<pre><code class="lang-python">$ python3 email_task.py -c email_config.ini destination_email@server.com</code></pre>
<ol start="5">
<li>Check the inbox of the destination email; an email should be received with the subject&nbsp;<kbd>With love, from ME to YOU</kbd>.</li>
</ol>
<h3>How it works...</h3>
<p>There are two key steps in the scripts&mdash;the generation of the message, and the sending.</p>
<p>The message needs to contain mainly the <kbd>To</kbd> and <kbd>From</kbd> email addresses, as well as the <kbd>Subject</kbd>. If the content is pure text, as in this case, calling <kbd>.set_content()&nbsp;</kbd> is enough. The whole message can then be sent.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>It is technically possible to send an email from a different email than the account used to send it. This is discouraged, though, as it can be considered by your email provider as trying to impersonate a different email. You can use the <kbd>reply-to</kbd> header as a way of allowing answering to a different account.</p>
</div>
</div>
<p>Sending the email requires you to connect to the specified server and start an SMPT connection. SMPT is the standard for email communication.&nbsp;</p>
<p>The steps are quite straightforward&mdash;configure the server, log into it, send the prepared message, and quit.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>If you need to send more than one message, you can log in, send multiple emails, and then quit, instead of connecting each time.</p>
</div>
</div>
<h3>There's more...</h3>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>If the objective is a bigger operation, like a marketing campaign, or even production emails like confirming a user's email, please check Chapter 8,&nbsp;<em>Dealing with Communication Channels</em></p>
</div>
</div>
<p>The email message content used in this recipe is very simple, but emails can be much more complicated than that.</p>
<p>The <kbd>To</kbd> field can contain multiple recipients. Separate them with commas, like this:</p>
<pre><code class="lang-python">message['To'] = ','.join(recipients)</code></pre>
<p>Emails can be defined in HTML, with an alternative plain text, and have attachments. The basic operation is to set up a <kbd>MIMEMultipart</kbd> and then attach each of the MIME parts that compose the email:</p>
<pre><code class="lang-python">from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.image import MIMEImage

message = MIMEMultipart()
part1 = MIMEText('some text', 'plain')
message.attach(part1)
with open('path/image', 'rb') as image:
    part2 = MIMEImage(image.read())
message.attach(part2)</code></pre>
<p>The most common SMPT connection is <kbd>SMPT_SSL</kbd>, which is more secure and requires a login and password, but plain, unauthenticated SMPT exists; check your email provider documentation.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Remember that this recipe is aimed for simple notifications. Emails can grow quite complex if attaching different information. If your objective is an email for customers or any general group, try to use the ideas in Chapter 8, <em>Dealing with Communication Channels</em>.</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The <em>Adding command-line options</em> recipe in&nbsp;Chapter 1, <em>Let's Begin Our Automation Journey</em></li>
<li>The <em>Preparing a task</em> recipe</li>
</ul>

</div>


<!--Chapter 3-->


<div class="chapter" data-chapter-number="3">
<div class="chapter-start">
<div class="ch-head">Chapter <span class="chapter-number"> 3 </span></div>
<h1 class="chaptertitle">Building Your First Web Scraping Application</h1>
<h3 class="author">Jaime Buelta</h3>
</div>

<p>In this chapter, we'll cover the following recipes:</p>
<ul>
<li>Downloading web pages</li>
<li>Parsing HTML</li>
<li>Crawling the web</li>
<li>Subscribing to feeds</li>
<li>Accessing web APIs</li>
<li>Interacting with forms</li>
<li>Using Selenium for advanced interaction</li>
<li>Accessing password-protected pages</li>
<li>Speeding up web scraping</li>
</ul>
<h2>Introduction</h2>
<p>The internet, and the&nbsp;<strong>WWW</strong>&nbsp;(<strong>World Wide Web</strong>), is probably the most prominent source of information today. Most of that information is retrievable through the HTTP protocol. <strong>HTTP</strong> was invented originally to share pages of hypertext (hence the name <strong>HyperText Transfer Protocol</strong>), which started the WWW.</p>
<p>This operation is very familiar, as it is what happens in any web browser. But we can also perform those operations programmatically to automatically retrieve and process information. Python has included in the standard library an HTTP client, but the fantastic <kbd>requests</kbd> module makes it very easy. In this chapter, we will see how.</p>
<h2>Downloading web pages</h2>
<p>The basic ability to download a web page involves making an HTTP <kbd>GET</kbd> request against a URL. This is the basic operation of any web browser. Let's quickly recap the different parts of this operation:</p>
<ol>
<li>Using the HTTP protocol.</li>
<li>Using the <kbd>GET</kbd> method, which is the most common HTTP method. We'll see more in the <em>Accessing web APIs</em> recipe.</li>
<li>URL describing the full address of the page, including the server and the path.</li>
</ol>
<p>That request will be processed by the server and a response will be sent back. This response will contain a <strong>status code</strong>, typically 200 if everything went fine, and a body with the result, which will normally be text with an HTML page.</p>
<p>Most of this is handled automatically by the HTTP client used to perform the request. We'll see in this recipe how to make a simple request to obtain a web page.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>HTTP requests and responses can also contain headers. Headers contain extra information, such as the total size of the request, the format of the content, the date of the request, and what browser or server is used.&nbsp;</p>
</div>
</div>
<h3>Getting ready</h3>
<p>Using the fantastic <kbd>requests</kbd> module, getting web pages is super simple. Install the module:</p>
<pre><code class="lang-python">$ echo "requests==2.18.3" &gt;&gt; requirements.txt
$ source .venv/bin/activate
(.venv) $ pip install -r requirements.txt </code></pre>
<p>We'll download the page at&nbsp;<a href="http://www.columbia.edu/~fdc/sample.html">http://www.columbia.edu/~fdc/sample.html</a>&nbsp;because it is a straightforward HTML page that is easy to read in text mode.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>requests</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import requests</code></pre>
<ol start="2">
<li>Make a request to the URL, which will take a second or two:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; url = 'http://www.columbia.edu/~fdc/sample.html'
&gt;&gt;&gt; response = requests.get(url)</code></pre>
<ol start="3">
<li>Check the returned object status code:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; response.status_code
200</code></pre>
<ol start="4">
<li>Check the content of the result:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; response.text
'&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;\n&lt;html&gt;\n&lt;head&gt;\n
...
FULL BODY
...
&lt;!-- close the &lt;html&gt; begun above --&gt;\n'</code></pre>
<ol start="5">
<li>Check the ongoing and returned headers:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; response.request.headers
{'User-Agent': 'python-requests/2.18.4', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive'}
&gt;&gt;&gt; response.headers
{'Date': 'Fri, 25 May 2018 21:51:47 GMT', 'Server': 'Apache', 'Last-Modified': 'Thu, 22 Apr 2004 15:52:25 GMT', 'Accept-Ranges': 'bytes', 'Vary': 'Accept-Encoding,User-Agent', 'Content-Encoding': 'gzip', 'Content-Length': '8664', 'Keep-Alive': 'timeout=15, max=85', 'Connection': 'Keep-Alive', 'Content-Type': 'text/html', 'Set-Cookie': 'BIGipServer~CUIT~www.columbia.edu-80-pool=1764244352.20480.0000; expires=Sat, 26-May-2018 03:51:47 GMT; path=/; Httponly'}</code></pre>
<h3>How it works...</h3>
<p>The operation of <kbd>requests</kbd> is very simple; perform the operation, <kbd>GET</kbd> in this case, over the URL. This returns a <kbd>result</kbd> object that can be analyzed. The main elements are the <kbd>status_code</kbd> and the body content, which can be presented as <kbd>text</kbd>.</p>
<p>The full request can be checked in the <kbd>request</kbd> field:</p>
<pre><code class="lang-python">&gt;&gt;&gt; response.request
&lt;PreparedRequest [GET]&gt;
&gt;&gt;&gt; response.request.url
'http://www.columbia.edu/~fdc/sample.html'</code></pre>
<p>The full request's documentation can be found here:&nbsp;<a href="http://docs.python-requests.org/en/master/">http://docs.python-requests.org/en/master/</a>. Over the course of the chapter, we'll be showing more features.</p>
<h3>There's more...</h3>
<p>All HTTP status codes can be checked on this web page:&nbsp;<a href="https://httpstatuses.com/">https://httpstatuses.com/</a>. They are also described in the <kbd>httplib</kbd> module with convenient constant names, such as&nbsp;<kbd>OK</kbd>, <kbd>NOT_FOUND</kbd>, or <kbd>FORBIDDEN</kbd>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The most famous error status code is arguably 404, which happens when a URL is not found.&nbsp;Try it out by doing <kbd>requests.get('http://www.columbia.edu/invalid')</kbd>.</p>
</div>
</div>
<p>A request can use the <strong>HTTPS</strong> protocol (<strong>secure HTTP</strong>). It is equivalent, but ensures that the contents of the request and response are private. <kbd>requests</kbd> handles it transparently.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Any website that handles any private information will use HTTPS to ensure that the information has not leaked out. HTTP is vulnerable to someone eavesdropping. Use HTTPS where available.</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The&nbsp;<em>Installing third-party packages</em> recipe in&nbsp;Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em></li>
<li>The <em>Parsing HTML</em> recipe</li>
</ul>
<h2>Parsing HTML</h2>
<p>Downloading raw text or a binary file is a good starting point, but the main language of the web is HTML.</p>
<p>HTML is a structured language, defining different parts of a document such as headers and paragraphs. HTML is also hierarchical, defining sub-elements. The ability to parse raw text into a structured document is basically to be able to extract information automatically from a web page. For example, some text can be relevant if enclosed in a particular <kbd>class div</kbd>&nbsp;or after a header <kbd>h3</kbd> tag.</p>
<h3>Getting ready</h3>
<p>We'll use the excellent Beautiful Soup module to parse the HTML text into a memory object that can be analyzed. We need to use the&nbsp;<kbd>beautifulsoup4</kbd>&nbsp;package&nbsp;to use the latest Python 3 version that is available. Add the package to your <kbd>requirements.txt</kbd> and install the dependencies in the virtual environment:</p>
<pre><code class="lang-python">$ echo "beautifulsoup4==4.6.0" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>BeautifulSoup</kbd> and <kbd>requests</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import requests
&gt;&gt;&gt; from bs4 import BeautifulSoup</code></pre>
<ol start="2">
<li>Set up the URL of the page to download and retrieve it:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; URL = 'http://www.columbia.edu/~fdc/sample.html'
&gt;&gt;&gt; response = requests.get(URL)
&gt;&gt;&gt; response
&lt;Response [200]&gt;</code></pre>
<ol start="3">
<li>Parse the downloaded page:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; page = BeautifulSoup(response.text, 'html.parser')</code></pre>
<ol start="4">
<li>Obtain the title of the page. See that it is the same as what's displayed in the browser:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; page.title
&lt;title&gt;Sample Web Page&lt;/title&gt;
&gt;&gt;&gt; page.title.string
'Sample Web Page'</code></pre>
<ol start="5">
<li>Find all the <kbd>h3</kbd> elements in the page, to determine the existing sections:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; page.find_all('h3')
[&lt;h3&gt;&lt;a name="contents"&gt;CONTENTS&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="basics"&gt;1. Creating a Web Page&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="syntax"&gt;2. HTML Syntax&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="chars"&gt;3. Special Characters&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="convert"&gt;4. Converting Plain Text to HTML&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="effects"&gt;5. Effects&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="lists"&gt;6. Lists&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="links"&gt;7. Links&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="tables"&gt;8. Tables&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="install"&gt;9. Installing Your Web Page on the Internet&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="more"&gt;10. Where to go from here&lt;/a&gt;&lt;/h3&gt;]</code></pre>
<ol start="6">
<li>Extract the text on the section links. Stop when you reach the next <kbd>&lt;h3&gt;</kbd> tag:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; link_section = page.find('a', attrs={'name': 'links'})
&gt;&gt;&gt; section = []
&gt;&gt;&gt; for element in link_section.next_elements:
...     if element.name == 'h3':
...         break
...     section.append(element.string or '')
...
&gt;&gt;&gt; result = ''.join(section)
&gt;&gt;&gt; result
'7. Links\n\nLinks can be internal within a Web page (like to\nthe Table of ContentsTable of Contents at the top), or they\ncan be to external web pages or pictures on the same website, or they\ncan be to websites, pages, or pictures anywhere else in the world.\n\n\n\nHere is a link to the Kermit\nProject home pageKermit\nProject home page.\n\n\n\nHere is a link to Section 5Section 5 of this document.\n\n\n\nHere is a link to\nSection 4.0Section 4.0\nof the C-Kermit\nfor Unix Installation InstructionsC-Kermit\nfor Unix Installation Instructions.\n\n\n\nHere is a link to a picture:\nCLICK HERECLICK HERE to see it.\n\n\n'</code></pre>
<p>Notice that there are no HTML tags; it's all raw text.</p>
<h3>How it works...</h3>
<p>The first step is to download the page. Then, the raw text can be parsed, as in step 3. The resulting&nbsp;<kbd>page</kbd>&nbsp;object&nbsp;contains the parsed information.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The&nbsp;<kbd>html.parser</kbd>&nbsp;parser&nbsp;is the default one, but for specific operations it can have problems. For example, for big pages it can be slow, or has issue rendering highly dynamic web pages. You can use other parsers,&nbsp;such as,&nbsp;&nbsp;<kbd>lxml</kbd>, which is much faster, or&nbsp;<kbd>html5lib</kbd>, which will be closer to how a browser operates, including dynamic changes produced by HTML5. They are external modules that will need to be added to the <kbd>requirements.txt</kbd> file.</p>
</div>
</div>
<p><kbd>BeautifulSoup</kbd> allows us to search for HTML elements. It can search for the first one with <kbd>.find()</kbd>&nbsp;or return a list with&nbsp;<kbd>.find_all()</kbd>. In step 5, it searched for a specific tag <kbd>&lt;a&gt;</kbd> that had a particular attribute, <kbd>name=link</kbd>.&nbsp;After that, it kept iterating on <kbd>.next_elements</kbd> until it finds the next <kbd>h3</kbd> tag, which marks the end of the section.</p>
<p>The text of each element is extracted and finally composed into a single text. Note the <kbd>or</kbd> that avoids storing <kbd>None</kbd>, returned when an element has no text.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>HTML is highly versatile, and can have multiple structures. The case presented in this recipe is typical, but other options on dividing sections can be grouping related sections inside a big <kbd>&lt;div&gt;</kbd> tag or other elements, or even raw text. Some experimentation will be required until you find the specific process to extract the juicy bits on a web page. Don't be afraid to try!</p>
</div>
</div>
<h3>There's more...</h3>
<p>Regexes can be used as well as input in the&nbsp;<kbd>.find()</kbd> and <kbd>.find_all()</kbd> methods. For example, this search uses the&nbsp;<kbd>h2</kbd> and <kbd>h3</kbd> tags:</p>
<pre><code class="lang-python">&gt;&gt;&gt; page.find_all(re.compile('^h(2|3)'))
[&lt;h2&gt;Sample Web Page&lt;/h2&gt;, &lt;h3&gt;&lt;a name="contents"&gt;CONTENTS&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="basics"&gt;1. Creating a Web Page&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="syntax"&gt;2. HTML Syntax&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="chars"&gt;3. Special Characters&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="convert"&gt;4. Converting Plain Text to HTML&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="effects"&gt;5. Effects&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="lists"&gt;6. Lists&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="links"&gt;7. Links&lt;/a&gt;&lt;/h3&gt;,</code></pre>
<pre><code class="lang-python">&lt;h3&gt;&lt;a name="tables"&gt;8. Tables&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="install"&gt;9. Installing Your Web Page on the Internet&lt;/a&gt;&lt;/h3&gt;, &lt;h3&gt;&lt;a name="more"&gt;10. Where to go from here&lt;/a&gt;&lt;/h3&gt;]</code></pre>
<p>Another useful find parameter is including the CSS class with the <kbd>class_</kbd> parameter. This will be shown later in the book.</p>
<p>The full Beautiful Soup documentation can be found here:&nbsp;<a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">https://www.crummy.com/software/BeautifulSoup/bs4/doc/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Installing third-party packages</em> recipe in Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em></li>
<li>The <em>Introducing regular expressions</em> recipe in Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em></li>
<li>The <em>Downloading web pages</em> recipe</li>
</ul>
<h2>Crawling the web</h2>
<p>Given the nature of hyperlink pages, starting from a known place and following links to other pages is a very important tool in the arsenal when scraping the web.</p>
<p>To do so, we crawl a page looking for a small phrase, and will print any paragraph that contains it. We will search only in pages that belong to the same site. I.e.&nbsp;only URLs starting with www.somesite.com.&nbsp;We won't follow links to external sites.</p>
<h3>Getting ready</h3>
<p>This recipe builds on the introduced concepts, so it will download and parse the pages to search for links and continue downloading.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>When crawling the web, remember to set limits when downloading. It's very easy to crawl over too many pages. As anyone checking Wikipedia can confirm, the internet is potentially limitless.</p>
</div>
</div>
<p>We'll use as an example a prepared example, available in the GitHub repo: <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter03/test_site">https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter03/test_site</a>. Download the whole site and run the included script.</p>
<pre><code class="lang-python">$ python simple_delay_server.py</code></pre>
<p>This serves the site in the URL <kbd>http://localhost:8000</kbd>. You can check it on a browser. It's a simple blog with three entries. Most of it is uninteresting, but we added a couple of paragraphs that contain the keyword <kbd>python</kbd>.&nbsp;</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000050.png" class="lazyload" /></p>
<h3>How to do it...</h3>
<ol>
<li>The full script, <kbd>crawling_web_step1.py</kbd>,&nbsp;is available in GitHub at the following link:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter03/crawling_web_step1.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter03/crawling_web_step1.py</a>. The most relevant bits are displayed here:</li>
</ol>
<pre><code class="lang-python">...

def process_link(source_link, text):
    logging.info(f'Extracting links from {source_link}')
    parsed_source = urlparse(source_link)
    result = requests.get(source_link)
    # Error handling. See GitHub for details
    ...
    page = BeautifulSoup(result.text, 'html.parser')
    search_text(source_link, page, text)
    return get_links(parsed_source, page)

def get_links(parsed_source, page):
    '''Retrieve the links on the page'''
    links = []
    for element in page.find_all('a'):
        link = element.get('href')
        # Validate is a valid link. See GitHub for details
        ...
        links.append(link)
    return links</code></pre>
<ol start="2">
<li>Search for references to <kbd>python</kbd>, to return a list with URLs that contain it and&nbsp;the paragraph. Notice there are a couple of errors because of broken links:</li>
</ol>
<pre><code class="lang-python">$ python crawling_web_step1.py https://localhost:8000/ -p python
Link http://localhost:8000/: --&gt; A smaller article , that contains a reference to Python
Link http://localhost:8000/files/5eabef23f63024c20389c34b94dee593-1.html: --&gt; A smaller article , that contains a reference to Python
Link http://localhost:8000/files/33714fc865e02aeda2dabb9a42a787b2-0.html: --&gt; This is the actual bit with a python reference that we are interested in.
Link http://localhost:8000/files/archive-september-2018.html: --&gt; A smaller article , that contains a reference to Python
Link http://localhost:8000/index.html: --&gt; A smaller article , that contains a reference to Python</code></pre>
<ol start="3">
<li>Another good search term is <kbd>crocodile</kbd>. Try it out:</li>
</ol>
<pre><code class="lang-python">$ python crawling_web_step1.py http://localhost:8000/ -p crocodile</code></pre>
<h3>How it works...</h3>
<p>Let's see each of the components of the script:</p>
<ol>
<li>A loop that goes through all the found links, in the <kbd>main</kbd> function:</li>
</ol>
<p>Note that there's a retrieval limit of 10 pages, and it's checking that any new link to add is not added already.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Note these two things are limits. We won't download the same link twice and we'll stop at some point.</p>
</div>
</div>
<ol start="2">
<li>Downloading and parsing&nbsp;the link, in the <kbd>process_link</kbd> function:</li>
</ol>
<p>It downloads the file, and checks that the status is correct to skip errors such as broken links. It also checks that the type (as described in&nbsp;<kbd>Content-Type</kbd>) is a HTML page to skip PDFs and other formats. And finally, it parses the raw HTML into a <kbd>BeautifulSoup</kbd> object.</p>
<p>It also parses the source link using <kbd>urlparse</kbd>, so later, in step 4, it can skip all the references to external sources.&nbsp;<kbd>urlparse</kbd> divides a URL into its composing elements:</p>
<pre><code class="lang-python">&gt;&gt;&gt; from urllib.parse import urlparse
&gt;&gt;&gt; &gt;&gt;&gt; urlparse('http://localhost:8000/files/b93bec5d9681df87e6e8d5703ed7cd81-2.html')
ParseResult(scheme='http', netloc='localhost:8000', path='/files/b93bec5d9681df87e6e8d5703ed7cd81-2.html', params='', query='', fragment='')</code></pre>
<ol start="3">
<li>It finds the text to search, in the <kbd>search_text</kbd> function:</li>
</ol>
<p>It searches the parsed object for the specified text. Note the search is done as a <kbd>regex</kbd> and only in the text. It prints the resulting&nbsp;matches, including <kbd>source_link</kbd>, referencing the URL where the match was found:</p>
<pre><code class="lang-python">for element in page.find_all(text=re.compile(text)):
    print(f'Link {source_link}: --&gt; {element}')</code></pre>
<ol start="4">
<li>The&nbsp;&nbsp;<strong><kbd>get_links</kbd></strong>&nbsp;function&nbsp;retrieves all links on a page:&nbsp;</li>
</ol>
<p>It searches in the parsed page all <kbd>&lt;a&gt;</kbd> elements, and retrieves the <kbd>href</kbd> elements, but only elements that have such <kbd>href</kbd> elements and that are a fully qualified URL (starting with <kbd>http</kbd>). This removes links that are not a URL, such as a <kbd>'#'</kbd> link, or that are internal to the page.</p>
<p>An extra check is done to check they have the same source as the original link, then they are registered as valid links.&nbsp;The <kbd>netloc</kbd> attribute allows to detect that the link comes from the same URL domain than&nbsp;the parsed URL generated in step 2.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>We won't follow links that point to a different address (for example, a <a href="http://www.google.com">http://www.google.com</a>&nbsp;one).</p>
</div>
</div>
<p>Finally, the links are returned, where they'll be added to the loop described in step 1.</p>
<h3>There's more...</h3>
<p>Further filters could be enforced, for example, discarding all links that end in <kbd>.pdf</kbd>, meaning they&nbsp;are PDF files:</p>
<pre><code class="lang-python"># In get_links
if link.endswith('pdf'):
  continue</code></pre>
<p>The use of <kbd>Content-Type</kbd> can also be determined to parse the returned object in different ways. A PDF result (<kbd>Content-Type: application/pdf</kbd>)&nbsp;won't have a valid <kbd>response.text</kbd> object to be parsed, but it can be parsed in other ways. The same is valid for other types, such as a CSV file (<kbd>Content-Type: text/csv</kbd>) or a ZIP file that may need to be decompressed (<kbd>Content-Type:&nbsp;application/zip</kbd>). We'll see how to deal with those later.</p>
<h3>See also</h3>
<ul>
<li>The <em>Downloading web pages</em> recipe</li>
<li>The <em>Parsing HTML</em> recipe</li>
</ul>
<h2>Subscribing to feeds</h2>
<p>RSS is probably the biggest <em>secret</em>&nbsp;of the internet. While its moment of glory seemed to be during the 2000s, and now it's not in the spotlight anymore, it allows easy subscription to websites.&nbsp;It is present in lots of places, and it's incredibly useful.</p>
<p>At its core, RSS is a way of presenting a succession of ordered references (typically articles, but also other elements such as podcast episodes or YouTube publications) and a publishing time. This makes for a very natural way of knowing what articles are new since the last check, as well as presenting some structured data about them, such as the title and a summary.</p>
<p>In this recipe, we will present the <kbd>feedparser</kbd> module, and determine how to obtain&nbsp;data from an RSS feed.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p><strong>RSS</strong> is not the only available feed format. There's also a format called <strong>Atom</strong>, but both are very much equivalent. <kbd>feedparser</kbd> is also capable of parsing it, so both can be used indistinctly.</p>
</div>
</div>
<h3>Getting ready</h3>
<p>We need to add the <kbd>feedparser</kbd> dependency to our <kbd>requirements.txt</kbd> file and reinstall it:</p>
<pre><code class="lang-python">$ echo "feedparser==5.2.1" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>Feed URLs can be found on almost all pages that deal with publications, including blogs, news, podcasts, and so on. Sometimes they are very easy to find, but sometimes they are a little bit hidden. Search by <kbd>feed</kbd>&nbsp;or <kbd>RSS</kbd>.</p>
<p>Most newspapers and news agencies has their RSS feeds divided by themes. We'll use as example to parse <strong>The New York Times</strong> main page feed,&nbsp;<a href="http://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml">http://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml</a>. There are more feeds available in the main feed page:&nbsp;<a href="https://archive.nytimes.com/www.nytimes.com/services/xml/rss/index.html?mcubz=0">https://archive.nytimes.com/www.nytimes.com/services/xml/rss/index.html</a>.&nbsp;</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Please note the feeds may be subjected to terms and conditions of use. In the New York Times case, they are described at the end of the main feed page.</p>
</div>
</div>
<p>Please note that this feed changes quite often, meaning that the linked entries will change from the examples in this book.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>feedparser</kbd> module, as well as <kbd>datetime</kbd>,&nbsp;<kbd>delorean</kbd>, and <kbd>requests</kbd>:</li>
</ol>
<pre><code class="lang-python">import feedparser
import datetime
import delorean
import requests</code></pre>
<ol start="2">
<li>Parse the feed (it will be downloaded automatically) and check when it was last updated. Feed information, like the title of the feed, can be obtained in the <kbd>feed</kbd> attribute:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; rss = feedparser.parse('http://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml')</code></pre>
<pre><code class="lang-python">&gt;&gt;&gt; rss.updated
'Sat, 02 Jun 2018 19:50:35 GMT'</code></pre>
<ol start="3">
<li>Get the entries that are newer than six hours:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; time_limit = delorean.parse(rss.updated) - datetime.timedelta(hours=6)
&gt;&gt;&gt; entries = [entry for entry in rss.entries if delorean.parse(entry.published) &gt; time_limit]</code></pre>
<ol start="4">
<li>There will be fewer entries than the total ones, because some of the returned entries will be older than six hours:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; len(entries)
10
&gt;&gt;&gt; len(rss.entries)
44</code></pre>
<ol start="5">
<li>Retrieve information about the entries, such as the <kbd>title</kbd>. The full entry URL is available as <kbd>link</kbd>. Explore the available information in this particular feed:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; entries[5]['title']
'Loose Ends: How to Live to 108'
&gt;&gt;&gt; entries[5]['link']
'https://www.nytimes.com/2018/06/02/opinion/sunday/how-to-live-to-108.html?partner=rss&amp;emc=rss'
&gt;&gt;&gt; requests.get(entries[5].link)
&lt;Response [200]&gt;</code></pre>
<h3>How it works...</h3>
<p>The parsed <kbd>feed</kbd> object contains the information of the entries, as well as general information about the feed itself, such as when it was updated. The <kbd>feed</kbd> information can be found in the <kbd>feed</kbd> attribute:</p>
<pre><code class="lang-python">&gt;&gt;&gt; rss.feed.title
'NYT &gt; Home Page'</code></pre>
<p>Each of the entries work as a dictionary, so the fields are easy to retrieve. They can also be accessed as attributes, but treating them as keys allows us to get all the available fields:</p>
<pre><code class="lang-python">&gt;&gt;&gt; entries[5].keys()
dict_keys(['title', 'title_detail', 'links', 'link', 'id', 'guidislink', 'media_content', 'summary', 'summary_detail', 'media_credit', 'credit', 'content', 'authors', 'author', 'author_detail', 'published', 'published_parsed', 'tags'])</code></pre>
<p>The basic strategy when dealing with feeds is to parse them and go through the entries, performing a quick check on whether they are interesting or not, for example, by checking the <em>description</em> or <em>summary</em>. If they are download the whole page using the <kbd>link</kbd> field. Then, to avoid rechecking entires, store the latest publication date and next time, only check newer entries.</p>
<h3>There's more...</h3>
<p>The full <kbd>feedparser</kbd> documentation can be found here:&nbsp;<a href="https://pythonhosted.org/feedparser/">https://pythonhosted.org/feedparser/</a>.</p>
<p>The information available can differ from feed to feed. In the New York Times example, there's a <kbd>tag</kbd>&nbsp;field with tag information, but this is not standard. As a minimum, entries will have a title, a description, and a link.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>RSS feeds are also a great way of curating your own selection of news sources. There are great feed readers for that.</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The <em>Installing third-party packages</em> recipe in Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em></li>
<li>The <em>Downloading web pages</em> recipe</li>
</ul>
<h2>Accessing web APIs</h2>
<p>Rich interfaces can be created through the web, allowing powerful interactions through HTTP. The most common interface is through RESTful APIs using JSON. These text-based interfaces are easy to understand and to program, and use common technologies that are <strong>language agnostic</strong>, meaning they can be accessed in any programming language that has an HTTP <kbd>client</kbd> module, including, of course, Python.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Formats other than JSON are used, such as XML, but JSON is a very simple and readable format that translates very well into Python dictionaries (and other language equivalents). JSON is, by far, the most common format in RESTful APIs at the moment. Learn more about JSON here:&nbsp;<a href="https://www.json.org/">https://www.json.org/</a>.</p>
</div>
</div>
<p>The strict definition of RESTful requires some characteristics, but a more informal definition could be accessing resources through URLs. This means a URL represents a particular resource, such as an article in a newspaper or a property on a real estate site. Resources can then be manipulated through HTTP methods (<kbd>GET</kbd> to view, <kbd>POST</kbd> to create, <kbd>PUT</kbd>/<kbd>PATCH</kbd> to edit, and <kbd>DELETE</kbd> to delete) to manipulate them.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Proper RESTful interfaces need to have certain characteristics, and are a way of creating interfaces that is not strictly restricted to HTTP interfaces. You can read more about it here:&nbsp;<a href="https://codewords.recurse.com/issues/five/what-restful-actually-means">https://codewords.recurse.com/issues/five/what-restful-actually-means</a>.</p>
</div>
</div>
<p>Using <kbd>requests</kbd> is very easy with them, as it includes native JSON support.</p>
<h3>Getting ready</h3>
<p>To demonstrate how to operate RESTful APIs, we'll use the example site&nbsp;<a href="https://jsonplaceholder.typicode.com/">https://jsonplaceholder.typicode.com/</a>. It simulates a common case with posts, comments, and other common resources. We will use posts and comments. The URLs to use will be as follows:</p>
<pre><code class="lang-python"># The collection of all posts
/posts
# A single post. X is the ID of the post
/posts/X
# The comments of post X
/posts/X/comments</code></pre>
<p>The site returns the adequate result to each of them. Pretty handy!</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Because it is a test site, data won't be created, but the site will return all the correct responses.</p>
</div>
</div>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>requests</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import requests</code></pre>
<ol start="2">
<li>Get the list of all posts and display the latest post:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; result = requests.get('https://jsonplaceholder.typicode.com/posts')
&gt;&gt;&gt; result
&lt;Response [200]&gt;
&gt;&gt;&gt; result.json()
# List of 100 posts NOT DISPLAYED HERE
&gt;&gt;&gt; result.json()[-1]
{'userId': 10, 'id': 100, 'title': 'at nam consequatur ea labore ea harum', 'body': 'cupiditate quo est a modi nesciunt soluta\nipsa voluptas error itaque dicta in\nautem qui minus magnam et distinctio eum\naccusamus ratione error aut'}</code></pre>
<ol start="3">
<li>Create a new post. See the URL of the new created resource. The call also returns the resource:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; new_post = {'userId': 10, 'title': 'a title', 'body': 'something something'}
&gt;&gt;&gt; result = requests.post('https://jsonplaceholder.typicode.com/posts',
              json=new_post)
&gt;&gt;&gt; result
&lt;Response [201]&gt;
&gt;&gt;&gt; result.json()
{'userId': 10, 'title': 'a title', 'body': 'something something', 'id': 101}
&gt;&gt;&gt; result.headers['Location']
'http://jsonplaceholder.typicode.com/posts/101'</code></pre>
<p>Notice that the <kbd>POST</kbd> request to create the resource returns 201, which is the proper status for created.</p>
<ol start="4">
<li>Fetch an existing post with <kbd>GET</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; result = requests.get('https://jsonplaceholder.typicode.com/posts/2')
&gt;&gt;&gt; result
&lt;Response [200]&gt;
&gt;&gt;&gt; result.json()
{'userId': 1, 'id': 2, 'title': 'qui est esse', 'body': 'est rerum tempore vitae\nsequi sint nihil reprehenderit dolor beatae ea dolores neque\nfugiat blanditiis voluptate porro vel nihil molestiae ut reiciendis\nqui aperiam non debitis possimus qui neque nisi nulla'}</code></pre>
<ol start="5">
<li>Use <kbd>PATCH</kbd> to update its values. Check the returned resource:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; update = {'body': 'new body'}
&gt;&gt;&gt; result = requests.patch('https://jsonplaceholder.typicode.com/posts/2', json=update)
&gt;&gt;&gt; result
&lt;Response [200]&gt;
&gt;&gt;&gt; result.json()
{'userId': 1, 'id': 2, 'title': 'qui est esse', 'body': 'new body'}</code></pre>
<h3>How it works...</h3>
<p>Two kinds of resources are typically accessed. Single resources (<kbd>https://jsonplaceholder.typicode.com/posts/X</kbd>) and collections (<kbd>https://jsonplaceholder.typicode.com/posts</kbd>):</p>
<ul>
<li>Collections accept <kbd>GET</kbd> to retrieve them all and <kbd>POST</kbd> to create a new resource</li>
<li>Single elements accept <kbd>GET</kbd> to get the element, <kbd>PUT</kbd> and <kbd>PATCH</kbd> to edit, and <kbd>DELETE</kbd> to remove them</li>
</ul>
<p>All the available HTTP methods can be called in <kbd>requests</kbd>. In the previous recipes, we used <kbd>.get()</kbd>, but <kbd>.post()</kbd>, <kbd>.patch()</kbd>, <kbd>.put()</kbd>, and <kbd>.delete()</kbd> are available.</p>
<p>The returned response object has a&nbsp;<kbd>.json()</kbd>&nbsp;method that decodes the result from JSON.&nbsp;</p>
<p>Equally, to send information, a&nbsp;<kbd>json</kbd>&nbsp;argument&nbsp;is available. This encodes a dictionary into JSON and sends it to the server. The data needs to follow the format of the resource or an error may be raised.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p><kbd>GET</kbd> and <kbd>DELETE</kbd> don't require data, while <kbd>PATCH</kbd>, <kbd>PUT</kbd>, and <kbd>POST</kbd> do require data.</p>
</div>
</div>
<p>The referred resource will be returned, and its URL is available in the header location. This is useful when creating a new resource, where its URL is not known beforehand.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The difference between <kbd>PATCH</kbd> and <kbd>PUT</kbd> is that the latter replaces the whole resource, while the first does a partial update.</p>
</div>
</div>
<h3>There's more...</h3>
<p>RESTful APIs are very powerful, but also have huge variability. Please check the documentation of the specific API to learn about its details.</p>
<h3>See also</h3>
<ul>
<li>The <em>Downloading web pages</em> recipe</li>
<li>The <em>Installing third-party packages</em> recipe in Chapter 1, <em>Let Us Begin Our Automation Journey</em></li>
</ul>
<h2>Interacting with forms</h2>
<p>A common element present in web pages is forms. Forms are a way of sending values into a web page, for example, to create a new comment on a blog post, or to submit a purchase.</p>
<p>Browsers present the forms so you can input values and send them in a single action after pressing the submit&nbsp;or equivalent button. We'll see how to create this action programatically in this recipe.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Be aware that sending data to a site is normally more sensible than receiving data from it. For example, sending automatic comments to a website is very much the definition of <strong>spam</strong>. This means that it can be more difficult to automate and include security measures. Double-check that what you're trying to achieve is a valid, ethical use case.</p>
</div>
</div>
<h3>Getting ready</h3>
<p>We'll work against the test server,&nbsp;<a href="https://httpbin.org/forms/post">https://httpbin.org/forms/post</a>, which allows us to send a test form and sends back the submitted information.</p>
<p>The following is an example form to order a pizza:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000045.png" class="lazyload" /></p>
<p>You can fill the form manually and see it return the information in JSON format, including extra information such as the browser use.</p>
<p>The following is the frontend of the web form generated:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000051.png" class="lazyload" /></p>
<p>The following image is the back end of the web form generated:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000034.png" class="lazyload" /></p>
<p>We need to analyze the HTML to see the accepted data for the form. Checking the source code, it shows this:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000013.png" class="lazyload" /></p>
<p>Source code</p>
<p>Check the name of the inputs,&nbsp;<kbd>custname</kbd>,&nbsp;<kbd>custtel</kbd>, <kbd>custemail</kbd>, <kbd>size</kbd> (a radio option), <kbd>topping</kbd> (a multiselection checkbox), <kbd>delivery</kbd> (time), and <kbd>comments</kbd>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>requests</kbd>, <kbd>BeautifulSoup</kbd>, and <kbd>re</kbd>&nbsp;modules:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import requests
&gt;&gt;&gt; from bs4 import BeautifulSoup
&gt;&gt;&gt; import re</code></pre>
<ol start="2">
<li>Retrieve the form page, parse it, and print the input fields. Check that the posting URL is <kbd>/post</kbd> (not <kbd>/forms/post</kbd>):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; response = requests.get('https://httpbin.org/forms/post')
&gt;&gt;&gt; page = BeautifulSoup(response.text)
&gt;&gt;&gt; form = soup.find('form')
&gt;&gt;&gt; {field.get('name') for field in form.find_all(re.compile('input|textarea'))}
{'delivery', 'topping', 'size', 'custemail', 'comments', 'custtel', 'custname'}</code></pre>
<p>Note&nbsp;<kbd>textarea</kbd>&nbsp;is a valid input, as well as defined in the HTML format.&nbsp;</p>
<ol start="3">
<li>Prepare the data to be posted as a dictionary. Check the values are the same as defined in the form:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; data = {'custname': "Sean O'Connell", 'custtel': '123-456-789', 'custemail': 'sean@oconnell.ie', 'size': 'small', 'topping': ['bacon', 'onion'], 'delivery': '20:30', 'comments': ''}</code></pre>
<ol start="4">
<li>Post the values and check that the response is the same as returned in the browser:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; response = requests.post('https://httpbin.org/post', data)
&gt;&gt;&gt; response
&lt;Response [200]&gt;
&gt;&gt;&gt; response.json()
{'args': {}, 'data': '', 'files': {}, 'form': {'comments': '', 'custemail': 'sean@oconnell.ie', 'custname': "Sean O'Connell", 'custtel': '123-456-789', 'delivery': '20:30', 'size': 'small', 'topping': ['bacon', 'onion']}, 'headers': {'Accept': '*/*', 'Accept-Encoding': 'gzip, deflate', 'Connection': 'close', 'Content-Length':</code></pre>
<pre><code class="lang-python">'140', 'Content-Type': 'application/x-www-form-urlencoded', 'Host': 'httpbin.org', 'User-Agent': 'python-requests/2.18.3'}, 'json': None, 'origin': '89.100.17.159', 'url': 'https://httpbin.org/post'}</code></pre>
<h3>How it works...</h3>
<p><kbd>requests</kbd> directly accepts to send data in the proper way. By default, it sends the <kbd>POST</kbd> data in the&nbsp;<kbd>application/x-www-form-urlencoded</kbd>&nbsp;format.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Compare that with the&nbsp;<em>Accessing web APIs</em>&nbsp;recipe, where the data is explicitly sent in JSON format using the argument <kbd>json</kbd>. This makes the <kbd>Content-Type</kbd> be <kbd>application/json</kbd> instead of <kbd>application/x-www-form-urlencoded</kbd>.</p>
</div>
</div>
<p>The key aspect here is to respect the format of the form and the possible values that can return an error if incorrect, typically a 400 error.</p>
<h3>There's more...</h3>
<p>Other than following the format of forms and inputting valid values, the main problem when working with forms is the multiple ways of preventing spam and abusive behavior.</p>
<p>A very common limitation is to ensure that you downloaded the form before submitting it, to avoid submitting multiple forms or <strong>Cross-Site Request Forgery</strong> (<strong>CSRF</strong>).</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>CSRF, which means&nbsp;producing a malicious call from a page to another taking advantage that&nbsp; your browser is authenticated, is a serious problem. For example, entering in a puppies site that take advantage of you being logged into your bank page to perform operations "on your behalf". Here is a good description of it:&nbsp;<a href="https://stackoverflow.com/a/33829607">https://stackoverflow.com/a/33829607</a>. New techniques in browsers help with these issues by default.</p>
</div>
</div>
<p>To obtain the specific token, you need to first download the form, as shown in the recipe, obtain the value of the CSRF token, and resubmit it. Note that the token can have different names; this is just an example:</p>
<pre><code class="lang-python">&gt;&gt;&gt; form.find(attrs={'name': 'token'}).get('value')
'ABCEDF12345'</code></pre>
<h3>See also</h3>
<ul>
<li>The <em>Downloading web pages</em> recipe</li>
<li>The <em>Parsing HTML</em> recipe</li>
</ul>
<h2>Using Selenium for advanced interaction</h2>
<p>Sometimes, nothing short of the real thing will work. Selenium is a project to achieve automation in web browsers. It's conceived as a way of&nbsp;automatic testing, but it also can be used to automate interactions with a site.</p>
<p>Selenium can control Safari, Chrome, Firefox, Internet Explorer, or Microsoft Edge, though it requires installing a specific driver for each case. We'll use Chrome.&nbsp;</p>
<h3>Getting ready</h3>
<p>We need to install the right driver for Chrome, called <kbd>chromedriver</kbd>. It is available here:&nbsp;<a href="https://sites.google.com/a/chromium.org/chromedriver/">https://sites.google.com/a/chromium.org/chromedriver/</a>. It is available for most platforms. It also requires that you have Chrome installed:&nbsp;<a href="https://www.google.com/chrome/">https://www.google.com/chrome/</a>.</p>
<p>Add the <kbd>selenium</kbd> module to&nbsp;<kbd>requirements.txt</kbd> and install it:</p>
<pre><code class="lang-python">$ echo "selenium==3.12.0" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Import Selenium, start a browser, and load the form page. A page will open reflecting the operations:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from selenium import webdriver
&gt;&gt;&gt; browser = webdriver.Chrome()
&gt;&gt;&gt; browser.get('https://httpbin.org/forms/post')</code></pre>
<p>Note the banner with Chrome is being controlled by automated test software.</p>
<ol start="2">
<li>Add a value in the Customer name&nbsp;field. Remember that it is called <kbd>custname</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; custname = browser.find_element_by_name("custname")
&gt;&gt;&gt; custname.clear()
&gt;&gt;&gt; custname.send_keys("Sean O'Connell")</code></pre>
<p>The form will update:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000027.png" class="lazyload" /></p>
<ol start="3">
<li>Select the pizza size as&nbsp;<kbd>medium</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; for size_element in browser.find_elements_by_name("size"):
...     if size_element.get_attribute('value') == 'medium':
...         size_element.click()
...
&gt;&gt;&gt;</code></pre>
<p>This will change the pizza size ratio box.</p>
<ol start="4">
<li>Add <kbd>bacon</kbd> and&nbsp;<kbd>cheese</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; for topping in browser.find_elements_by_name('topping'):
...     if topping.get_attribute('value') in ['bacon', 'cheese']:
...         topping.click()
...
&gt;&gt;&gt;</code></pre>
<p>Finally, the checkboxes will appear as marked:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000007.png" class="lazyload" /></p>
<ol start="5">
<li>Submit the form. The page will submit and the result will be displayed:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; browser.find_element_by_tag_name('form').submit()</code></pre>
<p>The form will be submitted and the result from the server will be displayed:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000019.png" class="lazyload" /></p>
<ol start="6">
<li>Close the browser:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; browser.quit()</code></pre>
<h3>How it works...</h3>
<p>Step 1 in the <em>How to do it&hellip;</em> section shows how to create a Selenium page and go to a particular URL.</p>
<p>Selenium works in a similar way to Beautiful Soup. Select the adequate element, and then manipulate it.&nbsp;The selectors in Selenium work in a similar way to those in Beautiful Soup, with the most common&nbsp;ones being <kbd>find_element_by_id</kbd>, <kbd>find_element_by_class_name</kbd>, <kbd>find_element_by_name</kbd>, <kbd>find_element_by_tag_name</kbd>, and <kbd>find_element_by_css_selector</kbd>. There are equivalent <kbd>find_elements_by_X</kbd>&nbsp;&nbsp;that return a list instead of the first found element&nbsp;(&nbsp;<kbd>find_elements_by_tag_name</kbd>,&nbsp;<kbd>find_elements_by_name</kbd>, and more). This is also useful when checking whether the element is there or not. If there's no elements, <kbd>find_element</kbd> will raise an error while <kbd>find_elements</kbd> will return an empty list.</p>
<p>The data on the elements can be obtained through <kbd>.get_attribute()</kbd>&nbsp;for HTML attributes (such as the values on the form elements) or <kbd>.text</kbd>.</p>
<p>The elements can be manipulated by simulating sending keystrokes to input text, with the method <kbd>.send_keys()</kbd>, clicked with <kbd>.click()</kbd> or submitted with <kbd>.submit()</kbd> if they accept that. <kbd>.submit()</kbd> will search on a form for the proper submission, and <kbd>.click()</kbd> will select/deselect in the same way that a click of the mouse will do.</p>
<p>Finally, step 6 closes the browser.</p>
<h3>There's more...</h3>
<p>Here is the full Selenium documentation:&nbsp;<a href="http://selenium-python.readthedocs.io/">http://selenium-python.readthedocs.io/</a>.</p>
<p>For each of the elements, there's extra information that can be extracted,&nbsp;such as <kbd>.is_displayed()</kbd> or <kbd>.is_selected()</kbd>. Text can be searched using <kbd>.find_element_by_link_text()</kbd> and <kbd>.find_element_by_partial_link_text()</kbd>.</p>
<p>Sometimes, opening a browser can be inconvenient. An alternative is to start the browser in headless mode and manipulate it from there, like this:</p>
<pre><code class="lang-python">&gt;&gt;&gt; from selenium.webdriver.chrome.options import Options
&gt;&gt;&gt; chrome_options = Options()
&gt;&gt;&gt; chrome_options.add_argument("--headless")
&gt;&gt;&gt; browser = webdriver.Chrome(chrome_options=chrome_options)
&gt;&gt;&gt; browser.get('https://httpbin.org/forms/post')</code></pre>
<p>The page won't be displayed. But a screenshot can be saved anyway with the following line:</p>
<pre><code class="lang-python">&gt;&gt;&gt; browser.save_screenshot('screenshot.png')</code></pre>
<h3>See also</h3>
<ul>
<li>The <em>Parsing HTML</em> recipe</li>
<li>The <em>Interact with forms</em> recipe</li>
</ul>
<h2>Accessing password-protected pages</h2>
<p>Sometimes a web page is not open to the public, but protected in some way. The most basic aspect is to use basic HTTP authentication, which is integrated into virtually every web server, and it's a user/password schema.</p>
<h3>Getting ready</h3>
<p>We can test this kind of authentication in&nbsp;<a href="https://httpbin.org">https://httpbin.org</a>.</p>
<p>It has a path, <kbd>/basic-auth/{user}/{password}</kbd>, which forces authentication, with the user and password stated. This is very handy for understanding how authentication works.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>requests</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import requests</code></pre>
<ol start="2">
<li>Make a <kbd>GET</kbd> request to the URL with the wrong credentials. Notice that we set the credentials on the URL to be <kbd>user</kbd>&nbsp;and <kbd>psswd</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; requests.get('https://httpbin.org/basic-auth/user/psswd', 
                 auth=('user', 'psswd'))
&lt;Response [200]&gt;</code></pre>
<ol start="3">
<li>Use the wrong credentials to return a 401 status code (Unauthorized):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; requests.get('https://httpbin.org/basic-auth/user/psswd', 
                 auth=('user', 'wrong'))
&lt;Response [401]&gt;</code></pre>
<ol start="4">
<li>The credentials can be also passed directly in the URL, separated by a colon and an <kbd>@</kbd> symbol before the server, like this:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; requests.get('https://user:psswd@httpbin.org/basic-auth/user/psswd')
&lt;Response [200]&gt;
&gt;&gt;&gt; requests.get('https://user:wrong@httpbin.org/basic-auth/user/psswd')
&lt;Response [401]&gt;</code></pre>
<h3>How it works...</h3>
<p>As HTTP basic authentication is supported everywhere, support from <kbd>requests</kbd> is very easy.</p>
<p>Steps 2 and 4 in the <em>How to do it&hellip;</em> section show how to provide the proper password. Step 3 shows what happens when the password is the wrong one.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Remember to always use HTTPS to ensure that the sending of the password is kept secret. If you use HTTP, the password will be sent in the open over the web.</p>
</div>
</div>
<h3>There's more...</h3>
<p>Adding the user and password to the URL works on the browser as well. Try to access the page directly to see a box displayed asking for the username and password:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000002.png" class="lazyload" /></p>
<p>User credentials page</p>
<p>When using the URL containing the user and password, <kbd>https://user:psswd@httpbin.org/basic-auth/user/psswd</kbd>, the dialog does not appear and it authenticates automatically.</p>
<p>If you need to access multiple pages, you can create a session in <kbd>requests</kbd> and set the authentication parameters to avoid having to input them everywhere:</p>
<pre><code class="lang-python">&gt;&gt;&gt; s = requests.Session()
&gt;&gt;&gt; s.auth = ('user', 'psswd')
&gt;&gt;&gt; s.get('https://httpbin.org/basic-auth/user/psswd')
&lt;Response [200]&gt;</code></pre>
<h3>See also</h3>
<ul>
<li>The <em>Downloading web pages</em> recipe</li>
<li>The <em>Accessing Web APIs</em> recipe</li>
</ul>
<h2>Speeding up web scraping</h2>
<p>Most of the time spent downloading information from web pages is usually spent waiting. A request goes from our computer to whatever server will process it, and until the response is composed and comes back to our computer, we cannot do much about it.</p>
<p>During the execution of the recipes in the book, you'll notice there's a wait involved in <kbd>requests</kbd> calls, normally of around one or two seconds. But computers can do other stuff while waiting, including making more requests at the same time. In this recipe, we will see how to download a list of pages in parallel and wait until they are all ready. We will use an intentionally slow server to show the point.</p>
<h3>Getting ready</h3>
<p>We'll get code to crawl and search for keywords, making use of the <kbd>futures</kbd> capabilities of Python 3 to download multiple pages at the same time.</p>
<p>A <kbd>future</kbd> is an object that represents the promise of a value. This means that you immediately&nbsp;receive an object while the code is being executed in the background. Only, when specifically requesting for its <kbd>.result()</kbd> the code blocks until getting it.</p>
<p>To generate a <kbd>future</kbd>, you need a background engine, called <strong>executor</strong>. Once created,&nbsp;<kbd>submit</kbd> a function and parameters to it to retrieve a <kbd>future</kbd>. &nbsp;The retrieval of the result can be delayed as long as necessary, allowing the generation of several <kbd>futures</kbd> in a row, and waiting until all are finished, executing them in parallel, instead of creating one, wait until it finishes, creating another, and so on.</p>
<p>There are several ways to&nbsp;create&nbsp;an executor; in this&nbsp;recipe, we'll use <kbd>ThreadPoolExecutor</kbd>, which will use threads.</p>
<p>We'll use as an example a prepared example, available in the GitHub repo:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter03/test_site">https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter03/test_site</a>. Download the whole site and run the included script</p>
<pre><code class="lang-python">$ python simple_delay_server.py -d 2</code></pre>
<p>This serves the site in the URL&nbsp;<kbd>http://localhost:8000</kbd>. You can check it on a browser. It's s simple blog with three entries. Most of it is uninteresting, but we added a couple of paragraphs that contain the keyword&nbsp;<kbd>python</kbd>. The parameter <kbd>-d 2</kbd> makes the server intentionally slow, simulating a bad connection.</p>
<h3>How to do it...</h3>
<ol>
<li>Write the following script, <kbd>speed_up_step1.py</kbd>. The full code is available in GitHub under the&nbsp;&nbsp;<kbd>Chapter03</kbd>: <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter03/speed_up_step1.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter03/speed_up_step1.py&nbsp;</a>directory. Here are only the most relevant parts. It is based on&nbsp;<kbd>crawling_web_step1.py</kbd>:</li>
</ol>
<pre><code class="lang-python">...
def process_link(source_link, text):
    ...
    return source_link, get_links(parsed_source, page)
...

def main(base_url, to_search, workers):
    checked_links = set()
    to_check = [base_url]
    max_checks = 10

    with concurrent.futures.ThreadPoolExecutor(max_workers=workers) as executor:
        while to_check:
            futures = [executor.submit(process_link, url, to_search)
                       for url in to_check]
            to_check = []
            for data in concurrent.futures.as_completed(futures):
                link, new_links = data.result()

                checked_links.add(link)
                for link in new_links:
                    if link not in checked_links and link not in to_check:
                        to_check.append(link)

                max_checks -= 1
                if not max_checks:
                    return


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    ...
    parser.add_argument('-w', type=int, help='Number of workers',
                        default=4)
    args = parser.parse_args()

    main(args.u, args.p, args.w)</code></pre>
<ol start="2">
<li>Notice the differences in the <kbd>main</kbd> function. Also, there's an extra parameter added (number of concurrent workers), and the function <kbd>process_link</kbd>&nbsp;now returns the source link.</li>
<li>Run the&nbsp;<kbd>crawling_web_step1.py</kbd>&nbsp;script&nbsp;to get a time baseline. Notice the output has been removed here for clarity:</li>
</ol>
<pre><code class="lang-python">$ time python crawling_web_step1.py http://localhost:8000/
... REMOVED OUTPUT
real 0m12.221s
user 0m0.160s
sys 0m0.034s</code></pre>
<ol start="4">
<li>Run the new script with one worker, which is slower than the original one:</li>
</ol>
<pre><code class="lang-python">$ time python speed_up_step1.py -w 1
... REMOVED OUTPUT
real 0m16.403s
user 0m0.181s
sys 0m0.068s</code></pre>
<ol start="5">
<li>Increase the number of workers:</li>
</ol>
<pre><code class="lang-python">$ time python speed_up_step1.py -w 2
... REMOVED OUTPUT
real 0m10.353s
user 0m0.199s
sys 0m0.068s</code></pre>
<ol start="6">
<li>Adding more workers decreases the time:</li>
</ol>
<pre><code class="lang-python">$ time python speed_up_step1.py -w 5
... REMOVED OUTPUT
real 0m6.234s
user 0m0.171s
sys 0m0.040s</code></pre>
<h3>How it works...</h3>
<p>The main engine to create the concurrent requests is the main function. Notice that the rest of the code is basically untouched (other than returning the source link in the <kbd>process_link</kbd> function).</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>This change is actually quite common when adapting for concurrency. Concurrent tasks need to return all the relevant data, as they cannot rely on an ordered context.</p>
</div>
</div>
<p>This is the relevant part of the code that handles the concurrent engine:</p>
<pre><code class="lang-python">with concurrent.futures.ThreadPoolExecutor(max_workers=workers) as executor:
    while to_check:
        futures = [executor.submit(process_link, url, to_search)
                   for url in to_check]
        to_check = []
        for data in concurrent.futures.as_completed(futures):
            link, new_links = data.result()

            checked_links.add(link)
            for link in new_links:
                if link not in checked_links and link not in to_check:
                    to_check.append(link)

             max_checks -= 1
             if not max_checks:
                return</code></pre>
<p>The <kbd>with</kbd> context creates a pool of workers, specifying its number. Inside, a list of futures containing all the URLs to retrieve is created. The <kbd>.as_completed()</kbd> function returns the futures that are finished, and then there's some work dealing with obtaining newly found links and checking whether they need to be added to be retrieved or not. This process is similar to the one presented in the&nbsp;<em>Crawling the web&nbsp;</em>recipe.</p>
<p>The process starts again until enough links have been retrieved or there are no links to retrieve. Note that the links are retrieved in batches; the first time, the base link is processed and all links are retrieved. In the second iteration, all those links will be requested. Once they are all downloaded, a new batch will be processed.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>When dealing with concurrent requests, keep in mind that they can change order between two executions. If a request takes a little more or a little less time, that can affect the ordering of the retrieved information. Because we stop after downloading 10 pages, that also means that the 10 pages could be different.</p>
</div>
</div>
<h3>There's more...</h3>
<p>The full <kbd>futures</kbd> documentation in Python can be found here:&nbsp;<a href="https://docs.python.org/3/library/concurrent.futures.html">https://docs.python.org/3/library/concurrent.futures.html</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>As you can see in steps 4 and 5 in the <em>How to do it&hellip;</em> section,&nbsp;properly&nbsp;determining the number of workers can require some tests. Some numbers can make the process slower, due the increase in management. Do not be afraid to experiment!</p>
</div>
</div>
<p>In the Python world, there are other ways to make concurrent HTTP requests. There's a native request module that allows us to work with <kbd>futures</kbd>, called <kbd>requests-futures</kbd>. It can be found here:&nbsp;<a href="https://github.com/ross/requests-futures">https://github.com/ross/requests-futures</a>.</p>
<p>Another alternative is to use asynchronous programming. This way of working has recently gotten a lot of attention, as it can be very efficient in situations when dealing with many concurrent calls, but the resulting way of coding is different from the traditional way and requires some time to get used to. Python includes the <kbd>asyncio</kbd> module to work that way, and there's a good module called <kbd>aiohttp</kbd> to work with HTTP requests. You can find more information about <kbd>aiohttp</kbd> here:&nbsp;<a href="https://aiohttp.readthedocs.io/en/stable/client_quickstart.html">https://aiohttp.readthedocs.io/en/stable/client_quickstart.html</a>.</p>
<p>A good introduction to asynchronous programming can be found in this article:&nbsp;<a href="https://djangostars.com/blog/asynchronous-programming-in-python-asyncio/">https://djangostars.com/blog/asynchronous-programming-in-python-asyncio/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Crawling the web</em> recipe</li>
<li>The <em>Downloading web pages</em> recipe</li>
</ul>

</div>


<!--Chapter 4-->


<div class="chapter" data-chapter-number="4">
<div class="chapter-start">
<div class="ch-head">Chapter <span class="chapter-number"> 4 </span></div>
<h1 class="chaptertitle">Searching and Reading Local Files</h1>
<h3 class="author">Jaime Buelta</h3>
</div>

<p>In this chapter, we'll cover the following recipes:</p>
<ul>
<li>Crawling and searching directories</li>
<li>Reading text files</li>
<li>Dealing with encodings</li>
<li>Reading CSV files</li>
<li>Reading log files</li>
<li>Reading file metadata</li>
<li>Reading images</li>
<li>Reading PDF files</li>
<li>Reading Word documents</li>
<li>Scanning documents for a keyword</li>
</ul>
<h2>Introduction</h2>
<p>In this chapter, we will deal with the basic operations to read files, starting with searching and opening files in directories and subdirectories. Then, we'll describe some of the most common file types and how to read them, including formats such as raw text files, PDFs, and Word documents.</p>
<p>The last recipe will combine them all, showing how to search recursively in a directory for a word in different kinds of files.</p>
<h2>Crawling and searching directories</h2>
<p>In this recipe, we'll learn how to&nbsp;recursively&nbsp;scan&nbsp;a directory to get all the files contained there. The files can be of a particular kind, or just all of them.</p>
<h3>Getting ready</h3>
<p>Let's start by creating a test directory with some file information:</p>
<pre><code class="lang-python">$ mkdir dir
$ touch dir/file1.txt
$ touch dir/file2.txt
$ mkdir dir/subdir
$ touch dir/subdir/file3.txt
$ touch dir/subdir/file4.txt
$ touch dir/subdir/file5.pdf
$ touch dir/file6.pdf</code></pre>
<p>All the files will be empty; we will use them in this recipe only to discover them. Notice there are four files that have a <kbd>.txt</kbd> extension, and two that have a <kbd>.pdf</kbd> extension.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The files are also available in the GitHub repository here:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter04/documents/dir">https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter04/documents/dir</a>.</p>
</div>
</div>
<p>Enter the created <kbd>dir</kbd>&nbsp;directory:</p>
<pre><code class="lang-python">$ cd dir</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Print all the filenames in the <kbd>dir</kbd> directory and subdirectories:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import os
&gt;&gt;&gt; for root, dirs, files in os.walk('.'):
...     for file in files:
...         print(file)
...
file1.txt
file2.txt
file6.pdf
file3.txt
file4.txt
file5.pdf</code></pre>
<ol start="2">
<li>Print the full path of the files, joining with the <kbd>root</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; for root, dirs, files in os.walk('.'):
...     for file in files:
...         full_file_path = os.path.join(root, file)
...         print(full_file_path)
...
./dir/file1.txt
./dir/file2.txt
./dir/file6.pdf
./dir/subdir/file3.txt
./dir/subdir/file4.txt
./dir/subdir/file5.pdf</code></pre>
<ol start="3">
<li>Print only the <kbd>.pdf</kbd> files:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; for root, dirs, files in os.walk('.'):
...     for file in files:
...         if file.endswith('.pdf'):
...             full_file_path = os.path.join(root, file)
...             print(full_file_path)
...
./dir/file6.pdf
./dir/subdir/file5.pdf</code></pre>
<ol start="4">
<li>Print only files that contain an even number:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import re
&gt;&gt;&gt; for root, dirs, files in os.walk('.'):
...     for file in files:
...         if re.search(r'[13579]', file):
...             full_file_path = os.path.join(root, file)
...             print(full_file_path)
...
./dir/file1.txt
./dir/subdir/file3.txt
./dir/subdir/file5.pdf</code></pre>
<h3>How it works...</h3>
<p><kbd>os.walk()</kbd> goes through the whole directory and all subdirectories, returning all the files. It returns a tuple with the specific directory, the subdirectories that depends directly, and all the files:</p>
<pre><code class="lang-python">&gt;&gt;&gt; for root, dirs, files in os.walk('.'):
... print(root, dirs, files)
...
. ['dir'] []
./dir ['subdir'] ['file1.txt', 'file2.txt', 'file6.pdf']
./dir/subdir [] ['file3.txt', 'file4.txt', 'file5.pdf']</code></pre>
<p>The&nbsp;<kbd>os.path.join()</kbd>&nbsp;function&nbsp;allows us to cleanly join two paths, such as the base path and the file.</p>
<p>As files are returned as pure strings, any kind of filtering can be done, as in step 3. In step 4, the full power of regular expressions can be used to filter.&nbsp;</p>
<p>In the next recipe, we'll deal with the content of the files, and not just the filename.</p>
<h3>There's more...</h3>
<p>The returned files are not opened or modified in anyway. This operation is read-only. Files can be opened as usual, and described as in the following recipes.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Be aware that changing the structure of the directory while walking it may affect the results. If you need to store any file while working, for example, when copying or moving a file, it's usually a good idea to store it in a different directory.</p>
</div>
</div>
<p>The&nbsp;&nbsp;<kbd>os.path</kbd> module has other interesting functions. The most useful, other than <kbd>join()</kbd>, are probably:</p>
<ul>
<li><kbd>os.path.abspath()</kbd>, which returns the absolute path of a file</li>
<li><kbd>os.path.split()</kbd>, which splits the path between directory and file:</li>
</ul>
<pre><code class="lang-python">&gt;&gt;&gt; os.path.split('/a/very/long/path/file.txt')
('/a/very/long/path', 'file.txt')</code></pre>
<ul>
<li><kbd>os.path.exists()</kbd>, to return whether&nbsp;a file exists or not on the filesystem</li>
</ul>
<p>The full documentation about <kbd>os.path</kbd> can be found here:&nbsp;<a href="https://docs.python.org/3/library/os.path.html">https://docs.python.org/3/library/os.path.html</a>. Another module, <kbd>pathlib</kbd>, can be used for&nbsp;higher-level access, in an object-oriented way:&nbsp;<a href="https://docs.python.org/3/library/pathlib.html">https://docs.python.org/3/library/pathlib.html</a>.</p>
<p>As demonstrated in step 4, multiple ways of filtering can be used. All of the string manipulations shown in&nbsp;Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em> can be used.</p>
<h3>See also</h3>
<ul>
<li>The <em>Introducing regular expressions</em>&nbsp;recipe in Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey&nbsp;</em></li>
<li>The <em>Reading text files</em> recipe</li>
</ul>
<h2>Reading text files</h2>
<p>After searching for a particular file, we'll probably follow up by opening it and reading it. Text files are very simple yet very powerful files. They store data in plain text, without complicated binary formats.&nbsp;</p>
<p>Text file support is provided natively in Python, and it's easy to consider it a collection of lines.</p>
<h3>Getting ready</h3>
<p>We'll read the&nbsp;<kbd>zen_of_python.txt</kbd>&nbsp;file, containing the <em>Zen of Python</em> by Tim Peters, which is a collection of aphorisms that very well describe the design principles behind Python. It is available in the GitHub repository here:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/documents/zen_of_python.txt">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/documents/zen_of_python.txt</a>:</p>
<pre><code class="lang-python">Beautiful is better than ugly.
Explicit is better than implicit.
Simple is better than complex.
Complex is better than complicated.
Flat is better than nested.
Sparse is better than dense.
Readability counts.
Special cases aren't special enough to break the rules.
Although practicality beats purity.
Errors should never pass silently.
Unless explicitly silenced.
In the face of ambiguity, refuse the temptation to guess.
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you're Dutch.
Now is better than never.
Although never is often better than *right* now.
If the implementation is hard to explain, it's a bad idea.
If the implementation is easy to explain, it may be a good idea.
Namespaces are one honking great idea -- let's do more of those!</code></pre>
<p>The <em>Zen of Python</em> is described in PEP-20&nbsp;here:&nbsp;<a href="https://www.python.org/dev/peps/pep-0020/">https://www.python.org/dev/peps/pep-0020/</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The <em>Zen of Python</em> can be displayed in any Python interpreter by calling <kbd>import this</kbd>.</p>
</div>
</div>
<h3>How to do it...</h3>
<ol>
<li>Open and print the whole file, line by line (the result is not displayed):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('zen_of_python.txt') as file:
...     for line in file:
...         print(line)
...
[RESULT NOT DISPLAYED]</code></pre>
<ol start="2">
<li>Open the file and print any line containing the string <kbd>should</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('zen_of_python.txt', 'r') as file:
...     for line in file:
...         if 'should' in line.lower():
...             print(line)
...
Errors should never pass silently.
There should be one-- and preferably only one --obvious way to do it.</code></pre>
<ol start="3">
<li>Open the file and print the first line containing the word <kbd>better</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('zen_of_python.txt', 'rt') as file:
...     for line in file:
...         if 'better' in line.lower():
...             print(line)
...             break
...
Beautiful is better than ugly.</code></pre>
<h3>How it works...</h3>
<p>To open a file in text mode, use the <kbd>open()</kbd> function. This returns a <kbd>file</kbd> object that then can be iterated over to return it line by line, as shown in step 1 of the <em>How to do it&hellip;</em> section.</p>
<p>The <kbd>with</kbd> context manager is a very convenient way of dealing with files, as it will close them after finishing its use (leaving the block). It will do so even if there's an exception raised.</p>
<p>Step 2 shows how to iterate and filter the lines based in what lines are applicable for our tasks. The lines are returned as strings that can be filtered in multiple ways, as described before.</p>
<p>Reading the whole file may not be required, as shown in step 3. Because iterating through the file line by line will be reading the file as you go, you can stop at any time, avoiding reading the rest of the file. For a small file such as our example, that's not very relevant, but for long files, this can reduce memory use and time.</p>
<h3>There's more...</h3>
<p>The <kbd>with</kbd> context manager is the preferred way of dealing with files, but it's not the only one. You may also open and close them manually, like this:</p>
<pre><code class="lang-python">&gt;&gt;&gt; file = open('zen_of_python')
&gt;&gt;&gt; content = file.read()
&gt;&gt;&gt; file.close()</code></pre>
<p>Note the <kbd>.close()&nbsp;</kbd> method, to ensure that the file is closed and to free resources related to opening a file.&nbsp;The <kbd>.read()</kbd>&nbsp;method reads the whole file in one go, instead of line by line.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The <kbd>.read()</kbd> method also accepts a size parameter in bytes that limits the size of the data read. For example, <kbd>file.read(1024)</kbd> will return up to 1 KB of information. The next call to <kbd>.read()</kbd> will continue from that point.</p>
</div>
</div>
<p>Files are opened in a particular mode. Modes define a combination of read/write as well as text or binary data. By default, files are opened in read-only and text mode, which are described as <kbd>'r'</kbd>&nbsp;(step 2) or <kbd>'rt'</kbd> (step 3).</p>
<p>More modes will be explored in other recipes.</p>
<h3>See also</h3>
<ul>
<li>The <em>Crawling and searching directories</em> recipe</li>
<li>The <em>Dealing with encodings</em> recipe</li>
</ul>
<h2>Dealing with encodings</h2>
<p>Text files can be present in different encodings. In recent years, the situation has greatly improved, but there are still compatibility problems when working with different systems.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>There's a difference between raw data in a file and a string object in Python. The string object has been transformed from whatever encoding the file contains into a native string. Once it is in this format, it may need to be stored in different encodings. By default, Python works with the defined by the OS, which in modern operating systems is&nbsp;UTF-8.&nbsp; This is a highly compatible encoding, but you may need to save files in a different one.</p>
</div>
</div>
<h3>Getting ready</h3>
<p>We prepared two files in the GitHub repository that store the string <kbd>20&pound;</kbd> in two different encodings. One in usual UTF8 and another in&nbsp;ISO 8859-1, another common encoding. The files are available in GitHub under the&nbsp;<kbd>Chapter04/documents</kbd>&nbsp;directory, with the names <kbd>example_iso.txt</kbd> and <kbd>example_utf8.txt</kbd>:&nbsp;</p>
<p><a href="https://github.com/PacktPublishing/Python-Automation-Cookbook">https://github.com/PacktPublishing/Python-Automation-Cookbook</a></p>
<p>We'll use the Beautiful Soup&nbsp;module, presented in the&nbsp;<em>Parsing HTML</em> recipe in&nbsp;Chapter 3,&nbsp;<em>Building Your First Web Scraping Application</em>.</p>
<h3>How to do it...</h3>
<ol>
<li>Open the&nbsp;<kbd>example_utf8.txt</kbd>&nbsp;file&nbsp;and display its content:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('example_utf8.txt') as file:
...     print(file.read())
...
20&pound;</code></pre>
<ol start="2">
<li>Try to open the&nbsp;<kbd>example_iso.txt</kbd>&nbsp;file, which will raise an exception:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('example_iso.txt') as file:
... print(file.read())
...
Traceback (most recent call last):
  ...
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xa3 in position 2: invalid start byte</code></pre>
<ol start="3">
<li>Open the&nbsp;<kbd>example_iso.txt</kbd>&nbsp;file&nbsp;with the proper encoding:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('example_iso.txt', 
              encoding='iso-8859-1') as file:
...     print(file.read())
...
20&pound;</code></pre>
<ol start="4">
<li>Open the <kbd>utf8</kbd> file and save its content in an&nbsp;<kbd>iso-8859-1</kbd> file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('example_utf8.txt') as file:
...     content = file.read()
&gt;&gt;&gt; with open('example_output_iso.txt', 'w',
               encoding='iso-8859-1') as file:
...     file.write(content)
...
4</code></pre>
<ol start="5">
<li>Finally, read from the new file in the proper format to ensure it is correctly saved:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('example_output_iso.txt', 
              encoding='iso-8859-1') as file:
...     print(file.read())
...
20&pound;</code></pre>
<h3>How it works...</h3>
<p>Steps 1 and 2 in the <em>How to do it&hellip;</em> section are very straightforward. In step 3, we add an extra parameter,&nbsp;<kbd>encoding</kbd>, to specify that the file needs to be opened in something different to UTF-8.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Python accepts a lot of standard encodings right out of the box. Check here for all of them and their aliases:&nbsp;<a href="https://docs.python.org/3/library/codecs.html#standard-encodings">https://docs.python.org/3/library/codecs.html#standard-encodings</a>.</p>
</div>
</div>
<p>In step 4, we create a new file in&nbsp;ISO-8859-1 and write to it as usual. Notice the <kbd>'w'</kbd> parameter, which specifies to open it for writing and in text mode.&nbsp;</p>
<p>Step 5 is a confirmation that the file is properly saved.</p>
<h3>There's more...</h3>
<p>This recipe assumes that we know the encoding a file is in. But sometimes we're not sure about that.&nbsp;Beautiful Soup, a module to parse HTML, can try to detect what encoding a particular file has.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Automatically detecting what encoding a file has may be, well, impossible, as there are potentially an infinte number of encodings. But we'll check the usual encodings that should cover 90% of the real world cases. Just remember that the easiest way of knowing for sure is to ask whomever created the file in the first place.</p>
</div>
</div>
<p>To do so, we'll need to open the file to read in binary format with the <kbd>'rb'</kbd> parameter, to then pass the binary content to the&nbsp;<kbd>UnicodeDammit</kbd>&nbsp;module&nbsp;of Beautiful Soup, like this:</p>
<pre><code class="lang-python">&gt;&gt;&gt; from bs4 import UnicodeDammit
&gt;&gt;&gt; with open('example_output_iso.txt', 'rb') as file:
...     content = file.read()
...
&gt;&gt;&gt; suggestion = UnicodeDammit(content)
&gt;&gt;&gt; suggestion.original_encoding
'iso-8859-1'
&gt;&gt;&gt; suggestion.unicode_markup
'20&pound;\n'</code></pre>
<p>The encoding can then be inferred. Though <kbd>.unicode_markup</kbd> returns the decoded string, it's better to use this suggestion only once, to then open the file in our automated task with the proper encoding.</p>
<h3>See also</h3>
<ul>
<li>The <em>Manipulating strings</em> recipe in&nbsp;Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em></li>
<li>The <em>Parsing HTML</em> recipe in Chapter 3,&nbsp;<em>Building Your First Web Scraping Application</em></li>
</ul>
<h2>Reading CSV files</h2>
<p>Some text files contain tabular data separated by commas. This is a convenient way of creating structured data, instead of using proprietary, more complex formats such as Excel or others. These files are called <strong>Comma Separated Values</strong>, or <strong>CSV</strong>, files and most spreadsheet packages also export to it.</p>
<h3>Getting ready</h3>
<p>We've prepared a CSV file using the data for the 10 top movies by theatre attendance, as described by this page:&nbsp;<a href="http://www.mrob.com/pub/film-video/topadj.html">http://www.mrob.com/pub/film-video/topadj.html</a>.</p>
<p>We copied the first ten elements of the table into a spreadsheet program (Numbers) and exported the file as a CSV. The file is available in the GitHub repository in the <kbd>Chapter04/documents</kbd>&nbsp;directory as <kbd>top_films.csv</kbd>:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000038.png" class="lazyload" /></p>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>csv</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import csv</code></pre>
<ol start="2">
<li>Open the file, create a reader, and iterate through it to show the tabular data of all rows (only three rows are shown):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('top_films.csv') as file:
...   data = csv.reader(file)
...   for row in data:
...       print(row)
...
['Rank', 'Admissions\n(millions)', 'Title (year) (studio)', 'Director(s)']
['1', '225.7', 'Gone With the Wind (1939)\xa0(MGM)', 'Victor Fleming, George Cukor, Sam Wood']
['2', '194.4', 'Star Wars (Ep. IV: A New Hope) (1977)\xa0(Fox)', 'George Lucas']
...
['10', '118.9', 'The Lion King (1994)\xa0(BV)', 'Roger Allers, Rob Minkoff']</code></pre>
<ol start="3">
<li>Open the file and use&nbsp;<kbd>DictReader</kbd> to structure the data, including the header:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('top_films.csv') as file:
...     data = csv.DictReader(file)
...     structured_data = [row for row in data]
...
&gt;&gt;&gt; structured_data[0]
OrderedDict([('Rank', '1'), ('Admissions\n(millions)', '225.7'), ('Title (year) (studio)', 'Gone With the Wind (1939)\xa0(MGM)'), ('Director(s)', 'Victor Fleming, George Cukor, Sam Wood')])</code></pre>
<ol start="4">
<li>&nbsp;Each of the items in <kbd>structured_data</kbd> is a full dictionary that contains each of the values:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; structured_data[0].keys()
odict_keys(['Rank', 'Admissions\n(millions)', 'Title (year) (studio)', 'Director(s)'])
&gt;&gt;&gt; structured_data[0]['Rank']
'1'
&gt;&gt;&gt; structured_data[0]['Director(s)']
'Victor Fleming, George Cukor, Sam Wood'</code></pre>
<h3>How it works...</h3>
<p>Notice that the file needs to be read, and we use a <kbd>with</kbd> context manager. This ensures&nbsp;that the file is closed at the end of the block.</p>
<p>As shown in step 2 from the <em>How to do it&hellip;</em> section, the <kbd>csv.reader</kbd> class allows us to structure the returning lines of code by subdividing them as lists, following the format of the table data. Notice how all the values are described as strings. <kbd>csv.reader</kbd> does not understand whether the first line is a header or not.</p>
<p>For a more structured read of the file, in step 3 we use <kbd>csv.DictReader</kbd>, which by default reads the first row as a header defining the fields described later, and then converts each of the rows into dictionaries with those fields.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Sometimes, like in this case, the names of the fields as described in the file can be a little verbose. Don't be afraid to translate the dictionary on an extra step into more manageable field names.</p>
</div>
</div>
<h3>There's more...</h3>
<p>As CSV is a very loosely defined interpretation, there are several ways that the data can be stored. This is represented in the <kbd>csv</kbd> module as <strong>dialects</strong>. For example, the values can be delimited by commas, semicolons, or tabs. The list of default accepted dialects can be displayed by calling <kbd>csv.list_dialect</kbd>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>By default, the dialect will be Excel, which is the most common one. Even other spreadsheets will commonly use it.</p>
</div>
</div>
<p>But dialects can also be inferred from the file itself through the <kbd>Sniffer</kbd> class. The <kbd>Sniffer</kbd> class analyzes a sample of the file (or the whole file) and returns a <kbd>dialect</kbd> object to allow reading in the proper way.</p>
<p>Notice that the file is open with no new lines, to not make any assumptions about it:</p>
<pre><code class="lang-python">&gt;&gt;&gt; with open('top_films.csv', newline='') as file:
...    dialect = csv.Sniffer().sniff(file.read())</code></pre>
<p>The dialect can then be used when opening the reader. Note the <kbd>newline</kbd> again, as the dialect will split the lines correctly:</p>
<pre><code class="lang-python">&gt;&gt;&gt; with open('top_films.csv', newline='') as file:
...     reader = csv.reader(file, dialect)
...     for row in reader:
...         print(row)</code></pre>
<p>The full <kbd>csv</kbd> module documentation can be found here:&nbsp;<a href="https://docs.python.org/3.6/library/csv.html">https://docs.python.org/3.6/library/csv.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Dealing with encodings</em> recipe</li>
<li>The <em>Reading text files</em> recipe</li>
</ul>
<h2>Reading log files</h2>
<p>Another common structured text file format is <strong>log files</strong>. Log files consist of rows of logs, which are a line of text with a particular format. Typically, each one will have a time when it happened, so the file is an ordered collection of events.</p>
<h3>Getting ready</h3>
<p>The&nbsp;<kbd>example_log.log</kbd>&nbsp;file&nbsp;with five sales logs can be obtained from the GitHub repository here:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/documents/example_logs.log">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/documents/example_logs.log</a>.</p>
<p>The format is the following:</p>
<pre><code class="lang-python">[&lt;Timestamp in iso format&gt;] - SALE - PRODUCT: &lt;product id&gt; - PRICE: $&lt;price of the sale&gt;</code></pre>
<p>We'll use the&nbsp;<kbd>Chapter01/price_log.py</kbd>&nbsp;file&nbsp;to process each log into an object.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>PriceLog</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from price_log import PriceLog</code></pre>
<ol start="2">
<li>Open the log file and parse all logs:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('example_logs.log') as file:
...     logs = [PriceLog.parse(log) for log in file]
...
&gt;&gt;&gt; len(logs)
5
&gt;&gt;&gt; logs[0]
&lt;PriceLog (Delorean(datetime=datetime.datetime(2018, 6, 17, 22, 11, 50, 268396), timezone='UTC'), 1489, 9.99)&gt;</code></pre>
<ol start="3">
<li>Determine the total income by all sales:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; total = sum(log.price for log in logs)
&gt;&gt;&gt; total
Decimal('47.82')</code></pre>
<ol start="4">
<li>Determine how many units have been sold of each <kbd>product_id</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from collections import Counter
&gt;&gt;&gt; counter = Counter(log.product_id for log in logs)
&gt;&gt;&gt; counter
Counter({1489: 2, 4508: 1, 8597: 1, 3086: 1})</code></pre>
<ol start="5">
<li>Filter the logs to find all occurrences of selling product ID <kbd>1489</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; logs = []
&gt;&gt;&gt; with open('example_logs.log') as file:
...     for log in file:
...         plog = PriceLog.parse(log)
...         if plog.product_id == 1489:
...             logs.append(plog)
...
&gt;&gt; len(logs)
2
&gt;&gt;&gt; logs[0].product_id, logs[0].timestamp
(1489, Delorean(datetime=datetime.datetime(2018, 6, 17, 22, 11, 50, 268396), timezone='UTC'))
&gt;&gt;&gt; logs[1].product_id, logs[1].timestamp
(1489, Delorean(datetime=datetime.datetime(2018, 6, 17, 22, 11, 50, 268468), timezone='UTC'))</code></pre>
<h3>How it works...</h3>
<p>As each of the logs is a single line, we open the file and go one by one, parsing each of them. The parsing code is available&nbsp;on <kbd>price_log.py</kbd>. Check it for more details.</p>
<p>In Step 2 in the <em>How to do it&hellip;</em> section, we open the file and process each of the lines to create a log list with all our processed logs. Then, we can produce aggregation operations, as in the next steps.</p>
<p>Step 3 shows how to aggregate all values, in this case summing the price of all items sold over the log file, to get the total revenue.</p>
<p>Step 4 uses the Counter to determine the amount of each item in the file log. This returns a dictionary-like object with the values to count and the number of times they appear.</p>
<p>Filtering can also be done in a line-by-line approach, as shown in step 5. This is similar to the other filtering in the recipes of this chapter.</p>
<h3>There's more...</h3>
<p>Remember that you can stop processing a file as soon as you have all the data you need. This may be a good strategy if the file is very big, as is usually the case with log files.</p>
<p>Counter is a great tool to quickly count a list. See the Python documentation here for more details:&nbsp;<a href="https://docs.python.org/2/library/collections.html#counter-objects">https://docs.python.org/2/library/collections.html#counter-objects</a>. You can get the ordered items by calling the following:</p>
<pre><code class="lang-python">&gt;&gt;&gt; counter.most_common()
[(1489, 2), (4508, 1), (8597, 1), (3086, 1)]</code></pre>
<h3>See also</h3>
<ul>
<li>The <em>Using a third party tool&mdash;parse</em> recipe in Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em></li>
<li>The <em>Reading text files</em> recipe</li>
</ul>
<h2>Reading file metadata</h2>
<p>File metadata is everything associated with a particular file that is not the data itself. That means parameters such as the size of the file, the creation date, or its permissions.</p>
<p>Browsing through that data is important, for example, to filter files older than a date, or find all files bigger than a value in KBs. In this recipe, we'll see how to access the file metadata in Python.</p>
<h3>Getting ready</h3>
<p>We'll use the&nbsp;<kbd>zen_of_python.txt</kbd>&nbsp;file, available in the GitHub repository (<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/documents/zen_of_python.txt">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/documents/zen_of_python.txt</a>). As you can see by using the <kbd>ls</kbd> command, the file has <kbd>856</kbd> bytes, and, in this example, it was created on June 14:</p>
<pre><code class="lang-python">$ ls -lrt zen_of_python.txt
-rw-r--r--@ 1 jaime staff 856 14 Jun 21:22 zen_of_python.txt</code></pre>
<p>On your computer the dates may vary, based on when you downloaded the code.</p>
<h3>How to do it...</h3>
<ol>
<li>Import&nbsp;<kbd>os</kbd>&nbsp;and&nbsp;<kbd>datetime</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import os
&gt;&gt;&gt; from datetime import datetime</code></pre>
<ol start="2">
<li>Retrieve the stats of the&nbsp;<kbd>zen_of_python.txt</kbd>&nbsp;file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; stats = os.stat(('zen_of_python.txt')
&gt;&gt;&gt; stats
os.stat_result(st_mode=33188, st_ino=15822537, st_dev=16777224, st_nlink=1, st_uid=501, st_gid=20, st_size=856, st_atime=1529461935, st_mtime=1529007749, st_ctime=1529007757)</code></pre>
<ol start="3">
<li>Get the size of the file, in bytes:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; stats.st_size
856</code></pre>
<ol start="4">
<li>Obtain when the file was last modified:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; datetime.fromtimestamp(stats.st_mtime)
datetime.datetime(2018, 6, 14, 21, 22, 29)</code></pre>
<ol start="5">
<li>Obtain when the file was last accessed:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; datetime.fromtimestamp(stats.st_atime)
datetime.datetime(2018, 6, 20, 3, 32, 15)</code></pre>
<h3>How it works...</h3>
<p><kbd>os.stats</kbd>&nbsp;returns a stats object that represents the metadata stored in the filesystem. The metadata includes:</p>
<ul>
<li>The size of the file, in bytes, as shown in step 3 in the <em>How to do it&hellip;</em> section, using&nbsp;<kbd>st_size</kbd></li>
<li>When the file content was last modified, as shown in step 4, using&nbsp;<kbd>st_mtime</kbd></li>
<li>When the file was last read (accessed), as shown in step 5, using&nbsp;<kbd>st_atime</kbd></li>
</ul>
<p>The times are returned as timestamps, so in steps 4 and 5 we create a&nbsp;<kbd>datetime</kbd>&nbsp;object from the timestamps to better access the data.</p>
<p>All these values can be used to filter the files.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Notice you don't need to open the file with&nbsp;<kbd>open()</kbd>&nbsp;to read its metadata. Detecting whether a file has been changed after a known value will be quicker than comparing its content, so you can take advantage of that for comparison.</p>
</div>
</div>
<h3>There's more...</h3>
<p>To obtain the stats one by one, there are also convenience&nbsp;functions available in <kbd>os.path</kbd>, which follow the pattern <kbd>get&lt;value&gt;</kbd>:</p>
<pre><code class="lang-python">&gt;&gt;&gt; os.path.getsize('zen_of_python.txt')
856
&gt;&gt;&gt; os.path.getmtime('zen_of_python.txt')
1529531584.0
&gt;&gt;&gt; os.path.getatime('zen_of_python.txt')
1529531669.0</code></pre>
<p>The value is specified in the UNIX timestamp format (seconds since&nbsp; January&nbsp;1,&nbsp;1970).</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Notice calling these three functions will be slower than calling&nbsp;<kbd>os.stats</kbd>&nbsp;and processing the results. Also, returned <kbd>stats</kbd> can be inspected to detect the available values.</p>
</div>
</div>
<p>The values described in the recipe are available for all filesystems, but there are more that can be used.</p>
<p>For example, to obtain the creation date of a file, you can use the <kbd>st_birthtime</kbd> parameter for MacOS or <kbd>st_mtime</kbd> in Windows.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p><kbd>st_mtime</kbd>&nbsp;is always available, but its meaning changes between systems. In Unix systems, it will change when the content is modified, so it's not a reliable time of creation.</p>
</div>
</div>
<p><kbd>os.stat</kbd>&nbsp;will follow symbolic links. If you want to get the stats of a symbolic link, use&nbsp;<kbd>os.lstat()</kbd>.</p>
<p>Check the full documentation about all available stats here:&nbsp;<a href="https://docs.python.org/3.6/library/os.html#os.stat_result">https://docs.python.org/3.6/library/os.html#os.stat_result</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Reading text files</em> recipe</li>
<li>The <em>Reading images</em> recipe</li>
</ul>
<h2>Reading images</h2>
<p>Probably the most common data that is not text is image data. Images had their own set of specific metadata that can be read to filter values or perform other operations.</p>
<p>A main challenge is dealing with multiple formats and different metadata definitions. We'll show in this recipe how to get information from both a JPEG and PNG, and how the same information can be encoded differently.</p>
<h3>Getting ready</h3>
<p>The best general toolkit for dealing with images in Python is, arguably, Pillow. This module allows you to easily read files in the most common formats, as well as perform operations on them. Pillow started as a fork of <strong>PIL</strong> (<strong>Python Imaging Library</strong>), a previous module that became stagnant some years ago.</p>
<p>We will also use the <kbd>xmltodict</kbd> module to transform some data in XML to a more convenient dictionary. Add both modules to <kbd>requirements.txt</kbd> and reinstall into the virtual environment:</p>
<pre><code class="lang-python">$ echo "Pillow==5.1.0" &gt;&gt; requirements.txt
$ echo "xmltodict==0.11.0" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>The metadata information in photo files is defined in the <strong>EXIF</strong>&nbsp;(<strong>Exchangeable Image File</strong>)&nbsp;format.&nbsp;EXIF&nbsp;is a standard to store information about pictures, including things like what camera took the picture, when it was taken, GPS on where, exposure, focal length, color info, and so on.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>You can get a good summary here:&nbsp;<a href="https://www.slrphotographyguide.com/what-is-exif-metadata/">https://www.slrphotographyguide.com/what-is-exif-metadata/</a>. All the information is optional, but virtually all digital cameras and processing software will store some data. Because of the privacy concerns, parts of it, like the exact location, can be disabled.</p>
</div>
</div>
<p>The following images will be used for this recipe, and are available to download in the GiHub repository (<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter04/images">https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter04/images</a>):</p>
<ul>
<li><kbd>photo-dublin-a1.jpg</kbd></li>
<li><kbd>photo-dublin-a2.png</kbd></li>
<li><kbd>photo-dublin-b.png</kbd></li>
</ul>
<p>Two of them,&nbsp;<kbd>photo-dublin-a1.jpg</kbd> and&nbsp;<kbd>photo-dublin-a2.png</kbd>, are the same photo, but while the first is the raw picture the second one has been retouched to slightly change the colors and crop it. Notice one is in JPEG format and the other in PNG. The other one,&nbsp;<kbd>photo-dublin-b.png&nbsp;</kbd>, is a different picture. Both pictures were taken in Dublin, with the same phone camera, on two different days.</p>
<p>While Pillow understands how JPG files store the EXIF info&nbsp;directly, PNG files store XMP info, a more generic standard that can contain EXIF info.&nbsp;</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>More info about XMP can be obtained here:&nbsp;<a href="https://www.adobe.com/devnet/xmp.html">https://www.adobe.com/devnet/xmp.html</a>. For the most part, it defines an XML tree structure that's relatively readable in raw.</p>
</div>
</div>
<p>To further complicate it, XMP is a subset of RDF, which is a&nbsp;standard describing the way of encoding the information.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>If EFIX, XMP, and RDF sounds confusing, well, it's because they are. Ultimately, they are just names to store the values we are interested in. We can inspect the specifics of the names using Python introspection tools and check exactly how the data is structured and what the name of the parameter we are looking for is.</p>
</div>
</div>
<p>As the GPS information is stored in different formats, we've included in the GitHub repository a file called <kbd>gps_conversion.py</kbd>, here: <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/gps_conversion.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/gps_conversion.py</a>.&nbsp;This includes the functions <kbd>exif_to_decimal</kbd> and <kbd>rdf_to_decimal</kbd>, which will transform both formats into decimals to compare them.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the modules and functions to use in this recipe:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from PIL import Image
&gt;&gt;&gt; from PIL.ExifTags import TAGS, GPSTAGS
&gt;&gt;&gt; import xmltodict
&gt;&gt;&gt; from gps_conversion import exif_to_decimal, rdf_to_decimal</code></pre>
<ol start="2">
<li>Open the first photo:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; image1 = Image.open('photo-dublin-a1.jpg')</code></pre>
<ol start="3">
<li>Get the width, height, and format of the file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; image1.height
3024
&gt;&gt;&gt; image1.width
4032
&gt;&gt;&gt; image1.format
'JPEG'</code></pre>
<ol start="4">
<li>Retrieve the EXIF information of the image, and process it for a convenient dictionary. Show the camera, the lens used, and when it was taken:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; exif_info_1 = {TAGS.get(tag, tag): value 
                   for tag, value in image1._getexif().items()}
&gt;&gt;&gt; exif_info_1['Model']
'iPhone X'
&gt;&gt;&gt; exif_info_1['LensModel']
'iPhone X back dual camera 4mm f/1.8'
&gt;&gt;&gt; exif_info_1['DateTimeOriginal']
'2018:04:21 12:07:55'</code></pre>
<ol start="5">
<li>Open the second image and obtain the XMP info:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; image2 = Image.open('photo-dublin-a2.png')
&gt;&gt;&gt; image2.height
2630
&gt;&gt;&gt; image2.width
3943
&gt;&gt;&gt; image2.format
'PNG'
&gt;&gt;&gt; xmp_info = xmltodict.parse(image2.info['XML:com.adobe.xmp'])</code></pre>
<ol start="6">
<li>Obtain the RDF description field, which contains all the values we are looking for. Retrieve the model (a TIFF value), the lens model (an EXIF value), and the creation date (an XMP value). Check the values are the same as in step 4, even if the file is different:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; rdf_info_2 = xmp_info['x:xmpmeta']['rdf:RDF']['rdf:Description']
&gt;&gt;&gt; rdf_info_2['tiff:Model']
'iPhone X'
&gt;&gt;&gt; rdf_info_2['exifEX:LensModel']
'iPhone X back dual camera 4mm f/1.8'
&gt;&gt;&gt; rdf_info_2['xmp:CreateDate']
'2018-04-21T12:07:55'</code></pre>
<ol start="7">
<li>Obtain the GPS information in both pictures, transform into an equivalent format, and check that they are the same. Notice that the resolution is not the same, but they match up to the fourth decimal point:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; gps_info_1 = {GPSTAGS.get(tag, tag): value 
                  for tag, value in exif_info_1['GPSInfo'].items()}
&gt;&gt;&gt; exif_to_decimal(gps_info_1)
('N53.34690555555556', 'W6.247797222222222')
&gt;&gt;&gt; rdf_to_decimal(rdf_info_2)
('N53.346905', 'W6.247796666666667')</code></pre>
<ol start="8">
<li>Open the third image and obtain the creation date and GPS info, and check it doesn't match the other photo, although it is close (the second and third decimals are not the same):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; image3 = Image.open('photo-dublin-b.png')
&gt;&gt;&gt; xmp_info = xmltodict.parse(image3.info['XML:com.adobe.xmp'])
&gt;&gt;&gt; rdf_info_3 = xmp_info['x:xmpmeta']['rdf:RDF']['rdf:Description']
&gt;&gt;&gt; rdf_info_3['xmp:CreateDate']
'2018-03-08T18:16:57'
&gt;&gt;&gt; rdf_to_decimal(rdf_info_3)
('N53.34984166666667', 'W6.260388333333333')</code></pre>
<h3>How it works...</h3>
<p>Pillow is able to interpret files in most common languages, and open them as images in JPG format, as shown in step 2 in the <em>How to do it&hellip;</em> section.</p>
<p>The <kbd>Image</kbd> object contains the basic information about the size and format of the file, and is displayed in step 3. The <kbd>info</kbd> property contains information that is dependent on the format.</p>
<p>The EXIF metadata for JPG files can be parsed with the&nbsp;<kbd>._getexif()</kbd>&nbsp;method, but then it needs to be translated properly, as it uses the raw binary definition. For example, the number 42,036 corresponds to the&nbsp;<kbd>LensModel</kbd>&nbsp;property. Fortunately, there's a definition of all tags in the&nbsp;<kbd>PIL.ExifTags</kbd>&nbsp;module. We translate the dictionary to readable tags in the step 4 to obtain a more readable dictionary.</p>
<p>Step 5 opens a PNG format, which has the same properties related to size, but the metadata is stored in XML/RDF format and needs to be parsed with the help of <kbd>xmltodict.</kbd> Step 6 shows how to navigate this metadata to extract the same information as in the JPG format. The data is the same, as both files come from the same original picture, even if the images are different.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p><kbd>xmltodict</kbd> has some issues when trying to parse data that's not in XML format. Check that the input is valid XML.</p>
</div>
</div>
<p>Step 7 extracted the GPS information for both images, which is stored in different ways, and shows they are the same (although the precision is different because of the way it is encoded).</p>
<p>Step 8 shows the information on a different photo.</p>
<h3>There's more...</h3>
<p>Pillow also has a lot of functionality around modifying pictures. It is very easy to resize or make simple modifications to a file, such as rotating it. You can find the complete Pillow documentation here:&nbsp;<a href="https://pillow.readthedocs.io">https://pillow.readthedocs.io</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Pillow allow a lot of operations with images. Not only simple operations such as resizing or transforming one format into another, but also things like cropping the image, applying color filters, or generating animated GIFs. If you're interested in image processing using Python, it is definitely something to take a look at.</p>
</div>
</div>
<p>The GPS coordinates in the recipe are stated in <strong>DMS</strong> (<strong>Degrees</strong>, <strong>Minutes</strong>, <strong>Seconds</strong>), <strong>DDM</strong> (<strong>Degrees</strong>, <strong>Decimal Minutes</strong>), and transformed into <strong>DD</strong> (<strong>Decimal Degrees</strong>). You can find more about the different GPS formats here:&nbsp;<a href="http://www.ubergizmo.com/how-to/read-gps-coordinates/">http://www.ubergizmo.com/how-to/read-gps-coordinates/</a>. You'll also find how to search the exact locations of the pictures there, in case you're curious.</p>
<p>A more advanced use of reading image files is to try to process them for <strong>OCR</strong> (<strong>Optical Character Recognition</strong>). This means automatically detecting text in an image and extracting and processing it. The open source module <kbd>tesseract</kbd> allows you to do this, and it can be used with Python and Pillow.</p>
<p>You need to install <kbd>tesseract</kbd> in your system (<a href="https://github.com/tesseract-ocr/tesseract/wiki">https://github.com/tesseract-ocr/tesseract/wiki</a>), and the <kbd>pytesseract</kbd>&nbsp;Python module (using <kbd>pip install pytesseract</kbd>). You can download a file with clear text, called <kbd>photo-text.jpg</kbd>, from the GitHub repository at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/images/photo-text.jpg">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/images/photo-text.jpg</a><a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/images/photo-text.jpg">:</a></p>
<pre><code class="lang-python">&gt;&gt;&gt; from PIL import Image
&gt;&gt;&gt; import pytesseract
&gt;&gt;&gt; pytesseract.image_to_string(Image.open('photo-text.jpg'))
'Automate!'</code></pre>
<p>OCR can be difficult if the text is not very clear in the image, or it is mixed with images, or it uses a distinctive font. There's an example of that in the&nbsp;<kbd>photo-dublin-a-text.jpg</kbd>&nbsp;file, (available in the GitHub repository at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/images/photo-dublin-a-text.jpg">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/images/photo-dublin-a-text.jpg</a>), which includes text over the picture:</p>
<pre><code class="lang-python">&gt;&gt;&gt; &gt;&gt;&gt; pytesseract.image_to_string(Image.open('photo-dublin-a-text.jpg'))
'fl\n\nAutomat'</code></pre>
<p>More information about Tesseract is available at the following links:<br /><a href="https://github.com/tesseract-ocr/tesseract">https://github.com/tesseract-ocr/tesseract</a><br /><a href="https://github.com/madmaze/pytesseract">https://github.com/madmaze/pytesseract</a></p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Properly importing files to OCR may require initial image processing for better results. Image processing is out of scope for the objectives of this book, but you may use OpenCV,&nbsp;which more powerful than Pillow. You can process a file and then open it with Pillow:&nbsp;<a href="http://opencv-python-tutroals.readthedocs.io/en/latest/py_tutorials/py_tutorials.html">http://opencv-python-tutroals.readthedocs.io/en/latest/py_tutorials/py_tutorials.html</a>.</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The <em>Reading text files</em> recipe</li>
<li>The <em>Reading file metadata</em>&nbsp;recipe</li>
<li>The <em>Crawling and searching directories</em>&nbsp;recipe</li>
</ul>
<h2>Reading PDF files</h2>
<p>A common format for documents is <strong>PDF</strong> (<strong>Portable Document Format</strong>). It started as a format to describe a document for any printer, so PDF is a format that ensures that the document will be printed exactly as it shows, and therefore is a great way of guaranteeing consistency. It has become a powerful standard&nbsp;for sharing documents, especially documents that are read-only.</p>
<h3>Getting ready</h3>
<p>For this recipe, we are going to use the&nbsp;<kbd>PyPDF2</kbd>&nbsp;module. We need to add it to our virtual environment:</p>
<pre><code class="lang-python">&gt;&gt;&gt; echo "PyPDF2==1.26.0" &gt;&gt; requirements.txt
&gt;&gt;&gt; pip install -r requirements.txt</code></pre>
<p>In the GitHub directory <kbd>Chapter03/documents</kbd>, we have prepared two documents, <kbd>document-1.pdf</kbd> and&nbsp;<kbd>document-2.pdf</kbd>, to use in this recipe. Note they contain mostly Lorem Ipsum text, which is just placeholder text.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Lorem Ipsum text is commonly used in design to show text without needing to create the content before the design. Learn more about it here:&nbsp;<a href="https://loremipsum.io/">https://loremipsum.io/</a>.</p>
</div>
</div>
<p>They are both the same test document, but the second one can only be opened with a password. The password is <kbd>automate</kbd>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from PyPDF2 import PdfFileReader</code></pre>
<ol start="2">
<li>Open the&nbsp;<kbd>document-1.pdf</kbd>&nbsp;file and create a PDF document object. Notice the file needs to be open for the whole reading:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; file = open('document-1.pdf', 'rb')
&gt;&gt;&gt; document = PdfFileReader(file)</code></pre>
<ol start="3">
<li>Get the number of pages of the document, and check it is not encrypted:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.numPages
3
&gt;&gt;&gt; document.isEncrypted
False</code></pre>
<ol start="4">
<li>Get the creation date from the document info (<kbd>2018-Jun-24 11:15:18</kbd>), and discover that it has been created with a Mac <kbd>Quartz PDFContext</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.documentInfo['/CreationDate']
"D:20180624111518Z00'00'"
&gt;&gt;&gt; document.documentInfo['/Producer']
'Mac OS X 10.13.5 Quartz PDFContext'</code></pre>
<ol start="5">
<li>Get the first page, and read the text on it:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.pages[0].extractText()
'!A VERY IMPORTANT DOCUMENT \nBy James McCormac CEO Loose Seal Inc '</code></pre>
<ol start="6">
<li>Do the same operation for the second page (redacted here):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.pages[1].extractText()
'"!This is an example of a test document that is stored in PDF format. It contains some \nsentences to describe what it is and the it has lore ipsum text.\n!"\nLorem ipsum dolor sit amet, consectetur adipiscing elit. ...$'</code></pre>
<ol start="7">
<li>Close the file and open <kbd>document-2.pdf</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; file.close()
&gt;&gt;&gt; file = open('document-2.pdf', 'rb')
&gt;&gt;&gt; document = PdfFileReader(file)</code></pre>
<ol start="8">
<li>Check the document is encrypted (it requires a password) and raises an error if trying to access its content:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.isEncrypted
True
&gt;&gt;&gt; document.numPages
...
PyPDF2.utils.PdfReadError: File has not been decrypted</code></pre>
<ol start="9">
<li>Decrypt the file and access its content:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.decrypt('automate')
1
&gt;&gt;&gt; document.numPages
3
&gt;&gt;&gt; document.pages[0].extractText()
'!A VERY IMPORTANT DOCUMENT \nBy James McCormac CEO Loose Seal Inc ' </code></pre>
<ol start="10">
<li>Close the file to clean up:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; file.close()</code></pre>
<h3>How it works...</h3>
<p>Once the document is open, as shown on steps 1 and 2 in the <em>How to do it&hellip;</em> section, the <kbd>document</kbd> object provides access to the document.</p>
<p>The most interesting properties are the number of pages, available in <kbd>.numPages</kbd>, and each of the pages, available in <kbd>.pages</kbd>, which can be accessed like a list.</p>
<p>Other data accessible is stored in <kbd>.documentInfo</kbd>, which stores metadata on the creator and when it was created.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The information in <kbd>.documentInfo</kbd> is optional and sometimes not up-to-date. It depends greatly on the tool used to generate the PDF.</p>
</div>
</div>
<p>Each of the <kbd>page</kbd> objects can get its text by calling <kbd>.extractText()</kbd>, which will return all the text contained in the page, as done in steps 5 and 6. This method tries to extract all text, but it has some limitations. For well-structured texts, such as our example, it works quite well and the resulting text can be processed cleanly. Dealing with text in multiple columns or located in strange positions, it may complicate working with it.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Notice that the PDF file needs to be open for the whole operation, instead of using a <kbd>with</kbd> context operator. After leaving the <kbd>with</kbd> block, the file is closed.</p>
</div>
</div>
<p>Steps 8 and 9 shows how to deal with encrypted files. You can detect whether a file is encrypted or not with <kbd>.isEncrypted</kbd>, and then decrypt it with the <kbd>.decrypt</kbd> method, giving the password.</p>
<h3>There's more...</h3>
<p>PDF is such a flexible format that it is very standard, but that also means that it can be difficult to parse and process.</p>
<p>While most PDF files contain text information, it is not uncommon that they contain images. This, for example, happens very often with scanned documents. This means that the information is stored as a collection of images, instead of in text. This makes it difficult to extract the data; we end up having to resolve to methods such as OCR to parse the images into text.</p>
<p>PyPDF2 does not provide a good interface to deal with images. You may need to transform the PDF into a collection of images and then process them. Most PDF readers can do it, or you can use a command-line tool such as&nbsp;<kbd>pdftooppm</kbd>&nbsp;(<a href="https://linux.die.net/man/1/pdftoppm">https://linux.die.net/man/1/pdftoppm</a>) or QPDF (see the following). See the&nbsp;<em>Reading images</em>&nbsp;recipe&nbsp; for ideas about OCR.</p>
<p>Some ways of encrypting files may not be understood by PyPDF2. It will generate <kbd>NotImplementedError: only algorithm code 1 and 2 are supported</kbd>. If that happens, you need to decrypt the PDF externally and open it once it is decrypted. You can use QPDF to create a copy without the password, as follows:</p>
<pre><code class="lang-python">$ qpdf --decrypt --password=PASSWORD encrypted.pdf output-decrypted.pdf</code></pre>
<p>The full QPDF is available here:&nbsp;<a href="http://qpdf.sourceforge.net/files/qpdf-manual.html">http://qpdf.sourceforge.net/files/qpdf-manual.html</a>. QPDF is available in most package managers as well.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>QPDF is capable of doing a lot of transformations and analyzing PDFs in-depth. There are also bindings into Python on a module called <kbd>pikepdf</kbd> (<a href="https://pikepdf.readthedocs.io/en/stable/">https://pikepdf.readthedocs.io/en/stable/</a>). This module is more difficult to use than PyPDF2 and it's not as straightforward for text extraction, but it can be useful if other operations such as extracting images from a PDF are required.</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The <em>Reading text files</em> recipe</li>
<li>The <em>Crawling and searching directories</em> recipe</li>
</ul>
<h2>Reading Word documents</h2>
<p>Word documents (<kbd>.docx</kbd>) are another common kind of document that stores text. They are&nbsp;typically&nbsp;generated with Microsoft Office, but other tools also produce compatible files. They are probably the most common format to share files that need to be editable, but they are also common for distributing documents.</p>
<p>We'll see in this recipe how to extract text information from a Word document.</p>
<h3>Getting ready</h3>
<p>We'll use the&nbsp;<kbd>python-docx</kbd>&nbsp;module&nbsp;to read and process Word documents:</p>
<pre><code class="lang-python">&gt;&gt;&gt; echo "python-docx==0.8.6" &gt;&gt; requirements.txt
&gt;&gt;&gt; pip install -r requirements.txt</code></pre>
<p>We have prepared a test file, available in the GitHub&nbsp;<kbd>Chapter04/documents</kbd> directory, called&nbsp;<kbd>document-1.docx</kbd>, which we'll use with this recipe. Note that this document follows the same Lorem Ipsun pattern that was described in the test document for the recipe&nbsp;<em>Reading PDF files</em>&nbsp;recipe&nbsp;.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>python-docx</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt; import docx</code></pre>
<ol start="2">
<li>Open the&nbsp;<kbd>document-1.docx</kbd>&nbsp;file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; doc = docx.Document('document-1.docx')</code></pre>
<ol start="3">
<li>Check some of the metadata properties stored in <kbd>core_properties</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt; doc.core_properties.title
'A very important document'
&gt;&gt;&gt; doc.core_properties.keywords
'lorem ipsum'
&gt;&gt;&gt; doc.core_properties.modified
datetime.datetime(2018, 6, 24, 15, 1, 7)</code></pre>
<ol start="4">
<li>Check the number of paragraphs:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; len(doc.paragraphs)
58</code></pre>
<ol start="5">
<li>Walk through the paragraphs to detect the ones that contain text. Notice not all text is displayed here:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; for index, paragraph in enumerate(doc.paragraphs):
...     if paragraph.text:
...         print(index, paragraph.text)
...
30 A VERY IMPORTANT DOCUMENT
31 By James McCormac
32 CEO Loose Seal Inc
34
...
56 TITLE 2
57 ...</code></pre>
<ol start="6">
<li>Obtain the text for paragraphs <kbd>30</kbd> and <kbd>31</kbd>, which correspond to the title and subtitle on the first page:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; doc.paragraphs[30].text
'A VERY IMPORTANT DOCUMENT'
&gt;&gt;&gt; doc.paragraphs[31].text
'By James McCormac'</code></pre>
<ol start="7">
<li>Each of the paragraphs has <kbd>runs</kbd>, which are sections of the text with different properties.&nbsp;Check that the first text paragraph and <kbd>run</kbd> is in bold and the second is in italics:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; doc.paragraphs[30].runs[0].italic
&gt;&gt;&gt; doc.paragraphs[30].runs[0].bold
True
&gt;&gt;&gt; doc.paragraphs[31].runs[0].bold
&gt;&gt;&gt; doc.paragraphs[31].runs[0].italic
True</code></pre>
<ol start="8">
<li>In this document, most of the paragraphs have only one <kbd>run</kbd>, but we have a good example of different runs in paragraph <kbd>48</kbd>. Display its text and the different styles. For example, the word <kbd>Word</kbd>&nbsp;is in bold, and <kbd>ipsum</kbd>&nbsp;is in italics:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; [run.text for run in doc.paragraphs[48].runs]
['This is an example of a test document that is stored in ', 'Word', ' format', '. It contains some ', 'sentences', ' to describe what it is and it has ', 'lore', 'm', ' ipsum', ' text.']
&gt;&gt;&gt; run1 = doc.paragraphs[48].runs[1]
&gt;&gt;&gt; run1.text
'Word'
&gt;&gt;&gt; run1.bold
True
&gt;&gt;&gt; run2 = doc.paragraphs[48].runs[8]
&gt;&gt;&gt; run2.text
' ipsum'
&gt;&gt;&gt; run2.italic
True</code></pre>
<h3>How it works...</h3>
<p>The most important peculiarity of Word documents is that the data is structured in paragraphs, instead of in pages. The size of the font, line size and other considerations may make the number of pages change.</p>
<p>Most of the paragraphs are also typically empty, or include only new lines, tabs, or other whitespace characters. It is a good idea to check when a paragraph is empty and skip it.</p>
<p>In the <em>How to do it&hellip;</em> section, step 2 opens the file and step 3 shows how to access the core properties. These are properties that are defined in Word as document metadata, such as the author or creation date.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>This information needs to be taken with a grain of salt, as a lot of tools that produce Word documents (but not Microsoft Office) won't necessarily fill it. Double-check before using that information.</p>
</div>
</div>
<p>The paragraphs of the document can be iterated and have their text extracted in raw format, as shown in step 6. This is information that doesn't include styling information and it's typically the most useful one for processing the data automatically.</p>
<p>If the styling information is required, the runs can be used, as in steps 7 and 8. Each paragraph can contain one or more runs, which are smaller units that share the same styling. For example, if a sentence is <em>Word1</em> word2 <strong>word3</strong>, there will be three runs, one with italic text (Word1), another with underline (word2), and another with bold (word3). Even more so, there can be intermediate runs with regular text that contains just the whitespaces, making a total of 5 runs.</p>
<p>The styling can be detected individually on properties such as bold, italic, or underline.&nbsp;</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The division in runs can quite complicated. Due to the way editors work it, is not uncommon to have <em>half-words,</em>&nbsp;a split word in two runs, sometimes with the same properties. Do not rely on the number of runs and analyse the content. In particular, double-check if trying to ensure if a part with a particular style is divided in two or more runs. A good example is the words <kbd>lore</kbd>&nbsp;<kbd>m</kbd>&nbsp;(it should be <kbd>lorem</kbd>) in Step 8.</p>
</div>
</div>
<p>Be aware that, because Word documents are produced by so many sources, a lot of properties may not be set up, leaving it to the tool on what specifics to use. For example, is very common to keep the default font, which may mean that the font information is left empty.</p>
<h3>There's more...</h3>
<p>Further style information can be found under the font attribute, such as <kbd>small_caps</kbd> or size:</p>
<pre><code class="lang-python">&gt;&gt;&gt; run2.font.cs_italic
True
&gt;&gt;&gt; run2.font.size
152400
&gt;&gt;&gt; run2.font.small_caps</code></pre>
<p>Normally focusing on the raw text, without paying attention to the style information is the correct parsing. But sometimes a bold word in a paragraph, will have special significance. It may be the header or the result you're looking for. Because it's highlighted, it likely is what you're looking for! Keep that in mind when analysing documents.</p>
<p>You can find the whole <kbd>python-docx</kbd> documentation here:&nbsp;<a href="https://python-docx.readthedocs.io/en/latest/">https://python-docx.readthedocs.io/en/latest/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Reading text files</em> recipe</li>
<li>The <em>Reading PDF files</em> recipe</li>
</ul>
<h2>Scanning documents for a keyword</h2>
<p>In this recipe, we will join all the lessons of the previous recipes and will search the files in the directory for a particular keyword. This is a recap of the rest of the recipes in this chapter and includes a script that searches different kinds of files.</p>
<h3>Getting ready</h3>
<p>Be sure to include all the following modules in the <kbd>requirements.txt</kbd> file and install them into your virtual environment:</p>
<pre><code class="lang-python">beautifulsoup4==4.6.0
Pillow==5.1.0
PyPDF2==1.26.0
python-docx==0.8.6</code></pre>
<p>Check that the directory to search has the following files&nbsp;(all are available in GitHub in the <kbd>Chapter04/documents</kbd> directory). Note that&nbsp;<kbd>file5.pdf</kbd> and <kbd>file6.pdf</kbd> are copies of <kbd>document-1.pdf</kbd>, for simplicity. <kbd>file1.txt</kbd> to <kbd>file4.txt</kbd> are empty files:</p>
<pre><code class="lang-python">├── dir
│   ├── file1.txt
│   ├── file2.txt
│   ├── file6.pdf
│   └── subdir
│       ├── file3.txt
│       ├── file4.txt
│       └── file5.pdf
├── document-1.docx
├── document-1.pdf
├── document-2-1.pdf
├── document-2.pdf
├── example_iso.txt
├── example_output_iso.txt
├── example_utf8.txt
├── top_films.csv
└── zen_of_python.txt</code></pre>
<p>We've prepared a script,&nbsp;<kbd>scan.py</kbd>, that will search for a word in all the <kbd>.txt</kbd>, <kbd>.csv</kbd>, <kbd>.pdf</kbd>, and <kbd>.docx</kbd> files. The script is available in the <kbd>Chapter04</kbd> directory&nbsp;of the GitHub repository.</p>
<h3>How to do it...</h3>
<ol>
<li>Refer to help <kbd>-h</kbd> for how to use the&nbsp;<kbd>scan.py</kbd>&nbsp;script:</li>
</ol>
<pre><code class="lang-python">$ python scan.py -h
usage: scan.py [-h] [-w W]

optional arguments:
 -h, --help show this help message and exit
 -w W Word to search</code></pre>
<ol start="2">
<li>Search for the word <kbd>the</kbd>, which is present in most of the files:</li>
</ol>
<pre><code class="lang-python">$ python scan.py -w the
&gt;&gt;&gt; Word found in ./document-1.pdf
&gt;&gt;&gt; Word found in ./top_films.csv
&gt;&gt;&gt; Word found in ./zen_of_python.txt
&gt;&gt;&gt; Word found in ./dir/file6.pdf
&gt;&gt;&gt; Word found in ./dir/subdir/file5.pdf</code></pre>
<ol start="3">
<li>Search for the word <kbd>lorem</kbd>, only present in the PDF and docx files:</li>
</ol>
<pre><code class="lang-python">$ python scan.py -w lorem
&gt;&gt;&gt; Word found in ./document-1.docx
&gt;&gt;&gt; Word found in ./document-1.pdf
&gt;&gt;&gt; Word found in ./dir/file6.pdf
&gt;&gt;&gt; Word found in ./dir/subdir/file5.pdf</code></pre>
<ol start="4">
<li>Search for the word <kbd>20&pound;</kbd>, only present&nbsp;in the two ISO files, with different encodings:</li>
</ol>
<pre><code class="lang-python">$ python scan.py -w 20&pound;
&gt;&gt;&gt; Word found in ./example_iso.txt
&gt;&gt;&gt; Word found in ./example_output_iso.txt</code></pre>
<ol start="5">
<li>The search is case insensitive. Search for the word <kbd>BETTER</kbd>, only present in the <kbd>zen_of_python.txt</kbd> file:</li>
</ol>
<pre><code class="lang-python">$ python scan.py -w BETTER
&gt;&gt;&gt; Word found in ./zen_of_python.txt</code></pre>
<h3>How it works...</h3>
<p>The file <kbd>scan.py</kbd>&nbsp;has the following elements:</p>
<ol>
<li>An entry point that parses the input parameters and creates the help for the command line.</li>
<li>A main function that walks through the directory and analyses each of the files&nbsp;found. Based on their extension, it decides whether there's an available function to process and search it.</li>
<li>An <kbd>EXTENSION</kbd> dictionary, which pairs the extensions with the function to search them.</li>
<li>The&nbsp;<kbd>search_txt</kbd>, <kbd>search_csv</kbd>, <kbd>search_pdf</kbd>,&nbsp;and <kbd>search_docx</kbd> functions, which process and search for the required word for each kind of file.</li>
</ol>
<p>The comparison is case-insensitive, so the search word is transformed in lower case and, in all comparisons, the text is transformed into lowercase.</p>
<p>Each of the search functions have their own peculiarities:</p>
<ol>
<li><kbd>search_txt</kbd> first opens the file to determine its encoding, using <kbd>UnicodeDammit</kbd>, then it opens the file and reads it line by line. If the word is found, it stops immediately and returns success.</li>
<li><kbd>search_csv</kbd> opens the file in CSV, and iterates not only line by line, but also column by column. As soon as the word is found, it returns.</li>
<li><kbd>search_pdf</kbd> opens the file and exits if it is encrypted. It not, it goes page by page, extracting the text and comparing it with the word. It returns as soon as it finds a match.</li>
<li><kbd>search_docx</kbd> opens the file and iterates through all its paragraphs for a match. As soon as a match is found, the function returns.</li>
</ol>
<h3>There's more...</h3>
<p>There are some extra ideas that could be implemented:</p>
<ul>
<li>More search functions could be added. In this chapter, we went through log files and images.</li>
<li>A similar structure could work for searching for files and returning only the last 10.</li>
<li><kbd>search_csv</kbd> is not sniffing to detect the dialect. This could be added as well.</li>
<li>Reading is quite sequential. It should be possible to read the files in parallel, analyzing them for faster returns, but be aware that reading files in parallel can lead to sorting issues, as the files won't always be processed in the same order.</li>
</ul>
<h3>See also</h3>
<ul>
<li>The <em>Crawling and searching directories</em> recipe</li>
<li>The <em>Reading text files</em> recipe</li>
<li>The&nbsp;<em>Dealing with encodings</em>&nbsp;recipe</li>
<li>The&nbsp;<em>Reading CSV files</em>&nbsp;recipe</li>
<li>The&nbsp;<em>Reading PDF files</em>&nbsp;recipe</li>
<li>The&nbsp;<em>Reading Word documents</em> recipe</li>
</ul>

</div>

<!--Chapter 5-->

<div class="chapter" data-chapter-number="5">
<div class="chapter-start">
<div class="ch-head">Chapter <span class="chapter-number"> 5 </span></div>
<h1 class="chaptertitle">Generating Fantastic Reports</h1>
<h3 class="author">Jaime Buelta</h3>
</div>


<p>In this chapter, we will cover the following recipes:</p>
<ul>
<li>Creating a simple report in plain text</li>
<li>Using templates for reports</li>
<li>Formatting text in Markdown</li>
<li>Writing&nbsp;a basic Word document</li>
<li>Styling a Word document</li>
<li>Generating structure in Word documents</li>
<li>Adding pictures to Word documents</li>
<li>Writing a simple PDF document</li>
<li>Structuring a PDF</li>
<li>Aggregating PDF reports</li>
<li>Watermarking and encrypting a PDF</li>
</ul>
<h2>Introduction</h2>
<p>In this chapter, we'll see how to write documents and perform basic operations, such as dealing with templates in different formats, such as plain text and Markdown. We'll spend the most time with common, useful formats such as Word and PDF.</p>
<h2>Creating a simple report in plain text</h2>
<p>The most simple report is to generate some text and store it in a file.</p>
<h3>Getting ready</h3>
<p>For this recipe, we will generate a brief report in text format. The data to be stored will be in a dictionary.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>datetime</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from datetime import datetime</code></pre>
<ol start="2">
<li>Create the template with the report in text format:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; TEMPLATE = '''
Movies report
-------------

Date: {date}
Movies seen in the last 30 days: {num_movies}
Total minutes: {total_minutes}
'''</code></pre>
<ol start="3">
<li>Create a dictionary with the values to store. Note this is the data that's going to be presented in the report:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; data = {
    'date': datetime.utcnow(),
 'num_movies': 3,
    'total_minutes': 376,
}</code></pre>
<ol start="4">
<li>Compose the report, adding the data to the template:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; report = TEMPLATE.format(**data)</code></pre>
<ol start="5">
<li>Create a new file with the current date and store the report:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; FILENAME_TMPL = "{date}_report.txt"
&gt;&gt;&gt; filename = FILENAME_TMPL.format(date=data['date'].strftime('%Y-%m-%d'))
&gt;&gt;&gt; filename
2018-06-26_report.txt
&gt;&gt;&gt; with open(filename, 'w') as file:
...     file.write(report)</code></pre>
<ol start="6">
<li>Check the newly created report:</li>
</ol>
<pre><code class="lang-python">$ cat 2018-06-26_report.txt

Movies report
-------------

Date: 2018-06-26 23:40:08.737671
Movies seen in the last 30 days: 3
Total minutes: 376</code></pre>
<h3>How it works...</h3>
<p>Steps 2 and 3 in the <em>How to do it&hellip;</em> section set up a simple template and add a dictionary with all the data to be contained in the report. Then, in step 4, those two are combined into a specific report.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>In step 4, the dictionary is combined with a template. Notice that the keys on the dictionary correspond to the parameters on the template. The trick is to use the double star in the&nbsp;<kbd>format</kbd>&nbsp;call to decompress the dictionary, passing each of the keys as a parameter to <kbd>format()</kbd>.</p>
</div>
</div>
<p>In Step 5, the resulting report, a string, is stored in a newly created file, using the <kbd>with</kbd> context manager. The <kbd>open()</kbd> function creates a new file, as stated in the opening mode, <kbd>w</kbd>, and keeps it open during the block, which writes the data to the file. When exiting the block, the file is properly closed.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The open modes determine how to open a file, whether it is to read or write, and whether the file is in text or binary. The <kbd>w</kbd> mode opens the file to write it, overwriting it if it already exists. Be careful to not to delete an existing file by mistake!</p>
</div>
</div>
<p>Step 6 checks that the file has been created with the proper data.</p>
<h3>There's more...</h3>
<p>The filename is created with today's date to minimize the probability of overwriting values. The format of the date, starting with the year and ending with the day, has been selected so the files are sorted naturally in the correct order.</p>
<p>The <kbd>with</kbd> context manager will close the file even if there's an exception. It will raise an&nbsp;<kbd>IOError</kbd>&nbsp;exception if there is.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Some of the common exceptions in writing could be a problem with permissions, a full hard drive, or a path problem (for instance, trying to write in a non-existent directory).&nbsp;</p>
</div>
</div>
<p>Note that a file may not be fully committed to disk until it is closed or explicitly flushed. Generally, this is not a problem when dealing with files, but something to keep in mind if trying to open a file twice, one for read and one for write.</p>
<h3>See also</h3>
<ul>
<li>The <em>Using templates for reports</em> recipe</li>
<li>The <em>Formatting text in Markdown</em>&nbsp;recipe</li>
<li>The <em>Aggregating PDF reports</em>&nbsp;recipe</li>
</ul>
<h2>Using templates for reports</h2>
<p>HTML is a very flexible format that can be used to present rich reports. While an HTML template can be created by treating it as just text, there are tools that allow you to add better handling of structured text. This detaches the template from the code as well, separating the generation of the data from the representation of that data.</p>
<h3>Getting ready</h3>
<p>The tool used in this recipe, Jinja2, reads a file that contains the template and applies the context to it. The context contains the data to be displayed.</p>
<p>We should start by installing the module:</p>
<pre><code class="lang-python">$ echo "jinja2==2.20" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>Jinja2 uses its own syntax, which is a mixture of HTML and Python. It is aimed at HTML documents so it easily performs operations such as correctly escaping special characters.</p>
<p>In the GitHub repository, we've included a template file called <kbd>jinja_template.html</kbd> with the template to use.</p>
<h3>How to do it...</h3>
<ol>
<li>Import Jinja2 <kbd>Template</kbd> and <kbd>datetime</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from jinja2 import Template
&gt;&gt;&gt; from datetime import datetime</code></pre>
<ol start="2">
<li>Read the template from the files into memory:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('jinja_template.html') as file:
...     template = Template(file.read())</code></pre>
<ol start="3">
<li>Create a context with the data to be displayed:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; context = {
    'date': datetime.now(),
    'movies': ['Casablanca', 'The Sound of Music', 'Vertigo'],
    'total_minutes': 404,
}</code></pre>
<ol start="4">
<li>Render the template and write a new file, <kbd>report.html</kbd>, with the following result:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('report.html', 'w') as file:
...    file.write(template.render(context))</code></pre>
<ol start="5">
<li>Open the <kbd>report.html</kbd> file in a browser:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000016.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>Steps 2 and 4 in the <em>How to do it&hellip;</em> section are very straightforward: they read the template and&nbsp;&nbsp;save the resulting report.</p>
<p>As seen in Steps 3 and 4, the main task is to create a context dictionary with the information to be displayed. The template then renders that information, as shown in step 5. Let's take a look at <kbd>jinja_template.html</kbd>:</p>
<pre><code class="lang-python">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;title&gt; Movies Report&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Movies Report&lt;/h1&gt;
    &lt;p&gt;Date {{date}}&lt;/p&gt;
    &lt;p&gt;Movies seen in the last 30 days: {{movies|length}}&lt;/p&gt;
    &lt;ol&gt;
        {% for movie in movies %}
        &lt;li&gt;{{movie}}&lt;/li&gt;
        {% endfor %}
    &lt;/ol&gt;
    &lt;p&gt;Total minutes: {{total_minutes}} &lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>Most of it is replacing the context values as defined between curly brackets, such as <kbd>{{total_minutes}}</kbd>.&nbsp;</p>
<p>Note the tag, <kbd>{% for ... %} / {% endfor %}</kbd>, which defines a loop. That allows a very Python-based assignment to generate multiple rows or elements.</p>
<p>Filters can be applied to the variables to modify them. In this case, the <kbd>length</kbd> filter is applied to the <kbd>movies</kbd> list to obtain the size using the pipe symbol, as shown in&nbsp;<kbd>{{movies|length}}</kbd>.</p>
<h3>There's more...</h3>
<p>Other than the <kbd>{% for %}</kbd> tag, there's an <kbd>{% if %}</kbd> tag, allowing it to display conditionally:</p>
<pre><code class="lang-python">{% if movies|length &gt; 5 %}
  Wow, so many movies this month!
{% else %}
  Regular number of movies
{% endif %}</code></pre>
<p>There are a good number of defined filters already (see the whole list here: <a href="http://jinja.pocoo.org/docs/2.10/templates/#list-of-builtin-filters">http://jinja.pocoo.org/docs/2.10/templates/#list-of-builtin-filters</a>). But, it is also possible to define custom ones.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Note that you can add a lot of processing and logic to the template using filters. While a little bit is fine, try to limit the amount of logic in the template. Most of the calculations for data to be displayed should be done before, leaving the template to just display values. This makes the context very straightforward and simplifies the template, allowing for changes.</p>
</div>
</div>
<p>When dealing with HTML files, it is good to auto-escape the variables. This means that characters with meaning, for example, the <kbd>&lt;</kbd> character, will be replaced by the equivalent HTML code to be properly displayed on an HTML page. To do so, create the template with the <kbd>autoescape</kbd> parameter. Check the difference here:</p>
<pre><code class="lang-python">&gt;&gt;&gt; Template('{{variable}}', autoescape=False).render({'variable': '&lt;'})
'&lt;'
&gt;&gt;&gt; Template('{{variable}}', autoescape=True).render({'variable': '&lt;'})
'&lt;'</code></pre>
<p>Escaping can be applied on each variable with the <kbd>e</kbd> filter (meaning <em>escape</em>) and unapplied with the <kbd>safe</kbd> filter (meaning <em>it is safe to render as it is</em>).</p>
<p>Jinja2 templates are extensible, meaning that you can create a <kbd>base_template.html</kbd> and then extend it, changing some of the elements. You can include other files as well, partitioning and separating different sections. See the full documentation for further details.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Jinja2 is very powerful and allows us to create complex HTML templates, and also in other formats such as LaTeX or JavaScript, though this requires configuring. I encourage you to read the whole documentation and have a look at all its capabilities!&nbsp;</p>
</div>
</div>
<p>The whole Jinja2 documentation can be found here:&nbsp;<a href="http://jinja.pocoo.org/docs/2.10/">http://jinja.pocoo.org/docs/2.10/.</a></p>
<h3>See also</h3>
<ul>
<li>The <em>Creating a simple report in plain text</em> recipe</li>
<li>The <em>Formatting text in Markdown</em> recipe</li>
</ul>
<h2>Formatting text in Markdown</h2>
<p><strong>Markdown</strong> is a very popular markup language&nbsp;used to create raw text that can be converted into styled HTML. It is a good way of structuring documents in a way that is readable in raw text format, while being able to&nbsp;properly style them in HTML.&nbsp;</p>
<p>In this recipe, we'll see how to transform a Markdown document into styled HTML using Python.</p>
<h3>Getting ready</h3>
<p>We should start by installing the <kbd>mistune</kbd> module, which will compile Markdown documents into HTML:</p>
<pre><code class="lang-python">$ echo "mistune==0.8.3" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>In the GitHub repository, there is a template file called&nbsp;<kbd>markdown_template.md</kbd>&nbsp;with a template of the report to generate.&nbsp;</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>mistune</kbd>&nbsp;and <kbd>datetime</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import mistune</code></pre>
<ol start="2">
<li>Read the template from the file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('markdown_template.md') as file:
...     template = file.read()</code></pre>
<ol start="3">
<li>Set up the context of the data to be included in the report:</li>
</ol>
<pre><code class="lang-python">context = {
    'date': datetime.now(),
    'pmovies': ['Casablanca', 'The Sound of Music', 'Vertigo'],
    'total_minutes': 404,
}</code></pre>
<ol start="4">
<li>As movies need to be displayed as bullet points, we transform the list into a suitable Markdown bullet list. Also, we store the number of movies:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; context['num_movies'] = len(context['pmovies'])
&gt;&gt;&gt; context['movies'] = '\n'.join('* {}'.format(movie) for movie in context['pmovies'])</code></pre>
<ol start="5">
<li>Render the template and compile the resulting Markdown into HTML:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; md_report = template.format(**context)
&gt;&gt;&gt; report = mistune.markdown(md_report)</code></pre>
<ol start="6">
<li>Finally, store the resulting report in the <kbd>report.html</kbd> file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('report.html', 'w') as file:
...    file.write(report)</code></pre>
<ol start="7">
<li>Open the <kbd>report.html</kbd> file in a browser to check the result:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000001.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>Steps 2 and 3 in the <em>How do it&hellip;</em> section prepare the template and the data to be displayed. In Step 4, extra information is produced&mdash;the number of movies, which is derivative from the <kbd>movies</kbd> element. The <kbd>movies</kbd> element is then transformed into a valid Markdown element from a Python list. Note the new lines and the initial <kbd>*</kbd>, which will be rendered as a bullet point:</p>
<pre><code class="lang-python">&gt;&gt;&gt; '\n'.join('* {}'.format(movie) for movie in context['pmovies'])
'* Casablanca\n* The Sound of Music\n* Vertigo'</code></pre>
<p>In Step 5, the template is generated in Markdown format. The format is very readable in this raw form, which is the strong point of Markdown:</p>
<pre><code class="lang-python">Movies Report
=======

Date: 2018-06-29 20:47:18.930655

Movies seen in the last 30 days: 3

* Casablanca
* The Sound of Music
* Vertigo

Total minutes: 404</code></pre>
<p>Then, using&nbsp;<kbd>mistune</kbd>, the report is transformed into HTML and stored in a file in Step 6.</p>
<h3>There's more...</h3>
<p>Learning Markdown is extremely useful, as it is supported by many common web pages as a way of enabling text input that is easy and can render to a styled format. Some examples are GitHub, Stack Overflow, and most blogging platforms.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>There is actually more than one kind of Markdown. This is because the official definition was limited or ambiguous, and there was no interest in clarifying or standardizing it. This led to several implementations that are sightly different, such as GitHub Flavoured Markdown, MultiMarkdown, and CommonMark.</p>
</div>
</div>
<p>The text in Markdown is quite readable, but in case you need to interactively see how it will look, you can use the Dillinger online editor at <a href="https://dillinger.io/">https://dillinger.io/</a>.</p>
<p><kbd>Mistune</kbd> full docs are available here:&nbsp;<a href="http://mistune.readthedocs.io/en/latest/">http://mistune.readthedocs.io/en/latest/.</a></p>
<p>The full Markdown syntax can be found at <a href="https://daringfireball.net/projects/markdown/syntax">https://daringfireball.net/projects/markdown/syntax</a>, and a good cheat sheet with the most-used elements at <a href="https://beegit.com/markdown-cheat-sheet">https://beegit.com/markdown-cheat-sheet.</a></p>
<h3>See also</h3>
<ul>
<li>The <em>Creating a simple report in pain text</em> recipe</li>
<li>The <em>Using templates for reports</em> recipe</li>
</ul>
<h2>Writing a basic Word document</h2>
<p>Microsoft Office is one of the most common pieces of software, and MS Word in particular is almost a de facto standard for documents. Generating <kbd>docx</kbd> documents is possible with an automated script, which will help distribute reports in a format that's easily readable in many business.</p>
<p>In this recipe, we will learn how to generate a full Word document.</p>
<h3>Getting ready</h3>
<p>We'll use the <kbd>python-docx</kbd> module to process Word documents:</p>
<pre><code class="lang-python">&gt;&gt;&gt; echo "python-docx==0.8.6" &gt;&gt; requirements.txt
&gt;&gt;&gt; pip install -r requirements.txt</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>python-docx</kbd> and <kbd>datetime</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import docx
&gt;&gt;&gt; from datetime import datetime</code></pre>
<ol start="2">
<li>Define the <kbd>context</kbd> with the data to be stored in the report:</li>
</ol>
<pre><code class="lang-python">context = {
    'date': datetime.now(),
    'movies': ['Casablanca', 'The Sound of Music', 'Vertigo'],
    'total_minutes': 404,
}</code></pre>
<ol start="3">
<li>Create a new <kbd>docx</kbd> document, and include a heading,&nbsp;<kbd>Movies Report</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document = docx.Document()
&gt;&gt;&gt; document.add_heading('Movies Report', 0)</code></pre>
<ol start="4">
<li>Add a paragraph describing the date, with the date in italics:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; paragraph = document.add_paragraph('Date: ')
&gt;&gt;&gt; paragraph.add_run(str(context['date'])).italic = True</code></pre>
<ol start="5">
<li>Add information about the number of movies seen in a different paragraph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; paragraph = document.add_paragraph('Movies see in the last 30 days: ')
&gt;&gt;&gt; paragraph.add_run(str(len(context['movies']))).italic = True</code></pre>
<ol start="6">
<li>Add each of the movies as a bullet point:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; for movie in context['movies']:
...     document.add_paragraph(movie, style='List Bullet')</code></pre>
<ol start="7">
<li>Add the total minutes and save the file as follows:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; paragraph = document.add_paragraph('Total minutes: ')
&gt;&gt;&gt; paragraph.add_run(str(context['total_minutes'])).italic = True
&gt;&gt;&gt; document.save('word-report.docx')</code></pre>
<ol start="8">
<li>Open the <kbd>word-report.docx</kbd> file to check it:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000044.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>The basics of a Word document is that it is divided in to paragraphs, and each of the paragraphs is divided in to runs. A run is a part of a paragraph that shares the same style.</p>
<p>Steps 1 and 2 in the <em>How to do it&hellip;</em> section are preparation for importing and defining the data that's going to be stored in the report.</p>
<p>In Step 3, the document is created and a heading with the proper title is added. This automatically styles the text.</p>
<p>Dealing with paragraphs is introduced in Step 4. A new paragraph is created based on the introduced text with the default style, but new runs can be added to change it. Here, we added the first run with the text <kbd>Date:</kbd>, and then another run is added with the specific time and labelled as <em>italic</em>.</p>
<p>In Steps 5 and 6, we see information about the movies. The first part stores the number of movies, in a similar way to Step 4. After that, the movies are added to the report one by one, and the style is set up like bullet points.</p>
<p>Finally, Step 7 stores the total run time of all movies, in a similar way to Step 4, and stores the document in a file.</p>
<h3>There's more...</h3>
<p>If you need to introduce extra lines in the document for formatting purposes, add empty paragraphs.&nbsp;</p>
<p>Due to the way that the MS Word format works, there's no easy way of determining how many pages is going to have. You may need to run some tests on sizes, especially if you're generating the text to store dynamically.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Even if you generate <kbd>docx</kbd> files, having MS Office is not necessary. There are other applications that can open and deal with these files, including free alternatives such as LibreOffice.</p>
</div>
</div>
<p>The whole <kbd>python-docx</kbd> documentation is available here: <a href="https://python-docx.readthedocs.io/en/latest/">https://python-docx.readthedocs.io/en/latest/.</a></p>
<h3>See also</h3>
<ul>
<li>The <em>Styling a Word document</em> recipe</li>
<li>The <em>Generating structure in Word documents</em> recipe</li>
</ul>
<h2>Styling a Word document</h2>
<p>A Word document can be very plain, but we can also add styling to help properly understand the displayed data. Word has a set of predefined styles that can be used to variate the document and highlight the important parts of it.</p>
<h3>Getting ready</h3>
<p>We'll use the <kbd>python-docx</kbd> module to process Word documents:</p>
<pre><code class="lang-python">&gt;&gt;&gt; echo "python-docx==0.8.6" &gt;&gt; requirements.txt
&gt;&gt;&gt; pip install -r requirements.txt</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>python-docx</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import docx</code></pre>
<ol start="2">
<li>Create a new document:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document = docx.Document()</code></pre>
<ol start="3">
<li>Add a paragraph that highlights some words in different ways,&nbsp;<em>Italics</em>, <strong>bold,</strong> and underline:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; p = document.add_paragraph('This shows different kinds of emphasis: ')
&gt;&gt;&gt; p.add_run('bold').bold = True
&gt;&gt;&gt; p.add_run(', ')
&lt;docx.text.run.Run object at ...&gt;
&gt;&gt;&gt; p.add_run('italics').italic = True
&gt;&gt;&gt; p.add_run(' and ')
&lt;docx.text.run.Run object at ...&gt;
&gt;&gt;&gt; p.add_run('underline').underline = True
&gt;&gt;&gt; p.add_run('.')
&lt;docx.text.run.Run object at ...&gt;</code></pre>
<ol start="4">
<li>Create some paragraphs, styling them with default styles, such as <kbd>List Bullet</kbd>, <kbd>List Number</kbd>,&nbsp; or <kbd>Quote</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.add_paragraph('a few', style='List Bullet')
&lt;docx.text.paragraph.Paragraph object at ...&gt;
&gt;&gt;&gt; document.add_paragraph('bullet', style='List Bullet')
&lt;docx.text.paragraph.Paragraph object at ...&gt;
&gt;&gt;&gt; document.add_paragraph('points', style='List Bullet')
&lt;docx.text.paragraph.Paragraph object at ...&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; document.add_paragraph('Or numbered', style='List Number')
&lt;docx.text.paragraph.Paragraph object at ...&gt;
&gt;&gt;&gt; document.add_paragraph('that will', style='List Number')
&lt;docx.text.paragraph.Paragraph object at ...&gt;
&gt;&gt;&gt; document.add_paragraph('that keep', style='List Number')
&lt;docx.text.paragraph.Paragraph object at ...&gt;
&gt;&gt;&gt; document.add_paragraph('count', style='List Number')
&lt;docx.text.paragraph.Paragraph object at ...&gt;
&gt;&gt;&gt; 
&gt;&gt;&gt; document.add_paragraph('And finish with a quote', style='Quote')
&lt;docx.text.paragraph.Paragraph object at 0x10d2336d8&gt;</code></pre>
<ol start="5">
<li>Create a paragraph in a different font and size. We'll use <kbd>Arial</kbd>&nbsp;font and a point size of <kbd>25</kbd>. The paragraph will be aligned to the right:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from docx.shared import Pt
&gt;&gt;&gt; from docx.enum.text import WD_ALIGN_PARAGRAPH
&gt;&gt;&gt; p = document.add_paragraph('This paragraph will have a manual styling and right alignment')
&gt;&gt;&gt; p.runs[0].font.name = 'Arial'
&gt;&gt;&gt; p.runs[0].font.size = Pt(25)
&gt;&gt;&gt; p.alignment = WD_ALIGN_PARAGRAPH.RIGHT</code></pre>
<ol start="6">
<li>Save the document:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.save('word-report-style.docx')</code></pre>
<ol start="7">
<li>Open the <kbd>word-report-style.docx</kbd> document to verify its content:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000067.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>After creating the document in Step 1, Step 2 from the <em>How to do it&hellip;</em> section adds a paragraph that has several runs. In Word, a paragraph can contain multiple runs, which are parts that can have different styles. In general, any format change related to individual words will be applied to a run, while a change that affects paragraphs will be applied to the paragraph.</p>
<p>Each of the runs are created, by default, with the <kbd>Normal</kbd> style. Any attribute of&nbsp;<kbd>.bold</kbd>, <kbd>.italic</kbd>, or <kbd>.underline</kbd> can be changed to <kbd>True</kbd> to set up if the run should be in a proper style or a combination. A value of <kbd>False</kbd> will deactivate it, while a <kbd>None</kbd> value will leave it as the default.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Note that the proper word in this protocol is <em>italic</em>, and not <em>italics</em>. Setting the property to italics won't have any effect, but won't display an error either.&nbsp;</p>
</div>
</div>
<p>Step 4 shows how to apply some of the default styles for paragraphs, in this case to show bullet points, numbered lists, and quotes. There are more styles, and they can be checked in this page of the documentation:&nbsp;<a href="https://python-docx.readthedocs.io/en/latest/user/styles-understanding.html?highlight=List%20Bullet#paragraph-styles-in-default-template">https://python-docx.readthedocs.io/en/latest/user/styles-understanding.html?highlight=List%20Bullet#paragraph-styles-in-default-template</a>. Try to find out which ones work best for your document.</p>
<p>The <kbd>.font</kbd> property of a run is shown in Step 5. This allows you to manually set up a specific font and size. Note that the size needs to be specified using the proper <kbd>Pt</kbd> (points) object.</p>
<p>The alignment of the paragraph is set up in the <kbd>paragraph</kbd> object, and uses a constant to define whether it is left, right, center, or justified. All alignment options can be found here:&nbsp;<a href="https://python-docx.readthedocs.io/en/latest/api/enum/WdAlignParagraph.html">https://python-docx.readthedocs.io/en/latest/api/enum/WdAlignParagraph.html.</a></p>
<p>Finally, step 7 saves the file so it's stored in the file system.</p>
<h3>There's more...</h3>
<p>The <kbd>font</kbd> attribute can also be used to set up more properties of the text, such as small caps, shadow, emboss, or strikethrough. The whole range of possibilities is shown here:&nbsp;<a href="https://python-docx.readthedocs.io/en/latest/api/text.html#docx.text.run.Font">https://python-docx.readthedocs.io/en/latest/api/text.html#docx.text.run.Font.</a></p>
<p>Another available option is to change the color of the text. Note the run can be any of the previously generated runs:</p>
<pre><code class="lang-python">&gt;&gt;&gt; from docx.shared import RGBColor
&gt;&gt;&gt; DARK_BLUE = RGBColor.from_string('1b3866')
&gt;&gt;&gt; run.font.color.rbg = DARK_BLUE</code></pre>
<p>The color can be described in the usual hex format from a string. Try to define all the colors to use to ensure they are all consistent, and limit yourself to a maximum of three colors in a report to not overcharge it.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>You can use an online color picker, such as this one: <a href="https://www.w3schools.com/colors/colors_picker.asp">https://www.w3schools.com/colors/colors_picker.asp</a>. Remember to not use the # at the beginning. If you need to generate a palette, it's a good idea to use tools such as&nbsp;<a href="https://coolors.co/">https://coolors.co/</a>&nbsp;to generate good combinations.</p>
</div>
</div>
<p>The whole&nbsp;<kbd>python-docx</kbd>&nbsp;documentation is available here:&nbsp;<a href="https://python-docx.readthedocs.io/en/latest/">https://python-docx.readthedocs.io/en/latest/.</a></p>
<h3>See also</h3>
<ul>
<li>The <em>Writing a basic Word document</em> recipe</li>
<li>The <em>Generating structure in Word documents</em> recipe</li>
</ul>
<h2>Generating structure in Word documents</h2>
<p>To create proper professional reports, they need to have the proper structure. An MS Word document doesn't have the concept of <em>a page</em>, as it works in paragraphs, but we can introduce breaks and sections to properly divide a document.</p>
<p>We'll see in this recipe how to create a structured Word document.</p>
<h3>Getting ready</h3>
<p>We'll use the <kbd>python-docx</kbd> module to process Word documents:</p>
<pre><code class="lang-python">&gt;&gt;&gt; echo "python-docx==0.8.6" &gt;&gt; requirements.txt
&gt;&gt;&gt; pip install -r requirements.txt</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>python-docx</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import docx</code></pre>
<ol start="2">
<li>Create a new document:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document = docx.Document()</code></pre>
<ol start="3">
<li>Create a paragraph that has a line break:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; p = document.add_paragraph('This is the start of the paragraph')
&gt;&gt;&gt; run = p.add_run()
&gt;&gt;&gt; run.add_break(docx.text.run.WD_BREAK.LINE)
&gt;&gt;&gt; p.add_run('And now this in a different line')
&gt;&gt;&gt; p.add_run(". Even if it's on the same paragraph.")</code></pre>
<ol start="4">
<li>Create a page break and write a paragraph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.add_page_break()
&gt;&gt;&gt; document.add_paragraph('This appears in a new page')</code></pre>
<ol start="5">
<li>Create a new section, which will be on landscape pages:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; section = document.add_section( docx.enum.section.WD_SECTION.NEW_PAGE)
&gt;&gt;&gt; section.orientation = docx.enum.section.WD_ORIENT.LANDSCAPE
&gt;&gt;&gt; section.page_height, section.page_width = section.page_width, section.page_height
&gt;&gt;&gt; document.add_paragraph('This is part of a new landscape section')</code></pre>
<ol start="6">
<li>Create another section, reverting to portrait orientation:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; section = document.add_section( docx.enum.section.WD_SECTION.NEW_PAGE)
&gt;&gt;&gt; section.orientation = docx.enum.section.WD_ORIENT.PORTRAIT
&gt;&gt;&gt; section.page_height, section.page_width = section.page_width, section.page_height
&gt;&gt;&gt; document.add_paragraph('In this section, recover the portrait orientation')</code></pre>
<ol start="7">
<li>Save the document:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.save('word-report-structure.docx')</code></pre>
<ol start="8">
<li>Check the result by&nbsp;opening the document and checking the resulting sections:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000062.png" class="lazyload" /></p>
<p>Check the new page:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000057.png" class="lazyload" /></p>
<p>Check for a landscape section:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000028.png" class="lazyload" /></p>
<p>Then, go back to portrait orientation:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000047.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>After creating the document in Step 2 in the <em>How to do it&hellip;</em> section, we add a paragraph for the first section. Notice that the document starts with a section. The paragraph introduces a line break in the middle of the paragraph.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>There is a small difference between a line break in a paragraph and a new paragraph, though for most uses it is quite similar. Try to experiment with them.</p>
</div>
</div>
<p>A page break is introduced in Step 3, without changing the section.</p>
<p>Step 4 creates a new section on a new page. Step 5 also changes the orientation of the page to landscape. In Step 6, a new section is introduced and the orientation reverts to portrait.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Note that when changing the orientation, we also need to swap the width and height. Each new section inherits the properties from the previous one, so this swapping needs to happen in Step 6 as well.</p>
</div>
</div>
<p>Finally, the document is saved in Step 6.</p>
<h3>There's more...</h3>
<p>A section mandates page composition, including the orientation and size of the page. The size of the page can be changed using the length options, such as <kbd>Inches</kbd> or <kbd>Cm</kbd>:</p>
<pre><code class="lang-python">&gt;&gt;&gt; from docx.shared import Inches, Cm 
&gt;&gt;&gt; section.page_height = Inches(10)
&gt;&gt;&gt; section.page_width = Cm(20)</code></pre>
<p>The page margins can also be defined in the same way:</p>
<pre><code class="lang-python">&gt;&gt;&gt; section.left_margin = Inches(1.5)
&gt;&gt;&gt; section.right_margin = Cm(2.81)
&gt;&gt;&gt; section.top_margin = Inches(1)
&gt;&gt;&gt; section.bottom_margin = Cm(2.54)</code></pre>
<p>Sections can also be forced to start not only on the next page, but on the next odd page, which will look better when printing on two sides:</p>
<pre><code class="lang-python">&gt;&gt;&gt; document.add_section( docx.enum.section.WD_SECTION.ODD_PAGE)</code></pre>
<p>The whole&nbsp;<kbd>python-docx</kbd>&nbsp;documentation is available here:&nbsp;<a href="https://python-docx.readthedocs.io/en/latest/">https://python-docx.readthedocs.io/en/latest/.</a></p>
<h3>See also</h3>
<ul>
<li>The <em>Writing a basic Word document</em> recipe</li>
<li>The <em>Styling a Word document</em> recipe</li>
</ul>
<h2>Adding pictures to Word documents</h2>
<p>Word documents are capable of adding images to show graphs or any other kind of extra information. Being able to add an image is a great way of creating rich reports.</p>
<p>We'll see in this recipe how to include an existing file in a Word document.</p>
<h3>Getting ready</h3>
<p>We'll use the <kbd>python-docx</kbd> module to process Word documents:</p>
<pre><code class="lang-python">$ echo "python-docx==0.8.6" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>We need to prepare an image to include in the document. We'll use the file&nbsp;in GitHub at <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/images/photo-dublin-a1.jpg">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/images/photo-dublin-a1.jpg</a>, which shows a view of Dublin. You can download it on the command line, like this:</p>
<pre><code class="lang-python">$ wget https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter04/images/photo-dublin-a1.jpg</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>python-docx</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import docx</code></pre>
<ol start="2">
<li>Create a new document:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document = docx.Document()</code></pre>
<ol start="3">
<li>Create a paragraph with some text:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.add_paragraph('This is a document that includes a picture taken in Dublin')</code></pre>
<ol start="4">
<li>Add the image:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; image = document.add_picture('photo-dublin-a1.jpg')</code></pre>
<ol start="5">
<li>Scale the image properly to fit on the page (<em>14&nbsp;x 10</em>):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from docx.shared import Cm
&gt;&gt;&gt; image.width = Cm(14)
&gt;&gt;&gt; image.height = Cm(10)</code></pre>
<ol start="6">
<li>The image has been added to a new paragraph. Align it to the center and add descriptive text:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; paragraph = document.paragraphs[-1]
&gt;&gt;&gt; from docx.enum.text import WD_ALIGN_PARAGRAPH
&gt;&gt;&gt; paragraph.alignment = WD_ALIGN_PARAGRAPH.CENTER
&gt;&gt;&gt; paragraph.add_run().add_break()
&gt;&gt;&gt; paragraph.add_run('A picture of Dublin')</code></pre>
<ol start="7">
<li>Add a new paragraph with extra text, and save the document:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.add_paragraph('Keep adding text after the image')
&lt;docx.text.paragraph.Paragraph object at XXX&gt;
&gt;&gt;&gt; document.save('report.docx')</code></pre>
<ol start="8">
<li>Check the result:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000058.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>The first few steps (Step 1 to Step 3 in the <em>How to do it&hellip;</em> section) create the document and add some text.</p>
<p>Step 4 adds the image from the file, and Step 5 resizes it into a manageable size. By default, the image is too big.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Keep in mind the proportion of the image when resizing. Note that you can also use other measures such as <kbd>Inch</kbd>, defined in <kbd>shared</kbd> as well.</p>
</div>
</div>
<p>Inserting the image creates a new paragraph as well, so the paragraph can be styled to align the image or to add more text, such as a reference or description. The paragraph is obtained in Step 6 through the <kbd>document.paragraph</kbd> property. The last paragraph is obtained and styled properly, aligning it to the center. A new line and a <kbd>run</kbd> with descriptive text are added.</p>
<p>Step 7 adds extra text after the image and saves the document.</p>
<h3>There's more...</h3>
<p>The size of the image can be changed, but as we saw before, the proportion of the image needs to be calculated if that changes. The resizing may end up not being perfect if done by approximation, as in Step 5 from the <em>How to do it&hellip;</em> section.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Notice that the image does not have a perfect ratio of 10:14. It should instead be 10:13.33. For an image, that may be good enough, but for data that is more sensitive&nbsp;to proportion changes, such as a chart, it may require extra care.</p>
</div>
</div>
<p>To obtain the proper relation, divide the height by the width and then scale properly:</p>
<pre><code class="lang-python">&gt;&gt;&gt; image = document.add_picture('photo-dublin-a1.jpg')
&gt;&gt;&gt; image.height / image.width
0.75
&gt;&gt;&gt; RELATION = image.height / image.width
&gt;&gt;&gt; image.width = Cm(12)
&gt;&gt;&gt; image.height = Cm(12 * RELATION)</code></pre>
<p>If you need to transform the values to a particular size, you can use the <kbd>cm</kbd>, <kbd>inches</kbd>, <kbd>mm</kbd>, or <kbd>pt</kbd> attributes:</p>
<pre><code class="lang-python">&gt;&gt;&gt; image.width.cm
12.0
&gt;&gt;&gt; image.width.mm
120.0
&gt;&gt;&gt; image.width.inches
4.724409448818897
&gt;&gt;&gt; image.width.pt
340.15748031496065</code></pre>
<p>The whole&nbsp;<kbd>python-docx</kbd>&nbsp;documentation is available here:&nbsp;<a href="https://python-docx.readthedocs.io/en/latest/">https://python-docx.readthedocs.io/en/latest/.</a></p>
<h3>See also</h3>
<ul>
<li>The <em>Writing a basic Word document</em> recipe</li>
<li>The <em>Styling a Word document</em> recipe</li>
<li>The <em>Generating structure in Word documents</em> recipe</li>
</ul>
<h2>Writing a simple PDF document</h2>
<p>PDF files are a common way of sharing reports. The main characteristic of PDF documents is that they define exactly how the document is going to look, and they are read-only after being produced, which makes them very straightforward to share.</p>
<p>In this recipe, we'll see how to write a simple PDF report using Python.</p>
<h3>Getting ready</h3>
<p>We'll use the <kbd>fpdf</kbd> module to create PDF documents:</p>
<pre><code class="lang-python">&gt;&gt;&gt; echo "fpdf==1.7.2" &gt;&gt; requirements.txt
&gt;&gt;&gt; pip install -r requirements.txt</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>fpdf</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import fpdf</code></pre>
<ol start="2">
<li>Create a document:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document = fpdf.FPDF()</code></pre>
<ol start="3">
<li>Define the font and color for a title, and add the first page:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.set_font('Times', 'B', 14)
&gt;&gt;&gt; document.set_text_color(19, 83, 173)
&gt;&gt;&gt; document.add_page()</code></pre>
<ol start="4">
<li>Write the title of the document:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.cell(0, 5, 'PDF test document')
&gt;&gt;&gt; document.ln()</code></pre>
<ol start="5">
<li>Write a long paragraph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.set_font('Times', '', 12)
&gt;&gt;&gt; document.set_text_color(0)
&gt;&gt;&gt; document.multi_cell(0, 5, 'This is an example of a long paragraph. ' * 10)
[]
&gt;&gt;&gt; document.ln()</code></pre>
<ol start="6">
<li>Write another long paragraph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.multi_cell(0, 5, 'Another long paragraph. Lorem ipsum dolor sit amet, consectetur adipiscing elit.' * 20)
</code></pre>
<ol start="7">
<li>Save the document:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; document.output('report.pdf')</code></pre>
<ol start="8">
<li>Check the&nbsp;<kbd>report.pdf</kbd> document:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000035.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>The <kbd>fpdf</kbd> module creates a PDF document and allows us to write in it.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Due to the peculiarities of a PDF, the best way to think about it is to imagine a cursor writing in the document and moving to the next position, similar to a typewriter.</p>
</div>
</div>
<p>The first operations are to specify the font and size to use, and then add the first page. This is done in Step 3. The first font is in bold (second argument,&nbsp;<kbd>'B'</kbd>) and in a bigger font than the rest of the document to serve as a title.&nbsp;The color is also set up with <kbd>.set_text_color</kbd>, in RGB components.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The text can also be styled in italics with <kbd>I</kbd> and underlined with <kbd>U</kbd>. You can combine them, so <kbd>BI</kbd> will produce text in bold and italic.</p>
</div>
</div>
<p>The&nbsp;<kbd>.cell</kbd> call creates a box of text with the specified text. The first couple of parameters are the width and height. Width <kbd>0</kbd> uses the whole space up to the right margin. Height <kbd>5</kbd> (mm) is&nbsp;adequate&nbsp;for a size <kbd>12</kbd> font. The call to <kbd>.ln</kbd> introduces a new line.</p>
<p>To write a multiline paragraph, we use the <kbd>.multi_cell</kbd> method. Its parameters are the same as&nbsp;<kbd>.cell</kbd>. Two paragraphs are written in Steps 5 and 6. Notice the change in font before, to distinguish the title from the body of the report. The <kbd>.set_text_color</kbd> is called with a single argument to set up the color in grayscale. In this case, it is in black.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Using <kbd>.cell</kbd> for long text will make it go over the margin and off the page. Use it only for text that will fit in a single line. You can find the size of a string with <kbd>.get_string_width</kbd>.</p>
</div>
</div>
<p>The document is saved to disk in Step 7.</p>
<h3>There's more...</h3>
<p>Pages are added automatically is a <kbd>multi_cell</kbd> operation occupies all space available in a page. Calling <kbd>.add_page</kbd> will move to a new page.</p>
<p>You can use any of the default fonts (<kbd>Courier</kbd>, <kbd>Helvetica</kbd>, and&nbsp;&nbsp;<kbd>Times</kbd>), or add an extra font using <kbd>.add_font</kbd>. Check the documentation for more details:&nbsp;<a href="http://pyfpdf.readthedocs.io/en/latest/reference/add_font/index.html">http://pyfpdf.readthedocs.io/en/latest/reference/add_font/index.html.</a></p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The fonts <kbd>Symbol</kbd> and&nbsp;<kbd>ZapfDingbats</kbd> are also available, but are to be used with symbols. This could be useful if you need some extra symbols, but test before using them. The rest of the default fonts should include your&nbsp;necessities for serif, sans serif, and fixed-width cases. In PDFs, fonts used will be embedded in the document, so they'll be displayed properly.</p>
</div>
</div>
<p>Keep the height consistent through&nbsp;out the document, at least between text of the same size. Define a constant you're comfortable with, and use it through out the text:</p>
<pre><code class="lang-python">&gt;&gt;&gt; BODY_TEXT_HEIGHT = 5
&gt;&gt;&gt; document.multi_cell(0, BODY_TEXT_HEIGHT, text)</code></pre>
<p>By default, the text will be justified, but that can be changed. Use the align argument with <kbd>J</kbd> (justified), <kbd>C</kbd> (center), <kbd>R</kbd>&nbsp;(right), or <kbd>L</kbd> (left). For example, this produces text aligned to the left:</p>
<pre><code class="lang-python">&gt;&gt;&gt; document.multi_cell(0, BODY_TEXT_HEIGHT, text, align='L')</code></pre>
<p>The full FPDF documentation can be found here:&nbsp;<a href="http://pyfpdf.readthedocs.io/en/latest/index.html">http://pyfpdf.readthedocs.io/en/latest/index.html.</a></p>
<h3>See also</h3>
<ul>
<li><em>Structuring a PDF</em></li>
<li><em>Aggregating PDF reports</em></li>
<li><em>Watermarking and encrypting a PDF</em></li>
</ul>
<h2>Structuring a PDF</h2>
<p>Some elements can be automatically generated when creating a PDF to add a better look and structure to your elements. In this recipe, we'll see how to add a header and footer, and how to create links to other elements.</p>
<h3>Getting ready</h3>
<p>We'll use the <kbd>fpdf</kbd> module to create PDF documents:</p>
<pre><code class="lang-python">&gt;&gt;&gt; echo "fpdf==1.7.2" &gt;&gt; requirements.txt
&gt;&gt;&gt; pip install -r requirements.txt</code></pre>
<h3>How to do it...</h3>
<ol>
<li>The <kbd>structuring_pdf.py</kbd> script is available in GitHub here: <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter05/structuring_pdf.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter05/structuring_pdf.py</a>. The most relevant bits are displayed here:</li>
</ol>
<pre><code class="lang-python">import fpdf
from random import randint

class StructuredPDF(fpdf.FPDF):
    LINE_HEIGHT = 5

    def footer(self):
        self.set_y(-15)
        self.set_font('Times', 'I', 8)
        page_number = 'Page {number}/{{nb}}'.format(number=self.page_no())
        self.cell(0, self.LINE_HEIGHT, page_number, 0, 0, 'R')

    def chapter(self, title, paragraphs):
        self.add_page()
        link = self.title_text(title)
        page = self.page_no()
        for paragraph in paragraphs:
            self.multi_cell(0, self.LINE_HEIGHT, paragraph)
            self.ln()

        return link, page

    def title_text(self, title):
        self.set_font('Times', 'B', 15)
        self.cell(0, self.LINE_HEIGHT, title)
        self.set_font('Times', '', 12)
        self.line(10, 17, 110, 17)
        link = self.add_link()
        self.set_link(link)
        self.ln()
        self.ln()

        return link

    def get_full_line(self, head, tail, fill):
        ...</code></pre>
<pre><code class="lang-python">    def toc(self, links):
        self.add_page()
        self.title_text('Table of contents')
        self.set_font('Times', 'I', 12)

        for title, page, link in links:
            line = self.get_full_line(title, page, '.')
            self.cell(0, self.LINE_HEIGHT, line, link=link)
            self.ln()


LOREM_IPSUM = ...

def main():
    document = StructuredPDF()
    document.alias_nb_pages()
    links = []
    num_chapters = randint(5, 40)
    for index in range(1, num_chapters):
        chapter_title = 'Chapter {}'.format(index)
        num_paragraphs = randint(10, 15)
        link, page = document.chapter(chapter_title,
                                      [LOREM_IPSUM] * num_paragraphs)
        links.append((chapter_title, page, link))

    document.toc(links)
    document.output('report.pdf')</code></pre>
<ol start="2">
<li>Run the script, and it will generate the <kbd>report.pdf</kbd> file, which contains some chapters and a table of contents. Note that it generates some randomness, so the specific numbers will vary each time you run it:</li>
</ol>
<pre><code class="lang-python">$ python3 structuring_pdf.py</code></pre>
<ol start="3">
<li>Check the result. Here is a sample:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000011.png" class="lazyload" /></p>
<p>Check the table of contents at the end:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000029.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>Let's take a look at each of the elements of the script.</p>
<p><kbd>StructuredPDF</kbd> defines a class that inherits from <kbd>FPDF</kbd>. This is useful to overwrite the&nbsp;<kbd>footer</kbd> method, which creates a footer each time a page is created. It also helps simplify the code in <kbd>main</kbd>.</p>
<p>The <kbd>main</kbd> function creates the document. It starts the document, and adds each of the chapters, collecting their link information. Finally, it calls the <kbd>toc</kbd> method to generate a table of contents using the link information.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The text to be stored is generated by multiplying the LOREM_IPSUM text, which is a placeholder.</p>
</div>
</div>
<p>The <kbd>chapter</kbd> method first prints a title section, and then adds each of the paragraphs defined. It collects the page number on which the chapter starts and the link returned by the <kbd>title_text</kbd> method to return them.</p>
<p>The <kbd>title_text</kbd> method writes the text in bigger and bolder text. Then, it adds a line to separate the title from the body of the chapter. It generates and sets a <kbd>link</kbd> object pointing to the current page in the following lines:</p>
<pre><code class="lang-python"> link = self.add_link()
 self.set_link(link)</code></pre>
<p>This link will be used in the table of contents to add a clickable element that points to this chapter.</p>
<p>The <kbd>footer</kbd> method automatically adds a footer to each page. It sets a smaller font, and it adds text with the current page (obtained through <kbd>page_no</kbd>) and uses <kbd>{nb}</kbd> , which will be replaced with the total number of pages.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The call to&nbsp;<kbd>alias_nb_pages</kbd> in <kbd>main</kbd>&nbsp;ensures&nbsp;<kbd>{nb}</kbd>&nbsp;is replaced when the document is generated.</p>
</div>
</div>
<p>Finally, the table of contents is generated in the <kbd>toc</kbd> method. It writes the title and adds all the referenced links that have been collected as the link, page, and chapter name, which is all the info required.</p>
<h3>There's more...</h3>
<p>Notice the use of <kbd>randint</kbd> to add a bit of randomness to the document. This call, available in Python's standard library, returns a number between the defined maximum and minimum. Both are included.&nbsp;</p>
<p>The <kbd>get_full_line</kbd> method generates a properly sized line for the table of contents. It takes a start (the name of the chapter) and end (the page number), and adds the number of fill characters (dots) until the line has the proper width (120 mm).</p>
<p>To calculate the size of the text, the script calls&nbsp;<kbd>get_string_width</kbd>, which takes into account the font and the size.</p>
<p>Link objects can be used to point to a specific page, instead of the current one, and also not to the start of the page; use <kbd>set_link(link, y=place, page=num_page)</kbd>. Check the documentation at <a href="http://pyfpdf.readthedocs.io/en/latest/reference/set_link/index.html">http://pyfpdf.readthedocs.io/en/latest/reference/set_link/index.html.</a></p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Adjusting some of the elements can take a certain degree of trial and error, for example, to position the line. A sightly longer or shorter line can be a matter of taste.&nbsp;Don't be afraid to experiment and check until it produces the desired effect.</p>
</div>
</div>
<p>The full FPDF&nbsp;documentation can be found here:&nbsp;<a href="http://pyfpdf.readthedocs.io/en/latest/index.html">http://pyfpdf.readthedocs.io/en/latest/index.html.</a></p>
<h3>See also</h3>
<ul>
<li>The <em>Writing a simple PDF document</em> recipe&nbsp;</li>
<li>The <em>Aggregating PDF reports</em> recipe</li>
<li>The <em>Watermarking and encrypting a PDF</em> recipe</li>
</ul>
<h2>Aggregating PDF reports</h2>
<p>In this recipe, we'll see how to mix two PDFs into the same one. This will allow us to combine reports into a bigger one.</p>
<h3>Getting ready</h3>
<p>We'll use the <kbd>PyPDF2</kbd> module. <kbd>Pillow</kbd> and <kbd>pdf2image</kbd> are also dependencies used by the scripts:</p>
<pre><code class="lang-python">$ echo "PyPDF2==1.26.0" &gt;&gt; requirements.txt
$ echo "pdf2image==0.1.14" &gt;&gt; requirements.txt
$ echo "Pillow==5.1.0" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>For <kbd>pdf2image</kbd> to properly work, it needs to install&nbsp;<kbd>pdftoppm</kbd>, so check here for instructions on how to install it for different platforms: <a href="https://github.com/Belval/pdf2image#first-you-need-pdftoppm">https://github.com/Belval/pdf2image#first-you-need-pdftoppm.</a></p>
<p>We need two PDFs to combine them. For this recipe, we'll use two PDFs: a <kbd>report.pdf</kbd> file generated by the&nbsp;&nbsp;<kbd>structuring_pdf.py</kbd> script, available in GitHub at <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter05/structuring_pdf.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter05/structuring_pdf.py</a>, and another (<kbd>report2.pdf</kbd>) after watermarking it through the following command:</p>
<pre><code class="lang-python">$ python watermarking_pdf.py report.pdf -u automate_user -o report2.pdf</code></pre>
<p>This uses the watermarking script&nbsp;<kbd>watermarking_pdf.py</kbd>, available in GitHub at <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter05/watermarking_pdf.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter05/watermarking_pdf.py</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>PyPDF2</kbd> and create the output PDF:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import PyPDF2
&gt;&gt;&gt; output_pdf = PyPDF2.PdfFileWriter()</code></pre>
<ol start="2">
<li>Read the first file and create a reader:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; file1 = open('report.pdf', 'rb')
&gt;&gt;&gt; pdf1 = PyPDF2.PdfFileReader(file1)</code></pre>
<ol start="3">
<li>Append all pages to the output PDF:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; output_pdf.appendPagesFromReader(pdf1)</code></pre>
<ol start="4">
<li>Open the second file, create a reader, and append the pages to the output PDF:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; file2 = open('report2.pdf', 'rb')
&gt;&gt;&gt; pdf2 = PyPDF2.PdfFileReader(file2)
&gt;&gt;&gt; output_pdf.appendPagesFromReader(pdf2)</code></pre>
<ol start="5">
<li>Create the output file and save it:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('result.pdf', 'wb') as out_file:
...     output_pdf.write(out_file)</code></pre>
<ol start="6">
<li>Close the open files:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; file1.close()
&gt;&gt;&gt; file2.close()</code></pre>
<ol start="7">
<li>Check the output file and confirm that it contains both PDFs pages.</li>
</ol>
<h3>How it works...</h3>
<p><kbd>PyPDF2</kbd> allows us to create a reader for each input file, and add all its pages to a newly created PDF writer. Note the files are opened in binary mode (<kbd>rb</kbd>).</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The input files need to remain open until the result is saved. This is due to the way the copy of the pages works. If the file is open, the resulting file can be stored as an empty file.</p>
</div>
</div>
<p>The PDF writer is finally saved into a new file. Notice that the file needs to be open to write in binary mode (<kbd>wb</kbd>).</p>
<h3>There's more...</h3>
<p><kbd>.appendPagesFromReader</kbd> is very convenient for adding all pages, but it's also possible to add a number of pages one by one with <kbd>.addPage</kbd>. For example, to add the third page, the code would look like this:</p>
<pre><code class="lang-python">&gt;&gt;&gt; page = pdf1.getPage(3)
&gt;&gt;&gt; output_pdf.addPage(page)</code></pre>
<p>The full documentation for <kbd>PyPDF2</kbd> is here: <a href="https://pythonhosted.org/PyPDF2/">https://pythonhosted.org/PyPDF2/.</a></p>
<h3>See also</h3>
<ul>
<li>The <em>Writing a simple PDF document</em> recipe</li>
<li>The <em>Structuring a PDF</em> recipe</li>
<li>The <em>Watermarking and encrypting a PDF</em> recipe</li>
</ul>
<h2>Watermarking and encrypting a PDF</h2>
<p>PDF files have some interesting security measures to limit the distribution of a document. We can encrypt the content, making it necessary to know a password in order to be able to read it. We'll see as well how to add a watermark to label the document clearly as not for public distribution and, if leaked, to know its origin.</p>
<h3>Getting ready</h3>
<p>We'll use the <kbd>pdf2image</kbd> module to transform PDF documents to PIL images.&nbsp;<kbd>Pillow</kbd> is a prerequisite. We'll also use <kbd>PyPDF2</kbd>:</p>
<pre><code class="lang-python">$ echo "pdf2image==0.1.14" &gt;&gt; requirements.txt
$ echo "Pillow==5.1.0" &gt;&gt; requirements.txt
$ echo "PyPDF2==1.26.0" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>For <kbd>pdf2image</kbd> to properly work, it needs to install&nbsp;<kbd>pdftoppm</kbd>, so check here for instructions on how to install it for different platforms: <a href="https://github.com/Belval/pdf2image#first-you-need-pdftoppm">https://github.com/Belval/pdf2image#first-you-need-pdftoppm.</a></p>
<p>We also need a PDF file to watermark and encrypt. We'll use a <kbd>report.pdf</kbd>&nbsp;file generated by the <kbd>structuring_pdf.py</kbd> script, available in GitHub at <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/chapter5/structuring_pdf.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/chapter5/structuring_pdf.py</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>The&nbsp;script, <kbd>watermarking_pdf.py</kbd>, is available in GitHub here: <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter05/watermarking_pdf.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter05/watermarking_pdf.py</a>. The most relevant bits are displayed here:</li>
</ol>
<pre><code class="lang-python">def encrypt(out_pdf, password):
    output_pdf = PyPDF2.PdfFileWriter()

    in_file = open(out_pdf, "rb")
    input_pdf = PyPDF2.PdfFileReader(in_file)
    output_pdf.appendPagesFromReader(input_pdf)
    output_pdf.encrypt(password)

    # Intermediate file
    with open(INTERMEDIATE_ENCRYPT_FILE, "wb") as out_file:
        output_pdf.write(out_file)

    in_file.close()

    # Rename the intermediate file
    os.rename(INTERMEDIATE_ENCRYPT_FILE, out_pdf)


def create_watermark(watermarked_by):
    mask = Image.new('L', WATERMARK_SIZE, 0)
    draw = ImageDraw.Draw(mask)
    font = ImageFont.load_default()
    text = 'WATERMARKED BY {}\n{}'.format(watermarked_by, datetime.now())
    draw.multiline_text((0, 100), text, 55, font=font)

    watermark = Image.new('RGB', WATERMARK_SIZE)
    watermark.putalpha(mask)
    watermark = watermark.resize((1950, 1950))
    watermark = watermark.rotate(45)
    # Crop to only the watermark
    bbox = watermark.getbbox()
    watermark = watermark.crop(bbox)

    return watermark

def apply_watermark(watermark, in_pdf, out_pdf):
    # Transform from PDF to images
    images = convert_from_path(in_pdf)
    ...
    # Paste the watermark in each page
    for image in images:
        image.paste(watermark, position, watermark)

    # Save the resulting PDF
    images[0].save(out_pdf, save_all=True, append_images=images[1:])</code></pre>
<ol start="2">
<li>Watermark the PDF file with the following command:</li>
</ol>
<pre><code class="lang-python">$ python watermarking_pdf.py report.pdf -u automate_user -o out.pdf
Creating a watermark
Watermarking the document
$</code></pre>
<ol start="3">
<li>Check that the document added a watermark with <kbd>automate_user</kbd> and a timestamp to all pages of <kbd>out.pdf</kbd>:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000041.png" class="lazyload" /></p>
<ol start="4">
<li>Watermark and encrypt with the following command. Note that encrypting may take a little while:</li>
</ol>
<pre><code class="lang-python">$ python watermarking_pdf.py report.pdf -u automate_user -o out.pdf -p secretpassword
Creating a watermark
Watermarking the document
Encrypting the document
$</code></pre>
<ol start="5">
<li>Open the resulting <kbd>out.pdf</kbd>, and check that it requires you to input the <kbd>secretpassword</kbd> password. The timestamp will also be new.</li>
</ol>
<h3>How it works...</h3>
<p>The <kbd>watermarking_pdf.py</kbd> script first obtains the parameters from the command line using <kbd>argparse</kbd>, and then passes it to a <kbd>main</kbd> function that calls the other three functions,&nbsp;<kbd>create_watermark</kbd>,&nbsp;<kbd>apply_watermark</kbd> and, if a password is used,&nbsp;<kbd>encrypt</kbd>.</p>
<p><kbd>create_watermark</kbd> generates an image with the watermark. It uses the Pillow <kbd>Image</kbd> class to create a grey image (mode <kbd>L</kbd>) and draw the text. Then, this image gets applied as an alpha channel on a new image, making the image semi-transparent, so it will show the text to watermark.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The alpha channel makes fully transparent anything in white (color 0) and fully opaque anything in black (color 255). In this case, the background is white and the color of the text is 55, making it semi-transparent.</p>
</div>
</div>
<p>The image is then rotated 45 degrees and cropped to reduce the transparent background that may have appeared. This centers the image and allows for better positioning.</p>
<p>In the next step,&nbsp;<kbd>apply_watermark</kbd> transforms the PDF into a sequence of PIL <kbd>Images</kbd> using the&nbsp;<kbd>pdf2image</kbd> module. It calculates the position to apply the watermark, and then pastes the watermark.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The image needs to be located by its left-top corner. This is located in the half of the document, minus half of the watermark, in both height and width. Note that the script assumes that all the pages of the document are equal.</p>
</div>
</div>
<p>Finally, the result is saved to a PDF; notice the <kbd>save_all</kbd> parameter, which allows us to save a multipage PDF.</p>
<p>If a password is passed, the <kbd>encrypt</kbd> function is called. It opens the output PDF, using&nbsp;<kbd>PdfFileReader</kbd>, and creates a new intermediate PDF with&nbsp;<kbd>PdfFileWriter</kbd>. All the pages of the output PDF are added to the new PDF, the PDF is encrypted, and then the intermediate PDF is renamed as the output PDF using <kbd>os.rename</kbd>.</p>
<h3>There's more...</h3>
<p>As part of the watermarking, notice that the pages are transformed into images from text. This adds extra protection, as the text won't be extractable directly, as it is stored as an image. When protecting a file, this is a good idea, as it will stop copying/pasting directly.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>This is not a huge security measure, though, as the text may be extractable through OCR tools. But, it protects against casual extraction of the text.</p>
</div>
</div>
<p>The default font from PIL can be a little rough. Another font, if the <kbd>TrueType</kbd> or <kbd>OpenType</kbd> file is available, can be added and used by calling the following:</p>
<pre><code class="lang-python">font = ImageFont.truetype('my_font.ttf', SIZE)</code></pre>
<p>Note that this may require installing the <kbd>FreeType</kbd> libraries, normally available as part of the <kbd>libfreetype</kbd> package. Further documentation is available at <a href="https://www.freetype.org/">https://www.freetype.org/</a>. Depending on the font and size, you may need to adjust the sizes.</p>
<p>The full <kbd>pdf2image</kbd> documentation can be found at <a href="https://github.com/Belval/pdf2image">https://github.com/Belval/pdf2image</a>, the full documentation for <kbd>PyPDF2</kbd> at <a href="https://pythonhosted.org/PyPDF2/">https://pythonhosted.org/PyPDF2/</a>, and the full documentation for <kbd>Pillow</kbd> can be found at <a href="https://pillow.readthedocs.io/en/5.2.x/">https://pillow.readthedocs.io/en/5.2.x/.</a></p>
<h3>See also</h3>
<ul>
<li>The <em>Writing a simple PDF document</em> recipe</li>
<li>The <em>Structuring a PDF</em> recipe</li>
<li>The <em>Aggregating PDF reports</em> recipe</li>
</ul>

</div>

<!--Chapter 6-->

<div class="chapter" data-chapter-number="6">
<div class="chapter-start">
<div class="ch-head">Chapter <span class="chapter-number"> 6 </span></div>
<h1 class="chaptertitle">Fun with Spreadsheets</h1>
<h3 class="author">Jaime Buelta</h3>
</div>


<p>In this chapter, we will cover the following recipes:</p>
<ul>
<li>Writing a CSV spreadsheet</li>
<li>Updating CSV spreadsheets</li>
<li>Reading an Excel spreadsheet</li>
<li>Updating an Excel spreadsheet</li>
<li>Creating new sheets in an Excel spreadsheet</li>
<li>Creating charts in Excel</li>
<li>Working with format in Excel</li>
<li>Reading and writing in LibreOffice</li>
<li>Creating a macro in LibreOffice</li>
</ul>
<h2>Introduction</h2>
<p>Spreadsheets are one of the most versatile and omnipresent tools in the world of computing. Their intuitive approach of sheets and cells is used by virtually everyone that uses a computer as part of their day-to-day operations. There's even a joke that whole complex businesses are managed and described in a single spreadsheet.&nbsp;They are an incredibly powerful tool.</p>
<p>That makes the ability to automate reading from and writing to spreadsheets so powerful. We'll see in this chapter how to process spreadsheets, mainly in the most common format, Excel. A final recipe will cover a free alternative, Libre Office, and in particular, how to use Python as a scripting language inside it.</p>
<h2>Writing a CSV spreadsheet</h2>
<p>CSV files are simple spreadsheets that are easy to share. They are basically a text file with tabular data, separated by commas (hence the name Comma-Separated Values), in a simple table format.&nbsp;CSV files can be created using Python's standard library and can be read by most spreadsheet software.</p>
<h3>Getting ready</h3>
<p>For this recipe, only the standard library of Python is required. Everything is ready out of the box!</p>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>csv</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import csv</code></pre>
<ol start="2">
<li>Define the header with how the data will be ordered and the data to store:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; HEADER = ('Admissions', 'Name', 'Year')
&gt;&gt;&gt; DATA = [
... (225.7, 'Gone With the Wind', 1939),
... (194.4, 'Star Wars', 1977),
... (161.0, 'ET: The Extra-Terrestrial', 1982)
... ]</code></pre>
<ol start="3">
<li>Write the data into a CSV file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('movies.csv', 'w',  newline='') as csvfile:
...     movies = csv.writer(csvfile)
...     movies.writerow(HEADER)
...     for row in DATA:
...         movies.writerow(row)</code></pre>
<ol start="4">
<li>Check the resulting CSV file in a spreadsheet. In the following screenshot, the file is displayed using the LibreOffice software:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000021.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>After the preparation work in steps 1 and 2 in the <em>How to do it&hellip;</em> section, step 3 is the part that does the work.</p>
<p>It opens a new file,&nbsp;<kbd>movies.csv</kbd>, in write (<kbd>w</kbd>) mode. The raw file object in <kbd>csvfile</kbd>&nbsp;then creates a writer. All this happens in a <kbd>with</kbd> block, so it closes the file when it's over.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Note the <kbd>newline=''</kbd> parameter. This is done to make the <kbd>writer</kbd>&nbsp;store the newline directly and avoid incompatibility issues.</p>
</div>
</div>
<p>The writer writes row by row the elements using <kbd>.writerow</kbd>. The first one is the <kbd>HEADER</kbd>, and then each of the lines of data.</p>
<h3>There's more...</h3>
<p>The code presented stores the data in the default dialect. The dialect defines what divides the data on each row (commas or other characters), how to escape, newlines, and so on. In case the dialect needs to be tweaked, each of these parameters can be defined in the <kbd>writer</kbd> call. See the following link for a list of all the parameters that can be defined:</p>
<p><a href="https://docs.python.org/3/library/csv.html#dialects-and-formatting-parameters">https://docs.python.org/3/library/csv.html#dialects-and-formatting-parameters</a>.&nbsp;</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>CSV files are better when simple. If the data to be stored is complicated, maybe the best alternative is not a CSV file. But CSV files are extremely useful when dealing with tabular data. They can be understood by virtually all programs, and even dealing with them at a low level is easy.</p>
</div>
</div>
<p>The full <kbd>csv</kbd> module documentation can be found here:</p>
<p><a href="https://docs.python.org/3/library/csv.html">https://docs.python.org/3/library/csv.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Reading CSV files</em> recipe <em>in&nbsp;</em>Chapter 4,&nbsp;<em>Searching and Reading Local Files</em></li>
<li>The <em>Updating CSV files</em> recipe</li>
</ul>
<h2>Updating the CSV files</h2>
<p>Given that CSV files are simple text files, the best solution to update their content is to read them, change them to internal Python objects, and then write the result in the same format. In this recipe, will see how to do this.</p>
<h3>Getting ready</h3>
<p>In this recipe, we will use the&nbsp;<kbd>movies.csv</kbd>&nbsp;file that is available on GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/movies.csv">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/movies.csv</a>. It contains the following data:</p>
<table border="1">
<tbody>
<tr>
<td><strong>Admissions</strong></td>
<td><strong>Name</strong></td>
<td><strong>Year</strong></td>
</tr>
<tr>
<td>225.7</td>
<td>Gone With the Wind</td>
<td>1939</td>
</tr>
<tr>
<td>194.4</td>
<td>Star Wars</td>
<td>1968</td>
</tr>
<tr>
<td>161.0</td>
<td>ET: The Extra-Terrestrial</td>
<td>1982</td>
</tr>
</tbody>
</table>
<p>Notice that the year of <kbd>Star Wars</kbd>&nbsp;is incorrect (it should be 1977). We'll change it in the recipe.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the&nbsp;<kbd>csv</kbd> module and define the filename:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import csv
&gt;&gt;&gt; FILENAME = 'movies.csv'</code></pre>
<ol start="2">
<li>Read the contents of the file using a <kbd>DictReader</kbd> and transform them into a list of ordered rows:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open(FILENAME, newline='') as file:
...     data = [row for row in csv.DictReader(file)]</code></pre>
<ol start="3">
<li>Check the obtained data. Change the proper value from 1968 to 1977:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; data
[OrderedDict([('Admissions', '225.7'), ('Name', 'Gone With the Wind'), ('Year', '1939')]), OrderedDict([('Admissions', '194.4'), ('Name', 'Star Wars'), ('Year', '1968')]), OrderedDict([('Admissions', '161.0'), ('Name', 'ET: The Extra-Terrestrial'), ('Year', '1982')])]
&gt;&gt;&gt; data[1]['Year']
'1968'
&gt;&gt;&gt; data[1]['Year'] = '1977'</code></pre>
<ol start="4">
<li>Open the file again, and store the values:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; HEADER = data[0].keys()
&gt;&gt;&gt; with open(FILENAME, 'w', newline='') as file:
...     writer = csv.DictWriter(file, fieldnames=HEADER)
...     writer.writeheader()
...     writer.writerows(data)</code></pre>
<ol start="5">
<li>Check the result in spreadsheet software. The result is similar to that displayed in step 4 of the&nbsp;<em>Writing a CSV spreadsheet</em> recipe.</li>
</ol>
<h3>How it works...</h3>
<p>After importing the <kbd>csv</kbd> module in step 2 of the <em>How to do it&hellip;</em> section, we extract all the data from the file. The file is opened in a <kbd>with</kbd> block.&nbsp;&nbsp;<kbd>DictReader</kbd> conveniently transforms it into a list of dictionaries, with the keys on the header values.</p>
<p>The conveniently formatted data can then be manipulated and changed. We change the data to the proper value in step 3.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>In this recipe, we change the value directly, but searching may be required in a more general case.</p>
</div>
</div>
<p>Step 4 overwrites the file and, using&nbsp;<kbd>DictWriter</kbd>, stores the data. <kbd>DictWriter</kbd> requires us to define the fields on the columns by requiring the <kbd>fieldnames</kbd>. To obtain it, we retrieve the keys of one of the rows and store them in <kbd>HEADER</kbd>.</p>
<p>The file is opened again in <kbd>w</kbd> mode to overwrite it.&nbsp;<kbd>DictWriter</kbd>&nbsp; first stores the header with <kbd>.writeheader</kbd> and then stores all the rows with a single call to <kbd>.writerows</kbd>.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The rows can also be added one by one by calling <kbd>.writerow</kbd></p>
</div>
</div>
<p>After closing the <kbd>with</kbd> block, the file is stored and can be checked.</p>
<h3>There's more...</h3>
<p>The dialect of the CSV file typically known, but it may be the case that it is not. In that case, the <kbd>Sniffer</kbd> class can help. It&nbsp;analyses a sample of the file (or the whole file) and returns a <kbd>dialect</kbd> object to allow reading in the proper way:</p>
<pre><code class="lang-python">&gt;&gt;&gt; with open(FILENAME, newline='') as file:
...    dialect = csv.Sniffer().sniff(file.read())</code></pre>
<p>The dialect then can be passed to the <kbd>DictReader</kbd> class when opening the file. The file will need to be opened twice for reading.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Remember to use the dialect on the <kbd>DictWriter</kbd> class as well to save the file in the same format.</p>
</div>
</div>
<p>The full documentation for the&nbsp;<kbd>csv</kbd> module can be found here:</p>
<p><a href="https://docs.python.org/3.6/library/csv.html">https://docs.python.org/3.6/library/csv.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The&nbsp;<em>Reading CSV files</em> recipe in&nbsp;Chapter 4,&nbsp;<em>Searching and Reading Local Files</em></li>
<li>The <em>Writing a CSV spreadsheet</em> recipe</li>
</ul>
<h2>Reading an Excel spreadsheet</h2>
<p>MS Office is arguably the most common office suite software, making its formats pretty much standards. In terms of spreadsheets, Excel is probably the most used one and a format easily exchanged.</p>
<p>In this recipe, we'll see how to obtain information from an Excel spreadsheet programmatically from Python using the <kbd>openpyxl</kbd> module.</p>
<h3>Getting ready</h3>
<p>We will use the&nbsp;<kbd>openpyxl</kbd> module. We should install the module, adding it to our <kbd>requirements.txt</kbd> file as follows:</p>
<pre><code class="lang-python">$ echo "openpyxl==2.5.4" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>In the GitHub repository, there's an Excel spreadsheet named <kbd>movies.xlsx</kbd> that contains information on the top ten movies by attendance. The file can be found here:</p>
<p><a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/movies.xlsx">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/movies.xlsx</a>.</p>
<p>The source of the information is this web page:</p>
<p><a href="http://www.mrob.com/pub/film-video/topadj.html">http://www.mrob.com/pub/film-video/topadj.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the&nbsp;<kbd>openpyxl</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import openpyxl</code></pre>
<ol start="2">
<li>Load the file into memory:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; xlsfile = openpyxl.load_workbook('movies.xlsx')</code></pre>
<ol start="3">
<li>List all sheets and get the first one, which is the only one that contains data:</li>
</ol>
<ol start="3"></ol>
<pre><code class="lang-python">&gt;&gt;&gt; xlsfile.sheetnames
['Sheet1']
&gt;&gt;&gt; sheet = xlsfile['Sheet1']</code></pre>
<ol start="4">
<li>Obtain the value of cells <kbd>B4</kbd> and <kbd>D4</kbd> (admissions and director of E.T.):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; sheet['B4'].value
161
&gt;&gt;&gt; sheet['D4'].value
'Steven Spielberg'</code></pre>
<ol start="5">
<li>Obtain the size in rows and columns. Any cell out of that range will return <kbd>None</kbd> as a value:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; sheet.max_row
11
&gt;&gt;&gt; sheet.max_column
4
&gt;&gt;&gt; sheet['A12'].value
&gt;&gt;&gt; sheet['E1'].value</code></pre>
<h3>How it works...</h3>
<p>After importing the module in step 1, step 2 in the <em>How to do it&hellip;</em> section loads the file into memory in a <kbd>Workbook</kbd> object. Each workbook can contain one or more sheets, which contain cells.</p>
<p>To determine the available sheets, in step 3 we obtain all the sheets (there's only one in this example) and then access the sheet like a dictionary to retrieve a <kbd>Worksheet</kbd> object.</p>
<p><kbd>Worksheet</kbd> can then access all the cells directly by their names, such as&nbsp;<kbd>A4</kbd> or <kbd>C3</kbd>. Each of them will return a <kbd>Cell</kbd> object. The&nbsp;<kbd>.value</kbd>&nbsp;attribute stores the value in the cell.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>In the rest of the recipes in this chapter, we will see more attributes of <kbd>Cell</kbd> objects. Keep reading!</p>
</div>
</div>
<p>Obtaining the area where the data is stored is possible with&nbsp;<kbd>max_columns</kbd> and <kbd>max_rows</kbd>. This allows us to search within the limits of the data.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Excel defines the columns as letters (A, B, C, and so on ) and rows as numbers (1, 2, 3, and so on). Remember to always set the column, and then the row (<kbd>D1</kbd>, not <kbd>1D</kbd>), or an error will be raised.</p>
</div>
</div>
<p>Cells outside the area are accessible, but won't return data. They can be used to write new info.</p>
<h3>There's more...</h3>
<p>Cells can also be retrieved with&nbsp;<kbd>sheet.cell(column, row)</kbd>. Both elements start at 1.</p>
<p>All the cells within the data area iterating from the sheet, for example:</p>
<pre><code class="lang-python">&gt;&gt;&gt; for row in sheet:
...     for cell in row:
...         # Do stuff with cell</code></pre>
<p>This will return a list of lists with all cells, row by row: A1, A2, A3 ... B1, B2, B3, and so on.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>You can retrieve the cell's column with columns iterating through <kbd>sheet.columns</kbd>:&nbsp;A1, B1, C1, and so on, A2, B2, C2. and so on.</p>
</div>
</div>
<p>When retrieving a cell, you can find their&nbsp;position with <kbd>.coordinate</kbd>, <kbd>.row</kbd>, and <kbd>.column</kbd>:</p>
<pre><code class="lang-python">&gt;&gt;&gt; cell.coordinate
'D4'
&gt;&gt;&gt; cell.column
'D'
&gt;&gt;&gt; cell.row
4</code></pre>
<p>The full <kbd>openpyxl</kbd> documentation can be found here:</p>
<p><a href="https://openpyxl.readthedocs.io/en/stable/index.html">https://openpyxl.readthedocs.io/en/stable/index.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Updating an Excel spreadsheet</em> recipe</li>
<li>The <em>Creating new sheets in an Excel spreadsheet</em> recipe</li>
<li>The <em>Creating charts in Excel</em> recipe</li>
<li>The <em>Working with the format in Excel</em> recipe</li>
</ul>
<h2>Updating an Excel spreadsheet</h2>
<p>In this recipe, we'll see how to update an existing Excel spreadsheet. This will include changing raw values in cells but also setting up formulas that will be evaluated when the spreadsheet is open. We'll also see how to add comments to cells.</p>
<h3>Getting ready</h3>
<p>We will use the module <kbd>openpyxl</kbd>. We should install the module, adding it to our <kbd>requirements.txt</kbd> file as follows:</p>
<pre><code class="lang-python">$ echo "openpyxl==2.5.4" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>In the GitHub repository, there's an Excel spreadsheet named <kbd>movies.xlsx</kbd> that contains information on the top ten movies by attendance.</p>
<p>The file can be found here:</p>
<p><a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/movies.xlsx">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/movies.xlsx</a><a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/chapter6/movies.xlsx">.</a></p>
<h3>How to do it...</h3>
<ol>
<li>Import the module&nbsp;<kbd>openpyxl</kbd> and the <kbd>Comment</kbd> class:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import openpyxl
&gt;&gt;&gt; from openpyxl.comments import Comment</code></pre>
<ol start="2">
<li>Load the file into memory and get the sheet:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; xlsfile = openpyxl.load_workbook('movies.xlsx')
&gt;&gt;&gt; sheet = xlsfile['Sheet1']</code></pre>
<ol start="3">
<li>Obtain the value of cell <kbd>D4</kbd> (director of E.T):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; sheet['D4'].value
'Steven Spielberg'</code></pre>
<ol start="4">
<li>Change the value to just <kbd>Spielberg</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; sheet['D4'].value = 'Spielberg'</code></pre>
<ol start="5">
<li>Add a comment to that cell:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; sheet['D4'].comment = Comment('Changed text automatically', 'User')</code></pre>
<ol start="6">
<li>Add a new element that obtains the total of all values in the <kbd>Admission</kbd> column:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; sheet['B12'] = '=SUM(B2:B11)'</code></pre>
<ol start="7">
<li>Save the spreadsheet to the&nbsp;<kbd>movies_comment.xlsx</kbd> file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; xlsfile.save('movies_comment.xlsx')</code></pre>
<ol start="8">
<li>Check the resulting file, which includes the comment and the calculation of the total of column <kbd>B</kbd> in <kbd>A12</kbd>:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000072.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>In the <em>How to do it&hellip;</em> section, the imports in step 1 and reading the spreadsheet in step 2, we select the cell to be changed in step 3.</p>
<p>Updating the value is done in step 4 with an assignment. A comment in the cell is added, overwriting the <kbd>.coment</kbd> attribute with a new <kbd>Comment</kbd>. Note that the user that made the comment needs to be added as well.</p>
<p>Values can also include descriptions of formulas. In step 6, we add a new formula to cell <kbd>B12</kbd>. The value is calculated and displayed when the file is opened in step 8.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The value of a formula is not calculated in the Python object. This means that the formula could contain errors or display unexpected results through bugs. Be sure to double-check that the formulas are correct.</p>
</div>
</div>
<p>Finally, in step 9, the spreadsheet is saved to disk by calling the <kbd>.save</kbd> method of the file.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The name of the resulting file can be the same one as the input one to overwrite the file.</p>
</div>
</div>
<p>The comment and values can be checked by externally accessing the file.</p>
<h3>There's more...</h3>
<p>You can store data in multiple values, and it will be translated into the proper types for Excel. For example, storing&nbsp;<kbd>datetime</kbd> will store it in the proper date format. The same is true with <kbd>float</kbd> or other numeric formats.</p>
<p>If you need to infer types, you can enable&nbsp;this by using the <kbd>guess_type</kbd>&nbsp;parameter when loading the file, for example:</p>
<pre><code class="lang-python">&gt;&gt;&gt; xlsfile = openpyxl.load_workbook('movies.xlsx', guess_types=True)
&gt;&gt;&gt; xlsfile['Sheet1']['A1'].value = '37%'
&gt;&gt;&gt; xlsfile['Sheet1']['A1'].value
0.37
&gt;&gt;&gt; xlsfile['Sheet1']['A1'].value = '2.75'
&gt;&gt;&gt; xlsfile['Sheet1']['A1'].value
2.75</code></pre>
<p>Adding comments to automatically generated cells can help review the resulting file, making clear how where they generated.</p>
<p>While is possible to add formulas to automatically generate Excel files, debugging the results can be tricky. When generating a result, generally it's better to make the calculations in Python and store the result in raw.</p>
<p>The full&nbsp;<kbd>openpyxl</kbd>&nbsp;documentation can be found here:</p>
<p><a href="https://openpyxl.readthedocs.io/en/stable/index.html">https://openpyxl.readthedocs.io/en/stable/index.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Reading an Excel spreadsheet</em> recipe</li>
<li>The&nbsp;<em>Creating new sheets on an Excel spreadsheet</em>&nbsp;recipe</li>
<li>The&nbsp;<em>Creating charts in Excel</em>&nbsp;recipe</li>
<li>The&nbsp;<em>Working with the format in Excel</em> recipe</li>
</ul>
<h2>Creating new sheets on an Excel spreadsheet</h2>
<p>In this recipe, we'll demonstrate how to create a new Excel spreadsheet from scratch, and add and deal with multiple sheets.</p>
<h3>Getting ready</h3>
<p>We will use the module&nbsp;<kbd>openpyxl</kbd>. &nbsp;We should install the module, adding it to our <kbd>requirements.txt</kbd> file as follows:</p>
<pre><code class="lang-python">$ echo "openpyxl==2.5.4" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>We'll store in the new file information about the movies with the most attendance. Data is extracted from&nbsp;here:</p>
<p><a href="http://www.mrob.com/pub/film-video/topadj.html">http://www.mrob.com/pub/film-video/topadj.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>openpyxl</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import openpyxl</code></pre>
<ol start="2">
<li>Create a new Excel file. It creates a default sheet, called <kbd>Sheet</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; xlsfile = openpyxl.Workbook()
&gt;&gt;&gt; xlsfile.sheetnames
['Sheet']
&gt;&gt;&gt; sheet = xlsfile['Sheet']</code></pre>
<ol start="3">
<li>Add data about the number of attendees to this sheet from the source. Only the first three are added for simplicity:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; data = [
...    (225.7, 'Gone With the Wind', 'Victor Fleming'),
...    (194.4, 'Star Wars', 'George Lucas'),
...    (161.0, 'ET: The Extraterrestrial', 'Steven Spielberg'),
... ]
&gt;&gt;&gt; for row, (admissions, name, director) in enumerate(data, 1):
...     sheet['A{}'.format(row)].value = admissions
...     sheet['B{}'.format(row)].value = name</code></pre>
<ol start="4"></ol>
<ol start="4">
<li>Create a new sheet:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; sheet = xlsfile.create_sheet("Directors")
&gt;&gt;&gt; sheet
&lt;Worksheet "Directors"&gt;
&gt;&gt;&gt; xlsfile.sheetnames
['Sheet', 'Directors']</code></pre>
<ol start="5">
<li>Add the name of the director for each movie:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; for row, (admissions, name, director) in enumerate(data, 1):
...    sheet['A{}'.format(row)].value = director
...    sheet['B{}'.format(row)].value = name</code></pre>
<ol start="6">
<li>Save the file as <kbd>movie_sheets.xlsx</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; xlsfile.save('movie_sheets.xlsx')</code></pre>
<ol start="7">
<li>Open the&nbsp;<kbd>movie_sheets.xlsx</kbd> file&nbsp;to check that it has two sheets, with the proper information, as shown in the following screenshot:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000009.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>In the <em>How to do it&hellip;</em> section, after importing the module in step 1, we create a new spreadsheet in step 2. This is a new spreadsheet that contains just the default sheet.</p>
<p>The data to be stored is defined in step 3. Note it contains the info that will go on both sheets (name in both,&nbsp;admissions in the first sheet, and director's name in the second). In this step, the first sheet is filled.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Note how the value is stored. The proper cell is defined as column&nbsp;<kbd>A</kbd> or <kbd>B</kbd>&nbsp; and the proper row (rows start at 1). The <kbd>enumerate</kbd> function returns a tuple with the first element as the index and the second as the enumerate parameter (an iterator).</p>
</div>
</div>
<p>After that, the new sheet is created in step 4,&nbsp;using the name <kbd>Directors</kbd>. <kbd>.create_sheet</kbd> returns the new sheet.</p>
<p>The information in the <kbd>Directors</kbd> sheet is stored in step 5 and the file is saved in step 6.</p>
<h3>There's more...</h3>
<p>The name of an existing sheet can be changed through the <kbd>.title</kbd> property:</p>
<pre><code class="lang-python">&gt;&gt;&gt; sheet = xlsfile['Sheet']
&gt;&gt;&gt; sheet.title = 'Admissions'
&gt;&gt;&gt; xlsfile.sheetnames
['Admissions', 'Directors']</code></pre>
<p>Be careful, as it won't be possible to access the sheet with&nbsp;<kbd>xlsfile['Sheet']</kbd>. That name doesn't exist!</p>
<p>The active sheet, the sheet that will be displayed when the file is opened, can be obtained through the <kbd>.active</kbd> property and changed with&nbsp;<kbd>._active_sheet_index</kbd>. The index starts at&nbsp;<kbd>0</kbd>&nbsp;for the first sheet:</p>
<pre><code class="lang-python">&gt;&gt; xlsfile.active
&lt;Worksheet "Admissions"&gt;
&gt;&gt;&gt; xlsfile._active_sheet_index
0
&gt;&gt;&gt; xlsfile._active_sheet_index = 1
&gt;&gt;&gt; xlsfile.active
&lt;Worksheet "Directors"&gt;</code></pre>
<p>The sheet can also be copied using <kbd>.copy_worksheet</kbd>. Be aware that some data, for example, charts, won't be carried over. Most duplicated information will be cell data:</p>
<pre><code class="lang-python">new_copied_sheet = xlsfile.copy_worksheet(source_sheet)</code></pre>
<p>The full&nbsp;<kbd>openpyxl</kbd>&nbsp;documentation can be found here:</p>
<p><a href="https://openpyxl.readthedocs.io/en/stable/index.html">https://openpyxl.readthedocs.io/en/stable/index.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Reading an Excel spreadsheet</em> recipe</li>
<li><span>The <em>Updating an Excel spreadsheet and adding comments</em>&nbsp;recipe</span></li>
<li>The <em>Creating charts in Excel</em>&nbsp;recipe</li>
<li>The <em>Working with format in Excel</em>&nbsp;recipe</li>
</ul>
<h2>Creating charts in Excel</h2>
<p>Spreadsheets include a lot of tools to deal with data, including presenting the data in colorful charts. Let's see how to append a chart programmatically to an Excel spreadsheet.</p>
<h3>Getting ready</h3>
<p>We will use the module&nbsp;<kbd>openpyxl</kbd>. &nbsp;We should install the module,&nbsp;adding it to our <kbd>requirements.txt</kbd> file as follows:</p>
<pre><code class="lang-python">$ echo "openpyxl==2.5.4" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>We'll store in the new file information about the movies with the most attendance. Data is extracted from&nbsp;here:</p>
<p><a href="http://www.mrob.com/pub/film-video/topadj.html">http://www.mrob.com/pub/film-video/topadj.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the&nbsp;<kbd>openpyxl</kbd>&nbsp;module and create a new Excel file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import openpyxl
&gt;&gt;&gt; from openpyxl.chart import BarChart, Reference
&gt;&gt;&gt; xlsfile = openpyxl.Workbook()</code></pre>
<ol start="2">
<li>Add data about the number of attendees in this sheet from the source. Only the first three are added for simplicity:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; data = [
...     ('Name', 'Admissions'),
...     ('Gone With the Wind', 225.7),
...     ('Star Wars', 194.4),
...     ('ET: The Extraterrestrial', 161.0),
... ]
&gt;&gt;&gt; sheet = xlsfile['Sheet']
&gt;&gt;&gt; for row in data:
... sheet.append(row)</code></pre>
<ol start="3">
<li>Create a <kbd>BarChart</kbd> object and fill it with basic information:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; chart = BarChart()
&gt;&gt;&gt; chart.title = "Admissions per movie"
&gt;&gt;&gt; chart.y_axis.title = 'Millions'</code></pre>
<ol start="4">
<li>Create a reference to the <kbd>data</kbd>, and append the <kbd>data</kbd> to the chart:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; data = Reference(sheet, min_row=2, max_row=4, min_col=1, max_col=2)
&gt;&gt;&gt; chart.add_data(data, from_rows=True, titles_from_data=True)</code></pre>
<ol start="5">
<li>Add the chart to the sheet and save the file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; sheet.add_chart(chart, "A6")
&gt;&gt;&gt; xlsfile.save('movie_chart.xlsx')</code></pre>
<ol start="6">
<li>Check the resulting chart in the spreadsheet, as shown in the following screenshot:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000025.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>In the <em>How to do it&hellip;</em> section, after preparing the data in steps 1 and 2, the data is ready in the range <kbd>A1:B4</kbd>. Note that <kbd>A1</kbd> and <kbd>B1</kbd>&nbsp;both contain a header that should not be used in the chart.</p>
<p>In step 3, we set up the new chart and include the basic data, such as a title and the units of the <em>Y</em> axis.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The title is changed to <kbd>Millions</kbd>; although a more correct way would been <kbd>Admissions(millions)</kbd>, it'd be redundant with the full title of the chart.</p>
</div>
</div>
<p>Step 4 creates a reference box through a <kbd>Reference</kbd> object, from row 2 column 1 to row 4 column 2, which is the area where our data lives, excluding the header. The data is added to the chart with <kbd>.add_data</kbd>.&nbsp;<kbd>from_rows</kbd> makes each row a different data series.&nbsp;<kbd>titles_from_data</kbd> makes the first column treated as the name of the series.</p>
<p>The chart is added to cell <kbd>A6</kbd> in step 5 and saved to disk.</p>
<h3>There's more...</h3>
<p>There are a bunch of different charts that can be created, including bar charts, line charts, area charts (line charts that fill the area between the line and the axis), pie charts, or scatter charts (XY charts where one value is plotted against the other). Each kind of chart has an equivalent class, for example&nbsp;<kbd>PieChart</kbd> or <kbd>LineChart</kbd>.</p>
<p>Each one, at the same time, can have different types. For example, the default type for <kbd>BarChart</kbd> is column, printing the bars vertically, but they can also be printed in vertical, selecting a different type:</p>
<pre><code class="lang-python">&gt;&gt;&gt; chart.type = 'bar'</code></pre>
<p>Check the&nbsp;<kbd>openpyxl</kbd>&nbsp;documentation to see all available combinations.</p>
<p>Instead of extracting the <em>x&nbsp;</em>axis labels from the data, they can be set explicitly with <kbd>set_categories</kbd>. For example, compare step 4 with the following code:</p>
<pre><code class="lang-python">data = Reference(sheet, min_row=2, max_row=4, min_col=2, max_col=2)
labels = Reference(sheet, min_row=2, max_row=4, min_col=1, max_col=1)
chart.add_data(data, from_rows=False, titles_from_data=False)
chart.set_categories(labels)</code></pre>
<p>The range, instead of using a <kbd>Reference</kbd> object, can also be input with text labels describing the region:</p>
<pre><code class="lang-python">chart.add_data('Sheet!B2:B4', from_rows=False, titles_from_data=False)
chart.set_categories('Sheet!A2:A4')</code></pre>
<p>This way of describing it may be more difficult to deal with if the range of data needs to be created programatically.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Defining charts in Excel correctly can be difficult sometimes. The way Excel extracts the data from a particular range can be baffling. Remember to allow time for trial and error, and to deal with differences. For example, in step 4 we define three series with one data point, while in the preceding code we define a single series with three data points. Most of those differences are subtle. Finally, the most important point is how the end chart looks. Try different chart types and learn the differences.</p>
</div>
</div>
<p>The full&nbsp;<kbd>openpyxl</kbd>&nbsp;documentation can be found here:</p>
<p><a href="https://openpyxl.readthedocs.io/en/stable/index.html">https://openpyxl.readthedocs.io/en/stable/index.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Reading an Excel spreadsheet</em> recipe</li>
<li>The&nbsp;<em>Updating an Excel spreadsheet and adding comments</em>&nbsp;recipe</li>
<li>The&nbsp;<em>Creating new sheets on an Excel spreadsheet</em>&nbsp;recipe</li>
<li>The&nbsp;<em>Working with format in Excel</em>&nbsp;recipe</li>
</ul>
<h2>Working with format in Excel</h2>
<p>Presenting information in spreadsheets is not just a matter of organizing it into cells or displaying it graphically in charts, but also involves changing the format to highlight the important points about it. In this recipe, we'll see how to manipulate the format of cells to enhance the data and present it in the best way.</p>
<h3>Getting ready</h3>
<p>We will use the module&nbsp;<kbd>openpyxl</kbd>. &nbsp;We should install the module, adding it to our&nbsp;<kbd>requirements.txt</kbd>&nbsp;file as follows:</p>
<pre><code class="lang-python">$ echo "openpyxl==2.5.4" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>We'll store in the new file information about the movies with the most attendance. Data is extracted from&nbsp;here:</p>
<p><a href="http://www.mrob.com/pub/film-video/topadj.html">http://www.mrob.com/pub/film-video/topadj.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the&nbsp;<kbd>openpyxl</kbd>&nbsp;module and create a new Excel file:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import openpyxl
&gt;&gt;&gt; from openpyxl.styles import Font, PatternFill, Border, Side
&gt;&gt;&gt; xlsfile = openpyxl.Workbook()</code></pre>
<ol start="2">
<li>Add data about the number of attendees in this sheet from the source. Only the first four are added, for simplicity:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; data = [
...    ('Name', 'Admissions'),
...    ('Gone With the Wind', 225.7),
...    ('Star Wars', 194.4),
...    ('ET: The Extraterrestrial', 161.0),
...    ('The Sound of Music', 156.4),
]
&gt;&gt;&gt; sheet = xlsfile['Sheet']
&gt;&gt;&gt; for row in data:
...    sheet.append(row)</code></pre>
<ol start="3">
<li>Define the colors to use for styling the spreadsheet:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; BLUE = "0033CC"
&gt;&gt;&gt; LIGHT_BLUE = 'E6ECFF'
&gt;&gt;&gt; WHITE = "FFFFFF"</code></pre>
<ol start="4">
<li>Define the header in a blue background and a white font:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; header_font = Font(name='Tahoma', size=14, color=WHITE)
&gt;&gt;&gt; header_fill = PatternFill("solid", fgColor=BLUE)
&gt;&gt;&gt; for row in sheet['A1:B1']:
...     for cell in row:
...         cell.font = header_font
...         cell.fill = header_fill</code></pre>
<ol start="5">
<li>Define an alternate pattern for the columns and a border on each row after the header:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; white_side = Side(border_style='thin', color=WHITE)
&gt;&gt;&gt; blue_side = Side(border_style='thin', color=BLUE)
&gt;&gt;&gt; alternate_fill = PatternFill("solid", fgColor=LIGHT_BLUE)
&gt;&gt;&gt; border = Border(bottom=blue_side, left=white_side, right=white_side)
&gt;&gt;&gt; for row_index, row in enumerate(sheet['A2:B5']):
...     for cell in row:
...         cell.border = border
...         if row_index % 2:
...             cell.fill = alternate_fill</code></pre>
<ol start="6">
<li>Save the file as&nbsp;<kbd>movies_format.xlsx</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; xlsfile.save('movies_format.xlsx')</code></pre>
<ol start="7">
<li>Check the resulting file:&nbsp;</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000003.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>In the <em>How to do it&hellip;&nbsp;</em>section, in step 1 we import the <kbd>openpyxl</kbd> module and create a new Excel file. In step 2, we add the data to the first sheet. Step 3 is also a preparation step to define the colors to be used. The colors are defined in hex format, which is common in the web design world.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>To find the definition of colors, there are plenty of color pickers online or even embedded in the OS. A tool like <a href="https://coolors.co/">https://coolors.co/</a>&nbsp;can be useful to define a palette to work with.</p>
</div>
</div>
<p>In step 4, we prepare the format to define the header. The header will have a different font (Tahoma), a bigger size (14pt), and it will be white on a blue background. To do this, we prepare a <kbd>Font</kbd> object with the font, size, and foreground color, and a <kbd>PatternFill</kbd> with the background color.</p>
<p>The loop after creating <kbd>header_font</kbd> and <kbd>header_fill</kbd> applies the font and fill to the proper cells.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Note that iterating over a range always returns the row, then cells, even if only one row is involved.</p>
</div>
</div>
<p>In step 5, a border to the rows and an alternate background is applied. The border is defined with blue top and bottom and white left and right. The fill is created in a similar way to step 4, but in a light blue. The background is only applied to even rows.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Note that the top border of a cell is the bottom of the one above and vice versa. This means that it's possible to overwrite the border in a loop.</p>
</div>
</div>
<p>The file is saved finally in step 6.</p>
<h3>There's more...</h3>
<p>To define the font, there are other options available, such as bold, italic, strikeout, or underline. Define the font and reassign it if you need to change any of its elements. And remember to check that the font is available.</p>
<p>There are also various ways of creating a fill. The <kbd>PatternFill</kbd> accepts several patterns, but the most useful one is&nbsp;<kbd>solid</kbd>.&nbsp;<kbd>GradientFill</kbd> can also be used to apply a two-color gradient.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>It's best to limit yourself to solid fills using <kbd>PatternFill</kbd>. You can tweak the color to best represent what you want. Remember to include&nbsp;<kbd>style='solid'</kbd>, or the colour may not appear.</p>
</div>
</div>
<p>It's also possible to define conditional formatting, but it's better to try to define the conditionals in Python and then apply the proper formatting.</p>
<p>Number formatting can be set up properly, for example:</p>
<pre><code class="lang-python">cell.style = 'Percent'</code></pre>
<p>This will display the value <kbd>0.37</kbd> as <kbd>37%</kbd>.</p>
<p>The full&nbsp;<kbd>openpyxl</kbd>&nbsp;documentation can be found here:</p>
<p><a href="https://openpyxl.readthedocs.io/en/stable/index.html">https://openpyxl.readthedocs.io/en/stable/index.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Reading an Excel spreadsheet</em> recipe</li>
<li>The&nbsp;<em>Updating an Excel spreadsheet and adding comments&nbsp;</em>recipe</li>
<li>The<em>&nbsp;Creating new sheets on an Excel spreadsheet</em>&nbsp;recipe</li>
<li>The&nbsp;<em>Creating charts in Excel&nbsp;</em>recipe</li>
</ul>
<h2>Creating a macro in LibreOffice</h2>
<p>LibreOffice is a free office suite that's an alternative to MS Office and other office packages. It includes a text editor and a spreadsheet program called <kbd>Calc</kbd>. Calc understands the regular Excel formats, and it's also totally scriptable internally through its UNO API. The UNO interface allows programmatic access to the suite, and it's accessible in different languages, such as Java.</p>
<p>One of the available language is Python, making it very easy to generate very complex applications in a suite format, as this enables the use of the full Python standard library.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Using the full Python standard library give access to elements such as cryptography; opening external files, including ZIP&nbsp;files; or connecting to remote databases. Also, take advantage of the Python syntax and avoid dealing with LibreOffice BASIC.</p>
</div>
</div>
<p>We'll see in this recipe how to add an external Python file as a macro that will change the contents of a spreadsheet.</p>
<h3>Getting ready</h3>
<p>LibreOffice needs to be installed. It is available at&nbsp;<a href="https://www.libreoffice.org/">https://www.libreoffice.org/</a>.</p>
<p>Once downloaded and installed, it needs to be configured to allow the execution of macros:</p>
<ol>
<li>Go to Settings | Security to find the Macro Security details:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000052.png" class="lazyload" /></p>
<ol start="2">
<li>Open&nbsp;Macro Security and select Medium to allow execution of our macros. This will display a warning before allowing us to run a macro:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000068.png" class="lazyload" /></p>
<p>To insert the macro into the file, we'll use a script called <kbd>include_macro.py</kbd>, which is available at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/include_macro.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/include_macro.py</a>. The script with the macro is also available as <kbd>libreoffice_script.py</kbd> here:</p>
<p><a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/libreoffice_script.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/libreoffice_script.py</a>.</p>
<p>The file to put the script into, called <kbd>movies.ods</kbd>, is also available here:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/movies.ods">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter06/movies.ods</a>. It contains, in the&nbsp;<kbd>.ods</kbd> format (LibreOffice format), a table with the 10 movies with highest admissions. Data is extracted from&nbsp;here:</p>
<p><a href="http://www.mrob.com/pub/film-video/topadj.html">http://www.mrob.com/pub/film-video/topadj.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Use the&nbsp;<kbd>include_macro.py</kbd>&nbsp;script to attach the&nbsp;<kbd>libreoffice_script.py</kbd> to the file <kbd>movies.ods</kbd> macrofile:</li>
</ol>
<pre><code class="lang-python">$ python include_macro.py -h
usage: It inserts the macro file "script" into the file "spreadsheet" in .ods format. The resulting file is located in the macro_file directory, that will be created
       [-h] spreadsheet script

positional arguments:
  spreadsheet File to insert the script
  script Script to insert in the file

optional arguments:
  -h, --help show this help message and exit

$ python include_macro.py movies.ods libreoffice_script.py</code></pre>
<ol start="2">
<li>Open the resulting file,&nbsp;<kbd>macro_file/movies.ods</kbd>, in LibreOffice. Notice that it shows a warning to enable the macros (click on Enable). Go to Tools | Macros | Run Macro:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000006.png" class="lazyload" /></p>
<ol start="3">
<li>Select the&nbsp;<kbd>ObtainAggregated</kbd> under <kbd>movies.ods</kbd>&nbsp;| <kbd>libreoffice_script</kbd>&nbsp;macro and click on Run. It calculates the aggregated admissions and stores them in cell <kbd>B12</kbd>. It adds a <kbd>Total</kbd> label in <kbd>A15</kbd>:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000059.png" class="lazyload" /></p>
<ol start="4">
<li>Repeat steps 2 and 3 to run it again. Now it runs all the aggregations, but adds <kbd>B12</kbd> and gets the result in <kbd>B13</kbd>:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000032.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>The main work in step 1 is done in the&nbsp;<kbd>include_macro.py</kbd> script. It copies the file into the&nbsp;<kbd>macro_file</kbd>&nbsp;subdirectory to avoid modifying the input.</p>
<p>Internally, an<kbd>.ods</kbd> file is a ZIP file with a certain structure. The script takes advantage of the ZIP file Python module to add the script in the proper subdirectory internally. It also modifies the <kbd>manifest.xml</kbd> file to allow LibreOffice to know there's a script inside the file.</p>
<p>The macro that is executed in step 3 is defined in <kbd>libreoffice_script.py</kbd>&nbsp;and contains a single function:</p>
<pre><code class="lang-python">def ObtainAggregated(*args):
    """Prints the Python version into the current document"""
    # get the doc from the scripting context
    # which is made available to all scripts
    desktop = XSCRIPTCONTEXT.getDesktop()
    model = desktop.getCurrentComponent()
    # get the first sheet
    sheet = model.Sheets.getByIndex(0)

    # Find the admissions column
    MAX_ELEMENT = 20
    for column in range(0, MAX_ELEMENT):
        cell = sheet.getCellByPosition(column, 0)
        if 'Admissions' in cell.String:
            break
    else:
        raise Exception('Admissions not found')

    accumulator = 0.0
    for row in range(1, MAX_ELEMENT):
        cell = sheet.getCellByPosition(column, row)
        value = cell.getValue()
        if value:
            accumulator += cell.getValue()
        else:
            break

    cell = sheet.getCellByPosition(column, row)
    cell.setValue(accumulator)

    cell = sheet.getCellRangeByName("A15")
    cell.String = 'Total'
    return None</code></pre>
<p>The variable&nbsp;<kbd>XSCRIPTCONTEXT</kbd> is created automatically and allowed to get the current component, and from there, the first <kbd>Sheet</kbd>. After that, the sheet is iterated to find the <kbd>Admissions</kbd> column through&nbsp;<kbd>.getCellByPosition&nbsp;</kbd> and obtain the string value with the <kbd>.String</kbd> attribute. With the same method, it aggregates all the values in the column, extracting them through <kbd>.getValue</kbd> to get their numerical values.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>As the loop iterates through the column until finding an empty cell, the second time it's executed it will aggregate the value in <kbd>B12</kbd>, which is the aggregated value in the previous execution. This is done on purpose to show that macros can be executed multiple times, with different results.</p>
</div>
</div>
<p>Cells can also be referenced by their string position through <kbd>.getCellRangeByName</kbd>, to store <kbd>Total</kbd> in cell <kbd>A15</kbd>.</p>
<h3>There's more...</h3>
<p>The Python interpreter is embedded into LibreOffice, meaning that the specific version can change if LibreOffice changes. In the latest version of LibreOffice at the time of writing this book (6.0.5), the version included was Python 3.5.1.</p>
<p>The UNO interface is very complete and allows you to access a lot of advanced elements. Unfortunately, the documentation is not great, and achieving it can be complicated and time consuming. The documentation is defined in Java or C++, and there are examples in LibreOffice BASIC or other languages, but few for Python. The full documentation can be found at: <a href="https://api.libreoffice.org/">https://api.libreoffice.org/</a>, and the reference is here:</p>
<p><a href="https://api.libreoffice.org/docs/idl/ref/index.html">https://api.libreoffice.org/docs/idl/ref/index.html</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>For example, it is possible to create&nbsp;complex charts or even interactive dialogs that ask for and process responses from the user. There's a lot of information in forums and old answers. The code in BASIC is also adaptable to Python most of the time.</p>
</div>
</div>
<p>LibreOffice is a fork of a previous project called OpenOffice. UNO was already available, meaning that some references will be found when searching the internet that refer to OpenOffice.</p>
<p>Remember that LibreOffice is capable of&nbsp;reading and writing Excel files.&nbsp;Some features may not be 100% compatible;&nbsp;for example, there may be formatting issues.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>For the same reason, it is totally possible to generate a file in Excel format with the tools described in other recipes of this chapter and open it with LibreOffice. That can be a good approach as the documentation is better for <kbd>openpyxl</kbd>.</p>
</div>
</div>
<p>Debugging can also be tricky on occasion. Remember to ensure that a file is fully closed before reopening it with new code.</p>
<p>UNO is also capable of working with other parts of the LibreOffice suite, such as for creating documents.</p>
<h3>See also</h3>
<ul>
<li>The <em>Writing a CSV spreadsheet</em> recipe</li>
<li>The <em>Updating an Excel spreadsheet and adding comments and formulas</em> recipe</li>
</ul>

</div>

<!--Chapter 7-->

<div class="chapter" data-chapter-number="7">
<div class="chapter-start">
<div class="ch-head">Chapter <span class="chapter-number"> 7 </span></div>
<h1 class="chaptertitle">Developing Stunning Graphs</h1>
<h3 class="author">Jaime Buelta</h3>
</div>


<p>The following recipes will be covered in this chapter:</p>
<ul>
<li>Plotting a simple sales graph</li>
<li>Drawing stacked bars</li>
<li>Plotting pie charts</li>
<li>Displaying multiple lines</li>
<li>Drawing a scatter plot</li>
<li>Visualizing maps</li>
<li>Adding legends and annotations</li>
<li>Combining graphs</li>
<li>Saving charts</li>
</ul>
<h2>Introduction</h2>
<p>Graphs and images are fantastic ways of presenting complex data in a way that's easily understandable. In this chapter, we will make use of the powerful <kbd>matplotlib</kbd>&nbsp;library to learn how to create all kinds of graphs. <kbd>matplotlib</kbd> is a library that's aimed at displaying data in multiple ways, and it can create absolute stunning plots that will help transmit and display information in the best way.</p>
<p>The graphs we'll cover will go from simple bar graphs to line or pie charts, and combine multiple plots in the same graph, annotate them, or even draw geographical maps.</p>
<h2>Plotting a simple sales graph</h2>
<p>In this recipe, we'll see how to draw a sales graph by drawing bars proportional to sales in different periods.</p>
<h3>Getting ready</h3>
<p>We can install <kbd>matplotlib</kbd> in our virtual environment using the following commands:</p>
<pre><code class="lang-python">$ echo "matplotlib==2.2.2" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>In some OSes, this may require us to install additional packages; for example, in Ubuntu it may require us to run&nbsp;<kbd>apt-get install python3-tk</kbd>. Check the <kbd>matplolib</kbd> docs for details.</p>
<p>If you are using macOS, it's possible that you'll get an error like this&mdash;<kbd>RuntimeError: Python is not installed as a framework</kbd>. See the <kbd>matplolib</kbd> documentation on how to fix it:&nbsp;<a href="https://matplotlib.org/faq/osx_framework.html">https://matplotlib.org/faq/osx_framework.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>matplotlib</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import matplotlib.pyplot as plt</code></pre>
<ol start="2">
<li>Prepare the data to be displayed on the graph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; DATA = (
...    ('Q1 2017', 100),
...    ('Q2 2017', 150),
...    ('Q3 2017', 125),
...    ('Q4 2017', 175),
... )</code></pre>
<ol start="3">
<li>Split the data into usable formats for the graph. This is a preparation step:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; POS = list(range(len(DATA)))
&gt;&gt;&gt; VALUES = [value for label, value in DATA]
&gt;&gt;&gt; LABELS = [label for label, value in DATA]</code></pre>
<ol start="4">
<li>Create a bar graph with the data:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.bar(POS, VALUES)
&gt;&gt;&gt; plt.xticks(POS, LABELS)
&gt;&gt;&gt; plt.ylabel('Sales')</code></pre>
<ol start="5">
<li>Display the graph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.show()</code></pre>
<ol start="6">
<li>The result will be displayed as follows in a new window:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000048.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>After importing the module, the data is presented in step 2 from the <em>How to do it&hellip;</em> section in a convenient way, which will likely be similar to the way the data was originally stored.</p>
<p>Because of the way <kbd>matplotlib</kbd> works, it requires an <em>X</em> component as well as a <em>Y</em> component. In this case, our <em>X</em> component is just a sequence of integers, as many as data points. We create that in <kbd>POS</kbd>. In <kbd>VALUES</kbd>, we store the numeric value of the sales as a sequence, and in <kbd>LABELS</kbd> the associated label for each data point. All that preparation work is done in step 3.</p>
<p>Step 4 creates the bar graph, with the sequences <em>X</em> (<kbd>POS</kbd>) and <em>Y</em> (<kbd>VALUES</kbd>). These define our bars. To specify the period it refers to, we put labels on the <em>x</em> axis for each value with <kbd>.xticks</kbd>&nbsp;in the same way. To clarify the meaning, we add a label with&nbsp;<kbd>.ylabel</kbd>.</p>
<p>To display the resulting&nbsp; graph, step 5 calls <kbd>.show</kbd>, which opens a new window with the result.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Calling <kbd>.show</kbd> blocks the execution of the program. The program will resume when the window is closed.</p>
</div>
</div>
<h3>There's more...</h3>
<p>You may want to change the format in which the values are presented. In our example, maybe the numbers represent millions of dollars. To do so, you can add a formatter to the <em>y</em> axis, so the values represented there will have it applied to them:</p>
<pre><code class="lang-python">&gt;&gt;&gt; from matplotlib.ticker import FuncFormatter

&gt;&gt;&gt; def value_format(value, position):
...    return '$ {}M'.format(int(value))

&gt;&gt;&gt; axes = plt.gca()
&gt;&gt;&gt; axes.yaxis.set_major_formatter(FuncFormatter(value_format))</code></pre>
<p><kbd>value_format</kbd> is a function that returns a value based on the value and position of the data. Here, it will return the value 100 as <kbd>$ 100 M</kbd>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Values will be retrieved as floats, requiring you to transform them into integers for display.</p>
</div>
</div>
<p>To apply the formatter, we need to retrieve the <kbd>axis</kbd> object with <kbd>.gca</kbd> (get current axes). Then, the <kbd>.yaxis</kbd> gets the formatter.</p>
<p>The color of the bars can also be determined with the <kbd>color</kbd> parameter.&nbsp;Colors can be specified in multiple formats, as described in <a href="https://matplotlib.org/api/colors_api.html">https://matplotlib.org/api/colors_api.html</a>, but my favorite&nbsp;is following the XKCD color survey, using the <kbd>xkcd:</kbd> prefix (no space after the colon):</p>
<pre><code class="lang-python">&gt;&gt;&gt; plt.bar(POS, VALUES, color='xkcd:moss green')</code></pre>
<p>The full survey can be found here:&nbsp;<a href="https://xkcd.com/color/rgb/">https://xkcd.com/color/rgb/</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Most common colors, such as blue or red, are also available for quick tests. They tend to be a little bright to be used in good-looking reports, though.</p>
</div>
</div>
<p>Combining the color with formatting the axis gives the following result:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000064.png" class="lazyload" /></p>
<p>Bar graphs don't need to display information in a temporal way.&nbsp;As we've seen,&nbsp;<kbd>matplotlib</kbd>&nbsp;requires us to specify the <em>X</em> parameter of each bar. That's a powerful tool to generate all kinds of graphs.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>For example, the bars can be arranged to display a histogram, such as for displaying people of a certain height. The bars will start at a low height, increase to the average size, and then drop back. Don't limit yourself to just spreadsheet charts!</p>
</div>
</div>
<p>The full <kbd>matplotlib</kbd> documentation can be found here:&nbsp;<a href="https://matplotlib.org/">https://matplotlib.org/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Drawing stacked bars</em> recipe</li>
<li>The <em>Adding legends and annotations</em> recipe</li>
<li>The <em>Combining graphs</em> recipe</li>
</ul>
<h2>Drawing stacked bars</h2>
<p>A powerful way of displaying different categories is to present them as stacked bars, so each of the categories and the total are displayed. We'll see in this recipe how to do that.</p>
<h3>Getting ready</h3>
<p>We need to install&nbsp;<kbd>matplotlib</kbd>&nbsp;in our virtual environment:</p>
<pre><code class="lang-python">$ echo "matplotlib==2.2.2" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>If you are using macOS, it's possible that you get an error like this:&nbsp;<kbd>RuntimeError: Python is not installed as a framework</kbd>. See the&nbsp;<kbd>matplolib</kbd>&nbsp;documentation on how to fix it:&nbsp;<a href="https://matplotlib.org/faq/osx_framework.html">https://matplotlib.org/faq/osx_framework.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>matplotlib</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import matplotlib.pyplot as plt</code></pre>
<ol start="2">
<li>Prepare the data. This represents two products' sales, one established, and a new one:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; DATA = (
...     ('Q1 2017', 100, 0),
...     ('Q2 2017', 105, 15),
...     ('Q3 2017', 125, 40),
...     ('Q4 2017', 115, 80),
... )</code></pre>
<ol start="3">
<li>Process the data to prepare the expected format:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; POS = list(range(len(DATA)))
&gt;&gt;&gt; VALUESA = [valueA for label, valueA, valueB in DATA]
&gt;&gt;&gt; VALUESB = [valueB for label, valueA, valueB in DATA]
&gt;&gt;&gt; LABELS = [label for label, value1, value2 in DATA]</code></pre>
<ol start="4">
<li>Create the bar plot. Two plots are required:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.bar(POS, VALUESB)
&gt;&gt;&gt; plt.bar(POS, VALUESA, bottom=VALUESB)
&gt;&gt;&gt; plt.ylabel('Sales')
&gt;&gt;&gt; plt.xticks(POS, LABELS)</code></pre>
<ol start="5">
<li>Display the graph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.show()</code></pre>
<ol start="6">
<li>The result will be displayed in a new window as follows:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000037.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>After importing the module, the data is presented in step 2 in a convenient way, which will likely be similar to the way the data was originally stored.</p>
<p>In step 3, the data is prepared in three sequences, <kbd>VALUESA</kbd>, <kbd>VALUEB</kbd>, and <kbd>LABELS</kbd>. A <kbd>POS</kbd> sequence to correctly position the bars is added.</p>
<p>Step 4 creates the bar graph, with the sequences <em>X</em> (<kbd>POS</kbd>) and <em>Y</em> (<kbd>VALUESB</kbd>). The second bar sequence, <kbd>VALUESA</kbd>, is added on top of the previous one, using the <kbd>bottom</kbd> parameter. This stacks the bars.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Notice that we stack the second value, <kbd>VALUESB</kbd>, first. The second value represents a new product introduced in the market, while <kbd>VALUESA</kbd> is more stable. This better&nbsp;shows the growth of the new product.</p>
</div>
</div>
<p>Each of the periods is labeled on the <em>X</em> axis with&nbsp;<kbd>.xticks</kbd>. To clarify the meaning, we add a label with&nbsp;<kbd>.ylabel</kbd>.</p>
<p>To display the resulting graph, step 5 calls <kbd>.show</kbd>, which opens a new window with the result.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Calling <kbd>.show</kbd> blocks the execution of the program. The program will resume when the window is closed.</p>
</div>
</div>
<h3>There's more...</h3>
<p>Another way of presenting stacked bars is adding them as percentages, so the total doesn't change, only the relative sizes compared to each other.</p>
<p>To do that, <kbd>VALUESA</kbd> and <kbd>VALUEB</kbd> need to be calculated relative to the percentages in this way:</p>
<pre><code class="lang-python">&gt;&gt;&gt; VALUESA = [100 * valueA / (valueA + valueB) for label, valueA, valueB in DATA]
&gt;&gt;&gt; VALUESB = [100 * valueB / (valueA + valueB) for label, valueA, valueB in DATA]</code></pre>
<p>This makes each value equal to the percentage of the total, and the total always adds up to <kbd>100</kbd>. This produces the following graphic:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000017.png" class="lazyload" /></p>
<p>The bars doesn't necessarily need to be stacked. Sometimes, it may be interesting to present the bars one against the other for comparison.&nbsp;</p>
<p>To do that, we need to move the position of the second bar sequence. We'll need also to set thinner bars to allow space:</p>
<pre><code class="lang-python">&gt;&gt;&gt; WIDTH = 0.3
&gt;&gt;&gt; plt.bar([p - WIDTH / 2 for p in POS], VALUESA, width=WIDTH)
&gt;&gt;&gt; plt.bar([p + WIDTH / 2 for p in POS], VALUESB, width=WIDTH)</code></pre>
<p>Note how the width of the bar is set to a third of the space, as our reference space is <kbd>1</kbd> between the bars. The first bar is moved to the left and the second to the right to center them. The <kbd>bottom</kbd> argument has been deleted to not stack the bars:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000031.png" class="lazyload" /></p>
<p>The full&nbsp;<kbd>matplotlib</kbd>&nbsp;documentation can be found here:&nbsp;<a href="https://matplotlib.org/">https://matplotlib.org/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Plotting a simple sales graph</em> recipe</li>
<li>The <em>Adding legends and annotations</em> recipe</li>
<li>The <em>Combining graphs</em> recipe</li>
</ul>
<h2>Plotting pie charts</h2>
<p>Pie charts! A Business 101 favorite, and a common way of presenting percentages. We'll see in this recipe how to plot a pie chart, with different slices representing proportions.</p>
<h3>Getting ready</h3>
<p>We need to install&nbsp;<kbd>matplotlib</kbd>&nbsp;in our virtual environment using the following commands:</p>
<pre><code class="lang-python">$ echo "matplotlib==2.2.2" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>If you are using macOS, it's possible that you get an error like this&mdash;<kbd>RuntimeError: Python is not installed as a framework</kbd>. See the&nbsp;<kbd>matplotlib</kbd>&nbsp;documentation on how to fix it:&nbsp;<a href="https://matplotlib.org/faq/osx_framework.html">https://matplotlib.org/faq/osx_framework.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>matplotlib</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import matplotlib.pyplot as plt</code></pre>
<ol start="2">
<li>Prepare the data. This represents several lines of products:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; DATA = (
...     ('Common', 100),
...     ('Premium', 75),
...     ('Luxurious', 50),
...     ('Extravagant', 20),
... )</code></pre>
<ol start="3">
<li>Process the data to prepare the expected format:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; VALUES = [value for label, value in DATA]
&gt;&gt;&gt; LABELS = [label for label, value in DATA]</code></pre>
<ol start="4">
<li>Create the pie chart:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.pie(VALUES, labels=LABELS, autopct='%1.1f%%')
&gt;&gt;&gt; plt.gca().axis('equal')</code></pre>
<ol start="5">
<li>Display the graph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.show()</code></pre>
<ol start="6">
<li>The result will be displayed in a new window as follows:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000046.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>The module is imported in step 1 of the <em>How to do it&hellip;</em> section, and the data to present is imported in step 2. The data is separated into two components, a list of <kbd>VALUES</kbd> and a list of <kbd>LABELS</kbd>, in step 3.</p>
<p>The creation of the chart happens in step 4. The pie chart is created by adding <kbd>VALUES</kbd> and <kbd>LABELS</kbd>. The&nbsp;<kbd>autopct</kbd>&nbsp;parameter formats the value so it displays it as a percentage to a single decimal place.&nbsp;</p>
<p>The call to <kbd>axis</kbd>&nbsp;ensure&nbsp;the pie chart will look round, instead of having a bit of perspective and appearing as an oval.</p>
<p>To display the resulting&nbsp; graph, step 5 calls&nbsp;<kbd>.show</kbd>, which opens a new window with the result.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Calling&nbsp;<kbd>.show</kbd>&nbsp;blocks the execution of the program. The program will resume when the window is closed.</p>
</div>
</div>
<h3>There's more...</h3>
<p>Pie charts are a little overused in business graphs. Most of the time, a bar chart with percentages or values will be a better way of visualizing&nbsp;the data, especially if more than two or three options are displayed. Try to limit the use of pie charts in your reports and data presentations.</p>
<p>Rotating the start of the wedges is possible with the&nbsp;<kbd>startangle</kbd>&nbsp;parameter, and the direction to set up the wedges is defined by <kbd>counterclock</kbd> (defaults to&nbsp; <kbd>True</kbd>):</p>
<pre><code class="lang-python">&gt;&gt;&gt; plt.pie(VALUES, labels=LABELS, startangle=90, counterclock=False)</code></pre>
<p>The format inside the label can be set by a function. As the value inside the pie is defined as a percentage, finding the original value can be a little tricky. The following snippet creates a dictionary indexing by its percentage as an integer, so we can retrieve the referenced value.&nbsp;Please note that this assumes that no percentage gets repeated. If that's the case, the labels may be slightly incorrect. In that case, we may need to use up to the first decimal place for better precision:</p>
<pre><code class="lang-python">&gt;&gt;&gt; from matplotlib.ticker import FuncFormatter

&gt;&gt;&gt; total = sum(value for label, value in DATA)
&gt;&gt;&gt; BY_VALUE = {int(100 * value / total): value for label, value in DATA}

&gt;&gt;&gt; def value_format(percent, **kwargs):
...     value = BY_VALUE[int(percent)]
...     return '{}'.format(value)</code></pre>
<p>One or more wedges can also be separated by using the explode parameter. This specifies how separated the wedge is from the center:</p>
<pre><code class="lang-python">&gt;&gt;&gt; explode = (0, 0, 0.1, 0)
&gt;&gt;&gt; plt.pie(VALUES, labels=LABELS, explode=explode, autopct=value_format,
            startangle=90, counterclock=False)</code></pre>
<p>Combining all these options, we get the following result:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000022.png" class="lazyload" /></p>
<p>The full&nbsp;<kbd>matplotlib</kbd>&nbsp;documentation can be found here:&nbsp;<a href="https://matplotlib.org/">https://matplotlib.org/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Plotting a simple sales graph</em> recipe</li>
<li>The <em>Drawing stacked bars</em> recipe</li>
</ul>
<h2>Displaying multiple lines</h2>
<p>This recipe will show how to display multiple lines in a graph.</p>
<h3>Getting ready</h3>
<p>We need to install&nbsp;<kbd>matplotlib</kbd>&nbsp;in our virtual environment:</p>
<pre><code class="lang-python">$ echo "matplotlib==2.2.2" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>If you are using macOS, it's possible that you get an error like this&mdash;<kbd>RuntimeError: Python is not installed as a framework</kbd>. See the&nbsp;<kbd>matplolib</kbd>&nbsp;documentation on how to fix it:&nbsp;<a href="https://matplotlib.org/faq/osx_framework.html">https://matplotlib.org/faq/osx_framework.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>matplotlib</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import matplotlib.pyplot as plt</code></pre>
<ol start="2">
<li>Prepare the data. This represents two products' sales:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; DATA = (
...     ('Q1 2017', 100, 5),
...     ('Q2 2017', 105, 15),
...     ('Q3 2017', 125, 40),
...     ('Q4 2017', 115, 80),
... )</code></pre>
<ol start="3">
<li>Process the data to prepare the expected format:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; POS = list(range(len(DATA)))
&gt;&gt;&gt; VALUESA = [valueA for label, valueA, valueB in DATA]
&gt;&gt;&gt; VALUESB = [valueB for label, valueA, valueB in DATA]
&gt;&gt;&gt; LABELS = [label for label, value1, value2 in DATA]</code></pre>
<ol start="4">
<li>Create the line plot. Two lines are required:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.plot(POS, VALUESA, 'o-')
&gt;&gt;&gt; plt.plot(POS, VALUESB, 'o-')
&gt;&gt;&gt; plt.ylabel('Sales')
&gt;&gt;&gt; plt.xticks(POS, LABELS)</code></pre>
<ol start="5">
<li>Display the graph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.show()</code></pre>
<ol start="6">
<li>The result will be displayed in a new window:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000015.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>In the <em>How to do it&hellip;</em> section, step 1 imports the module and step 2 shows the data to be plotted in a formatted way.</p>
<p>In step 3, the data is prepared in three sequences,&nbsp;<kbd>VALUESA</kbd>,&nbsp;<kbd>VALUEB</kbd>,&nbsp;and&nbsp;<kbd>LABELS</kbd>. A&nbsp;<kbd>POS</kbd>&nbsp;sequence to correctly position each point is added.</p>
<p>Step 4 creates the graph, with the sequences <em>X</em> (<kbd>POS</kbd>) and <em>Y</em> (<kbd>VALUESA</kbd>), and then <kbd>POS</kbd> and <kbd>VALUESB</kbd>. The value of <kbd>'o-'</kbd> is added to draw a circle on each of the data points and a full line between them.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>By default, the plot will display a solid line, with no marker on each point. If only the marker is used (that is,&nbsp;<kbd>'o'</kbd>), there'll be no line.</p>
</div>
</div>
<p>Each of the periods is labeled on the <em>X</em> axis with&nbsp;<kbd>.xticks</kbd>. To clarify the meaning, we add a label with&nbsp;<kbd>.ylabel</kbd>.</p>
<p>To display the resulting graph, step 5 calls&nbsp;<kbd>.show</kbd>, which opens a new window with the result.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Calling&nbsp;<kbd>.show</kbd>&nbsp;blocks the execution of the program. The program will resume when the window is closed.</p>
</div>
</div>
<h3>There's more...</h3>
<p>Graphs with lines are deceptively simple and able to create a lot of interesting representations. It is probably the most convenient when showing mathematical graphs. For example, we can display a graph showing Moore's Law in a few lines of code.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Moore's Law is an observation by Gordon Moore that the number of components in an integrated circuit doubles every two years. It was first described in 1965 and then corrected in 1975. It seems to be quite close to the historic rate of technological advancement over the last 40 years.</p>
</div>
</div>
<p>We first create a line describing the theoretical line, with data points from 1970 to 2013. Starting with 1000 transistors, we double it every two years, up to 2013:</p>
<pre><code class="lang-python">&gt;&gt;&gt; POS = [year for year in range(1970, 2013)]
&gt;&gt;&gt; MOORES = [1000 * (2 ** (i * 0.5)) for i in range(len(POS))]
&gt;&gt;&gt; plt.plot(POS, MOORES)</code></pre>
<p>Following some documentation, we extract a few examples of commercial CPUs, their year of release, and their number of integrated components from here:&nbsp;<a href="http://www.wagnercg.com/Portals/0/FunStuff/AHistoryofMicroprocessorTransistorCount.pdf">http://www.wagnercg.com/Portals/0/FunStuff/AHistoryofMicroprocessorTransistorCount.pdf</a>. Due to the big numbers, we'll use the notation of&nbsp;<kbd>1_000_000</kbd> for a million, available in Python 3:</p>
<pre><code class="lang-python">&gt;&gt;&gt; DATA = (
...    ('Intel 4004', 2_300, 1971),
...    ('Motorola 68000', 68_000, 1979),
...    ('Pentium', 3_100_000, 1993),
...    ('Core i7', 731_000_000, 2008),
... )</code></pre>
<p>Draw a line with markers to display those points at the proper places. The <kbd>'v'</kbd>&nbsp;mark&nbsp;will display a triangle:</p>
<pre><code class="lang-python">&gt;&gt;&gt; data_x = [x for label, y, x in DATA]
&gt;&gt;&gt; data_y = [y for label, y, x in DATA]
&gt;&gt;&gt; plt.plot(data_x, data_y, 'v')</code></pre>
<p>For each data point, append a label in the proper place with the name of the CPU:</p>
<pre><code class="lang-python">&gt;&gt;&gt; for label, y, x in DATA:
&gt;&gt;&gt;    plt.text(x, y, label)</code></pre>
<p>Finally, growth doesn't make sense displayed in a linear graph, so we change the scale to be logarithmic, which makes exponential growth look like a straight line. But to keep the sense of dimension, add a grid. Call <kbd>.show</kbd> to display the graph:</p>
<pre><code class="lang-python">&gt;&gt;&gt; plt.gca().grid()
&gt;&gt;&gt; plt.yscale('log')</code></pre>
<p>The resulting graph will be displayed:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000020.png" class="lazyload" /></p>
<p>The full&nbsp;<kbd>matplotlib</kbd>&nbsp;documentation can be found here:&nbsp;<a href="https://matplotlib.org/">https://matplotlib.org/</a>. In particular, check the available formats for the lines (solid, dashed, dotted, and so on) and markers (dot, circle, triangle, star, and so on) here:&nbsp;<a href="https://matplotlib.org/api/_as_gen/matplotlib.pyplot.plot.html">https://matplotlib.org/api/_as_gen/matplotlib.pyplot.plot.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Adding legends and annotations</em> recipe</li>
<li>The <em>Combining graphs</em> recipe</li>
</ul>
<h2>Drawing a scatter plot</h2>
<p>A scatter plot is one where the information is only displayed as dots with <em>X</em> and <em>Y</em> values. They are very useful when presenting samples and to see whether there's any relationship between two variables. In this recipe, we'll display a graph plotting time spent on a website against money spent, to see whether we can see a pattern.</p>
<h3>Getting ready</h3>
<p>We need to install&nbsp;<kbd>matplotlib</kbd>&nbsp;in our virtual environment:</p>
<pre><code class="lang-python">$ echo "matplotlib==2.2.2" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>If you are using macOS, it's possible that you get an error like this&mdash;<kbd>RuntimeError: Python is not installed as a framework</kbd>. See the&nbsp;<kbd>matplolib</kbd>&nbsp;documentation on how to fix it:&nbsp;<a href="https://matplotlib.org/faq/osx_framework.html">https://matplotlib.org/faq/osx_framework.html</a>.</p>
<p>As data points, we'll use the <kbd>scatter.csv</kbd>&nbsp;file&nbsp;to read the data. This file is available on GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter07/scatter.csv">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter07/scatter.csv</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import&nbsp;<kbd>matplotlib</kbd> and <kbd>csv</kbd>. <kbd>FuncFormatter</kbd> is also imported to format the axes later:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import csv
&gt;&gt;&gt; import matplotlib.pyplot as plt
&gt;&gt;&gt; from matplotlib.ticker import FuncFormatter</code></pre>
<ol start="2">
<li>Prepare the data, reading from&nbsp;the file using the <kbd>csv</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('scatter.csv') as fp:
...    reader = csv.reader(fp)
...    data = list(reader)</code></pre>
<ol start="3">
<li>Prepare the data for plotting, and then plot it:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; data_x = [float(x) for x, y in data]
&gt;&gt;&gt; data_y = [float(y) for x, y in data]
&gt;&gt;&gt; plt.scatter(data_x, data_y)</code></pre>
<ol start="4">
<li>Improve the context by formatting the axes:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; def format_minutes(value, pos):
...     return '{}m'.format(int(value))
&gt;&gt;&gt; def format_dollars(value, pos):
...     return '${}'.format(value)
&gt;&gt;&gt; plt.gca().xaxis.set_major_formatter(FuncFormatter(format_minutes))
&gt;&gt;&gt; plt.xlabel('Time in website')
&gt;&gt;&gt; plt.gca().yaxis.set_major_formatter(FuncFormatter(format_dollars))
&gt;&gt;&gt; plt.ylabel('Spending')</code></pre>
<ol start="5">
<li>Show the graph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.show()</code></pre>
<ol start="6">
<li>The result will be displayed in a new window:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000030.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>Steps 1 and 2 of the <em>How to do it&hellip;</em> section import the modules we'll use later and read the data from the CSV file. The data is transformed into a list to allow us to iterate through it several times, as that's necessary in step 3.</p>
<p>Step 3 prepares the data in two arrays, and then uses <kbd>.scatter</kbd> to plot them. The parameters for <kbd>.scatter</kbd>, as with other methods of <kbd>matplotlib</kbd>, require an array of <em>X</em>&nbsp;and <em>Y</em> values. They both need to have the same size. The data is converted into <kbd>float</kbd> from the file format, to ensure the number format.</p>
<p>Step 4 refines the way the data is presented on each of the axis. The same operation is presented twice&mdash;a function is created that define how the values on that axis should be displayed (in dollars or in minutes). The function accepts as input the value to display and the position. Typically, the position will be ignored. The axis formatter will be overwritten with <kbd>.set_major_formatter</kbd>. Notice that both axes are returned with <kbd>.gca</kbd> (get current axes).</p>
<p>A label is added to the axes with <kbd>.xlabel</kbd> and <kbd>.ylabel</kbd>.</p>
<p>Finally, step 5 displays the graph in a new window. Analyzing the result, we can say that there seem to be two kinds of users, ones who spend less that 10 minutes and never spend more than $10, and users who spend more time and also have a higher chance of spending up to $100.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Note that the data presented&nbsp;is synthetic, and it has been generated with the result in mind. Real-life data will probably look more spread out.</p>
</div>
</div>
<h3>There's more...</h3>
<p>A scatter plot can display not only points in two dimensions, but also add a third (area) and even a fourth dimension (color).</p>
<p>To add those elements, use the parameters <kbd>s</kbd> for <em>size</em>&nbsp;and <kbd>c</kbd> for <em>color</em>.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Size is defined as the diameter of a ball&nbsp;in points&nbsp;squared. So, for a ball of diameter 10, 100 will be used. Color can use any of the usual definitions of color in <kbd>matplotlib</kbd>,&nbsp; such as hex color, RGB, and so on. See the documentation for more details:&nbsp;<a href="https://matplotlib.org/users/colors.html">https://matplotlib.org/users/colors.html</a>.</p>
</div>
</div>
<p>For example, we can generate a random graph using the four dimensions in the following way:</p>
<pre><code class="lang-python">&gt;&gt;&gt; import matplotlib.pyplot as plt
&gt;&gt;&gt; import random
&gt;&gt;&gt; NUM_POINTS = 100
&gt;&gt;&gt; COLOR_SCALE = ['#FF0000', '#FFFF00', '#FFFF00', '#7FFF00', '#00FF00']
&gt;&gt;&gt; data_x = [random.random() for _ in range(NUM_POINTS)]
&gt;&gt;&gt; data_y = [random.random() for _ in range(NUM_POINTS)]
&gt;&gt;&gt; size = [(50 * random.random()) ** 2 for _ in range(NUM_POINTS)]
&gt;&gt;&gt; color = [random.choice(COLOR_SCALE) for _ in range(NUM_POINTS)]
&gt;&gt;&gt; plt.scatter(data_x, data_y, s=size, c=color, alpha=0.5)
&gt;&gt;&gt; plt.show()</code></pre>
<p><kbd>COLOR_SCALE</kbd> goes from green to red, and the size of each of the points will be between <kbd>0</kbd> and <kbd>50</kbd> points in diameter. The result should be something like this:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000004.png" class="lazyload" /></p>
<p>Note that it is random, so each time it will generate a different graph.</p>
<p>The <kbd>alpha</kbd> value makes each of the points semitransparent, allowing us to see where they overlap. The higher this value is, the less transparent the points will be. This parameter will affect the displayed color, as it will blend the point with the background.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Even though it's possible to display two independent values in the size and color, they can also be related to any of the other values. For example, making the color dependent on the size will make all the points of the same size the same color, which may help distinguish the data. Remember that the ultimate goal of a graph is to make data easy to understand. Try different approaches to improve this.</p>
</div>
</div>
<p>The full&nbsp;<kbd>matplotlib</kbd>&nbsp;documentation can be found here:&nbsp;<a href="https://matplotlib.org/">https://matplotlib.org/</a>.&nbsp;</p>
<h3>See also</h3>
<ul>
<li>The <em>Displaying multiple lines</em> recipe</li>
<li>The <em>Adding legends and annotations</em> recipe</li>
</ul>
<h2>Visualizing&nbsp;maps</h2>
<p>To show information that changes from region to region, the best way is to display a map that presents the information, while at the same time giving a regional sense of position and location for the data.</p>
<p>In this recipe, we'll make use of the <kbd>fiona</kbd> module to import GIS information, as well as <kbd>matplotlib</kbd> to display the information. We will display a map of Western Europe and display the population of each country with a color grade. The darker the color, the larger the population.</p>
<h3>Getting ready</h3>
<p>We need to install&nbsp;<kbd>matplotlib</kbd>&nbsp;and <kbd>fiona</kbd>&nbsp;in our virtual environment:</p>
<pre><code class="lang-python">$ echo "matplotlib==2.2.2" &gt;&gt; requirements.txt
$ echo "Fiona==1.7.13" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>If you are using macOS, it's possible that you get an error like this&mdash;<kbd>RuntimeError: Python is not installed as a framework</kbd>. See the&nbsp;<kbd>matplolib</kbd>&nbsp;documentation on how to fix it:&nbsp;<a href="https://matplotlib.org/faq/osx_framework.html">https://matplotlib.org/faq/osx_framework.html</a>.</p>
<p>The map data needs to be downloaded. Fortunately, there's a lot of freely available data for geographic information. A search on Google should&nbsp;quickly&nbsp;return almost everything you need, including detailed information on regions, counties, rivers, or any other kind of data.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>GIS information is available in different formats from a lot of public organizations. <kbd>fiona</kbd> is capable of understanding most common formats and treating them in equivalent ways, but there are small differences. Read the <kbd>fiona</kbd> documentation for more details.</p>
</div>
</div>
<p>The data we'll use in this recipe, covering all European countries, is available on GitHub at the following URL:&nbsp;&nbsp;<a href="https://github.com/leakyMirror/map-of-europe/blob/master/GeoJSON/europe.geojson">https://github.com/leakyMirror/map-of-europe/blob/master/GeoJSON/europe.geojson</a>. Note it is in GeoJSON, which is an easy standard to work with.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the modules to be used later:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import matplotlib.pyplot as plt
&gt;&gt;&gt; import matplotlib.cm as cm
&gt;&gt;&gt; import fiona</code></pre>
<ol start="2">
<li>Load the population of the countries to display. The population has been:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; COUNTRIES_POPULATION = {
...     'Spain': 47.2,
...     'Portugal': 10.6,
...     'United Kingdom': 63.8,
...     'Ireland': 4.7,
...     'France': 64.9,
...     'Italy': 61.1,
...     'Germany': 82.6,
...     'Netherlands': 16.8,
...     'Belgium': 11.1,
...     'Denmark': 5.6,
...     'Slovenia': 2,
...     'Austria': 8.5,
...     'Luxembourg': 0.5,
...     'Andorra': 0.077,
...     'Switzerland': 8.2,
...     'Liechtenstein': 0.038,
... }
&gt;&gt;&gt; MAX_POPULATION = max(COUNTRIES_POPULATION.values())
&gt;&gt;&gt; MIN_POPULATION = min(COUNTRIES_POPULATION.values())</code></pre>
<ol start="3">
<li>Prepare the <kbd>colormap</kbd>, which will determine the color each country will be displayed in a shade of green. Calculate which color corresponds to each country:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; colormap = cm.get_cmap('Greens')
&gt;&gt;&gt; COUNTRY_COLOUR = {
...     country_name: colormap(
...         (population - MIN_POPULATION) / (MAX_POPULATION - MIN_POPULATION)
...     )
...     for country_name, population in COUNTRIES_POPULATION.items()
... }</code></pre>
<ol start="4">
<li>Open the file and read the data, filtering by the countries we defined the population of in step 1:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with fiona.open('europe.geojson') as fd:
&gt;&gt;&gt;     full_data = [data for data in full_data
...                  if data['properties']['NAME'] in COUNTRIES_POPULATION]</code></pre>
<ol start="5">
<li>Plot each of the countries in the proper color:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; for data in full_data:
...     country_name = data['properties']['NAME']
...     color = COUNTRY_COLOUR[country_name]
...     geo_type = data['geometry']['type']
...     if geo_type == 'Polygon':
...         data_x = [x for x, y in data['geometry']['coordinates'][0]]
...         data_y = [y for x, y in data['geometry']['coordinates'][0]]
...         plt.fill(data_x, data_y, c=color)
...     elif geo_type == 'MultiPolygon':
...         for coordinates in data['geometry']['coordinates']:
...             data_x = [x for x, y in coordinates[0]]
...             data_y = [y for x, y in coordinates[0]]
...             plt.fill(data_x, data_y, c=color)</code></pre>
<ol start="6">
<li>Display the result:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.show()</code></pre>
<ol start="7">
<li>The result will be displayed in a new window:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000060.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>After importing the modules in step 1 from the <em>How to do it&hellip;</em> section, the data to be displayed is defined in step 2. Note that the names need to be in the same format as they'll be in the GEO file. The minimum and maximum populations are calculated to properly balance the range&nbsp;later.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The population has been rounded to a significant number, and it's defined in millions. Only a few countries have been defined for the purposes of this recipe, but there are more available in the GIS file and the map can be extended toward the East.</p>
</div>
</div>
<p>A <kbd>colormap</kbd> defining the color range in shades of green (<kbd>Greens</kbd>) is described in step 3. This is one&nbsp;standard&nbsp;<kbd>colormap</kbd>&nbsp;in <kbd>matplotlib</kbd>, but others described in the documentation can be used (<a href="https://matplotlib.org/examples/color/colormaps_reference.html">https://matplotlib.org/examples/color/colormaps_reference.html</a>), such as&nbsp;oranges,&nbsp;reds, or plasma for a more cold-to-hot approach.&nbsp;</p>
<p>The <kbd>COUNTRY_COLOUR</kbd>&nbsp;dictionary&nbsp;stores the color defined by the <kbd>colormap</kbd> for each country. The population is reduced to a number from 0.0 (least population) to 1.0 (most), and passed to <kbd>colormap</kbd> to retrieve the color at the scale it corresponds to.</p>
<p>The GIS information is&nbsp;then&nbsp;retrieved in step 4. The <kbd>europe.geojson</kbd>&nbsp;file&nbsp;is read using <kbd>fiona</kbd> and the data is copied so we can use it in the next steps. It also&nbsp;filters to only deal with the countries we defined the population of, so no extra countries are plotted.</p>
<p>The loop in step 5 goes country by country, and then we plot it using <kbd>.fill</kbd>, which plots a polygon. The geometry of each of the different countries is either a single polygon (<kbd>Polygon</kbd>) or more than one (<kbd>MultiPolygon</kbd>). In each case, the proper polygons are drawn, all in the same color. This means&nbsp;<kbd>MultiPolygon</kbd>&nbsp;is drawn several times.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>GIS information is stored as points for coordinates describing the latitude and longitude of the point. Areas, such as countries, have a list of coordinates that describe an area within them. Some maps are more precise and have more points defining areas. Multiple polygons may be required to define a country, as some parts may be separated from each other, islands being the most obvious cases, but there are also enclaves.</p>
</div>
</div>
<p>Finally, the data is displayed by calling <kbd>.show</kbd>.</p>
<h3>There's more...</h3>
<p>Taking advantage of the information contained in the GIS file, we can add extra information to the map. The <kbd>properties</kbd>&nbsp;object contains information about the name of the country, but also its ISO name, FID code, and central location as <kbd>LON</kbd> and <kbd>LAT</kbd>. We can use this information to display the name of the country using <kbd>.text</kbd>:</p>
<pre><code class="lang-python">    long, lat = data['properties']['LON'], data['properties']['LAT']
    iso3 = data['properties']['ISO3']
    plt.text(long, lat, iso3, horizontalalignment='center')</code></pre>
<p>This code will live inside the loop in&nbsp;step 6 in the <em>How to do it&hellip;</em> section.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>If you analyze the file, you'll see that the <kbd>properties</kbd> object contains information about the population, stored as POP2005, so you can draw the population info directly from the map. That is left as an exercise. Different map files will contain different information, so be sure to play around to unleash all the possibilities.</p>
</div>
</div>
<p>Also, you may notice that the map may be distorted in some cases. <kbd>matplotlib</kbd> will try to present it in a square box, and if the map is not roughly square, this will be evident. For example, try to display only Spain, Portugal, Ireland, and the UK. We can force the graph to present 1 point of latitude with the same space as 1 point of longitude, which is a good approach if we are not drawing something near the poles. This is achieved by calling <kbd>.set_aspect</kbd> in the axes. Current axes can be obtained through <kbd>.gca</kbd> (<strong>get current axes</strong>)</p>
<pre><code class="lang-python">&gt;&gt;&gt; axes = plt.gca()
&gt;&gt;&gt; axes.set_aspect('equal', adjustable='box')</code></pre>
<p>Also, to improve the look of the map, we can set up a background color that helps to differentiate between the background and the foreground, and remove the labels in the axes, as printing the latitude and longitude is probably distracting. Removing the labels on the axes is achieved by setting empty labels with <kbd>.xticks</kbd> and <kbd>.yticks</kbd>. The background color is mandated by the foreground color of the axes:</p>
<pre><code class="lang-python">&gt;&gt;&gt; plt.xticks([])
&gt;&gt;&gt; plt.yticks([])
&gt;&gt;&gt; axes = plt.gca()
&gt;&gt;&gt; axes.set_facecolor('xkcd:light blue')</code></pre>
<p>Finally, to better differentiate between the different regions, a line surrounding each area can be added. This can be done by drawing a thin line with the same data as&nbsp;<kbd>.fill</kbd>, right after. Notice that this code is repeated twice in step 2:</p>
<pre><code class="lang-python"> plt.fill(data_x, data_y, c=color)
 plt.plot(data_x, data_y, c='black', linewidth=0.2)</code></pre>
<p>Applying all these elements to the map, it now looks like this:&nbsp;</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000070.png" class="lazyload" /></p>
<p>The resulting code is available on&nbsp;GitHub&nbsp;here:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter07/visualising_maps.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter07/visualising_maps.py</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>As we've seen, maps are drawn as general polygons. Don't be afraid to include other geometrical forms. You can define your own polygons and print them with <kbd>.fill</kbd>&nbsp;or some extra labels. For example, far away regions may need to be transported to avoid having too big a&nbsp;map. Or, rectangles can be used to print extra information on top of parts of the map.</p>
</div>
</div>
<p>The full <kbd>fiona</kbd> documentation can be found here:&nbsp;<a href="http://toblerity.org/fiona/">http://toblerity.org/fiona/</a>.&nbsp;The full&nbsp;<kbd>matplotlib</kbd>&nbsp;documentation can be found here:&nbsp;<a href="https://matplotlib.org/">https://matplotlib.org/</a>.&nbsp;</p>
<h3>See also</h3>
<ul>
<li>The <em>Adding legends and annotations</em> recipe</li>
<li>The <em>Combining graphs</em> recipe</li>
</ul>
<h2>Adding legends and annotations</h2>
<p>When drawing graphs with dense information, a legend may be required to determine the specific colors or help better understand the data presented. In <kbd>matplotlib</kbd>, legends can be pretty rich and have multiple ways of presenting them. Annotations to draw attention to specific points are also good ways to focus the message for the audience.</p>
<p>In this recipe, we'll create a graph with three different components and display a legend with information to better understand it, as well as annotating the most interesting points on our graph.</p>
<h3>Getting ready</h3>
<p>We need to install&nbsp;<kbd>matplotlib</kbd>&nbsp;in our virtual environment:</p>
<pre><code class="lang-python">$ echo "matplotlib==2.2.2" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>If you are using macOS, it's possible that you get an error like this&mdash;<kbd>RuntimeError: Python is not installed as a framework</kbd>. See the&nbsp;<kbd>matplolib</kbd>&nbsp;documentation on how to fix it:&nbsp;<a href="https://matplotlib.org/faq/osx_framework.html">https://matplotlib.org/faq/osx_framework.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import&nbsp;<kbd>matplotlib</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import matplotlib.pyplot as plt</code></pre>
<ol start="2">
<li>Prepare the data to be displayed on the graph, and the legends that should be displayed. Each of the lines is composed of the time label, sales of <kbd>ProductA</kbd>, sales of <kbd>ProductB</kbd>, and sales of <kbd>ProductC</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; LEGEND = ('ProductA', 'ProductB', 'ProductC')
&gt;&gt;&gt; DATA = (
...     ('Q1 2017', 100, 30, 3),
...     ('Q2 2017', 105, 32, 15),
...     ('Q3 2017', 125, 29, 40),
...     ('Q4 2017', 115, 31, 80),
... )</code></pre>
<ol start="3">
<li>Split the data into usable formats for the graph. This is a preparation step:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; POS = list(range(len(DATA)))
&gt;&gt;&gt; VALUESA = [valueA for label, valueA, valueB, valueC in DATA]
&gt;&gt;&gt; VALUESB = [valueB for label, valueA, valueB, valueC in DATA]
&gt;&gt;&gt; VALUESC = [valueC for label, valueA, valueB, valueC in DATA]
&gt;&gt;&gt; LABELS = [label for label, valueA, valueB, valueC in DATA]</code></pre>
<ol start="4">
<li>Create a bar graph with the data:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; WIDTH = 0.2
&gt;&gt;&gt; plt.bar([p - WIDTH for p in POS], VALUESA, width=WIDTH)
&gt;&gt;&gt; plt.bar([p for p in POS], VALUESB, width=WIDTH)
&gt;&gt;&gt; plt.bar([p + WIDTH for p in POS], VALUESC, width=WIDTH)
&gt;&gt;&gt; plt.ylabel('Sales')
&gt;&gt;&gt; plt.xticks(POS, LABELS)</code></pre>
<ol start="5">
<li>Add an annotation displaying the maximum growth in the chart:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.annotate('400% growth', xy=(1.2, 18), xytext=(1.3, 40),
                 horizontalalignment='center',
                 arrowprops=dict(facecolor='black', shrink=0.05))</code></pre>
<ol start="6">
<li>Add the <kbd>legend</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.legend(LEGEND)</code></pre>
<ol start="7">
<li>Display the graph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.show()</code></pre>
<ol start="8">
<li>The result will be displayed in a new window:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000012.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>Steps 1 and 2&nbsp; of the <em>How to do it&hellip;</em> section prepare the imports and the data that will be displayed in the bar, in a format similar to what well-structured input data will look like. In step 3, the data is split into different arrays to prepare the input in <kbd>matplotlib</kbd>. Basically, each data sequence is stored in a different array.</p>
<p>Step 4 draws the data. Each data sequence gets a call to <kbd>.bar</kbd>, specifying its position and values. Labels do the same as <kbd>.xticks</kbd>. To separate each of the bars around the labels, the first one is displaced to the left and the third to the right.</p>
<p>An annotation is added above the bar for <kbd>ProductC</kbd> in the second quarter. Note that the annotation includes the point in <kbd>xy</kbd> and the text location in <kbd>xytext</kbd>.</p>
<p>In step 6, the legend is added. Notice that the labels need to be added in the same order as the data was input. The legend is located automatically in an area that doesn't cover any data. <kbd>arroprops</kbd> details the arrow to point to the data.</p>
<p>Finally, the graph is drawn in step 7 by calling <kbd>.show</kbd>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Calling&nbsp;<kbd>.show</kbd>&nbsp;blocks the execution of the program. The program will resume when the window is closed.</p>
</div>
</div>
<h3>There's more...</h3>
<p>Legends will be display automatically in most cases with just a call to <kbd>.legend</kbd>. If you need to customize the order in which they appear, you may refer each label to a specific element. For example, this way (note it calls <kbd>ProductA</kbd> the <kbd>valueC</kbd> series)</p>
<pre><code class="lang-python">&gt;&gt;&gt; valueA = plt.bar([p - WIDTH for p in POS], VALUESA, width=WIDTH)
&gt;&gt;&gt; valueB = plt.bar([p for p in POS], VALUESB, width=WIDTH)
&gt;&gt;&gt; valueC = plt.bar([p + WIDTH for p in POS], VALUESC, width=WIDTH)
&gt;&gt;&gt; plt.legend((valueC, valueB, valueA), LEGEND)</code></pre>
<p>The location of the legend can also be changed manually, through the&nbsp;<kbd>loc</kbd>&nbsp;parameter. By default, it is <kbd>best</kbd>&nbsp;and it will draw the legend over an area where there's the least overlap of data (ideally none). But values such as&nbsp;<kbd>right</kbd>, <kbd>upper left</kbd>, and so on can be used, or a specific <kbd>(X, Y)</kbd> tuple.</p>
<p>Another option is to plot the legend&nbsp;outside of the graph, using the&nbsp;<kbd>bbox_to_anchor</kbd>&nbsp;option. In this case, the legend is attached to the (<em>X</em>, <em>Y</em>) of the bounding box, where <kbd>0</kbd> is the bottom-left corner of the graph and <kbd>1</kbd> is the upper-right corner. This may cause the legend to be clipped by the external border, so you may need to adjust where the graph starts and ends with <kbd>.subplots_adjust</kbd>:</p>
<pre><code class="lang-python">&gt;&gt;&gt; plt.legend(LEGEND, title='Products', bbox_to_anchor=(1, 0.8))
&gt;&gt;&gt; plt.subplots_adjust(right=0.80)</code></pre>
<p>Adjusting the <kbd>bbox_to_anchor</kbd> parameter and <kbd>.subplots_adjust</kbd> will require a little bit of trial and error, until the expected result is produced.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p><kbd>.subplots_adjust</kbd> references the positions as the position of the axis where it will be displayed. This means that <kbd>right=0.80</kbd>&nbsp;will leave 20% of the screen on the right of the plot, while the default for left is 0.125, meaning it leaves 12.5% of the space on the left of the plot. See the documentation for further details:&nbsp;<a href="https://matplotlib.org/api/_as_gen/matplotlib.pyplot.subplots_adjust.html">https://matplotlib.org/api/_as_gen/matplotlib.pyplot.subplots_adjust.html</a>.</p>
</div>
</div>
<p>The annotations can be done in different styles and can be tweaked with different options regarding the way to connect and so on. For example, this code will create an arrow with the <kbd>fancy</kbd>&nbsp;style connecting with a curve. The result is displayed here:</p>
<pre><code class="lang-python">plt.annotate('400% growth', xy=(1.2, 18), xytext=(1.3, 40),
             horizontalalignment='center',
             arrowprops={'facecolor': 'black',
                         'arrowstyle': "fancy",
                         'connectionstyle': "angle3",
                         })</code></pre>
<p>In our recipe, we did not&nbsp;annotate to&nbsp;exactly the end of the bar (point (<kbd>1.2</kbd>, <kbd>15</kbd>)), but slightly above it, to give a little bit of breathing space.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Adjusting the&nbsp;exact&nbsp;point to annotate and where to locate the text will require a bit of testing.&nbsp;The text was also positioned by looking for the best place to not overlap the text with the bars. The font size and color can be changed, using the <kbd>fontsize</kbd> and <kbd>color</kbd> parameters, in&nbsp;both&nbsp;the <kbd>.legend</kbd> and <kbd>.annotate</kbd> calls.</p>
</div>
</div>
<p>Applying all these elements, the graph may look similar to this. This graph can be replicated by calling the <kbd>legend_and_annotation.py</kbd> script available in GitHub here:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter07/adding_legend_and_annotations.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter07/adding_legend_and_annotations.py</a>:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000061.png" class="lazyload" /></p>
<p>The full&nbsp;<kbd>matplotlib</kbd>&nbsp;documentation can be found here:&nbsp;<a href="https://matplotlib.org/">https://matplotlib.org/</a>. In particular, the guide for legends is here:&nbsp;<a href="https://matplotlib.org/users/legend_guide.html#plotting-guide-legend">https://matplotlib.org/users/legend_guide.html#plotting-guide-legend</a>&nbsp;and for annotations it is here:&nbsp;<a href="https://matplotlib.org/users/annotations.html">https://matplotlib.org/users/annotations.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Drawing stacked bars</em> recipe</li>
<li>The <em>Combining graphs</em> recipe</li>
</ul>
<h2>Combining graphs</h2>
<p>More than one graph can be combined in the same graph. In this recipe, we'll see how to present data in the same plot, on two different axes, and how to add more plots to the same graph.</p>
<h3>Getting ready</h3>
<p>We need to install&nbsp;<kbd>matplotlib</kbd>&nbsp;in our virtual environment:</p>
<pre><code class="lang-python">$ echo "matplotlib==2.2.2" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>If you are using macOS, it's possible that you get an error like this&mdash;<kbd>RuntimeError: Python is not installed as a framework</kbd>. See the&nbsp;<kbd>matplolib</kbd>&nbsp;documentation on how to fix it:&nbsp;<a href="https://matplotlib.org/faq/osx_framework.html">https://matplotlib.org/faq/osx_framework.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import&nbsp;<kbd>matplotlib</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import matplotlib.pyplot as plt</code></pre>
<ol start="2">
<li>Prepare the data to be displayed on the graph and the legends that should be displayed. Each of the lines is composed of the time label,&nbsp;&nbsp;sales of <kbd>ProductA</kbd>, and sales of <kbd>ProductB</kbd>. Notice how <kbd>ProductB</kbd> has a much higher value than <kbd>A</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; DATA = (
...  ('Q1 2017', 100, 3000, 3),
...  ('Q2 2017', 105, 3200, 5),
...  ('Q3 2017', 125, 2900, 7),
...  ('Q4 2017', 115, 3100, 3),
... )</code></pre>
<ol start="3">
<li>Prepare the data in independent arrays:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; POS = list(range(len(DATA)))
&gt;&gt;&gt; VALUESA = [valueA for label, valueA, valueB, valueC in DATA]
&gt;&gt;&gt; VALUESB = [valueB for label, valueA, valueB, valueC in DATA]
&gt;&gt;&gt; VALUESC = [valueC for label, valueA, valueB, valueC in DATA]
&gt;&gt;&gt; LABELS = [label for label, valueA, valueB, valueC in DATA]</code></pre>
<p>Note that this expands and creates a list for each of the values.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The values can also be expanded with this&mdash;<kbd>LABELS</kbd>, <kbd>VALUESA</kbd>, <kbd>VALUESB</kbd>, <kbd>VALUESC = ZIP(*DATA)</kbd></p>
</div>
</div>
<ol start="4">
<li>Create a first subplot:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.subplot(2, 1, 1)</code></pre>
<ol start="5">
<li>Create a bar graph with information about <kbd>VALUESA</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; valueA = plt.bar(POS, VALUESA)
&gt;&gt;&gt; plt.ylabel('Sales A')</code></pre>
<ol start="6">
<li>Create a different <em>Y</em> axis, and add information about <kbd>VALUESB</kbd> as a line plot:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.twinx()
&gt;&gt;&gt; valueB = plt.plot(POS, VALUESB, 'o-', color='red')
&gt;&gt;&gt; plt.ylabel('Sales B')
&gt;&gt;&gt; plt.xticks(POS, LABELS)</code></pre>
<ol start="7">
<li>Create another subplot and fill it with <kbd>VALUESC</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.subplot(2, 1, 2)
&gt;&gt;&gt; plt.plot(POS, VALUESC)
&gt;&gt;&gt; plt.gca().set_ylim(ymin=0)
&gt;&gt;&gt; plt.xticks(POS, LABELS)</code></pre>
<ol start="8">
<li>Display the graph:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.show()</code></pre>
<ol start="9">
<li>The result will be displayed in a new window:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000040.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>After importing the module, the data is presented in step 2 in the <em>How to do it&hellip;</em> section in a convenient way, which will likely be similar to the way the data was originally stored. Step 3 is a preparation step that splits the data into different arrays for the next steps.</p>
<p>Step 4 creates a new <kbd>.subplot</kbd>. This splits the full drawing into two elements. The parameters are number of rows, columns, and selected subplot. So, we create two subplots in a column and drew in the first one.</p>
<p>Step 5 prints a <kbd>.bar</kbd> plot in this subplot using <kbd>VALUESA</kbd> data, and labels the <em>Y</em> axis with <kbd>Sales A</kbd>&nbsp;using <kbd>.ylabel</kbd>.</p>
<p>Step 6 creates a new <em>Y</em> axis with&nbsp;<kbd>.twinx</kbd>, drawing <kbd>VALUESB</kbd>&nbsp;now&nbsp;as a line plot through <kbd>.plot</kbd>. The label is marked with <kbd>.ylabel</kbd> as <kbd>Sales B</kbd>. The <em>X</em> axis is labeled using <kbd>.xticks</kbd>.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The <kbd>VALUESB</kbd> plot is set as red to avoid both plots having the same color. By default, the first color is the same in both cases, and that will lead to confusion. The data points are marked with the&nbsp;<kbd>'o'</kbd>&nbsp;option.</p>
</div>
</div>
<p>In step 7, we changed to the second subplot using <kbd>.subplot</kbd>. The plot prints&nbsp;<kbd>VALUESC</kbd> as a line, and&nbsp;again&nbsp;puts the labels on the <em>X</em> axis with <kbd>.xticker</kbd>&nbsp;and sets the minimum of the <em>Y</em> axis to <kbd>0</kbd>. The graph is then displayed in step 8.</p>
<h3>There's more...</h3>
<p>Plots with multiple axes are complicated to read as a general rule. Use them only when there's a good reason to do so and the data is highly correlated.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>By default, the <em>Y</em> axis in line plots will try to present information between the minimum and maximum <em>Y</em> values. Truncating the axis is normally not the best way to present information, as it can distort the perceived differences. For example, changing values in the range from 10 to 11 can look like a huge deal if the graph goes from 10 to 11, but this is less than 10%. Setting the <em>Y</em> axis minimum to <kbd>0</kbd> with&nbsp;<kbd>plt.gca().set_ylim(ymin=0)</kbd>&nbsp;is a good idea, especially with two different axes.</p>
</div>
</div>
<p>The call to select the subplot will first&nbsp;go&nbsp;by row, then by column, so <kbd>.subplot(2, 2, 3)</kbd> will select the subplot in the first column, second row.</p>
<p>The divided subplot grid can be changed. A first call to <kbd>.subplot(2, 2, 1)</kbd> and <kbd>.subplot(2, 2, 2)</kbd>, and then calling <kbd>.subplot(2, 1, 2)</kbd>, will create a structure with two small plots in the first row and a wider one in the second. Going back will overwrite previously drawn subplots.</p>
<p>The full&nbsp;<kbd>matplotlib</kbd>&nbsp;documentation can be found here:&nbsp;<a href="https://matplotlib.org/">https://matplotlib.org/</a>. In particular, the guide for legends is here:&nbsp;<a href="https://matplotlib.org/users/legend_guide.html#plotting-guide-legend">https://matplotlib.org/users/legend_guide.html#plotting-guide-legend</a>. For annotations, it is here:&nbsp;<a href="https://matplotlib.org/users/annotations.html">https://matplotlib.org/users/annotations.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Drawing multiple lines</em> recipe</li>
<li>The <em>Visualizing maps</em> recipe</li>
</ul>
<h2>Saving charts</h2>
<p>Once a chart is ready, we can store it on the hard drive so it can be referenced in other documents. We'll see in this recipe how to save charts in different formats.</p>
<h3>Getting ready</h3>
<p>We need to install&nbsp;<kbd>matplotlib</kbd>&nbsp;in our virtual environment:</p>
<pre><code class="lang-python">$ echo "matplotlib==2.2.2" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>If you are using macOS, it's possible that you get an error like this&mdash;<kbd>RuntimeError: Python is not installed as a framework</kbd>. See the&nbsp;<kbd>matplolib</kbd>&nbsp;documentation on how to fix it:&nbsp;<a href="https://matplotlib.org/faq/osx_framework.html">https://matplotlib.org/faq/osx_framework.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import&nbsp;<kbd>matplotlib</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import matplotlib.pyplot as plt</code></pre>
<ol start="2">
<li>Prepare the data to be displayed on the graph and split it into different arrays:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; DATA = (
...    ('Q1 2017', 100),
...    ('Q2 2017', 150),
...    ('Q3 2017', 125),
...    ('Q4 2017', 175),
... )
&gt;&gt;&gt; POS = list(range(len(DATA)))
&gt;&gt;&gt; VALUES = [value for label, value in DATA]
&gt;&gt;&gt; LABELS = [label for label, value in DATA]</code></pre>
<ol start="3">
<li>Create a bar graph with the data:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.bar(POS, VALUES)
&gt;&gt;&gt; plt.xticks(POS, LABELS)
&gt;&gt;&gt; plt.ylabel('Sales')</code></pre>
<ol start="4">
<li>Save the graph to the hard drive:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; plt.savefig('data.png')</code></pre>
<ol start="6"></ol>
<h3>How it works...</h3>
<p>After importing and preparing the data in steps 1 and 2 in the <em>How to do it&hellip;</em> section, the graph is generated in step 3 by calling&nbsp;<kbd>.bar</kbd>. A <kbd>.ylabel</kbd> is added and the <em>X</em> axis is labeled with the proper time description through <kbd>.xticks</kbd>.</p>
<p>Step 4 saves the file to the hard drive with the name <kbd>data.png</kbd>.</p>
<h3>There's more...</h3>
<p>The resolution of the image can be determined through the <kbd>dpi</kbd> parameter. This will affect the size of the file. Use resolutions between <kbd>72</kbd> and <kbd>300</kbd>. Lower ones will be difficult to read, and higher ones won't make sense unless the size of the graph is humongous:</p>
<pre><code class="lang-python">&gt;&gt;&gt; plt.savefig('data.png', dpi=72)</code></pre>
<p><kbd>matplotlib</kbd> understands how to store the most common file formats, such as JPEG, PDF, and PNG. It will be used automatically when the filename has the proper extension.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Unless you have a specific requirement, use PNG. It is very efficient at storing graphs with limited colors when compared with other formats. If you need to find all the supported files, you can call&nbsp;<kbd>plt.gcf().canvas.get_supported_filetypes()</kbd>.</p>
</div>
</div>
<p>The full&nbsp;<kbd>matplotlib</kbd>&nbsp;documentation can be found here:&nbsp;<a href="https://matplotlib.org/">https://matplotlib.org/</a>. In particular, the guide for legends is here:&nbsp;<a href="https://matplotlib.org/users/legend_guide.html#plotting-guide-legend">https://matplotlib.org/users/legend_guide.html#plotting-guide-legend</a>. For annotations, it is here:&nbsp;<a href="https://matplotlib.org/users/annotations.html">https://matplotlib.org/users/annotations.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Plotting a simple sales graph</em> recipe</li>
<li>The <em>Adding legends and annotations</em> recipe</li>
</ul>

</div>

<!--Chapter 8-->

<div class="chapter" data-chapter-number="8">
<div class="chapter-start">
<div class="ch-head">Chapter <span class="chapter-number"> 8 </span></div>
<h1 class="chaptertitle">Dealing with Communication Channels</h1>
<h3 class="author">Jaime Buelta</h3>
</div>

<p>In this chapter, we will cover the following recipes:</p>
<ul>
<li>Working with email templates</li>
<li>Sending an individual email</li>
<li>Reading an email</li>
<li>Adding subscribers to an email newsletter</li>
<li>Sending notifications via email</li>
<li>Producing SMS</li>
<li>Receiving SMS</li>
<li>Creating a Telegram bot</li>
</ul>
<h2>Introduction</h2>
<p>Dealing with communication channels is where automating things can produce big gains. In this recipe, we'll see how to work with two of the most common communication channels&mdash;emails, including newsletters, as well as sending and receiving text messages by phone.</p>
<p>During the years, there has been a fair amount of abuse in methods of delivery, like spam or unsolicited marketing messages, making necessary to partner with external tools to avoid messages to be automatically rejected by automated filters. We will present the proper caveats where applicable. All the tools&nbsp;presented&nbsp;have excellent documentation, so do not be afraid to read it. They also have a lot of features, and they may be able to do something that is exactly what you're looking for.</p>
<h2>Working with email templates</h2>
<p>To send an email, we first need to generate its content. In this recipe, we'll see how to generate a proper template, in both text-only style and HTML.</p>
<h3>Getting ready</h3>
<p>We should start by installing the&nbsp;<kbd>mistune</kbd>&nbsp;module, which will compile Markdown documents into HTML. We will also use the <kbd>jinja2</kbd>&nbsp;module&nbsp;to combine HTML with our text:</p>
<pre><code class="lang-python">$ echo "mistune==0.8.3" &gt;&gt; requirements.txt
$ echo "jinja2==2.20" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>In the GitHub repo, there are a couple of templates we will use&mdash;<kbd>email_template.md</kbd> in&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/email_template.md">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/email_template.md</a> and a template for styling,&nbsp;<kbd>email_styling.html</kbd>, in&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/email_styling.html">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/email_styling.html</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the modules:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import mistune
&gt;&gt;&gt; import jinja2</code></pre>
<ol start="2">
<li>Read both templates from disk:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('email_template.md') as md_file:
...     markdown = md_file.read()

&gt;&gt;&gt; with open('email_styling.html') as styling_file:
...     styling = styling_file.read()</code></pre>
<ol start="3">
<li>Define the <kbd>data</kbd> to include in the template. The template is quite simple and accepts only a single parameter:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; data = {'name': 'Seamus'}</code></pre>
<ol start="4">
<li>Render the Markdown template. This produces the text-only version of the <kbd>data</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; text = markdown.format(**data)</code></pre>
<ol start="5">
<li>Render the Markdown and add the styling:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; html_content = mistune.markdown(text)
&gt;&gt;&gt; html = jinja2.Template(styling).render(content=html_content)</code></pre>
<ol start="6">
<li>Save the text and the HTML version to disk to check them:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with open('text_version.txt', 'w') as fp:
...     fp.write(text)
&gt;&gt;&gt; with open('html_version.html', 'w') as fp:
...     fp.write(html)</code></pre>
<ol start="7">
<li>Check the text version:</li>
</ol>
<pre><code class="lang-python">$ cat text_version.txt
Hi Seamus:

This is an email talking about **things**

### Very important info

1. One thing
2. Other thing
3. Some extra detail

Best regards,

  *The email team*</code></pre>
<ol start="8">
<li>Check the HTML version in a browser:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000049.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>Step 1 gets the modules that will be used later, and step 2 reads the two templates that will be rendered.&nbsp;<kbd>email_template.md</kbd>&nbsp;is the basis of the content, and it's a Markdown template.&nbsp;<kbd>email_styling.html</kbd> is an HTML template that contains the basic HTML surrounding and CSS styling information.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The basic structure is to create the content in Markdown format. This is a plain-text file that's readable and can be send as part of the email. That content can then be converted into HTML and surrounded with some styling to create an HTML function.&nbsp;<kbd>email_styling.html</kbd> has a content area to put the rendered HTML from Markdown.</p>
</div>
</div>
<p>Step 3 defines the data that will render in&nbsp;<kbd>email_template.md</kbd>. It is a very simple template that only requires a parameter called <kbd>name</kbd>.</p>
<p>In step 4, the Markdown template gets rendered with the <kbd>data</kbd>. This produces the plain-text version of the email.</p>
<p>The <kbd>HTML</kbd> version is rendered in step 5. The plain-text version is rendered to <kbd>HTML</kbd> using&nbsp;<kbd>mistune</kbd>, and then it is wrapped in <kbd>email_styling.html</kbd> using a <kbd>jinja2</kbd> template. The final version is a self-contained HTML document.</p>
<p>Finally, we save both versions, plain-text (as <kbd>text</kbd>) and HTML (as <kbd>html</kbd>), to a file in step 6. Steps 7 and 8 check the stored values. The information is the same, but in the <kbd>HTML</kbd> version, it is styled.</p>
<h3>There's more...</h3>
<p>Using Markdown makes dual emails with text and HTML easy to generate. Markdown is quite readable in text format, and renders very naturally into HTML. That said, it is possible to generate a totally different HTML version, which will allow for more customization and taking advantage of HTML's features.</p>
<p>The full&nbsp;Markdown&nbsp;syntax can be found at&nbsp;<a href="https://daringfireball.net/projects/markdown/syntax">https://daringfireball.net/projects/markdown/syntax</a>&nbsp;and a good cheat sheet with the most commonly used elements is at&nbsp;<a href="https://beegit.com/markdown-cheat-sheet">https://beegit.com/markdown-cheat-sheet</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>While making a plain-text-only version of an email is not strictly necessary, it is a good practice and shows you care about who reads the email. Most email clients accept HTML, but it's not totally universal.&nbsp;</p>
</div>
</div>
<p>For an HTML email, note that the whole style should be contained in the email. That means that the CSS needs to be embedded into the <kbd>HTML</kbd>. Avoid making external calls that could lead the email to not render properly in some email clients, or even be qualified as spam.</p>
<p>The styling in&nbsp;<kbd>email_styling.html</kbd>&nbsp;is based on the&nbsp;modest&nbsp;style that can be found here:&nbsp;<a href="http://markdowncss.github.io/">http://markdowncss.github.io/</a>. There are more CSS styles that can be used, and a search in Google should find more. Remember to remove any external references, as discussed before.</p>
<p>Images can be included in HTML by encoding the image in <kbd>base64</kbd> format so it can be embedded directly in the HTML <kbd>img</kbd> tag, instead of adding a reference:</p>
<pre><code class="lang-python">&gt;&gt;&gt; import base64
&gt;&gt;&gt; with open("image.png",'rb') as file:
...    encoded_data = base64.b64encode(file)
&gt;&gt;&gt; print "&lt;img data-src='https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/data:image/png;base64,{data}'/&gt;".format(data=encoded_data)</code></pre>
<p>You can find more information about this technique in&nbsp;this article:&nbsp;<a href="https://css-tricks.com/data-uris/">https://css-tricks.com/data-uris/</a>.</p>
<p>The <kbd>mistune</kbd> full docs are available at&nbsp;<a href="http://mistune.readthedocs.io/en/latest/">http://mistune.readthedocs.io/en/latest/</a>&nbsp;and the&nbsp;<kbd>jinja2</kbd> documentation at&nbsp;<a href="http://jinja.pocoo.org/docs/2.10/">http://jinja.pocoo.org/docs/2.10/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Formatting text in Markdown</em> recipe in Chapter 5, <em>Generating Fantastic Reports</em>&nbsp;</li>
<li>The <em>Using templates for reports recipe</em> in Chapter 5, <em>Generating Fantastic Reports&nbsp;</em></li>
<li>The <em>Sending transactional emails</em> recipe&nbsp;in&nbsp;Chapter 5, <em>Generating Fantastic Reports&nbsp;</em></li>
</ul>
<h2>Sending an individual email</h2>
<p>The most basic way of sending an email is to send an individual one from an email account. This option is only recommended for very sporadic use, but for simple purposes such as sending a couple of emails a day to controlled addresses, it can be good enough.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Do not use this method to send emails in bulk to distribution lists or to customers with unknown email addresses. You risk being banned from your service provider due to anti-spam rules. See other recipes in this chapter for more options.</p>
</div>
</div>
<h3>Getting ready</h3>
<p>For this recipe, we'll need an email account with a service provider. There are small differences based on the provider to use, but we'll use a Gmail account, as it is very common and free to access.</p>
<p>Due to Gmail's security, we'll need to create a specific app password that can be used to send an email. Follow the instructions here:&nbsp;<a href="https://support.google.com/accounts/answer/185833">https://support.google.com/accounts/answer/185833</a>. This will help to generate a password for the purpose of this recipe. Remember to create it for mail access. You can delete the password afterwards to remove it.</p>
<p>We'll use the <kbd>smtplib</kbd> module, which is part of Python's standard library.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the&nbsp;<kbd>smtplib</kbd>&nbsp;and <kbd>email</kbd>&nbsp;modules:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import smtplib
&gt;&gt;&gt; from email.mime.multipart import MIMEMultipart
&gt;&gt;&gt; from email.mime.text import MIMEText</code></pre>
<ol start="2">
<li>Set up the credentials, replacing these with your own ones. For testing purposes, we'll send to the same email, but feel free to use a different address:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; USER = 'your.account@gmail.com'
&gt;&gt;&gt; PASSWORD = 'YourPassword'
&gt;&gt;&gt; sent_from = USER
&gt;&gt;&gt; send_to = [USER]</code></pre>
<ol start="3">
<li>Define the data to be sent. Notice the two alternatives, a plain-text one and an HTML one:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; text = "Hi!\nThis is the text version linking to https://www.packtpub.com/\nCheers!"
&gt;&gt;&gt; html = """&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;
... &lt;p&gt;Hi!&lt;br&gt;
... This is the HTML version linking to &lt;a href="https://www.packtpub.com/"&gt;Packt&lt;/a&gt;&lt;br&gt;
... &lt;/p&gt;
... &lt;/body&gt;&lt;/html&gt;
"""</code></pre>
<ol start="4">
<li>Compose the message as a <kbd>MIME</kbd> multipart, including&nbsp;<kbd>subject</kbd>, <kbd>to</kbd>, and <kbd>from</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; msg = MIMEMultipart('alternative')
&gt;&gt;&gt; msg['Subject'] = 'An interesting email'
&gt;&gt;&gt; msg['From'] = sent_from
&gt;&gt;&gt; msg['To'] = ', '.join(send_to)</code></pre>
<ol start="5">
<li>Fill the data&nbsp;content parts of the email:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; part_plain = MIMEText(text, 'plain')
&gt;&gt;&gt; part_html = MIMEText(html, 'html')
&gt;&gt;&gt; msg.attach(part_plain)
&gt;&gt;&gt; msg.attach(part_html)</code></pre>
<ol start="6">
<li>Send the email, using the&nbsp;<kbd>SMTP SSL</kbd> protocol:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
...     server.login(USER, PASSWORD)
...     server.sendmail(sent_from, send_to, msg.as_string())</code></pre>
<ol start="7">
<li>The email is sent. Check your email account for the message. Checking the <em>original email</em>, you can see the full raw email, with elements in both&nbsp;HTML and plain-text. The email is presented redacted:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000073.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>After step 1, making the pertinent imports from <kbd>stmplib</kbd> and <kbd>email</kbd>, step 2 defines the credentials obtained from Gmail.</p>
<p>Step 3 shows the HTML and text that is going to be sent. They are alternatives, so they should present the same information, but in different formats.</p>
<p>The basic message information is set up in step 4. It specifies the subject of the email, as well as the <em>from</em> and <em>to</em>. Step 5 adds multiple parts, each with the proper <kbd>MIMEText</kbd> type.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The last part added&nbsp;is the preferred alternative, according to the <kbd>MIME</kbd> format, so we add the <kbd>HTML</kbd> part last.</p>
</div>
</div>
<p>Step 6 sets up the connection with the server, logs in using the credentials, and sends the message. It uses a <kbd>with</kbd> context to get the connection.&nbsp;</p>
<p>If there's an error with the credentials, it will raise an exception with&nbsp;username and password not accepted.</p>
<h3>There's more...</h3>
<p>Note that <kbd>sent_to</kbd> is a list of addresses. You can send an email to more than one address. The only caveat is in step 4, where it needs to be specified as a list of comma-separated value for all addresses.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Although it is possible to label <kbd>sent_from</kbd> as a different address than that used to send the email, it is not recommended. That can be interpreted as an indication of trying to fake the origin of the email, and provoke detection as a spam source.</p>
</div>
</div>
<p>The server used here, <kbd>smtp.gmail.com</kbd><em>,&nbsp;</em>is the one specified by Gmail, and the defined port for <kbd>SMTPS</kbd> (secure <kbd>SMTP</kbd>) is <kbd>465</kbd>. Gmail also accepts port&nbsp;<kbd>587</kbd>, which is the standard, but requires you to specify the kind of session by calling&nbsp;<kbd>.starttls</kbd>, as shown in the next code:</p>
<pre><code class="lang-python"> with smtplib.SMTP('smtp.gmail.com', 587) as server:
    server.starttls()
    server.login(USER, PASSWORD)
    server.sendmail(sent_from, send_to, msg.as_string())</code></pre>
<p>If you are interested in more details about these differences and both protocols, you can find more information in this&nbsp;article:&nbsp;<a href="https://www.fastmail.com/help/technical/ssltlsstarttls.html">https://www.fastmail.com/help/technical/ssltlsstarttls.html</a>.</p>
<p>The full <kbd>smtplib</kbd> documentation can be found at&nbsp;<a href="https://docs.python.org/3/library/smtplib.html">https://docs.python.org/3/library/smtplib.html</a>, and the <kbd>email</kbd> module, with info on the different formats for emails, including examples on <kbd>MIME</kbd> types, can be found here:&nbsp;<a href="https://docs.python.org/3/library/email.html">https://docs.python.org/3/library/email.html</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Working with email templates</em> recipe</li>
<li>The <em>Sending an individual email</em> recipe</li>
</ul>
<h2>Reading an email</h2>
<p>In this recipe, we'll see how to read emails from an account. We'll use the <kbd>IMAP4</kbd> standard, which is the most commonly used standard for&nbsp;reading&nbsp;email.</p>
<p>Once read, the email can be processed and analyzed automatically to generate actions such as smart automated responses, forwarding the email to a different target, aggregating the results for monitoring, and so on. The options are unlimited!</p>
<h3>Getting ready</h3>
<p>For this recipe, we'll need an email account with a service provider. There are small differences based on the provider to use, but we'll use a Gmail account, as it is very common and free to access.</p>
<p>Due to Gmail's security, we'll need to create a specific app password to use to send an email. Follow the instructions here:&nbsp;<a href="https://support.google.com/accounts/answer/185833">https://support.google.com/accounts/answer/185833</a>. This will generate a password for the purpose of this recipe. Remember to create it for mail. You can delete the password afterwards to remove it.</p>
<p>We'll use the&nbsp;<kbd>imaplib</kbd>&nbsp;module, which is part of Python's standard library.</p>
<p>The recipe will read the last received email, so you can use it for better control over what's going to be read. We'll send a short email that looks like it was sent to support.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the&nbsp;<kbd>imaplib</kbd> and <kbd>email</kbd>&nbsp;modules:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import imaplib
&gt;&gt;&gt; import email
&gt;&gt;&gt; from email.parser import BytesParser, Parser
&gt;&gt;&gt; from email.policy import default</code></pre>
<ol start="2">
<li>Set up the credentials, replacing these with your own ones:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; USER = 'your.account@gmail.com'
&gt;&gt;&gt; PASSWORD = 'YourPassword'</code></pre>
<ol start="3">
<li>Connect to the email server:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; mail = imaplib.IMAP4_SSL('imap.gmail.com')
&gt;&gt;&gt; mail.login(USER, PASSWORD)</code></pre>
<ol start="4">
<li>Select the inbox folder:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; mail.select('inbox')</code></pre>
<ol start="5">
<li>Read all email UIDs and retrieve the latest received email:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; result, data = mail.uid('search', None, 'ALL')
&gt;&gt;&gt; latest_email_uid = data[0].split()[-1]
&gt;&gt;&gt; result, data = mail.uid('fetch', latest_email_uid, '(RFC822)')
&gt;&gt;&gt; raw_email = data[0][1]</code></pre>
<ol start="6">
<li>Parse the email into a Python object:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; email_message = BytesParser(policy=default).parsebytes(raw_email)</code></pre>
<ol start="7">
<li>Display the subject and sender of the email:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; email_message['subject']
'[Ref ABCDEF] Subject: Product A'
&gt;&gt;&gt; email.utils.parseaddr(email_message['From'])
('Sender name', 'sender@gmail.com')</code></pre>
<ol start="8">
<li>Retrieve the payload of the text:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; email_type = email_message.get_content_maintype()
&gt;&gt;&gt; if email_type == 'multipart':
...     for part in email_message.get_payload():
...         if part.get_content_type() == 'text/plain':
...             payload = part.get_payload()
... elif email_type == 'text':
...     payload = email_message.get_payload()
&gt;&gt;&gt; print(payload)
Hi:

  I'm having difficulties getting into my account. What was the URL, again?

  Thanks!
    A confuser customer</code></pre>
<h3>How it works...</h3>
<p>After importing the modules that will be used and defining the credentials, we connect to the server in step 3.</p>
<p>Step 4 connects to the <kbd>inbox</kbd>. This is a default folder in Gmail that contains the received email.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Of course, you may need to read a different folder. You can get a list of all folders by calling <kbd>mail.list()</kbd>.</p>
</div>
</div>
<p>In step 5, first a list of UIDs is retrieved for all the emails in the inbox by calling <kbd>.uid('search', None, "ALL")</kbd>. The last email received is then retrieved again from the server through a <kbd>fetch</kbd> action with&nbsp;<kbd>.uid('fetch', latest_email_uid, '(RFC822)')</kbd>. This retrieves the email in RFC822 format, which is the standard. Note that retrieving the email marks it as read.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The <kbd>.uid</kbd> command allows us to call IMAP4 commands, returning a tuple with the result (<kbd>OK</kbd>&nbsp;or <kbd>NO</kbd>) and the data. If there's an error, it will raise the proper exception.</p>
</div>
</div>
<p>The <kbd>BytesParser</kbd>&nbsp;module&nbsp;is used to transform from the raw <kbd>RFC822</kbd> email into a Python object. This is done in Step 6.</p>
<p>The metadata, including details such as the subject, the sender, and the timestamp, can be accessed like a dictionary, as shown in step 7. The addresses can be parsed from raw text format to separate the part with&nbsp;<kbd>email.utils.parseaddr</kbd>.</p>
<p>Finally, the content can be unfolded and extracted. If the type of the email is multipart, each of the parts can be extracted by iterating through&nbsp;<kbd>.get_payload()</kbd>. The one that's easier to deal with is <kbd>plain/text</kbd>, so assuming it is present, the code in step 8 will extract it.</p>
<p>The email body is stored in the <kbd>payload</kbd> variable.</p>
<h3>There's more...</h3>
<p>In step 5, we are retrieving all the emails in the inbox, but that's not necessary. The search can be filtered, for example by retrieving only the last day's emails:</p>
<pre><code class="lang-python">import datetime
since = (datetime.date.today() - datetime.timedelta(days=1)).strftime("%d-%b-%Y")
result, data = mail.uid('search', None, f'(SENTSINCE {since})')</code></pre>
<p>This will search according to the date&nbsp;of the email. Notice the resolution is in days.</p>
<p>There are more actions that can be done through <kbd>IMAP4</kbd>. Check RFC 3501&nbsp;&nbsp;<a href="https://tools.ietf.org/html/rfc3501">https://tools.ietf.org/html/rfc3501</a>&nbsp;and RFC 6851&nbsp;<a href="https://tools.ietf.org/html/rfc6851">https://tools.ietf.org/html/rfc6851</a>&nbsp;for further details.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The RFCs describe the IMAP4 protocol and can be a little arid. Checking the possible actions will give you an idea of the possibilities to investigate in detail, probably by Googling for examples.&nbsp;</p>
</div>
</div>
<p>The subject and body of the email, as well as other metadata such as date, to, from, and so on, can be parsed and processed. For example, the subject retrieved in this recipe can be processed in the following way:</p>
<pre><code class="lang-python">&gt;&gt;&gt; import re
&gt;&gt;&gt; re.search(r'\[Ref (\w+)] Subject: (\w+)', '[Ref ABCDEF] Subject: Product A').groups()
('ABCDEF', 'Product') </code></pre>
<p>See Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em> for more info about regular expressions and other ways of parsing information.</p>
<h3>See also</h3>
<ul>
<li>The <em>Introducing regular expressions</em> recipe in Chapter 1, <em>Let Us Begin Our Automation Journey</em></li>
</ul>
<h2>Adding subscribers to an email newsletter</h2>
<p>A common marketing tool is email newsletters. They are convenient ways of sending information to multiple targets. A good newsletter system is difficult to implement, and the recommended way is to use&nbsp;ones&nbsp;available in the market. A well known one is MailChimp (<a href="https://mailchimp.com/">https://mailchimp.com/</a>).</p>
<p>MailChimp has a lot of possibilities, but the interesting one in regard to this book is its API, which can be scripted to automate tools. This RESTful API can be accessed through Python. In this recipe, we will see how to add more subscribers to an existing list.</p>
<h3>Getting ready</h3>
<p>As we will use MailChimp, we need to have an account&nbsp;available. You can create a free account at&nbsp;<a href="https://login.mailchimp.com/signup/">https://login.mailchimp.com/signup/</a>.</p>
<p>After creating the account, be sure to at least&nbsp;have&nbsp;a list that we will add subscribers to. As part of the registration, it is possible that it has been created. It will appear under Lists:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000039.png" class="lazyload" /></p>
<p>The list will contain the subscribed users.</p>
<p>For the API, we'll need an API key. Go to Account | Extras | API keys and create a new one:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000063.png" class="lazyload" /></p>
<p>We will use the&nbsp;requests&nbsp;module for accessing the API. Add it to your virtual environment:</p>
<pre><code class="lang-python">$ echo "requests==2.18.3" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>The MailChimp API uses the concept of the <strong>DC</strong> (<strong>data center</strong>) that your account uses. This can be obtained from the last digits of your API,&nbsp;or from the start of the URL from the MailChimp admin site. For example, in all the previous screenshots, it is <kbd>us19</kbd>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>requests</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import requests</code></pre>
<ol start="2">
<li>Define the authentication and base URLs. The base URL requires your <kbd>dc</kbd> at the start (such as&nbsp;<kbd>us19</kbd>):</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; API = 'your secret key'
&gt;&gt;&gt; BASE = 'https://&lt;dc&gt;.api.mailchimp.com/3.0'
&gt;&gt;&gt; auth = ('user', API)</code></pre>
<ol start="3">
<li>Obtain all your lists:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; url = f'{BASE}/lists'
&gt;&gt;&gt; response = requests.get(url, auth=auth)
&gt;&gt;&gt; result = response.json()</code></pre>
<ol start="4">
<li>Filter your lists to obtain the <kbd>href</kbd> for the required list:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; LIST_NAME = 'Your list name'
&gt;&gt;&gt; this_list = [l for l in result['lists'] if l['name'] == LIST_NAME][0]
&gt;&gt;&gt; list_url = [l['href'] for l in this_list['_links'] if l['rel'] == 'self'][0]</code></pre>
<ol start="5">
<li>With the list URL, you can obtain the URL for the members of the list:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; response = requests.get(list_url, auth=auth)
&gt;&gt;&gt; result = response.json()
&gt;&gt;&gt; result['stats']
{'member_count': 1, 'unsubscribe_count': 0, 'cleaned_count': 0, ...}
&gt;&gt;&gt; members_url = [l['href'] for l in result['_links'] if l['rel'] == 'members'][0]</code></pre>
<ol start="6">
<li>The list of members can be retrieved through a <kbd>GET</kbd> request to&nbsp;<kbd>members_url</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; response = requests.get(members_url, json=new_member, auth=auth)
&gt;&gt;&gt; result = response.json()
&gt;&gt;&gt; len(result['members'])
1</code></pre>
<ol start="7">
<li>Append a new member to the list:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; new_member = {
    'email_address': 'test@test.com',
    'status': 'subscribed',
}
&gt;&gt;&gt; response = requests.post(members_url, json=new_member, auth=auth)</code></pre>
<ol start="8">
<li>Retrieving the list of users with a <kbd>GET</kbd> obtains both users:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; response = requests.post(members_url, json=new_member, auth=auth)
&gt;&gt;&gt; result = response.json()
&gt;&gt;&gt; len(result['members'])
2</code></pre>
<h3>How it works...</h3>
<p>After importing the requests module in step 1, we define the basic values to connect in step 2, the base URL, and the credentials. Note that for the authentication, we only require the API key as the password, and any user (as described by the MailChimp documentation:&nbsp;<a href="https://developer.mailchimp.com/documentation/mailchimp/guides/get-started-with-mailchimp-api-3/">https://developer.mailchimp.com/documentation/mailchimp/guides/get-started-with-mailchimp-api-3/</a>).</p>
<p>Step 3 retrieves all the lists, calling the proper URL. The result is returned in JSON format. The call includes the <kbd>auth</kbd> parameter with the defined credentials. All subsequent calls will be made with that <kbd>auth</kbd> parameter for authentication purposes.</p>
<p>Step 4 shows how to filter the returned list to grab the URL of the particular list of interest. Each of the returned calls includes a list of <kbd>_links</kbd> with related information, making it possible to walk through the API.</p>
<p>The URL for the list is called in step 5. This returns information for the list, including the basic stats. Applying a similar filtering to step 4, we retrieve the URL for the members.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Due to size&nbsp;constraints and to show relevant data, not all of the retrieved elements are displayed. Feel free to analyze them interactively and find out about them. The data is well constructed, following the RESTful principles of discoverability; plus the Python ability of introspection makes it quite readable and understandable.</p>
</div>
</div>
<p>Step 6 retrieves the list of members, making a <kbd>GET</kbd>&nbsp;request to&nbsp;<kbd>members_url</kbd>, which can be seen as a single user. This can be seen in the <em>Getting Ready</em>&nbsp;section, in the web interface.&nbsp;</p>
<p>Step 7 creates a new user and posts on the <kbd>members_url</kbd>&nbsp;with the information passed in the <kbd>json</kbd> parameter, so it gets translated into JSON format. The updated data is retrieved in step 7, showing that there's a new user in the list.</p>
<h3>There's more...</h3>
<p>The full MailChimp API is quite powerful and can perform a large number of tasks. Go to the full MailChimp documentation to discover all the possibilities:&nbsp;<a href="https://developer.mailchimp.com/">https://developer.mailchimp.com/</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>As a brief note, and a little out of scope of this book, please be aware of the legal implications of adding subscribers to an automated list. Spam is a serious worry and there are new regulations in place to protect the rights of customers, such as GPDR. Ensure that you have the permission of users to email them. The good thing is that MailChimp automatically&nbsp;implements tools to help with this, such as automatic unsubscribe buttons.</p>
</div>
</div>
<p>The general MailChimp documentation is also quite interesting and shows a lot of possibilities. MailChimp is capable of managing newsletter and general distribution lists, but it can also be tailored to generate flows, schedule the sending of emails, and automatically send messages to your audience based on parameters such as their birthday.</p>
<h3>See also</h3>
<ul>
<li>The <em>Sending an individual email</em> recipe</li>
<li>The <em>Sending transactional emails</em> recipe</li>
</ul>
<h2>Sending notifications via email</h2>
<p>In this recipe, we will cover how to send emails that will be send towards customers. An email that is sent in response to an action by a user, for example, a confirmation email or an alert email, is called <em>a</em> <strong>transactional email</strong>. Due to spam protection and other limitations, it is better to implement this kind of email with the help of external tools.&nbsp;</p>
<p>In this recipe, we will use Mailgun (<a href="https://www.mailgun.com">https://www.mailgun.com</a>), which is able to send this kind of email, as well as communicate responses.</p>
<h3>Getting ready</h3>
<p>We'll need to create an account in Mailgun. Go to <a href="https://signup.mailgun.com/new/signup">https://signup.mailgun.com</a> to create one. Notice that the credit card information is optional.</p>
<p>Once registered, go to Domains to see there's a sandbox environment. We can use it to test the functionality, although it will only send emails to registered test email accounts. The API credentials will be displayed there:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000053.png" class="lazyload" /></p>
<p>We need to register the account so we'll receive the email as an <em>authorized recipient</em>. You can add it here:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000014.png" class="lazyload" /></p>
<p>To verify the account, check the email of the authorized recipient and confirm it. The email address is now ready to receive test emails:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000043.png" class="lazyload" /></p>
<p>We will use the requests&nbsp;module&nbsp;for making the connection to the Mailgun API. Install it in the virtual environment:</p>
<pre><code class="lang-python">$ echo "requests==2.18.3" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>Everything is ready to send emails, but notice only to authorized recipients. Being able to send emails everywhere requires us to set up a domain.&nbsp;Follow the Mailgun documentation: <a href="https://documentation.mailgun.com/en/latest/quickstart-sending.html#verify-your-domain">https://documentation.mailgun.com/en/latest/quickstart-sending.html#verify-your-domain</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the&nbsp;<kbd>requests</kbd>&nbsp;module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; import requests</code></pre>
<ol start="2">
<li>Prepare the credentials, as well as the to and from emails. Note we're using a mock from:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; KEY = 'YOUR-SECRET-KEY'
&gt;&gt;&gt; DOMAIN = 'YOUR-DOMAIN.mailgun.org'
&gt;&gt;&gt; TO = 'YOUR-AUTHORISED-RECEIVER'</code></pre>
<pre><code class="lang-python">
&gt;&gt;&gt; FROM = f'sender@{DOMAIN}'
&gt;&gt;&gt; auth = ('api', KEY)</code></pre>
<ol start="3">
<li>Prepare the email to be sent. Here, there is the HTML version and an alternative plain-text one:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; text = "Hi!\nThis is the text version linking to https://www.packtpub.com/\nCheers!"
&gt;&gt;&gt; html = '''&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;
...     &lt;p&gt;Hi!&lt;br&gt;
...        This is the HTML version linking to &lt;a href="https://www.packtpub.com/"&gt;Packt&lt;/a&gt;&lt;br&gt;
...     &lt;/p&gt;  
...   &lt;/body&gt;&lt;/html&gt;'''</code></pre>
<ol start="4">
<li>Set up the data to send to Mailgun:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; data = {
...     'from': f'Sender &lt;{FROM}&gt;',
...     'to': f'Jaime Buelta &lt;{TO}&gt;',
...     'subject': 'An interesting email!',
...     'text': text,
...     'html': html,
... }</code></pre>
<ol start="5">
<li>Make the call to the API:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; response = requests.post(f"https://api.mailgun.net/v3/{DOMAIN}/messages", auth=auth, data=data)
&gt;&gt;&gt; response.json()
{'id': '&lt;YOUR-ID.mailgun.org&gt;', 'message': 'Queued. Thank you.'}</code></pre>
<ol start="6">
<li>Retrieve the events and check the email has been delivered:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; response_events = requests.get(f'https://api.mailgun.net/v3/{DOMAIN}/events', auth=auth)
&gt;&gt;&gt; response_events.json()['items'][0]['recipient'] == TO
True
&gt;&gt;&gt; response_events.json()['items'][0]['event']
'delivered'</code></pre>
<ol start="7">
<li>The email should appear in your inbox. As it was sent through the sandbox environment, be sure to check your spam folder if it doesn't show up directly.</li>
</ol>
<h3>How it works...</h3>
<p>Step 1 imports the <kbd>requests</kbd>&nbsp;module&nbsp;to be used later. The credentials and the basic information in the message are defined in step 2, and should be extracted from the Mailgun web interface, as shown before.</p>
<p>Step 3 defines the email that will be sent. Step 4 structures the information in the way Mailgun expects. Notice the <kbd>html</kbd> and <kbd>text</kbd> fields. By default, it will set HTML as preferred and the plain-text option as an alternative. The format for the <kbd>TO</kbd> and <kbd>FROM</kbd> should be in the <kbd>Name &lt;address&gt;</kbd> format. You can use commas to separate multiple recipients in <kbd>TO</kbd>.</p>
<p>The call to the API&nbsp; is made in step 5. It is a <kbd>POST</kbd> call to the messages endpoint. The data is transferred in the standard way, and basic authentication is used with the <kbd>auth</kbd> parameter. Notice the definition in step 2. All calls to Mailgun should include this parameter. It returns a message notifying you that it was successful and the message is queued.</p>
<p>In step 6, a call to retrieve the events through a <kbd>GET</kbd> request is made. This will show the latest actions performed, the last of which will be the recent send. Information about delivery can also be found.</p>
<h3>There's more...</h3>
<p>To send emails, you'll need to set up the domain with which to send it, instead of using the sandbox environment. You can find the instructions here:&nbsp;<a href="https://documentation.mailgun.com/en/latest/quickstart-sending.html#verify-your-domain">https://documentation.mailgun.com/en/latest/quickstart-sending.html#verify-your-domain</a>. This requires you to change your DNS records to verify that you are their legitimate owner, and increases the deliverability of emails.</p>
<p>The emails can include attachments in the following way:</p>
<pre><code class="lang-python">attachments = [("attachment", ("attachment1.jpg", open("image.jpg","rb").read())),
               ("attachment", ("attachment2.txt", open("text.txt","rb").read()))]
response = requests.post(f"https://api.mailgun.net/v3/{DOMAIN}/messages",
                         auth=auth, files=attachments, data=data)</code></pre>
<p>The data can include the usual info such as&nbsp;<kbd>cc</kbd> or <kbd>bcc</kbd>, but you can also delay the delivery for up to three days with the&nbsp;<kbd>o:deliverytime</kbd> parameter:</p>
<pre><code class="lang-python">import datetime
import email.utils
delivery_time = datetime.datetime.now() + datetime.timedelta(days=1)
data = {
    ...
    'o:deliverytime': email.utils.format_datetime(delivery_time),
}</code></pre>
<p>Mailgun can also be used to receive emails and to trigger processes when they arrive, for example, forwarding them based on rules. Check the Mailgun documentation to find more.</p>
<p>The full Mailgun documentation can be found here,&nbsp;<a href="https://documentation.mailgun.com/en/latest/quickstart.html">https://documentation.mailgun.com/en/latest/quickstart.html</a>. Be sure to check their <em>Best Practices</em> section (<a href="https://documentation.mailgun.com/en/latest/best_practices.html#email-best-practices">https://documentation.mailgun.com/en/latest/best_practices.html#email-best-practices</a>) to understand the world of sending emails and how to avoid being labeled as spam.</p>
<h3>See also</h3>
<ul>
<li>The <em>Working with email templates</em> recipe</li>
<li>The <em>Sending an individual email</em> recipe</li>
</ul>
<h2>Producing SMS</h2>
<p>One of the most widely available communication channels is text messages. Text messages are very convenient to use to distribute information.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>SMS messages can be used for marketing purposes, but also as ways of alerting or sending notifications, or, very common recently, as a way of implementing two-factor authentication systems.</p>
</div>
</div>
<p>We will use Twilio, a service exposing an API to send SMS in an easy way.&nbsp;</p>
<h3>Getting ready</h3>
<p>We need to create an account for Twilio at&nbsp;<a href="https://www.twilio.com/">https://www.twilio.com/</a>. Go to the page and register a new account.</p>
<p>You'll need to follow the instructions and set up a phone number to receive messages. You'll need to input a code sent to this phone or receive a call to verify this line.</p>
<p>Create a new project and check the dashboard. From there, you'll be able to create a first phone number, able to receive and send SMS:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000042.png" class="lazyload" /></p>
<p>Once the number is configured, it will appear in the Active Numbers&nbsp;section in All Products and Services | Phone Numbers<em>.</em></p>
<p>On the main dashboard, check <kbd>ACCOUNT SID</kbd> and&nbsp;<kbd>AUTH TOKEN</kbd>. They'll be used later. Notice you'll need to display the auth token.</p>
<p>We'll&nbsp;also&nbsp;need to install the <kbd>twilio</kbd> module. Add it to your virtual environment:</p>
<pre><code class="lang-python">$ echo "twilio==6.16.1" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>Notice that the receiver phone number can only be a verified number with a trial account. You can verify more than one number; follow the documentation at&nbsp;<a href="https://support.twilio.com/hc/en-us/articles/223180048-Adding-a-Verified-Phone-Number-or-Caller-ID-with-Twilio">https://support.twilio.com/hc/en-us/articles/223180048-Adding-a-Verified-Phone-Number-or-Caller-ID-with-Twilio</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Import the <kbd>Client</kbd> from the <kbd>twilio</kbd> module:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from twilio.rest import Client</code></pre>
<ol start="2">
<li>Set up the authentication credentials obtained from the dashboard before. Also, set your Twilio phone number; as an example, here&nbsp;we set <kbd>+353 12 345 6789</kbd>, a fake Irish number. It will be local to your country:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; ACCOUNT_SID = 'Your account SID'
&gt;&gt;&gt; AUTH_TOKEN = 'Your secret token'
&gt;&gt;&gt; FROM = '+353 12 345 6789'</code></pre>
<ol start="3">
<li>Start the <kbd>client</kbd> to access the API:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; client = Client(ACCOUNT_SID, AUTH_TOKEN)</code></pre>
<ol start="4">
<li>Send a message to your authorized phone number. Notice the underscore at the end of <kbd>from_</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; message = client.messages.create(body='This is a test message from Python!', 
                                     from_=FROM, 
                                     to='+your authorised number')</code></pre>
<ol start="5">
<li>You'll receive an SMS to your phone:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000033.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>The use of the Twilio client to send messages is very straightforward.</p>
<p>In step 1, we import the <kbd>Client</kbd>, and prepare the credentials and the phone number configured in step 2.</p>
<p>Step 3 creates the client with the proper authentication, and the message is sent in step 4.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Note that the <kbd>to</kbd> number needs to be one of the authenticated numbers while in a trial account, or it will produce an error. You can add more authenticated numbers; check the Twilio documentation.</p>
</div>
</div>
<p>All the messages that are sent from a trial account will include that detail in the SMS, as you can see in step 5.</p>
<h3>There's more...</h3>
<p>In certain regions (US and Canada at the time of writing this), SMS numbers have the ability to send MMS messages, including images. To attach images to the message, add the <kbd>media_url</kbd> parameter and the URL of the image to send:</p>
<pre><code class="lang-python">client.messages.create(body='An MMS message',
                       media_url='http://my.image.com/image.png', 
                       from_=FROM, 
                       to='+your authorised number')</code></pre>
<p>The client is based on a RESTful API, and allows you to perform multiple operations, such as create a new phone number, or obtain an available number first and then purchase it:</p>
<pre><code class="lang-python">available_numbers = client.available_phone_numbers("IE").local.list()
number = available_numbers[0]
new_number = client.incoming_phone_numbers.create(phone_number=number.phone_number)</code></pre>
<p>Check the documentation for more available actions, but most of the dashboard point-and-click actions can be performed programmatically.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Twilio is also capable of performing other phone services, such as phone calls and text-to-speech.&nbsp;Check it out in the full documentation.</p>
</div>
</div>
<p>The full Twilio documentation is available here:&nbsp;<a href="https://www.twilio.com/docs/">https://www.twilio.com/docs/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Receiving SMS</em> recipe</li>
<li>The <em>Creating a Telegram bot</em> recipe</li>
</ul>
<h2>Receiving SMS</h2>
<p>SMS can also be received and processed automatically. This enables services such as delivering information on request (for instance, send INFO GOALS to receive the results from the Soccer&nbsp;League), but also more complex flows such as in bots, which can have simple conversations with users that enable rich services such as remotely&nbsp;configuring&nbsp;a thermostat.&nbsp;</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Each time Twilio receives an SMS to one of your registered phone numbers, it performs a request to a publicly available URL. This is configured in the service, meaning it should be under your control. This creates the problem of having a URL under your control available on the internet. This means that just your local computer won't work, as it's not addressable. We will use Heroku (<a href="http://heroku.com">http://heroku.com</a>) to deliver an available service, but there are other alternatives. The Twilio documentation has examples using <kbd>grok</kbd>, which allows for local development by creating a tunnel between a public address and your local development environment. See here for more details:&nbsp;<a href="https://www.twilio.com/blog/2013/10/test-your-webhooks-locally-with-ngrok.html">https://www.twilio.com/blog/2013/10/test-your-webhooks-locally-with-ngrok.html</a>.</p>
</div>
</div>
<p>This way of operating is common in communication APIs. It should be noted that Twilio has a beta API for WhatsApp, which works in a similar way. Check the docs for more information at&nbsp;<a href="https://www.twilio.com/docs/sms/whatsapp/quickstart/python">https://www.twilio.com/docs/sms/whatsapp/quickstart/python</a>.</p>
<h3>Getting ready</h3>
<p>We need to create an account for Twilio at&nbsp;<a href="https://www.twilio.com/">https://www.twilio.com/</a>.&nbsp;Refer to the <em>Getting ready</em> section in the <em>Producing SMS</em>&nbsp;recipe&nbsp;for detailed instructions.</p>
<p>For this recipe, we will also need to set up a web service in Heroku (<a href="https://www.heroku.com/">https://www.heroku.com/</a>) to be able to create a webhook capable of receiving SMS addressed to Twilio. Because the main objective of this recipe is the SMS part, we will be concise when setting up Heroku, but you can refer to its excellent documentation. It is quite easy to use:</p>
<ol>
<li>Create an account in Heroku.</li>
</ol>
<ol start="2">
<li>You'll need to install the command line interface for Heroku (instructions for all platforms are at&nbsp;<a href="https://devcenter.heroku.com/articles/getting-started-with-python#set-up">https://devcenter.heroku.com/articles/getting-started-with-python#set-up</a>) and then log in to the command line:</li>
</ol>
<pre><code class="lang-python">$ heroku login
Enter your Heroku credentials.
Email: your.user@server.com
Password:</code></pre>
<ol start="3">
<li>Download a basic Heroku template from<a href="https://github.com/datademofun/heroku-basic-flask">&nbsp;https://github.com/datademofun/heroku-basic-flask</a>. We will use it as a base for our server.</li>
<li>Add the <kbd>twilio</kbd> client to the <kbd>requirements.txt</kbd> file:</li>
</ol>
<pre><code class="lang-python">$ echo "twilio" &gt;&gt; requirements.txt</code></pre>
<ol start="5">
<li>Replace&nbsp;<kbd>app.py</kbd> with the one in GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/app.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/app.py</a>.</li>
</ol>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>You can keep the existing <kbd>app.py</kbd> to check the template example and how Heroku works. Check out the README at&nbsp;<a href="https://github.com/datademofun/heroku-basic-flask">https://github.com/datademofun/heroku-basic-flask</a>.</p>
</div>
</div>
<ol start="6">
<li>Once done, commit the changes to Git:</li>
</ol>
<pre><code class="lang-python">$ git add .
$ git commit -m 'first commit'</code></pre>
<ol start="7">
<li>Create a new service in Heroku. It will generate a new service name randomly (we use <kbd>service-name-12345</kbd> here). This URL is accessible:</li>
</ol>
<pre><code class="lang-python">$ heroku create
Creating app... done, ⬢ SERVICE-NAME-12345
https://service-name-12345.herokuapp.com/ | https://git.heroku.com/service-name-12345.git</code></pre>
<ol start="8">
<li>Deploy the service. In Heroku, deploying a service pushes the code to the remote Git server:</li>
</ol>
<pre><code class="lang-python">$ git push heroku master
...
remote: Verifying deploy... done.
To https://git.heroku.com/service-name-12345.git
 b6cd95a..367a994 master -&gt; master</code></pre>
<ol start="9">
<li>Check that the service is up and running at the webhook URL. Note it is displayed as output in the previous step. You can also check it in a browser:</li>
</ol>
<pre><code class="lang-python">$ curl https://service-name-12345.herokuapp.com/
All working!</code></pre>
<h3>How to do it...</h3>
<ol>
<li>Go to Twilio and access the&nbsp;PHONE NUMBER&nbsp;section.&nbsp;Configure the webhook URL. This will make the URL be called on each received SMS. Go to the&nbsp;Active&nbsp;Numbers&nbsp;section in&nbsp;All Products and Services&nbsp;|&nbsp;Phone Numbers and fill in the webhook. Note the <kbd>/sms</kbd> at the end of the webhook. Click on Save:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000074.png" class="lazyload" /></p>
<ol start="2">
<li>The service is now up and can be used. Send an SMS to your Twilio phone number and you should get back an automated response:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000026.png" class="lazyload" /></p>
<p>Note the blurred parts should be replaced with your info.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>If you have a trial account, you can only send messages back to one of your authorized phone numbers, so you'll need to send the text from them.</p>
</div>
</div>
<h3>How it works...</h3>
<p>Step 1 sets up the webhook, so Twilio calls your Heroku app when receiving an SMS on the phone line.</p>
<p>Let's take a look at the code in <kbd>app.py</kbd> to see how this works. Here it is redacted for clarity; check the full file at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/app.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/app.py</a>:</p>
<pre><code class="lang-python">...
@app.route('/')
def homepage():
    return 'All working!'

@app.route("/sms", methods=['GET', 'POST'])
def sms_reply():
    from_number = request.form['From']
    body = request.form['Body']
    resp = MessagingResponse()
    msg = (f'Awwwww! Thanks so much for your message {from_number}, '
           f'"{body}" to you too.')

    resp.message(msg)
    return str(resp)
...</code></pre>
<p><kbd>app.py</kbd> can be divided into three parts&mdash;the Python imports at start of the file and startup of the Flask app at the end, which is just setting up Flask (not shown here); the call to&nbsp;<kbd>homepage</kbd>, which is generated to test that the server is working; and <kbd>sms_reply</kbd>, which is where the magic happens.</p>
<p>The <kbd>sms_reply</kbd>&nbsp;function&nbsp;obtains the phone number that sends the SMS, as well as the body of the message, from the <kbd>request.form</kbd> dictionary. Then, compose a response in <kbd>msg</kbd>, attach it to a new&nbsp;<kbd>MessagingResponse</kbd>, and return it.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>We are using the message from the user as a whole, but remember all the techniques to parse text mentioned in Chapter 1, <em>Let Us Begin Our Automation Journey</em>. They are all applicable here to detecting predefined actions or any other text processing.</p>
</div>
</div>
<p>The returned value will be sent back by Twilio to the sender, producing the result seen in step 2.</p>
<h3>There's more...</h3>
<p>To be able to generate automated conversations, the state of the conversation should be stored. For advanced state, it should probably be stored in a database, generating a flow, but for simple cases, storing information in <kbd>session</kbd> may be enough. The session is able to store information in the cookies that is persistent between the same combination of to and from phone numbers, allowing you to retrieve it between messages.</p>
<p>For example, this modification will return not only the send body, but the previous one as well. Only the relevant parts have been included:</p>
<pre><code class="lang-python">app = Flask(__name__)
app.secret_key = b'somethingreallysecret!!!!'
... 
@app.route("/sms", methods=['GET', 'POST'])
def sms_reply():
    from_number = request.form['From']
    last_message = session.get('MESSAGE', None)
    body = request.form['Body']
    resp = MessagingResponse()
    msg = (f'Awwwww! Thanks so much for your message {from_number}, '
           f'"{body}" to you too. ')
    if last_message:
        msg += f'Not so long ago you said "{last_message}" to me..'
    session['MESSAGE'] = body
    resp.message(msg)
    return str(resp)</code></pre>
<p>The previous <kbd>body</kbd> is stored in the <kbd>MESSAGE</kbd>&nbsp;key of the session, which is carried over. Notice the requirement for a secret key to use the session data. Read this for information about it:&nbsp;<a href="http://flask.pocoo.org/docs/1.0/quickstart/?highlight=session#sessions">http://flask.pocoo.org/docs/1.0/quickstart/?highlight=session#sessions</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>To deploy the new version in Heroku, commit the new <kbd>app.py</kbd>&nbsp;to Git, and then do <kbd>git push heroku master</kbd>. The new version will be deployed automatically!</p>
</div>
</div>
<p>Because the main objective of this recipe is to demonstrate how to reply, Heroku and Flask as not described in detail, but they both have excellent documentation. The full documentation for Heroku can be found at&nbsp;<a href="https://devcenter.heroku.com/categories/reference">https://devcenter.heroku.com/categories/reference</a>&nbsp;and the documentation for Flask is here:&nbsp;<a href="http://flask.pocoo.org/docs/">http://flask.pocoo.org/docs/</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Remember, the use of Heroku and Flask is just a convenience for this recipe, as they are great and easy tools to use. There are multiple alternatives to them, as long as you are able to expose a URL so Twilio can call it. Also, check the security measures to ensure that requests to this endpoint come from Twilio: <a href="https://www.twilio.com/docs/usage/security#validating-requests">https://www.twilio.com/docs/usage/security#validating-requests</a>.</p>
</div>
</div>
<p>The full documentation for Twilio can be found here:&nbsp;<a href="https://www.twilio.com/docs/">https://www.twilio.com/docs/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Producing SMS</em> recipe</li>
<li>The <em>Creating a Telegram bot</em> recipe</li>
</ul>
<h2>Creating a Telegram bot</h2>
<p>Telegram Messenger is an instant messaging app that has good support for creating bots. Bots are small applications that aim to produce automatic conversations. The big promise of bots is as machines that can create any kind of conversation, totally indistinguishable from a conversation with a human being, and pass the <em>Turing Test,</em>&nbsp;but that objective is quite ambitious and not realistic yet for the most part.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The Turing Test was proposed by Alan Turing in 1951. Two participants, a human and an Artificial Intelligence (a machine or software program), communicate via text (like in an instant messaging app) with a human judge that decides which one is human and which one is not. If the judge can only guess correctly 50% of the time, it can't be easily differentiated and therefore the AI passes the test. This was one of the first attempts to measure Artificial Intelligence.</p>
</div>
</div>
<p>But bots can be very useful with a more limited approach, similar to phone systems where you need to press <em>2</em> for checking your account, and press <em>3</em> for reporting a missing card. We'll see in this recipe how to generate a simple bot that will display offers and events for a company.</p>
<h3>Getting ready</h3>
<p>We need to create a new bot for Telegram. This is done through an interface called <strong>the BotFather</strong>, which is a Telegram special channel that allows us to create a new bot. You can access the channel here:&nbsp;<a href="https://telegram.me/botfather">https://telegram.me/botfather</a>. Access it through your Telegram account.</p>
<p>Run <kbd>/start</kbd> to start the interface and then create a new bot with <kbd>/newbot</kbd>. The interface will ask you the name of the bot and a username, which should be unique.</p>
<p>Once it's set up, it will give you the following:</p>
<ul>
<li>The Telegram channel of your bot&mdash;<kbd>https:/t.me/&lt;yourusername&gt;</kbd>.</li>
<li>A token to allow access the bot. Copy it as it will be used later.</li>
</ul>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>You can generate a new token if you lose it. Read The BotFather's documentation.</p>
</div>
</div>
<p>We also need to install the Python module <kbd>telepot</kbd>, which wraps the RESTful interface from Telegram:</p>
<pre><code class="lang-python">$ echo "telepot==12.7" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>Download the <kbd>telegram_bot.py</kbd>&nbsp;script&nbsp;from GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/telegram_bot.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/telegram_bot.py</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Setup your generated token into the <kbd>telegram_bot.py</kbd> script on the <kbd>TOKEN</kbd> constant in line 6:</li>
</ol>
<pre><code class="lang-python">TOKEN = '&lt;YOUR TOKEN&gt;'</code></pre>
<ol start="2">
<li>Start the bot:</li>
</ol>
<pre><code class="lang-python">$ python telegram_bot.py</code></pre>
<ol start="3">
<li>&nbsp;Open the Telegram channel in your phone using the URL and start it. You can use the <kbd>help</kbd>, <kbd>offers</kbd>, and <kbd>events</kbd>&nbsp;commands:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000024.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>Step 1 sets the token to use for your specific channel. In step 2, we start the bot locally.</p>
<p>Let's see how the code in <kbd>telegram_bot.py</kbd> is structured:</p>
<pre><code class="lang-python">IMPORTS

TOKEN

# Define the information to return per command
def get_help():
def get_offers():
def get_events():
COMMANDS = {
    'help': get_help,
    'offers': get_offers,
    'events': get_events,
}

class MarketingBot(telepot.helper.ChatHandler):
...


# Create and start the bot

</code></pre>
<p>The <kbd>MarketingBot</kbd> class creates an interface to handle the communication with Telegram:</p>
<ul>
<li>When the channel is started, the <kbd>open</kbd> method will be called</li>
<li>When a message is received, the <kbd>on_chat_message</kbd> method will be called</li>
<li>If there's no answer in a while, <kbd>on_idle</kbd> will be called</li>
</ul>
<p>In each case, the <kbd>self.sender.sendMessage</kbd>&nbsp;method&nbsp;is used to send a message back to the user. Most of the interesting bits happen in <kbd>on_chat_message</kbd>:</p>
<pre><code class="lang-python">def on_chat_message(self, msg):
    # If the data sent is not test, return an error
    content_type, chat_type, chat_id = telepot.glance(msg)
    if content_type != 'text':
        self.sender.sendMessage("I don't understand you. "
                                "Please type 'help' for options")
        return

    # Make the commands case insensitive
    command = msg['text'].lower()</code></pre>
<pre><code class="lang-python">
    if command not in COMMANDS:
        self.sender.sendMessage("I don't understand you. "
                                "Please type 'help' for options")
        return

    message = COMMANDS[command]()
    self.sender.sendMessage(message)</code></pre>
<p>First, it checks whether the received message is text and returns an error message if it's not. It analyzes the received text, and if it's one of the defined commands, it executes the corresponding function to retrieve the text to return.</p>
<p>Then, it sends the message back to the user.</p>
<p>Step 3 shows how this works from the point of view of the user who is interacting with the bot.</p>
<h3>There's more...</h3>
<p>You can add more info, an avatar picture, and so on to your Telegram channel using the <kbd>BotFather</kbd> interface.</p>
<p>To simplify our interface, we can create a custom keyboard to simplify the bot. Create it after defining the commands, around line 44 of the script:</p>
<pre><code class="lang-python">from telepot.namedtuple import ReplyKeyboardMarkup, KeyboardButton
keys = [[KeyboardButton(text=text)] for text in COMMANDS]
KEYBOARD = ReplyKeyboardMarkup(keyboard=keys)</code></pre>
<p>Notice it is creating a keyboard with three rows, each with one of the commands. Then, add the resulting&nbsp;<kbd>KEYBOARD</kbd> as the <kbd>reply_markup</kbd> on each of the <kbd>sendMessage</kbd> calls, for example as follows:</p>
<pre><code class="lang-python"> message = COMMANDS[command]()
 self.sender.sendMessage(message, reply_markup=KEYBOARD)</code></pre>
<p>This replaces the keyboard with only the defined buttons, making&nbsp;the interface&nbsp;very obvious:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000018.png" class="lazyload" /></p>
<p>These changes can be downloaded in the&nbsp;<kbd>telegram_bot_custom_keyboard.py</kbd>&nbsp;file, available in GitHub here:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/telegram_bot_custom_keyboard.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter08/telegram_bot_custom_keyboard.py</a>.</p>
<p>You can create other kinds of custom interfaces, such as inline buttons or even a platform for creating games. Check the Telegram API docs for more information.</p>
<p>Interacting with Telegram can&nbsp;also&nbsp;be done through webhooks, in a similar way as presented in the&nbsp;Receiving SMS&nbsp;recipe. Check the example for Flask in the <kbd>telepot</kbd> documentation here:&nbsp;<a href="https://github.com/nickoala/telepot/tree/master/examples/webhook">https://github.com/nickoala/telepot/tree/master/examples/webhook</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Setting up a Telegram webhook can be done through <kbd>telepot</kbd>. It requires that your service is behind an HTTPS address to ensure the communication is private. This can be tricky to do with simple services. You can check the documentation on setting up a webhook in the Telegram docs:&nbsp;<a href="https://core.telegram.org/bots/api#setwebhook">https://core.telegram.org/bots/api#setwebhook</a>.</p>
</div>
</div>
<p>The full Telegram API for bots can be found here:&nbsp;<a href="https://core.telegram.org/bots">https://core.telegram.org/bots</a>.</p>
<p>The documentation for the <kbd>telepot</kbd> module is found here:&nbsp;<a href="https://telepot.readthedocs.io/en/latest/">https://telepot.readthedocs.io/en/latest/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Producing SMS</em> recipe</li>
<li>The <em>Receiving SMS</em> recipe</li>
</ul>

</div>


<!--Chapter 9-->

<div class="chapter" data-chapter-number="9">
<div class="chapter-start">
<div class="ch-head">Chapter <span class="chapter-number"> 9 </span></div>
<h1 class="chaptertitle">Why Not Automate Your Marketing Campaign?</h1>
<h3 class="author">Jaime Buelta</h3>
</div>


<p>In this chapter, we will cover the following recipes, which are related to a marketing campaign:</p>
<ul>
<li>Detecting the opportunities</li>
<li>Creating personalized&nbsp;coupon codes</li>
<li>Sending a notification to the customer on their preferred&nbsp;channel</li>
<li>Preparing sales information</li>
<li>Generating a sales report</li>
</ul>
<h2>Introduction</h2>
<p>In this chapter, we will create a whole marketing campaign, going through each of the automatic steps we'll take.&nbsp;We will leverage all the concepts and recipes throughout the book in a single project that will require different steps.&nbsp;</p>
<p>Let's take an example.&nbsp;For our project, our company&nbsp; wishes to set up up&nbsp;a marketing campaign to improve engagement and sales. A very laudable effort. To do so, we can divide the action into several steps:</p>
<ol>
<li>We want to detect the best moment to launch the campaign, so we will be notified from different sources about keywords that will help us make an informed decision</li>
<li>The campaign will include the generation of individual codes to be sent to potential customers</li>
</ol>
<ol start="3">
<li>Parts of these codes will be sent directly to users over their preferred channel, text message or email</li>
<li>To monitor the result of the campaign, the sales information will be compiled and a sales report will be generated</li>
</ol>
<p>This chapter will go through each of these steps and present a combined solution based on modules and techniques that have been introduced in the book.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>While these examples have been created with real-life requirements in mind, take into account that your specific environment will always surprise you. Don't be afraid to experiment, tweak, and improve your system as you learn more about it. Iterating is the way to create great systems.</p>
</div>
</div>
<p>Let's get to it!</p>
<h2>Detecting the opportunities</h2>
<p>In this recipe, we present a marketing campaign that is divided into several steps:</p>
<ol>
<li>Detect the best moment to launch the campaign</li>
<li>Generate individual codes to be sent to potential customers</li>
<li>Send the codes directly to users over their preferred channel, text message or email</li>
<li>Collate the results of the campaign and generate a sales report with analysis of the results</li>
</ol>
<p>This recipe shows step 1 of the campaign.</p>
<p>Our first stage is to detect the best time to launch a campaign. To do so, we will monitor a list of news sites, searching for news containing one of our defined keywords. Any article that matches these keywords will be added to a report that will be sent in an email.</p>
<h3>Getting ready</h3>
<p>In this recipe, we will use several external modules previously presented in the book, <kbd>delorean</kbd>, <kbd>requests</kbd>, and&nbsp;<kbd>BeautifulSoup</kbd>. We need to add them to our virtual environment if not already there:</p>
<pre><code class="lang-python">$ echo "delorean==1.0.0" &gt;&gt; requirements.txt
$ echo "requests==2.18.3" &gt;&gt; requirements.txt
$ echo "beautifulsoup4==4.6.0" &gt;&gt; requirements.txt
$ echo "feedparser==5.2.1" &gt;&gt; requirements.txt
$ echo "jinja2==2.10" &gt;&gt; requirements.txt
$ echo "mistune==0.8.3" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>You need to make a list of RSS feeds, from which we will put our data.&nbsp;</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>In our example, we use the following feeds, which are all technology feeds in well-known news sites:&nbsp;<br /><a href="http://feeds.reuters.com/reuters/technologyNews">http://feeds.reuters.com/reuters/technologyNews</a><br /><a href="http://rss.nytimes.com/services/xml/rss/nyt/Technology.xml">http://rss.nytimes.com/services/xml/rss/nyt/Technology.xml</a><br /><a href="http://feeds.bbci.co.uk/news/science_and_environment/rss.xml">http://feeds.bbci.co.uk/news/science_and_environment/rss.xml</a></p>
</div>
</div>
<p>Download the <kbd>search_keywords.py</kbd> script, which will perform the actions, from GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/search_keywords.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/search_keywords.py</a>.<br />You also need to download the email templates, which can be found at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/email_styling.html">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/email_styling.html</a> and <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/email_template.md">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/email_template.md</a>.<br />There is a config template in&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/config-opportunity.ini">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/config-opportunity.ini</a>.</p>
<p>You need a valid username and password for an email service. Check the&nbsp;<em>Sending an individual email</em>&nbsp;recipe in&nbsp;Chapter 8,&nbsp;<em>Dealing with Communication Channels</em>.</p>
<h3>How to do it...</h3>
<ol>
<li>Create a <kbd>config-opportunity.ini</kbd> file, which should be in the following format. Remember to fill it with your details:&nbsp;</li>
</ol>
<pre><code class="lang-python">[SEARCH]
keywords = keyword, keyword
feeds = feed, feed

[EMAIL]
user = &lt;YOUR EMAIL USERNAME&gt;
password = &lt;YOUR EMAIL PASSWORD&gt;
from = &lt;EMAIL ADDRESS FROM&gt;
to = &lt;EMAIL ADDRESS TO&gt;</code></pre>
<p>You can use the template from&nbsp; GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/config-opportunity.ini">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/config-opportunity.ini</a> to search for the keyword&nbsp;<kbd>cpu</kbd><em>&nbsp;</em>and some test feeds. Remember to fill in the <kbd>EMAIL</kbd> fields with your own account details.</p>
<ol start="2">
<li>Call the script to produce the email and report:</li>
</ol>
<pre><code class="lang-python">$ python search_keywords.py config-opportunity.ini</code></pre>
<ol start="3">
<li>Check the <kbd>to</kbd>&nbsp;email, and you should receive a report with the articles&nbsp;found. It should be something similar to this:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000056.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>After creating the proper configuration for the script in step 1, web scraping and sending an email with the results&nbsp;is done in step 2&nbsp;by&nbsp;calling <kbd>search_keywords.py</kbd>.</p>
<p>Let's take a look at the&nbsp;<kbd>search_keywords.py</kbd> script. The code is structured into the following parts:</p>
<ul>
<li>The <kbd>IMPORTS</kbd> section makes available all the Python modules to be used later. It also defines&nbsp;<kbd>EmailConfig&nbsp;namedtuple</kbd> to help with handling the email parameters.&nbsp;</li>
<li><kbd>READ TEMPLATES</kbd> retrieves the email templates and stores them for later use in the&nbsp;<kbd>EMAIL_TEMPLATE</kbd> and&nbsp;<kbd>EMAIL_STYLING</kbd> constants.</li>
<li>The <kbd>__main__</kbd> block starts the process by, getting the configuration parameters, parsing the config file, and then calling the main function.</li>
<li>The <kbd>main</kbd> function combines the other functions. First, it retrieves the articles, and then it obtains the body and sends the email.</li>
<li><kbd>get_articles</kbd> walks through all the feeds, discards any article that is over a week old, retrieves each of them, and searches for a match on the keywords. All the matched articles are returned, including information about the link and a summary.</li>
<li><kbd>compose_email_body</kbd> uses the email templates to compile the email body. Notice that the template is in Markdown and it gets parsed into HTML, to give the same information in plain-text and in HTML.</li>
<li><kbd>send_email</kbd> gets the body information, as well as required info such as the username/password, and finally sends the email.</li>
</ul>
<h3>There's more...</h3>
<p>One of the main challenges in retrieving information from different sources is to parse the text in all cases. Some of the feeds may return information in different formats.</p>
<p>For instance, in our example you can see that the Reuters feed summary includes HTML information that gets rendered in the resulting email. If you have that kind of problem, you may need to process the returned data further, until it becomes consistent. This may be highly dependent on the expected quality of the resulting report.&nbsp;</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>When developing automatic tasks, especially when dealing with multiple input sources, expect to spend a lot of time cleaning the input in a way that's consistent. But, on the other hand, find a balance and keep in mind the final recipient. If the email is to be received, for example, by yourself or an understanding teammate, you can be a little bit more permissive than in the case of an important client.</p>
</div>
</div>
<p>Another possibility is to increase the complexity of the match. In this recipe, the check is done with a simple <kbd>in</kbd>, but remember that all the techniques in Chapter 1, <em>Let Us Begin Our Automation Journey,&nbsp;</em> including all the regular expression capabilities, are available for you to use.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>This script is automatable through a cron job as&nbsp;described in Chapter 2, <em>Automating Tasks Made Easy</em>. Try to run it every week!</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The <em>Adding command line arguments</em> recipe in Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em>&nbsp;</li>
<li>The Introducing regular expressions recipe in Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em>&nbsp;</li>
<li>The <em>Preparing a task</em> recipe in Chapter 2,&nbsp;<em>Automating Tasks Made Easy</em></li>
<li>The&nbsp;<em>Setting up a cron job</em> in&nbsp;Chapter 2,&nbsp;<em>Automating Tasks Made Easy</em></li>
<li>The <em>Parsing HTML</em> in Chapter 3,&nbsp;<em>Building Your First Web Scraping Application</em></li>
<li>The <em>Crawling the web</em> recipe in Chapter 3,&nbsp;<em>Building Your First Web Scraping Application</em></li>
<li>The Subscribing to feeds recipe in&nbsp;&nbsp;Chapter 3,&nbsp;<em>Building Your First Web Scraping Application</em></li>
<li>The Sending an individual email recipe in Chapter 8,&nbsp;<em>Dealing with Communication Channels</em></li>
</ul>
<h2>Creating personalized coupon codes</h2>
<p>In this chapter, we are presenting a marketing campaign divided into steps:</p>
<ol>
<li>Detect the best moment to launch the campaign</li>
<li>Generate individual codes to be sent to potential customers</li>
<li>Send the codes directly to users over their preferred channel, text message or email</li>
<li>Collect the results of the campaign</li>
<li>Generate a sales report with analysis of the results</li>
</ol>
<p>This recipe shows step 2 of the campaign.</p>
<p>After an opportunity is detected, we decide to generate a campaign for all customers. To direct promotions and avoid duplication, we will generate a million unique coupons, divided into three batches:</p>
<ul>
<li>Half of the codes will be printed and distributed in a marketing action</li>
<li>300,000 codes&nbsp;will be reserved to be used later if the campaign hits some goals</li>
<li>The remainder 200,000&nbsp;will be directed to customers through SMS and emails, as we will see later</li>
</ul>
<p>These coupons can be redeemed in the online system. Our task will be to generate the proper codes, which should meet the following requirements:</p>
<ul>
<li>The codes need to be unique</li>
<li>The codes need to be printable and easy to read, as some customers will be dictating them over the phone</li>
<li>There should be a quick way of discarding codes before checking them (avoiding spam attacks)</li>
<li>The codes should be presented in a CSV format for printing</li>
</ul>
<h3>Getting ready</h3>
<p>Download the <kbd>create_personalised_coupons.py</kbd>&nbsp;script, which will generate the coupons in CSV files, from GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/create_personalised_coupons.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/create_personalised_coupons.py</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Call the <kbd>create_personalised_coupons.py</kbd>&nbsp;script. It will take a minute or two to run, depending on your computer speed. It will display the generated codes onscreen:</li>
</ol>
<pre><code class="lang-python">$ python create_personalised_coupons.py
Code: HWLF-P9J9E-U3
Code: EAUE-FRCWR-WM
Code: PMW7-P39MP-KT
...</code></pre>
<ol start="2">
<li>Check it created three CSV files with the codes <kbd>codes_batch_1.csv</kbd>, <kbd>codes_batch_2.csv</kbd>, and <kbd>codes_batch_3.csv</kbd>, each with the proper number of codes:</li>
</ol>
<pre><code class="lang-python">$ wc -l codes_batch_*.csv
  500000 codes_batch_1.csv
  300000 codes_batch_2.csv
  200000 codes_batch_3.csv
 1000000 total</code></pre>
<ol start="3">
<li>Check that each of the batch files contains unique codes. Your codes will be unique and different from the ones displayed here:</li>
</ol>
<pre><code class="lang-python">$ head codes_batch_2.csv
9J9F-M33YH-YR
7WLP-LTJUP-PV
WHFU-THW7R-T9
...</code></pre>
<h3>How it works...</h3>
<p>Step 1 calls the script that generates all the codes, and step 2 checks that the results are correct. Step 3 shows the format in which the codes are stored. Let's analyze the <kbd>create_personalised_coupons.py</kbd> script.</p>
<p>In summary, it has the following structure:</p>
<pre><code class="lang-python"># IMPORTS

# FUNCTIONS
def random_code(digits)
def checksum(code1, code2)
def check_code(code)
def generate_code()

# SET UP TASK

# GENERATE CODES

# CREATE AND SAVE BATCHES</code></pre>
<p>The different functions work together to create a code. <kbd>random_code&nbsp;</kbd> generates a combination of random letters and numbers, taken from <kbd>CHARACTERS</kbd>.&nbsp; This string contains all the valid characters to choose from.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The selection of characters is defined as symbols that are easy to print and not mistake for each other. For example, it will be difficult to distinguish between a letter O and the number 0, or the number 1 and the letter I, depending on the font. This may depend on the specifics, so check printing tests if necessary to tailor the characters. But avoid using all letter and numbers, as it may cause confusion. Increase the length of the codes if necessary.</p>
</div>
</div>
<p>The <kbd>checksum</kbd>&nbsp;function&nbsp;generates, based on two codes, an extra digit that is derived from the two codes. This process is called <strong>hashing</strong>, and it's a well known process in computing, especially for cryptography.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The basic function of hashing is to produce an output from an input that is smaller and is&nbsp;not reversible, meaning it's&nbsp;very difficult to guess unless the input is known. Hashing has a lot of common applications in computing, normally under the hood. For example, Python dictionaries make extensive use of hashing.</p>
</div>
</div>
<p>In our recipe, we'll use&nbsp;SHA256,&nbsp;a well known fast hashing algorithm included in the Python <kbd>hashlib</kbd> module:</p>
<pre><code class="lang-python">def checksum(code1, code2):
    m = hashlib.sha256()
    m.update(code1.encode())
    m.update(code2.encode())
    checksum = int(m.hexdigest()[:2], base=16)
    digit = CHARACTERS[checksum % len(CHARACTERS)]
    return digit</code></pre>
<p>Both codes are added as input, and the resulting two hex digits of the hash are applied over <kbd>CHARACTERS</kbd> to obtain one of the available characters. The digits get transformed into a number (as they are in base 16) and we apply the <kbd>modulo</kbd> operator to be sure to obtain one of the available characters.</p>
<p>The objective of this checksum is to be able to quickly check whether a code looks like it is correct and discard possible spam. We can produce the operation again over a code to see whether the checksum is the same. Note that this is not a cryptographic hash, as no secret is required at any point of the operation. Given this specific use case, this (low) level of security is probably fine for our purposes.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Cryptography is a much bigger theme and ensuring that security is strong can be difficult. The main strategy in cryptography involving hashing is probably to store just the hash to avoid storing passwords in a readable format. You can read a quick intro to that here:&nbsp;<a href="https://crackstation.net/hashing-security.htm">https://crackstation.net/hashing-security.htm</a>.</p>
</div>
</div>
<p>The <kbd>generate_code</kbd>&nbsp;function&nbsp;then produces a random code, composed of four digits, then five digits, and then two digits of the checksum, divided by dashes. The first digit is generated with the first nine digits in order (four then five), and the second reversing them (five then four).</p>
<p>The <kbd>check_code</kbd>&nbsp;function&nbsp;reverses the process and returns <kbd>True</kbd> if the code is correct, and&nbsp;<kbd>False</kbd> otherwise.</p>
<p>With the basic elements in place, the script starts by defining the required batches&mdash;500,000, 300,000, and 200,000.</p>
<p>All the codes are generated in the same pool, called <kbd>codes</kbd>. This is to avoid duplicates between pools. Note that, due to the randomness of the process, we can't rule out the possibility of generating a duplicated code, though this is small. We allow to retry up to three times to avoid generating a duplicate code. The codes are added to a set accumulator to guarantee their uniqueness and to speed up checking whether a code is already there.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p><kbd>sets</kbd> are another of the places where Python uses hashing under the hood, so it hashes the element to be added and compares it with the hashes of the elements already there. This makes checking in sets very quick.</p>
</div>
</div>
<p>To be sure that the process is correct, each code is verified and printed to display&nbsp;progress while generating the code and allow inspecting that everything is working as expected.</p>
<p>Finally, the codes are divided into the proper number of batches and each one is saved in an individual <kbd>.csv</kbd> file. The codes are removed removed&nbsp;one by one from <kbd>codes</kbd>&nbsp;using <kbd>.pop()</kbd> until the <kbd>batch</kbd> has the proper size:</p>
<pre><code class="lang-python">batch = [(codes.pop(),) for _ in range(batch_size)]</code></pre>
<p>Note how the previous line creates a batch of the proper size of rows with a single element. Each row is still a list, as it should be for a CSV file.</p>
<p>Then, a file is created and, using a&nbsp;<kbd>csv.writer</kbd>, the codes are stored as rows.</p>
<p>As a final test, the remaining <kbd>codes</kbd> are verified to be empty.</p>
<h3>There's more...</h3>
<p>In this recipe, a direct approach has been used in the flow. This is in opposition to the principles presented in the&nbsp;<em>Preparing a task to run</em> recipe in&nbsp;Chapter 2, <em>Automating Tasks Made Easy</em>. Notice that, compared with the tasks presented there, this script is aimed to be run a single time to produce the codes, and that's it. It also uses defined constants, such as&nbsp;<kbd>BATCHES</kbd>, for configuration.</p>
<p>Given that it is a unique task, designed to be run once, spending time structuring it into a reusable component is probably not the best use of our time.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Over-engineering is definitively possible, and choosing between a pragmatic design and a more future-facing approach may not be easy. Be realistic about maintenance costs and try to find your own balance.</p>
</div>
</div>
<p>In the same way, the design in this recipe on the checksum is aimed to give a minimum way to check whether a code is totally made up or looks legit. Given that codes will be checked against a system, this seems like a sensible approach, but be aware of your particular use case.</p>
<p>Our code space is of <kbd>22 characters ** 9 digits =&nbsp;1,207,269,217,792 possible codes</kbd>, meaning the probability of guessing one of the million generated is very small. Is also not very likely to produce the same code twice, but nevertheless, we protected our code against that with up to three retries.</p>
<p>These kinds of checks, as well as checking that each code verifies and that we end up with no remaining codes, are very useful when developing this kind of script. It ensures that we are going in the right direction and things are going according to plan. Just be aware that <kbd>asserts</kbd> may not be executed in some conditions.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>As described in the Python documentation, <kbd>assert</kbd> commands are ignored if the Python code is optimized (run with the <kbd>-O</kbd> command). See the documentation here&nbsp;<a href="https://docs.python.org/3/reference/simple_stmts.html#the-assert-statement">https://docs.python.org/3/reference/simple_stmts.html#the-assert-statement</a>. This is normally not done, but can be confusing if that's the case. Avoid depending heavily on <kbd>asserts</kbd>.</p>
</div>
</div>
<p>Learning the basics of cryptography is not as difficult as you may assume. There are a small number of basic schema that are well known and easily learned.&nbsp;A good introduction article is this one,&nbsp;<a href="https://thebestvpn.com/cryptography/">https://thebestvpn.com/cryptography/</a>. Python also has a good number of cryptographic functions integrated; see the documentation at&nbsp;<a href="https://docs.python.org/3/library/crypto.html">https://docs.python.org/3/library/crypto.html</a>. The best approach is to find a good book and know that, while it's a difficult subject to truly master, it is definitely approachable.</p>
<h3>See also</h3>
<ul>
<li>The <em>Introducing regular expressions</em> recipe in Chapter 1, <em>Let Us Begin Our Automation Journey&nbsp;</em></li>
<li>The <em>Reading CSV files</em> recipe in Chapter 4,&nbsp;<em>Searching and Reading Local Files</em></li>
</ul>
<h2>Sending a notification to the customer on their preferred channel</h2>
<p>In this chapter, we are presenting a marketing campaign divided into several steps:</p>
<ol>
<li>Detect the best moment to launch the campaign</li>
<li>Generate individual codes to be sent to potential customers</li>
<li>Send the codes directly to users over their preferred channel, text message or email</li>
<li>Collect the results of the campaign</li>
<li>Generate a sales report with analysis of the results</li>
</ol>
<p>This recipe shows step 3 of the campaign.</p>
<p>Once our codes are created for direct marketing, we need to distribute them to our customers.</p>
<p>For this recipe, from an input from a CSV file with the information of all customers and their preferred contact methods, we will fill the file&nbsp;with the codes generated previously, and then send a notification through the proper method that will include the promotional code.</p>
<h3>Getting ready</h3>
<p>In this recipe, we will use several modules&nbsp;already presented&mdash;<kbd>delorean</kbd>, <kbd>requests</kbd>, and <kbd>twilio</kbd>. We need to add them to our virtual environment if not already there:</p>
<pre><code class="lang-python">$ echo "delorean==1.0.0" &gt;&gt; requirements.txt
$ echo "requests==2.18.3" &gt;&gt; requirements.txt
$ echo "twilio==6.16.3" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>We need to define a <kbd>config-channel.ini</kbd> file with our credentials for the services to use, Mailgun and Twilio.&nbsp;A template of this file can be found in GitHub here:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/config-channel.ini">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/config-channel.ini</a>.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>For information on how to obtain the credentials, refer to the&nbsp;<em>Sending notifications via emails</em>&nbsp;and&nbsp;<em>Producing SMS</em>&nbsp;recipes&nbsp;Chapter 8,&nbsp;<em>Dealing with Communication Channels</em></p>
</div>
</div>
<p>The file has the following format:</p>
<pre><code class="lang-python">[MAILGUN]
KEY = &lt;YOUR KEY&gt;
DOMAIN = &lt;YOUR DOMAIN&gt;
FROM = &lt;YOUR FROM EMAIL&gt;
[TWILIO]
ACCOUNT_SID = &lt;YOUR SID&gt;
AUTH_TOKEN = &lt;YOUR TOKEN&gt;
FROM = &lt;FROM TWILIO PHONE NUMBER&gt;</code></pre>
<p>For a description of all the contacts to target, we need to generate a CSV file, <kbd>notifications.csv</kbd>, in the following format:</p>
<table border="1">
<tbody>
<tr>
<td>Name</td>
<td>Contact Method</td>
<td>Target</td>
<td>Status</td>
<td>Code</td>
<td>Timestamp</td>
</tr>
<tr>
<td>John Smith</td>
<td>PHONE</td>
<td>+1-555-12345678</td>
<td><kbd>NOT-SENT</kbd></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Paul Smith</td>
<td>EMAIL</td>
<td><kbd>paul.smith@test.com</kbd></td>
<td><kbd>NOT-SENT</kbd></td>
<td></td>
<td></td>
</tr>
<tr>
<td>&hellip;</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Note that the <kbd>Code</kbd>&nbsp;column is empty, and all statuses should be <kbd>NOT-SENT</kbd> or empty.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>If you are using a test account in Twilio and Mailgun, be aware of its limitations. For example, Twilio only allows you to send messages to authenticated phone numbers. You can create a small CSV with only two or three contacts to test the script.</p>
</div>
</div>
<p>The coupon codes to be used should be ready in a CSV file. You can generate several batches with the <kbd>create_personalised_coupons.py</kbd>&nbsp;script, available in GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/create_personalised_coupons.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/create_personalised_coupons.py</a>.</p>
<p>Download the script to be used, <kbd>send_notifications.py</kbd>, from GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/send_notifications.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/send_notifications.py</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Run <kbd>send_notifications.py</kbd> to see its options and usage:</li>
</ol>
<pre><code class="lang-python">$ python send_notifications.py --help
usage: send_notifications.py [-h] [-c CODES] [--config CONFIG_FILE] notif_file

positional arguments:
  notif_file notifications file

optional arguments:
  -h, --help show this help message and exit
  -c CODES, --codes CODES
                        Optional file with codes. If present, the file will be
                        populated with codes. No codes will be sent
  --config CONFIG_FILE config file (default config.ini)</code></pre>
<ol start="2">
<li>Add the codes to the <kbd>notifications.csv</kbd> file:</li>
</ol>
<pre><code class="lang-python">$ python send_notifications.py --config config-channel.ini notifications.csv -c codes_batch_3.csv 
$ head notifications.csv
Name,Contact Method,Target,Status,Code,Timestamp
John Smith,PHONE,+1-555-12345678,NOT-SENT,CFXK-U37JN-TM,
Paul Smith,EMAIL,paul.smith@test.com,NOT-SENT,HJGX-M97WE-9Y,
...</code></pre>
<ol start="3">
<li>Finally, send the notifications:</li>
</ol>
<pre><code class="lang-python">$ python send_notifications.py --config config-channel.ini notifications.csv
$ head notifications.csv
Name,Contact Method,Target,Status,Code,Timestamp
John Smith,PHONE,+1-555-12345678,SENT,CFXK-U37JN-TM,2018-08-25T13:08:15.908986+00:00
Paul Smith,EMAIL,paul.smith@test.com,SENT,HJGX-M97WE-9Y,2018-08-25T13:08:16.980951+00:00
...</code></pre>
<ol start="4">
<li>Check the emails and phones to verify the messages were received.</li>
</ol>
<h3>How it works...</h3>
<p>Step 1 shows the use of the script. The general idea is to call it several times, the first to fill it with codes, and the second to send the messages. If there's an error, the script can be executed again, and only messages not previously sent will be retried.</p>
<p>The <kbd>notifications.csv</kbd> file gets the codes that will be injected in step 2. The codes are finally sent in step 3.</p>
<p>Let's analyze the code of&nbsp;<kbd>send_notifications.py</kbd>. Only the most relevant bits are shown here:</p>
<pre><code class="lang-python"># IMPORTS

def send_phone_notification(...):
def send_email_notification(...):
def send_notification(...):

def save_file(...):
def main(...):

if __name__ == '__main__':
    # Parse arguments and prepare configuration
    ...</code></pre>
<p>The main function goes through the file line by line and analyzes what to do in each case. If the entry is <kbd>SENT</kbd>, it skips it. If it has no code, it tries to fill it. If it tries to send it, it will attach the timestamp to record when it was sent or tried to be sent.</p>
<p>For each entry, the whole file is saved again&nbsp;in a file called <kbd>save_file</kbd>. Notice how the file cursor is positioned at the start of the file, the file is written, and then flushed to disk. This makes the file overwritten on each entry operation, without having to close and open the file again.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Why write the whole file for each entry? This is to allow you to retry. If one of the entries produces an unexpected error or a timeout, or even if there's a general failure, all the progress and previous codes will be marked as <kbd>SENT</kbd> already, and not sent a second time. This means the operation can be retried needed. For a huge number of entries, this is a good way of ensuring that a problem in the middle of the process doesn't make us resend messages to our customers.</p>
</div>
</div>
<p>For each code to be sent, the <kbd>send_notification</kbd>&nbsp;function&nbsp;decides to call&nbsp;either&nbsp;<kbd>send_phone_notification</kbd> or <kbd>send_email_notification</kbd>. It appends the current time in both cases.</p>
<p>Both <kbd>send</kbd> functions return an error&nbsp;if they can't send the message. This allows you to mark it in the resulting <kbd>notifications.csv</kbd> and retry it later.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The <kbd>notifications.csv</kbd> file can also be changed manually. For example, imagine there's a typo in an email and that's the reason for the error. It can be changed and retried.</p>
</div>
</div>
<p><kbd>send_email_notification</kbd>&nbsp;sends the message based on the Mailgun interface. For more information, refer to the&nbsp;<em>Sending notifications via emails</em>&nbsp;recipe in Chapter 8, <em>Dealing with Communication Channels</em>. Note that the email sent here is text only.</p>
<p><kbd>send_phone_notification</kbd> sends the message based on the Twilio interface.&nbsp;For more information, refer to the <em>Producing SMS</em> recipe in Chapter 8, <em>Dealing with Communication Channels</em>.</p>
<h3>There's more...</h3>
<p>The format of the timestamp has been deliberately written in ISO format, as it is a parsable format. This means that we can get back a proper object in an easy way, like this:</p>
<pre><code class="lang-python">&gt;&gt;&gt; import datetime
&gt;&gt;&gt; timestamp = datetime.datetime.now(datetime.timezone.utc).isoformat()
&gt;&gt;&gt; timestamp
'2018-08-25T14:13:53.772815+00:00'
&gt;&gt;&gt; datetime.datetime.fromisoformat(timestamp)
datetime.datetime(2018, 9, 11, 21, 5, 41, 979567, tzinfo=datetime.timezone.utc)</code></pre>
<p>This allows you to easily parse&nbsp;the timestamp&nbsp;back and forth.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>ISO 8601 time format is well supported in most programming languages and&nbsp;very precisely&nbsp;defines the time, as it includes the time zone. It is an excellent choice for recording times, if you can use it.</p>
</div>
</div>
<p>The strategy used in <kbd>send_notification</kbd> to route the notifications is an interesting one:</p>
<pre><code class="lang-python"># Route each of the notifications
METHOD = {
    'PHONE': send_phone_notification,
    'EMAIL': send_email_notification,
}
try:
    method = METHOD[entry['Contact Method']]
    result = method(entry, config)
except KeyError:
    result = 'INVALID_METHOD'</code></pre>
<p>The <kbd>METHOD</kbd> dictionary assigns each of the possible&nbsp;<kbd>Contact Method</kbd>&nbsp;to a function that has the same definition, accepting both an entry and a config.</p>
<p>Then, based on the specific method, the function is retrieved from the dictionary and called. Note the <kbd>method</kbd> variable contains the correct function to call.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>This acts in a similar way to the <kbd>switch</kbd> operation that is available in other programming languages.&nbsp;It is also possible to achieve this through <kbd>if&hellip;else</kbd> blocks. For simple cases like this code, the dictionary method makes the code very readable.</p>
</div>
</div>
<p>The <kbd>invalid_method</kbd>&nbsp;function&nbsp;is used as a default. If the <kbd>Contact Method</kbd> is not one of the available ones (<kbd>PHONE</kbd> or <kbd>EMAIL</kbd>), a <kbd>KeyError</kbd> will be raised, captured, and the result will be defined as <kbd>INVALID METHOD</kbd>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Sending notifications via emails</em> recipe in Chapter 8,&nbsp;<em>Dealing with Communication Channels&nbsp;</em></li>
<li>The&nbsp;<em>Producing SMS</em> recipe in&nbsp;Chapter 8,&nbsp;<em>Dealing with Communication Channels&nbsp;</em></li>
</ul>
<h2>Preparing sales information</h2>
<p>In this chapter, we are presenting a marketing campaign divided into several steps:</p>
<ol>
<li>Detect the best moment to launch the campaign</li>
<li>Generate individual codes to be sent to potential customers</li>
<li>Send the codes directly to users over their preferred channel, text message or email</li>
<li>Collect the results of the campaign</li>
<li>Generate a sales report with analysis of the results</li>
</ol>
<p>This recipe shows step 4 of the campaign.</p>
<p>After sending the information to users, we need to collect the sales log from the shops to monitor how it is going and how big the campaign's impact is.</p>
<p>The sales logs are reported as individual files from each of the associated shops, so in this recipe we'll see how to aggregate all the info into a&nbsp;spreadsheet to be able to treat the information as a whole.</p>
<h3>Getting ready</h3>
<p>For this recipe, we need to install the following modules:</p>
<pre><code class="lang-python">$ echo "openpyxl==2.5.4" &gt;&gt; requirements.txt
$ echo "parse==1.8.2" &gt;&gt; requirements.txt
$ echo "delorean==1.0.0" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>We can obtain a test structure and test logs for this recipe from GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter09/sales">https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter09/sales</a>. Please download the full&nbsp;<kbd>sales</kbd>&nbsp;directory, which contains a lot of test logs.&nbsp;To display the structure, we'll use the <kbd>tree</kbd> command (<a href="http://mama.indstate.edu/users/ice/tree/">http://mama.indstate.edu/users/ice/tree/</a>), which is installed by default in Linux and can be installed using <kbd>brew</kbd> in macOs (<a href="https://brew.sh/">https://brew.sh/</a>). You can use a graphical tool to inspect the directory as well.</p>
<p>We'll also need the <kbd>sale_log.py</kbd>&nbsp;module&nbsp;and the&nbsp;<kbd>parse_sales_log.py</kbd>&nbsp;script, available in GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/parse_sales_log.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/parse_sales_log.py</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Check the structure of the <kbd>sales</kbd> directory. Each subdirectory represents a shop that has submitted its sales logs for the period:</li>
</ol>
<pre><code class="lang-python">$ tree sales
sales
├── 345
│   └── logs.txt
├── 438
│   ├── logs_1.txt
│   ├── logs_2.txt
│   ├── logs_3.txt
│   └── logs_4.txt
└── 656
 └── logs.txt</code></pre>
<ol start="2">
<li>Check&nbsp; the log files:</li>
</ol>
<pre><code class="lang-python">$ head sales/438/logs_1.txt
[2018-08-27 21:05:55+00:00] - SALE - PRODUCT: 12346 - PRICE: $02.99 - NAME: Single item - DISCOUNT: 0%
[2018-08-27 22:05:55+00:00] - SALE - PRODUCT: 12345 - PRICE: $07.99 - NAME: Family pack - DISCOUNT: 20%
...</code></pre>
<ol start="3">
<li>Call the <kbd>parse_sales_log.py</kbd>&nbsp;script to generate the repository:</li>
</ol>
<pre><code class="lang-python">$ python parse_sales_log.py sales -o report.xlsx</code></pre>
<ol start="4">
<li>Check the generated Excel result, <kbd>report.xlsx</kbd>:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000008.png" class="lazyload" /></p>
<h3>How it works...</h3>
<p>Steps 1 and 2 show how the data is structured. Step 3 calls <kbd>parse_sales_log.py&nbsp;</kbd> to read all the log files and parse them, and then stores them in an Excel spreadsheet. The contents of the spreadsheet are displayed in step 4.</p>
<p>Let's see how&nbsp;<kbd>parse_sales_log.py</kbd> is structured:</p>
<pre><code class="lang-python"># IMPORTS
from sale_log import SaleLog

def get_logs_from_file(shop, log_filename):
    with open(log_filename) as logfile:
        logs = [SaleLog.parse(shop=shop, text_log=log)
                for log in logfile]
    return logs

def main(log_dir, output_filename):
    logs = []
    for dirpath, dirnames, filenames in os.walk(log_dir):
        for filename in filenames:
            # The shop is the last directory
            shop = os.path.basename(dirpath)
            fullpath = os.path.join(dirpath, filename)
            logs.extend(get_logs_from_file(shop, fullpath))

    # Create and save the Excel sheet
    xlsfile = openpyxl.Workbook()
    sheet = xlsfile['Sheet']
    sheet.append(SaleLog.row_header())
    for log in logs:
        sheet.append(log.row())
    xlsfile.save(output_filename)

if __name__ == '__main__':
  # PARSE COMMAND LINE ARGUMENTS AND CALL main()

</code></pre>
<p>The command line arguments are explained in Chapter 1, <em>Let Us Begin Our Automation Journey</em>. Note that the imports include <kbd>SaleLog</kbd>.</p>
<p>The main function walks through the whole directory and grabs all the files through <kbd>os.walk</kbd>. You can get more information about <kbd>os.walk</kbd> in Chapter 2, <em>Automating Tasks Made Easy</em>. Each file is then passed to <kbd>get_logs_from_file</kbd> to parse its logs and add them to the global <kbd>logs</kbd> list.</p>
<p>Note that the specific shop is stored in the last subdirectory, so it is extracted with <kbd>os.path.basename</kbd>.</p>
<p>Once the list of logs has been completed, a new Excel sheet is created using the <kbd>openpyxl</kbd> module. The <kbd>SaleLog</kbd> module has a <kbd>.row_header</kbd> method to add the first row, and then all the logs are converted to row format using <kbd>.row</kbd>. Finally, the file is saved.</p>
<p>To parse the logs, we make a module called <kbd>sale_log.py</kbd>. This abstracts parsing and dealing with a row. Most of it is straightforward and it structures each of the different parameters properly, but the parse method requires a bit of attention:</p>
<pre><code class="lang-python">    @classmethod
    def parse(cls, shop, text_log):
        '''
        Parse from a text log with the format
        ...
        to a SaleLog object
        '''
        def price(string):
            return Decimal(string)

        def isodate(string):
            return delorean.parse(string)

        FORMAT = ('[{timestamp:isodate}] - SALE - PRODUCT: {product:d} '
                  '- PRICE: ${price:price} - NAME: {name:D} '
                  '- DISCOUNT: {discount:d}%')

        formats = {'price': price, 'isodate': isodate}
        result = parse.parse(FORMAT, text_log, formats)

        return cls(timestamp=result['timestamp'],
                   product_id=result['product'],
                   price=result['price'],
                   name=result['name'],
                   discount=result['discount'],
                   shop=shop)</code></pre>
<p><kbd>sale_log.py</kbd> is a <em>classmethod</em>, meaning that it can be used by calling&nbsp;<kbd>SaleLog.parse</kbd>, and it returns a new element of the class.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Classmethods<em>&nbsp;</em>are called with a first argument that stores the class, instead of the object normally stored in <kbd>self</kbd>. The convention is to use <kbd>cls</kbd> to represent it. Calling&nbsp;<kbd>cls(...)&nbsp;</kbd>&nbsp;at the end&nbsp;is equivalent to <kbd>SaleFormat(...)</kbd>, so it calls the <kbd>__init__</kbd>&nbsp;method.</p>
</div>
</div>
<p>The method uses the <kbd>parse</kbd> module to retrieve the values from the template. Note how two elements, <kbd>timestamp</kbd> and <kbd>price</kbd>, have custom parsing. The <kbd>delorean</kbd>&nbsp;module&nbsp;helps us with parsing the date, and the price is better described as a <kbd>Decimal</kbd> to keep the proper resolution. The custom filters are applied in the <kbd>formats</kbd> argument.</p>
<h3>There's more...</h3>
<p>The <kbd>Decimal</kbd> type is described in detail in the Python documentation here:&nbsp;<a href="https://docs.python.org/3/library/decimal.html">https://docs.python.org/3/library/decimal.html</a>.</p>
<p>The full <kbd>openpyxl</kbd> can be found here:<a href="https://openpyxl.readthedocs.io/en/stable/">&nbsp;https://openpyxl.readthedocs.io/en/stable/</a>. Also, check Chapter 6,&nbsp;<em>Fun with Spreadsheets</em>, for more examples on how to use the module.</p>
<p>The full <kbd>parse</kbd> documentation can be found here:&nbsp;<a href="https://github.com/r1chardj0n3s/parse">https://github.com/r1chardj0n3s/parse</a>. Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey</em>, also describes this module in greater detail.</p>
<h3>See also</h3>
<ul>
<li>The <em>Using a third-party tool&mdash;parse</em> recipe in Chapter 1,&nbsp;<em>Let Us Begin Our Automation Journey &nbsp;</em></li>
<li>The <em>Crawling and searching directories</em> recipe&nbsp;in&nbsp;Chapter 4,&nbsp;<em>Searching and Reading Local Files</em></li>
<li>The <em>Reading text files</em> recipe&nbsp;in&nbsp;Chapter 4,&nbsp;<em>Searching and Reading Local Files</em></li>
<li>The <em>Updating an Excel spreadsheet</em> recipe&nbsp;in&nbsp;Chapter 6,&nbsp;<em>Fun with Spreadsheets</em></li>
</ul>
<h2>Generating a sales report</h2>
<p>In this chapter, we are presenting a marketing campaign divided in several steps:</p>
<ol>
<li>Detect the best moment to launch the campaign</li>
<li>Generate individual codes to be sent to potential customers</li>
<li>Send the codes directly to users over their preferred channel, text message or email</li>
<li>Collect the results of the campaign</li>
<li>Generate a sales report with analysis of the results</li>
</ol>
<p>This recipe shows step 5 of the campaign.</p>
<p>As the final step, all the information about each of the sales is aggregated and displayed in a sales report.</p>
<p>In this recipe, we'll see how to leverage reading from spreadsheets, creating PDFs, and producing graphs to generate a comprehensive report automatically in order to analyze the performance of our campaign.</p>
<h3>Getting Ready</h3>
<p>In this recipe, we'll require the following modules in our virtual environment:</p>
<pre><code class="lang-python">$ echo "openpyxl==2.5.4" &gt;&gt; requirements.txt
$ echo "fpdf==1.7.2" &gt;&gt; requirements.txt
$ echo "delorean==1.0.0" &gt;&gt; requirements.txt
$ echo "PyPDF2==1.26.0" &gt;&gt; requirements.txt
$ echo "matplotlib==2.2.2" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>We'll need the <kbd>sale_log.py</kbd>&nbsp;module&nbsp;available in GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/sale_log.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/sale_log.py</a>.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The input spreadsheet is generated in&nbsp;the previous recipe, preparing sales information. Check there for more information.</p>
</div>
</div>
<p>You can download the script to generate the input spreadsheet,&nbsp;<kbd>parse_sales_log.py</kbd>, from GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/parse_sales_log.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/parse_sales_log.py</a>.</p>
<p>Download the raw log files from GitHub at <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter09/sales">https://github.com/PacktPublishing/Python-Automation-Cookbook/tree/master/Chapter09/sales</a>. Please download the full&nbsp;<kbd>sales</kbd>&nbsp;directory.</p>
<p>Download the <kbd>generate_sales_report.py</kbd>&nbsp;script&nbsp;from GitHub at&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/generate_sales_report.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter09/generate_sales_report.py</a>.</p>
<h3>How to do it...</h3>
<ol>
<li>Check the input file and the use of&nbsp;<kbd>generate_sales_report.py</kbd>:</li>
</ol>
<pre><code class="lang-python">$ ls report.xlsx
report.xlsx
$ python generate_sales_report.py --help
usage: generate_sales_report.py [-h] input_file output_file

positional arguments:
  input_file
  output_file

optional arguments:
  -h, --help show this help message and exit</code></pre>
<ol start="2">
<li>Call the <kbd>generate_sales_report.py</kbd>&nbsp;script with the input file and an output file:</li>
</ol>
<pre><code class="lang-python">$ python generate_sales_report.py report.xlsx output.pdf</code></pre>
<ol start="3">
<li>Check the&nbsp;<kbd>output.pdf</kbd>&nbsp;output file. It will contain three pages, the first a brief summary and the second and third graphs with the sales by day and by shop:</li>
</ol>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000005.png" class="lazyload" /></p>
<p>The second page shows a graph of sales by day:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000000.png" class="lazyload" /></p>
<p>The third page divides the sales by shop:</p>
<p class="f-center"><img data-src="https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-automation-cookbook/images/000036.png" class="lazyload" /></p>
<h3>How it works</h3>
<p>Step 1 shows how to use the script and step 2 calls it on the input file. Let's take a look at the basic structure of the&nbsp;<kbd>generate_sales_report.py</kbd> script:</p>
<pre><code class="lang-python"># IMPORTS
def generate_summary(logs):

def aggregate_by_day(logs):
def aggregate_by_shop(logs):

def graph(...):

def create_summary_brief(...):


def main(input_file, output_file):
  # open and read input file
  # Generate each of the pages calling the other calls
  # Group all the pdfs into a single file
  # Write the resulting PDF

if __name__ == '__main__':
  # Compile the input and output files from the command line
  # call main</code></pre>
<p>There are two key elements&mdash;the aggregation of the logs in different ways (by shop and by day) and the generation of a summary in each case. The summary is generated with&nbsp;<kbd>generate_summary</kbd>, which, from a list of logs, generates a dictionary with its aggregated information. The aggregation of the logs is done in different styles in the <kbd>aggregate_by</kbd> functions.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p><kbd>generate_summary</kbd>&nbsp;produces a dictionary with the aggregated information, including start and end time, total income of all logs, total units, average discount, and a breakdown of the same data by product.</p>
</div>
</div>
<p>The script is better understood by starting at the end. The main functions join all the different operations. Read each of the logs and transform them into native&nbsp;<kbd>SaleLog</kbd> objects.</p>
<p>Then, it generates each of the pages into an intermediate PDF file:</p>
<ul>
<li>A brief, generated by&nbsp;<kbd>create_summary_brief</kbd> over a general summary of all the data.</li>
<li>The logs are <kbd>aggregate_by_day</kbd>. A summary is created and a graph is produced.</li>
<li>The logs are <kbd>aggregate_by_shop</kbd>. A summary is created and a graph is produced.&nbsp;</li>
</ul>
<p>All the intermediate PDF pages are joined, using&nbsp;<kbd>PyPDF2</kbd>, into a single file. Finally, the intermediate pages are deleted.</p>
<p>Both <kbd>aggregate_by_day</kbd> and <kbd>aggregate_by_shop</kbd> return a list with a summary of each of the elements. In <kbd>aggregate_by_day</kbd>, we detect when a&nbsp;day ends by using <kbd>.end_of_day</kbd> to differentiate one day from another.</p>
<p>The <kbd>graph</kbd> function does the following:</p>
<ol>
<li>Prepares all the data that is going to be displayed. That includes the number of units per tag (day or shop), and the total income per tag.</li>
<li>Creates a top graph with the total income, split by product into stacked bars. To be able to do this, at the same time the total income is calculated, the baseline (the position where the next stack is located) is calculated.</li>
<li>It divides the bottom part of the graph into as many graphs as there are products, and displays the number of units sold on each one, per tag (day or shop).</li>
</ol>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>For a better display, the graph is defined to be the size of an A4 sheet. It also allows us, using&nbsp;<kbd>skip_labels</kbd>, to print one of each <em>X</em> label on the second graph on the <em>X</em> axis to avoid overlapping. This is useful when displaying the days, and it's set to show only one label per week.</p>
</div>
</div>
<p>The resulting graph is saved to a file.</p>
<p><kbd>create_summary_brief</kbd> uses the&nbsp;<kbd>fpdf</kbd> module to save a text PDF page with the total summary information.&nbsp;</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The template and information in <kbd>create_summary_brief</kbd> has been left deliberately simple to avoid complicating this recipe, but it can be complicated with better descriptive text and formatting. Refer to Chapter 5,&nbsp;<em>Generating&nbsp;Fantastic Reports</em>, for more details on how to use <kbd>fpdf</kbd><em>.</em></p>
</div>
</div>
<p>As shown before, the <kbd>main</kbd> function groups all the PDF pages and joins them into a single document, removing the intermediate pages later.</p>
<h3>There's more...</h3>
<p>The reports included in this recipe could be expanded. For example, the average discount could be calculated in each of the pages and displayed as a line:</p>
<pre><code class="lang-python"># Generate a data series with the average discount
discount = [summary['average_discount'] for _, summary in full_summary]
....
# Print the legend
# Plot the discount in a second axis
plt.twinx()
plt.plot(pos, discount,'o-', color='green')
plt.ylabel('Average Discount')</code></pre>
<p>Be careful not to put too much information in a single graph, though. It may reduce the readability. In this case, another graph is&nbsp;probably&nbsp;a better way of displaying it.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Be careful to print the legend before creating the second axis, or it will display only the information on the second axis.</p>
</div>
</div>
<p>The size and orientation of the graphs can determine whether to use more labels or fewer, so they are clear and readable. This is demonstrated in the use of <kbd>skip_labels</kbd> to avoid clutter. Keep an eye on the resulting graphics and try to adapt to possible problems in that area by changing sizes or limiting labels in some cases.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>For example, a possible limit is to have no more than three products, as printing four graphs in the second row in our graphs will probably&nbsp;make the text illegible. Feel free to experiment and check the limits of the code.</p>
</div>
</div>
<p>The complete&nbsp;<kbd>matplotlib</kbd> documentation can be found at&nbsp;<a href="https://matplotlib.org/">https://matplotlib.org/</a>.<br />The <kbd>delorean</kbd> documentation can be found here:&nbsp;<a href="https://delorean.readthedocs.io/en/latest/">https://delorean.readthedocs.io/en/latest/</a>.<br />All the documentation for&nbsp;<kbd>openpyxl</kbd> is available at&nbsp;<a href="https://openpyxl.readthedocs.io/en/stable/">https://openpyxl.readthedocs.io/en/stable/</a>.<br />The full documentation for the PDF manipulation modules can be found for PyPDF2 at&nbsp;<a href="https://pythonhosted.org/PyPDF2/">https://pythonhosted.org/PyPDF2/</a> and&nbsp; for <kbd>pyfdf</kbd> at&nbsp;<a href="https://pyfpdf.readthedocs.io/en/latest/">https://pyfpdf.readthedocs.io/en/latest/</a>.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>This recipe makes use of different concepts and techniques that are available in Chapter 5,&nbsp;<em>Generating Fantastic Reports</em>, for PDF creation and manipulation, Chapter 6, <em>Fun with Spreadsheets</em>, for spreadsheet reading, and Chapter 7, <em>Developing Stunning Graphs</em>, for graph creation. Check them out to know more.</p>
</div>
</div>
<h3>See also</h3>
<ul>
<li>The <em>Aggregating PDF</em> reports recipe in Chapter 5,&nbsp;<em>Generating Fantastic Reports</em></li>
<li>The <em>Reading an Excel</em> spreadsheet recipe in Chapter 6,&nbsp;<em>Fun with Spreadsheets</em></li>
<li>The <em>Drawing stacked bars</em> recipe in Chapter 7, <em>Developing Stunning Graphs</em>&nbsp;</li>
<li>The&nbsp;<em>Displaying multiple lines</em> recipe in&nbsp;Chapter 7,&nbsp;<em>Developing Stunning Graphs</em>&nbsp;</li>
<li>The&nbsp;<em>Adding legends and annotations</em> recipe&nbsp;in&nbsp;Chapter 7,&nbsp;<em>Developing Stunning Graphs</em>&nbsp;</li>
<li>The&nbsp;<em>Combining graphs</em> recipe&nbsp;in&nbsp;Chapter 7,&nbsp;<em>Developing Stunning Graphs</em>&nbsp;</li>
<li>The&nbsp;<em>Saving charts</em> recipe&nbsp;in&nbsp;Chapter 7,&nbsp;<em>Developing Stunning Graphs</em>&nbsp;</li>
</ul>
</div>

<!--Chapter 10-->
<div class="chapter" data-chapter-number="10">
<div class="chapter-start">
<div class="ch-head">Chapter <span class="chapter-number"> 10 </span></div>
<h1 class="chaptertitle">Debugging Techniques</h1>
<h3 class="author">Jaime Buelta</h3>
</div>


<p>In this chapter, we will cover the following recipes:</p>
<ul>
<li>Learning Python interpreter basics</li>
<li>Debugging through logging</li>
<li>Debugging with breakpoints</li>
<li>Improving your debugging skills</li>
</ul>
<h2>Introduction</h2>
<p>Writing code is not easy. Actually, it is very hard. Even the best programmer in the world can't foresee any possible alternative and flow of the code.&nbsp;</p>
<p>This means that executing our code will always produce surprises and unexpected behavior. Some will be very evident and others will be very subtle, but the ability to identify and remove these defects in the code is critical to building solid software.</p>
<p>These defects in software are known as <strong>bugs</strong>, and therefore removing them is called <strong>debugging</strong>.</p>
<p>Inspecting the code just by reading it is not great. There are always surprises, and complex code is difficult to follow. That's why the ability to debug by stopping execution and taking a look at the current state of things is important.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Everyone, EVERYONE introduces bugs in the code, normally to be surprised by them later. Some people have described debugging as&nbsp;<em>being the detective in a crime movie where you are also the murderer</em>.</p>
</div>
</div>
<p>Any debugging process roughly follows this path:</p>
<ol>
<li>You realize there's a problem</li>
<li>You understand what the correct behavior&nbsp;should&nbsp;be</li>
<li>You discover why the current code produces the bug</li>
<li>You change the code to produce the proper result</li>
</ol>
<p>95% of the time, everything but step 3 is trivial, which is the bulk of the debugging process.&nbsp;</p>
<p>Realizing the why of a bug, at its core, uses the scientific method:</p>
<ol>
<li>Measure and observe what the code is doing</li>
<li>Produce a hypothesis on why that is</li>
<li>Validate or disprove that's correct, maybe through an experiment</li>
<li>Use the resulting information to iterate the process</li>
</ol>
<p>Debugging is an ability, and as such, it will improve over time. Practice plays an important role in developing intuition on what paths look promising to identify an error, but there are some general ideas that may help you:</p>
<ul>
<li><strong>Divide and conquer:&nbsp;</strong>Isolate small parts of the code, so that it is possible to understand the code. Simplify the problem as much as possible.</li>
</ul>
<p>There's a format of this called the <strong>Wolf fence algorithm</strong>, described by Eduard Gauss:</p>
<blockquote>
<p>"There's one wolf in Alaska; how do you find it? First build a fence down the middle of the state, wait for the wolf to howl, determine which side of the fence it is on. Repeat process on that side only, until you get to the point where you can see the wolf."</p>
</blockquote>
<ul>
<li><strong>Move backwards from the error:&nbsp;</strong>If there's a clear error at a specific point, the bug is likely located in the surroundings.&nbsp;Move progressively backwards from the error, following the track until the source of the error is found.</li>
</ul>
<ul>
<li><strong>You can assume anything you want, as long as you prove your assumption:</strong>&nbsp;Code is very complex to keep in your head all at once. You need to validate small assumptions that, when combined, will provide solid ground to move forward with detecting and fixing the problem. Make small experiments, which will allow you to remove from your mind parts of the code that actually work and focus on untested ones.</li>
</ul>
<p>Or in the words of Sherlock Holmes:</p>
<p>"<em>Once you eliminate the impossible, whatever remains, no matter how improbable, must be the truth."</em></p>
<p>But remember to prove it. Avoid untested assumptions.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>All of this sounds a bit scary, but actually most of the bugs are pretty evident. Maybe a typo, or a piece of code not ready for a particular value. Try to keep things simple.&nbsp;Simple code is easier to analyze and debug.</p>
</div>
</div>
<p>In this chapter, we will see some of the tools and techniques for debugging, and apply them specifically to Python scripts. The scripts will have some bugs that we will fix as part of the recipe.</p>
<h2>Learning Python interpreter basics</h2>
<p>In this recipe, we'll cover some of Python's built-in capabilities to examine code, to investigate what's going on, and to detect when things are not behaving properly.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>We can also verify when things are working as expected. Remember that being able to discard part of the code as the source of a bug is incredibly important.</p>
</div>
</div>
<p>While debugging, we typically need to analyze unknown elements and objects that come from an external module or service. Given the dynamic nature of Python, the code is highly discoverable at any point in the execution.</p>
<p>Everything&nbsp;in this recipe is&nbsp;included by default in Python's interpreter.</p>
<h3>How to do it...</h3>
<ol>
<li>Import <kbd>pprint</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; from pprint import pprint</code></pre>
<ol start="2">
<li>Create a new dictionary called <kbd>dictionary</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; dictionary = {'example': 1}</code></pre>
<ol start="3">
<li>Display&nbsp;<kbd>globals</kbd> into this environment:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; globals()
{...'pprint': &lt;function pprint at 0x100995048&gt;, 
...'dictionary': {'example': 1}}</code></pre>
<ol start="4">
<li>Print the <kbd>globals</kbd> dictionary in a readable format with <kbd>pprint</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; pprint(globals())
{'__annotations__': {},
 ...
 'dictionary': {'example': 1},
 'pprint': &lt;function pprint at 0x100995048&gt;}</code></pre>
<ol start="5">
<li>&nbsp;Display all of the attributes of the <kbd>dictionary</kbd>:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; dir(dictionary)
['__class__', '__contains__', '__delattr__', '__delitem__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__getitem__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__iter__', '__le__', '__len__', '__lt__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__setitem__', '__sizeof__', '__str__', '__subclasshook__', 'clear', 'copy', 'fromkeys', 'get', 'items', 'keys', 'pop', 'popitem', 'setdefault', 'update', 'values']</code></pre>
<ol start="6">
<li>Show the help for the <kbd>dictionary</kbd> object:</li>
</ol>
<pre><code class="lang-python">&gt;&gt;&gt; help(dictionary)

Help on dict object:

class dict(object)
 | dict() -&gt; new empty dictionary
 | dict(mapping) -&gt; new dictionary initialized from a mapping object's
 | (key, value) pairs
...</code></pre>
<h3>How it works...</h3>
<p>After the import of <kbd>pprint</kbd> (pretty print) in step 1, we create a new dictionary to work as the example in step 2.</p>
<p>Step 3 shows how the global namespace contains, among other things, the defined dictionary and the module. <kbd>globals()</kbd>&nbsp;displays all imported modules an other global variables.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>There's an equivalent <kbd>locals()</kbd> for local namespaces.</p>
</div>
</div>
<p><kbd>pprint</kbd> helps to display the <kbd>globals</kbd> in a more readable format in step 4, adding more space and separating the elements by line.</p>
<p>Step 5 shows how to use <kbd>dir()</kbd> to obtain all the attributes of a Python object. Note this includes all the double underscore values, such as&nbsp;<kbd>__len__</kbd>.</p>
<p>The use of the&nbsp;built-in <kbd>help()</kbd>&nbsp;function will display relevant information for objects.</p>
<h3>There's more...</h3>
<p><kbd>dir()</kbd> in particular is extremely useful for inspecting unknown objects, modules, or classes. If you need to filter out the default attributes, and clarify the output, you can filter the output this way:</p>
<pre><code class="lang-python">&gt;&gt;&gt; [att for att in dir(dictionary) if not att.startswith('__')]
['clear', 'copy', 'fromkeys', 'get', 'items', 'keys', 'pop', 'popitem', 'setdefault', 'update', 'values']</code></pre>
<p>In the same way, if you're searching for a particular method (such as something that starts with <kbd>set</kbd>), you can filter in the same way.</p>
<p><kbd>help()</kbd> will display the <kbd>docstring</kbd> of a function or class.&nbsp;<kbd>docstring</kbd> is the string defined just after the definition to document the function or class:</p>
<pre><code class="lang-python">&gt;&gt;&gt; def something():
...     '''
...     This is help for something
...     '''
...     pass
...
&gt;&gt;&gt; help(something)
Help on function something in module __main__:

something()
    This is help for something</code></pre>
<p>Notice how in the next example, the &nbsp;<em>This is help for something</em>&nbsp;string is defined just after the definition of the function.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p><kbd>docstring</kbd> is normally enclosed in triple quotes to allow writing string with multiple lines. Python will treat everything inside triple-quotes as a big string, even if there are newlines. You can use either&nbsp;<kbd>'</kbd> or <kbd>"</kbd>&nbsp;characters,&nbsp; as long as you use three of them. You can find more information about <kbd>docstrings</kbd> at&nbsp;<a href="https://www.python.org/dev/peps/pep-0257/">https://www.python.org/dev/peps/pep-0257/</a>.</p>
</div>
</div>
<p>The documentation for the built-in functions can be found at&nbsp;<a href="https://docs.python.org/3/library/functions.html#built-in-functions">https://docs.python.org/3/library/functions.html#built-in-functions</a>, and the full documentation for <kbd>pprint</kbd> can be found at&nbsp;<a href="https://docs.python.org/3/library/pprint.html">https://docs.python.org/3/library/pprint.html#</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Improving your debugging skills</em> recipe</li>
<li>The <em>Debugging through logging</em> recipe</li>
</ul>
<h2>Debugging through logging</h2>
<p>Debugging is, after all, detecting what's going on inside our program and what unexpected or incorrect effects may be happening. A simple, yet very effective, approach is to output variables and other information at strategic parts of your code to follow the flow of the program.</p>
<p>The simplest form of this approach is called <strong>print debugging</strong>, or inserting print statements at certain points to print the value of variables or points while debugging.</p>
<p>But taking this technique a little bit further and combining it with the logging techniques presented in Chapter 2,&nbsp;<em>Automating Tasks Made Easy</em> allows us to create a semi-permanent trace of the execution of the program, which can be really useful when detecting issues in a running program.</p>
<h3>Getting ready</h3>
<p>Download the&nbsp;<kbd>debug_logging.py</kbd>&nbsp;file from GitHub:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter10/debug_logging.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter10/debug_logging.py</a>.</p>
<p>It contains an implementation of the bubble sort algorithm (<a href="https://www.studytonight.com/data-structures/bubble-sort">https://www.studytonight.com/data-structures/bubble-sort</a>), which is the simplest way to sort a list of elements. It iterates several times over the list, and on each iteration, two adjacent values are checked and interchanged, so the bigger one is after the smaller. This makes&nbsp;the bigger values ascend like bubbles in the list.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Bubble sort is a simple but naive way of implementing a sort, and there are better alternatives. Unless you have an extremely good reason not to, rely on the standard&nbsp;<kbd>.sort</kbd> method in lists.</p>
</div>
</div>
<p>When run, it checks the following list to verify that it is correct:</p>
<pre><code class="lang-python">assert [1, 2, 3, 4, 7, 10] == bubble_sort([3, 7, 10, 2, 4, 1])</code></pre>
<p>We have a bug in this implementation, so we can fix it as part of the recipe!</p>
<h3>How to do it...</h3>
<ol>
<li>Run the <kbd>debug_logging.py</kbd> script and check whether it fails:</li>
</ol>
<pre><code class="lang-python">$ python debug_logging.py
INFO:Sorting the list: [3, 7, 10, 2, 4, 1]
INFO:Sorted list:      [2, 3, 4, 7, 10, 1]
Traceback (most recent call last):
  File "debug_logging.py", line 17, in &lt;module&gt;
    assert [1, 2, 3, 4, 7, 10] == bubble_sort([3, 7, 10, 2, 4, 1])
AssertionError</code></pre>
<ol start="2">
<li>Enable the dubug logging, changing the second line of the <kbd>debug_logging.py</kbd> script:&nbsp;</li>
</ol>
<pre><code class="lang-python">logging.basicConfig(format='%(levelname)s:%(message)s', level=logging.INFO)</code></pre>
<p>Change the preceding line to the following one:</p>
<pre><code class="lang-python">logging.basicConfig(format='%(levelname)s:%(message)s', level=logging.DEBUG)</code></pre>
<p>Note the different <kbd>level</kbd>.</p>
<ol start="3">
<li>Run the script again, with more information inside:</li>
</ol>
<pre><code class="lang-python">$ python debug_logging.py
INFO:Sorting the list: [3, 7, 10, 2, 4, 1]
DEBUG:alist: [3, 7, 10, 2, 4, 1]
DEBUG:alist: [3, 7, 10, 2, 4, 1]
DEBUG:alist: [3, 7, 2, 10, 4, 1]
DEBUG:alist: [3, 7, 2, 4, 10, 1]
DEBUG:alist: [3, 7, 2, 4, 10, 1]
DEBUG:alist: [3, 2, 7, 4, 10, 1]
DEBUG:alist: [3, 2, 4, 7, 10, 1]
DEBUG:alist: [2, 3, 4, 7, 10, 1]
DEBUG:alist: [2, 3, 4, 7, 10, 1]
DEBUG:alist: [2, 3, 4, 7, 10, 1]
INFO:Sorted list : [2, 3, 4, 7, 10, 1]
Traceback (most recent call last):
  File "debug_logging.py", line 17, in &lt;module&gt;
    assert [1, 2, 3, 4, 7, 10] == bubble_sort([3, 7, 10, 2, 4, 1])
AssertionError</code></pre>
<ol start="4">
<li>After analyzing the output, we realize that the last element of the list is not sorted. We analyze the code and discover an off-by-one error in line 7. Do you see it? Let's fix it by changing the following line:</li>
</ol>
<pre><code class="lang-python">for passnum in reversed(range(len(alist) - 1)):</code></pre>
<p>Change the preceding line to the following one:</p>
<pre><code class="lang-python">for passnum in reversed(range(len(alist))):</code></pre>
<p>(Notice the removal of the <kbd>-1</kbd> operation.)</p>
<ol start="5">
<li>&nbsp;Run it again and&nbsp;you will see that it works as expected. The debug logs are not displayed here:&nbsp;</li>
</ol>
<pre><code class="lang-python">$ python debug_logging.py
INFO:Sorting the list: [3, 7, 10, 2, 4, 1]
...
INFO:Sorted list     : [1, 2, 3, 4, 7, 10]</code></pre>
<h3>How it works...</h3>
<p>Step 1 presents the script and shows that the code is faulty, as it's not properly sorting the list.</p>
<p>The script already has some logs to show the start and end result, as well as some debug logs that show each intermediate step. In step 2, we activate the display of the&nbsp;<kbd>DEBUG</kbd> logs, as in step 1 only the&nbsp;<kbd>INFO</kbd> ones were shown.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Note that the logs are displayed by default in the standard error output. This is displayed by default in the Terminal. If you need to direct the logs somewhere else, such as a file, see how to configure a different handler. See the logging configuration in Python for more details:&nbsp;<a href="https://docs.python.org/3/howto/logging.html">https://docs.python.org/3/howto/logging.html</a>.</p>
</div>
</div>
<p>Step 3 runs the script again, this time displaying extra information, showing that the last element in the list is not sorted.</p>
<p>The bug is an off-by-one error, a very common kind of error, as it should iterate to the whole size of the list. This is fixed in step 4.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Check the code to understand why there's an error. The whole list should be compared, but we made the mistake of reducing the size by one.</p>
</div>
</div>
<p>Step 5 shows that the fixed script runs correctly.</p>
<h3>There's more...</h3>
<p>In this recipe, we have strategically located the debug logs beforehand, but that may not be the case in a real-life debugging exercise. You may need to add more or change the location as part of the bug investigation.</p>
<p>The biggest advantage of this technique is that we're able to see the flow of the program, being able to inspect one moment of the code execution to another, and make sense of the flow. But the disadvantage is that we can end with a wall of text that doesn't provide specific information about our problem. You need to find a balance between too much and too little information.</p>
<p>For the same reason, try to limit very long variables unless they're necessary.</p>
<p>Remember to turn down the logging level after fixing the bug. It is likely that some logs that you discover to be irrelevant may need to be deleted.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>The quick and dirty version of this technique is to add print statements instead of debug logs. While some people are resistant to this, it is actually a valuable technique to use for debug purposes. But remember to clean them up when you're done.</p>
</div>
</div>
<p>All the introspection elements are available, so you can create logs that display, for example, all the attributes of a&nbsp;<kbd>dir(object)</kbd> object:</p>
<pre><code class="lang-python">logging.debug(f'object {dir(object)}')</code></pre>
<p>Anything that can be displayed as a string is able to be presented in a log, including any text manipulation.</p>
<h3>See also</h3>
<ul>
<li>The <em>Learning Python interpreter basics</em> recipe</li>
<li>The <em>Improving your debugging skills</em> recipe</li>
</ul>
<h2>Debugging with breakpoints</h2>
<p>Python has a ready-to-go debugger called <kbd>pdb</kbd>. Given that Python code is interpreted, this means that stopping the execution of the code at any point is possible by setting a breakpoint, which will jump into a command line where any code can be used to analyze the situation and execute any number of instructions.</p>
<p>Let's see how to do it.</p>
<h3>Getting ready</h3>
<p>Download the&nbsp;<kbd>debug_algorithm.py</kbd>&nbsp;script, available from GitHub:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter10/debug_algorithm.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter10/debug_algorithm.py</a>.</p>
<p>In the next section, we will analyze the execution of the code in detail. The&nbsp;code&nbsp;checks whether numbers follow certain properties:</p>
<pre><code class="lang-python">def valid(candidate):
    if candidate &lt;= 1:
        return False

    lower = candidate - 1
    while lower &gt; 1:
        if candidate / lower == candidate // lower:
            return False
        lower -= 1

    return True


assert not valid(1)
assert valid(3)
assert not valid(15)
assert not valid(18)
assert not valid(50)
assert valid(53)</code></pre>
<p>It is possible that you recognize what the code is doing, but bear with me so that we can analyze it interactively.</p>
<h3>How to do it...</h3>
<ol>
<li>Run the code to see all the assertions are valid:</li>
</ol>
<pre><code class="lang-python">$ python debug_algorithm.py</code></pre>
<ol start="2">
<li>Add&nbsp;&nbsp;<kbd>breakpoint()</kbd>, after the <kbd>while</kbd> loop, just before line 7, resulting in&nbsp;the following:</li>
</ol>
<pre><code class="lang-python">    while lower &gt; 1:
        breakpoint()
        if candidate / lower == candidate // lower:</code></pre>
<ol start="3">
<li>&nbsp;Execute the code again, and see that it stops at the breakpoint, entering into the interactive <kbd>Pdb</kbd> mode:</li>
</ol>
<pre><code class="lang-python">$ python debug_algorithm.py
&gt; .../debug_algorithm.py(8)valid()
-&gt; if candidate / lower == candidate // lower:
(Pdb)</code></pre>
<ol start="4">
<li>Check the value of the candidate and the two operations. This line is checking whether the dividing of <kbd>candidate</kbd> by <kbd>lower</kbd> is an integer (the float and integer division is the same):</li>
</ol>
<pre><code class="lang-python">(Pdb) candidate
3
(Pdb) candidate / lower
1.5
(Pdb) candidate // lower
1</code></pre>
<ol start="5">
<li>Continue to the next instruction with <kbd>n</kbd>. See that it ends the while loop and returns <kbd>True</kbd>:</li>
</ol>
<pre><code class="lang-python">(Pdb) n
&gt; ...debug_algorithm.py(10)valid()
-&gt; lower -= 1
(Pdb) n
&gt; ...debug_algorithm.py(6)valid()
-&gt; while lower &gt; 1:
(Pdb) n
&gt; ...debug_algorithm.py(12)valid()
-&gt; return True
(Pdb) n
--Return--
&gt; ...debug_algorithm.py(12)valid()-&gt;True
-&gt; return True</code></pre>
<ol start="6">
<li>Continue the execution until another breakpoint is found with <kbd>c</kbd>. Note that this is the next call to <kbd>valid()</kbd>, which has 15 as an input:</li>
</ol>
<pre><code class="lang-python">(Pdb) c
&gt; ...debug_algorithm.py(8)valid()
-&gt; if candidate / lower == candidate // lower:
(Pdb) candidate
15
(Pdb) lower
14</code></pre>
<ol start="7">
<li>Continue running and inspecting the numbers until what the <kbd>valid</kbd> function is doing makes sense. Are you able to find out what the code does?&nbsp;(If you can't, don't worry and check the next section.) When you're done, exit with <kbd>q</kbd>. This stops the execution:</li>
</ol>
<pre><code class="lang-python">(Pdb) q
...
bdb.BdbQuit</code></pre>
<h3>How it works...</h3>
<p>The code is, as you probably know already, checking whether a number is a prime number. It tries to divide the number by all integers lower than it. If at any point is divisible,&nbsp;it returns a <kbd>False</kbd> result, because it's not a prime.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>This is actually a very inefficient way of checking for a prime number, as it will take a very long time to deal with big numbers. It is fast enough for our teaching purposes, though. If you're interested in finding primes, you can take a look at math packages such as SymPy (<a href="https://docs.sympy.org/latest/modules/ntheory.html?highlight=prime#sympy.ntheory.primetest.isprime">https://docs.sympy.org/latest/modules/ntheory.html?highlight=prime#sympy.ntheory.primetest.isprime</a>).</p>
</div>
</div>
<p>After checking the general execution in step 1, in step 2, we introduced a <kbd>breakpoint</kbd> in the code.</p>
<p>When the code is executed in step 3, it stops at the <kbd>breakpoint</kbd> position, entering into an interactive mode.</p>
<p>In the interactive mode, we can inspect the values of any variable as well as perform any kind of operation. As demonstrated in step 4, sometimes, a line of code can be better analyzed by reproducing its parts.</p>
<p>The code can be inspected&nbsp;and regular operations can be executed in the command line. The next line of code can be executed by calling <kbd>n(ext)</kbd>, as done in step 5 several times, to see the flow of the code.</p>
<p>Step 6 shows how to resume the execution with the&nbsp;<kbd>c(ontinue)</kbd>&nbsp;command in order, to stop in the next breakpoint. All these operations can be iterated to see the flow and values, and to understand what the code is doing at any point.</p>
<p>The execution can be stopped with <kbd>q(uit)</kbd>, as demonstrated in step 7.</p>
<h3>There's more...</h3>
<p>To see all the available operations, you can call&nbsp;<kbd>h(elp)</kbd>&nbsp;at any point.</p>
<p>You can check&nbsp;the surrounding code at any point using the <kbd>l(ist)</kbd> command. For example, in step 4:</p>
<pre><code class="lang-python">(Pdb) l
  3   return False
  4
  5   lower = candidate - 1
  6   while lower &gt; 1:
  7     breakpoint()
  8 -&gt;  if candidate / lower == candidate // lower:
  9       return False
 10     lower -= 1
 11
 12   return True</code></pre>
<p>The other two main debugger commands are <kbd>s(tep)</kbd>, which will execute the next step, including entering a new call, and <kbd>r(eturn)</kbd>, which will return from the current function.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>You can set up (and disable) more breakpoints using the <kbd>pdb</kbd> command <kbd>b(reak)</kbd>. You need to specify the file and line for the breakpoint, but it's actually more straightforward and less error-prone to just change the code and run it again.</p>
</div>
</div>
<p>You can overwrite variables as well as read them. Or create new variables. Or make extra calls. Or anything else you can imagine. The full power of the Python interpreter is at your service! Use it to check how something works or verify&nbsp;whether something is happening.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Avoid creating variables with names that are reserved for the debugger, such as calling a list <kbd>l</kbd>. It will make things confusing and interfere when trying to debug, sometimes in non-obvious ways.</p>
</div>
</div>
<p>The&nbsp;<kbd>breakpoint()</kbd> function is new in Python 3.7, but it's highly recommended if you're using that version. In previous versions, you need to replace it with&nbsp;the following:</p>
<pre><code class="lang-python">import pdb; pdb.set_trace()</code></pre>
<p>They work in exactly the same way. Note the two statements in the same line, which is not recommended in Python in general, but it's a great way of keeping the breakpoint in a single line.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>Remember to remove any <kbd>breakpoints</kbd> once&nbsp;<kbd>debugging</kbd> is done! Especially when committing to a version-control system such as Git.</p>
</div>
</div>
<p>You can read more about the new <kbd>breakpoint</kbd> call in the official PEP describing its usage at:&nbsp;<a href="https://www.python.org/dev/peps/pep-0553/">https://www.python.org/dev/peps/pep-0553/</a>.</p>
<p>The full <kbd>pdb</kbd> documentation can be found here:&nbsp;<a href="https://docs.python.org/3.7/library/pdb.html#module-pdb">https://docs.python.org/3.7/library/pdb.html#module-pdb</a>. It includes all the debug commands.</p>
<h3>See also</h3>
<ul>
<li>The <em>Learning Python interpreter basics</em> recipe</li>
<li>The <em>Improving your debugging skills</em> recipe</li>
</ul>
<h2>Improving your debugging skills</h2>
<p>In this recipe, we will analyze a small script that replicates a call to an&nbsp;external service, analyzing it and fixing some bugs. We will show different techniques to improve the debugging.</p>
<p>The script will ping some personal names to an internet server (<kbd>httpbin.org</kbd>, a test site) to get them back, simulating its retrieval from an external server. It will then split them into first and last name and prepare them to be sorted by surname. Finally, it will sort them.</p>
<p>The script contains several bugs that we will detect and fix.</p>
<h3>Getting ready</h3>
<p>For this recipe, we will use the&nbsp;<kbd>requests</kbd> and <kbd>parse</kbd>&nbsp;modules and include them in our virtual environment:</p>
<pre><code class="lang-python">$ echo "requests==2.18.3" &gt;&gt; requirements.txt
$ echo "parse==1.8.2" &gt;&gt; requirements.txt
$ pip install -r requirements.txt</code></pre>
<p>The&nbsp;<kbd>debug_skills.py</kbd>&nbsp;script is available from GitHub: <a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter10/debug_skills.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter10/debug_skills.py</a>. Note that it contains bugs that we will fix as part of this recipe.</p>
<h3>How to do it...</h3>
<ol>
<li>Run the script, which will generate an error:</li>
</ol>
<pre><code class="lang-python">$ python debug_skills.py
Traceback (most recent call last):
 File "debug_skills.py", line 26, in &lt;module&gt;
 raise Exception(f'Error accessing server: {result}')
Exception: Error accessing server: &lt;Response [405]&gt;</code></pre>
<ol start="2">
<li>Analyze the status code. We get 405, which means that the method we sent is not allowed. We inspect the code and realize that for the call in line 24, we used <kbd>GET</kbd>, when the proper one is <kbd>POST</kbd> (as described in the URL). Replace the code&nbsp;with the following:</li>
</ol>
<pre><code class="lang-python"># ERROR Step 2. Using .get when it should be .post
# (old) result = requests.get('http://httpbin.org/post', json=data)
result = requests.post('http://httpbin.org/post', json=data)</code></pre>
<p>We keep the old buggy code commented with&nbsp;<kbd>(old)</kbd> for clarity of changes.</p>
<ol start="3">
<li>Run the code again, which will produce a different error:</li>
</ol>
<pre><code class="lang-python">$ python debug_skills.py
Traceback (most recent call last):
  File "debug_skills_solved.py", line 34, in &lt;module&gt;
    first_name, last_name = full_name.split()
ValueError: too many values to unpack (expected 2)</code></pre>
<ol start="4">
<li>Insert a breakpoint in line 33, one preceding the error. Run it again and enter into debugging mode:</li>
</ol>
<pre><code class="lang-python">$ python debug_skills_solved.py
..debug_skills.py(35)&lt;module&gt;()
-&gt; first_name, last_name = full_name.split()
(Pdb) n
&gt; ...debug_skills.py(36)&lt;module&gt;()
-&gt; ready_name = f'{last_name}, {first_name}'
(Pdb) c
&gt; ...debug_skills.py(34)&lt;module&gt;()
-&gt; breakpoint()</code></pre>
<p>Running&nbsp;<kbd>n</kbd>&nbsp;does not produce an error, meaning that it's not the first value. After a few runs on <kbd>&nbsp;c</kbd>, we realize that this is not the correct approach, as we don't know what input is the one generating the error.</p>
<ol start="5">
<li>Instead, we wrap the line with a <kbd>try...except</kbd> block and produce a breakpoint at that point:</li>
</ol>
<pre><code class="lang-python">    try:
        first_name, last_name = full_name.split()
    except:
        breakpoint()</code></pre>
<ol start="6">
<li>We run the code again. This time the code stops at the moment the data produced an error:</li>
</ol>
<pre><code class="lang-python">$ python debug_skills.py
&gt; ...debug_skills.py(38)&lt;module&gt;()
-&gt; ready_name = f'{last_name}, {first_name}'
(Pdb) full_name
'John Paul Smith'</code></pre>
<ol start="7">
<li>The cause is now clear, line 35 only allows us to split two words, but raises an error if a middle name is added. After some testing, we settle into this line to fix it:</li>
</ol>
<pre><code class="lang-python">    # ERROR Step 6 split only two words. Some names has middle names
    # (old) first_name, last_name = full_name.split()
    first_name, last_name = full_name.rsplit(maxsplit=1)</code></pre>
<ol start="8">
<li>We run the script again. Be sure to remove the <kbd>breakpoint</kbd> and <kbd>try..except</kbd> block.&nbsp;This time, it generates a list of names! And they are sorted alphabetically by surname. However, a few of the names look incorrect:</li>
</ol>
<pre><code class="lang-python">$ python debug_skills_solved.py
['Berg, Keagan', 'Cordova, Mai', 'Craig, Michael', 'Garc\\u00eda, Roc\\u00edo', 'Mccabe, Fathima', "O'Carroll, S\\u00e9amus", 'Pate, Poppy-Mae', 'Rennie, Vivienne', 'Smith, John Paul', 'Smyth, John', 'Sullivan, Roman']</code></pre>
<p>Who's called&nbsp;<kbd>O'Carroll, S\\u00e9amus</kbd> ?</p>
<ol start="9">
<li>To analyse this particular case, but skip the rest, we must create an <kbd>if</kbd> condition to break only for that name in line 33. Notice the <kbd>in</kbd> to avoid having to be totally correct:</li>
</ol>
<pre><code class="lang-python">    full_name = parse.search('"custname": "{name}"', raw_result)['name']
    if "O'Carroll" in full_name:
        breakpoint()</code></pre>
<ol start="10">
<li>Run the script once more. The breakpoint stops at the proper moment:</li>
</ol>
<pre><code class="lang-python">$ python debug_skills.py
&gt; debug_skills.py(38)&lt;module&gt;()
-&gt; first_name, last_name = full_name.rsplit(maxsplit=1)
(Pdb) full_name
"S\\u00e9amus O'Carroll"</code></pre>
<ol start="11">
<li>Move upward in the code and check the different variables:</li>
</ol>
<pre><code class="lang-python">(Pdb) full_name
"S\\u00e9amus O'Carroll"
(Pdb) raw_result
'{"custname": "S\\u00e9amus O\'Carroll"}'
(Pdb) result.json()
{'args': {}, 'data': '{"custname": "S\\u00e9amus O\'Carroll"}', 'files': {}, 'form': {}, 'headers': {'Accept': '*/*', 'Accept-Encoding': 'gzip, deflate', 'Connection': 'close', 'Content-Length': '37', 'Content-Type': 'application/json', 'Host': 'httpbin.org', 'User-Agent': 'python-requests/2.18.3'}, 'json': {'custname': "S&eacute;amus O'Carroll"}, 'origin': '89.100.17.159', 'url': 'http://httpbin.org/post'}</code></pre>
<ol start="12">
<li>In the <kbd>result.json()</kbd> dictionary, there's actually a different field that seems to be rendering the name properly, which is called <kbd>'json'</kbd>. Let's look at it in detail; we can see that it's a dictionary:</li>
</ol>
<pre><code class="lang-python">(Pdb) result.json()['json']
{'custname': "S&eacute;amus O'Carroll"}
(Pdb) type(result.json()['json'])
&lt;class 'dict'&gt;</code></pre>
<ol start="13">
<li>Change the code, instead of parsing the raw value in <kbd>'data'</kbd>, use directly the <kbd>'json'</kbd> field from the result. This&nbsp; simplifies the code, which is great!</li>
</ol>
<pre><code class="lang-python">    # ERROR Step 11. Obtain the value from a raw value. Use
    # the decoded JSON instead
    # raw_result = result.json()['data']
    # Extract the name from the result
    # full_name = parse.search('"custname": "{name}"', raw_result)['name']
    raw_result = result.json()['json']
    full_name = raw_result['custname']</code></pre>
<ol start="14">
<li>Run the code again. Remember to remove the <kbd>breakpoint</kbd>:</li>
</ol>
<pre><code class="lang-python">$ python debug_skills.py
['Berg, Keagan', 'Cordova, Mai', 'Craig, Michael', 'Garc&iacute;a, Roc&iacute;o', 'Mccabe, Fathima', "O'Carroll, S&eacute;amus", 'Pate, Poppy-Mae', 'Rennie, Vivienne', 'Smith, John Paul', 'Smyth, John', 'Sullivan, Roman']</code></pre>
<p>This time, it's all correct! You have successfully debugged the program!</p>
<h3>How it works...</h3>
<p>The structure of the recipe is divided into three different problems. Let's analyze it in small blocks:</p>
<ul>
<li><strong>First error&mdash;Wrong call to the external service</strong>:</li>
</ul>
<p>After showing the first error in step 1, we read with care the resulting error, saying that the server is returning a 405 status code. This corresponds to a&nbsp;method not allowed, indicating that our calling method is not correct.</p>
<p>Inspect the following line:</p>
<pre><code class="lang-python">result = requests.get('http://httpbin.org/post', json=data)</code></pre>
<p>It gives us the indication that we are using a <kbd>GET</kbd> call to one URL that's defined for <kbd>POST</kbd>, so we make the change in step 2.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Notice that there has been no extra debugging steps as such in this error, but a careful reading of the error message and the code. Remember to pay attention to error messages and logs. Often, this is enough to discover the issue.</p>
</div>
</div>
<p>We run the code in step 3 to find the next problem.</p>
<ul>
<li><strong>Second error&mdash;Wrong handling of middle names</strong>:</li>
</ul>
<p>In step 3, we get an error of too many values to unpack. We create a <kbd>breakpoint</kbd> to analyze the data in step 4 at this point, but discover that not all the data produces this error. The analysis done in step 4 shows that it may be very confusing to stop the execution when an error is not produced, having to continue until it does. We know that the error is produced at this point, but only for certain kind of data.</p>
<p>As we know that the error is being produced at some point, we capture it in a <kbd>try..except</kbd> block in step 5. When the exception is produced, we trigger the <kbd>breakpoint</kbd>.</p>
<p>This makes step 6 execution of the script to stop when the <kbd>full_name</kbd> is&nbsp;<kbd>'John Paul Smith'</kbd>. This produces an error as the <kbd>split</kbd> expects two elements, not three.</p>
<p>This is fixed in step 7, allowing everything except the last word to be part of the first name, grouping any middle name(s) into the first element. This fits our purpose for this program, to sort by last name.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>Names are actually quite complex to handle. Check out this article if you want to be delighted with the great amount of wrong assumptions one can make regarding names:&nbsp;<a href="https://www.kalzumeus.com/2010/06/17/falsehoods-programmers-believe-about-names/">https://www.kalzumeus.com/2010/06/17/falsehoods-programmers-believe-about-names/</a>.</p>
</div>
</div>
<p>The following line does that with <kbd>rsplit</kbd>:</p>
<pre><code class="lang-python">first_name, last_name = full_name.rsplit(maxsplit=1)</code></pre>
<p>It divides the text by words, starting from the right and making a maximum of one split, guaranteeing that only two elements will be returned.</p>
<p>When the code is changed, step 8 runs the code again to discover the next error.</p>
<ul>
<li><strong>Third error&mdash;Using a wrong returned value by the external service</strong>:</li>
</ul>
<p>Running the code in step 8 displays the list and does not produce any errors. But, examining the results, we can see that some of the names are incorrectly processed.</p>
<p>We pick one of the examples in step 9 and create a conditional breakpoint. We only activate the <kbd>breakpoint</kbd> if the data fulfills the <kbd>if</kbd> condition.</p>
<div class="box note">
<h4>Note</h4>
<div class="body">
<p>The <kbd>if</kbd> condition in this case stops at any time the&nbsp;<kbd>"O'Carroll"</kbd>&nbsp;string appears, not having to make it stricter with an equal statement. Be pragmatic about this code, as you'll need to remove it after the bug is fixed anyway.</p>
</div>
</div>
<p>The code is run again in step 10. From there, once validated that the data is as expected, we worked <em>backward</em>&nbsp;to find the root of the problem. Step 11 analyzes previous values and the code up to that point, trying to find out what lead to the incorrect value.</p>
<p>We then discover that we used the wrong field in the returned value from the <kbd>result</kbd> from the server. The value in the <kbd>json</kbd> field is better for this task and it's already parsed for us. Step 12 checks the value and sees how it should be used.</p>
<p>In step 13, we change the code to adjust. Notice that the <kbd>parse</kbd> module is no longer needed and that the code is actually cleaner using the <kbd>json</kbd> field.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>This result is actually more common than it looks, especially when dealing with external interfaces. We may use it in a way that works, but maybe it's not the best. Take a little bit of time to read the documentation and keep an eye on improvements and learn how to better use the tools.</p>
</div>
</div>
<p>Once this is fixed, the code is run again in step 14. Finally, the code is doing what's expected, sorting the names alphabetically by surname. Notice that the other name that contained strange characters is fixed as well.</p>
<h3>There's more...</h3>
<p>The fixed script is available from GitHub:&nbsp;<a href="https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter10/debug_skills_fixed.py">https://github.com/PacktPublishing/Python-Automation-Cookbook/blob/master/Chapter10/debug_skills_fixed.py</a>. You can download it and see the differences.</p>
<p>There are other ways of creating conditional breakpoints. There's actually support from the debugger to create breakpoints that stop, but only if some conditions are met. When possible, we find it easier to work directly with code, as it is persistent between runs and easier to remember and operate. You can check how to create it in the Python <kbd>pdb</kbd> documentation:&nbsp;<a href="https://docs.python.org/3/library/pdb.html#pdbcommand-break">https://docs.python.org/3/library/pdb.html#pdbcommand-break</a>.</p>
<p>The kind of breakpoint catching an exception shown in the first error is a demonstration of how making conditions in code is straightforward. Just be careful to remove them afterwards!</p>
<p>There are other debuggers available that have an increased set of features. For example:</p>
<ul>
<li><kbd>ipdb</kbd> (<a href="https://github.com/gotcha/ipdb">https://github.com/gotcha/ipdb</a>): Adds tab completion and syntax highlights</li>
<li><kbd>pudb</kbd> (<a href="https://documen.tician.de/pudb/">https://documen.tician.de/pudb/</a>): Displays an old-style, semi-graphical, text-based interface, in the style of early 90s tools that display the environment variables automatically</li>
<li><kbd>web-pdb</kbd>&nbsp;(<a href="https://pypi.org/project/web-pdb/">https://pypi.org/project/web-pdb/</a>): Opens a web server to access a graphic interface with the debugger</li>
</ul>
<p>Check their documentations to know how to install them and run them.&nbsp;</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>There are more debuggers available, a search on the internet will give you more options, including Python IDEs. In any case, be aware of adding dependencies. It is always good to be able to use the default debugger.</p>
</div>
</div>
<p>The new breakpoint commands in Python 3.7 allow us to change easily between debuggers using the&nbsp;<kbd>PYTHONBREAKPOINT</kbd> environment variable. For example:</p>
<pre><code class="lang-python">$ PYTHONBREAKPOINT=ipdb.set_trace python my_script.py</code></pre>
<p>This starts <kbd>ipdb</kbd> on any breakpoint in the code. You can see more about this in the <kbd>breakpoint()</kbd> documentation&nbsp;can be found:&nbsp;<a href="https://www.python.org/dev/peps/pep-0553/#environment-variable">https://www.python.org/dev/peps/pep-0553/#environment-variable</a>.</p>
<div class="box tip">
<h4>Tip</h4>
<div class="body">
<p>An important effect on this is to disable all breakpoints by setting <kbd>PYTHONBREAKPOINT=0</kbd>, which is a great tool to ensure that code in production is never interrupted by a <kbd>breakpoint()</kbd> left by mistake.</p>
</div>
</div>
<p>The Python <kbd>pdb</kbd> documentation can be found here:&nbsp;<a href="https://docs.python.org/3/library/pdb.html">https://docs.python.org/3/library/pdb.html</a> The whole documentation of the <kbd>parse</kbd> module can be found at&nbsp;<a href="https://github.com/r1chardj0n3s/parse">https://github.com/r1chardj0n3s/parse</a>&nbsp;and the whole <kbd>requests</kbd> documentation at&nbsp;<a href="http://docs.python-requests.org/en/master/">http://docs.python-requests.org/en/master/</a>.</p>
<h3>See also</h3>
<ul>
<li>The <em>Learning Python interpreter basics</em> recipe</li>
<li>The <em>Debugging with breakpoints</em> recipe</li>
</ul>
<h3>Leave a review - let other readers know what you think</h3>
<p>Please share your thoughts on this book with others by leaving a review on the site that you bought it from. If you purchased the book from Amazon, please leave us an honest review on this book's Amazon page. This is vital so that other potential readers can see and use your unbiased opinion to make purchasing decisions, we can understand what our customers think about our products, and our authors can see your feedback on the title that they have worked with Packt to create. It will only take a few minutes of your time, but is valuable to other potential customers, our authors, and Packt. Thank you!</p>
</div>

