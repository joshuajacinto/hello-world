{"title":"Python High Performance","authors":["Gabriele Lanaro"],"publisher":"packt","version":1,"chapters":[{"title":"Preface","author":"","block":"k68ocgky","number":0,"contents":[{"block_type":"element","block":"k68ocnmw","search_text":"Python High Performance","text_count":23,"tag_name":"h2","attributes":{"id":"maintitle"},"children":[{"block_type":"text","content":"Python High Performance"}]},{"block_type":"element","block":"k68ocnmx","search_text":"Build high-performing, concurrent, and distributed applications","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Build high-performing, concurrent, and distributed applications"}]},{"block_type":"element","block":"k68ocnmy","search_text":"Gabriele Lanaro","text_count":15,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Gabriele Lanaro"}]},{"block_type":"element","block":"k68ocnmz","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000029.png","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k68ocnn0","search_text":"BIRMINGHAM - MUMBAI","text_count":19,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BIRMINGHAM - MUMBAI"}]}]},{"block_type":"element","block":"k68ocnn1","search_text":"Copyright © 2017 Packt Publishing","text_count":33,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Copyright &copy; 2017 Packt Publishing"}]},{"block_type":"element","block":"k68ocnn2","search_text":"All rights reserved. No part of this book may be reproduced, stored in a retrieval system, or transmitted in any form or by any means, without the prior written permission of the publisher, except in the case of brief quotations embedded in critical articles or reviews.","text_count":270,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All rights reserved. No part of this book may be reproduced, stored in a retrieval system, or transmitted in any form or by any means, without the prior written permission of the publisher, except in the case of brief quotations embedded in critical articles or reviews."}]},{"block_type":"element","block":"k68ocnn3","search_text":"Every effort has been made in the preparation of this book to ensure the accuracy of the information presented. However, the information contained in this book is sold without warranty, either express or implied. Neither the author, nor Packt Publishing, and its dealers and distributors will be held liable for any damages caused or alleged to be caused directly or indirectly by this book.","text_count":391,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Every effort has been made in the preparation of this book to ensure the accuracy of the information presented. However, the information contained in this book is sold without warranty, either express or implied. Neither the author, nor Packt Publishing, and its dealers and distributors will be held liable for any damages caused or alleged to be caused directly or indirectly by this book."}]},{"block_type":"element","block":"k68ocnn4","search_text":"Packt Publishing has endeavored to provide trademark information about all of the companies and products mentioned in this book by the appropriate use of capitals. However, Packt Publishing cannot guarantee the accuracy of this information.","text_count":240,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Packt Publishing has endeavored to provide trademark information about all of the companies and products mentioned in this book by the appropriate use of capitals. However, Packt Publishing cannot guarantee the accuracy of this information."}]},{"block_type":"element","block":"k68ocnn5","search_text":"First published: December 2013","text_count":30,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First published: December 2013"}]},{"block_type":"element","block":"k68ocnn6","search_text":"Second edition: May 2017","text_count":24,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Second edition:&nbsp;May&nbsp;2017"}]},{"block_type":"element","block":"k68ocnn7","search_text":"Production reference: 2250517","text_count":29,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Production reference: 2250517"}]},{"block_type":"element","block":"k68ocnn8","search_text":"Published by Packt Publishing Ltd.","text_count":34,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Published by Packt Publishing Ltd."}]},{"block_type":"element","block":"k68ocnn9","search_text":"Livery Place","text_count":12,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Livery Place"}]},{"block_type":"element","block":"k68ocnna","search_text":"35 Livery Street","text_count":16,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"35 Livery Street"}]},{"block_type":"element","block":"k68ocnnb","search_text":"Birmingham ","text_count":11,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Birmingham&nbsp;"}]},{"block_type":"element","block":"k68ocnnc","search_text":"B3 2PB, UK.","text_count":11,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"B3 2PB, UK."}]},{"block_type":"element","block":"k68ocnnd","search_text":"ISBN 978-1-78728-289-6","text_count":22,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"ISBN 978-1-78728-289-6"}]},{"block_type":"element","block":"k68ocnne","search_text":"www.packtpub.com","text_count":16,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com","target":"_blank","rel":"noopener"},"children":[{"block_type":"text","content":"www.packtpub.com"}]}]},{"block_type":"element","block":"k68ocnnf","search_text":"Credits","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Credits"}]},{"block_type":"element","block":"k68ocnng","search_text":"Author Gabriele Lanaro Copy Editor Shaila Kusanale Reviewer Will Brennan Project Coordinator Ulhas Kambali Commissioning Editor Kunal Parikh Proofreader Safis Editing Acquisition Editor Chaitanya Nair Indexer Tejal Daruwale Soni Content Development Editor Vikas Tiwari Graphics Abhinash Sahu Technical Editor Jijo Maliyekal Production Coordinator Shantanu Zagade ","text_count":363,"tag_name":"table","attributes":{},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Author"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Gabriele Lanaro"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Copy Editor"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Shaila Kusanale"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Reviewer"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Will Brennan"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Project Coordinator"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Ulhas Kambali"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Commissioning Editor"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Kunal Parikh"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Proofreader"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Safis Editing"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Acquisition Editor"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chaitanya Nair"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Indexer"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Tejal Daruwale Soni"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Content Development Editor"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Vikas Tiwari"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Graphics"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Abhinash Sahu"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Technical Editor"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Jijo Maliyekal"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Production Coordinator"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Shantanu Zagade"}]}]}]}]}]},{"block_type":"element","block":"k68ocnnh","search_text":"","text_count":0,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"&nbsp;&emsp;"}]},{"block_type":"element","block":"k68ocnni","search_text":"About the Author","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"About the Author"}]},{"block_type":"element","block":"k68ocnnj","search_text":"Dr. Gabriele Lanaro has been conducting research to study the formation and growth of crystals using medium and large-scale computer simulations. In 2017, he obtained his PhD in theoretical chemistry. His interests span machine learning, numerical computing visualization, and web technologies. He has a sheer passion for good software and is the author of the chemlab and chemview open source packages. In 2013, he authored the first edition of the book “ High Performance Python Programming ”.","text_count":495,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Dr. Gabriele Lanaro"}]},{"block_type":"text","content":"has been conducting research to study the formation and growth of crystals using medium and large-scale computer simulations. In 2017, he obtained his PhD in theoretical chemistry. His interests span machine learning, numerical computing visualization, and web technologies. He has a sheer passion for good software and is the author of the chemlab and chemview open source packages. In 2013, he authored the first edition of the book &ldquo;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"High Performance Python Programming"}]},{"block_type":"text","content":"&rdquo;."}]},{"block_type":"element","block":"k68ocnnk","search_text":"I'd like to acknowledge the support from Packt editors, including Vikas Tiwari. I would also like to thank my girlfriend, Harani, who had to tolerate the way-too-long writing nights, and friends who provided company and support throughout. Also, as always, I’d love to thank my parents for giving me the opportunity to pursue my ambitions.","text_count":339,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"I'd like to acknowledge the support from Packt editors, including Vikas Tiwari. I would also like to thank my girlfriend, Harani, who had to tolerate the way-too-long writing nights, and friends who provided company and support throughout. Also, as always, I&rsquo;d love to thank my parents for giving me the opportunity to pursue my ambitions."}]},{"block_type":"element","block":"k68ocnnl","search_text":"Lastly, I would like to thank Blenz coffee for powering the execution engine of this book through electricity and caffeine.","text_count":123,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Lastly, I would like to thank Blenz coffee for powering the execution engine of this book through electricity and caffeine."}]},{"block_type":"element","block":"k68ocnnm","search_text":"About the Reviewer","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"About the Reviewer"}]},{"block_type":"element","block":"k68ocnnn","search_text":"Will Brennan is a C++/Python developer based in London with previous experience in writing molecular dynamics simulations. He is currently working on high-performance image processing and machine learning applications. You can refer to his repositories at https://github.com/WillBrennan .","text_count":288,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Will Brennan"}]},{"block_type":"text","content":"is a C++/Python developer based in London with previous experience in writing molecular dynamics simulations. He&nbsp;is currently working on high-performance image processing and machine learning applications. You can refer to his repositories at&nbsp;"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/WillBrennan"},"children":[{"block_type":"text","content":"https://github.com/WillBrennan"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnno","search_text":"Preface","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Preface"}]},{"block_type":"element","block":"k68ocnnp","search_text":"The Python programming language has seen a huge surge in popularity in recent years, thanks to its intuitive, fun syntax, and its vast array of top-quality third-party libraries. Python has been the language of choice for many introductory and advanced university courses as well as for numerically intense fields, such as the sciences and engineering. Its primary applications also lies in machine learning, system scripting, and web applications.","text_count":448,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Python programming language has seen a huge surge in popularity in recent years, thanks to its intuitive, fun syntax, and its vast array of top-quality third-party libraries. Python has been the language of choice for many introductory and advanced university courses as well as for numerically intense fields, such as the sciences and engineering. Its primary applications also lies in machine learning, system scripting, and web applications."}]},{"block_type":"element","block":"k68ocnnq","search_text":"The reference Python interpreter, CPython, is generally regarded as inefficient when compared to lower-level languages, such as C, C++, and Fortran. CPython’s poor performance lies in the fact that the program instructions are processed by an interpreter rather than being compiled to efficient machine code. While using an interpreter has several advantages, such as portability and the additional compilation step, it does introduce an extra layer of indirection between the program and the machine, which causes a less efficient execution.","text_count":542,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The reference Python interpreter, CPython, is generally regarded as inefficient when compared to lower-level languages, such as C, C++, and Fortran. CPython&rsquo;s poor performance lies in the fact that the program instructions are processed by an interpreter rather than being compiled to efficient machine code. While using an interpreter has several advantages, such as portability and the additional compilation step, it does introduce an extra layer of indirection between the program and the machine, which causes a less efficient execution."}]},{"block_type":"element","block":"k68ocnnr","search_text":"Over the years, many strategies have been developed to overcome CPython's performance shortcomings. This book aims to fill this gap and will teach how to consistently achieve strong performance out of your Python programs.","text_count":222,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Over the years, many strategies have been developed to overcome CPython's performance shortcomings. This book aims to fill this gap and will teach how to consistently achieve strong performance out of your Python programs."}]},{"block_type":"element","block":"k68ocnns","search_text":"This book will appeal to a broad audience as it covers both the optimization of numerical and scientific codes as well as strategies to improve the response times of web services and applications.","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This book will appeal to a broad audience as it covers both the optimization of numerical and scientific codes as well as strategies to improve the response times of web services and applications."}]},{"block_type":"element","block":"k68ocnnt","search_text":"The book can be read cover-to-cover ; however, chapters are designed to be self-contained so that you can skip to a section of interest if you are already familiar with the previous topics.","text_count":189,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The book can be read cover-to-cover ; however, chapters are designed to be self-contained so that you can skip to a section of interest if you are already familiar with the previous topics."}]},{"block_type":"element","block":"k68ocnnu","search_text":"What this book covers","text_count":21,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"What this book covers"}]},{"block_type":"element","block":"k68ocnnv","search_text":"Chapter 1 , Benchmark and Profiling , will teach you how to assess the performance of Python programs and practical strategies on how to identify and isolate the slow sections of your code.","text_count":189,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 1"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":", Benchmark and Profiling"}]},{"block_type":"text","content":", will teach you how to assess the performance of Python programs and practical strategies on how to identify and isolate the slow sections of your code."}]},{"block_type":"element","block":"k68ocnnw","search_text":"Chapter 2 , Pure Python Optimizations , discusses how to improve your running times by order of magnitudes using the efficient data structures and algorithms available in the Python standard library and pure-Python third-party modules.","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 2"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":", Pure Python Optimizations"}]},{"block_type":"text","content":", discusses how to improve your running times by order of magnitudes using the efficient data structures and algorithms available in the Python standard library and pure-Python third-party modules."}]},{"block_type":"element","block":"k68ocnnx","search_text":"Chapter 3 , Fast Array Operations with NumPy and Pandas , is a guide to the NumPy and Pandas packages. Mastery of these packages will allow you to implement fast numerical algorithms with an expressive, concise interface.","text_count":221,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 3"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":", Fast Array Operations with NumPy and Pandas"}]},{"block_type":"text","content":", is a guide to the NumPy and Pandas packages. Mastery of these packages will allow you to implement fast numerical algorithms with an expressive, concise interface."}]},{"block_type":"element","block":"k68ocnny","search_text":"Chapter 4 , C Performance with Cython , is a tutorial on Cython, a language that uses a Python-compatible syntax to generate efficient C code.","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 4"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":", C Performance with Cython"}]},{"block_type":"text","content":", is a tutorial on Cython, a language that uses a Python-compatible syntax to generate efficient C code."}]},{"block_type":"element","block":"k68ocnnz","search_text":"Chapter 5, Exploring Compilers , covers tools that can be used to compile Python to efficient machine code. The chapter will teach you how to use Numba, an optimizing compiler for Python functions, and PyPy, an alternative interpreter that can execute and optimize Python programs on the fly.","text_count":292,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 5,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Exploring Compilers"}]},{"block_type":"text","content":", covers tools that can be used to compile Python to efficient machine code. The chapter will teach you how to use Numba, an optimizing compiler for Python functions, and PyPy, an alternative interpreter that can execute and optimize Python programs on the fly."}]},{"block_type":"element","block":"k68ocno0","search_text":"Chapter 6 , Implementing Concurrency , is a guide to asynchronous and reactive programming. We will learn about key terms and concepts, and demonstrate how to write clean, concurrent code using the asyncio and RxPy frameworks.","text_count":226,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 6"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":", Implementing Concurrency"}]},{"block_type":"text","content":", is a guide to asynchronous and reactive programming. We will learn about key terms and concepts, and demonstrate how to write clean, concurrent code using the asyncio and RxPy frameworks."}]},{"block_type":"element","block":"k68ocno1","search_text":"Chapter 7 , Parallel Processing , is an introduction to parallel programming on multi-core processors and GPUs. In this chapter, you will learn to achieve parallelism using the multiprocessing module and by expressing your code using Theano and Tensorflow.","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 7"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":", Parallel Processing"}]},{"block_type":"text","content":", is an introduction to parallel programming on multi-core processors and GPUs. In this chapter, you will learn to achieve parallelism using the multiprocessing module and by expressing your code using Theano and Tensorflow."}]},{"block_type":"element","block":"k68ocno2","search_text":"Chapter 8 , Distributed Processing , extends the content of the preceding chapter by focusing on running parallel algorithms on distributed systems for large-scale problems and big data. This chapter will cover the Dask, PySpark, and mpi4py libraries.","text_count":251,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 8"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":", Distributed Processing"}]},{"block_type":"text","content":", extends the content of the preceding chapter&nbsp;by focusing on running parallel algorithms on distributed systems for large-scale problems and big data. This chapter will cover the Dask, PySpark, and mpi4py libraries."}]},{"block_type":"element","block":"k68ocno3","search_text":"Chapter 9 , Designing for High Performance , discusses general optimization strategies and best practices to develop, test, and deploy your high-performance Python applications.","text_count":177,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 9"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":", Designing for High Performance"}]},{"block_type":"text","content":", discusses general optimization strategies and best practices to develop, test, and deploy your high-performance Python applications."}]},{"block_type":"element","block":"k68ocno4","search_text":"What you need for this book","text_count":27,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"What you need for this book"}]},{"block_type":"element","block":"k68ocno5","search_text":"The software in this book is tested on Python version 3.5 and on Ubuntu version 16.04. However, majority of the examples can also be run on the Windows and Mac OS X operating systems.","text_count":183,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The software in this book is tested on Python version 3.5 and on Ubuntu version 16.04. However, majority of the examples can also be run on the Windows and Mac OS X operating systems."}]},{"block_type":"element","block":"k68ocno6","search_text":"The recommended way to install Python and the associated libraries is through the Anaconda distribution, which can be downloaded from https://www.continuum.io/downloads , for Linux, Windows, and Mac OS X.","text_count":204,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The recommended way to install Python and the associated libraries is through the Anaconda distribution, which can be downloaded from"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.continuum.io/downloads"},"children":[{"block_type":"text","content":"https://www.continuum.io/downloads"}]},{"block_type":"text","content":", for Linux, Windows, and Mac OS X."}]},{"block_type":"element","block":"k68ocno7","search_text":"Who this book is for","text_count":20,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Who this book is for"}]},{"block_type":"element","block":"k68ocno8","search_text":"The book is aimed at Python developers who want to improve the performance of their application; basic knowledge of Python is expected.","text_count":135,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The book is aimed at Python developers who want to improve the performance of their application; basic knowledge of Python is expected."}]},{"block_type":"element","block":"k68ocno9","search_text":"Conventions","text_count":11,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Conventions"}]},{"block_type":"element","block":"k68ocnoa","search_text":"In this book, you will find a number of text styles that distinguish between different kinds of information. Here are some examples of these styles and an explanation of their meaning.","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this book, you will find a number of text styles that distinguish between different kinds of information. Here are some examples of these styles and an explanation of their meaning."}]},{"block_type":"element","block":"k68ocnob","search_text":"Code words in text, database table names, folder names, filenames, file extensions, pathnames, dummy URLs, user input, and Twitter handles are shown as follows: \"To summarize, we will implement a method called ParticleSimulator.evolve_numpy and benchmark it against the pure Python version, renamed as ParticleSimulator.evolve_python \"","text_count":335,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Code words in text, database table names, folder names, filenames, file extensions, pathnames, dummy URLs, user input, and Twitter handles are shown as follows: \"To summarize, we will implement a method called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator.evolve_numpy"}]},{"block_type":"text","content":"and benchmark it against the pure Python version, renamed as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator.evolve_python"}]},{"block_type":"text","content":"\""}]},{"block_type":"element","block":"k68ocnoc","search_text":"A block of code is set as follows:","text_count":34,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A block of code is set as follows:"}]},{"block_type":"element","block":"k68ocnod","search_text":"def square(x): return x * x inputs = [0, 1, 2, 3, 4] outputs = pool.map(square, inputs) ","text_count":88,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def square(x):\n    return x * x\n\n    inputs = [0, 1, 2, 3, 4]\n    outputs = pool.map(square, inputs)"}]}]},{"block_type":"element","block":"k68ocnoe","search_text":"When we wish to draw your attention to a particular part of a code block, the relevant lines or items are set in bold:","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When we wish to draw your attention to a particular part of a code block, the relevant lines or items are set in bold:"}]},{"block_type":"element","block":"k68ocnof","search_text":"def square(x): return x * x inputs = [0, 1, 2, 3, 4] outputs = pool.map(square, inputs) ","text_count":88,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def square(x):\n    return x * x\n\n    inputs = [0, 1, 2, 3, 4]\n    outputs = pool.map(square, inputs)"}]}]},{"block_type":"element","block":"k68ocnog","search_text":"Any command-line input or output is written as follows:","text_count":55,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Any command-line input or output is written as follows:"}]},{"block_type":"element","block":"k68ocnoh","search_text":"$ time python -c 'import pi; pi.pi_serial()' real 0m0.734s user 0m0.731s sys 0m0.004s ","text_count":86,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"$ time python -c 'import pi; pi.pi_serial()' \nreal 0m0.734s\nuser 0m0.731s\nsys 0m0.004s"}]}]},{"block_type":"element","block":"k68ocnoi","search_text":"New terms and important words are shown in bold. Words that you see on the screen, for example, in menus or dialog boxes, appear in the text like this: \"On the right, clicking on the tab Callee Map will display a diagram of the function costs.\"","text_count":244,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"New terms"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"important words"}]},{"block_type":"text","content":"are shown in bold. Words that you see on the screen, for example, in menus or dialog boxes, appear in the text like this: \"On the right, clicking on the tab Callee Map will display a diagram of the function costs.\""}]},{"block_type":"element","block":"k68ocnoj","search_text":"Note Warnings or important notes appear in a box like this. ","text_count":60,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Warnings or important notes appear in a box like this."}]}]},{"block_type":"element","block":"k68ocnok","search_text":"Tip Tips and tricks appear like this. ","text_count":38,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Tips and tricks appear like this."}]}]},{"block_type":"element","block":"k68ocnol","search_text":"Reader feedback","text_count":15,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Reader feedback"}]},{"block_type":"element","block":"k68ocnom","search_text":"Feedback from our readers is always welcome. Let us know what you think about this book-what you liked or disliked. Reader feedback is important for us as it helps us develop titles that you will really get the most out of.","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Feedback from our readers is always welcome. Let us know what you think about this book-what you liked or disliked. Reader feedback is important for us as it helps us develop titles that you will really get the most out of."}]},{"block_type":"element","block":"k68ocnon","search_text":"To send us general feedback, simply e-mail feedback@packtpub.com , and mention the book's title in the subject of your message.","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To send us general feedback, simply e-mail&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"feedback@packtpub.com"}]},{"block_type":"text","content":", and mention the book's title in the subject of your message."}]},{"block_type":"element","block":"k68ocnoo","search_text":"If there is a topic that you have expertise in and you are interested in either writing or contributing to a book, see our author guide at www.packtpub.com/authors .","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If there is a topic that you have expertise in and you are interested in either writing or contributing to a book, see our author guide at&nbsp;"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com/authors","target":"_blank","rel":"noopener"},"children":[{"block_type":"text","content":"www.packtpub.com/authors"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnop","search_text":"Customer support","text_count":16,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Customer support"}]},{"block_type":"element","block":"k68ocnoq","search_text":"Now that you are the proud owner of a Packt book, we have a number of things to help you to get the most from your purchase.","text_count":124,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that you are the proud owner of a Packt book, we have a number of things to help you to get the most from your purchase."}]},{"block_type":"element","block":"k68ocnor","search_text":"Downloading the example code","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Downloading the example code"}]},{"block_type":"element","block":"k68ocnos","search_text":"You can download the example code files for this book from your account at http://www.packtpub.com . If you purchased this book elsewhere, you can visit http://www.packtpub.com/support and register to have the files e-mailed directly to you.","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can download the example code files for this book from your account at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com","target":"_blank","rel":"noopener"},"children":[{"block_type":"text","content":"http://www.packtpub.com"}]},{"block_type":"text","content":". If you purchased this book elsewhere, you can visit"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com/support","target":"_blank","rel":"noopener"},"children":[{"block_type":"text","content":"http://www.packtpub.com/support"}]},{"block_type":"text","content":"and register to have the files e-mailed directly to you."}]},{"block_type":"element","block":"k68ocnot","search_text":"You can download the code files by following these steps:","text_count":57,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can download the code files by following these steps:"}]},{"block_type":"element","block":"k68ocnou","search_text":"Log in or register to our website using your e-mail address and password. Hover the mouse pointer on the SUPPORT tab at the top. Click on Code Downloads & Errata. Enter the name of the book in the Search box. Select the book for which you're looking to download the code files. Choose from the drop-down menu where you purchased this book from. Click on Code Download. ","text_count":369,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Log in or register to our website using your e-mail address and password."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Hover the mouse pointer on the SUPPORT tab at the top."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Click on Code Downloads &amp; Errata."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Enter the name of the book in the Search box."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Select the book for which you're looking to download the code files."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Choose from the drop-down menu where you purchased this book from."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Click on Code Download."}]}]},{"block_type":"element","block":"k68ocnov","search_text":"Once the file is downloaded, please make sure that you unzip or extract the folder using the latest version of:","text_count":111,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once the file is downloaded, please make sure that you unzip or extract the folder using the latest version of:"}]},{"block_type":"element","block":"k68ocnow","search_text":"WinRAR / 7-Zip for Windows Zipeg / iZip / UnRarX for Mac 7-Zip / PeaZip for Linux ","text_count":82,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"WinRAR / 7-Zip for Windows"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Zipeg / iZip / UnRarX for Mac"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"7-Zip / PeaZip for Linux"}]}]},{"block_type":"element","block":"k68ocnox","search_text":"The code bundle for the book is also hosted on GitHub at https://github.com/PacktPublishing/Python-High-Performance-Second-Edition . We also have other code bundles from our rich catalog of books and videos available at https://github.com/PacktPublishing/ . Check them out!","text_count":273,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code bundle for the book is also hosted on GitHub at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/PacktPublishing/Python-High-Performance-Second-Edition"},"children":[{"block_type":"text","content":"https://github.com/PacktPublishing/Python-High-Performance-Second-Edition"}]},{"block_type":"text","content":". We also have other code bundles from our rich catalog of books and videos available at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/PacktPublishing/"},"children":[{"block_type":"text","content":"https://github.com/PacktPublishing/"}]},{"block_type":"text","content":". Check them out!"}]},{"block_type":"element","block":"k68ocnoy","search_text":"Downloading the color images of this book","text_count":41,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Downloading the color images of this book"}]},{"block_type":"element","block":"k68ocnoz","search_text":"We also provide you with a PDF file that has color images of the screenshots/diagrams used in this book. The color images will help you better understand the changes in the output. You can download this file from https://www.packtpub.com/sites/default/files/downloads/PythonHighPerformanceSecondEdition_ColorImages.pdf .","text_count":320,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We also provide you with a PDF file that has color images of the screenshots/diagrams used in this book. The color images will help you better understand the changes in the output. You can download this file from"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.packtpub.com/sites/default/files/downloads/PythonHighPerformanceSecondEdition_ColorImages.pdf"},"children":[{"block_type":"text","content":"https://www.packtpub.com/sites/default/files/downloads/PythonHighPerformanceSecondEdition_ColorImages.pdf"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnp0","search_text":"Errata","text_count":6,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Errata"}]},{"block_type":"element","block":"k68ocnp1","search_text":"Although we have taken every care to ensure the accuracy of our content, mistakes do happen. If you find a mistake in one of our books-maybe a mistake in the text or the code-we would be grateful if you could report this to us. By doing so, you can save other readers from frustration and help us improve subsequent versions of this book. If you find any errata, please report them by visiting http://www.packtpub.com/submit-errata , selecting your book, clicking on the Errata Submission Form link, and entering the details of your errata. Once your errata are verified, your submission will be accepted and the errata will be uploaded to our website or added to any list of existing errata under the Errata section of that title.","text_count":731,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Although we have taken every care to ensure the accuracy of our content, mistakes do happen. If you find a mistake in one of our books-maybe a mistake in the text or the code-we would be grateful if you could report this to us. By doing so, you can save other readers from frustration and help us improve subsequent versions of this book. If you find any errata, please report them by visiting"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com/submit-errata","target":"_blank","rel":"noopener"},"children":[{"block_type":"text","content":"http://www.packtpub.com/submit-errata"}]},{"block_type":"text","content":", selecting your book, clicking on the Errata Submission Form link, and entering the details of your errata. Once your errata are verified, your submission will be accepted and the errata will be uploaded to our website or added to any list of existing errata under the Errata section of that title."}]},{"block_type":"element","block":"k68ocnp2","search_text":"To view the previously submitted errata, go to https://www.packtpub.com/books/content/support and enter the name of the book in the search field. The required information will appear under the Errata section.","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To view the previously submitted errata, go to"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.packtpub.com/books/content/support","target":"_blank","rel":"noopener"},"children":[{"block_type":"text","content":"https://www.packtpub.com/books/content/support"}]},{"block_type":"text","content":"and enter the name of the book in the search field. The required information will appear under the Errata section."}]},{"block_type":"element","block":"k68ocnp3","search_text":"Piracy","text_count":6,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Piracy"}]},{"block_type":"element","block":"k68ocnp4","search_text":"Piracy of copyrighted material on the Internet is an ongoing problem across all media. At Packt, we take the protection of our copyright and licenses very seriously. If you come across any illegal copies of our works in any form on the Internet, please provide us with the location address or website name immediately so that we can pursue a remedy.","text_count":349,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Piracy of copyrighted material on the Internet is an ongoing problem across all media. At Packt, we take the protection of our copyright and licenses very seriously. If you come across any illegal copies of our works in any form on the Internet, please provide us with the location address or website name immediately so that we can pursue a remedy."}]},{"block_type":"element","block":"k68ocnp5","search_text":"Please contact us at copyright@packtpub.com with a link to the suspected pirated material.","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Please contact us at&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"copyright@packtpub.com"}]},{"block_type":"text","content":"&nbsp;with a link to the suspected pirated material."}]},{"block_type":"element","block":"k68ocnp6","search_text":"We appreciate your help in protecting our authors and our ability to bring you valuable content.","text_count":96,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We appreciate your help in protecting our authors and our ability to bring you valuable content."}]},{"block_type":"element","block":"k68ocnp7","search_text":"Questions","text_count":9,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Questions"}]},{"block_type":"element","block":"k68ocnp8","search_text":"If you have a problem with any aspect of this book, you can contact us at questions@packtpub.com , and we will do our best to address the problem.","text_count":146,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you have a problem with any aspect of this book, you can contact us at&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"questions@packtpub.com"}]},{"block_type":"text","content":", and we will do our best to address the problem."}]}]},{"title":"Benchmarking and Profiling","author":"Gabriele Lanaro","block":"k68ocgmo","number":1,"contents":[{"block_type":"element","block":"k68ocnp9","search_text":"Recognizing the slow parts of your program is the single most important task when it comes to speeding up your code. Luckily, in most cases, the code that causes the application to slow down is a very small fraction of the program. By locating those critical sections, you can focus on the parts that need improvement without wasting time in micro-optimization.","text_count":361,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Recognizing the slow parts of your program is the single most important task when it comes to speeding up your code. Luckily, in most cases, the code that causes the application to slow down is a very small fraction of the program. By locating those critical sections, you can focus on the parts that need improvement without wasting time in micro-optimization."}]},{"block_type":"element","block":"k68ocnpa","search_text":"Profiling is the technique that allows us to pinpoint the most resource-intensive spots in an application. A profiler is a program that runs an application and monitors how long each function takes to execute, thus detecting the functions in which your application spends most of its time.","text_count":289,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Profiling"}]},{"block_type":"text","content":"is the technique that allows us to pinpoint the most resource-intensive spots in an application. A"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"profiler"}]},{"block_type":"text","content":"is a program that runs an application and monitors how long each function takes to execute, thus detecting the functions in which your application spends most of its time."}]},{"block_type":"element","block":"k68ocnpb","search_text":"Python provides several tools to help us find these bottlenecks and measure important performance metrics. In this chapter, we will learn how to use the standard cProfile module and the line_profiler third-party package. We will also learn how to profile an application's memory consumption through the memory_profiler tool. Another useful tool that we will cover is KCachegrind , which can be used to graphically display the data produced by various profilers.","text_count":461,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Python provides several tools to help us find these bottlenecks and measure important&nbsp;performance metrics. In this chapter, we will learn how to use the standard"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"module and the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":"&nbsp;third-party package.&nbsp; We will also learn how to profile an application's memory consumption through the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"memory_profiler"}]},{"block_type":"text","content":"tool. Another useful tool that we will cover is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"KCachegrind"}]},{"block_type":"text","content":", which can be used&nbsp;to graphically display the data produced by various profilers."}]},{"block_type":"element","block":"k68ocnpc","search_text":"Benchmarks are small scripts used to assess the total execution time of your application. We will learn how to write benchmarks and how to accurately time your programs.","text_count":169,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Benchmarks"}]},{"block_type":"text","content":"are small scripts used to&nbsp;assess the total execution time of your application. We will learn how to write benchmarks and how to accurately time your programs."}]},{"block_type":"element","block":"k68ocnpd","search_text":"The list of topics we will cover in this chapter is as follows:","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The list of topics we will cover in this chapter is as follows:"}]},{"block_type":"element","block":"k68ocnpe","search_text":"General principles of high performance programming Writing tests and benchmarks The Unix time command The Python timeit module Testing and benchmarking with pytest Profiling your application The cProfile standard tool Interpreting profiling results with KCachegrind line_profiler and memory_profiler tools Disassembling Python code through the dis module ","text_count":355,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"General principles of high performance&nbsp;programming"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Writing tests and benchmarks"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The Unix"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":"command"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The Python"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"module"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Testing and benchmarking with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Profiling your application"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"standard tool"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Interpreting profiling results with KCachegrind"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":"and&nbsp;&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"memory_profiler"}]},{"block_type":"text","content":"&nbsp;tools"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Disassembling Python code through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dis"}]},{"block_type":"text","content":"module"}]}]},{"block_type":"element","block":"k68ocnpf","search_text":"Designing your application","text_count":26,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Designing your application"}]},{"block_type":"element","block":"k68ocnpg","search_text":"When designing a performance-intensive program, the very first step is to write your code without bothering with small optimizations:","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When designing a performance-intensive program, the very first step is to write your code without bothering with small optimizations:"}]},{"block_type":"element","block":"k68ocnph","search_text":"\"Premature optimization is the root of all evil.\" - Donald Knuth ","text_count":65,"tag_name":"blockquote","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"\"Premature optimization is the root of all evil.\""}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"-&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Donald Knuth"}]}]}]},{"block_type":"element","block":"k68ocnpi","search_text":"In the early development stages, the design of the program can change quickly and may require large rewrites and reorganizations of the code base. By testing different prototypes without the burden of optimization, you are free to devote your time and energy to ensure that the program produces correct results and that the design is flexible. After all, who needs an application that runs fast but gives the wrong answer?","text_count":422,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the early development stages, the design of the program can change quickly and may require large rewrites and reorganizations&nbsp;of the code base. By testing different prototypes without the burden of optimization, you are free to devote your time and energy to ensure that the program produces correct results and that the design is flexible. After all, who needs an application that runs fast but gives the wrong answer?"}]},{"block_type":"element","block":"k68ocnpj","search_text":"The mantras that you should remember when optimizing your code are as follows:","text_count":78,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The mantras that you should remember when optimizing your code are as follows:"}]},{"block_type":"element","block":"k68ocnpk","search_text":"Make it run : We have to get the software in a working state, and ensure that it produces the correct results. This exploratory phase serves to better understand the application and to spot major design issues in the early stages. Make it right : We want to ensure that the design of the program is solid. Refactoring should be done before attempting any performance optimization. This really helps separate the application into independent and cohesive units that are easier to maintain. Make it fast : Once our program is working and is well structured, we can focus on performance optimization. We may also want to optimize memory usage if that constitutes an issue. ","text_count":670,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Make it run"}]},{"block_type":"text","content":": We have to get the software in a working state, and ensure that it produces the correct results. This exploratory phase serves to better&nbsp;understand the application&nbsp;and to spot major design issues in the early stages."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Make it right"}]},{"block_type":"text","content":": We want to ensure that the design of the program is solid. Refactoring should be done before attempting any performance optimization. This really helps separate the application into independent and cohesive units that are easier to maintain."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Make it fast"}]},{"block_type":"text","content":": Once our program is working and is well structured, we can focus on performance optimization. We may also want to optimize memory usage if that constitutes an issue."}]}]},{"block_type":"element","block":"k68ocnpl","search_text":"In this section, we will write and profile a particle simulator test application. The simulator is a program that takes some particles and simulates their movement over time according to a set of laws that we impose. These particles can be abstract entities or correspond to physical objects, for example, billiard balls moving on a table, molecules in gas, stars moving through space, smoke particles, fluids in a chamber, and so on.","text_count":434,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will write and profile a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"particle simulator"}]},{"block_type":"text","content":"test application. The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"simulator"}]},{"block_type":"text","content":"is a program that takes some particles and simulates their movement over&nbsp;time according to a set of laws that we impose. These particles can be abstract entities or correspond to physical objects, for example, billiard balls moving on a table, molecules in gas, stars moving through space, smoke particles, fluids in a chamber, and so on."}]},{"block_type":"element","block":"k68ocnpm","search_text":"Computer simulations are useful in fields such as Physics, Chemistry, Astronomy, and many other disciplines. The applications used to simulate systems are particularly performance-intensive and scientists and engineers spend an inordinate amount of time optimizing these codes. In order to study realistic systems, it is often necessary to simulate a very high number of bodies and every small increase in performance counts.","text_count":425,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Computer simulations are useful in fields such as Physics, Chemistry, Astronomy, and many other disciplines. The applications used to simulate systems are particularly performance-intensive and scientists and engineers spend an inordinate amount of time optimizing these codes. In order to study realistic systems, it is often necessary to simulate a very high number of bodies and every small increase in performance counts."}]},{"block_type":"element","block":"k68ocnpn","search_text":"In our first example, we will simulate a system containing particles that constantly rotate around a central point at various speeds, just like the hands of a clock.","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In our first example, we will simulate a system containing particles that constantly rotate around a central point at various speeds, just like the hands of a clock."}]},{"block_type":"element","block":"k68ocnpo","search_text":"The necessary information to run our simulation will be the starting positions of the particles, the speed, and the rotation direction. From these elements, we have to calculate the position of the particle in the next instant of time. An example system is shown in the following figure. The origin of the system is the (0, 0) point, the position is indicated by the x , y vector and the velocity is indicated by the vx , vy vector:","text_count":432,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The necessary information to run our simulation will be the starting positions of the particles, the speed, and the rotation direction. From these elements, we have to calculate the position of the particle in the next instant of time. An example system is shown in the following figure. The origin of the system is the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(0, 0)"}]},{"block_type":"text","content":"point, the position is indicated by the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"vector and the velocity is indicated by the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"vx"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"vy"}]},{"block_type":"text","content":"vector:"}]},{"block_type":"element","block":"k68ocnpp","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000011.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocnpq","search_text":"The basic feature of a circular motion is that the particles always move perpendicular to the direction connecting the particle and the center. To move the particle, we simply change the position by taking a series of very small steps (which correspond to advancing the system for a small interval of time) in the direction of motion, as shown in the following figure:","text_count":368,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The basic feature of a circular motion is that the particles always move perpendicular to the direction connecting the particle and the center. To move the particle, we simply change the position by taking a series of very small steps (which correspond to advancing the system for a small interval of time) in the direction of motion, as shown in the following figure:"}]},{"block_type":"element","block":"k68ocnpr","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000024.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocnps","search_text":"We will start by designing the application in an object-oriented way. According to our requirements, it is natural to have a generic Particle class that stores the particle positions, x and y , and their angular velocity, ang_vel :","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will start by designing the application in an object-oriented way. According to our requirements, it is natural to have a generic"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Particle"}]},{"block_type":"text","content":"class that stores the particle positions,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"&nbsp;and&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":", and their&nbsp;angular velocity,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ang_vel"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocnpt","search_text":"class Particle: def __init__(self, x, y, ang_vel): self.x = x self.y = y self.ang_vel = ang_vel ","text_count":96,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class Particle: \n        def __init__(self, x, y, ang_vel): \n            self.x = x \n            self.y = y \n            self.ang_vel = ang_vel"}]}]},{"block_type":"element","block":"k68ocnpu","search_text":"Note that we accept positive and negative numbers for all the parameters (the sign of ang_vel will simply determine the direction of rotation).","text_count":143,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that we accept positive and negative numbers for all the parameters (the sign of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ang_vel"}]},{"block_type":"text","content":"will simply determine the direction of rotation)."}]},{"block_type":"element","block":"k68ocnpv","search_text":"Another class, called ParticleSimulator , will encapsulate the laws of motion and will be responsible for changing the positions of the particles over time. The __init__ method will store a list of Particle instances and the evolve method will change the particle positions according to our laws.","text_count":296,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another class, called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator"}]},{"block_type":"text","content":", will encapsulate the&nbsp;laws of motion and will be responsible for changing the positions of the particles over time. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"__init__"}]},{"block_type":"text","content":"method will store a list of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Particle"}]},{"block_type":"text","content":"instances and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"evolve"}]},{"block_type":"text","content":"method will change the particle positions according to our laws."}]},{"block_type":"element","block":"k68ocnpw","search_text":"We want the particles to rotate around the position corresponding to the x=0 and y=0 coordinates, at a constant speed. The direction of the particles will always be perpendicular to the direction from the center (refer to the first figure of this chapter). To find the direction of the movement along the x and y axes (corresponding to the Python v_x and v_y variables), it is sufficient to use these formulae:","text_count":410,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We want the particles to rotate around the position corresponding to the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x=0"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"y=0"}]},{"block_type":"text","content":"&nbsp;coordinates, at a constant speed. The direction of the particles will always be perpendicular to the direction from the center (refer to the first figure of this chapter). To find the direction of the movement along the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"axes (corresponding to the Python&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"v_x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"v_y"}]},{"block_type":"text","content":"&nbsp;variables), it is sufficient to use these formulae:"}]},{"block_type":"element","block":"k68ocnpx","search_text":"v_x = -y / (x**2 + y**2)**0.5 v_y = x / (x**2 + y**2)**0.5 ","text_count":59,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"v_x = -y / (x**2 + y**2)**0.5\n    v_y = x / (x**2 + y**2)**0.5"}]}]},{"block_type":"element","block":"k68ocnpy","search_text":"If we let one of our particles move, after a certain time t , it will reach another position following a circular path. We can approximate a circular trajectory by dividing the time interval, t , into tiny time steps, dt , where the particle moves in a straight line tangentially to the circle. The final result is just an approximation of a circular motion. In order to avoid a strong divergence, such as the one illustrated in the following figure, it is necessary to take very small time steps:","text_count":497,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we let one of our particles move, after a certain time"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"t"}]},{"block_type":"text","content":", it will reach another position following a circular path. We can approximate a circular trajectory by dividing the time interval,&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"t"}]},{"block_type":"text","content":", into tiny time steps,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"dt"}]},{"block_type":"text","content":", where the particle moves in a straight line tangentially to the circle. The final result is just an approximation of a circular motion. In order to avoid a strong divergence, such as the one illustrated in the following figure, it is necessary to take very small time steps:"}]},{"block_type":"element","block":"k68ocnpz","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000012.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocnq0","search_text":"In a more schematic way, we have to carry out the following steps to calculate the particle position at time t :","text_count":112,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a more schematic way, we have to carry out the following steps to calculate the particle position at time"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"t"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocnq1","search_text":"Calculate the direction of motion ( v_x and v_y ). Calculate the displacement ( d_x and d_y ), which is the product of time step, angular velocity, and direction of motion. Repeat steps 1 and 2 for enough times to cover the total time t . ","text_count":239,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Calculate the direction of motion ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"v_x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"v_y"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Calculate the displacement ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"d_x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"d_y"}]},{"block_type":"text","content":"), which is the product of time step, angular velocity, and direction of motion."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Repeat steps 1 and 2 for enough times to cover the total time"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"t"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68ocnq2","search_text":"The following code shows the full ParticleSimulator implementation:","text_count":67,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following code shows the full"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator"}]},{"block_type":"text","content":"implementation:"}]},{"block_type":"element","block":"k68ocnq3","search_text":"class ParticleSimulator: def __init__(self, particles): self.particles = particles def evolve(self, dt): timestep = 0.00001 nsteps = int(dt/timestep) for i in range(nsteps): for p in self.particles: # 1. calculate the direction norm = (p.x**2 + p.y**2)**0.5 v_x = -p.y/norm v_y = p.x/norm # 2. calculate the displacement d_x = timestep * p.ang_vel * v_x d_y = timestep * p.ang_vel * v_y p.x += d_x p.y += d_y # 3. repeat for all the time steps ","text_count":444,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class ParticleSimulator: \n\n        def __init__(self, particles): \n            self.particles = particles \n\n        def evolve(self, dt): \n            timestep = 0.00001 \n            nsteps = int(dt/timestep) \n     \n            for i in range(nsteps):\n                for p in self.particles:\n                    # 1. calculate the direction \n                    norm = (p.x**2 + p.y**2)**0.5 \n                    v_x = -p.y/norm \n                    v_y = p.x/norm \n\n                    # 2. calculate the displacement \n                    d_x = timestep * p.ang_vel * v_x \n                    d_y = timestep * p.ang_vel * v_y \n\n                    p.x += d_x \n                    p.y += d_y \n                    # 3. repeat for all the time steps"}]}]},{"block_type":"element","block":"k68ocnq4","search_text":"We can use the matplotlib library to visualize our particles. This library is not included in the Python standard library, and it can be easily installed using the pip install matplotlib command.","text_count":195,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib"}]},{"block_type":"text","content":"library to visualize our particles. This library is not included in the Python standard library, and&nbsp;it can be easily installed using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip install matplotlib"}]},{"block_type":"text","content":"&nbsp;command."}]},{"block_type":"element","block":"k68ocnq5","search_text":"Note Alternatively, you can use the Anaconda Python distribution ( https://store.continuum.io/cshop/anaconda/ ) that includes matplotlib and most of the other third-party packages used in this book. Anaconda is free and is available for Linux, Windows, and Mac. ","text_count":262,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Alternatively, you can use the Anaconda Python distribution ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://store.continuum.io/cshop/anaconda/"},"children":[{"block_type":"text","content":"https://store.continuum.io/cshop/anaconda/"}]},{"block_type":"text","content":") that includes"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib"}]},{"block_type":"text","content":"and most of the other third-party packages used in this book. Anaconda is free and is available for Linux, Windows, and Mac."}]}]},{"block_type":"element","block":"k68ocnq6","search_text":"To make an interactive visualization, we will use the matplotlib.pyplot.plot function to display the particles as points and the matplotlib.animation.FuncAnimation class to animate the evolution of the particles over time.","text_count":222,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To make an interactive visualization, we will use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib.pyplot.plot"}]},{"block_type":"text","content":"function to&nbsp;display the&nbsp;particles as points&nbsp;and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib.animation.FuncAnimation"}]},{"block_type":"text","content":"class to animate the evolution of the&nbsp;particles over time."}]},{"block_type":"element","block":"k68ocnq7","search_text":"The visualize function takes a particle ParticleSimulator instance as an argument and displays the trajectory in an animated plot. The steps necessary to display the particle trajectory using the matplotlib tools are as follows:","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"visualize"}]},{"block_type":"text","content":"function takes a particle"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator"}]},{"block_type":"text","content":"instance as an argument and displays the trajectory in an animated plot. The steps necessary to display&nbsp;the particle trajectory using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib"}]},{"block_type":"text","content":"tools&nbsp;are as follows:"}]},{"block_type":"element","block":"k68ocnq8","search_text":"Set up the axes and use the plot function to display the particles. plot takes a list of x and y coordinates. Write an initialization function, init , and a function, animate , that updates the x and y coordinates using the line.set_data method. Create a FuncAnimation instance by passing the init and animate functions plus the interval parameters, which specify the update interval, and blit , which improves the update rate of the image. Run the animation with plt.show() : ","text_count":477,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Set up the axes and use the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"plot"}]},{"block_type":"text","content":"function to display the particles."},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"plot"}]},{"block_type":"text","content":"takes a list of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"coordinates."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Write an initialization function,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"init"}]},{"block_type":"text","content":", and a function,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"animate"}]},{"block_type":"text","content":", that updates the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y&nbsp;"}]},{"block_type":"text","content":"coordinates using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line.set_data"}]},{"block_type":"text","content":"method."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"FuncAnimation"}]},{"block_type":"text","content":"instance by passing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"init"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"animate"}]},{"block_type":"text","content":"functions plus the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"interval"}]},{"block_type":"text","content":"&nbsp;parameters, which specify the update interval, and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"blit"}]},{"block_type":"text","content":", which improves the update rate of the image."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Run the animation with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"plt.show()"}]},{"block_type":"text","content":":"}]}]},{"block_type":"element","block":"k68ocnq9","search_text":"from matplotlib import pyplot as plt from matplotlib import animation def visualize(simulator): X = [p.x for p in simulator.particles] Y = [p.y for p in simulator.particles] fig = plt.figure() ax = plt.subplot(111, aspect='equal') line, = ax.plot(X, Y, 'ro') # Axis limits plt.xlim(-1, 1) plt.ylim(-1, 1) # It will be run when the animation starts def init(): line.set_data([], []) return line, # The comma is important! def animate(i): # We let the particle evolve for 0.01 time units simulator.evolve(0.01) X = [p.x for p in simulator.particles] Y = [p.y for p in simulator.particles] line.set_data(X, Y) return line, # Call the animate function each 10 ms anim = animation.FuncAnimation(fig, animate, init_func=init, blit=True, interval=10) plt.show() ","text_count":755,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from matplotlib import pyplot as plt \n    from matplotlib import animation \n\n    def visualize(simulator): \n\n        X = [p.x for p in simulator.particles] \n        Y = [p.y for p in simulator.particles] \n\n        fig = plt.figure() \n        ax = plt.subplot(111, aspect='equal') \n        line, = ax.plot(X, Y, 'ro') \n     \n        # Axis limits \n        plt.xlim(-1, 1) \n        plt.ylim(-1, 1) \n\n        # It will be run when the animation starts \n        def init(): \n            line.set_data([], []) \n            return line, # The comma is important!\n\n        def animate(i): \n            # We let the particle evolve for 0.01 time units \n            simulator.evolve(0.01) \n            X = [p.x for p in simulator.particles] \n            Y = [p.y for p in simulator.particles] \n\n            line.set_data(X, Y) \n            return line, \n\n        # Call the animate function each 10 ms \n        anim = animation.FuncAnimation(fig,\n                                       animate,\n                                       init_func=init,\n                                       blit=True,\n                                       interval=10) \n        plt.show()"}]}]},{"block_type":"element","block":"k68ocnqa","search_text":"To test things out, we define a small function, test_visualize , that animates a system of three particles rotating in different directions. Note that the third particle completes a round three times faster than the others:","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To test things out, we define a small function,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_visualize"}]},{"block_type":"text","content":", that animates a system of three particles rotating in different directions. Note that the third particle completes a round three times faster than the others:"}]},{"block_type":"element","block":"k68ocnqb","search_text":"def test_visualize(): particles = [Particle(0.3, 0.5, 1), Particle(0.0, -0.5, -1), Particle(-0.1, -0.4, 3)] simulator = ParticleSimulator(particles) visualize(simulator) if __name__ == '__main__': test_visualize() ","text_count":214,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def test_visualize(): \n        particles = [Particle(0.3, 0.5, 1), \n                     Particle(0.0, -0.5, -1), \n                     Particle(-0.1, -0.4, 3)] \n\n        simulator = ParticleSimulator(particles) \n        visualize(simulator) \n\n    if __name__ == '__main__': \n        test_visualize()"}]}]},{"block_type":"element","block":"k68ocnqc","search_text":"The test_visualize function is helpful to graphically understand the system time evolution. In the following section, we will write more test functions to properly verify program correctness and measure performance.","text_count":215,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_visualize"}]},{"block_type":"text","content":"function is helpful to graphically understand the system time evolution. In the following section, we will write more test functions to properly verify program correctness and measure performance."}]},{"block_type":"element","block":"k68ocnqd","search_text":"Writing tests and benchmarks","text_count":28,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Writing tests and benchmarks"}]},{"block_type":"element","block":"k68ocnqe","search_text":"Now that we have a working simulator, we can start measuring our performance and tune-up our code so that the simulator can handle as many particles as possible. As a first step, we will write a test and a benchmark.","text_count":216,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have a working simulator, we can start measuring our performance and tune-up our code so that the&nbsp;simulator can handle as many particles as possible. As a first step, we will write a test and a benchmark."}]},{"block_type":"element","block":"k68ocnqf","search_text":"We need a test that checks whether the results produced by the simulation are correct or not. Optimizing a program commonly requires employing multiple strategies; as we rewrite our code multiple times, bugs may easily be introduced. A solid test suite ensures that the implementation is correct at every iteration so that we are free to go wild and try different things with the confidence that, if the test suite passes, the code will still work as expected.","text_count":460,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We need a test that checks whether the results produced by the simulation are correct or not. Optimizing a program commonly requires employing multiple strategies; as we rewrite our code multiple times, bugs may easily be introduced. A&nbsp;solid test suite ensures that the implementation is correct at every iteration so that we are free to go wild and try different things with the confidence that, if the test suite passes, the code will still work as expected."}]},{"block_type":"element","block":"k68ocnqg","search_text":"Our test will take three particles, simulate them for 0.1 time units, and compare the results with those from a reference implementation. A good way to organize your tests is using a separate function for each different aspect (or unit) of your application. Since our current functionality is included in the evolve method, our function will be named test_evolve . The following code shows the test_evolve implementation. Note that, in this case, we compare floating point numbers up to a certain precision through the fequal function:","text_count":535,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our test will take three particles, simulate them&nbsp;for&nbsp;0.1 time units, and compare the results with those from a reference implementation. A good way to organize your tests is using a separate function for each different aspect (or unit) of your application. Since our current functionality is included in the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"evolve"}]},{"block_type":"text","content":"method, our function will be named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_evolve"}]},{"block_type":"text","content":". The following code shows the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_evolve"}]},{"block_type":"text","content":"implementation. Note that, in this case, we compare floating point numbers up to a certain&nbsp;precision through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fequal"}]},{"block_type":"text","content":"&nbsp;function:"}]},{"block_type":"element","block":"k68ocnqh","search_text":"def test_evolve(): particles = [Particle( 0.3, 0.5, +1), Particle( 0.0, -0.5, -1), Particle(-0.1, -0.4, +3)] simulator = ParticleSimulator(particles) simulator.evolve(0.1) p0, p1, p2 = particles def fequal(a, b, eps=1e-5): return abs(a - b) < eps assert fequal(p0.x, 0.210269) assert fequal(p0.y, 0.543863) assert fequal(p1.x, -0.099334) assert fequal(p1.y, -0.490034) assert fequal(p2.x, 0.191358) assert fequal(p2.y, -0.365227) if __name__ == '__main__': test_evolve() ","text_count":471,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def test_evolve(): \n        particles = [Particle( 0.3,  0.5, +1), \n                     Particle( 0.0, -0.5, -1), \n                     Particle(-0.1, -0.4, +3)] \n\n        simulator = ParticleSimulator(particles) \n\n        simulator.evolve(0.1) \n\n        p0, p1, p2 = particles \n\n        def fequal(a, b, eps=1e-5): \n            return abs(a - b) &lt; eps \n\n        assert fequal(p0.x, 0.210269) \n        assert fequal(p0.y, 0.543863) \n\n        assert fequal(p1.x, -0.099334) \n        assert fequal(p1.y, -0.490034) \n\n        assert fequal(p2.x,  0.191358) \n        assert fequal(p2.y, -0.365227) \n\n    if __name__ == '__main__': \n        test_evolve()"}]}]},{"block_type":"element","block":"k68ocnqi","search_text":"A test ensures the correctness of our functionality but gives little information about its running time. A benchmark is a simple and representative use case that can be run to assess the running time of an application. Benchmarks are very useful to keep score of how fast our program is with each new version that we implement.","text_count":327,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A test&nbsp;ensures the correctness of our functionality but gives little information about&nbsp;its running time. &nbsp;A benchmark is a simple and representative use case that can be run to assess the running time of an application. Benchmarks are very useful to keep score of&nbsp;how fast our program&nbsp;is with each new version that we implement."}]},{"block_type":"element","block":"k68ocnqj","search_text":"We can write a representative benchmark by instantiating a thousand Particle objects with random coordinates and angular velocity, and feed them to a ParticleSimulator class. We then let the system evolve for 0.1 time units:","text_count":224,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can write a representative benchmark by instantiating a thousand&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Particle"}]},{"block_type":"text","content":"objects with random coordinates and angular velocity, and feed them to a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator"}]},{"block_type":"text","content":"class. We then let the system evolve for&nbsp;0.1 time units:"}]},{"block_type":"element","block":"k68ocnqk","search_text":"from random import uniform def benchmark(): particles = [Particle(uniform(-1.0, 1.0), uniform(-1.0, 1.0), uniform(-1.0, 1.0)) for i in range(1000)] simulator = ParticleSimulator(particles) simulator.evolve(0.1) if __name__ == '__main__': benchmark() ","text_count":250,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from random import uniform \n\n    def benchmark(): \n        particles = [Particle(uniform(-1.0, 1.0), \n                              uniform(-1.0, 1.0), \n                              uniform(-1.0, 1.0)) \n                      for i in range(1000)] \n\n        simulator = ParticleSimulator(particles) \n        simulator.evolve(0.1) \n\n    if __name__ == '__main__': \n        benchmark()"}]}]},{"block_type":"element","block":"k68ocnql","search_text":"Timing your benchmark","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Timing your benchmark"}]},{"block_type":"element","block":"k68ocnqm","search_text":"A very simple way to time a benchmark is through the Unix time command. Using the time command, as follows, you can easily measure the execution time of an arbitrary process:","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A very simple way to time a&nbsp;benchmark is through the Unix"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":"command. Using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":"&nbsp;command, as follows, you can easily measure the execution time of an arbitrary process:"}]},{"block_type":"element","block":"k68ocnqn","search_text":"$ time python simul.py real 0m1.051s user 0m1.022s sys 0m0.028s ","text_count":64,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ time python simul.py\nreal    0m1.051s\nuser    0m1.022s\nsys     0m0.028s"}]}]},{"block_type":"element","block":"k68ocnqo","search_text":"Note The time command is not available for Windows. To install Unix tools, such as time , on Windows you can use the cygwin shell, downloadable from the official website ( http://www.cygwin.com/ ). Alternatively, you can use similar PowerShell commands, such as Measure-Command ( https://msdn.microsoft.com/en-us/powershell/reference/5.1/microsoft.powershell.utility/measure-command ), to measure execution time. ","text_count":413,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":"command is not available for Windows. To install Unix tools, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":", on Windows you can use the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cygwin"}]},{"block_type":"text","content":"shell, downloadable from the official website ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.cygwin.com/"},"children":[{"block_type":"text","content":"http://www.cygwin.com/"}]},{"block_type":"text","content":"). Alternatively, you can use similar PowerShell commands, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Measure-Command"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://msdn.microsoft.com/en-us/powershell/reference/5.1/microsoft.powershell.utility/measure-command"},"children":[{"block_type":"text","content":"https://msdn.microsoft.com/en-us/powershell/reference/5.1/microsoft.powershell.utility/measure-command"}]},{"block_type":"text","content":"), to measure execution time."}]}]},{"block_type":"element","block":"k68ocnqp","search_text":"By default, time displays three metrics:","text_count":40,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By default,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":"&nbsp;displays three metrics:"}]},{"block_type":"element","block":"k68ocnqq","search_text":"real : The actual time spent running the process from start to finish, as if it was measured by a human with a stopwatch user : The cumulative time spent by all the CPUs during the computation sys : The cumulative time spent by all the CPUs during system-related tasks, such as memory allocation ","text_count":296,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"real"}]},{"block_type":"text","content":": The actual time spent running the process from start to finish, as if it was measured by a human with a stopwatch"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"user"}]},{"block_type":"text","content":": The cumulative time spent by all the CPUs during the computation"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sys"}]},{"block_type":"text","content":": The cumulative time spent by all the CPUs during system-related tasks, such as memory allocation"}]}]},{"block_type":"element","block":"k68ocnqr","search_text":"Note that sometimes user + sys might be greater than real , as multiple processors may work in parallel.","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that sometimes"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"user"}]},{"block_type":"text","content":"+"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sys"}]},{"block_type":"text","content":"might be greater than"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"real"}]},{"block_type":"text","content":", as multiple processors may work in parallel."}]},{"block_type":"element","block":"k68ocnqs","search_text":"Tip time also offers richer formatting options. For an overview, you can explore its manual (using the man time command). If you want a summary of all the metrics available, you can use the -v option. ","text_count":201,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":"also offers richer&nbsp;formatting options. For an overview, you can explore its manual (using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"man time"}]},{"block_type":"text","content":"command). If you want a summary of all the metrics available, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-v"}]},{"block_type":"text","content":"option."}]}]},{"block_type":"element","block":"k68ocnqt","search_text":"The Unix time command is one of the simplest and more direct ways to benchmark a program. For an accurate measurement, the benchmark should be designed to have a long enough execution time (in the order of seconds) so that the setup and tear-down of the process is small compared to the execution time of the application. The user metric is suitable as a monitor for the CPU performance, while the real metric also includes the time spent in other processes while waiting for I/O operations.","text_count":491,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Unix"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":"command is one of the simplest and more direct ways to benchmark a program. For an&nbsp;accurate measurement, the benchmark should be designed to have a long enough&nbsp;execution time (in the order of seconds) so that the&nbsp;setup and tear-down of the process is small compared to the execution time of the application. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"user"}]},{"block_type":"text","content":"metric is suitable as a monitor for the CPU performance, while the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"real"}]},{"block_type":"text","content":"metric also includes the time spent in other processes while&nbsp;waiting for I/O operations."}]},{"block_type":"element","block":"k68ocnqu","search_text":"Another convenient way to time Python scripts is the timeit module. This module runs a snippet of code in a loop for n times and measures the total execution times. Then, it repeats the same operation r times (by default, the value of r is 3 ) and records the time of the best run. Due to this timing scheme, timeit is an appropriate tool to accurately time small statements in isolation.","text_count":388,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another convenient way to time Python scripts is the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"module. This module runs a snippet of code in a loop for"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"n"}]},{"block_type":"text","content":"times and measures&nbsp;the total execution times. Then, it repeats the same operation"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"r"}]},{"block_type":"text","content":"times (by default, the value of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"r"}]},{"block_type":"text","content":"is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"3"}]},{"block_type":"text","content":") and records the time of the best run. Due to&nbsp;this timing scheme,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"&nbsp;is an appropriate tool to accurately time small statements in isolation."}]},{"block_type":"element","block":"k68ocnqv","search_text":"The timeit module can be used as a Python package, from the command line or from IPython .","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"module can be used as a Python package, from the command line or from"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"IPython"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnqw","search_text":"IPython is a Python shell design that improves the interactivity of the Python interpreter. It boosts tab completion and many utilities to time, profile, and debug your code. We will use this shell to try out snippets throughout the book. The IPython shell accepts magic commands --statements that start with a % symbol--that enhance the shell with special behaviors. Commands that start with %% are called cell magics , which can be applied on multi-line snippets (termed as cells ).","text_count":484,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"IPython is a Python shell design that improves the interactivity of the Python interpreter. It boosts tab completion and many utilities to time, profile, and debug your code. We will use this shell to try out snippets throughout the book. The IPython shell accepts"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"magic commands"}]},{"block_type":"text","content":"--statements that start with a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%"}]},{"block_type":"text","content":"symbol--that enhance the shell with special behaviors. Commands that start with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%%"}]},{"block_type":"text","content":"are called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"cell magics"}]},{"block_type":"text","content":", which&nbsp;can be applied on multi-line snippets (termed as&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"cells"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k68ocnqx","search_text":"IPython is available on most Linux distributions through pip and is included in Anaconda.","text_count":89,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"IPython is available on most Linux distributions through"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip"}]},{"block_type":"text","content":"&nbsp;and is included in Anaconda."}]},{"block_type":"element","block":"k68ocnqy","search_text":"Tip You can use IPython as a regular Python shell ( ipython ), but it is also available in a Qt-based version ( ipython qtconsole ) and as a powerful browser-based interface ( jupyter notebook ). ","text_count":196,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can use IPython as a regular Python shell ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ipython"}]},{"block_type":"text","content":"), but it is also available in a Qt-based version ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ipython qtconsole"}]},{"block_type":"text","content":") and as a powerful browser-based interface ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"jupyter notebook"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k68ocnqz","search_text":"In IPython and command-line interfaces, it is possible to specify the number of loops or repetitions with the -n and -r options. If not specified, they will be automatically inferred by timeit . When invoking timeit from the command line, you can also pass some setup code, through the -s option, which will execute before the benchmark. In the following snippet, the IPython command line and Python module version of timeit are demonstrated: ","text_count":443,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In IPython and command-line interfaces, it is possible to specify the number of loops or repetitions with the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-n"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-r"}]},{"block_type":"text","content":"options. If not specified, they will be automatically inferred by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":". When invoking"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"from the command line, you can also pass&nbsp;some setup code, through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-s"}]},{"block_type":"text","content":"option, which&nbsp;will execute before the benchmark. In the following snippet, the IPython command line and Python module version of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"are demonstrated:&nbsp;"}]},{"block_type":"element","block":"k68ocnr0","search_text":"# IPython Interface $ ipython In [1]: from simul import benchmark In [2]: %timeit benchmark() 1 loops, best of 3: 782 ms per loop # Command Line Interface $ python -m timeit -s 'from simul import benchmark' 'benchmark()' 10 loops, best of 3: 826 msec per loop # Python Interface # put this function into the simul.py script import timeit result = timeit.timeit('benchmark()', setup='from __main__ import benchmark', number=10) # result is the time (in seconds) to run the whole loop result = timeit.repeat('benchmark()', setup='from __main__ import benchmark', number=10, repeat=3) # result is a list containing the time of each repetition (repeat=3 in this case) Note that while the command line and IPython interfaces automatically infer a reasonable number of loops n , the Python interface requires you to explicitly specify a value through the number argument. ","text_count":866,"tag_name":"blockquote","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"# IPython Interface"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"$ ipython"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"In [1]: from simul import benchmark"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"In [2]: %timeit benchmark()"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"1 loops, best of 3: 782 ms per loop"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"# Command Line Interface"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"$ python -m timeit -s 'from simul import benchmark' 'benchmark()'"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"10 loops, best of 3: 826 msec per loop"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"# Python Interface"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"# put this function into the simul.py script"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"import timeit"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"result = timeit.timeit('benchmark()',"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"setup='from __main__ import benchmark',"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"number=10)"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"# result is the time (in seconds) to run the whole loop"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"result = timeit.repeat('benchmark()',"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"setup='from __main__ import benchmark',"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"number=10,"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"repeat=3)"}]},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"# result is a list containing the time of each repetition (repeat=3 in this case)"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that while the command line and IPython interfaces automatically infer a reasonable number of loops"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"n"}]},{"block_type":"text","content":", the Python interface requires you to explicitly specify a value through the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"number"}]},{"block_type":"text","content":"argument."}]}]},{"block_type":"element","block":"k68ocnr1","search_text":"Better tests and benchmarks with pytest-benchmark","text_count":49,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Better tests and benchmarks with pytest-benchmark"}]},{"block_type":"element","block":"k68ocnr2","search_text":"The Unix time command is a versatile tool that can be used to assess the running time of small programs on a variety of platforms. For larger Python applications and libraries, a more comprehensive solution that deals with both testing and benchmarking is pytest , in combination with its pytest-benchmark plugin.","text_count":313,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Unix"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":"command is a versatile tool that can be used to assess the running time of small programs on a variety of platforms. For larger Python applications and libraries, a more comprehensive solution that deals with both testing and benchmarking is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest"}]},{"block_type":"text","content":", in combination with its"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest-benchmark"}]},{"block_type":"text","content":"&nbsp;plugin."}]},{"block_type":"element","block":"k68ocnr3","search_text":"In this section, we will write a simple benchmark for our application using the pytest testing framework. For the interested reader, the pytest documentation, which can be found at http://doc.pytest.org/en/latest/, is the best resource to learn more about the framework and its uses.","text_count":283,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will write a simple benchmark for our application using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest"}]},{"block_type":"text","content":"testing framework. For the interested reader, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest"}]},{"block_type":"text","content":"documentation, which can be found at&nbsp;"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://doc.pytest.org/en/latest/"},"children":[{"block_type":"text","content":"http://doc.pytest.org/en/latest/,"}]},{"block_type":"text","content":"is the best resource to learn more about the framework and its uses."}]},{"block_type":"element","block":"k68ocnr4","search_text":"Note You can install pytest from the console using the pip install pytest command. The benchmarking plugin can be installed, similarly, by issuing the pip install pytest-benchmark command. ","text_count":189,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can install"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest"}]},{"block_type":"text","content":"from the console using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip install pytest"}]},{"block_type":"text","content":"&nbsp;command. The benchmarking plugin can be installed, similarly, by issuing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip install pytest-benchmark"}]},{"block_type":"text","content":"&nbsp;command."}]}]},{"block_type":"element","block":"k68ocnr5","search_text":"A testing framework is a set of tools that simplifies writing, executing, and debugging tests and provides rich reports and summaries of the test results. When using the pytest framework, it is recommended to place tests separately from the application code. In the following example, we create the test_simul.py file, which contains the test_evolve function:","text_count":359,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A testing framework is a set of tools that simplifies writing, executing, and debugging tests and provides rich reports and summaries of the test results. When using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest"}]},{"block_type":"text","content":"framework, it is recommended to place tests separately from the application code. In the following example, we create the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_simul.py"}]},{"block_type":"text","content":"&nbsp;file, which contains the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_evolve"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k68ocnr6","search_text":"from simul import Particle, ParticleSimulator def test_evolve(): particles = [Particle( 0.3, 0.5, +1), Particle( 0.0, -0.5, -1), Particle(-0.1, -0.4, +3)] simulator = ParticleSimulator(particles) simulator.evolve(0.1) p0, p1, p2 = particles def fequal(a, b, eps=1e-5): return abs(a - b) < eps assert fequal(p0.x, 0.210269) assert fequal(p0.y, 0.543863) assert fequal(p1.x, -0.099334) assert fequal(p1.y, -0.490034) assert fequal(p2.x, 0.191358) assert fequal(p2.y, -0.365227) ","text_count":476,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from simul import Particle, ParticleSimulator\n\n    def test_evolve():\n        particles = [Particle( 0.3,  0.5, +1),\n                     Particle( 0.0, -0.5, -1),\n                     Particle(-0.1, -0.4, +3)]\n\n        simulator = ParticleSimulator(particles)\n\n        simulator.evolve(0.1)\n    \n        p0, p1, p2 = particles\n\n        def fequal(a, b, eps=1e-5):\n            return abs(a - b) &lt; eps\n\n        assert fequal(p0.x, 0.210269)\n        assert fequal(p0.y, 0.543863)\n\n        assert fequal(p1.x, -0.099334)\n        assert fequal(p1.y, -0.490034)\n\n        assert fequal(p2.x,  0.191358)\n        assert fequal(p2.y, -0.365227)"}]}]},{"block_type":"element","block":"k68ocnr7","search_text":"The pytest executable can be used from the command line to discover and run tests contained in Python modules. To execute a specific test, we can use the pytest path/to/module.py::function_name syntax. To execute test_evolve , we can type the following command in a console to obtain simple but informative output:","text_count":314,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The &nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest"}]},{"block_type":"text","content":"executable can be used from the command line to discover and run tests contained in Python modules. To execute a specific test, we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest path/to/module.py::function_name"}]},{"block_type":"text","content":"&nbsp;syntax. To execute"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_evolve"}]},{"block_type":"text","content":",&nbsp; we can type the following command in a console to obtain simple but informative output:"}]},{"block_type":"element","block":"k68ocnr8","search_text":"$ pytest test_simul.py::test_evolve platform linux -- Python 3.5.2, pytest-3.0.5, py-1.4.32, pluggy-0.4.0 rootdir: /home/gabriele/workspace/hiperf/chapter1, inifile: plugins: collected 2 items test_simul.py . =========================== 1 passed in 0.43 seconds =========================== ","text_count":290,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ pytest test_simul.py::test_evolve\n\nplatform linux -- Python 3.5.2, pytest-3.0.5, py-1.4.32, pluggy-0.4.0\nrootdir: /home/gabriele/workspace/hiperf/chapter1, inifile: plugins:\ncollected 2 items \n\ntest_simul.py .\n\n=========================== 1 passed in 0.43 seconds ==========================="}]}]},{"block_type":"element","block":"k68ocnr9","search_text":"Once we have a test in place, it is possible for you to execute your test as a benchmark using the pytest-benchmark plugin. If we change our test function so that it accepts an argument named benchmark , the pytest framework will automatically pass the benchmark resource as an argument (in pytest terminology, these resources are called fixtures ). The benchmark resource can be called by passing the function that we intend to benchmark as the first argument, followed by the additional arguments. In the following snippet, we illustrate the edits necessary to benchmark the ParticleSimulator.evolve function:","text_count":611,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once we have a test in place, it is possible for you to execute&nbsp;your test as a benchmark using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest-benchmark"}]},{"block_type":"text","content":"plugin. If we change our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test"}]},{"block_type":"text","content":"function so that it accepts an argument named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"benchmark"}]},{"block_type":"text","content":", the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest"}]},{"block_type":"text","content":"framework will automatically pass the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"benchmark"}]},{"block_type":"text","content":"resource as an argument (in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest"}]},{"block_type":"text","content":"terminology, these resources are called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"fixtures"}]},{"block_type":"text","content":"). The benchmark resource can be called by passing the function that we intend to benchmark as the first argument, followed by the additional arguments. In the following snippet, we illustrate the edits necessary to benchmark the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator.evolve"}]},{"block_type":"text","content":"&nbsp;function:"}]},{"block_type":"element","block":"k68ocnra","search_text":"from simul import Particle, ParticleSimulator def test_evolve(benchmark): # ... previous code benchmark(simulator.evolve, 0.1) ","text_count":127,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from simul import Particle, ParticleSimulator\n\n    def test_evolve(benchmark):\n        # ... previous code\n        benchmark(simulator.evolve, 0.1)"}]}]},{"block_type":"element","block":"k68ocnrb","search_text":"To run the benchmark, it is sufficient to rerun the pytest test_simul.py::test_evolve command. The resulting output will contain detailed timing information regarding the test_evolve function, as shown:","text_count":202,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To run the benchmark, it is sufficient to rerun the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest test_simul.py::test_evolve"}]},{"block_type":"text","content":"&nbsp;command. The resulting output will contain detailed timing information regarding the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_evolve"}]},{"block_type":"text","content":"function, as shown:"}]},{"block_type":"element","block":"k68ocnrc","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000001.png","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k68ocnrd","search_text":"For each test collected, pytest-benchmark will execute the benchmark function several times and provide a statistic summary of its running time. The output shown earlier is very interesting as it shows how running times vary between runs. In this example, the benchmark in test_evolve was run 34 times (column Rounds ), its timings ranged between 29 and 41 ms ( Min and Max ), and the Average and Median times were fairly similar at about 30 ms, which is actually very close to the best timing obtained. This example demonstrates how there can be substantial performance variability between runs, and that when taking timings with one-shot tools such as time , it is a good idea to run the program multiple times and record a representative value, such as the minimum or the median.","text_count":782,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For each test collected,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest-benchmark"}]},{"block_type":"text","content":"&nbsp;will execute the benchmark function several times and provide a statistic summary of its running time. The output shown earlier&nbsp;is very interesting as it shows how running times vary between runs."},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"text","content":"In this example, the benchmark in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_evolve"}]},{"block_type":"text","content":"was run"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"34"}]},{"block_type":"text","content":"times (column"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Rounds"}]},{"block_type":"text","content":"), its timings ranged between"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"29"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"41"}]},{"block_type":"text","content":"ms ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Min"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Max"}]},{"block_type":"text","content":"), and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Average"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Median"}]},{"block_type":"text","content":"times were fairly similar at about"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"30"}]},{"block_type":"text","content":"ms, which is actually very close to the best timing obtained. This example demonstrates how there can be substantial performance variability between runs, and that when taking timings with one-shot tools such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":", it is a good idea to run the program multiple times and record a representative value, such as the minimum or the median."}]},{"block_type":"element","block":"k68ocnre","search_text":"pytest-benchmark has many more features and options that can be used to take accurate timings and analyze the results. For more information, consult the documentation at http://pytest-benchmark.readthedocs.io/en/stable/usage.html .","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest-benchmark"}]},{"block_type":"text","content":"has many more features and options that can be used to take accurate timings and analyze the results. For more information, consult the documentation at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://pytest-benchmark.readthedocs.io/en/stable/usage.html"},"children":[{"block_type":"text","content":"http://pytest-benchmark.readthedocs.io/en/stable/usage.html"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnrf","search_text":"Finding bottlenecks with cProfile","text_count":33,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Finding bottlenecks with cProfile"}]},{"block_type":"element","block":"k68ocnrg","search_text":"After assessing the correctness and timing the execution time of the program, we are ready to identify the parts of the code that need to be tuned for performance. Those parts are typically quite small compared to the size of the program.","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"After assessing the correctness and timing the execution time of the program, we are ready to identify the parts of the code that need to be tuned for performance. Those parts are typically quite small compared to the size of the program."}]},{"block_type":"element","block":"k68ocnrh","search_text":"Two profiling modules are available through the Python standard library:","text_count":72,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Two&nbsp;profiling modules are available through the Python standard library:"}]},{"block_type":"element","block":"k68ocnri","search_text":"The profile module : This module is written in pure Python and adds a significant overhead to the program execution. Its presence in the standard library is because of its vast platform support and because it is easier to extend. The cProfile module : This is the main profiling module, with an interface equivalent to profile . It is written in C, has a small overhead, and is suitable as a general purpose profiler. ","text_count":418,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"The"}]},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"profile"}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"module"}]},{"block_type":"text","content":": This module is written in pure Python and adds a significant overhead to the program execution. Its presence in the standard library is because of its vast platform support&nbsp;and because it is easier to extend."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"The"}]},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"module"}]},{"block_type":"text","content":": This is the main profiling module, with an interface equivalent to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"profile"}]},{"block_type":"text","content":". It is written in C, has a small overhead, and is suitable as a general purpose profiler."}]}]},{"block_type":"element","block":"k68ocnrj","search_text":"The cProfile module can be used in three different ways:","text_count":56,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"module can be used in three&nbsp;different ways:"}]},{"block_type":"element","block":"k68ocnrk","search_text":"From the command line As a Python module With IPython ","text_count":54,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"From the command line"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"As a Python module"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"With&nbsp;IPython"}]}]},{"block_type":"element","block":"k68ocnrl","search_text":"cProfile does not require any change in the source code and can be executed directly on an existing Python script or function. You can use cProfile from the command line in this way:","text_count":182,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"&nbsp;does not require any change in the source code and can be executed directly on an existing Python script or function.&nbsp;You can use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"from the command line in this way:"}]},{"block_type":"element","block":"k68ocnrm","search_text":"$ python -m cProfile simul.py ","text_count":30,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ python -m cProfile simul.py"}]}]},{"block_type":"element","block":"k68ocnrn","search_text":"This will print a long output containing several profiling metrics of all of the functions called in the application. You can use the -s option to sort the output by a specific metric. In the following snippet ,the output is sorted by the tottime metric, which will be described here:","text_count":284,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This will print a long output containing several profiling metrics of&nbsp;all of the functions called in the application. You can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-s"}]},{"block_type":"text","content":"option to sort the output by a specific metric. In the following snippet ,the output is sorted by the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tottime"}]},{"block_type":"text","content":"&nbsp;metric, which will be described here:"}]},{"block_type":"element","block":"k68ocnro","search_text":"$ python -m cProfile -s tottime simul.py ","text_count":41,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ python -m cProfile"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"-s tottime"}]},{"block_type":"text","content":"simul.py"}]}]},{"block_type":"element","block":"k68ocnrp","search_text":"The data produced by cProfile can be saved in an output file by passing the -o option. The format that cProfile uses is readable by the stats module and other tools. The usage of the -o option is as follows:","text_count":207,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The data produced by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"can be saved in an&nbsp;output file by passing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-o"}]},{"block_type":"text","content":"option. The format that"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"uses is readable by the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"stats"}]},{"block_type":"text","content":"module and other tools. The usage of the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-o"}]},{"block_type":"text","content":"option is as follows:"}]},{"block_type":"element","block":"k68ocnrq","search_text":"$ python -m cProfile -o prof.out simul.py ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ python -m cProfile"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"-o prof.out"}]},{"block_type":"text","content":"simul.py"}]}]},{"block_type":"element","block":"k68ocnrr","search_text":"The usage of cProfile as a Python module requires invoking the cProfile.run function in the following way:","text_count":106,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The usage of cProfile as a Python module requires invoking the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile.run"}]},{"block_type":"text","content":"&nbsp;function in the following way:"}]},{"block_type":"element","block":"k68ocnrs","search_text":"from simul import benchmark import cProfile cProfile.run(\"benchmark()\") ","text_count":72,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from simul import benchmark\n    import cProfile\n\n    cProfile.run(\"benchmark()\")"}]}]},{"block_type":"element","block":"k68ocnrt","search_text":"You can also wrap a section of code between method calls of a cProfile.Profile object, as shown:","text_count":96,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can also wrap a section of code between method calls of a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile.Profile"}]},{"block_type":"text","content":"object, as shown:"}]},{"block_type":"element","block":"k68ocnru","search_text":"from simul import benchmark import cProfile pr = cProfile.Profile() pr.enable() benchmark() pr.disable() pr.print_stats() ","text_count":122,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from simul import benchmark\n    import cProfile\n\n    pr = cProfile.Profile()\n    pr.enable()\n    benchmark()\n    pr.disable()\n    pr.print_stats()"}]}]},{"block_type":"element","block":"k68ocnrv","search_text":"cProfile can also be used interactively with IPython. The %prun magic command lets you profile an individual function call, as illustrated:","text_count":139,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"&nbsp;can also be used&nbsp;interactively with IPython. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%prun"}]},{"block_type":"text","content":"magic command lets you profile an individual function call, as&nbsp;illustrated:"}]},{"block_type":"element","block":"k68ocnrw","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000028.png","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k68ocnrx","search_text":"The cProfile output is divided into five columns:","text_count":49,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"output is divided into five columns:"}]},{"block_type":"element","block":"k68ocnry","search_text":"ncalls : The number of times the function was called. tottime : The total time spent in the function without taking into account the calls to other functions. cumtime : The time in the function including other function calls. percall : The time spent for a single call of the function--it can be obtained by dividing the total or cumulative time by the number of calls. filename:lineno : The filename and corresponding line numbers. This information is not available when calling C extensions modules. ","text_count":502,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ncalls"}]},{"block_type":"text","content":": The number of times the function was called."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tottime"}]},{"block_type":"text","content":": The total time spent in the function without taking into account the calls to other functions."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cumtime"}]},{"block_type":"text","content":": The time in the function including other function calls."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"percall"}]},{"block_type":"text","content":": The time spent for a single call of the function--it can be obtained by dividing the total or cumulative time by the number of calls."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"filename:lineno"}]},{"block_type":"text","content":": The filename and corresponding line numbers. This information is not available&nbsp;when calling C extensions modules."}]}]},{"block_type":"element","block":"k68ocnrz","search_text":"The most important metric is tottime , the actual time spent in the function body excluding subcalls, which tell us exactly where the bottleneck is.","text_count":148,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most important metric is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tottime"}]},{"block_type":"text","content":", the actual time spent in the function body excluding subcalls, which tell us exactly where the bottleneck is."}]},{"block_type":"element","block":"k68ocns0","search_text":"Unsurprisingly, the largest portion of time is spent in the evolve function. We can imagine that the loop is the section of the code that needs performance tuning. cProfile only provides information at the function level and does not tell us which specific statements are responsible for the bottleneck. Fortunately, as we will see in the next section, the line_profiler tool is capable of providing line-by-line information of the time spent in the function.","text_count":459,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Unsurprisingly, the largest portion of time is spent in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"evolve"}]},{"block_type":"text","content":"function. We can imagine that the loop is the section of the code that needs&nbsp;performance tuning."},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"only provides information at the function level and does not tell us which specific statements&nbsp;are responsible for the bottleneck. Fortunately, as we will see in the next section, the &nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":"&nbsp;tool is capable of providing line-by-line information of the time spent in the function."}]},{"block_type":"element","block":"k68ocns1","search_text":"Analyzing the cProfile text output can be daunting for big programs with a lot of calls and subcalls. Some visual tools aid the task by improving navigation with an interactive, graphical interface.","text_count":198,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Analyzing the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"&nbsp;text output can be daunting for big programs with a lot of calls and subcalls. Some visual&nbsp;tools aid the task by improving navigation with an interactive, graphical interface."}]},{"block_type":"element","block":"k68ocns2","search_text":"KCachegrind is a Graphical User Interface (GUI) useful to analyze the profiling output emitted by cProfile .","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"KCachegrind is a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Graphical User Interface (GUI)"}]},{"block_type":"text","content":"&nbsp;useful to analyze the profiling output emitted by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocns3","search_text":"Note KCachegrind is available in the Ubuntu 16.04 official repositories. The Qt port, QCacheGrind, can be downloaded for Windows from http://sourceforge.net/projects/qcachegrindwin/ . Mac users can compile QCacheGrind using Mac Ports ( http://www.macports.org/ ) by following the instructions present in the blog post at http://blogs.perl.org/users/rurban/2013/04/install-kachegrind-on-macosx-with-ports.html . ","text_count":411,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"KCachegrind is available in the Ubuntu 16.04 official repositories. The Qt port, QCacheGrind, can be downloaded for Windows from"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://sourceforge.net/projects/qcachegrindwin/"},"children":[{"block_type":"text","content":"http://sourceforge.net/projects/qcachegrindwin/"}]},{"block_type":"text","content":".&nbsp;Mac users can compile QCacheGrind using Mac Ports ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.macports.org/"},"children":[{"block_type":"text","content":"http://www.macports.org/"}]},{"block_type":"text","content":") by following the instructions present in the blog post at&nbsp;"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://blogs.perl.org/users/rurban/2013/04/install-kachegrind-on-macosx-with-ports.html"},"children":[{"block_type":"text","content":"http://blogs.perl.org/users/rurban/2013/04/install-kachegrind-on-macosx-with-ports.html"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68ocns4","search_text":"KCachegrind can't directly read the output files produced by cProfile . Luckily, the pyprof2calltree third-party Python module is able to convert the cProfile output file into a format readable by KCachegrind.","text_count":209,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"KCachegrind can't directly read the output files produced by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":". Luckily, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyprof2calltree"}]},{"block_type":"text","content":"third-party Python module is able to convert the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"output file into a format readable by KCachegrind."}]},{"block_type":"element","block":"k68ocns5","search_text":"Note You can install pyprof2calltree from the Python Package Index using the command pip install pyprof2calltree . ","text_count":115,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can install"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyprof2calltree"}]},{"block_type":"text","content":"&nbsp;from the Python Package Index&nbsp;using the command"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip install pyprof2calltree"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68ocns6","search_text":"To best show the KCachegrind features, we will use another example with a more diversified structure. We define a recursive function, factorial , and two other functions that use factorial , named taylor_exp and taylor_sin . They represent the polynomial coefficients of the Taylor approximations of exp(x) and sin(x) :","text_count":319,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To best show the KCachegrind features, we will use another example with a more diversified structure. We define a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"recursive"}]},{"block_type":"text","content":"function,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"factorial"}]},{"block_type":"text","content":", and two other functions that use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"factorial"}]},{"block_type":"text","content":", named&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"taylor_exp"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"taylor_sin"}]},{"block_type":"text","content":". They represent the polynomial coefficients of the Taylor approximations of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"exp(x)"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sin(x)"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocns7","search_text":"def factorial(n): if n == 0: return 1.0 else: return n * factorial(n-1) def taylor_exp(n): return [1.0/factorial(i) for i in range(n)] def taylor_sin(n): res = [] for i in range(n): if i % 2 == 1: res.append((-1)**((i-1)/2)/float(factorial(i))) else: res.append(0.0) return res def benchmark(): taylor_exp(500) taylor_sin(500) if __name__ == '__main__': benchmark() ","text_count":366,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def factorial(n): \n        if n == 0: \n            return 1.0 \n        else: \n            return n * factorial(n-1) \n\n    def taylor_exp(n): \n        return [1.0/factorial(i) for i in range(n)] \n\n    def taylor_sin(n): \n        res = [] \n        for i in range(n): \n            if i % 2 == 1: \n               res.append((-1)**((i-1)/2)/float(factorial(i))) \n            else: \n               res.append(0.0) \n        return res \n\n    def benchmark(): \n        taylor_exp(500) \n        taylor_sin(500) \n\n    if __name__ == '__main__': \n        benchmark()"}]}]},{"block_type":"element","block":"k68ocns8","search_text":"To access profile information, we first need to generate the cProfile output file:","text_count":82,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To access profile information, we first need to generate the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"output file:"}]},{"block_type":"element","block":"k68ocns9","search_text":"$ python -m cProfile -o prof.out taylor.py ","text_count":43,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ python -m cProfile -o prof.out taylor.py"}]}]},{"block_type":"element","block":"k68ocnsa","search_text":"Then, we can convert the output file with pyprof2calltree and launch KCachegrind:","text_count":81,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can convert the output file with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyprof2calltree"}]},{"block_type":"text","content":"and launch KCachegrind:"}]},{"block_type":"element","block":"k68ocnsb","search_text":"$ pyprof2calltree -i prof.out -o prof.calltree $ kcachegrind prof.calltree # or qcachegrind prof.calltree ","text_count":106,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ pyprof2calltree -i prof.out -o prof.calltree\n$ kcachegrind prof.calltree # or qcachegrind prof.calltree"}]}]},{"block_type":"element","block":"k68ocnsc","search_text":"The output is shown in the following screenshot:","text_count":48,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The output is shown in the following screenshot:"}]},{"block_type":"element","block":"k68ocnsd","search_text":"","text_count":0,"tag_name":"p","attributes":{},"children":[]},{"block_type":"element","block":"k68ocnse","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000025.png","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k68ocnsf","search_text":"The preceding screenshot shows the KCachegrind user interface. On the left, we have an output fairly similar to cProfile . The actual column names are slightly different: Incl. translates to cProfile module's cumtime and Self translates to tottime . The values are given in percentages by clicking on the Relative button on the menu bar. By clicking on the column headers, you can sort them by the corresponding property.","text_count":421,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding screenshot shows&nbsp;the KCachegrind user interface. On the left, we have an output fairly similar to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":". The actual column names are slightly different: Incl. translates to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"module's"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cumtime"}]},{"block_type":"text","content":"&nbsp;and&nbsp;Self translates to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tottime"}]},{"block_type":"text","content":". The values are given in percentages by clicking on the Relative button on the menu bar.&nbsp;By clicking on the column headers, you can sort them by the corresponding property."}]},{"block_type":"element","block":"k68ocnsg","search_text":"On the top right, a click on the Callee Map tab will display a diagram of the function costs. In the diagram, the time percentage spent by the function is proportional to the area of the rectangle. Rectangles can contain sub-rectangles that represent subcalls to other functions. In this case, we can easily see that there are two rectangles for the factorial function. The one on the left corresponds to the calls made by taylor_exp and the one on the right to the calls made by taylor_sin .","text_count":492,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the top right, a click on the Callee Map tab will display a diagram of the function costs. In the diagram, the time percentage spent by the function is proportional to the area of the rectangle. Rectangles can contain sub-rectangles that represent subcalls to other functions. In this case, we can easily see that there are two rectangles for the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"factorial"}]},{"block_type":"text","content":"function. The one on the left corresponds to the calls made by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"taylor_exp"}]},{"block_type":"text","content":"and the one on the right to the calls made by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"taylor_sin"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnsh","search_text":"On the bottom right, you can display another diagram, the call graph , by clicking on the Call Graph tab. A call graph is a graphical representation of the calling relationship between the functions; each square represents a function and the arrows imply a calling relationship. For example, taylor_exp calls factorial 500 times, and taylor_sin calls factorial 250 times. KCachegrind also detects recursive calls: factorial calls itself 187250 times.","text_count":450,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the bottom right, you can display another diagram, the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"call graph"}]},{"block_type":"text","content":",&nbsp;by clicking on the Call Graph tab. A call graph is a graphical representation of the calling relationship between the functions; each square represents a function and the arrows imply a calling relationship. For example,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"taylor_exp"}]},{"block_type":"text","content":"calls"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"factorial"}]},{"block_type":"text","content":"&nbsp;500 times, and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"taylor_sin"}]},{"block_type":"text","content":"calls&nbsp;factorial 250 times. KCachegrind also detects recursive calls:"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"factorial"}]},{"block_type":"text","content":"calls itself 187250 times."}]},{"block_type":"element","block":"k68ocnsi","search_text":"You can navigate to the Call Graph or the Caller Map tab by double-clicking on the rectangles; the interface will update accordingly, showing that the timing properties are relative to the selected function. For example, double-clicking on taylor_exp will cause the graph to change, showing only the contribution of taylor_exp to the total cost.","text_count":345,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can navigate to the Call Graph or the Caller Map tab by double-clicking on the rectangles; the interface will update accordingly, showing that the timing properties are relative to the selected function. For example, double-clicking on"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"taylor_exp"}]},{"block_type":"text","content":"will cause the graph to change, showing only the contribution of&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"taylor_exp"}]},{"block_type":"text","content":"&nbsp;to the total cost."}]},{"block_type":"element","block":"k68ocnsj","search_text":"Note Gprof2Dot ( https://github.com/jrfonseca/gprof2dot ) is another popular tool used to produce call graphs. Starting from output files produced by one of the supported profilers, it will generate a .dot diagram representing the call graph. ","text_count":243,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Gprof2Dot"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/jrfonseca/gprof2dot"},"children":[{"block_type":"text","content":"https://github.com/jrfonseca/gprof2dot"}]},{"block_type":"text","content":") is another popular tool used to produce call graphs. Starting from output files produced by one of the supported profilers, it will generate a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".dot"}]},{"block_type":"text","content":"diagram representing the call graph."}]}]},{"block_type":"element","block":"k68ocnsk","search_text":"Profile line by line with line_profiler","text_count":39,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Profile line by line with line_profiler"}]},{"block_type":"element","block":"k68ocnsl","search_text":"Now that we know which function we have to optimize, we can use the line_profiler module that provides information on how time is spent in a line-by-line fashion. This is very useful in situations where it's difficult to determine which statements are costly. The line_profiler module is a third-party module that is available on the Python Package Index and can be installed by following the instructions at https://github.com/rkern/line_profiler .","text_count":449,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we know which function we have to optimize, we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":"module&nbsp;that provides information on how time is spent in a line-by-line fashion. This is very useful in situations where it's difficult to determine which statements are costly. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":"module is a third-party module that is available on the Python Package Index and can be installed by following the instructions at&nbsp;"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/rkern/line_profiler"},"children":[{"block_type":"text","content":"https://github.com/rkern/line_profiler"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnsm","search_text":"In order to use line_profiler , we need to apply a @profile decorator to the functions we intend to monitor. Note that you don't have to import the profile function from another module as it gets injected in the global namespace when running the kernprof.py profiling script. To produce profiling output for our program, we need to add the @profile decorator to the evolve function:","text_count":382,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In order to use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":",&nbsp;we need to apply a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"@profile"}]},{"block_type":"text","content":"decorator to the functions we intend to monitor. Note that you don't have to import the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"profile"}]},{"block_type":"text","content":"function from another module as it gets injected in the global namespace when running the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"kernprof.py"}]},{"block_type":"text","content":"&nbsp;profiling script. To produce profiling output for our program, we need to add the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"@profile"}]},{"block_type":"text","content":"decorator to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"evolve"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k68ocnsn","search_text":"@profile def evolve(self, dt): # code ","text_count":38,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@profile \n    def evolve(self, dt): \n        # code"}]}]},{"block_type":"element","block":"k68ocnso","search_text":"The kernprof.py script will produce an output file and will print the result of the profiling on the standard output. We should run the script with two options:","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"kernprof.py"}]},{"block_type":"text","content":"script will produce an output file and will print the result of the profiling on the standard output. We should run the script with&nbsp;two options:"}]},{"block_type":"element","block":"k68ocnsp","search_text":"-l to use the line_profiler function -v to immediately print the results on screen ","text_count":83,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-l"}]},{"block_type":"text","content":"to use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":"function"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-v"}]},{"block_type":"text","content":"to immediately print the results on screen"}]}]},{"block_type":"element","block":"k68ocnsq","search_text":"The usage of kernprof.py is illustrated in the following line of code:","text_count":70,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The usage of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"kernprof.py"}]},{"block_type":"text","content":"is illustrated in the following line of code:"}]},{"block_type":"element","block":"k68ocnsr","search_text":"$ kernprof.py -l -v simul.py ","text_count":29,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ kernprof.py -l -v simul.py"}]}]},{"block_type":"element","block":"k68ocnss","search_text":"It is also possible to run the profiler in an IPython shell for interactive editing. You should first load the line_profiler extension that will provide the lprun magic command. Using that command, you can avoid adding the @profile decorator:","text_count":242,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is also possible to run the profiler in an IPython shell for interactive editing. You should first load the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":"extension that will provide the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"lprun"}]},{"block_type":"text","content":"&nbsp;magic command. Using that command, you can avoid adding the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"@profile"}]},{"block_type":"text","content":"decorator:"}]},{"block_type":"element","block":"k68ocnst","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000013.png","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k68ocnsu","search_text":"The output is quite intuitive and is divided into six columns:","text_count":62,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The output is quite intuitive and is divided into six columns:"}]},{"block_type":"element","block":"k68ocnsv","search_text":"Line # : The number of the line that was run Hits : The number of times that line was run Time : The execution time of the line in microseconds ( Time ) Per Hit : Time/hits % Time : Fraction of the total time spent executing that line Line Contents : The content of the line ","text_count":275,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Line #"}]},{"block_type":"text","content":": The number of the line that was run"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Hits"}]},{"block_type":"text","content":": The number of times that line was run"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Time"}]},{"block_type":"text","content":": The execution time of the line in microseconds ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Time"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Per Hit"}]},{"block_type":"text","content":": Time/hits"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"% Time"}]},{"block_type":"text","content":": Fraction of the total time spent executing that line"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Line Contents"}]},{"block_type":"text","content":": The content of the line"}]}]},{"block_type":"element","block":"k68ocnsw","search_text":"By looking at the percentage column, we can get a pretty good idea of where the time is spent. In this case, there are a few statements in the for loop body with a cost of around 10-20 percent each.","text_count":198,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By looking at the percentage column, we can get a pretty good idea of where the time is spent. In this case, there are a few statements in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"for"}]},{"block_type":"text","content":"loop body with a cost of around 10-20 percent each."}]},{"block_type":"element","block":"k68ocnsx","search_text":"Optimizing our code","text_count":19,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Optimizing our code"}]},{"block_type":"element","block":"k68ocnsy","search_text":"Now that we have identified where exactly our application is spending most of its time, we can make some changes and assess the change in performance.","text_count":150,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have identified where exactly our application is spending most of its time, we can make&nbsp;some changes and assess the change in performance."}]},{"block_type":"element","block":"k68ocnsz","search_text":"There are different ways to tune up our pure Python code. The way that produces the most remarkable results is to improve the algorithms used. In this case, instead of calculating the velocity and adding small steps, it will be more efficient (and correct as it is not an approximation) to express the equations of motion in terms of radius, r , and angle, alpha , (instead of x and y ), and then calculate the points on a circle using the following equation:","text_count":459,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are different ways to tune up our pure Python code. The way that produces the most remarkable results is to improve the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"algorithms"}]},{"block_type":"text","content":"used. In this case, instead of calculating the velocity and adding small steps, it will be more efficient (and correct as it is not an approximation) to express the equations of motion in terms of radius,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"r"}]},{"block_type":"text","content":", and angle,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"alpha"}]},{"block_type":"text","content":", (instead of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"), and then calculate the points on a circle using the following equation:"}]},{"block_type":"element","block":"k68ocnt0","search_text":"x = r * cos(alpha) y = r * sin(alpha) ","text_count":38,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"x = r * cos(alpha) \n    y = r * sin(alpha)"}]}]},{"block_type":"element","block":"k68ocnt1","search_text":"Another way lies in minimizing the number of instructions. For example, we can precalculate the timestep * p.ang_vel factor that doesn't change with time. We can exchange the loop order (first we iterate on particles, then we iterate on time steps) and put the calculation of the factor outside the loop on the particles.","text_count":321,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another way lies in minimizing the number of instructions. For example, we can precalculate the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timestep * p.ang_vel"}]},{"block_type":"text","content":"factor that doesn't change with time. We can exchange the loop order (first we iterate on particles, then we iterate on time steps) and put the calculation of the factor outside the loop on the particles."}]},{"block_type":"element","block":"k68ocnt2","search_text":"The line-by-line profiling also showed that even simple assignment operations can take a considerable amount of time. For example, the following statement takes more than 10 percent of the total time:","text_count":200,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The line-by-line profiling also showed that even simple assignment operations can take a considerable amount of time. For example, the following statement takes more than 10&nbsp;percent of the total time:"}]},{"block_type":"element","block":"k68ocnt3","search_text":"v_x = (-p.y)/norm ","text_count":18,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"v_x = (-p.y)/norm"}]}]},{"block_type":"element","block":"k68ocnt4","search_text":"We can improve the performance of the loop by reducing the number of assignment operations performed. To do that, we can avoid intermediate variables by rewriting the expression into a single, slightly more complex statement (note that the right-hand side gets evaluated completely before being assigned to the variables):","text_count":322,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can improve the performance of the loop by reducing&nbsp;the number of assignment operations performed. To do that, we can avoid intermediate variables by rewriting the expression into a single, slightly more complex statement (note that the right-hand side gets evaluated completely before being assigned to the variables):"}]},{"block_type":"element","block":"k68ocnt5","search_text":"p.x, p.y = p.x - t_x_ang*p.y/norm, p.y + t_x_ang * p.x/norm ","text_count":60,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"p.x, p.y = p.x - t_x_ang*p.y/norm, p.y + t_x_ang * p.x/norm"}]}]},{"block_type":"element","block":"k68ocnt6","search_text":"This leads to the following code:","text_count":33,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This leads to the following code:"}]},{"block_type":"element","block":"k68ocnt7","search_text":"def evolve_fast(self, dt): timestep = 0.00001 nsteps = int(dt/timestep) # Loop order is changed for p in self.particles: t_x_ang = timestep * p.ang_vel for i in range(nsteps): norm = (p.x**2 + p.y**2)**0.5 p.x, p.y = (p.x - t_x_ang * p.y/norm, p.y + t_x_ang * p.x/norm) ","text_count":270,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def evolve_fast(self, dt): \n            timestep = 0.00001 \n            nsteps = int(dt/timestep) \n\n            # Loop order is changed \n            for p in self.particles: \n                t_x_ang = timestep * p.ang_vel \n                for i in range(nsteps): \n                    norm = (p.x**2 + p.y**2)**0.5 \n                    p.x, p.y = (p.x - t_x_ang * p.y/norm,\n                                p.y + t_x_ang * p.x/norm)"}]}]},{"block_type":"element","block":"k68ocnt8","search_text":"After applying the changes, we should verify that the result is still the same by running our test. We can then compare the execution times using our benchmark:","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"After applying the changes, we should verify that the result is still the same by running our test. We can then compare the execution times using our benchmark:"}]},{"block_type":"element","block":"k68ocnt9","search_text":"$ time python simul.py # Performance Tuned real 0m0.756s user 0m0.714s sys 0m0.036s $ time python simul.py # Original real 0m0.863s user 0m0.831s sys 0m0.028s ","text_count":159,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ time python simul.py # Performance Tuned\nreal    0m0.756s\nuser    0m0.714s\nsys    0m0.036s\n\n$ time python simul.py # Original\nreal    0m0.863s\nuser    0m0.831s\nsys    0m0.028s"}]}]},{"block_type":"element","block":"k68ocnta","search_text":"As you can see, we obtained only a modest increment in speed by making a pure Python micro-optimization.","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, we obtained only a modest increment in speed by making a pure Python micro-optimization."}]},{"block_type":"element","block":"k68ocntb","search_text":"The dis module","text_count":14,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"The dis module"}]},{"block_type":"element","block":"k68ocntc","search_text":"Sometimes it's not easy to estimate how many operations a Python statement will take. In this section, we will dig into the Python internals to estimate the performance of individual statements. In the CPython interpreter, Python code is first converted to an intermediate representation, the bytecode , and then executed by the Python interpreter.","text_count":348,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sometimes it's not easy to estimate how many operations a Python statement will take. In this section, we will dig into the&nbsp;Python internals to estimate the performance of individual statements. In the CPython interpreter, Python code is first converted to an intermediate representation, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"bytecode"}]},{"block_type":"text","content":", and then executed by the Python interpreter."}]},{"block_type":"element","block":"k68ocntd","search_text":"To inspect how the code is converted to bytecode, we can use the dis Python module ( dis stands for disassemble). Its usage is really simple; all that is needed is to call the dis.dis function on the ParticleSimulator.evolve method:","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To inspect how the code is converted to bytecode, we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dis"}]},{"block_type":"text","content":"Python module ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dis"}]},{"block_type":"text","content":"stands for disassemble). Its usage is really simple; all that is needed is to call the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dis.dis"}]},{"block_type":"text","content":"function on the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator.evolve"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k68ocnte","search_text":"import dis from simul import ParticleSimulator dis.dis(ParticleSimulator.evolve) ","text_count":81,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import dis \n    from simul import ParticleSimulator \n    dis.dis(ParticleSimulator.evolve)"}]}]},{"block_type":"element","block":"k68ocntf","search_text":"This will print, for each line in the function, a list of bytecode instructions. For example, the v_x = (-p.y)/norm statement is expanded in the following set of instructions:","text_count":175,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This will print, for each line in the function, a list of bytecode instructions. For example, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"v_x = (-p.y)/norm"}]},{"block_type":"text","content":"statement is expanded in the following set of instructions:"}]},{"block_type":"element","block":"k68ocntg","search_text":"29 85 LOAD_FAST 5 (p) 88 LOAD_ATTR 4 (y) 91 UNARY_NEGATIVE 92 LOAD_FAST 6 (norm) 95 BINARY_TRUE_DIVIDE 96 STORE_FAST 7 (v_x) ","text_count":125,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"29           85 LOAD_FAST                5 (p) \n                 88 LOAD_ATTR                4 (y) \n                 91 UNARY_NEGATIVE        \n                 92 LOAD_FAST                6 (norm) \n                 95 BINARY_TRUE_DIVIDE    \n                 96 STORE_FAST               7 (v_x)"}]}]},{"block_type":"element","block":"k68ocnth","search_text":"LOAD_FAST loads a reference of the p variable onto the stack and LOAD_ATTR loads the y attribute of the item present on top of the stack. The other instructions, UNARY_NEGATIVE and BINARY_TRUE_DIVIDE , simply do arithmetic operations on top-of-stack items. Finally, the result is stored in v_x ( STORE_FAST ).","text_count":309,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LOAD_FAST"}]},{"block_type":"text","content":"loads a reference of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"p"}]},{"block_type":"text","content":"variable onto the stack and&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LOAD_ATTR"}]},{"block_type":"text","content":"loads the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"attribute of the item present on top of the stack. The other instructions,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"UNARY_NEGATIVE"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"BINARY_TRUE_DIVIDE"}]},{"block_type":"text","content":",&nbsp;simply do arithmetic operations on top-of-stack items. Finally, the result is stored in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"v_x"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"STORE_FAST"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k68ocnti","search_text":"By analyzing the dis output, we can see that the first version of the loop produces 51 bytecode instructions while the second gets converted into 35 instructions.","text_count":162,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By analyzing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dis"}]},{"block_type":"text","content":"output, we can see that the first version of the loop produces"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"51"}]},{"block_type":"text","content":"bytecode instructions while the second gets converted into&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"35"}]},{"block_type":"text","content":"instructions."}]},{"block_type":"element","block":"k68ocntj","search_text":"The dis module helps discover how the statements get converted and serves mainly as an exploration and learning tool of the Python bytecode representation.","text_count":155,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dis"}]},{"block_type":"text","content":"module helps discover how the statements get converted and serves mainly as an exploration and learning tool of the Python bytecode representation."}]},{"block_type":"element","block":"k68ocntk","search_text":"To improve our performance even further, we can keep trying to figure out other approaches to reduce the amount of instructions. It's clear, however, that this approach is ultimately limited by the speed of the Python interpreter and it is probably not the right tool for the job. In the following chapters, we will see how to speed up interpreter-limited calculations by executing fast specialized versions written in a lower level language (such as C or Fortran).","text_count":465,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To improve our performance even further, we can keep trying to figure out other approaches to reduce the amount of instructions. It's clear, however, that this approach is ultimately limited by the speed of the Python interpreter and it is probably not the right tool for the job. In the following chapters, we will see how to speed up interpreter-limited&nbsp;calculations by executing fast specialized versions written in a lower level language (such as C or Fortran)."}]},{"block_type":"element","block":"k68ocntl","search_text":"Profiling memory usage with memory_profiler","text_count":43,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Profiling memory usage with memory_profiler"}]},{"block_type":"element","block":"k68ocntm","search_text":"In some cases, high memory usage constitutes an issue. For example, if we want to handle a huge number of particles, we will incur a memory overhead due to the creation of many Particle instances.","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In some cases, high memory usage constitutes an issue. For example, if we want to handle a huge number of particles, we will incur a memory overhead due to the creation of many"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Particle"}]},{"block_type":"text","content":"instances."}]},{"block_type":"element","block":"k68ocntn","search_text":"The memory_profiler module summarizes, in a way similar to line_profiler , the memory usage of the process.","text_count":107,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"memory_profiler"}]},{"block_type":"text","content":"module summarizes, in a way similar to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":", the memory usage of the process."}]},{"block_type":"element","block":"k68ocnto","search_text":"Note The memory_profiler package is also available on the Python Package Index. You should also install the psutil module ( https://github.com/giampaolo/psutil ) as an optional dependency that will make memory_profiler considerably faster. ","text_count":240,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"memory_profiler"}]},{"block_type":"text","content":"package is also available on the Python Package Index. You should also install the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"psutil"}]},{"block_type":"text","content":"module ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/giampaolo/psutil"},"children":[{"block_type":"text","content":"https://github.com/giampaolo/psutil"}]},{"block_type":"text","content":") as an optional dependency that&nbsp;will make"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"memory_profiler"}]},{"block_type":"text","content":"&nbsp;considerably faster."}]}]},{"block_type":"element","block":"k68ocntp","search_text":"Just like line_profiler , memory_profiler also requires the instrumentation of the source code by placing a @profile decorator on the function we intend to monitor. In our case, we want to analyze the benchmark function.","text_count":220,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Just like"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"memory_profiler"}]},{"block_type":"text","content":"also requires the instrumentation of the source code by placing&nbsp;a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"@profile"}]},{"block_type":"text","content":"decorator on the function we intend to monitor. In our case, we want to analyze the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"benchmark"}]},{"block_type":"text","content":"&nbsp;function."}]},{"block_type":"element","block":"k68ocntq","search_text":"We can slightly change benchmark to instantiate a considerable amount ( 100000 ) of Particle instances and decrease the simulation time:","text_count":136,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can slightly change"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"benchmark"}]},{"block_type":"text","content":"to instantiate a considerable amount ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"100000"}]},{"block_type":"text","content":") of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Particle"}]},{"block_type":"text","content":"instances and decrease the simulation time:"}]},{"block_type":"element","block":"k68ocntr","search_text":"def benchmark_memory(): particles = [Particle(uniform(-1.0, 1.0), uniform(-1.0, 1.0), uniform(-1.0, 1.0)) for i in range(100000)] simulator = ParticleSimulator(particles) simulator.evolve(0.001) ","text_count":195,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def benchmark_memory(): \n        particles = [Particle(uniform(-1.0, 1.0), \n                              uniform(-1.0, 1.0), \n                              uniform(-1.0, 1.0)) \n                      for i in range(100000)] \n\n        simulator = ParticleSimulator(particles) \n        simulator.evolve(0.001)"}]}]},{"block_type":"element","block":"k68ocnts","search_text":"We can use memory_profiler from an IPython shell through the %mprun magic command as shown in the following screenshot:","text_count":119,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"memory_profiler"}]},{"block_type":"text","content":"from an IPython shell through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%mprun"}]},{"block_type":"text","content":"&nbsp;magic command as shown in the following screenshot:"}]},{"block_type":"element","block":"k68ocntt","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000002.png","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k68ocntu","search_text":"Tip It is possible to run memory_profiler from the shell using the mprof run command after adding the @profile decorator. ","text_count":122,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is possible to run&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"memory_profiler"}]},{"block_type":"text","content":"from the shell using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mprof run"}]},{"block_type":"text","content":"command after adding the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"@profile"}]},{"block_type":"text","content":"decorator."}]}]},{"block_type":"element","block":"k68ocntv","search_text":"From the Increment column, we can see that 100,000 Particle objects take 23.7 MiB of memory.","text_count":92,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Increment"}]},{"block_type":"text","content":"column, we can see that 100,000"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Particle"}]},{"block_type":"text","content":"objects take"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"23.7 MiB"}]},{"block_type":"text","content":"of memory."}]},{"block_type":"element","block":"k68ocntw","search_text":"Note 1 MiB (mebibyte) is equivalent to 1,048,576 bytes. It is different from 1 MB ( megabyte ), which is equivalent to 1,000,000 bytes. ","text_count":136,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"1 MiB (mebibyte) is equivalent to&nbsp; 1,048,576 bytes. It is different from 1 MB ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"megabyte"}]},{"block_type":"text","content":"), which is equivalent to 1,000,000 bytes."}]}]},{"block_type":"element","block":"k68ocntx","search_text":"We can use __slots__ on the Particle class to reduce its memory footprint. This feature saves some memory by avoiding storing the variables of the instance in an internal dictionary. This strategy, however, has a drawback--it prevents the addition of attributes other than the ones specified in __slots__ :","text_count":306,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"__slots__"}]},{"block_type":"text","content":"on the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Particle"}]},{"block_type":"text","content":"class to reduce its memory footprint. This feature saves some memory by avoiding storing the variables of the instance in an internal dictionary. This strategy, however,&nbsp;has a drawback--it prevents the addition of attributes other than the ones specified in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"__slots__"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocnty","search_text":"class Particle: __slots__ = ('x', 'y', 'ang_vel') def __init__(self, x, y, ang_vel): self.x = x self.y = y self.ang_vel = ang_vel ","text_count":130,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class Particle:\n        __slots__ = ('x', 'y', 'ang_vel') \n\n        def __init__(self, x, y, ang_vel): \n            self.x = x \n            self.y = y \n            self.ang_vel = ang_vel"}]}]},{"block_type":"element","block":"k68ocntz","search_text":"We can now rerun our benchmark to assess the change in memory consumption, the result is displayed in the following screenshot:","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now rerun our benchmark to assess the change in memory consumption, the result is displayed in the following screenshot:"}]},{"block_type":"element","block":"k68ocnu0","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000032.png","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k68ocnu1","search_text":"By rewriting the Particle class using __slots__ , we can save about 10 MiB of memory.","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By rewriting the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Particle"}]},{"block_type":"text","content":"class using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"__slots__"}]},{"block_type":"text","content":", we can save about"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"10 MiB"}]},{"block_type":"text","content":"of memory."}]},{"block_type":"element","block":"k68ocnu2","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k68ocnu3","search_text":"In this chapter, we introduced the basic principles of optimization and applied those principles to a test application. When optimizing, the first thing to do is test and identify the bottlenecks in the application. We saw how to write and time a benchmark using the time Unix command, the Python timeit module, and the full-fledged pytest-benchmark package. We learned how to profile our application using cProfile , line_profiler , and memory_profiler , and how to analyze and navigate the profiling data graphically with KCachegrind.","text_count":536,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we introduced the basic principles of optimization and applied those principles to a&nbsp;test application. When optimizing, the first thing to do is test and identify the bottlenecks in the application. We saw how to write and time a benchmark using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time"}]},{"block_type":"text","content":"Unix command, the Python"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"module, and the full-fledged"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest-benchmark"}]},{"block_type":"text","content":"package. We learned how to profile our application using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"memory_profiler"}]},{"block_type":"text","content":", and how to analyze and navigate the profiling data graphically with KCachegrind."}]},{"block_type":"element","block":"k68ocnu4","search_text":"In the next chapter, we will explore how to improve performance using algorithms and data structures available in the Python standard library. We will cover scaling, sample usage of several data structures, and learn techniques such as caching and memoization.","text_count":260,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter, we will explore how to improve performance using algorithms and data structures available in the Python standard library. We will cover scaling, sample usage of several data structures, and learn techniques such as caching and memoization."}]}]},{"title":"Pure Python Optimizations","author":"Gabriele Lanaro","block":"k68ocgoy","number":2,"contents":[{"block_type":"element","block":"k68ocnu5","search_text":"As mentioned in the last chapter, one of the most effective ways of improving the performance of applications is through the use of better algorithms and data structures. The Python standard library provides a large variety of ready-to-use algorithms and data structures that can be directly incorporated in your applications. With the tools learned from this chapter, you will be able to use the right algorithm for the task and achieve massive speed gains.","text_count":458,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As mentioned in the last&nbsp;chapter, one of the most effective ways of improving the performance of applications is through the use of better algorithms and data structures. The Python standard library provides a large variety of ready-to-use algorithms and data structures that can be directly incorporated in your applications. With the tools learned from this chapter, you will be able to use the right algorithm for the task and achieve massive speed gains."}]},{"block_type":"element","block":"k68ocnu6","search_text":"Even though many algorithms have been around for quite a while, they are especially relevant in today's world as we continuously produce, consume, and analyze ever increasing amounts of data. Buying a larger server or microoptimizing can work for some time, but achieving better scaling through algorithmic improvement can solve the problem once and for all.","text_count":358,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even though many algorithms have been around for quite a while, they are especially relevant in today's world as we continuously produce, consume, and analyze ever increasing amounts of data. Buying a larger server or microoptimizing can work for some time, but achieving better scaling through algorithmic improvement can solve the problem once and for all."}]},{"block_type":"element","block":"k68ocnu7","search_text":"In this chapter, we will understand how to achieve better scaling using standard algorithms and data structures. More advanced use cases will also be covered by taking advantage of third-party libraries. We will also learn about tools to implement caching, a technique used to achieve faster response times by sacrificing some space on memory or on disk.","text_count":354,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will understand how to achieve better scaling using standard algorithms and data structures. More advanced use cases will also be covered by taking advantage of third-party libraries. We will also learn about tools to implement caching, a technique used to achieve faster response times by sacrificing some space on memory or on disk."}]},{"block_type":"element","block":"k68ocnu8","search_text":"The list of topics to be covered in this chapter is as follows:","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The list of topics to be covered in this chapter is as follows:"}]},{"block_type":"element","block":"k68ocnu9","search_text":"Introduction to computational complexity Lists and deques Dictionaries How to build an inverted index using a dictionary Sets Heaps and priority queues Implementing autocompletion using tries Introduction to caching In-memory caching with the functools.lru_cache decorator On-disk cache with joblib.Memory Fast and memory-efficient loops with comprehensions and generators ","text_count":373,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Introduction to computational complexity"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Lists and deques"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Dictionaries"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"How to build an inverted index using a dictionary"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Sets"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Heaps and priority queues"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Implementing autocompletion using tries"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Introduction to caching"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In-memory caching with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"functools.lru_cache"}]},{"block_type":"text","content":"decorator"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"On-disk cache with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"joblib.Memory"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Fast and memory-efficient loops with comprehensions and generators"}]}]},{"block_type":"element","block":"k68ocnua","search_text":"Useful algorithms and data structures","text_count":37,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Useful algorithms and data structures"}]},{"block_type":"element","block":"k68ocnub","search_text":"Algorithmic improvements are especially effective in increasing performance because they typically allow the application to scale better with increasingly large inputs.","text_count":168,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Algorithmic improvements are especially effective in increasing&nbsp;performance because they typically allow the application to scale better&nbsp;with increasingly large inputs."}]},{"block_type":"element","block":"k68ocnuc","search_text":"Algorithm running times can be classified according to their computational complexity, a characterization of the resources required to perform a task. Such classification is expressed through the Big-O notation, an upper bound on the operations required to execute the task, which usually depends on the input size.","text_count":315,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Algorithm running times can be classified according to their computational complexity, a characterization&nbsp;of the resources required to perform a task. Such classification is expressed through the Big-O notation, an upper bound on the operations required to execute the task, which usually depends on the input size."}]},{"block_type":"element","block":"k68ocnud","search_text":"For example, incrementing each element of a list can be implemented using a for loop, as follows:","text_count":97,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For example, incrementing each element of a list can be implemented using a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"for"}]},{"block_type":"text","content":"loop, as follows:"}]},{"block_type":"element","block":"k68ocnue","search_text":"input = list(range(10)) for i, _ in enumerate(input): input[i] += 1 ","text_count":68,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"input = list(range(10))\n    for i, _ in enumerate(input):\n        input[i] += 1"}]}]},{"block_type":"element","block":"k68ocnuf","search_text":"If the operation does not depend on the size of the input (for example, accessing the first element of a list), the algorithm is said to take constant, or O (1), time. This means that, no matter how much data we have, the time to run the algorithm will always be the same.","text_count":272,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If the operation does not depend on the size of the input (for example, accessing the first element of a list), the algorithm is said to take constant, or"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1), time. This means that, no matter how much data we have, the time to run the algorithm will&nbsp;always be the same."}]},{"block_type":"element","block":"k68ocnug","search_text":"In this simple algorithm, the input[i] += 1 operation will be repeated 10 times, which is the size of the input. If we double the size of the input array, the number of operations will increase proportionally. Since the number of operations is proportional to the input size, this algorithm is said to take O ( N ) time, where N is the size of the input array.","text_count":360,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this simple algorithm, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"input[i] += 1"}]},{"block_type":"text","content":"operation will be repeated 10 times, which is the size of the input. If we double the size of the input array, the number of operations will increase proportionally. Since the number of operations is proportional to the input size, this algorithm is said to take"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":") time, where"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":"is the size of the input array."}]},{"block_type":"element","block":"k68ocnuh","search_text":"In some instances, the running time may depend on the structure of the input (for example, if the collection is sorted or contains many duplicates). In these cases, an algorithm may have different best-case, average-case, and worst-case running times. Unless stated otherwise, the running times presented in this chapter are considered to be average running times.","text_count":364,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In some instances, the running time may depend on the structure of the input (for example, if the collection is sorted or contains many duplicates). In these cases, an algorithm may have different&nbsp;best-case, average-case, and worst-case running times. Unless stated otherwise, the running times presented in this chapter are considered to be average running times."}]},{"block_type":"element","block":"k68ocnui","search_text":"In this section, we will examine the running times of the main algorithms and data structures that are implemented in the Python standard library, and understand how improving running times results in massive gains and allows us to solve large-scale problems with elegance.","text_count":273,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section,&nbsp;we will examine the running times of the main algorithms and data structures that are implemented in the Python standard library, and understand how improving running times results in massive&nbsp;gains and allows us to solve large-scale problems with elegance."}]},{"block_type":"element","block":"k68ocnuj","search_text":"You can find the code used to run the benchmarks in this chapter in the Algorithms.ipynb notebook, which can be opened using Jupyter.","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can find the code used to run the benchmarks in this chapter in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Algorithms.ipynb"}]},{"block_type":"text","content":"&nbsp;notebook, which can be opened using Jupyter."}]},{"block_type":"element","block":"k68ocnuk","search_text":"Lists and deques","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Lists and deques"}]},{"block_type":"element","block":"k68ocnul","search_text":"Python lists are ordered collections of elements and, in Python, are implemented as resizable arrays. An array is a basic data structure that consists of a series of contiguous memory locations, and each location contains a reference to a Python object.","text_count":253,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Python lists are ordered collections of elements and, in Python, are implemented as resizable arrays. An array is a basic data structure that&nbsp;consists of a series of contiguous memory locations, and each location contains a reference to a Python object."}]},{"block_type":"element","block":"k68ocnum","search_text":"Lists shine in accessing, modifying, and appending elements. Accessing or modifying an element involves fetching the object reference from the appropriate position of the underlying array and has complexity O (1). Appending an element is also very fast. When an empty list is created, an array of fixed size is allocated and, as we insert elements, the slots in the array are gradually filled up. Once all the slots are occupied, the list needs to increase the size of its underlying array, thus triggering a memory reallocation that can take O ( N ) time. Nevertheless, those memory allocations are infrequent, and the time complexity for the append operation is referred to as amortized O(1) time.","text_count":699,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Lists shine in accessing, modifying, and appending elements. Accessing or modifying an element involves fetching the object reference from the appropriate position of the underlying array and has complexity"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1). Appending an element is also very fast. When an empty list is created, an array of fixed size is allocated and, as we insert elements, the slots in the array are gradually filled up. Once all the slots are occupied, the list needs to increase the size of its underlying array, thus triggering a memory reallocation that can&nbsp;take"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":") time. Nevertheless, those memory allocations are infrequent, and the time complexity for the append operation is referred to as amortized O(1) time."}]},{"block_type":"element","block":"k68ocnun","search_text":"The list operations that may have efficiency problems are those that add or remove elements at the beginning (or somewhere in the middle) of the list. When an item is inserted, or removed, from the beginning of a list, all the subsequent elements of the array need to be shifted by a position, thus taking O ( N ) time.","text_count":319,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The&nbsp;list operations that may have efficiency problems are those that add or remove&nbsp;elements at the beginning (or somewhere in the middle) of the list. When an item is inserted, or removed, from the beginning of a list, all the subsequent elements of the array need to be shifted by a position, thus taking"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":") time."}]},{"block_type":"element","block":"k68ocnuo","search_text":"In the following table, the timings for different operations on a list of size 10,000 are shown; you can see how insertion and removal performances vary quite dramatically if performed at the beginning or at the end of the list:","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following table, the timings for different operations on a list of size 10,000 are shown; you can see how insertion and removal performances vary quite dramatically&nbsp;if performed at the beginning or at the end of the list:"}]},{"block_type":"element","block":"k68ocnup","search_text":"Code N=10000 ( µs) N=20000 ( µs) N=30000 ( µs) Time list.pop() 0.50 0.59 0.58 O (1) list.pop(0) 4.20 8.36 12.09 O ( N ) list.append(1) 0.43 0.45 0.46 O (1) list.insert(0, 1) 6.20 11.97 17.41 O ( N ) ","text_count":199,"tag_name":"table","attributes":{},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Code"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=10000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=20000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=30000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Time"}]}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"list.pop()"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.50"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.59"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.58"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"list.pop(0)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"4.20"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"8.36"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"12.09"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":")"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"list.append(1)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.43"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.45"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.46"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"list.insert(0, 1)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"6.20"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"11.97"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"17.41"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":")"}]}]}]}]},{"block_type":"element","block":"k68ocnuq","search_text":"In some cases, it is necessary to efficiently perform insertion or removal of elements both at the beginning and at the end of the collection. Python provides a data structure with those properties in the collections.deque class. The word deque stands for double-ended queue because this data structure is designed to efficiently put and remove elements at the beginning and at the end of the collection, as it is in the case of queues. In Python, deques are implemented as doubly-linked lists.","text_count":494,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In some cases, it is necessary to&nbsp;efficiently perform insertion or removal of elements both at the&nbsp;beginning and at the end of the collection. Python provides a data structure with those properties in the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"collections.deque"}]},{"block_type":"text","content":"&nbsp;class. The word"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"deque"}]},{"block_type":"text","content":"stands for double-ended queue because this data structure is designed to efficiently put and remove elements at the beginning and at the end of the collection, as it is in the case of queues. In Python, deques are implemented as doubly-linked lists."}]},{"block_type":"element","block":"k68ocnur","search_text":"Deques, in addition to pop and append , expose the popleft and appendleft methods that have O (1) running time:","text_count":111,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Deques, in addition to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pop"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"append"}]},{"block_type":"text","content":", expose the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"popleft"}]},{"block_type":"text","content":"&nbsp;and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"appendleft"}]},{"block_type":"text","content":"&nbsp;methods&nbsp;that have"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1) running time:"}]},{"block_type":"element","block":"k68ocnus","search_text":"Code N=10000 ( µs) N=20000 ( µs) N=30000 ( µs) Time deque.pop() 0.41 0.47 0.51 O (1) deque.popleft() 0.39 0.51 0.47 O (1) deque.append(1) 0.42 0.48 0.50 O (1) deque.appendleft(1) 0.38 0.47 0.51 O (1) ","text_count":200,"tag_name":"table","attributes":{},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Code"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=10000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=20000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=30000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Time"}]}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"deque.pop()"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.41"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.47"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.51"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"deque.popleft()"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.39"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.51"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.47"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"deque.append(1)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.42"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.48"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.50"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"deque.appendleft(1)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.38"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.47"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.51"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1)"}]}]}]}]},{"block_type":"element","block":"k68ocnut","search_text":"Despite these advantages, deques should not be used to replace regular lists in most cases. The efficiency gained by the appendleft and popleft operations comes at a cost: accessing an element in the middle of a deque is a O(N) operation, as shown in the following table:","text_count":271,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Despite these advantages, deques should not be used to&nbsp;replace regular lists in most cases. The efficiency gained by the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"appendleft"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"popleft"}]},{"block_type":"text","content":"operations comes at a cost: accessing an element in the middle of a deque is a O(N) operation, as shown in the following table:"}]},{"block_type":"element","block":"k68ocnuu","search_text":"Code N=10000 ( µs) N=20000 ( µs) N=30000 ( µs) Time deque[0] 0.37 0.41 0.45 O (1) deque[N - 1] 0.37 0.42 0.43 O (1) deque[int(N / 2)] 1.14 1.71 2.48 O (N) ","text_count":155,"tag_name":"table","attributes":{},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Code"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=10000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=20000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=30000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Time"}]}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"deque[0]"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.37"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.41"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.45"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"deque[N -&nbsp; 1]"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.37"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.42"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"0.43"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"deque[int(N / 2)]"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"1.14"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"1.71"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"2.48"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(N)"}]}]}]}]},{"block_type":"element","block":"k68ocnuv","search_text":"Searching for an item in a list is generally a O ( N ) operation and is performed using the list.index method. A simple way to speed up searches in lists is to keep the array sorted and perform a binary search using the bisect module.","text_count":234,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Searching for an item in a list is generally&nbsp;a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":") operation and is performed using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"list.index"}]},{"block_type":"text","content":"&nbsp;method. A simple way to speed up searches in lists is to keep the array sorted and perform a binary search using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bisect"}]},{"block_type":"text","content":"module."}]},{"block_type":"element","block":"k68ocnuw","search_text":"The bisect module allows fast searches on sorted arrays. The bisect.bisect function can be used on a sorted list to find the index to place an element while maintaining the array in sorted order. In the following example, we can see that if we want to insert the 3 element in the array while keeping collection in sorted order, we should put 3 in the third position (which corresponds to index 2):","text_count":397,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bisect"}]},{"block_type":"text","content":"module allows fast searches on sorted arrays. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bisect.bisect"}]},{"block_type":"text","content":"function can be used on a sorted list to find the index to place an element while maintaining the array in sorted order. In the following example, we can see that if we want to insert the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"3"}]},{"block_type":"text","content":"element in the array while keeping"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"collection"}]},{"block_type":"text","content":"in sorted order, we should put"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"3"}]},{"block_type":"text","content":"in the third position (which corresponds to index 2):"}]},{"block_type":"element","block":"k68ocnux","search_text":"insert bisect collection = [1, 2, 4, 5, 6] bisect.bisect(collection, 3) # Result: 2 ","text_count":84,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"insert bisect\n    collection = [1, 2, 4, 5, 6]\n    bisect.bisect(collection, 3)\n    # Result: 2"}]}]},{"block_type":"element","block":"k68ocnuy","search_text":"This function uses the binary search algorithm that has O ( log ( N )) running time. Such a running time is exceptionally fast, and basically means that your running time will increase by a constant amount every time you double your input size. This means that if, for example, your program takes 1 second to run on an input of size 1000 , it will take 2 seconds to process an input of size 2000 , 3 seconds to process an input of size 4000 , and so on. If you had 100 seconds, you could theoretically process an input of size 10 33 , which is larger than the number of atoms in your body!","text_count":589,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This function uses the binary search algorithm that has"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"log"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":")) running time. Such a running time is exceptionally fast, and basically means that your running time will increase by a constant amount every time you"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"double"}]},{"block_type":"text","content":"your input size. This means that if, for example, your program takes"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"second to run on an input of size"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1000"}]},{"block_type":"text","content":", it will take"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"2"}]},{"block_type":"text","content":"seconds to process an input of size"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"2000"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"3"}]},{"block_type":"text","content":"seconds to process an input of size"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"4000"}]},{"block_type":"text","content":", and so on. If you had"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"100"}]},{"block_type":"text","content":"seconds, you could theoretically process an input of size"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"10"},{"block_type":"element","tag_name":"sup","attributes":{},"children":[{"block_type":"text","content":"33"}]}]},{"block_type":"text","content":", which is larger than the number of atoms in your body!"}]},{"block_type":"element","block":"k68ocnuz","search_text":"If the value we are trying to insert is already present in the list, the bisect.bisect function will return the location after the already present value. Therefore, we can use the bisect.bisect_left variant, which returns the correct index in the following way (taken from the module documentation at https://docs.python.org/3.5/library/bisect.html ):","text_count":351,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If the value we are trying to insert is already present in the list, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bisect.bisect"}]},{"block_type":"text","content":"function will return the location"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"after"}]},{"block_type":"text","content":"the already present value.&nbsp; Therefore, we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bisect.bisect_left"}]},{"block_type":"text","content":"&nbsp;variant, which returns the correct index in the following way (taken from the module documentation at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://docs.python.org/3.5/library/bisect.html"},"children":[{"block_type":"text","content":"https://docs.python.org/3.5/library/bisect.html"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k68ocnv0","search_text":"def index_bisect(a, x): 'Locate the leftmost value exactly equal to x' i = bisect.bisect_left(a, x) if i != len(a) and a[i] == x: return i raise ValueError ","text_count":156,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def index_bisect(a, x):\n      'Locate the leftmost value exactly equal to x'\n      i = bisect.bisect_left(a, x)\n      if i != len(a) and a[i] == x:\n      return i\n      raise ValueError"}]}]},{"block_type":"element","block":"k68ocnv1","search_text":"In the following table, you can see how the running time of the bisect solution is barely affected at these input sizes, making it a suitable solution when searching through very large collections:","text_count":197,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following table, you can see how the running time of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bisect"}]},{"block_type":"text","content":"solution is barely affected at these input sizes, making it a suitable solution when searching through very large collections:"}]},{"block_type":"element","block":"k68ocnv2","search_text":"Code N=10000 ( µs) N=20000 ( µs) N=30000 ( µs) Time list.index(a) 87.55 171.06 263.17 O (N) index_bisect(list, a) 3.16 3.20 4.71 O (log(N)) ","text_count":140,"tag_name":"table","attributes":{},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Code"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=10000 ("}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=20000 ("}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=30000 ("}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Time"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"list.index(a)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"87.55"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"171.06"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"263.17"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(N)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"index_bisect(list, a)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"3.16"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"3.20"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"4.71"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(log(N))"}]}]}]}]},{"block_type":"element","block":"k68ocnv3","search_text":"Dictionaries","text_count":12,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Dictionaries"}]},{"block_type":"element","block":"k68ocnv4","search_text":"Dictionaries are extremely versatile and extensively used in the Python language. Dictionaries are implemented as hash maps and are very good at element insertion, deletion, and access; all these operations have an average O (1) time complexity. ","text_count":246,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dictionaries are extremely versatile and extensively used in the Python language. Dictionaries are implemented as hash maps and are very good at element insertion, deletion, and access; all these operations have an average"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1) time complexity.&nbsp;"}]},{"block_type":"element","block":"k68ocnv5","search_text":"Note In Python versions up to 3.5, dictionaries are unordered collections. Since Python 3.6, dictionaries are capable of maintaining their elements by order of insertion. ","text_count":171,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Python versions up to 3.5, dictionaries are unordered collections. Since Python 3.6, dictionaries are capable of maintaining their elements by order of insertion."}]}]},{"block_type":"element","block":"k68ocnv6","search_text":"A hash map is a data structure that associates a set of key-value pairs. The principle behind hash maps is to assign a specific index to each key so that its associated value can be stored in an array. The index can be obtained through the use of a hash function; Python implements hash functions for several data types. As a demonstration, the generic function to obtain hash codes is hash . In the following example, we show you how to obtain the hash code given the \"hello\" string:","text_count":484,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A hash map is a data structure that associates a set of key-value pairs. The principle behind hash maps is to assign a specific index to each key so that its associated value can be stored in an array. The index can be obtained through the use of a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hash"}]},{"block_type":"text","content":"function; Python implements hash functions for several data types. As a demonstration, the generic function to obtain hash codes is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hash"}]},{"block_type":"text","content":". In the following example, we show you how to obtain the hash code given the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"\"hello\""}]},{"block_type":"text","content":"&nbsp;string:"}]},{"block_type":"element","block":"k68ocnv7","search_text":"hash(\"hello\") # Result: -1182655621190490452 # To restrict the number to be a certain range you can use # the modulo (%) operator hash(\"hello\") % 10 # Result: 8 ","text_count":161,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"hash(\"hello\")\n    # Result: -1182655621190490452\n\n    # To restrict the number to be a certain range you can use\n    # the modulo (%) operator\n    hash(\"hello\") % 10\n    # Result: 8"}]}]},{"block_type":"element","block":"k68ocnv8","search_text":"Hash maps can be tricky to implement because they need to handle collisions that happen when two different objects have the same hash code. However, all the complexity is elegantly hidden behind the implementation and the default collision resolution works well in most real-world scenarios.","text_count":291,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Hash maps can be tricky to implement because they need to handle collisions that happen when two different objects have the same hash code. However, all the complexity is elegantly hidden behind the implementation and the default collision resolution works well in most real-world scenarios."}]},{"block_type":"element","block":"k68ocnv9","search_text":"Access, insertion, and removal of an item in a dictionary scales as O (1) with the size of the dictionary. However, note that the computation of the hash function still needs to happen and, for strings, the computation scales with the length of the string. As string keys are usually relatively small, this doesn't constitute a problem in practice.","text_count":348,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Access, insertion, and removal of an item in a dictionary scales as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1) with the size of the dictionary. However, note that the computation of the hash function still needs to happen and, for strings, the computation scales with the length of the string. As string keys are usually relatively small, this doesn't constitute a problem in practice."}]},{"block_type":"element","block":"k68ocnva","search_text":"A dictionary can be used to efficiently count unique elements in a list. In this example, we define the counter_dict function that takes a list and returns a dictionary containing the number of occurrences of each value in the list:","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A dictionary can be used to efficiently count unique elements in a list. In this example, we define the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"counter_dict"}]},{"block_type":"text","content":"function that takes a list and returns a dictionary containing the number of occurrences of each value in the list:"}]},{"block_type":"element","block":"k68ocnvb","search_text":"def counter_dict(items): counter = {} for item in items: if item not in counter: counter[item] = 0 else: counter[item] += 1 return counter ","text_count":139,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def counter_dict(items): \n        counter = {} \n        for item in items: \n            if item not in counter: \n                counter[item] = 0 \n            else: \n                counter[item] += 1 \n        return counter"}]}]},{"block_type":"element","block":"k68ocnvc","search_text":"The code can be somewhat simplified using collections.defaultdict , which can be used to produce dictionaries where each new key is automatically assigned a default value. In the following code, the defaultdict(int) call produces a dictionary where every new element is automatically assigned a zero value, and can be used to streamline the counting:","text_count":350,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code can be somewhat simplified using&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"collections.defaultdict"}]},{"block_type":"text","content":", which can be used to produce dictionaries where each new key is automatically assigned a default value. In the following code, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"defaultdict(int)"}]},{"block_type":"text","content":"call produces a dictionary where every new element is automatically assigned a zero value, and can be used to streamline the counting:"}]},{"block_type":"element","block":"k68ocnvd","search_text":"from collections import defaultdict def counter_defaultdict(items): counter = defaultdict(int) for item in items: counter[item] += 1 return counter ","text_count":148,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from collections import defaultdict\n    def counter_defaultdict(items):\n        counter = defaultdict(int)\n        for item in items:\n            counter[item] += 1\n        return counter"}]}]},{"block_type":"element","block":"k68ocnve","search_text":"The collections module also includes a Counter class that can be used for the same purpose with a single line of code:","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"collections"}]},{"block_type":"text","content":"module also includes a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Counter"}]},{"block_type":"text","content":"class that can be used for the same purpose with&nbsp;a single line of code:"}]},{"block_type":"element","block":"k68ocnvf","search_text":"from collections import Counter counter = Counter(items) ","text_count":57,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from collections import Counter\n    counter = Counter(items)"}]}]},{"block_type":"element","block":"k68ocnvg","search_text":"Speed-wise, all these ways of counting have the same time complexity, but the Counter implementation is the most efficient, as shown in the following table:","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Speed-wise, all these ways of counting have the same time complexity, but the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Counter"}]},{"block_type":"text","content":"implementation is the most efficient, as shown in the following table:"}]},{"block_type":"element","block":"k68ocnvh","search_text":"Code N=1000 ( µs) N=2000 ( µs) N=3000 ( µs) Time Counter(items) 51.48 96.63 140.26 O (N) counter_dict(items) 111.96 197.13 282.79 O (N) counter_defaultdict(items) 120.90 238.27 359.60 O (N) ","text_count":190,"tag_name":"table","attributes":{},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Code"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=1000 ("}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=2000 ("}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=3000 ("}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Time"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Counter(items)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"51.48"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"96.63"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"140.26"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(N)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"counter_dict(items)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"111.96"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"197.13"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"282.79"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(N)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"counter_defaultdict(items)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"120.90"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"238.27"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"359.60"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(N)"}]}]}]}]},{"block_type":"element","block":"k68ocnvi","search_text":"Building an in-memory search index using a hash map","text_count":51,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Building an in-memory search index using a hash map"}]},{"block_type":"element","block":"k68ocnvj","search_text":"Dictionaries can be used to quickly search for a word in a list of documents, similar to a search engine. In this subsection, we will learn how to build an inverted index based on a dictionary of lists. Let's say we have a collection of four documents:","text_count":252,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dictionaries can be used to quickly search for a word in a list of documents, similar to a search engine. In this subsection, we will learn how to build an inverted index based on a dictionary of lists. Let's say we have a collection of four documents:"}]},{"block_type":"element","block":"k68ocnvk","search_text":"docs = [\"the cat is under the table\", \"the dog is under the table\", \"cats and dogs smell roses\", \"Carla eats an apple\"] ","text_count":120,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"docs = [\"the cat is under the table\",\n            \"the dog is under the table\",\n            \"cats and dogs smell roses\",\n            \"Carla eats an apple\"]"}]}]},{"block_type":"element","block":"k68ocnvl","search_text":"A simple way to retrieve all the documents that match a query is to scan each document and test for the presence of a word. For example, if we want to look up the documents where the word table appears, we can employ the following filtering operation:","text_count":251,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A simple way to retrieve all the documents that match a query is to scan each document and test for the presence of a word. For example, if we want to look up the documents where the word"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"table"}]},{"block_type":"text","content":"&nbsp;appears, we can&nbsp;employ the following filtering operation:"}]},{"block_type":"element","block":"k68ocnvm","search_text":"matches = [doc for doc in docs if \"table\" in doc] ","text_count":50,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"matches = [doc for doc in docs if \"table\" in doc]"}]}]},{"block_type":"element","block":"k68ocnvn","search_text":"This approach is simple and works well when we have one-off queries; however, if we need to query the collection very often, it can be beneficial to optimize querying time. Since the per-query cost of the linear scan is O ( N ), you can imagine that a better scaling will allow us to handle much larger document collections.","text_count":324,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This approach is simple and works well when we have one-off queries; however, if we need to query the collection very often, it can be beneficial to optimize querying time. Since the per-query cost of the linear scan is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":"), you can imagine that a better scaling will allow us to handle much larger document collections."}]},{"block_type":"element","block":"k68ocnvo","search_text":"A better strategy is to spend some time preprocessing the documents so that they are easier to find at query time. We can build a structure, called the inverted index , that associates each word in our collection with the list of documents where that word is present. In our earlier example, the word \"table\" will be associated to the \"the cat is under the table\" and \"the dog is under the table\" documents; they correspond to indices 0 and 1 .","text_count":444,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A better strategy is to spend some time preprocessing the documents so that they are easier to find at query time. We can build a structure, called the&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"inverted index"}]},{"block_type":"text","content":", that associates each word in our collection with the list of documents where that word is present. In our earlier&nbsp;example, the word"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"\"table\""}]},{"block_type":"text","content":"will be associated to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"\"the cat is under the table\""}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"\"the dog is under the table\""}]},{"block_type":"text","content":"&nbsp;documents; they correspond&nbsp;to indices"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnvp","search_text":"Such a mapping can be implemented by going over our collection of documents and storing in a dictionary the index of the documents where that term appears. The implementation is similar to the counter_dict function, except that, instead of accumulating a counter, we are growing the list of documents that match the current term:","text_count":329,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Such a mapping can be implemented by going over our collection of documents and storing in a dictionary the index of the documents where that term appears. The implementation is similar to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"counter_dict"}]},{"block_type":"text","content":"&nbsp;function, except that, instead of accumulating a counter, we are growing the list of documents that match the current term:"}]},{"block_type":"element","block":"k68ocnvq","search_text":"# Building an index index = {} for i, doc in enumerate(docs): # We iterate over each term in the document for word in doc.split(): # We build a list containing the indices # where the term appears if word not in index: index[word] = [i] else: index[word].append(i) ","text_count":265,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# Building an index\n    index = {}\n    for i, doc in enumerate(docs):\n        # We iterate over each term in the document\n        for word in doc.split():\n            # We build a list containing the indices \n            # where the term appears\n            if word not in index:\n                index[word] = [i]\n            else:\n                index[word].append(i)"}]}]},{"block_type":"element","block":"k68ocnvr","search_text":"Once we have built our index, doing a query involves a simple dictionary lookup. For example, if we want to return all the documents containing the term table, we can simply query the index, and retrieve the corresponding documents:","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once we have built our index, doing a query involves a simple dictionary lookup. For example, if we want to return all the documents containing the term table, we can simply query the index, and retrieve the corresponding documents:"}]},{"block_type":"element","block":"k68ocnvs","search_text":"results = index[\"table\"] result_documents = [docs[i] for i in results] ","text_count":71,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"results = index[\"table\"]\n    result_documents = [docs[i] for i in results]"}]}]},{"block_type":"element","block":"k68ocnvt","search_text":"Since all it takes to query our collection is a dictionary access, the index can handle queries with time complexity O (1)! Thanks to the inverted index, we are now able to query any number of documents (as long as they fit in memory) in constant time. Needless to say, indexing is a technique widely used to quickly retrieve data not only in search engines, but also in databases and any system that requires fast searches.","text_count":424,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Since all it takes to query our collection is a dictionary access, the index can handle queries with time complexity"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1)! Thanks to the inverted index, we are now able to query any number of documents (as long as they fit in memory) in constant time. Needless to say, indexing is a technique widely used to quickly retrieve data not only in search engines, but also in databases and any system that requires fast searches."}]},{"block_type":"element","block":"k68ocnvu","search_text":"Note that building an inverted index is an expensive operation and requires you to encode every possible query. This is a substantial drawback, but the benefits are great and it may be worthwhile to pay the price in terms of decreased flexibility.","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that building an inverted index is an expensive operation and requires you to encode every possible query. This is a substantial drawback, but the benefits are great and it may be worthwhile to pay the price in terms of decreased flexibility."}]},{"block_type":"element","block":"k68ocnvv","search_text":"Sets","text_count":4,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sets"}]},{"block_type":"element","block":"k68ocnvw","search_text":"Sets are unordered collections of elements, with the additional restriction that the elements must be unique. The main use-cases where sets are a good choice are membership tests (testing if an element is present in the collection) and, unsurprisingly, set operations such as union, difference, and intersection.","text_count":312,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sets are unordered collections of elements, with the additional restriction that the elements must be unique.&nbsp; The main use-cases where sets are a good choice are membership tests (testing&nbsp;if an element is present in the collection) and, unsurprisingly, set operations such as union, difference, and intersection."}]},{"block_type":"element","block":"k68ocnvx","search_text":"In Python, sets are implemented using a hash-based algorithm just like dictionaries; therefore, the time complexities for addition, deletion, and test for membership scale as O (1) with the size of the collection.","text_count":213,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Python, sets are implemented using a hash-based algorithm just like dictionaries; therefore, the time complexities for addition, deletion, and test for membership scale as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1) with the size of the collection."}]},{"block_type":"element","block":"k68ocnvy","search_text":"Sets contain only unique elements. An immediate use case of sets is the removal of duplicates from a collection, which can be accomplished by simply passing the collection through the set constructor, as follows:","text_count":212,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sets contain only unique elements. An immediate use case of sets&nbsp;is the removal of duplicates from a collection, which can be accomplished by simply passing the collection through the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"set"}]},{"block_type":"text","content":"&nbsp;constructor, as follows:"}]},{"block_type":"element","block":"k68ocnvz","search_text":"# create a list that contains duplicates x = list(range(1000)) + list(range(500)) # the set *x_unique* will contain only # the unique elements in x x_unique = set(x) ","text_count":166,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# create a list that contains duplicates\n    x = list(range(1000)) + list(range(500))\n    # the set *x_unique* will contain only \n    # the unique elements in x\n    x_unique = set(x)"}]}]},{"block_type":"element","block":"k68ocnw0","search_text":"The time complexity for removing duplicates is O ( N ), as it requires to read the input and put each element in the set.","text_count":121,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The time complexity&nbsp;for removing duplicates is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":"), as it requires to read the input and put each element in the set."}]},{"block_type":"element","block":"k68ocnw1","search_text":"Sets expose a number of operations like union, intersection, and difference. The union of two sets is a new set containing all the elements of both the sets; the intersection is a new set that contains only the elements in common between the two sets, and the difference is a new set containing the element of the first set that are not contained in the second set. The time complexities for these operations are shown in the following table. Note that since we have two different input sizes, we will use the letter S to indicate the size of the first set (called s ), and T to indicate the size of the second set (called t ):","text_count":627,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sets expose a number of operations like union, intersection, and difference. The union&nbsp;of two sets is a new set containing all the elements of both the sets; the intersection is a new set that contains only the elements in common between the two sets, and the difference is a new set containing the element of the first set that are not contained in the second set. The time complexities for these operations are shown in the following table. Note that since we have two different input sizes, we will use&nbsp;the letter S to indicate the size of the first set (called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"s"}]},{"block_type":"text","content":"), and T to indicate the size of the second set (called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"t"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k68ocnw2","search_text":"Code Time s.union(t) O ( S + T ) s.intersection(t) O ( min ( S , T )) s.difference(t) O ( S ) ","text_count":94,"tag_name":"table","attributes":{},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Code"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Time"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"s.union(t)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"S"}]},{"block_type":"text","content":"+"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"T"}]},{"block_type":"text","content":")"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"s.intersection(t)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"min"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"S"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"T"}]},{"block_type":"text","content":"))"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"s.difference(t)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"S"}]},{"block_type":"text","content":")"}]}]}]}]},{"block_type":"element","block":"k68ocnw3","search_text":"An application of set operations are, for example, Boolean queries. Going back to the inverted index example of the previous subsection, we may want to support queries that include multiple terms. For example, we may want to search for all the documents that contain the words cat and table . This kind of a query can be efficiently computed by taking the intersection between the set of documents containing cat and the set of documents containing table .","text_count":456,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An application of set operations are, for example, Boolean queries. Going back to&nbsp;the inverted index example of the previous subsection, we may want to support queries that include multiple terms. For example, we may want to search for all the documents that contain the words&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cat"}]},{"block_type":"text","content":"&nbsp;and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"table"}]},{"block_type":"text","content":". This kind of a query can be efficiently computed by taking the intersection between the set of documents containing"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cat"}]},{"block_type":"text","content":"&nbsp;and the set of documents containing"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"table"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnw4","search_text":"In order to efficiently support those operations, we can change our indexing code so that each term is associated to a set of documents (rather than a list). After applying this change, calculating more advanced queries is a matter of applying the right set operation. In the following code, we show the inverted index based on sets and the query using set operations:","text_count":368,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In order to efficiently support those operations, we can change our indexing code so that each term is associated to a set of documents (rather than a list). After applying this change, calculating more advanced queries is a matter of applying the right set operation. In the following code, we show the inverted index based on sets and the query using set operations:"}]},{"block_type":"element","block":"k68ocnw5","search_text":"# Building an index using sets index = {} for i, doc in enumerate(docs): # We iterate over each term in the document for word in doc.split(): # We build a set containing the indices # where the term appears if word not in index: index[word] = {i} else: index[word].add(i) # Querying the documents containing both \"cat\" and \"table\" index['cat'].intersection(index['table']) ","text_count":373,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# Building an index using sets\n    index = {}\n    for i, doc in enumerate(docs):\n        # We iterate over each term in the document\n        for word in doc.split():\n            # We build a set containing the indices \n            # where the term appears\n            if word not in index:\n                index[word] = {i}\n            else:\n                index[word].add(i)\n    \n    # Querying the documents containing both \"cat\" and \"table\"\n    index['cat'].intersection(index['table'])"}]}]},{"block_type":"element","block":"k68ocnw6","search_text":"Heaps","text_count":5,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Heaps"}]},{"block_type":"element","block":"k68ocnw7","search_text":"Heaps are data structures designed to quickly find and extract the maximum (or minimum) value in a collection. A typical use-case for heaps is to process a series of incoming tasks in order of maximum priority.","text_count":210,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Heaps are data structures designed&nbsp;to quickly find and extract the maximum&nbsp;(or minimum) value in a collection. A typical use-case for heaps is to process a series of incoming tasks in order of maximum priority."}]},{"block_type":"element","block":"k68ocnw8","search_text":"One can theoretically use a sorted list using the tools in the bisect module; however, while extracting the maximum value will take O (1) time (using list.pop ), insertion will still take O (N) time (remember that, even if finding the insertion point takes O ( log ( N )) time, inserting an element in the middle of a list is still a O ( N ) operation). A heap is a more efficient data structure that allows for insertion and extraction of maximum values with O ( log ( N )) time complexity.","text_count":491,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One can theoretically use a sorted&nbsp;list using the tools in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bisect"}]},{"block_type":"text","content":"module; however, while extracting the maximum value will take"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1) time (using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"list.pop"}]},{"block_type":"text","content":"), insertion will still take"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(N) time (remember that, even if finding the insertion point takes"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"log"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":")) time, inserting an element in the middle of a list is still a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":") operation). A heap is a more efficient data structure that allows for insertion and extraction of maximum values with"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"log"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":")) time complexity."}]},{"block_type":"element","block":"k68ocnw9","search_text":"In Python, heaps are built using the procedures contained in the heapq module on an underlying list. For example, if we have a list of 10 elements, we can reorganize it into a heap with the heapq.heapify function:","text_count":213,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Python, heaps are built using the procedures contained in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"heapq"}]},{"block_type":"text","content":"module on an&nbsp;underlying list. For example, if we have&nbsp;a list of 10 elements, we can reorganize&nbsp;it into a heap with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"heapq.heapify"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k68ocnwa","search_text":"import heapq collection = [10, 3, 3, 4, 5, 6] heapq.heapify(collection) ","text_count":72,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import heapq\n\n    collection = [10, 3, 3, 4, 5, 6]\n    heapq.heapify(collection)"}]}]},{"block_type":"element","block":"k68ocnwb","search_text":"To perform the insertion and extraction operations on the heap, we can use the heapq.heappush and heapq.heappop functions. The heapq.heappop function will extract the minimum value in the collection in O ( log ( N )) time and can be used in the following way:","text_count":259,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To perform the insertion and extraction operations on the heap, we can use the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"heapq.heappush"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"heapq.heappop"}]},{"block_type":"text","content":"&nbsp;functions. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"heapq.heappop"}]},{"block_type":"text","content":"function will extract the minimum value in the collection in"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"log"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":")) time and can be used in the following way:"}]},{"block_type":"element","block":"k68ocnwc","search_text":"heapq.heappop(collection) # Returns: 3 ","text_count":39,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"heapq.heappop(collection)\n    # Returns: 3"}]}]},{"block_type":"element","block":"k68ocnwd","search_text":"Similarly, you can push the integer 1 , with the heapq.heappush function, as follows:","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Similarly, you can push the integer"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":", with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"heapq.heappush"}]},{"block_type":"text","content":"function, as follows:"}]},{"block_type":"element","block":"k68ocnwe","search_text":"heapq.heappush(collection, 1) ","text_count":30,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"heapq.heappush(collection, 1)"}]}]},{"block_type":"element","block":"k68ocnwf","search_text":"Another easy-to-use option is the queue.PriorityQueue class that, as a bonus, is thread and process-safe. The PriorityQueue class can be filled up with elements using the PriorityQueue.put method, while PriorityQueue.get can be used to extract the minimum value in the collection:","text_count":280,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another easy-to-use option is the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"queue.PriorityQueue"}]},{"block_type":"text","content":"class that, as a bonus, is thread and process-safe. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"PriorityQueue"}]},{"block_type":"text","content":"class can be filled up with elements using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"PriorityQueue.put"}]},{"block_type":"text","content":"&nbsp;method, while&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"PriorityQueue.get"}]},{"block_type":"text","content":"can be used to extract the minimum value in the collection:"}]},{"block_type":"element","block":"k68ocnwg","search_text":"from queue import PriorityQueue queue = PriorityQueue() for element in collection: queue.put(element) queue.get() # Returns: 3 ","text_count":127,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from queue import PriorityQueue\n\n    queue = PriorityQueue()\n    for element in collection:\n        queue.put(element)\n\n    queue.get()\n    # Returns: 3"}]}]},{"block_type":"element","block":"k68ocnwh","search_text":"If the maximum element is required, a simple trick is to multiply each element of the list by -1 . In this way, the order of the elements will be inverted. Also, if you want to associate an object (for example, a task to run) to each number (which can represent the priority), one can insert tuples of the (number, object) form; the comparison operator for the tuple will be ordered with respect to its first element, as shown in the following example:","text_count":452,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If the maximum element is required, a simple trick is to multiply each element of the list by&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-1"}]},{"block_type":"text","content":". In this way, the order of the elements will be inverted. Also, if you want to associate an object (for example, a task to run) to each number (which can represent the priority), one can insert tuples of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(number, object)"}]},{"block_type":"text","content":"&nbsp;form; the comparison operator for the tuple will be ordered with respect to its first element, as shown in the following example:"}]},{"block_type":"element","block":"k68ocnwi","search_text":"queue = PriorityQueue() queue.put((3, \"priority 3\")) queue.put((2, \"priority 2\")) queue.put((1, \"priority 1\")) queue.get() # Returns: (1, \"priority 1\") ","text_count":152,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"queue = PriorityQueue()\n    queue.put((3, \"priority 3\"))\n    queue.put((2, \"priority 2\"))\n    queue.put((1, \"priority 1\"))\n\n    queue.get()\n    # Returns: (1, \"priority 1\")"}]}]},{"block_type":"element","block":"k68ocnwj","search_text":"Tries","text_count":5,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Tries"}]},{"block_type":"element","block":"k68ocnwk","search_text":"A perhaps less popular data structure, very useful in practice, is the trie (sometimes called prefix tree). Tries are extremely fast at matching a list of strings against a prefix. This is especially useful when implementing features such as search-as-you type and autocompletion, where the list of available completions is very large and short response times are required.","text_count":373,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A perhaps less popular data structure, very useful in practice, is the trie (sometimes called prefix tree). Tries are extremely fast at matching a list of strings against a prefix. This is especially useful when implementing features such as search-as-you type and autocompletion, where the list of available completions is very large and short response times are required."}]},{"block_type":"element","block":"k68ocnwl","search_text":"Unfortunately, Python does not include a trie implementation in its standard library; however, many efficient implementations are readily available through PyPI. The one we will use in this subsection is patricia-trie , a single-file, pure Python implementation of trie. As an example, we will use patricia-trie to perform the task of finding the longest prefix in a set of strings (just like autocompletion).","text_count":409,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Unfortunately, Python does not include a trie implementation in its standard library; however, many efficient implementations are readily available through PyPI. The one we will use in this subsection is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"patricia-trie"}]},{"block_type":"text","content":", a single-file, pure Python implementation of trie.&nbsp;As an example, we will use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"patricia-trie"}]},{"block_type":"text","content":"to perform the task of finding the longest prefix in a set of strings (just like autocompletion)."}]},{"block_type":"element","block":"k68ocnwm","search_text":"As an example, we can demonstrate how fast a trie is able to search through a list of strings. In order to generate a large amount of unique random strings, we can define a function, random_string . The random_string function will return a string composed of random uppercase characters and, while there is a chance to get duplicates, we can greatly reduce the probability of duplicates to the point of being negligible if we make the string long enough. The implementation of the random_string function is shown as follows:","text_count":524,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As&nbsp;an example, we can demonstrate how fast a trie is able to search through a list of strings. In order to generate a large amount of unique random strings, we can define a function,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"random_string"}]},{"block_type":"text","content":". The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"random_string"}]},{"block_type":"text","content":"&nbsp;function will return a string composed of random uppercase characters and, while there is a chance to get duplicates, we can greatly reduce the probability of duplicates to the point of being negligible if we make the string long enough. The implementation of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"random_string"}]},{"block_type":"text","content":"function is shown as follows:"}]},{"block_type":"element","block":"k68ocnwn","search_text":"from random import choice from string import ascii_uppercase def random_string(length): \"\"\"Produce a random string made of *length* uppercase ascii characters\"\"\" return ''.join(choice(ascii_uppercase) for i in range(length)) ","text_count":225,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from random import choice\n    from string import ascii_uppercase\n\n    def random_string(length):\n     \"\"\"Produce a random string made of *length* uppercase ascii \n     characters\"\"\"\n     return ''.join(choice(ascii_uppercase) for i in range(length))"}]}]},{"block_type":"element","block":"k68ocnwo","search_text":"We can build a list of random strings and time how fast it searches for a prefix (in our case, the \"AA\" string) using the str.startswith function:","text_count":146,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can build a list of random strings&nbsp;and time how fast it searches for a prefix (in our case, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"\"AA\""}]},{"block_type":"text","content":"&nbsp;string) using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"str.startswith"}]},{"block_type":"text","content":"&nbsp;function:"}]},{"block_type":"element","block":"k68ocnwp","search_text":"strings = [random_string(32) for i in range(10000)] matches = [s for s in strings if s.startswith('AA')] ","text_count":105,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"strings = [random_string(32) for i in range(10000)]\n    matches = [s for s in strings if s.startswith('AA')]"}]}]},{"block_type":"element","block":"k68ocnwq","search_text":"List comprehension and str.startwith are already very optimized operations and, on this small dataset, the search takes only a millisecond or so:","text_count":145,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"List comprehension and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"str.startwith"}]},{"block_type":"text","content":"are already very optimized operations and, on this small dataset, the search takes only a millisecond or so:"}]},{"block_type":"element","block":"k68ocnwr","search_text":"%timeit [s for s in strings if s.startswith('AA')] 1000 loops, best of 3: 1.76 ms per loop ","text_count":91,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%timeit [s for s in strings if s.startswith('AA')]\n\n    1000 loops, best of 3: 1.76 ms per loop"}]}]},{"block_type":"element","block":"k68ocnws","search_text":"Now, let's try using a trie for the same operation. In this example, we will use the patricia-trie library that is installable through pip . The patricia.trie class implements a variant of the trie data structure with an interface similar to a dictionary. We can initialize our trie by creating a dictionary from our list of strings, as follows:","text_count":345,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's try using a trie for the same operation. In this example, we will use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"patricia-trie"}]},{"block_type":"text","content":"library that is installable through"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip"}]},{"block_type":"text","content":". The&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"patricia.trie"}]},{"block_type":"text","content":"&nbsp;class implements a variant of the trie data structure with an interface similar to a dictionary. We can initialize our trie by creating a dictionary from our list of strings, as follows:"}]},{"block_type":"element","block":"k68ocnwt","search_text":"from patricia import trie strings_dict = {s:0 for s in strings} # A dictionary where all values are 0 strings_trie = trie(**strings_dict) ","text_count":138,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from patricia import trie\n    strings_dict = {s:0 for s in strings} \n    # A dictionary where all values are 0\n    strings_trie = trie(**strings_dict)"}]}]},{"block_type":"element","block":"k68ocnwu","search_text":"To query patricia-trie for a matching prefix, we can use the trie.iter method, which returns an iterator over the matching strings:","text_count":131,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To query"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"patricia-trie"}]},{"block_type":"text","content":"for a matching prefix, we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"trie.iter"}]},{"block_type":"text","content":"&nbsp;method, which returns an iterator&nbsp;over the matching strings:"}]},{"block_type":"element","block":"k68ocnwv","search_text":"matches = list(strings_trie.iter('AA')) ","text_count":40,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"matches = list(strings_trie.iter('AA'))"}]}]},{"block_type":"element","block":"k68ocnww","search_text":"Now that we know how to initialize and query a trie, we can time the operation:","text_count":79,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we know how to initialize and query a trie, we can time the operation:"}]},{"block_type":"element","block":"k68ocnwx","search_text":"%timeit list(strings_trie.iter('AA')) 10000 loops, best of 3: 60.1 µs per loop ","text_count":79,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%timeit list(strings_trie.iter('AA'))\n    10000 loops, best of 3: 60.1 &micro;s per loop"}]}]},{"block_type":"element","block":"k68ocnwy","search_text":"If you look closely, the timing for this input size is 60.1 µs , which is about 30 times faster (1.76 ms = 1760 µs) than linear search! The speed up is so impressive because of the better computational complexity of the trie prefix search. Querying a trie has a time complexity O ( S ), where S is the length of the longest string in the collection, while the time complexity of a simple linear scan is O ( N ), where N is the size of the collection. ","text_count":451,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you look closely, the timing for this input size is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"60.1 &micro;s"}]},{"block_type":"text","content":", which is about 30 times faster&nbsp;(1.76 ms = 1760 &micro;s) than linear search! The speed up is so impressive because of the better computational complexity of the trie prefix search. Querying&nbsp;a trie has a time complexity&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"S"}]},{"block_type":"text","content":"), where S is the length of the longest string&nbsp;in the collection, while the time complexity of&nbsp;a simple linear scan is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":"), where"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":"is the size of the collection.&nbsp;"}]},{"block_type":"element","block":"k68ocnwz","search_text":"Note that if we want to return all the prefixes that match, the running time will be proportional to the number of results that match the prefix. Therefore, when designing timing benchmarks, care must be taken to ensure that we are always returning the same number of results.","text_count":276,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that if we want to return all the prefixes that match, the running time will be proportional to the number of results that match the prefix. Therefore, when designing timing benchmarks, care must be taken to ensure that we are always returning the same number of results."}]},{"block_type":"element","block":"k68ocnx0","search_text":"The scaling properties of a trie versus a linear scan for datasets of different sizes that contains ten prefix matches are shown in the following table:","text_count":152,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The scaling properties of a trie versus a linear scan for datasets of different sizes that contains ten&nbsp;prefix matches&nbsp;are&nbsp;shown in the following table:"}]},{"block_type":"element","block":"k68ocnx1","search_text":"Algorithm N=10000 ( µs) N=20000 ( µs) N=30000 ( µs) Time Trie 17.12 17.27 17.47 O ( S ) Linear scan 1978.44 4075.72 6398.06 O ( N ) ","text_count":132,"tag_name":"table","attributes":{},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Algorithm"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=10000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=20000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=30000 ("}]}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&micro;s)"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Time"}]}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"Trie"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"17.12"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"17.27"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"17.47"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"S"}]},{"block_type":"text","content":")"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"Linear scan"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"1978.44"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"4075.72"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"6398.06"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":")"}]}]}]}]},{"block_type":"element","block":"k68ocnx2","search_text":"An interesting fact is that the implementation of patricia-trie is actually a single Python file; this clearly shows how simple and powerful a clever algorithm can be. For extra features and performance, other C-optimized trie libraries are also available, such as datrie and marisa-trie .","text_count":289,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An interesting fact is that the implementation of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"patricia-trie"}]},{"block_type":"text","content":"is actually a single Python file; this clearly shows how simple and powerful a clever algorithm can be. For extra features and performance, other C-optimized trie libraries are also available, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"datrie"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"marisa-trie"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnx3","search_text":"Caching and memoization","text_count":23,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Caching and memoization"}]},{"block_type":"element","block":"k68ocnx4","search_text":"Caching is a great technique used to improve the performance of a wide range of applications. The idea behind caching is to store expensive results in a temporary location, called cache, that can be located in memory, on-disk, or in a remote location.","text_count":251,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Caching is a great technique used to improve the performance of a wide range of applications. The idea behind caching is to store expensive results&nbsp;in a temporary location, called cache, that can be located in memory, on-disk, or in a remote location."}]},{"block_type":"element","block":"k68ocnx5","search_text":"Web applications make extensive use of caching. In a web application, it often happens that users request a certain page at the same time. In this case, instead of recomputing the page for each user, the web application can compute it once and serve the user the already rendered page. Ideally, caching also needs a mechanism for invalidation so that if the page needs to be updated, we can recompute it before serving it again. Intelligent caching allows web applications to handle increasing number of users with less resources. Caching can also be done preemptively, such as the later sections of the video get buffered when watching a video online.","text_count":652,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Web applications make extensive use of caching. In a web application, it often happens that users request a certain page at the same time. In this case, instead of recomputing the page for each user, the web application can compute it once and serve the user the already rendered page. Ideally, caching also needs a mechanism for invalidation so that if the page needs to be updated, we can recompute it before serving it again. Intelligent caching allows web applications to handle increasing number of users with less resources.&nbsp;Caching can also be done preemptively, such as the later sections of the video get buffered when watching a video online."}]},{"block_type":"element","block":"k68ocnx6","search_text":"Caching is also used to improve the performance of certain algorithms. A great example is computing the Fibonacci sequence. Since computing the next number in the Fibonacci sequence requires the previous number in the sequence, one can store and reuse previous results, dramatically improving the running time. Storing and reusing the results of the previous function calls in an application is usually termed as memoization , and is one of the forms of caching. Several other algorithms can take advantage of memoization to gain impressive performance improvements, and this programming technique is commonly referred to as dynamic programming .","text_count":646,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Caching is also used to improve the performance of certain algorithms. A great example is computing the Fibonacci sequence. Since computing the next number in the Fibonacci sequence requires the previous number in the sequence, one can store and reuse previous results, dramatically improving the running time. Storing and reusing the results of the previous function calls in an application is usually termed as&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"memoization"}]},{"block_type":"text","content":", and is one of the forms of caching. Several other algorithms can take advantage of memoization to gain impressive performance improvements, and this programming technique is commonly referred to as&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"dynamic programming"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnx7","search_text":"The benefits of caching, however, do not come for free. What we are actually doing is sacrificing some space to improve the speed of the application. Additionally, if the cache is stored in a location on the network, we may incur transfer costs and general time needed for communication. One should evaluate when it is convenient to use a cache and how much space we are willing to trade for an increase in speed.","text_count":413,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The benefits of caching, however, do not come for free. What we are actually doing is sacrificing some space to improve the speed of the application. Additionally, if the cache is stored in a location on the network, we may incur transfer costs and general time needed for communication. One should evaluate when it is convenient to use a cache and how much space we are willing to trade&nbsp;for an increase in speed."}]},{"block_type":"element","block":"k68ocnx8","search_text":"Given the usefulness of this technique, the Python standard library includes a simple in-memory cache out of the box in the functools module. The functools.lru_cache decorator can be used to easily cache the results of a function. In the following example, we create a function, sum2 , that prints a statement and returns the sum of two numbers. By running the function twice, you can see that the first time the sum2 function is executed the \"Calculating ...\" string is produced, while the second time the result is returned without running the function:","text_count":555,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Given the&nbsp;usefulness of this technique, the Python standard library includes a simple in-memory cache out of the box in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"functools"}]},{"block_type":"text","content":"&nbsp;module. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"functools.lru_cache"}]},{"block_type":"text","content":"decorator can be used to easily cache&nbsp;the results of a function. In the following example, we create a function,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum2"}]},{"block_type":"text","content":",&nbsp;that prints a statement and returns the sum of two numbers. By running the function twice, you can see that the first time the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum2"}]},{"block_type":"text","content":"&nbsp;function is executed the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"\"Calculating ...\""}]},{"block_type":"text","content":"string is produced, while the second time the result is returned without running the function:"}]},{"block_type":"element","block":"k68ocnx9","search_text":"from functools import lru_cache @lru_cache() def sum2(a, b): print(\"Calculating {} + {}\".format(a, b)) return a + b print(sum2(1, 2)) # Output: # Calculating 1 + 2 # 3 print(sum2(1, 2)) # Output: # 3 ","text_count":200,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from functools import lru_cache\n\n    @lru_cache()\n    def sum2(a, b):\n        print(\"Calculating {} + {}\".format(a, b))\n        return a + b\n\n    print(sum2(1, 2))\n    # Output: \n    # Calculating 1 + 2\n    # 3\n    print(sum2(1, 2))\n    # Output: \n    # 3"}]}]},{"block_type":"element","block":"k68ocnxa","search_text":"The lru_cache decorator also provides other basic features. To restrict the size of the cache, one can set the number of elements that we intend to maintain through the max_size argument. If we want our cache size to be unbounded, we can specify a value of None . An example usage of max_size is shown here:","text_count":307,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"lru_cache"}]},{"block_type":"text","content":"decorator also provides other basic features. To restrict the size of the cache, one can set&nbsp;the number of elements that we intend to maintain through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max_size"}]},{"block_type":"text","content":"&nbsp;argument. If we want our cache size to be unbounded, we can specify a value of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"None"}]},{"block_type":"text","content":". An example usage of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max_size"}]},{"block_type":"text","content":"is shown here:"}]},{"block_type":"element","block":"k68ocnxb","search_text":"@lru_cache(max_size=16) def sum2(a, b): ... ","text_count":44,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@lru_cache(max_size=16)\n    def sum2(a, b):\n        ..."}]}]},{"block_type":"element","block":"k68ocnxc","search_text":"In this way, as we execute sum2 with different arguments, the cache will reach a maximum size of 16 and, as we keep requesting more calculations, new values will replace older values in the cache. The lru prefix originates from this strategy, which means least recently used.","text_count":275,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this way, as we execute"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum2"}]},{"block_type":"text","content":"with different arguments, the cache will reach a maximum size of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"16"}]},{"block_type":"text","content":"and, as we keep requesting more calculations, new values&nbsp;will replace older values in the cache. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"lru"}]},{"block_type":"text","content":"prefix originates from&nbsp;this strategy, which means least recently used."}]},{"block_type":"element","block":"k68ocnxd","search_text":"The lru_cache decorator also adds extra functionalities to the decorated function. For example, it is possible to examine the cache performance using the cache_info method, and it is possible to reset the cache using the cache_clear method, as follows:","text_count":252,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"lru_cache"}]},{"block_type":"text","content":"decorator also adds extra functionalities to the decorated function. For example, it is possible to examine the cache performance using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cache_info"}]},{"block_type":"text","content":"method, and it is possible to reset the cache using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cache_clear"}]},{"block_type":"text","content":"method, as follows:"}]},{"block_type":"element","block":"k68ocnxe","search_text":"sum2.cache_info() # Output: CacheInfo(hits=0, misses=1, maxsize=128, currsize=1) sum2.cache_clear() ","text_count":100,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"sum2.cache_info()\n    # Output: CacheInfo(hits=0, misses=1, maxsize=128, currsize=1)\n    sum2.cache_clear()"}]}]},{"block_type":"element","block":"k68ocnxf","search_text":"As an example, we can see how a problem, such as computing the fibonacci series, may benefit from caching. We can define a fibonacci function and time its execution:","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As an example, we can see how a problem, such as computing the fibonacci series, may benefit from caching. We can define a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fibonacci"}]},{"block_type":"text","content":"function and time its execution:"}]},{"block_type":"element","block":"k68ocnxg","search_text":"def fibonacci(n): if n < 1: return 1 else: return fibonacci(n - 1) + fibonacci(n - 2) # Non-memoized version %timeit fibonacci(20) 100 loops, best of 3: 5.57 ms per loop ","text_count":170,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def fibonacci(n):\n        if n &lt; 1:\n            return 1\n        else:\n            return fibonacci(n - 1) + fibonacci(n - 2)\n\n    # Non-memoized version\n    %timeit fibonacci(20)\n    100 loops, best of 3: 5.57 ms per loop"}]}]},{"block_type":"element","block":"k68ocnxh","search_text":"The execution takes 5.57 ms, which is very high. The scaling of the function written in this way has poor performance; the previously computed fibonacci sequences are not reused, causing this algorithm to have an exponential scaling of roughly O ( 2 N ).","text_count":254,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The execution takes 5.57 ms, which is very high. The scaling of the function written in this way has poor performance; the previously computed fibonacci sequences&nbsp;are not reused, causing this algorithm to have an exponential scaling of roughly"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"2"},{"block_type":"element","tag_name":"sup","attributes":{},"children":[{"block_type":"text","content":"N"}]}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k68ocnxi","search_text":"Caching can improve this algorithm by storing and reusing the already-computed fibonacci numbers. To implement the cached version, it is sufficient to apply the lru_cache decorator to the original fibonacci function. Also, to design a proper benchmark, we need to ensure that a new cache is instantiated for every run; to do this, we can use the timeit.repeat function, as shown in the following example:","text_count":404,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Caching can improve this algorithm by storing and reusing the already-computed fibonacci numbers. To implement the cached version, it is sufficient to apply the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"lru_cache"}]},{"block_type":"text","content":"decorator to the original"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fibonacci"}]},{"block_type":"text","content":"function. Also, to design a proper benchmark, we need to ensure that a new cache is instantiated for every run; to do this, we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit.repeat"}]},{"block_type":"text","content":"function, as shown in the following example:"}]},{"block_type":"element","block":"k68ocnxj","search_text":"import timeit setup_code = ''' from functools import lru_cache from __main__ import fibonacci fibonacci_memoized = lru_cache(maxsize=None)(fibonacci) ''' results = timeit.repeat('fibonacci_memoized(20)', setup=setup_code, repeat=1000, number=1) print(\"Fibonacci took {:.2f} us\".format(min(results))) # Output: Fibonacci took 0.01 us ","text_count":333,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import timeit\n    setup_code = '''\n    from functools import lru_cache\n    from __main__ import fibonacci\n    fibonacci_memoized = lru_cache(maxsize=None)(fibonacci)\n    '''\n\n    results = timeit.repeat('fibonacci_memoized(20)',\n                            setup=setup_code,\n                            repeat=1000,\n                            number=1)\n    print(\"Fibonacci took {:.2f} us\".format(min(results)))\n    # Output: Fibonacci took 0.01 us"}]}]},{"block_type":"element","block":"k68ocnxk","search_text":"Even though we changed the algorithm by adding a simple decorator, the running time now is much less than a microsecond. The reason is that, thanks to caching, we now have a linear time algorithm instead of an exponential one.","text_count":226,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even though we changed the algorithm by adding&nbsp;a simple decorator, the running time now is much less than a microsecond. The reason is that, thanks to caching, we now have a linear time algorithm instead of&nbsp;an exponential one."}]},{"block_type":"element","block":"k68ocnxl","search_text":"The lru_cache decorator can be used to implement simple in-memory caching in your application. For more advanced use cases, third-party modules can be used for more powerful implementation and on-disk caching.","text_count":209,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"lru_cache"}]},{"block_type":"text","content":"&nbsp;decorator&nbsp;can be used to implement simple in-memory caching in your application. For more advanced use cases,&nbsp;third-party modules can be used for more powerful implementation and on-disk caching."}]},{"block_type":"element","block":"k68ocnxm","search_text":"Joblib","text_count":6,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Joblib"}]},{"block_type":"element","block":"k68ocnxn","search_text":"A simple library that, among other things, provides a simple on-disk cache is joblib . The package can be used in a similar way as lru_cache , except that the results will be stored on disk and will persist between runs.","text_count":220,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A simple library that, among other things, provides a simple on-disk cache is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"joblib"}]},{"block_type":"text","content":". The package can be used in a similar way as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"lru_cache"}]},{"block_type":"text","content":", except that the results will be stored on disk and will persist between runs."}]},{"block_type":"element","block":"k68ocnxo","search_text":"Note The joblib module can be installed from PyPI using the pip install joblib command. ","text_count":88,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"joblib"}]},{"block_type":"text","content":"module can be installed from PyPI using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip install joblib"}]},{"block_type":"text","content":"&nbsp;command."}]}]},{"block_type":"element","block":"k68ocnxp","search_text":"The joblib module provides the Memory class that can be used to memoize functions using the Memory.cache decorator:","text_count":115,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"joblib"}]},{"block_type":"text","content":"module provides the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Memory"}]},{"block_type":"text","content":"&nbsp;class that can be used to memoize functions using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Memory.cache"}]},{"block_type":"text","content":"decorator:"}]},{"block_type":"element","block":"k68ocnxq","search_text":"from joblib import Memory memory = Memory(cachedir='/path/to/cachedir') @memory.cache def sum2(a, b): return a + b ","text_count":115,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from joblib import Memory\n    memory = Memory(cachedir='/path/to/cachedir')\n\n    @memory.cache\n    def sum2(a, b):\n        return a + b"}]}]},{"block_type":"element","block":"k68ocnxr","search_text":"The function will behave similar to lru_cache , with the exception that the results will be stored on-disk in the directory specified by the cachedir argument during Memory initialization. Additionally, the cached results will persist over subsequent runs!","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The function will behave similar to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"lru_cache"}]},{"block_type":"text","content":", with the exception that the results will be stored on-disk in the directory specified by the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cachedir"}]},{"block_type":"text","content":"argument during"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Memory"}]},{"block_type":"text","content":"initialization. Additionally, the cached results will persist&nbsp;over subsequent&nbsp;runs!"}]},{"block_type":"element","block":"k68ocnxs","search_text":"The Memory.cache method also allows to limit recomputation only when certain arguments change, and the resulting decorated function supports basic functionalities to clear and analyze the cache. ","text_count":195,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Memory.cache"}]},{"block_type":"text","content":"method also allows to limit recomputation only when certain arguments change, and the resulting decorated function supports basic functionalities to clear and analyze the cache.&nbsp;"}]},{"block_type":"element","block":"k68ocnxt","search_text":"Perhaps the best joblib feature is that, thanks to intelligent hashing algorithms, it provides efficient memoization of functions that operate on numpy arrays, and is particularly useful in scientific and engineering applications.","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Perhaps the best&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"joblib"}]},{"block_type":"text","content":"&nbsp;feature is that, thanks to intelligent hashing algorithms, it provides efficient memoization of functions that operate on"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy"}]},{"block_type":"text","content":"arrays, and is particularly useful in scientific and engineering applications."}]},{"block_type":"element","block":"k68ocnxu","search_text":"Comprehensions and generators","text_count":29,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Comprehensions and generators"}]},{"block_type":"element","block":"k68ocnxv","search_text":"In this section, we will explore a few simple strategies to speed up Python loops using comprehension and generators. In Python, comprehension and generator expressions are fairly optimized operations and should be preferred in place of explicit for-loops. Another reason to use this construct is readability; even if the speedup over a standard loop is modest, the comprehension and generator syntax is more compact and (most of the times) more intuitive.","text_count":456,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will explore a few simple strategies to speed up Python loops using comprehension and generators. In Python, comprehension and generator expressions are fairly optimized operations and should be preferred in place of explicit for-loops. Another reason to use this construct is readability; even if the speedup over a standard loop is modest, the comprehension and generator syntax is more compact and (most of the times) more intuitive."}]},{"block_type":"element","block":"k68ocnxw","search_text":"In the following example, we can see that both the list comprehension and generator expressions are faster than an explicit loop when combined with the sum function:","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following example, we can see that both the list comprehension and generator expressions are faster than an explicit loop when combined with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum"}]},{"block_type":"text","content":"&nbsp;function:"}]},{"block_type":"element","block":"k68ocnxx","search_text":"def loop(): res = [] for i in range(100000): res.append(i * i) return sum(res) def comprehension(): return sum([i * i for i in range(100000)]) def generator(): return sum(i * i for i in range(100000)) %timeit loop() 100 loops, best of 3: 16.1 ms per loop %timeit comprehension() 100 loops, best of 3: 10.1 ms per loop %timeit generator() 100 loops, best of 3: 12.4 ms per loop ","text_count":377,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def loop(): \n        res = [] \n        for i in range(100000): \n            res.append(i * i) \n        return sum(res) \n\n    def comprehension(): \n        return sum([i * i for i in range(100000)]) \n\n    def generator(): \n        return sum(i * i for i in range(100000)) \n\n    %timeit loop() \n    100 loops, best of 3: 16.1 ms per loop \n    %timeit comprehension() \n    100 loops, best of 3: 10.1 ms per loop \n    %timeit generator() \n    100 loops, best of 3: 12.4 ms per loop"}]}]},{"block_type":"element","block":"k68ocnxy","search_text":"Just like lists, it is possible to use dict comprehension to build dictionaries slightly more efficiently and compactly, as shown in the following code:","text_count":152,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Just like lists, it is possible to use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dict"}]},{"block_type":"text","content":"comprehension&nbsp;to build dictionaries slightly more efficiently and compactly, as shown in the following code:"}]},{"block_type":"element","block":"k68ocnxz","search_text":"def loop(): res = {} for i in range(100000): res[i] = i return res def comprehension(): return {i: i for i in range(100000)} %timeit loop() 100 loops, best of 3: 13.2 ms per loop %timeit comprehension() 100 loops, best of 3: 12.8 ms per loop ","text_count":242,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def loop(): \n        res = {} \n        for i in range(100000): \n            res[i] = i\n        return res\n\n    def comprehension(): \n        return {i: i for i in range(100000)}\n    %timeit loop() \n    100 loops, best of 3: 13.2 ms per loop \n    %timeit comprehension() \n    100 loops, best of 3: 12.8 ms per loop"}]}]},{"block_type":"element","block":"k68ocny0","search_text":"Efficient looping (especially in terms of memory) can be implemented using iterators and functions such as filter and map . As an example, consider the problem of applying a series of operations to a list using list comprehension and then taking the maximum value:","text_count":264,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Efficient looping (especially in terms of memory) can be implemented using iterators and functions such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"filter"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":". As an example, consider the problem of applying a series of operations to a list using list comprehension and then taking the maximum value:"}]},{"block_type":"element","block":"k68ocny1","search_text":"def map_comprehension(numbers): a = [n * 2 for n in numbers] b = [n ** 2 for n in a] c = [n ** 0.33 for n in b] return max(c) ","text_count":126,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def map_comprehension(numbers):\n        a = [n * 2 for n in numbers]\n        b = [n ** 2 for n in a]\n        c = [n ** 0.33 for n in b]\n        return max(c)"}]}]},{"block_type":"element","block":"k68ocny2","search_text":"The problem with this approach is that for every list comprehension, we are allocating a new list, increasing memory usage. Instead of using list comprehension, we can employ generators. Generators are objects that, when iterated upon, compute a value on the fly and return the result.","text_count":285,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The problem with this approach is that for every list comprehension, we are allocating a new list, increasing memory usage. Instead of using list comprehension, we can employ generators. Generators are objects that, when iterated upon, compute a value on the fly and return the result."}]},{"block_type":"element","block":"k68ocny3","search_text":"For example, the map function takes two arguments--a function and an iterator--and returns a generator that applies the function to every element of the collection. The important point is that the operation happens only while we are iterating , and not when map is invoked!","text_count":273,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For example, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"&nbsp;function takes two arguments--a function and an iterator--and returns a generator that applies the function to every element of the collection. The important point is that the operation happens only"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"while we are iterating"}]},{"block_type":"text","content":", and not when"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"is invoked!"}]},{"block_type":"element","block":"k68ocny4","search_text":"We can rewrite the previous function using map and by creating intermediate generators, rather than lists, thus saving memory by computing the values on the fly:","text_count":161,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can rewrite the previous function using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"and by creating intermediate generators, rather than lists, thus saving memory by computing the values on the fly:"}]},{"block_type":"element","block":"k68ocny5","search_text":"def map_normal(numbers): a = map(lambda n: n * 2, numbers) b = map(lambda n: n ** 2, a) c = map(lambda n: n ** 0.33, b) return max(c) ","text_count":134,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def map_normal(numbers):\n        a = map(lambda n: n * 2, numbers)\n        b = map(lambda n: n ** 2, a)\n        c = map(lambda n: n ** 0.33, b)\n        return max(c)"}]}]},{"block_type":"element","block":"k68ocny6","search_text":"We can profile the memory of the two solutions using the memory_profiler extension from an IPython session. The extension provides a small utility, %memit , that will help us evaluate the memory usage of a Python statement in a way similar to %timeit , as illustrated in the following snippet:","text_count":293,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can profile the memory of the two solutions using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"memory_profiler"}]},{"block_type":"text","content":"extension from an IPython session. The extension provides a small utility,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%memit"}]},{"block_type":"text","content":", that will help us evaluate the memory usage of a Python statement in a way similar to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%timeit"}]},{"block_type":"text","content":", as illustrated in the following snippet:"}]},{"block_type":"element","block":"k68ocny7","search_text":"%load_ext memory_profiler numbers = range(1000000) %memit map_comprehension(numbers) peak memory: 166.33 MiB, increment: 102.54 MiB %memit map_normal(numbers) peak memory: 71.04 MiB, increment: 0.00 MiB ","text_count":203,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%load_ext memory_profiler\n    numbers = range(1000000)\n    %memit map_comprehension(numbers)\n    peak memory: 166.33 MiB, increment: 102.54 MiB\n    %memit map_normal(numbers)\n    peak memory: 71.04 MiB, increment: 0.00 MiB"}]}]},{"block_type":"element","block":"k68ocny8","search_text":"As you can see, the memory used by the first version is 102.54 MiB , while the second version consumes 0.00 MiB ! For the interested reader, more functions that return generators can be found in the itertools module, which provides a set of utilities designed to handle common iteration patterns.","text_count":296,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, the memory used by the first version is&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"102.54 MiB"}]},{"block_type":"text","content":", while the second version consumes"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0.00 MiB"}]},{"block_type":"text","content":"! For the interested reader, more functions that return generators can be found in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"itertools"}]},{"block_type":"text","content":"module, which provides a set of utilities designed to handle common iteration patterns."}]},{"block_type":"element","block":"k68ocny9","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k68ocnya","search_text":"Algorithmic optimization can improve how your application scales as we process increasingly large data. In this chapter, we demonstrated use-cases and running times of the most common data structures available in Python, such as lists, deques, dictionaries, heaps, and tries. We also covered caching, a technique that can be used to trade some space, in memory or on-disk, in exchange for increased responsiveness of an application. We also demonstrated how to get modest speed gains by replacing for-loops with fast constructs, such as list comprehensions and generator expressions.","text_count":583,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Algorithmic optimization can improve how your application scales as we process increasingly large data. In this chapter, we demonstrated&nbsp;use-cases and running times of the most common data structures available in Python, such as lists, deques, dictionaries, heaps, and tries. We also covered caching, a technique that can be used&nbsp;to trade&nbsp;some space, in memory or on-disk,&nbsp;in exchange for increased&nbsp;responsiveness of an application. We also demonstrated how&nbsp;to get modest speed gains by replacing for-loops with fast constructs, such as list comprehensions and generator expressions."}]},{"block_type":"element","block":"k68ocnyb","search_text":"In the subsequent chapters, we will learn how to improve performance further using numerical libraries such as numpy , and how to write extension modules in a lower-level language with the help of Cython .","text_count":205,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the subsequent&nbsp;chapters, we will learn how to improve performance&nbsp;further using numerical libraries such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy"}]},{"block_type":"text","content":", and how to write extension modules in a lower-level language with the help of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Cython"}]},{"block_type":"text","content":"."}]}]},{"title":"Fast Array Operations with NumPy and Pandas","author":"Gabriele Lanaro","block":"k68ocgq5","number":3,"contents":[{"block_type":"element","block":"k68ocnyc","search_text":"NumPy is the de facto standard for scientific computing in Python. It extends Python with a flexible multidimensional array that allows fast and concise mathematical calculations.","text_count":179,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"NumPy is the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"de facto"}]},{"block_type":"text","content":"standard for scientific computing in Python. It extends Python with a flexible multidimensional array that allows fast and concise mathematical calculations."}]},{"block_type":"element","block":"k68ocnyd","search_text":"NumPy provides common data structures and algorithms designed to express complex mathematical operations using a concise syntax. The multidimensional array, numpy.ndarray , is internally based on C arrays. Apart from the performance benefits, this choice allows NumPy code to easily interface with the existing C and FORTRAN routines; NumPy is helpful in bridging the gap between Python and the legacy code written using those languages.","text_count":437,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"NumPy provides common data structures and algorithms designed to express&nbsp;complex mathematical operations using a concise syntax. The multidimensional array,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.ndarray"}]},{"block_type":"text","content":",&nbsp;is internally based on C arrays. Apart from the performance benefits, this choice allows NumPy code to easily interface with the existing C and FORTRAN routines; NumPy is helpful in bridging the gap between Python and the legacy code written using those languages."}]},{"block_type":"element","block":"k68ocnye","search_text":"In this chapter, we will learn how to create and manipulate NumPy arrays. We will also explore the NumPy broadcasting feature used to rewrite complex mathematical expressions in an efficient and succinct manner.","text_count":211,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will learn how to create and manipulate NumPy arrays. We will also explore the NumPy broadcasting feature used to rewrite complex mathematical expressions in an efficient and succinct manner."}]},{"block_type":"element","block":"k68ocnyf","search_text":"Pandas is a tool that relies heavily on NumPy and provides additional data structures and algorithms targeted toward data analysis. We will introduce the main Pandas features and its usage. We will also learn how to achieve high performance from Pandas data structures and vectorized operations. ","text_count":296,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Pandas is a tool that relies heavily on NumPy and provides additional&nbsp;data structures and algorithms targeted toward data analysis. We will introduce the main Pandas features and its usage. &nbsp;We will also learn how to achieve high performance from Pandas data structures and vectorized operations.&nbsp;"}]},{"block_type":"element","block":"k68ocnyg","search_text":"The topics covered in this chapter are as follows:","text_count":50,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The topics covered&nbsp;in this chapter are as follows:"}]},{"block_type":"element","block":"k68ocnyh","search_text":"Creating and manipulating NumPy arrays Mastering NumPy's broadcasting feature for fast and succinct vectorized operations Improving our particle simulator with NumPy Reaching optimal performance with numexpr Pandas fundamentals Database-style operations with Pandas ","text_count":266,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Creating and manipulating NumPy arrays"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Mastering&nbsp;NumPy's broadcasting feature for fast and succinct vectorized operations"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Improving our particle simulator with NumPy"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Reaching optimal performance with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Pandas fundamentals"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Database-style operations with Pandas"}]}]},{"block_type":"element","block":"k68ocnyi","search_text":"Getting started with NumPy","text_count":26,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Getting started with NumPy"}]},{"block_type":"element","block":"k68ocnyj","search_text":"The NumPy library revolves around its multidimensional array object, numpy.ndarray . NumPy arrays are collections of elements of the same data type; this fundamental restriction allows NumPy to pack the data in a way that allows for high-performance mathematical operations.","text_count":274,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The NumPy library revolves around its multidimensional array object,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.ndarray"}]},{"block_type":"text","content":". NumPy arrays are collections of elements of the same data type; this fundamental restriction allows NumPy to pack the data in a way that allows for high-performance mathematical operations."}]},{"block_type":"element","block":"k68ocnyk","search_text":"Creating arrays","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Creating arrays"}]},{"block_type":"element","block":"k68ocnyl","search_text":"You can create NumPy arrays using the numpy.array function. It takes a list-like object (or another array) as input and, optionally, a string expressing its data type. You can interactively test array creation using an IPython shell, as follows:","text_count":245,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can create NumPy arrays using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.array"}]},{"block_type":"text","content":"function. It takes a list-like object (or another array) as input and, optionally, a string expressing its data type. You can interactively test array creation using an IPython shell, as follows:"}]},{"block_type":"element","block":"k68ocnym","search_text":"import numpy as np a = np.array([0, 1, 2]) ","text_count":43,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np \n    a = np.array([0, 1, 2])"}]}]},{"block_type":"element","block":"k68ocnyn","search_text":"Every NumPy array has an associated data type that can be accessed using the dtype attribute. If we inspect the a array, we find that its dtype is int64 , which stands for 64-bit integer:","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Every NumPy array has&nbsp;an associated data type that can be accessed using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dtype"}]},{"block_type":"text","content":"attribute. If we inspect the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"array,&nbsp;we find that its &nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dtype"}]},{"block_type":"text","content":"is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int64"}]},{"block_type":"text","content":", which stands for&nbsp;64-bit integer:"}]},{"block_type":"element","block":"k68ocnyo","search_text":"a.dtype # Result: # dtype('int64') ","text_count":35,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a.dtype \n    # Result: \n    # dtype('int64')"}]}]},{"block_type":"element","block":"k68ocnyp","search_text":"We may decide to convert those integer numbers to float type. To do this, we can either pass the dtype argument at array initialization or cast the array to another data type using the astype method. The two ways to select a data type are shown in the following code:","text_count":267,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We may decide to convert those integer numbers to&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float"}]},{"block_type":"text","content":"type. To do this,&nbsp;we can either pass the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dtype"}]},{"block_type":"text","content":"argument at array initialization&nbsp;or cast the array to another data type using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"astype"}]},{"block_type":"text","content":"method. The two ways to select a data type are shown in the following code:"}]},{"block_type":"element","block":"k68ocnyq","search_text":"a = np.array([1, 2, 3], dtype='float32') a.astype('float32') # Result: # array([ 0., 1., 2.], dtype=float32) ","text_count":109,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.array([1, 2, 3], dtype='float32') \n    a.astype('float32') \n    # Result:\n    # array([ 0.,  1.,  2.], dtype=float32)"}]}]},{"block_type":"element","block":"k68ocnyr","search_text":"To create an array with two dimensions (an array of arrays), we can perform the initialization using a nested sequence, as follows:","text_count":131,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To create an array with two dimensions (an array of arrays), we can perform the initialization using a nested sequence, as follows:"}]},{"block_type":"element","block":"k68ocnys","search_text":"a = np.array([[0, 1, 2], [3, 4, 5]]) print(a) # Output: # [[0 1 2] # [3 4 5]] ","text_count":78,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.array([[0, 1, 2], [3, 4, 5]]) \n    print(a) \n    # Output:\n    # [[0 1 2]\n    #  [3 4 5]]"}]}]},{"block_type":"element","block":"k68ocnyt","search_text":"The array created in this way has two dimensions, which are called axes in NumPy's jargon. An array formed in this way is like a table that contains two rows and three columns. We can access the axes using the ndarray.shape attribute:","text_count":234,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The array created in this way has two dimensions, which are called&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"axes"}]},{"block_type":"text","content":"&nbsp;in NumPy's jargon. An&nbsp;array formed in this way is like a table that contains two rows and three columns. We can access the axes&nbsp;using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ndarray.shape"}]},{"block_type":"text","content":"attribute:"}]},{"block_type":"element","block":"k68ocnyu","search_text":"a.shape # Result: # (2, 3) ","text_count":27,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a.shape \n    # Result:\n    # (2, 3)"}]}]},{"block_type":"element","block":"k68ocnyv","search_text":"Arrays can also be reshaped as long as the product of the shape dimensions is equal to the total number of elements in the array (that is, the total number of elements is conserved). For example, we can reshape an array containing 16 elements in the following ways: (2, 8) , (4, 4) , or (2, 2, 4) . To reshape an array, we can either use the ndarray.reshape method or assign a new value to the ndarray.shape tuple. The following code illustrates the use of the ndarray.reshape method:","text_count":484,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Arrays can also be reshaped as long as the product of the shape dimensions is equal to the total number of elements in the array (that is,&nbsp;the total number of elements is conserved). For example, we can reshape an array containing 16 elements in the following ways:"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2, 8)"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(4, 4)"}]},{"block_type":"text","content":", or"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2, 2, 4)"}]},{"block_type":"text","content":". To reshape an array, we can either use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ndarray.reshape"}]},{"block_type":"text","content":"method or assign a new value to&nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ndarray.shape"}]},{"block_type":"text","content":"&nbsp;tuple. The following code illustrates the use of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ndarray.reshape"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k68ocnyw","search_text":"a = np.array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]) a.shape # Output: # (16,) a.reshape(4, 4) # Equivalent: a.shape = (4, 4) # Output: # array([[ 0, 1, 2, 3], # [ 4, 5, 6, 7], # [ 8, 9, 10, 11], # [12, 13, 14, 15]]) ","text_count":233,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.array([0, 1, 2, 3, 4, 5, 6, 7, 8, \n                  9, 10, 11, 12, 13, 14, 15]) \n    a.shape \n    # Output:\n    # (16,)\n\n    a.reshape(4, 4) # Equivalent: a.shape = (4, 4) \n    # Output: \n    # array([[ 0,  1,  2,  3],\n    #        [ 4,  5,  6,  7],\n    #        [ 8,  9, 10, 11],\n    #        [12, 13, 14, 15]])"}]}]},{"block_type":"element","block":"k68ocnyx","search_text":"Thanks to this property, you can freely add dimensions of size one. You can reshape an array with 16 elements to (16, 1) , (1, 16) , (16, 1, 1) , and so on. In the next section, we will extensively use this feature to implement complex operations through broadcasting . ","text_count":270,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Thanks to this property, you can freely add dimensions of size one. You can reshape an array with 16 elements to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(16, 1)"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(1, 16)"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(16, 1, 1)"}]},{"block_type":"text","content":", and so on. In the next section, we will extensively use this feature to implement complex operations through&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"broadcasting"}]},{"block_type":"text","content":".&nbsp;"}]},{"block_type":"element","block":"k68ocnyy","search_text":"NumPy provides convenience functions, shown in the following code, to create arrays filled with zeros, ones, or with no initial value (in this case, their actual value is meaningless and depends on the memory state). Those functions take the array shape as a tuple and, optionally, its dtype :","text_count":293,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"NumPy provides convenience functions, shown in the following code, to create arrays filled with zeros, ones, or with no&nbsp;initial value (in this case, their actual value is meaningless and depends on the memory state). Those functions take the array shape as a tuple and, optionally, its"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dtype"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocnyz","search_text":"np.zeros((3, 3)) np.empty((3, 3)) np.ones((3, 3), dtype='float32') ","text_count":67,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"np.zeros((3, 3)) \n    np.empty((3, 3)) \n    np.ones((3, 3), dtype='float32')"}]}]},{"block_type":"element","block":"k68ocnz0","search_text":"In our examples, we will use the numpy.random module to generate random floating point numbers in the (0, 1) interval. The numpy.random.rand will take a shape and return an array of random numbers with that shape:","text_count":213,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In our examples, we will use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.random"}]},{"block_type":"text","content":"module to generate random floating point numbers in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(0, 1)"}]},{"block_type":"text","content":"interval. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.random.rand"}]},{"block_type":"text","content":"&nbsp;will take a shape and return an array of random numbers with that shape:"}]},{"block_type":"element","block":"k68ocnz1","search_text":"np.random.rand(3, 3) ","text_count":21,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"np.random.rand(3, 3)"}]}]},{"block_type":"element","block":"k68ocnz2","search_text":"Sometimes it is convenient to initialize arrays that have the same shape as that of some other array. For that purpose, NumPy provides some handy functions, such as zeros_like , empty_like , and ones_like . These functions can be used as follows:","text_count":246,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sometimes it is convenient to initialize arrays that have the same shape as that of some other array. For that purpose, NumPy provides some handy functions, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"zeros_like"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"empty_like"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ones_like"}]},{"block_type":"text","content":". These functions can be used as follows:"}]},{"block_type":"element","block":"k68ocnz3","search_text":"np.zeros_like(a) np.empty_like(a) np.ones_like(a) ","text_count":50,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"np.zeros_like(a) \n    np.empty_like(a) \n    np.ones_like(a)"}]}]},{"block_type":"element","block":"k68ocnz4","search_text":"Accessing arrays","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Accessing arrays"}]},{"block_type":"element","block":"k68ocnz5","search_text":"The NumPy array interface is, on a shallow level, similar to that of Python lists. NumPy arrays can be indexed using integers and iterated using a for loop:","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The NumPy array interface is, on a shallow level, similar to that of Python lists. NumPy arrays can be indexed using integers and iterated using a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"for"}]},{"block_type":"text","content":"loop:"}]},{"block_type":"element","block":"k68ocnz6","search_text":"A = np.array([0, 1, 2, 3, 4, 5, 6, 7, 8]) A[0] # Result: # 0 [a for a in A] # Result: # [0, 1, 2, 3, 4, 5, 6, 7, 8] ","text_count":116,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"A = np.array([0, 1, 2, 3, 4, 5, 6, 7, 8]) \n    A[0] \n    # Result:\n    # 0 \n\n    [a for a in A] \n    # Result:\n    # [0, 1, 2, 3, 4, 5, 6, 7, 8]"}]}]},{"block_type":"element","block":"k68ocnz7","search_text":"In NumPy, array elements and sub-arrays can be conveniently accessed by using multiple values separated by commas inside the subscript operator, [] . If we take a (3,3) array (an array containing three triplets), and we access the element with index 0 , we obtain the first row, as follows:","text_count":290,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In NumPy, array elements and sub-arrays can be conveniently accessed by using multiple values separated by commas inside&nbsp;the subscript operator,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"[]"}]},{"block_type":"text","content":". If we take a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3,3)"}]},{"block_type":"text","content":"array (an array containing three triplets), and we access&nbsp;the element with index"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":", we obtain the first row, as follows:"}]},{"block_type":"element","block":"k68ocnz8","search_text":"A = np.array([[0, 1, 2], [3, 4, 5], [6, 7, 8]]) A[0] # Result: # array([0, 1, 2]) ","text_count":82,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"A = np.array([[0, 1, 2], [3, 4, 5], [6, 7, 8]]) \n    A[0] \n    # Result:\n    # array([0, 1, 2])"}]}]},{"block_type":"element","block":"k68ocnz9","search_text":"We can index the row again by adding another index separated by a comma. To get the second element of the first row, we can use the (0, 1) index. An important observation is that the A[0, 1] notation is actually a shorthand for A[(0, 1)] , that is, we are actually indexing using a tuple ! Both the versions are shown in the following snippet:","text_count":343,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can index the row&nbsp;again by adding another index separated by a comma. To get the second element of the first row, we can use the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(0, 1)"}]},{"block_type":"text","content":"index. An important observation is that the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"A[0, 1]"}]},{"block_type":"text","content":"notation is actually a shorthand for"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"A[(0, 1)]"}]},{"block_type":"text","content":", that is, we are actually indexing using a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"tuple"}]},{"block_type":"text","content":"! Both the versions are shown in the following snippet:"}]},{"block_type":"element","block":"k68ocnza","search_text":"A[0, 1] # Result: # 1 # Equivalent version using tuple A[(0, 1)] ","text_count":65,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"A[0, 1] \n    # Result:\n    # 1\n\n    # Equivalent version using tuple\n    A[(0, 1)]"}]}]},{"block_type":"element","block":"k68ocnzb","search_text":"NumPy allows you to slice arrays into multiple dimensions. If we slice on the first dimension, we can obtain a collection of triplets, shown as follows:","text_count":152,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"NumPy allows you to slice arrays into multiple dimensions. If we slice&nbsp;on the first dimension, we can obtain a collection of triplets, shown as follows:"}]},{"block_type":"element","block":"k68ocnzc","search_text":"A[0:2] # Result: # array([[0, 1, 2], # [3, 4, 5]]) ","text_count":51,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"A[0:2] \n    # Result:\n    # array([[0, 1, 2], \n    #        [3, 4, 5]])"}]}]},{"block_type":"element","block":"k68ocnzd","search_text":"If we slice the array again on the second dimension with 0:2 , we are basically extracting the first two elements from the collection of triplets shown earlier. This results in an array of shape (2, 2) , shown in the following code:","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we slice the array again on the second dimension with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0:2"}]},{"block_type":"text","content":", we are basically extracting&nbsp;the first two elements from the collection of triplets shown earlier. This results in an array of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2, 2)"}]},{"block_type":"text","content":", shown in the following code:"}]},{"block_type":"element","block":"k68ocnze","search_text":"A[0:2, 0:2] # Result: # array([[0, 1], # [3, 4]]) ","text_count":50,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"A[0:2, 0:2] \n    # Result:\n    # array([[0, 1], \n    #        [3, 4]])"}]}]},{"block_type":"element","block":"k68ocnzf","search_text":"Intuitively, you can update the values in the array using both numerical indexes and slices. An example is illustrated in the following code snippet:","text_count":149,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Intuitively, you can update the values in the array using both numerical indexes and slices. An example is illustrated in the following code snippet:"}]},{"block_type":"element","block":"k68ocnzg","search_text":"A[0, 1] = 8 A[0:2, 0:2] = [[1, 1], [1, 1]] ","text_count":43,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"A[0, 1] = 8 \n    A[0:2, 0:2] = [[1, 1], [1, 1]]"}]}]},{"block_type":"element","block":"k68ocnzh","search_text":"Indexing with the slicing syntax is very fast because, unlike lists, it doesn't produce a copy of the array. In NumPy's terminology, it returns a view of the same memory area. If we take a slice of the original array, and then we change one of its values, the original array will be updated as well. The following code illustrates an example of this feature:","text_count":358,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Indexing with the slicing syntax is very fast because, unlike lists, it doesn't produce&nbsp;a copy of the array. In NumPy's terminology, it returns a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"view"}]},{"block_type":"text","content":"of the same memory area. If we take a slice of the original array, and then we change one of its values, the original array will be updated as well. The following code illustrates an example of this feature:"}]},{"block_type":"element","block":"k68ocnzi","search_text":"a= np.array([1, 1, 1, 1]) a_view = a[0:2] a_view[0] = 2 print(a) # Output: # [2 1 1 1] ","text_count":87,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a= np.array([1, 1, 1, 1]) \n    a_view = a[0:2] \n    a_view[0] = 2 \n    print(a) \n    # Output:\n    # [2 1 1 1]"}]}]},{"block_type":"element","block":"k68ocnzj","search_text":"It is important to be extra careful when mutating NumPy arrays. Since views share data, changing the values of a view can result in hard-to-find bugs. To prevent side effects, you can set the a.flags.writeable = False flag, which will prevent accidental mutation of the array or any of its views.","text_count":296,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is important to be extra&nbsp;careful when mutating NumPy arrays. Since views share data, changing the values of a view&nbsp;can result in hard-to-find bugs. To prevent side effects, you can set the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a.flags.writeable = False"}]},{"block_type":"text","content":"flag,&nbsp;which will prevent accidental mutation of the array or any of its views."}]},{"block_type":"element","block":"k68ocnzk","search_text":"We can take a look at another example that shows how the slicing syntax can be used in a real-world setting. We define an r_i array, shown in the following line of code, which contains a set of 10 coordinates ( x , y ). Its shape will be (10, 2) :","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can take a look at another example that shows how the slicing syntax can be used in a real-world setting. We define an"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"r_i"}]},{"block_type":"text","content":"array, shown in the following line of code, which contains a set of 10 coordinates ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"). Its shape will be"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(10, 2)"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocnzl","search_text":"r_i = np.random.rand(10, 2) ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"r_i = np.random.rand(10, 2)"}]}]},{"block_type":"element","block":"k68ocnzm","search_text":"Tip If you have a hard time distinguishing arrays that differ in the axes order, for example between an a array of shape (10, 2) and (2, 10) , it is useful to think that every time you say the word of , you should introduce a new dimension. An array with ten elements of size two will be (10, 2) . Conversely, an array with two elements of size ten will be (2, 10) . ","text_count":367,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you have a hard time distinguishing arrays that differ in the axes order, for example between an a array of shape&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(10, 2)"}]},{"block_type":"text","content":"&nbsp;and&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2, 10)"}]},{"block_type":"text","content":", it is useful to think that every time you say the word"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"of"}]},{"block_type":"text","content":", you should&nbsp;introduce a new dimension. An array with ten elements"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"of"}]},{"block_type":"text","content":"size two will be"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(10, 2)"}]},{"block_type":"text","content":". Conversely, an array with two elements"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"of"}]},{"block_type":"text","content":"size ten will be"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2, 10)"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68ocnzn","search_text":"A typical operation we may be interested in is the extraction of the x component from each coordinate. In other words, you want to extract the (0, 0) , (1, 0) , (2, 0) , and so on items, resulting in an array with shape (10,) . It is helpful to think that the first index is moving while the second one is fixed (at 0 ). With this in mind, we will slice every index on the first axis (the moving one) and take the first element (the fixed one) on the second axis, as shown in the following line of code:","text_count":503,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A typical operation we may be interested in is the extraction of the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"component from each coordinate. In other words, you want to extract the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(0, 0)"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(1, 0)"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2, 0)"}]},{"block_type":"text","content":", and so on items, resulting in an array with shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(10,)"}]},{"block_type":"text","content":". It is helpful to think that the first index is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"moving"}]},{"block_type":"text","content":"while the second one is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"fixed"}]},{"block_type":"text","content":"(at"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"). With this in mind, we will slice every index on the first axis (the moving one) and take the first element (the fixed one) on the second axis, as shown in the following line of code:"}]},{"block_type":"element","block":"k68ocnzo","search_text":"x_i = r_i[:, 0] ","text_count":16,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"x_i = r_i[:, 0]"}]}]},{"block_type":"element","block":"k68ocnzp","search_text":"On the other hand, the following expression will keep the first index fixed and the second index moving, returning the first ( x , y ) coordinate:","text_count":146,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other hand, the following expression will keep the first index fixed and the second index moving, returning the first ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":") coordinate:"}]},{"block_type":"element","block":"k68ocnzq","search_text":"r_0 = r_i[0, :] ","text_count":16,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"r_0 = r_i[0, :]"}]}]},{"block_type":"element","block":"k68ocnzr","search_text":"Slicing all the indexes over the last axis is optional; using r_i[0] has the same effect as r_i[0, :] .","text_count":103,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Slicing all the indexes over the last axis is optional; using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"r_i[0]"}]},{"block_type":"text","content":"has the same effect as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"r_i[0, :]"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnzs","search_text":"NumPy allows you to index an array using another NumPy array made of either integer or Boolean values--a feature called fancy indexing .","text_count":136,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"NumPy allows you to index an array using another NumPy array made of either integer or Boolean values--a feature called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"fancy indexing"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocnzt","search_text":"If you index an array (say, a ) with another array of integers (say, idx ), NumPy will interpret the integers as indexes and will return an array containing their corresponding values. If we index an array containing 10 elements with np.array([0, 2, 3]) , we obtain an array of shape (3,) containing the elements at positions 0 , 2 , and 3 . The following code gives us an illustration of this concept:","text_count":402,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you index an array (say,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":") with another array of integers (say,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"idx"}]},{"block_type":"text","content":"), NumPy will interpret the integers as indexes and will return an array containing their corresponding values. If we index an array containing 10 elements with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.array([0, 2, 3])"}]},{"block_type":"text","content":", we obtain an array of shape&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3,)"}]},{"block_type":"text","content":"containing the elements at positions"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"2"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"3"}]},{"block_type":"text","content":". The following code gives us an illustration of this concept:"}]},{"block_type":"element","block":"k68ocnzu","search_text":"a = np.array([9, 8, 7, 6, 5, 4, 3, 2, 1, 0]) idx = np.array([0, 2, 3]) a[idx] # Result: # array([9, 7, 6]) ","text_count":107,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.array([9, 8, 7, 6, 5, 4, 3, 2, 1, 0]) \n    idx = np.array([0, 2, 3]) \n    a[idx] \n    # Result:\n    # array([9, 7, 6])"}]}]},{"block_type":"element","block":"k68ocnzv","search_text":"You can use fancy indexing on multiple dimensions by passing an array for each dimension. If we want to extract the (0, 2) and (1, 3) elements, we have to pack all the indexes acting on the first axis in one array, and the ones acting on the second axis in another. This can be seen in the following code:","text_count":305,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can use fancy indexing on multiple dimensions by passing an array for each dimension. If we want to extract the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(0, 2)"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(1, 3)"}]},{"block_type":"text","content":"elements, we have to pack all the indexes acting on the first axis in one array, and the ones acting on the second axis in another. This can be seen in the following code:"}]},{"block_type":"element","block":"k68ocnzw","search_text":"a = np.array([[0, 1, 2], [3, 4, 5], [6, 7, 8], [9, 10, 11]]) idx1 = np.array([0, 1]) idx2 = np.array([2, 3]) a[idx1, idx2] ","text_count":123,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.array([[0, 1, 2], [3, 4, 5], \n                  [6, 7, 8], [9, 10, 11]]) \n    idx1 = np.array([0, 1]) \n    idx2 = np.array([2, 3]) \n    a[idx1, idx2]"}]}]},{"block_type":"element","block":"k68ocnzx","search_text":"You can also use normal lists as index arrays, but not tuples. For example, the following two statements are equivalent:","text_count":120,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can also use normal lists as index arrays, but not tuples. For example, the following two statements are equivalent:"}]},{"block_type":"element","block":"k68ocnzy","search_text":"a[np.array([0, 1])] # is equivalent to a[[0, 1]] ","text_count":49,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a[np.array([0, 1])] # is equivalent to\n    a[[0, 1]]"}]}]},{"block_type":"element","block":"k68ocnzz","search_text":"However, if you use a tuple, NumPy will interpret the following statement as an index on multiple dimensions:","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, if you use a tuple, NumPy will interpret the following statement as an index on multiple dimensions:"}]},{"block_type":"element","block":"k68oco00","search_text":"a[(0, 1)] # is equivalent to a[0, 1] ","text_count":37,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a[(0, 1)] # is equivalent to\n    a[0, 1]"}]}]},{"block_type":"element","block":"k68oco01","search_text":"The index arrays are not required to be one-dimensional; we can extract elements from the original array in any shape. For example, we can select elements from the original array to form a (2,2) array, as shown:","text_count":211,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The index arrays are not required to be one-dimensional; we can extract elements from the original array in any shape. For example, we can select elements from the original array to form a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2,2)"}]},{"block_type":"text","content":"array, as shown:"}]},{"block_type":"element","block":"k68oco02","search_text":"idx1 = [[0, 1], [3, 2]] idx2 = [[0, 2], [1, 1]] a[idx1, idx2] # Output: # array([[ 0, 5], # [10, 7]]) ","text_count":102,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"idx1 = [[0, 1], [3, 2]] \n    idx2 = [[0, 2], [1, 1]] \n    a[idx1, idx2] \n    # Output: \n    # array([[ 0,  5],\n    #        [10,  7]])"}]}]},{"block_type":"element","block":"k68oco03","search_text":"The array slicing and fancy-indexing features can be combined. This is useful, for instance, when we want to swap the x and y columns in a coordinate array. In the following code, the first index will be running over all the elements (a slice) and, for each of those, we extract the element in position 1 (the y ) first and then the one in position 0 (the x ):","text_count":360,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The array slicing and fancy-indexing features can be combined. This is useful, for instance, when we want to swap the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"columns in a coordinate array. In the following code, the first index will be running over all the elements (a slice) and, for each of those, we extract the element in position"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"(the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":") first and then the one in position"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"(the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k68oco04","search_text":"r_i = np.random(10, 2) r_i[:, [0, 1]] = r_i[:, [1, 0]] ","text_count":55,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"r_i = np.random(10, 2) \n    r_i[:, [0, 1]] = r_i[:, [1, 0]]"}]}]},{"block_type":"element","block":"k68oco05","search_text":"When the index array is of the bool type, the rules are slightly different. The bool array will act like a mask ; every element corresponding to True will be extracted and put in the output array. This procedure is shown in the following code:","text_count":243,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When the index array is of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bool"}]},{"block_type":"text","content":"type, the rules are slightly different. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bool"}]},{"block_type":"text","content":"&nbsp;array will act like a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"mask"}]},{"block_type":"text","content":"; every element corresponding to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"True"}]},{"block_type":"text","content":"will be extracted and put in the output array. This procedure is shown in the following code:"}]},{"block_type":"element","block":"k68oco06","search_text":"a = np.array([0, 1, 2, 3, 4, 5]) mask = np.array([True, False, True, False, False, False]) a[mask] # Output: # array([0, 2]) ","text_count":125,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.array([0, 1, 2, 3, 4, 5]) \n    mask = np.array([True, False, True, False, False, False]) \n    a[mask] \n    # Output:\n    # array([0, 2])"}]}]},{"block_type":"element","block":"k68oco07","search_text":"The same rules apply when dealing with multiple dimensions. Furthermore, if the index array has the same shape as the original array, the elements corresponding to True will be selected and put in the resulting array.","text_count":217,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The same rules apply when dealing with multiple dimensions. Furthermore, if the index array has the same shape as the original array, the elements corresponding to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"True"}]},{"block_type":"text","content":"will be selected and put in the resulting array."}]},{"block_type":"element","block":"k68oco08","search_text":"Indexing in NumPy is a reasonably fast operation. Anyway, when speed is critical, you can use the slightly faster numpy.take and numpy.compress functions to squeeze out a little more performance. The first argument of numpy.take is the array we want to operate on, and the second is the list of indexes we want to extract. The last argument is axis ; if not provided, the indexes will act on the flattened array; otherwise, they will act along the specified axis:","text_count":463,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Indexing in NumPy is a reasonably fast operation. Anyway, when speed is critical, you can use the slightly faster"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.take"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.compress"}]},{"block_type":"text","content":"functions to squeeze out a little more performance. The first argument of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.take"}]},{"block_type":"text","content":"is the array we want to operate on, and the second is the list of indexes we want to extract. The last argument is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"axis"}]},{"block_type":"text","content":"; if not provided, the indexes will act on the flattened array; otherwise, they will act along the specified axis:"}]},{"block_type":"element","block":"k68oco09","search_text":"r_i = np.random(100, 2) idx = np.arange(50) # integers 0 to 50 %timeit np.take(r_i, idx, axis=0) 1000000 loops, best of 3: 962 ns per loop %timeit r_i[idx] 100000 loops, best of 3: 3.09 us per loop ","text_count":198,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"r_i = np.random(100, 2) \n    idx = np.arange(50) # integers 0 to 50 \n\n    %timeit np.take(r_i, idx, axis=0) \n    1000000 loops, best of 3: 962 ns per loop \n\n    %timeit r_i[idx] \n    100000 loops, best of 3: 3.09 us per loop"}]}]},{"block_type":"element","block":"k68oco0a","search_text":"The similar, but faster version for Boolean arrays is numpy.compress , which works in the same way. The use of numpy.compress is shown as follows:","text_count":146,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The similar, but faster version for Boolean arrays is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.compress"}]},{"block_type":"text","content":", which works in the same way. The use of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.compress"}]},{"block_type":"text","content":"is shown as follows:"}]},{"block_type":"element","block":"k68oco0b","search_text":"In [51]: idx = np.ones(100, dtype='bool') # all True values In [52]: %timeit np.compress(idx, r_i, axis=0) 1000000 loops, best of 3: 1.65 us per loop In [53]: %timeit r_i[idx] 100000 loops, best of 3: 5.47 us per loop ","text_count":218,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"In [51]: idx = np.ones(100, dtype='bool') # all True values \n    In [52]: %timeit np.compress(idx, r_i, axis=0) \n    1000000 loops, best of 3: 1.65 us per loop \n    In [53]: %timeit r_i[idx] \n    100000 loops, best of 3: 5.47 us per loop"}]}]},{"block_type":"element","block":"k68oco0c","search_text":"Broadcasting","text_count":12,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Broadcasting"}]},{"block_type":"element","block":"k68oco0d","search_text":"The true power of NumPy lies in its fast mathematical operations. The approach used by NumPy is to avoid stepping into the Python interpreter by performing element-wise calculation using optimized C code. Broadcasting is a clever set of rules that enables fast array calculations for arrays of similar (but not equal!) shape.","text_count":325,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The true power of NumPy lies in its fast mathematical operations. The approach used by NumPy is to avoid stepping into the Python interpreter by performing element-wise calculation using optimized C code."},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Broadcasting"}]},{"block_type":"text","content":"is a clever set of rules that enables&nbsp;fast array calculations for arrays of similar (but not equal!) shape."}]},{"block_type":"element","block":"k68oco0e","search_text":"Whenever you do an arithmetic operation on two arrays (like a product), if the two operands have the same shape, the operation will be applied in an element-wise fashion. For example, upon multiplying two shape (2,2) arrays, the operation will be done between pairs of corresponding elements, producing another (2, 2) array, as shown in the following code:","text_count":356,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Whenever you do an arithmetic operation on two arrays (like a product), if the two operands have the same shape, the operation will be applied in an element-wise fashion. For example, upon multiplying two shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2,2)"}]},{"block_type":"text","content":"arrays, the operation will be done between pairs of corresponding elements, producing another"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2, 2)"}]},{"block_type":"text","content":"array,&nbsp;as shown in the following code:"}]},{"block_type":"element","block":"k68oco0f","search_text":"A = np.array([[1, 2], [3, 4]]) B = np.array([[5, 6], [7, 8]]) A * B # Output: # array([[ 5, 12], # [21, 32]]) ","text_count":110,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"A = np.array([[1, 2], [3, 4]]) \n    B = np.array([[5, 6], [7, 8]]) \n    A * B \n    # Output:\n    # array([[ 5, 12],           \n    #        [21, 32]])"}]}]},{"block_type":"element","block":"k68oco0g","search_text":"If the shapes of the operands don't match, NumPy will attempt to match them using broadcasting rules. If one of the operands is a scalar (for example, a number), it will be applied to every element of the array, as the following code illustrates:","text_count":246,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If the shapes of the operands don't match, NumPy will attempt to match them using broadcasting rules. If one of the operands is a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"scalar"}]},{"block_type":"text","content":"(for example, a number), it will be applied to every element of the array, as the following code illustrates:"}]},{"block_type":"element","block":"k68oco0h","search_text":"A * 2 # Output: # array([[2, 4], # [6, 8]]) ","text_count":44,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"A * 2 \n    # Output: \n    # array([[2, 4], \n    #        [6, 8]])"}]}]},{"block_type":"element","block":"k68oco0i","search_text":"If the operand is another array, NumPy will try to match the shapes starting from the last axis. For example, if we want to combine an array of shape (3, 2) with one of shape (2,) , the second array will be repeated three times to generate a (3, 2) array. In other words, the array is broadcasted along a dimension to match the shape of the other operand, as shown in the following figure:","text_count":389,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If the operand is another array, NumPy will try to match the shapes starting from the last axis. For example, if we want to combine an array of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3, 2)"}]},{"block_type":"text","content":"with one of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2,)"}]},{"block_type":"text","content":", the second array will be&nbsp;repeated three&nbsp;times to generate a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3, 2)"}]},{"block_type":"text","content":"array. In other words, the array is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"broadcasted"}]},{"block_type":"text","content":"&nbsp;along a dimension to match the shape of the other operand, as shown in the following figure:"}]},{"block_type":"element","block":"k68oco0j","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000014.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68oco0k","search_text":"If the shapes mismatch, for example, when combining a (3, 2) array with a (2, 2) array, NumPy will throw an exception.","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If the shapes mismatch, for example, when combining a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3, 2)"}]},{"block_type":"text","content":"array with a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(2, 2)"}]},{"block_type":"text","content":"array, NumPy will throw an exception."}]},{"block_type":"element","block":"k68oco0l","search_text":"If one of the axis's size is 1, the array will be repeated over this axis until the shapes match. To illustrate that point, consider that we have an array of the following shape:","text_count":178,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If one of the axis's size is 1, the array will be repeated over this axis until the shapes match. To illustrate that point,&nbsp;consider that&nbsp;we have an array of the following shape:"}]},{"block_type":"element","block":"k68oco0m","search_text":"5, 10, 2 ","text_count":9,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"5, 10, 2"}]}]},{"block_type":"element","block":"k68oco0n","search_text":"Now, consider that we want to broadcast it with an array of shape (5, 1, 2) ; the array will be repeated on the second axis 10 times, which is shown as follows:","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, consider that we want to broadcast it with an array of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(5, 1, 2)"}]},{"block_type":"text","content":"; the array will be repeated on the second axis 10 times, which is shown as follows:"}]},{"block_type":"element","block":"k68oco0o","search_text":"5, 10, 2 5, 1, 2 → repeated - - - - 5, 10, 2 ","text_count":45,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"5, 10, 2 \n    5,  1, 2 &rarr; repeated \n    - - - - \n    5, 10, 2"}]}]},{"block_type":"element","block":"k68oco0p","search_text":"Earlier, we saw that it is possible to freely reshape arrays to add axes of size 1. Using the numpy.newaxis constant while indexing will introduce an extra dimension. For instance, if we have a (5, 2) array and we want to combine it with one of shape (5, 10, 2) , we can add an extra axis in the middle, as shown in the following code, to obtain a compatible (5, 1, 2) array:","text_count":375,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Earlier, we saw that it is possible to freely reshape arrays to add axes of size 1. Using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.newaxis"}]},{"block_type":"text","content":"constant while indexing will introduce an extra dimension. For instance, if we have a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(5, 2)"}]},{"block_type":"text","content":"array and we want to combine it with one of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(5, 10, 2)"}]},{"block_type":"text","content":", we can add an extra axis in the middle, as shown in the following code, to obtain a compatible"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(5, 1, 2)"}]},{"block_type":"text","content":"array:"}]},{"block_type":"element","block":"k68oco0q","search_text":"A = np.random.rand(5, 10, 2) B = np.random.rand(5, 2) A * B[:, np.newaxis, :] ","text_count":78,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"A = np.random.rand(5, 10, 2) \n    B = np.random.rand(5, 2) \n    A * B[:, np.newaxis, :]"}]}]},{"block_type":"element","block":"k68oco0r","search_text":"This feature can be used, for example, to operate on all possible combinations of the two arrays. One of these applications is the outer product . Consider that we have the following two arrays:","text_count":194,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This feature can be used, for example, to operate on all possible combinations of the two arrays. One of these applications is the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"outer product"}]},{"block_type":"text","content":".&nbsp;Consider that&nbsp;we have the following two arrays:"}]},{"block_type":"element","block":"k68oco0s","search_text":"a = [a1, a2, a3] b = [b1, b2, b3] ","text_count":34,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = [a1, a2, a3] \n    b = [b1, b2, b3]"}]}]},{"block_type":"element","block":"k68oco0t","search_text":"The outer product is a matrix containing the product of all the possible combinations (i, j) of the two array elements, as shown in the following snippet:","text_count":154,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The outer product is a matrix containing the product of all the possible combinations (i, j) of the two array elements, as shown in the following snippet:"}]},{"block_type":"element","block":"k68oco0u","search_text":"a x b = a1*b1, a1*b2, a1*b3 a2*b1, a2*b2, a2*b3 a3*b1, a3*b2, a3*b3 ","text_count":68,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a x b = a1*b1, a1*b2, a1*b3 \n            a2*b1, a2*b2, a2*b3 \n            a3*b1, a3*b2, a3*b3"}]}]},{"block_type":"element","block":"k68oco0v","search_text":"To calculate this using NumPy, we will repeat the [a1, a2, a3] elements in one dimension, the [b1, b2, b3] elements in another dimension, and then take their element-wise product, as shown in the following figure:","text_count":213,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To calculate this using NumPy, we will repeat the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"[a1, a2, a3]"}]},{"block_type":"text","content":"elements in one dimension, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"[b1, b2, b3]"}]},{"block_type":"text","content":"elements in another dimension, and then take their element-wise product, as shown in the following figure:"}]},{"block_type":"element","block":"k68oco0w","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000008.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68oco0x","search_text":"Using code, our strategy will be to transform the a array from shape (3,) to shape (3, 1) , and the b array from shape (3,) to shape (1, 3) . The two arrays are broadcasted in the two dimensions and get multiplied together using the following code:","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using code, our strategy will be to transform the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"array from shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3,)"}]},{"block_type":"text","content":"to shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3, 1)"}]},{"block_type":"text","content":", and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"b"}]},{"block_type":"text","content":"array from shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3,)"}]},{"block_type":"text","content":"to shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(1, 3)"}]},{"block_type":"text","content":". The two arrays are broadcasted in the two dimensions and get multiplied together using the following code:"}]},{"block_type":"element","block":"k68oco0y","search_text":"AB = a[:, np.newaxis] * b[np.newaxis, :] ","text_count":41,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"AB = a[:, np.newaxis] * b[np.newaxis, :]"}]}]},{"block_type":"element","block":"k68oco0z","search_text":"This operation is very fast and extremely effective as it avoids Python loops and is able to process a high number of elements at speeds comparable with pure C or FORTRAN code.","text_count":176,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This operation is very fast and extremely effective as it avoids Python loops and is able to process a high number of elements at speeds comparable with pure C&nbsp;or FORTRAN code."}]},{"block_type":"element","block":"k68oco10","search_text":"Mathematical operations","text_count":23,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Mathematical operations"}]},{"block_type":"element","block":"k68oco11","search_text":"NumPy includes the most common mathematical operations available for broadcasting, by default, ranging from simple algebra to trigonometry, rounding, and logic. For instance, to take the square root of every element in the array, we can use numpy.sqrt , as shown in the following code:","text_count":285,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"NumPy includes the most common mathematical operations available for broadcasting, by default, ranging from simple algebra to trigonometry, rounding, and logic. For instance, to take the square root of every element in the array, we can use&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.sqrt"}]},{"block_type":"text","content":", as shown in the following code:"}]},{"block_type":"element","block":"k68oco12","search_text":"np.sqrt(np.array([4, 9, 16])) # Result: # array([2., 3., 4.]) ","text_count":62,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"np.sqrt(np.array([4, 9, 16])) \n    # Result:\n    # array([2., 3., 4.])"}]}]},{"block_type":"element","block":"k68oco13","search_text":"The comparison operators are useful when trying to filter certain elements based on a condition. Imagine that we have an array of random numbers from 0 to 1 , and we want to extract all the numbers greater than 0.5 . We can use the > operator on the array to obtain a bool array, as follows:","text_count":291,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The comparison operators are useful when trying to filter certain elements based on a condition. Imagine that we have an array of random numbers from"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":", and we want to extract all the numbers greater than"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0.5"}]},{"block_type":"text","content":". We can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"&gt;"}]},{"block_type":"text","content":"operator on the array&nbsp;to obtain a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bool"}]},{"block_type":"text","content":"&nbsp;array, as follows:"}]},{"block_type":"element","block":"k68oco14","search_text":"a = np.random.rand(5, 3) a > 0.3 # Result: # array([[ True, False, True], # [ True, True, True], # [False, True, True], # [ True, True, False], # [ True, True, False]], dtype=bool) ","text_count":181,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.random.rand(5, 3) \n    a &gt; 0.3 \n    # Result:\n    # array([[ True, False,  True],\n    #        [ True,  True,  True],\n    #        [False,  True,  True],\n    #        [ True,  True, False],\n    #        [ True,  True, False]], dtype=bool)"}]}]},{"block_type":"element","block":"k68oco15","search_text":"The resulting bool array can then be reused as an index to retrieve the elements greater than 0.5 :","text_count":99,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The resulting"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bool"}]},{"block_type":"text","content":"&nbsp;array can then be reused as an index to retrieve the elements greater than"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0.5"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco16","search_text":"a[a > 0.5] print(a[a>0.5]) # Output: # [ 0.9755 0.5977 0.8287 0.6214 0.5669 0.9553 0.5894 0.7196 0.9200 0.5781 0.8281 ] ","text_count":120,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a[a &gt; 0.5] \n    print(a[a&gt;0.5]) \n    # Output:\n    # [ 0.9755  0.5977  0.8287  0.6214  0.5669  0.9553  0.5894   \n    0.7196  0.9200  0.5781  0.8281 ]"}]}]},{"block_type":"element","block":"k68oco17","search_text":"NumPy also implements methods such as ndarray.sum , which takes the sum of all the elements on an axis. If we have an array of shape (5, 3) , we can use the ndarray.sum method to sum the elements on the first axis, the second axis, or over all the elements of the array, as illustrated in the following snippet:","text_count":311,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"NumPy also implements methods such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ndarray.sum"}]},{"block_type":"text","content":", which takes the sum of all the elements on an axis. If we have an array of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(5, 3)"}]},{"block_type":"text","content":", we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ndarray.sum"}]},{"block_type":"text","content":"method to sum the elements on the first axis, the second axis, or over all the elements of the array, as illustrated in the following snippet:"}]},{"block_type":"element","block":"k68oco18","search_text":"a = np.random.rand(5, 3) a.sum(axis=0) # Result: # array([ 2.7454, 2.5517, 2.0303]) a.sum(axis=1) # Result: # array([ 1.7498, 1.2491, 1.8151, 1.9320, 0.5814]) a.sum() # With no argument operates on flattened array # Result: # 7.3275 ","text_count":233,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.random.rand(5, 3) \n    a.sum(axis=0) \n    # Result:\n    # array([ 2.7454,  2.5517,  2.0303]) \n\n    a.sum(axis=1) \n    # Result:\n    # array([ 1.7498,  1.2491,  1.8151,  1.9320,  0.5814]) \n\n    a.sum() # With no argument operates on flattened array \n    # Result:\n    # 7.3275"}]}]},{"block_type":"element","block":"k68oco19","search_text":"Note that by summing the elements over an axis, we eliminate that axis. From the preceding example, the sum on the axis 0 produces an array of shape (3,) , while the sum on the axis 1 produces an array of shape (5,) .","text_count":217,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that by summing the elements over an axis, we eliminate that axis. From the&nbsp;preceding example, the sum on the axis"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"produces an array of shape&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3,)"}]},{"block_type":"text","content":", while the sum on the axis"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"produces an array of shape&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(5,)"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68oco1a","search_text":"Calculating the norm","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Calculating the norm"}]},{"block_type":"element","block":"k68oco1b","search_text":"We can review the basic concepts illustrated in this section by calculating the norm of a set of coordinates. For a two-dimensional vector, the norm is defined as follows:","text_count":171,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can review the basic concepts illustrated in this section by calculating the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"norm"}]},{"block_type":"text","content":"of a set of coordinates. For a two-dimensional vector, the norm is defined as follows:"}]},{"block_type":"element","block":"k68oco1c","search_text":"norm = sqrt(x**2 + y**2) ","text_count":25,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"norm = sqrt(x**2 + y**2)"}]}]},{"block_type":"element","block":"k68oco1d","search_text":"Given an array of 10 coordinates ( x , y ), we want to find the norm of each coordinate. We can calculate the norm by taking these steps:","text_count":137,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Given an array of 10 coordinates ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"), we want to find the norm of each coordinate. We can calculate the norm by taking these steps:"}]},{"block_type":"element","block":"k68oco1e","search_text":"Square the coordinates, obtaining an array that contains (x**2, y**2) elements. Sum those with numpy.sum over the last axis. Take the square root, element-wise, with numpy.sqrt . ","text_count":179,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Square the coordinates, obtaining an array&nbsp;that contains"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(x**2, y**2)"}]},{"block_type":"text","content":"elements."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Sum those with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.sum"}]},{"block_type":"text","content":"over the last axis."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Take the square root, element-wise, with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.sqrt"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68oco1f","search_text":"The final expression can be compressed in a single line:","text_count":56,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The final expression can be compressed in a single line:"}]},{"block_type":"element","block":"k68oco1g","search_text":"r_i = np.random.rand(10, 2) norm = np.sqrt((r_i ** 2).sum(axis=1)) print(norm) # Output: # [ 0.7314 0.9050 0.5063 0.2553 0.0778 0.9143 1.3245 0.9486 1.010 1.0212] ","text_count":163,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"r_i = np.random.rand(10, 2) \n    norm = np.sqrt((r_i ** 2).sum(axis=1)) \n    print(norm)\n    # Output:\n    # [ 0.7314  0.9050  0.5063  0.2553  0.0778   0.9143   1.3245  \n    0.9486  1.010   1.0212]"}]}]},{"block_type":"element","block":"k68oco1h","search_text":"Rewriting the particle simulator in NumPy","text_count":41,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Rewriting the particle simulator in NumPy"}]},{"block_type":"element","block":"k68oco1i","search_text":"In this section, we will optimize our particle simulator by rewriting some parts of it in NumPy. We found, from the profiling we did in Chapter 1, Benchmarking and Profiling , that the slowest part of our program is the following loop contained in the ParticleSimulator.evolve method:","text_count":284,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will optimize our particle simulator by rewriting some parts of it in NumPy. We found, from the profiling we did in Chapter 1,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Benchmarking and Profiling"}]},{"block_type":"text","content":", that the slowest part of our program is the following loop contained in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator.evolve"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k68oco1j","search_text":"for i in range(nsteps): for p in self.particles: norm = (p.x**2 + p.y**2)**0.5 v_x = (-p.y)/norm v_y = p.x/norm d_x = timestep * p.ang_vel * v_x d_y = timestep * p.ang_vel * v_y p.x += d_x p.y += d_y ","text_count":200,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"for i in range(nsteps): \n      for p in self.particles: \n\n        norm = (p.x**2 + p.y**2)**0.5 \n        v_x = (-p.y)/norm \n        v_y = p.x/norm \n\n        d_x = timestep * p.ang_vel * v_x \n        d_y = timestep * p.ang_vel * v_y \n\n        p.x += d_x \n        p.y += d_y"}]}]},{"block_type":"element","block":"k68oco1k","search_text":"You may have noticed that the body of the loop acts solely on the current particle. If we had an array containing the particle positions and angular speed, we could rewrite the loop using a broadcasted operation. In contrast, the loop's steps depend on the previous step and cannot be parallelized in this way.","text_count":310,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You&nbsp;may have noticed that the body of the loop acts solely on the current particle. If we had an array containing the particle positions and angular speed, we could rewrite the loop using a broadcasted operation. In contrast, the loop's steps depend on the previous step and cannot be parallelized in this way."}]},{"block_type":"element","block":"k68oco1l","search_text":"It is natural then, to store all the array coordinates in an array of shape (nparticles, 2) and the angular speed in an array of shape (nparticles,) , where nparticles is the number of particles. We'll call those arrays r_i and ang_vel_i :","text_count":239,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is natural then, to store all the array coordinates in an array of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(nparticles, 2)"}]},{"block_type":"text","content":"and the angular speed in an array of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(nparticles,)"}]},{"block_type":"text","content":", where"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nparticles"}]},{"block_type":"text","content":"is the number of particles. We'll call those arrays"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"r_i"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ang_vel_i"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco1m","search_text":"r_i = np.array([[p.x, p.y] for p in self.particles]) ang_vel_i = np.array([p.ang_vel for p in self.particles]) ","text_count":111,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"r_i = np.array([[p.x, p.y] for p in self.particles]) \n    ang_vel_i = np.array([p.ang_vel for p in self.particles])"}]}]},{"block_type":"element","block":"k68oco1n","search_text":"The velocity direction, perpendicular to the vector ( x , y ), was defined as follows:","text_count":86,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The velocity direction, perpendicular to the vector ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"), was defined as follows:"}]},{"block_type":"element","block":"k68oco1o","search_text":"v_x = -y / norm v_y = x / norm ","text_count":31,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"v_x = -y / norm \n    v_y = x / norm"}]}]},{"block_type":"element","block":"k68oco1p","search_text":"The norm can be calculated using the strategy illustrated in the Calculating the norm section under the Getting started with NumPy heading:","text_count":139,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The norm can be calculated using the strategy illustrated in the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Calculating the norm"}]},{"block_type":"text","content":"section under the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Getting started with NumPy"}]},{"block_type":"text","content":"heading:"}]},{"block_type":"element","block":"k68oco1q","search_text":"norm_i = ((r_i ** 2).sum(axis=1))**0.5 ","text_count":39,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"norm_i = ((r_i ** 2).sum(axis=1))**0.5"}]}]},{"block_type":"element","block":"k68oco1r","search_text":"For the ( -y , x ) components, we first need to swap the x and y columns in r_i and then multiply the first column by -1, as shown in the following code:","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For the ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"-y"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":") components, we first need to swap the x and y columns in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"r_i"}]},{"block_type":"text","content":"and then multiply the first column by -1, as shown in the following code:"}]},{"block_type":"element","block":"k68oco1s","search_text":"v_i = r_i[:, [1, 0]] / norm_i v_i[:, 0] *= -1 ","text_count":46,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"v_i = r_i[:, [1, 0]] / norm_i \n    v_i[:, 0] *= -1"}]}]},{"block_type":"element","block":"k68oco1t","search_text":"To calculate the displacement, we need to compute the product of v_i , ang_vel_i , and timestep . Since ang_vel_i is of shape (nparticles,) , it needs a new axis in order to operate with v_i of shape (nparticles, 2) . We will do that using numpy.newaxis , as follows:","text_count":267,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To calculate the displacement, we need to compute the product of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"v_i"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ang_vel_i"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timestep"}]},{"block_type":"text","content":". Since"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ang_vel_i"}]},{"block_type":"text","content":"is of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(nparticles,)"}]},{"block_type":"text","content":", it needs a new axis in order to operate with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"v_i"}]},{"block_type":"text","content":"of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(nparticles, 2)"}]},{"block_type":"text","content":". We will do that using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy.newaxis"}]},{"block_type":"text","content":", as follows:"}]},{"block_type":"element","block":"k68oco1u","search_text":"d_i = timestep * ang_vel_i[:, np.newaxis] * v_i r_i += d_i ","text_count":59,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"d_i = timestep * ang_vel_i[:, np.newaxis] * v_i \n    r_i += d_i"}]}]},{"block_type":"element","block":"k68oco1v","search_text":"Outside the loop, we have to update the particle instances with the new coordinates, x and y , as follows:","text_count":106,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Outside the loop, we have to update the particle instances with the new coordinates,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":", as follows:"}]},{"block_type":"element","block":"k68oco1w","search_text":"for i, p in enumerate(self.particles): p.x, p.y = r_i[i] ","text_count":57,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"for i, p in enumerate(self.particles): \n      p.x, p.y = r_i[i]"}]}]},{"block_type":"element","block":"k68oco1x","search_text":"To summarize, we will implement a method called ParticleSimulator.evolve_numpy and benchmark it against the pure Python version, renamed as ParticleSimulator.evolve_python :","text_count":173,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To summarize, we will implement a method called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator.evolve_numpy"}]},{"block_type":"text","content":"and benchmark it against the pure Python version, renamed as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator.evolve_python"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco1y","search_text":"def evolve_numpy(self, dt): timestep = 0.00001 nsteps = int(dt/timestep) r_i = np.array([[p.x, p.y] for p in self.particles]) ang_vel_i = np.array([p.ang_vel for p in self.particles]) for i in range(nsteps): norm_i = np.sqrt((r_i ** 2).sum(axis=1)) v_i = r_i[:, [1, 0]] v_i[:, 0] *= -1 v_i /= norm_i[:, np.newaxis] d_i = timestep * ang_vel_i[:, np.newaxis] * v_i r_i += d_i for i, p in enumerate(self.particles): p.x, p.y = r_i[i] ","text_count":431,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def evolve_numpy(self, dt): \n      timestep = 0.00001 \n      nsteps = int(dt/timestep) \n\n      r_i = np.array([[p.x, p.y] for p in self.particles]) \n      ang_vel_i = np.array([p.ang_vel for p in self.particles]) \n\n      for i in range(nsteps): \n\n        norm_i = np.sqrt((r_i ** 2).sum(axis=1)) \n        v_i = r_i[:, [1, 0]] \n        v_i[:, 0] *= -1 \n        v_i /= norm_i[:, np.newaxis] \n        d_i = timestep * ang_vel_i[:, np.newaxis] * v_i \n        r_i += d_i \n\n        for i, p in enumerate(self.particles): \n          p.x, p.y = r_i[i]"}]}]},{"block_type":"element","block":"k68oco1z","search_text":"We also update the benchmark to conveniently change the number of particles and the simulation method, as follows:","text_count":114,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We also update the benchmark to conveniently change the number of particles and the simulation method, as follows:"}]},{"block_type":"element","block":"k68oco20","search_text":"def benchmark(npart=100, method='python'): particles = [Particle(uniform(-1.0, 1.0), uniform(-1.0, 1.0), uniform(-1.0, 1.0)) for i in range(npart)] simulator = ParticleSimulator(particles) if method=='python': simulator.evolve_python(0.1) elif method == 'numpy': simulator.evolve_numpy(0.1) ","text_count":291,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def benchmark(npart=100, method='python'): \n      particles = [Particle(uniform(-1.0, 1.0),     \n                            uniform(-1.0, 1.0),\n                            uniform(-1.0, 1.0))  \n                            for i in range(npart)] \n\n      simulator = ParticleSimulator(particles) \n\n      if method=='python': \n        simulator.evolve_python(0.1) \n\n      elif method == 'numpy': \n        simulator.evolve_numpy(0.1)"}]}]},{"block_type":"element","block":"k68oco21","search_text":"Let's run the benchmark in an IPython session:","text_count":46,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's run the benchmark in an IPython session:"}]},{"block_type":"element","block":"k68oco22","search_text":"from simul import benchmark %timeit benchmark(100, 'python') 1 loops, best of 3: 614 ms per loop %timeit benchmark(100, 'numpy') 1 loops, best of 3: 415 ms per loop ","text_count":165,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from simul import benchmark \n    %timeit benchmark(100, 'python') \n    1 loops, best of 3: 614 ms per loop \n    %timeit benchmark(100, 'numpy') \n    1 loops, best of 3: 415 ms per loop"}]}]},{"block_type":"element","block":"k68oco23","search_text":"We have some improvement, but it doesn't look like a huge speed boost. The power of NumPy is revealed when handling big arrays. If we increase the number of particles, we will note a more significant performance boost:","text_count":218,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We have some improvement, but it doesn't look like a huge speed boost. The power of NumPy is revealed when handling big arrays. If we increase the number of particles, we will note a more significant performance boost:"}]},{"block_type":"element","block":"k68oco24","search_text":"%timeit benchmark(1000, 'python') 1 loops, best of 3: 6.13 s per loop %timeit benchmark(1000, 'numpy') 1 loops, best of 3: 852 ms per loop ","text_count":139,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%timeit benchmark(1000, 'python') \n    1 loops, best of 3: 6.13 s per loop \n    %timeit benchmark(1000, 'numpy') \n    1 loops, best of 3: 852 ms per loop"}]}]},{"block_type":"element","block":"k68oco25","search_text":"The plot in the following figure was produced by running the benchmark with different particle numbers:","text_count":103,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The plot in the following figure was produced by running the benchmark with different particle numbers:"}]},{"block_type":"element","block":"k68oco26","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000034.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68oco27","search_text":"The plot shows that both the implementations scale linearly with particle size, but the runtime in the pure Python version grows much faster than the NumPy version; at greater sizes, we have a greater NumPy advantage. In general, when using NumPy, you should try to pack things into large arrays and group the calculations using the broadcasting feature.","text_count":354,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The plot shows that both the implementations scale linearly with particle size, but the runtime in the pure Python version grows much faster than the NumPy version; at greater sizes, we have a greater NumPy advantage. In general, when using NumPy, you should try to pack things into large arrays and group the calculations using the broadcasting feature."}]},{"block_type":"element","block":"k68oco28","search_text":"Reaching optimal performance with numexpr","text_count":41,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Reaching optimal performance with numexpr"}]},{"block_type":"element","block":"k68oco29","search_text":"When handling complex expressions, NumPy stores intermediate results in memory. David M. Cooke wrote a package called numexpr , which optimizes and compiles array expressions on the fly. It works by optimizing the usage of the CPU cache and by taking advantage of multiple processors.","text_count":284,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When handling complex expressions, NumPy stores intermediate results in memory. David M. Cooke wrote a package called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":", which optimizes and compiles array expressions on the fly. It works by optimizing the usage of the CPU cache and by taking advantage of multiple processors."}]},{"block_type":"element","block":"k68oco2a","search_text":"Its usage is generally straightforward and is based on a single function-- numexpr.evaluate . The function takes a string containing an array expression as its first argument. The syntax is basically identical to that of NumPy. For example, we can calculate a simple a + b * c expression in the following way:","text_count":309,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Its usage is generally straightforward and is based on a single function--"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr.evaluate"}]},{"block_type":"text","content":". The function takes a string containing an array expression as its first argument. The syntax is basically identical to that of NumPy. For example, we can calculate a simple"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a + b * c"}]},{"block_type":"text","content":"expression in the following way:"}]},{"block_type":"element","block":"k68oco2b","search_text":"a = np.random.rand(10000) b = np.random.rand(10000) c = np.random.rand(10000) d = ne.evaluate('a + b * c') ","text_count":107,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.random.rand(10000) \n    b = np.random.rand(10000) \n    c = np.random.rand(10000) \n    d = ne.evaluate('a + b * c')"}]}]},{"block_type":"element","block":"k68oco2c","search_text":"The numexpr package increases the performances in almost all cases, but to get a substantial advantage, you should use it with large arrays. An application that involves a large array is the calculation of a distance matrix . In a particle system, a distance matrix contains all the possible distances between the particles. To calculate it, we should first calculate all the vectors connecting any two particles (i,j) , as follows:","text_count":432,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":"package increases the performances in almost all cases, but to get&nbsp;a substantial advantage, you should use it with large arrays. An application that involves a large array is the calculation of a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"distance matrix"}]},{"block_type":"text","content":". In a particle system, a distance matrix contains all the possible distances between the particles. To calculate it, we should first calculate all the vectors connecting any two particles"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(i,j)"}]},{"block_type":"text","content":", as follows:"}]},{"block_type":"element","block":"k68oco2d","search_text":"x_ij = x_j - x_i y_ij = y_j - y_i. ","text_count":35,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"x_ij = x_j - x_i \n    y_ij = y_j - y_i."}]}]},{"block_type":"element","block":"k68oco2e","search_text":"Then, we calculate the length of this vector by taking its norm, as in the following code:","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we calculate the length of this vector by taking its norm, as in the following code:"}]},{"block_type":"element","block":"k68oco2f","search_text":"d_ij = sqrt(x_ij**2 + y_ij**2) ","text_count":31,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"d_ij = sqrt(x_ij**2 + y_ij**2)"}]}]},{"block_type":"element","block":"k68oco2g","search_text":"We can write this in NumPy by employing the usual broadcasting rules (the operation is similar to the outer product):","text_count":117,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can write this in NumPy by employing the usual broadcasting rules (the operation is similar to the outer product):"}]},{"block_type":"element","block":"k68oco2h","search_text":"r = np.random.rand(10000, 2) r_i = r[:, np.newaxis] r_j = r[np.newaxis, :] d_ij = r_j - r_i ","text_count":92,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"r = np.random.rand(10000, 2) \n    r_i = r[:, np.newaxis] \n    r_j = r[np.newaxis, :] \n    d_ij = r_j - r_i"}]}]},{"block_type":"element","block":"k68oco2i","search_text":"Finally, we calculate the norm over the last axis using the following line of code:","text_count":83,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we calculate the norm over the last axis using the following line of code:"}]},{"block_type":"element","block":"k68oco2j","search_text":"d_ij = np.sqrt((d_ij ** 2).sum(axis=2)) ","text_count":40,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"d_ij = np.sqrt((d_ij ** 2).sum(axis=2))"}]}]},{"block_type":"element","block":"k68oco2k","search_text":"Rewriting the same expression using the numexpr syntax is extremely easy. The numexpr package doesn't support slicing in its array expression; therefore, we first need to prepare the operands for broadcasting by adding an extra dimension, as follows:","text_count":250,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Rewriting the same expression using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":"syntax is extremely easy. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":"package doesn't support slicing in its array expression; therefore, we first need to prepare the operands for broadcasting by adding an extra dimension, as follows:"}]},{"block_type":"element","block":"k68oco2l","search_text":"r = np.random(10000, 2) r_i = r[:, np.newaxis] r_j = r[np.newaxis, :] ","text_count":70,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"r = np.random(10000, 2) \n    r_i = r[:, np.newaxis] \n    r_j = r[np.newaxis, :]"}]}]},{"block_type":"element","block":"k68oco2m","search_text":"At that point, we should try to pack as many operations as possible in a single expression to allow a significant optimization.","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At that point, we should try to pack as many operations as possible in a single expression to allow a significant optimization."}]},{"block_type":"element","block":"k68oco2n","search_text":"Most of the NumPy mathematical functions are also available in numexpr . However, there is a limitation--the reduction operations (the ones that reduce an axis, such as sum) have to happen last. Therefore, we have to first calculate the sum, then step out of numexpr , and finally calculate the square root in another expression:","text_count":329,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Most of the NumPy mathematical functions are also available in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":".&nbsp;However, there is a limitation--the reduction operations (the ones&nbsp;that reduce an axis, such as sum) have to happen last. Therefore,&nbsp;we have to first calculate the sum, then step out of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":", and finally calculate the square root in another expression:"}]},{"block_type":"element","block":"k68oco2o","search_text":"d_ij = ne.evaluate('sum((r_j - r_i)**2, 2)') d_ij = ne.evaluate('sqrt(d_ij)') ","text_count":78,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"d_ij = ne.evaluate('sum((r_j - r_i)**2, 2)') \n    d_ij = ne.evaluate('sqrt(d_ij)')"}]}]},{"block_type":"element","block":"k68oco2p","search_text":"The numexpr compiler will avoid redundant memory allocation by not storing intermediate results. When possible, it will also distribute the operations over multiple processors. In the distance_matrix.py file, you will find two functions that implement the two versions: distance_matrix_numpy and distance_matrix_numexpr :","text_count":321,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":"compiler will avoid redundant memory allocation&nbsp;by not storing&nbsp;intermediate results. When possible, it&nbsp;will also distribute&nbsp;the operations over multiple processors. In the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"distance_matrix.py"}]},{"block_type":"text","content":"file, you will find two functions that implement the two versions:"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"distance_matrix_numpy"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"distance_matrix_numexpr"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco2q","search_text":"from distance_matrix import (distance_matrix_numpy, distance_matrix_numexpr) %timeit distance_matrix_numpy(10000) 1 loops, best of 3: 3.56 s per loop %timeit distance_matrix_numexpr(10000) 1 loops, best of 3: 858 ms per loop ","text_count":225,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from distance_matrix import (distance_matrix_numpy, \n                                 distance_matrix_numexpr) \n    %timeit distance_matrix_numpy(10000) \n    1 loops, best of 3: 3.56 s per loop \n    %timeit distance_matrix_numexpr(10000) \n    1 loops, best of 3: 858 ms per loop"}]}]},{"block_type":"element","block":"k68oco2r","search_text":"By simply converting the expressions to use numexpr , we were able to obtain a 4.5x increase in performance over standard NumPy. The numexpr package can be used every time you need to optimize a NumPy expression that involves large arrays and complex operations, and you can do so with minimal changes in the code.","text_count":314,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By simply converting&nbsp;the expressions to use&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":", we were able to obtain a 4.5x increase in performance over standard NumPy. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":"package can be used every time you need to optimize a NumPy expression that involves large arrays and complex operations, and you can do so with minimal changes in the code."}]},{"block_type":"element","block":"k68oco2s","search_text":"Pandas","text_count":6,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Pandas"}]},{"block_type":"element","block":"k68oco2t","search_text":"Pandas is a library originally developed by Wes McKinney, which was designed to analyze datasets in a seamless and performant way. In recent years, this powerful library has seen an incredible growth and huge adoption by the Python community. In this section, we will introduce the main concepts and tools provided in this library, and we will use it to increase performance of various usecases that can't otherwise be addressed with NumPy's vectorized operations and broadcasting.","text_count":481,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Pandas is a library originally developed by Wes McKinney, which was designed to analyze datasets in a seamless and performant way. In recent years, this powerful library has seen&nbsp;an incredible growth and huge adoption by the Python community. In this section, we will introduce the main concepts and tools provided in this library, and we will use it to increase performance of various usecases that can't otherwise be addressed with&nbsp;NumPy's vectorized operations and broadcasting."}]},{"block_type":"element","block":"k68oco2u","search_text":"Pandas fundamentals","text_count":19,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Pandas fundamentals"}]},{"block_type":"element","block":"k68oco2v","search_text":"While NumPy deals mostly with arrays, Pandas main data structures are pandas.Series , pandas.DataFrame , and pandas.Panel . In the rest of this chapter, we will abbreviate pandas with pd .","text_count":188,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"While NumPy deals mostly with arrays, Pandas main data structures are"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pandas.Series"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pandas.DataFrame"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pandas.Panel"}]},{"block_type":"text","content":". In the rest of this chapter, we will abbreviate"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pandas"}]},{"block_type":"text","content":"with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68oco2w","search_text":"The main difference between a pd.Series object and an np.array is that a pd.Series object associates a specific key to each element of an array. Let’s see how this works in practice with an example.","text_count":198,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The main difference between a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"object and an"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.array"}]},{"block_type":"text","content":"is that a&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"object associates a specific"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"key"}]},{"block_type":"text","content":"to each element of an array. Let&rsquo;s see how this works in practice with an example."}]},{"block_type":"element","block":"k68oco2x","search_text":"Let's assume that we are trying to test a new blood pressure drug, and we want to store, for each patient, whether the patient's blood pressure improved after administering the drug. We can encode this information by associating to each subject ID (represented by an integer), True if the drug was effective, and False otherwise.","text_count":329,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's assume that we are trying to test a new blood pressure drug, and we want to store, for each patient,&nbsp;whether the patient's blood pressure improved after administering the drug. We can encode this information by associating to each subject ID (represented by&nbsp;an integer), &nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"True"}]},{"block_type":"text","content":"&nbsp;if the drug was effective, and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"False"}]},{"block_type":"text","content":"otherwise."}]},{"block_type":"element","block":"k68oco2y","search_text":"We can create a pd.Series object by associating an array of keys, the patients, to the array of values that represent the drug effectiveness. The array of keys can be passed to the Series constructor using the index argument, as shown in the following snippet:","text_count":260,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"object by associating an&nbsp;array of keys, the patients, to the array of values that represent the drug effectiveness. The array of keys can be passed to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Series"}]},{"block_type":"text","content":"constructor using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"index"}]},{"block_type":"text","content":"argument, as shown in the following snippet:"}]},{"block_type":"element","block":"k68oco2z","search_text":"import pandas as pd patients = [0, 1, 2, 3] effective = [True, True, False, False] effective_series = pd.Series(effective, index=patients) ","text_count":139,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import pandas as pd\n    patients = [0, 1, 2, 3]\n    effective = [True, True, False, False]\n\n    effective_series = pd.Series(effective, index=patients)"}]}]},{"block_type":"element","block":"k68oco30","search_text":"Associating a set of integers from 0 to N to a set of values can technically be implemented with np.array , since, in this case, the key will simply be the position of the element in the array. In Pandas, keys are not limited to integers but can also be strings, floating point numbers, and also generic (hashable) Python objects. For example, we can easily turn our IDs into strings with little effort, as shown in the following code:","text_count":435,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Associating a set of integers from 0 to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":"to a set of values can technically be implemented with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.array"}]},{"block_type":"text","content":", since, in this case, the key will simply be the position of the element in the array. In Pandas, keys are not limited to integers but can also be strings, floating point numbers, and also generic (hashable) Python objects. For example, we can easily turn our IDs into strings with little effort, as shown in the following code:"}]},{"block_type":"element","block":"k68oco31","search_text":"patients = [\"a\", \"b\", \"c\", \"d\"] effective = [True, True, False, False] effective_series = pd.Series(effective, index=patients) ","text_count":127,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"patients = [\"a\", \"b\", \"c\", \"d\"]\n    effective = [True, True, False, False]\n\n    effective_series = pd.Series(effective, index=patients)"}]}]},{"block_type":"element","block":"k68oco32","search_text":"An interesting observation is that, while NumPy arrays can be thought of as a contiguous collection of values similar to Python lists, the Pandas pd.Series object can be thought of as a structure that maps keys to values, similar to Python dictionaries.","text_count":253,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An interesting observation is that, while NumPy arrays can be thought of as a contiguous collection of values similar to Python lists, the Pandas"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"object can be thought of as a structure that maps keys to values, similar to Python dictionaries."}]},{"block_type":"element","block":"k68oco33","search_text":"What if you want to store the initial and final blood pressure for each patient? In Pandas, one can use a pd.DataFrame object to associate multiple data to each key.","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What if you want to store the initial and final blood pressure for each patient? In Pandas, one can use a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"object to associate&nbsp;multiple data to each key."}]},{"block_type":"element","block":"k68oco34","search_text":"pd.DataFrame can be initialized, similarly to a pd.Series object, by passing a dictionary of columns and an index. In the following example, we will see how to create a pd.DataFrame containing four columns that represent the initial and final measurements of systolic and dyastolic blood pressure for our patients:","text_count":314,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"can be initialized, similarly to a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"object, by passing a dictionary of columns and an index. In the following example, we will&nbsp;see how to create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"containing four columns that represent the initial and final measurements of systolic and dyastolic blood pressure for our patients:"}]},{"block_type":"element","block":"k68oco35","search_text":"patients = [\"a\", \"b\", \"c\", \"d\"] columns = { \"sys_initial\": [120, 126, 130, 115], \"dia_initial\": [75, 85, 90, 87], \"sys_final\": [115, 123, 130, 118], \"dia_final\": [70, 82, 92, 87] } df = pd.DataFrame(columns, index=patients) ","text_count":224,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"patients = [\"a\", \"b\", \"c\", \"d\"]\n\n    columns = {\n      \"sys_initial\": [120, 126, 130, 115],\n      \"dia_initial\": [75, 85, 90, 87],\n      \"sys_final\": [115, 123, 130, 118],\n      \"dia_final\": [70, 82, 92, 87]\n    }\n    \n    df = pd.DataFrame(columns, index=patients)"}]}]},{"block_type":"element","block":"k68oco36","search_text":"Equivalently, you can think of a pd.DataFrame as a collection of pd.Series . In fact, it is possible to directly initialize a pd.DataFrame , using a dictionary of pd.Series instances:","text_count":183,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Equivalently, you can think of a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"as a collection of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":". In fact, it is possible to directly initialize a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":", using a dictionary of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"instances:"}]},{"block_type":"element","block":"k68oco37","search_text":"columns = { \"sys_initial\": pd.Series([120, 126, 130, 115], index=patients), \"dia_initial\": pd.Series([75, 85, 90, 87], index=patients), \"sys_final\": pd.Series([115, 123, 130, 118], index=patients), \"dia_final\": pd.Series([70, 82, 92, 87], index=patients) } df = pd.DataFrame(columns) ","text_count":284,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"columns = {\n      \"sys_initial\": pd.Series([120, 126, 130, 115], index=patients),\n      \"dia_initial\": pd.Series([75, 85, 90, 87], index=patients),\n      \"sys_final\": pd.Series([115, 123, 130, 118], index=patients),\n      \"dia_final\": pd.Series([70, 82, 92, 87], index=patients)\n    }\n    df = pd.DataFrame(columns)"}]}]},{"block_type":"element","block":"k68oco38","search_text":"To inspect the content of a pd.DataFrame or pd.Series object, you can use the pd.Series.head and pd.DataFrame.head methods, which print the first few rows of the dataset:","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To inspect the content of a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"object, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series.head"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame.head"}]},{"block_type":"text","content":"methods, which print&nbsp;the first few rows of the dataset:"}]},{"block_type":"element","block":"k68oco39","search_text":"effective_series.head() # Output: # a True # b True # c False # d False # dtype: bool df.head() # Output: # dia_final dia_initial sys_final sys_initial # a 70 75 115 120 # b 82 85 123 126 # c 92 90 130 130 # d 87 87 118 115 ","text_count":224,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"effective_series.head()\n    # Output:\n    # a True\n    # b True\n    # c False\n    # d False\n    # dtype: bool\n\n    df.head()\n    # Output:\n    #    dia_final  dia_initial  sys_final  sys_initial\n    # a         70           75        115          120\n    # b         82           85        123          126\n    # c         92           90        130          130\n    # d         87           87        118          115"}]}]},{"block_type":"element","block":"k68oco3a","search_text":"Just like a pd.DataFrame can be used to store a collection of pd.Series , you can use a pd.Panel to store a collection of pd.DataFrames . We will not cover the usage of pd.Panel as it is not used as often as pd.Series and pd.DataFrame . To learn more about pd.Panel , ensure that you refer to the excellent documentation at http://pandas.pydata.org/pandas-docs/stable/dsintro.html#panel .","text_count":388,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Just like a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"&nbsp;can be used to store a collection of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":", you can use a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Panel"}]},{"block_type":"text","content":"to store a collection of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrames"}]},{"block_type":"text","content":". We will not cover the usage of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Panel"}]},{"block_type":"text","content":"as&nbsp;it is&nbsp;not used as often as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":". To learn more about"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Panel"}]},{"block_type":"text","content":", ensure that you refer to the excellent documentation at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://pandas.pydata.org/pandas-docs/stable/dsintro.html#panel"},"children":[{"block_type":"text","content":"http://pandas.pydata.org/pandas-docs/stable/dsintro.html#panel"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68oco3b","search_text":"Indexing Series and DataFrame objects","text_count":37,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Indexing Series and DataFrame objects"}]},{"block_type":"element","block":"k68oco3c","search_text":"Retrieving data from a pd.Series , given its key , can be done intuitively by indexing the pd.Series.loc attribute:","text_count":115,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Retrieving data from a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":", given its"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"key"}]},{"block_type":"text","content":", can be done intuitively by indexing&nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series.loc"}]},{"block_type":"text","content":"attribute:"}]},{"block_type":"element","block":"k68oco3d","search_text":"effective_series.loc[\"a\"] # Result: # True ","text_count":43,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"effective_series.loc[\"a\"]\n    # Result:\n    # True"}]}]},{"block_type":"element","block":"k68oco3e","search_text":"It is also possible to access the elements, given its position in the underlying array, using the pd.Series.iloc attribute:","text_count":123,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is also possible to access the elements, given its"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"position"}]},{"block_type":"text","content":"in the underlying array, using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series.iloc"}]},{"block_type":"text","content":"attribute:"}]},{"block_type":"element","block":"k68oco3f","search_text":"effective_series.iloc[0] # Result: # True ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"effective_series.iloc[0]\n    # Result:\n    # True"}]}]},{"block_type":"element","block":"k68oco3g","search_text":"You can also use the pd.Series.ix attribute for mixed access. If the key is not an integer, it will try to match by key, otherwise it will extract the element at the position indicated by the integer. A similar behavior will take place when you access the pd.Series directly. The following example demonstrates these concepts:","text_count":326,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can also use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series.ix"}]},{"block_type":"text","content":"attribute for mixed access.&nbsp;If the key is not an integer, it will try to match by key, otherwise it will extract the element at the position indicated by the integer. A similar behavior will&nbsp;take place&nbsp;when you access the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"directly. The following example demonstrates these concepts:"}]},{"block_type":"element","block":"k68oco3h","search_text":"effective_series.ix[\"a\"] # By key effective_series.ix[0] # By position # Equivalent effective_series[\"a\"] # By key effective_series[0] # By position ","text_count":149,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"effective_series.ix[\"a\"] # By key\n    effective_series.ix[0]   # By position\n\n    # Equivalent\n    effective_series[\"a\"] # By key\n    effective_series[0]   # By position"}]}]},{"block_type":"element","block":"k68oco3i","search_text":"Note that if the index is made of integers, this method will fall back to the key-only method (like loc ). To index by position in this scenario, the iloc method is your only option.","text_count":182,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that if the index is made of integers, this method will fall back to the key-only method (like"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"loc"}]},{"block_type":"text","content":"). To index by position in this scenario, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"iloc"}]},{"block_type":"text","content":"method is your only option."}]},{"block_type":"element","block":"k68oco3j","search_text":"Indexing pd.DataFrame works in a similar way. For example, you can use pd.DataFrame.loc to extract a row by key, and you can use pd.DataFrame.iloc to extract a row by position:","text_count":176,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Indexing"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"&nbsp;works in a similar way. For example, you can use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame.loc"}]},{"block_type":"text","content":"to extract a row by key, and you can use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame.iloc"}]},{"block_type":"text","content":"to extract a row by position:"}]},{"block_type":"element","block":"k68oco3k","search_text":"df.loc[\"a\"] df.iloc[0] # Result: # dia_final 70 # dia_initial 75 # sys_final 115 # sys_initial 120 # Name: a, dtype: int64 ","text_count":123,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.loc[\"a\"]\n    df.iloc[0]\n    # Result:\n    # dia_final 70\n    # dia_initial 75\n    # sys_final 115\n    # sys_initial 120\n    # Name: a, dtype: int64"}]}]},{"block_type":"element","block":"k68oco3l","search_text":"An important aspect is that the return type in this case is a pd.Series , where each column is a new key. In order to retrieve a specific row and column, you can use the following code. The loc attribute will index both row and column by key, while the iloc version will index row and column by an integer:","text_count":306,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An important aspect is that the return type in this case is a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":", where each column is a new key. In order to retrieve a specific row and column, you can use the following code. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"loc"}]},{"block_type":"text","content":"attribute will index both row and column by key, while the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"iloc"}]},{"block_type":"text","content":"version will index row and column by an integer:"}]},{"block_type":"element","block":"k68oco3m","search_text":"df.loc[\"a\", \"sys_initial\"] # is equivalent to df.loc[\"a\"].loc[\"sys_initial\"] df.iloc[0, 1] # is equivalent to df.iloc[0].iloc[1] ","text_count":129,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.loc[\"a\", \"sys_initial\"] # is equivalent to\n    df.loc[\"a\"].loc[\"sys_initial\"]\n\n    df.iloc[0, 1] # is equivalent to\n    df.iloc[0].iloc[1]"}]}]},{"block_type":"element","block":"k68oco3n","search_text":"Indexing a pd.DataFrame using the ix attribute is convenient to mix and match index and location-based indexing. For example, retrieving the \"sys_initial\" column for the row at position 0 can be accomplished as follows:","text_count":219,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Indexing a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ix"}]},{"block_type":"text","content":"attribute is convenient&nbsp;to mix and match index and location-based indexing. For example, retrieving the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"\"sys_initial\""}]},{"block_type":"text","content":"column for the row at position 0 can be accomplished&nbsp;as follows:"}]},{"block_type":"element","block":"k68oco3o","search_text":"df.ix[0, \"sys_initial\"] ","text_count":24,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.ix[0, \"sys_initial\"]"}]}]},{"block_type":"element","block":"k68oco3p","search_text":"Retrieving a column from a pd.DataFrame by name can be achieved by regular indexing or attribute access. To retrieve a column by position, you can either use iloc or use the pd.DataFrame.column attribute to retrieve the name of the column:","text_count":239,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Retrieving&nbsp;a column from a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"by name can be achieved by regular indexing or attribute access. &nbsp;To retrieve a column by position, you can either use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"iloc"}]},{"block_type":"text","content":"or use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame.column"}]},{"block_type":"text","content":"&nbsp;attribute to retrieve the name of the column:"}]},{"block_type":"element","block":"k68oco3q","search_text":"# Retrieve column by name df[\"sys_initial\"] # Equivalent to df.sys_initial # Retrieve column by position df[df.columns[2]] # Equivalent to df.iloc[:, 2] ","text_count":153,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# Retrieve column by name\n    df[\"sys_initial\"] # Equivalent to\n    df.sys_initial\n\n    # Retrieve column by position\n    df[df.columns[2]] # Equivalent to\n    df.iloc[:, 2]"}]}]},{"block_type":"element","block":"k68oco3r","search_text":"The mentioned methods also support more advanced indexing similar to those of NumPy, such as bool , lists, and int arrays.","text_count":122,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The mentioned methods&nbsp;also support more advanced indexing similar to those of NumPy, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bool"}]},{"block_type":"text","content":", lists, and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int"}]},{"block_type":"text","content":"arrays."}]},{"block_type":"element","block":"k68oco3s","search_text":"Now it's time for some performance considerations. There are some differences between an index in Pandas and a dictionary. For example, while the keys of a dictionary cannot contain duplicates, Pandas indexes can contain repeated elements. This flexibility, however, comes at a cost--if we try to access an element in a non-unique index, we may incur substantial performance loss--the access will be O ( N ), like a linear search, rather than O (1), like a dictionary.","text_count":468,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now it's time for some performance considerations. There are some differences between an index in Pandas and a dictionary. For example, while the keys of a dictionary cannot contain duplicates, Pandas indexes can contain repeated&nbsp;elements. This flexibility, however, comes at a cost--if we try to access an element in a non-unique index, we may incur substantial&nbsp;performance loss--the access will be"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":"), like a linear search, rather than"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1), like a dictionary."}]},{"block_type":"element","block":"k68oco3t","search_text":"A way to mitigate this effect is to sort the index; this will allow Pandas to use a binary search algorithm with a computational complexity of O ( log ( N )), which is much better. This can be accomplished using the pd.Series.sort_index function, as in the following code (the same applies for pd.DataFrame ):","text_count":309,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A way to mitigate this effect is to sort the index; this will allow Pandas to use a binary search algorithm with a&nbsp;computational&nbsp;complexity of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"log"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":")), which is much better. This can be accomplished using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series.sort_index"}]},{"block_type":"text","content":"function, as in the following code (the same applies for"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k68oco3u","search_text":"# Create a series with duplicate index index = list(range(1000)) + list(range(1000)) # Accessing a normal series is a O(N) operation series = pd.Series(range(2000), index=index) # Sorting the will improve look-up scaling to O(log(N)) series.sort_index(inplace=True) ","text_count":266,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# Create a series with duplicate index\n    index = list(range(1000)) + list(range(1000))\n\n    # Accessing a normal series is a O(N) operation\n    series = pd.Series(range(2000), index=index)\n\n    # Sorting the will improve look-up scaling to O(log(N))\n    series.sort_index(inplace=True)"}]}]},{"block_type":"element","block":"k68oco3v","search_text":"The timings for the different versions are summarized in the following table:","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The timings for the different versions are summarized in the following table:"}]},{"block_type":"element","block":"k68oco3w","search_text":"Index type N=10000 N=20000 N=30000 Time Unique 12.30 12.58 13.30 O (1) Non unique 494.95 814.10 1129.95 O (N) Non unique (sorted) 145.93 145.81 145.66 O ( log ( N )) ","text_count":166,"tag_name":"table","attributes":{},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Index type"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=10000"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=20000"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"N=30000"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Time"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"Unique"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"12.30"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"12.58"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"13.30"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(1)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"Non unique"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"494.95"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"814.10"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"1129.95"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"(N)"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"Non unique (sorted)"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"145.93"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"145.81"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"145.66"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"log"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":"))"}]}]}]}]},{"block_type":"element","block":"k68oco3x","search_text":"Database-style operations with Pandas","text_count":37,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Database-style operations with Pandas"}]},{"block_type":"element","block":"k68oco3y","search_text":"You may have noted that the “tabular” data is similar to what is usually stored in a database. A database is usually indexed using a primary key, and the various columns can have different data types, just like in a pd.DataFrame . ","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You may have noted that the &ldquo;tabular&rdquo; data is similar to what is usually stored in a database. A database is usually indexed using a primary key, and the various columns can have different data types, just like in a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":".&nbsp;"}]},{"block_type":"element","block":"k68oco3z","search_text":"The efficiency of the index operations in Pandas makes it suitable for database style manipulations, such as counting, joining, grouping, and aggregations.","text_count":155,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The efficiency of the index operations in&nbsp;Pandas makes it suitable for database style manipulations, such as counting, joining, grouping, and aggregations."}]},{"block_type":"element","block":"k68oco40","search_text":"Mapping","text_count":7,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Mapping"}]},{"block_type":"element","block":"k68oco41","search_text":"Pandas supports element-wise operations just like NumPy (after all, pd.Series stores their data using np.array ). For example, it is possible to apply transformation very easily on both pd.Series and pd.DataFrame :","text_count":214,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Pandas supports&nbsp;element-wise operations just like NumPy (after all,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"stores their data using&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.array"}]},{"block_type":"text","content":"). For example, it is possible to apply transformation very easily on both"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco42","search_text":"np.log(df.sys_initial) # Logarithm of a series df.sys_initial ** 2 # Square a series np.log(df) # Logarithm of a dataframe df ** 2 # Square of a dataframe ","text_count":155,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"np.log(df.sys_initial) # Logarithm of a series\n    df.sys_initial ** 2    # Square a series\n    np.log(df)             # Logarithm of a dataframe\n    df ** 2                # Square of a dataframe"}]}]},{"block_type":"element","block":"k68oco43","search_text":"You can also perform element-wise operations between two pd.Series in a way similar to NumPy. An important difference is that the operands will be matched by key, rather than by position; if there is a mismatch in the index, the resulting value will be set to NaN . Both the scenarios are exemplified in the following example:","text_count":326,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can also perform element-wise operations between two"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"in a way similar to NumPy. An important difference is&nbsp;that&nbsp;the operands will be matched by key, rather than by position; if there is a mismatch in the index, the resulting value will be set to&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"NaN"}]},{"block_type":"text","content":". Both the scenarios are&nbsp;exemplified in the following example:"}]},{"block_type":"element","block":"k68oco44","search_text":"# Matching index a = pd.Series([1, 2, 3], index=[\"a\", \"b\", \"c\"]) b = pd.Series([4, 5, 6], index=[\"a\", \"b\", \"c\"]) a + b # Result: # a 5 # b 7 # c 9 # dtype: int64 # Mismatching index b = pd.Series([4, 5, 6], index=[\"a\", \"b\", \"d\"]) # Result: # a 5.0 # b 7.0 # c NaN # d NaN # dtype: float64 ","text_count":289,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# Matching index\n    a = pd.Series([1, 2, 3], index=[\"a\", \"b\", \"c\"])\n    b = pd.Series([4, 5, 6], index=[\"a\", \"b\", \"c\"])\n    a + b\n    # Result: \n    # a 5\n    # b 7\n    # c 9\n    # dtype: int64\n\n    # Mismatching index\n    b = pd.Series([4, 5, 6], index=[\"a\", \"b\", \"d\"])\n    # Result:\n    # a 5.0\n    # b 7.0\n    # c NaN\n    # d NaN\n    # dtype: float64"}]}]},{"block_type":"element","block":"k68oco45","search_text":"For added flexibility, Pandas exposes the map , apply , and applymap methods that can be used to apply specific transformations.","text_count":128,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For added flexibility, Pandas exposes the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"apply"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"applymap"}]},{"block_type":"text","content":"methods&nbsp;that can be used to apply specific transformations."}]},{"block_type":"element","block":"k68oco46","search_text":"The pd.Series.map method can be used to execute a function to each value and return a pd.Series containing each result. In the following example, we show how to apply the superstar function to each element of a pd.Series :","text_count":222,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series.map"}]},{"block_type":"text","content":"method can be used to execute a function to each value and return a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"containing each result. In the following example, we show how to apply the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"superstar"}]},{"block_type":"text","content":"&nbsp;function to each element of a&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco47","search_text":"a = pd.Series([1, 2, 3], index=[\"a\", \"b\", \"c\"]) def superstar(x): return '*' + str(x) + '*' a.map(superstar) # Result: # a *1* # b *2* # c *3* # dtype: object ","text_count":159,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = pd.Series([1, 2, 3], index=[\"a\", \"b\", \"c\"])\n    def superstar(x):\n        return '*' + str(x) + '*'\n    a.map(superstar)\n\n    # Result:\n    # a *1*\n    # b *2*\n    # c *3*\n    # dtype: object"}]}]},{"block_type":"element","block":"k68oco48","search_text":"The pd.DataFrame.applymap function is the equivalent of pd.Series.map , but for DataFrames :","text_count":92,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame.applymap"}]},{"block_type":"text","content":"function is the equivalent of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series.map"}]},{"block_type":"text","content":", but for"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrames"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco49","search_text":"df.applymap(superstar) # Result: # dia_final dia_initial sys_final sys_initial # a *70* *75* *115* *120* # b *82* *85* *123* *126* # c *92* *90* *130* *130* # d *87* *87* *118* *115* ","text_count":183,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.applymap(superstar)\n    # Result:\n    #    dia_final  dia_initial  sys_final  sys_initial\n    # a       *70*         *75*      *115*        *120*\n    # b       *82*         *85*      *123*        *126*\n    # c       *92*         *90*      *130*        *130*\n    # d       *87*         *87*      *118*        *115*"}]}]},{"block_type":"element","block":"k68oco4a","search_text":"Finally, the pd.DataFrame.apply function can apply the passed function to each column or each row, rather than element-wise. The selection can be performed with the argument axis, where a value of 0 (the default) corresponds to columns, and 1 corresponds to rows. Also, note that the return value of apply is a pd.Series :","text_count":322,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame.apply"}]},{"block_type":"text","content":"function can apply the passed function to each column or&nbsp;each row, rather than element-wise. The selection can be performed with the argument axis, where a value of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"(the default) corresponds to columns, and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"corresponds to rows. Also, note&nbsp;that the return value of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"apply"}]},{"block_type":"text","content":"is a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco4b","search_text":"df.apply(superstar, axis=0) # Result: # dia_final *a 70nb 82nc 92nd 87nName: dia... # dia_initial *a 75nb 85nc 90nd 87nName: dia... # sys_final *a 115nb 123nc 130nd 118nName:... # sys_initial *a 120nb 126nc 130nd 115nName:... # dtype: object df.apply(superstar, axis=1) # Result: # a *dia_final 70ndia_initial 75nsys_f... # b *dia_final 82ndia_initial 85nsys_f... # c *dia_final 92ndia_initial 90nsys_f... # d *dia_final 87ndia_initial 87nsys_f... # dtype: object ","text_count":464,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.apply(superstar, axis=0)\n    # Result:\n    # dia_final *a 70nb 82nc 92nd 87nName: dia...\n    # dia_initial *a 75nb 85nc 90nd 87nName: dia...\n    # sys_final *a 115nb 123nc 130nd 118nName:...\n    # sys_initial *a 120nb 126nc 130nd 115nName:...\n    # dtype: object\n\n    df.apply(superstar, axis=1)\n    # Result:\n    # a *dia_final 70ndia_initial 75nsys_f...\n    # b *dia_final 82ndia_initial 85nsys_f...\n    # c *dia_final 92ndia_initial 90nsys_f...\n    # d *dia_final 87ndia_initial 87nsys_f...\n    # dtype: object"}]}]},{"block_type":"element","block":"k68oco4c","search_text":"Pandas also supports efficient numexpr -style expressions with the convenient eval method. For example, if we want to calculate the difference in the final and initial blood pressure, we can write the expression as a string, as shown in the following code:","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Pandas also supports efficient&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":"-style expressions with the convenient&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"eval"}]},{"block_type":"text","content":"method. For example, if we want to calculate the difference in the final and initial blood pressure, we can write the expression as a string, as shown in the following code:"}]},{"block_type":"element","block":"k68oco4d","search_text":"df.eval(\"sys_final - sys_initial\") # Result: # a -5 # b -3 # c 0 # d 3 # dtype: int64 ","text_count":86,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.eval(\"sys_final - sys_initial\")\n    # Result:\n    # a -5\n    # b -3\n    # c 0\n    # d 3\n    # dtype: int64"}]}]},{"block_type":"element","block":"k68oco4e","search_text":"It is also possible to create new columns using the assignment operator in the pd.DataFrame.eval expression. Note that, if the inplace=True argument is used, the operation will be applied directly on the original pd.DataFrame ; otherwise, the function will return a new dataframe. In the next example, we compute the difference between sys_final and sys_initial , and we store it in the sys_delta column:","text_count":404,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is also possible to create new columns&nbsp;using the assignment operator in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame.eval"}]},{"block_type":"text","content":"&nbsp;expression. Note that, if the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"inplace=True"}]},{"block_type":"text","content":"argument is used, the operation will be applied directly on the original"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"; otherwise, the function will return a new dataframe. In the next example, we compute the difference between"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sys_final"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sys_initial"}]},{"block_type":"text","content":", and we store it in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sys_delta"}]},{"block_type":"text","content":"column:"}]},{"block_type":"element","block":"k68oco4f","search_text":"df.eval(\"sys_delta = sys_final - sys_initial\", inplace=False) # Result: # dia_final dia_initial sys_final sys_initial sys_delta # a 70 75 115 120 -5 # b 82 85 123 126 -3 # c 92 90 130 130 0 # d 87 87 118 115 3 ","text_count":210,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.eval(\"sys_delta = sys_final - sys_initial\", inplace=False)\n# Result:\n#     dia_final   dia_initial   sys_final   sys_initial   sys_delta\n# a          70            75         115           120          -5\n# b          82            85         123           126          -3\n# c          92            90         130           130           0\n# d          87            87         118           115           3"}]}]},{"block_type":"element","block":"k68oco4g","search_text":"Grouping, aggregations, and transforms","text_count":38,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Grouping, aggregations, and transforms"}]},{"block_type":"element","block":"k68oco4h","search_text":"One of the most appreciated features of Pandas is the simple and concise expression of data analysis pipelines that requires grouping, transforming, and aggregating the data. To demonstrate this concept, let's extend our dataset by adding two new patients to whom we didn't administer the treatment (this is usually called a control group ). We also include a column, drug_admst , which records whether the patient was administered the treatment:","text_count":446,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the most appreciated&nbsp;features of Pandas is the simple and concise expression of data analysis pipelines that requires grouping, transforming, and aggregating the data. To demonstrate this concept, let's extend our dataset by adding two new patients to whom we didn't administer the treatment (this is usually called a&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"control group"}]},{"block_type":"text","content":"). We also include a column,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"drug_admst"}]},{"block_type":"text","content":", which&nbsp;records whether&nbsp;the patient was administered the treatment:"}]},{"block_type":"element","block":"k68oco4i","search_text":"patients = [\"a\", \"b\", \"c\", \"d\", \"e\", \"f\"] columns = { \"sys_initial\": [120, 126, 130, 115, 150, 117], \"dia_initial\": [75, 85, 90, 87, 90, 74], \"sys_final\": [115, 123, 130, 118, 130, 121], \"dia_final\": [70, 82, 92, 87, 85, 74], \"drug_admst\": [True, True, True, True, False, False] } df = pd.DataFrame(columns, index=patients) ","text_count":324,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"patients = [\"a\", \"b\", \"c\", \"d\", \"e\", \"f\"]\n\n    columns = {\n      \"sys_initial\": [120, 126, 130, 115, 150, 117],\n      \"dia_initial\": [75, 85, 90, 87, 90, 74],\n      \"sys_final\": [115, 123, 130, 118, 130, 121],\n      \"dia_final\": [70, 82, 92, 87, 85, 74],\n      \"drug_admst\": [True, True, True, True, False, False]\n    }\n\n    df = pd.DataFrame(columns, index=patients)"}]}]},{"block_type":"element","block":"k68oco4j","search_text":"At this point, we may be interested to know how the blood pressure changed between the two groups. You can group the patients according to drug_amst using the pd.DataFrame.groupby function. The return value will be the DataFrameGroupBy object, which can be iterated to obtain a new pd.DataFrame for each value of the drug_admst column:","text_count":335,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we may be interested to know how the blood pressure changed between the&nbsp;two groups. You can group the patients according to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"drug_amst"}]},{"block_type":"text","content":"&nbsp;using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame.groupby"}]},{"block_type":"text","content":"function. The return value will be the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrameGroupBy"}]},{"block_type":"text","content":"object, which can be iterated to obtain a new"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"for each value of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"drug_admst"}]},{"block_type":"text","content":"column:"}]},{"block_type":"element","block":"k68oco4k","search_text":"df.groupby('drug_admst') for value, group in df.groupby('drug_admst'): print(\"Value: {}\".format(value)) print(\"Group DataFrame:\") print(group) # Output: # Value: False # Group DataFrame: # dia_final dia_initial drug_admst sys_final sys_initial # e 85 90 False 130 150 # f 74 74 False 121 117 # Value: True # Group DataFrame: # dia_final dia_initial drug_admst sys_final sys_initial # a 70 75 True 115 120 # b 82 85 True 123 126 # c 92 90 True 130 130 # d 87 87 True 118 115 ","text_count":474,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.groupby('drug_admst')\n    for value, group in df.groupby('drug_admst'):\n        print(\"Value: {}\".format(value))\n        print(\"Group DataFrame:\")\n        print(group)\n# Output:\n# Value: False\n# Group DataFrame:\n#    dia_final   dia_initial   drug_admst   sys_final   sys_initial\n# e         85            90        False         130           150\n# f         74            74        False         121           117\n# Value: True\n# Group DataFrame:\n#    dia_final   dia_initial   drug_admst   sys_final   sys_initial\n# a         70            75         True         115           120\n# b         82            85         True         123           126\n# c         92            90         True         130           130\n# d         87            87         True         118           115"}]}]},{"block_type":"element","block":"k68oco4l","search_text":"Iterating on the DataFrameGroupBy object is almost never necessary, because, thanks to method chaining, it is possible to calculate group-related properties directly. For example, we may want to calculate mean, max, or standard deviation for each group. All those operations that summarize the data in some way are called aggregations and can be performed using the agg method. The result of agg is another pd.DataFrame that relates the grouping variables and the result of the aggregation, as illustrated in the following code:","text_count":528,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Iterating on the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrameGroupBy"}]},{"block_type":"text","content":"object is almost never necessary, because, thanks to method chaining, it is possible to calculate group-related properties&nbsp;directly. For example, we may want to calculate mean, max, or standard deviation for each group. All those operations that summarize the data in some way&nbsp;are called aggregations and can be performed using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"agg"}]},{"block_type":"text","content":"method. The result of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"agg"}]},{"block_type":"text","content":"is another"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"&nbsp;that relates the grouping variables and the result of the aggregation, as illustrated in the following code:"}]},{"block_type":"element","block":"k68oco4m","search_text":"df.groupby('drug_admst').agg(np.mean) # dia_final dia_initial sys_final sys_initial # drug_admst # False 79.50 82.00 125.5 133.50 # True 82.75 84.25 121.5 122.75 ","text_count":162,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.groupby('drug_admst').agg(np.mean)\n#              dia_final   dia_initial   sys_final   sys_initial\n# drug_admst \n# False            79.50         82.00       125.5        133.50\n# True             82.75         84.25       121.5        122.75"}]}]},{"block_type":"element","block":"k68oco4n","search_text":"It is also possible to perform processing on the DataFrame groups that do not represent a summarization. One common example of such an operation is filling in missing values. Those intermediate steps are called transforms .","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"It&nbsp;is also possible to perform processing on the DataFrame groups that do not represent a summarization. One common example of such an operation is filling in missing values. Those intermediate steps are called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"transforms"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68oco4o","search_text":"We can illustrate this concept with an example. Let's assume that we have a few missing values in our dataset, and we want to replace those values with the average of the other values in the same group. This can be accomplished using a transform, as follows:","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can illustrate this concept with an example. Let's assume that we have a few missing values in our dataset, and we want to replace those values with the average of the other values in the same group. This can be accomplished using a transform, as follows:"}]},{"block_type":"element","block":"k68oco4p","search_text":"df.loc['a','sys_initial'] = None df.groupby('drug_admst').transform(lambda df: df.fillna(df.mean())) # dia_final dia_initial sys_final sys_initial # a 70 75 115 123.666667 # b 82 85 123 126.000000 # c 92 90 130 130.000000 # d 87 87 118 115.000000 # e 85 90 130 150.000000 # f 74 74 121 117.000000 ","text_count":297,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.loc['a','sys_initial'] = None\ndf.groupby('drug_admst').transform(lambda df: df.fillna(df.mean())) \n#     dia_final    dia_initial   sys_final   sys_initial\n# a          70             75         115    123.666667\n# b          82             85         123    126.000000\n# c          92             90         130    130.000000\n# d          87             87         118    115.000000\n# e          85             90         130    150.000000\n# f          74             74         121    117.000000"}]}]},{"block_type":"element","block":"k68oco4q","search_text":"Joining","text_count":7,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Joining"}]},{"block_type":"element","block":"k68oco4r","search_text":"Joins are useful to aggregate data that is scattered among different tables. Let’s say that we want to include the location of the hospital in which patient measurements were taken in our dataset. We can reference the location for each patient using the H1 , H2 , and H3 labels, and we can store the address and identifier of the hospital in a hospital table:","text_count":359,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Joins are useful to aggregate&nbsp;data that is scattered among different tables. Let&rsquo;s say that we want to include the location of the&nbsp;hospital in which patient measurements were taken in our dataset. We can reference&nbsp;the location for each patient using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"H1"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"H2"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"H3"}]},{"block_type":"text","content":"labels,&nbsp;and we can store&nbsp;the address and identifier of the hospital in a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hospital"}]},{"block_type":"text","content":"table:"}]},{"block_type":"element","block":"k68oco4s","search_text":"hospitals = pd.DataFrame( { \"name\" : [\"City 1\", \"City 2\", \"City 3\"], \"address\" : [\"Address 1\", \"Address 2\", \"Address 3\"], \"city\": [\"City 1\", \"City 2\", \"City 3\"] }, index=[\"H1\", \"H2\", \"H3\"]) hospital_id = [\"H1\", \"H2\", \"H2\", \"H3\", \"H3\", \"H3\"] df['hospital_id'] = hospital_id ","text_count":273,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"hospitals = pd.DataFrame(\n      { \"name\" : [\"City 1\", \"City 2\", \"City 3\"],\n        \"address\" : [\"Address 1\", \"Address 2\", \"Address 3\"],\n        \"city\": [\"City 1\", \"City 2\", \"City 3\"] },\n      index=[\"H1\", \"H2\", \"H3\"])\n\n    hospital_id = [\"H1\", \"H2\", \"H2\", \"H3\", \"H3\", \"H3\"]\n    df['hospital_id'] = hospital_id"}]}]},{"block_type":"element","block":"k68oco4t","search_text":"Now, we want to find the city where the measure was taken for each patient. We need to map the keys from the hospital_id column to the city stored in the hospitals table.","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, we want to find&nbsp;the city where the measure was taken for each patient. We need to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"the keys&nbsp;from the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hospital_id"}]},{"block_type":"text","content":"&nbsp;column to the city stored in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hospitals"}]},{"block_type":"text","content":"table."}]},{"block_type":"element","block":"k68oco4u","search_text":"This can surely be implemented in Python using dictionaries:","text_count":60,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This can surely&nbsp;be implemented in Python using dictionaries:"}]},{"block_type":"element","block":"k68oco4v","search_text":"hospital_dict = { \"H1\": (\"City 1\", \"Name 1\", \"Address 1\"), \"H2\": (\"City 2\", \"Name 2\", \"Address 2\"), \"H3\": (\"City 3\", \"Name 3\", \"Address 3\") } cities = [hospital_dict[key][0] for key in hospital_id] ","text_count":198,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"hospital_dict = {\n     \"H1\": (\"City 1\", \"Name 1\", \"Address 1\"),\n     \"H2\": (\"City 2\", \"Name 2\", \"Address 2\"),\n     \"H3\": (\"City 3\", \"Name 3\", \"Address 3\")\n    }\n    cities = [hospital_dict[key][0] \n               for key in hospital_id]"}]}]},{"block_type":"element","block":"k68oco4w","search_text":"This algorithm runs efficiently with an O ( N ) time complexity, where N is the size of hospital_id . Pandas allows you to encode the same operation using simple indexing; the advantage is that the join will be performed in heavily optimized Cython and with efficient hashing algorithms. The preceding simple Python expression can be easily converted to Pandas in this way:","text_count":373,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This algorithm runs efficiently with an&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":") time complexity, where"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":"is the size of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hospital_id"}]},{"block_type":"text","content":".&nbsp;Pandas allows you to encode the same operation using simple indexing; the advantage is that the join will be performed in heavily optimized Cython and with efficient hashing algorithms. The preceding simple Python expression can be easily converted to Pandas in this way:"}]},{"block_type":"element","block":"k68oco4x","search_text":"cities = hospitals.loc[hospital_id, \"city\"] ","text_count":44,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cities = hospitals.loc[hospital_id, \"city\"]"}]}]},{"block_type":"element","block":"k68oco4y","search_text":"More advanced joins can also be performed with the pd.DataFrame.join method, which will produce a new pd.DataFrame that will attach the hospital information for each patient:","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"More advanced joins can also be performed with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame.join"}]},{"block_type":"text","content":"method, which&nbsp;will produce a new"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":"&nbsp;that will attach the hospital information for each patient:"}]},{"block_type":"element","block":"k68oco4z","search_text":"result = df.join(hospitals, on='hospital_id') result.columns # Result: # Index(['dia_final', 'dia_initial', 'drug_admst', # 'sys_final', 'sys_initial', # 'hospital_id', 'address', 'city', 'name'], # dtype='object') ","text_count":215,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"result = df.join(hospitals, on='hospital_id')\n    result.columns\n    # Result:\n    # Index(['dia_final', 'dia_initial', 'drug_admst', \n    # 'sys_final', 'sys_initial',\n    # 'hospital_id', 'address', 'city', 'name'],\n    # dtype='object')"}]}]},{"block_type":"element","block":"k68oco50","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k68oco51","search_text":"In this chapter, we learned how to manipulate NumPy arrays and how to write fast mathematical expressions using array broadcasting. This knowledge will help you write more concise, expressive code and, at the same time, to obtain substantial performance gains. We also introduced the numexpr library to further speed up NumPy calculations with minimal effort.","text_count":359,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we learned how to manipulate NumPy arrays and how to write fast mathematical expressions using array broadcasting. This knowledge will help you write more concise, expressive code and, at the same time, to obtain&nbsp;substantial performance gains. We also introduced the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":"library to further speed up NumPy&nbsp;calculations with minimal effort."}]},{"block_type":"element","block":"k68oco52","search_text":"Pandas implements efficient data structures that are useful when analyzing large datasets. In particular, Pandas shines when the data is indexed by non-integer keys and provides very fast hashing algorithms.","text_count":207,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Pandas implements efficient data structures that are useful when analyzing large datasets. In particular, Pandas shines when the data is indexed by non-integer keys and provides very fast hashing algorithms."}]},{"block_type":"element","block":"k68oco53","search_text":"NumPy and Pandas work well when handling large, homogenous inputs, but they are not suitable when the expressions grow complex and the operations cannot be expressed using the tools provided by these libraries. In such cases, we can leverage Python capabilities as a glue language by interfacing it with C using the Cython package.","text_count":331,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"NumPy and Pandas work well when handling large, homogenous inputs, but they are not suitable when the expressions grow complex and the operations cannot be expressed using the tools provided by these libraries.&nbsp;In such cases, we can leverage Python capabilities as a glue language by interfacing it with C using the Cython package."}]}]},{"title":"C Performance with Cython","author":"Gabriele Lanaro","block":"k68ocgrt","number":4,"contents":[{"block_type":"element","block":"k68oco54","search_text":"Cython is a language that extends Python by supporting the declaration of types for functions, variables, and classes. These typed declarations enable Cython to compile Python scripts to efficient C code. Cython can also act as a bridge between Python and C as it provides easy-to-use constructs to write interfaces to external C and C++ routines.","text_count":347,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Cython is a language that extends Python by supporting the&nbsp;declaration of types for functions, variables, and classes.&nbsp;These typed declarations enable Cython to compile Python scripts to efficient C code. Cython can also&nbsp;act as a bridge between Python and C as it provides easy-to-use constructs to write interfaces to external C and C++ routines."}]},{"block_type":"element","block":"k68oco55","search_text":"In this chapter, we will learn the following things:","text_count":52,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will learn the following things:"}]},{"block_type":"element","block":"k68oco56","search_text":"Cython syntax basics How to compile Cython programs How to use static typing to generate fast code How to efficiently manipulate arrays using typed memoryviews Optimizing a sample particle simulator Tips on using Cython in the Jupyter notebook The profiling tools available for Cython ","text_count":285,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Cython syntax basics"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"How to compile Cython programs"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"How to use"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"static typing"}]},{"block_type":"text","content":"to generate fast code"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"How to efficiently manipulate arrays using&nbsp;typed"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"memoryviews"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Optimizing a sample particle simulator"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Tips on using Cython in the Jupyter notebook"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The profiling tools available for Cython"}]}]},{"block_type":"element","block":"k68oco57","search_text":"While a minimum knowledge of C is helpful, this chapter focuses only on Cython in the context of Python optimization. Therefore, it doesn't require any C background.","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"While a minimum knowledge of C is helpful, this chapter focuses only on Cython in the context of Python optimization. Therefore, it doesn't require any C background."}]},{"block_type":"element","block":"k68oco58","search_text":"Compiling Cython extensions","text_count":27,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Compiling Cython extensions"}]},{"block_type":"element","block":"k68oco59","search_text":"The Cython syntax is, by design, a superset of Python. Cython can compile, with a few exceptions, most Python modules without requiring any change. Cython source files have the .pyx extension and can be compiled to produce a C file using the cython command.","text_count":257,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Cython syntax is, by design, a superset of Python.&nbsp;Cython can compile, with a few exceptions, most Python modules without requiring any change. Cython source files have the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".pyx"}]},{"block_type":"text","content":"extension and can be compiled to produce a C file using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cython"}]},{"block_type":"text","content":"command."}]},{"block_type":"element","block":"k68oco5a","search_text":"Our first Cython script will contain a simple function that prints Hello, World! as the output. Create a new hello.pyx file containing the following code:","text_count":154,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our first Cython script will contain a simple function that prints"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Hello, World!"}]},{"block_type":"text","content":"&nbsp;as the output. Create a new"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello.pyx"}]},{"block_type":"text","content":"file containing the following code:"}]},{"block_type":"element","block":"k68oco5b","search_text":"def hello(): print('Hello, World!') ","text_count":36,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def hello(): \n      print('Hello, World!')"}]}]},{"block_type":"element","block":"k68oco5c","search_text":"The cython command will read hello.pyx and generate the hello.c file:","text_count":69,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cython"}]},{"block_type":"text","content":"command will read"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello.pyx"}]},{"block_type":"text","content":"and generate the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello.c"}]},{"block_type":"text","content":"file:"}]},{"block_type":"element","block":"k68oco5d","search_text":"$ cython hello.pyx ","text_count":19,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ cython hello.pyx"}]}]},{"block_type":"element","block":"k68oco5e","search_text":"To compile hello.c to a Python extension module, we will use the GCC compiler. We need to add some Python-specific compilation options that depend on the operating system. It's important to specify the directory that contains the header files; in the following example, the directory is /usr/include/python3.5/ :","text_count":312,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To compile"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello.c"}]},{"block_type":"text","content":"to a Python extension module, we will use the GCC&nbsp;compiler. We need to add some Python-specific compilation options that depend on the operating system. It's important to specify the directory that contains the header files; in the following example, the directory is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"/usr/include/python3.5/"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco5f","search_text":"$ gcc -shared -pthread -fPIC -fwrapv -O2 -Wall -fno-strict-aliasing -lm -I/usr/include/python3.5/ -o hello.so hello.c ","text_count":118,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ gcc -shared -pthread -fPIC -fwrapv -O2 -Wall -fno-strict-aliasing -lm -I/usr/include/python3.5/ -o hello.so hello.c"}]}]},{"block_type":"element","block":"k68oco5g","search_text":"Note To find your Python include directory, you can use the distutils utility: sysconfig.get_python_inc . To execute it, you can simply issue the following python -c \"from distutils import sysconfig; print(sysconfig.get_python_inc())\" command. ","text_count":244,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To find your Python include directory, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"distutils"}]},{"block_type":"text","content":"utility:&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sysconfig.get_python_inc"}]},{"block_type":"text","content":". To execute it, you can simply issue the following&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"python -c \"from distutils import sysconfig; print(sysconfig.get_python_inc())\""}]},{"block_type":"text","content":"&nbsp;command."}]}]},{"block_type":"element","block":"k68oco5h","search_text":"This will produce a file called hello.so , a C extension module that is directly importable into a Python session:","text_count":114,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This will produce a file called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello.so"}]},{"block_type":"text","content":", a C extension module that is directly importable into a Python session:"}]},{"block_type":"element","block":"k68oco5i","search_text":">>> import hello >>> hello.hello() Hello, World! ","text_count":49,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&gt;&gt;&gt; import hello \n    &gt;&gt;&gt; hello.hello() \n    Hello, World!"}]}]},{"block_type":"element","block":"k68oco5j","search_text":"Cython accepts both Python 2 and Python 3 as input and output languages. In other words, you can compile a Python 3 script hello.pyx file using the -3 option:","text_count":158,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Cython accepts both Python 2 and Python 3 as input and output languages. In other words, you can compile a Python 3 script&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello.pyx"}]},{"block_type":"text","content":"file using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-3"}]},{"block_type":"text","content":"option:"}]},{"block_type":"element","block":"k68oco5k","search_text":"$ cython -3 hello.pyx ","text_count":22,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ cython -3 hello.pyx"}]}]},{"block_type":"element","block":"k68oco5l","search_text":"The generated hello.c can be compiled without any changes to Python 2 and Python 3 by including the corresponding headers with the -I option, as follows:","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The generated"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello.c"}]},{"block_type":"text","content":"can be compiled without any changes to Python 2 and Python 3 by including the corresponding headers with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-I"}]},{"block_type":"text","content":"option, as follows:"}]},{"block_type":"element","block":"k68oco5m","search_text":"$ gcc -I/usr/include/python3.5 # ... other options $ gcc -I/usr/include/python2.7 # ... other options ","text_count":102,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ gcc -I/usr/include/python3.5 # ... other options\n$ gcc -I/usr/include/python2.7 # ... other options"}]}]},{"block_type":"element","block":"k68oco5n","search_text":"A Cython program can be compiled in a more straightforward way using distutils , the standard Python packaging tool. By writing a setup.py script, we can compile the .pyx file directly to an extension module. To compile our hello.pyx example, we can write a minimal setup.py containing the following code:","text_count":305,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A Cython program can be compiled in a more straightforward way using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"distutils"}]},{"block_type":"text","content":", the standard Python packaging tool. By writing a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup.py"}]},{"block_type":"text","content":"script, we can compile the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".pyx"}]},{"block_type":"text","content":"file directly to an extension module. To compile our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello.pyx"}]},{"block_type":"text","content":"example, we can&nbsp;write a minimal&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup.py"}]},{"block_type":"text","content":"containing the following code:"}]},{"block_type":"element","block":"k68oco5o","search_text":"from distutils.core import setup from Cython.Build import cythonize setup( name='Hello', ext_modules = cythonize('hello.pyx') ) ","text_count":128,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from distutils.core import setup \n    from Cython.Build import cythonize \n\n    setup( \n      name='Hello',\n      ext_modules = cythonize('hello.pyx')\n    )"}]}]},{"block_type":"element","block":"k68oco5p","search_text":"In the first two lines of the preceding code, we import the setup function and the cythonize helper. The setup function contains a few key-value pairs that specify the name of the application and the extensions that need to be built.","text_count":233,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the first two lines of the preceding&nbsp;code, we import the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup"}]},{"block_type":"text","content":"function and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cythonize"}]},{"block_type":"text","content":"helper. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup"}]},{"block_type":"text","content":"function contains a few key-value pairs that specify&nbsp;the name of the application and the&nbsp;extensions that need to be built."}]},{"block_type":"element","block":"k68oco5q","search_text":"The cythonize helper takes either a string or a list of strings containing the Cython modules we want to compile. You can also use glob patterns using the following code:","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cythonize"}]},{"block_type":"text","content":"helper takes either a string or a list of strings containing the Cython modules we want to compile. You can also use glob patterns using the following code:"}]},{"block_type":"element","block":"k68oco5r","search_text":"cythonize(['hello.pyx', 'world.pyx', '*.pyx']) ","text_count":47,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cythonize(['hello.pyx', 'world.pyx', '*.pyx'])"}]}]},{"block_type":"element","block":"k68oco5s","search_text":"To compile our extension module using distutils , you can execute the setup.py script using the following code:","text_count":111,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To compile our extension module using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"distutils"}]},{"block_type":"text","content":", you can execute the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup.py"}]},{"block_type":"text","content":"script using the following code:"}]},{"block_type":"element","block":"k68oco5t","search_text":"$ python setup.py build_ext --inplace ","text_count":38,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ python setup.py build_ext --inplace"}]}]},{"block_type":"element","block":"k68oco5u","search_text":"The build_ext option tells the script to build the extension modules indicated in ext_modules , while the --inplace option tells the script to place the hello.so output file in the same location as the source file (instead of a build directory).","text_count":245,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"build_ext"}]},{"block_type":"text","content":"option tells the script to build the extension modules indicated in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ext_modules"}]},{"block_type":"text","content":", while&nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"--inplace"}]},{"block_type":"text","content":"option tells the script to place&nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello.so"}]},{"block_type":"text","content":"output file in the same location as the source file (instead of a build directory)."}]},{"block_type":"element","block":"k68oco5v","search_text":"Cython modules can also be automatically compiled using pyximport . All that's needed is a call to pyximport.install() at the beginning of your script (or you need to issue the command in your interpreter). After doing that, you can import .pyx files directly and pyximport will transparently compile the corresponding Cython modules:","text_count":334,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Cython modules can also be automatically compiled using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyximport"}]},{"block_type":"text","content":". All that's needed is a call to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyximport.install()"}]},{"block_type":"text","content":"at the beginning of your script (or you need to issue the command in your interpreter). After doing that, you can import"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".pyx"}]},{"block_type":"text","content":"files directly and&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyximport"}]},{"block_type":"text","content":"will transparently compile the corresponding Cython modules:"}]},{"block_type":"element","block":"k68oco5w","search_text":">>> import pyximport >>> pyximport.install() >>> import hello # This will compile hello.pyx ","text_count":92,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&gt;&gt;&gt; import pyximport \n    &gt;&gt;&gt; pyximport.install() \n    &gt;&gt;&gt; import hello # This will compile hello.pyx"}]}]},{"block_type":"element","block":"k68oco5x","search_text":"Unfortunately, pyximport will not work for all kinds of configurations (for example, when they involve a combination of C and Cython files), but it comes handy for testing simple scripts.","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Unfortunately,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyximport"}]},{"block_type":"text","content":"will not work for all kinds of configurations (for example, when they involve a combination of C and Cython files), but it comes handy for testing simple scripts."}]},{"block_type":"element","block":"k68oco5y","search_text":"Since version 0.13, IPython includes the cythonmagic extension to interactively write and test a series of Cython statements. You can load the extensions in an IPython shell using load_ext :","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Since version 0.13, IPython includes the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cythonmagic"}]},{"block_type":"text","content":"extension to interactively write and test a series of Cython statements. You can load the extensions in an IPython shell using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"load_ext"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco5z","search_text":"%load_ext cythonmagic ","text_count":22,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%load_ext cythonmagic"}]}]},{"block_type":"element","block":"k68oco60","search_text":"Once the extension is loaded, you can use the %%cython cell magic to write a multiline Cython snippet. In the following example, we define a hello_snippet function that will be compiled and added to the IPython session namespace:","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once the extension is loaded, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%%cython"}]},{"block_type":"text","content":"&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"cell magic"}]},{"block_type":"text","content":"to write a multiline Cython snippet. In the following example, we define a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello_snippet"}]},{"block_type":"text","content":"function that will be compiled and added to the IPython session&nbsp;namespace:"}]},{"block_type":"element","block":"k68oco61","search_text":"%%cython def hello_snippet(): print(\"Hello, Cython!\") hello_snippet() Hello, Cython! ","text_count":85,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%%cython \n    def hello_snippet(): \n        print(\"Hello, Cython!\") \n\n    hello_snippet()\n    Hello,  Cython!"}]}]},{"block_type":"element","block":"k68oco62","search_text":"Adding static types","text_count":19,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Adding static types"}]},{"block_type":"element","block":"k68oco63","search_text":"In Python, a variable can be associated to objects of different types during the execution of the program. While this feature is desirable as it makes the language flexible and dynamic, it also adds a significant overhead to the interpreter as it needs to look up type and methods of the variables at runtime, making it difficult to perform various optimizations. Cython extends the Python language with explicit type declarations so that it can generate efficient C extensions through compilation.","text_count":498,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Python, a variable&nbsp;can be associated to objects of different types&nbsp;during the execution of the program. While this feature is desirable as it makes the language flexible and dynamic, it also adds a significant overhead to the interpreter as it needs to look up&nbsp;type and methods of the variables at runtime, making it difficult&nbsp;to perform various optimizations. Cython extends the Python language with explicit type declarations so that it can generate efficient C extensions through compilation."}]},{"block_type":"element","block":"k68oco64","search_text":"The main way to declare data types in Cython is through cdef statements. The cdef keyword can be used in multiple contexts, such as variables, functions, and extension types (statically-typed classes).","text_count":201,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The main way to declare data types in Cython is through&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cdef"}]},{"block_type":"text","content":"statements. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cdef"}]},{"block_type":"text","content":"keyword can be used in multiple contexts, such as variables, functions, and extension types (statically-typed classes)."}]},{"block_type":"element","block":"k68oco65","search_text":"Variables","text_count":9,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Variables"}]},{"block_type":"element","block":"k68oco66","search_text":"In Cython, you can declare the type of a variable by prepending the variable with cdef and its respective type. For example, we can declare the i variable as a 16 bit integer in the following way:","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Cython, you can declare the type of a variable by prepending the variable with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cdef"}]},{"block_type":"text","content":"and its respective type. For example, we can declare the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"i"}]},{"block_type":"text","content":"variable as a 16 bit integer in the following way:"}]},{"block_type":"element","block":"k68oco67","search_text":"cdef int i ","text_count":11,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef int i"}]}]},{"block_type":"element","block":"k68oco68","search_text":"The cdef statement supports multiple variable names on the same line along with optional initialization, as seen in the following line:","text_count":135,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cdef"}]},{"block_type":"text","content":"statement supports multiple variable names on the same line along with optional initialization, as seen in the following line:"}]},{"block_type":"element","block":"k68oco69","search_text":"cdef double a, b = 2.0, c = 3.0 ","text_count":32,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef double a, b = 2.0, c = 3.0"}]}]},{"block_type":"element","block":"k68oco6a","search_text":"Typed variables are treated differently in comparison to regular variables. In Python, variables are often described as labels that refer to objects in memory. For example, we could assign the value 'hello' to the a variable at any point in the program without restriction:","text_count":273,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Typed variables are treated differently in comparison to regular&nbsp;variables. In Python, variables are often described as&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"labels"}]},{"block_type":"text","content":"&nbsp;that refer to objects in memory. For example, we could assign the value&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"'hello'"}]},{"block_type":"text","content":"to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"&nbsp;variable at any point in the program&nbsp;without restriction:"}]},{"block_type":"element","block":"k68oco6b","search_text":"a = 'hello' ","text_count":12,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = 'hello'"}]}]},{"block_type":"element","block":"k68oco6c","search_text":"The a variable holds a reference to the 'hello' string. We can also freely assign another value (for example, the integer 1 ) to the same variable later in the code:","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"&nbsp;variable holds a reference to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"'hello'"}]},{"block_type":"text","content":"&nbsp;string. We can also freely assign another value (for example, the integer"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":") to the same variable later in the code:"}]},{"block_type":"element","block":"k68oco6d","search_text":"a = 1 ","text_count":6,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = 1"}]}]},{"block_type":"element","block":"k68oco6e","search_text":"Python will assign the integer 1 to the a variable without any problem.","text_count":71,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Python will assign the integer"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"&nbsp;to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"variable without any problem."}]},{"block_type":"element","block":"k68oco6f","search_text":"Typed variables behave quite differently and are usually described as data containers: we can only store values that fit into the container that is determined by its data type. For example, if we declare the a variable as int , and then we try to assign it to a double , Cython will trigger an error, as shown in the following code:","text_count":332,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Typed variables behave quite differently and are usually described as&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"data containers:"}]},{"block_type":"text","content":"&nbsp;we can only&nbsp;store&nbsp;values that fit into the container that is determined by its data type. For example, if we declare the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"variable as&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int"}]},{"block_type":"text","content":", and then we try to assign it to a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"double"}]},{"block_type":"text","content":", Cython will trigger an error, as shown in the following code:"}]},{"block_type":"element","block":"k68oco6g","search_text":"%%cython cdef int i i = 3.0 # Output has been cut ...cf4b.pyx:2:4 Cannot assign type 'double' to 'int' ","text_count":103,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%%cython \n    cdef int i \n    i = 3.0 \n\n    # Output has been cut \n    ...cf4b.pyx:2:4 Cannot assign type 'double' to 'int'"}]}]},{"block_type":"element","block":"k68oco6h","search_text":"Static typing makes it easy for the compiler to perform useful optimizations. For example, if we declare a loop index as int , Cython will rewrite the loop in pure C without needing to step into the Python interpreter. The typing declaration guarantees that the type of the index will always be int and cannot be overwritten at runtime so that the compiler is free to perform the optimizations without compromising the program correctness.","text_count":439,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Static typing makes it easy for the compiler to perform&nbsp;useful optimizations. For example, if we declare a loop index as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int"}]},{"block_type":"text","content":", Cython will rewrite the loop in pure C without needing to step into the Python interpreter. The typing declaration guarantees that the type of the index will always be"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int"}]},{"block_type":"text","content":"and cannot be overwritten at runtime so that the compiler is free to perform the optimizations without compromising the program correctness."}]},{"block_type":"element","block":"k68oco6i","search_text":"We can assess the speed gain in this case with a small test case. In the following example, we implement a simple loop that increments a variable 100 times. With Cython, the example function can be coded as follows:","text_count":215,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can assess the speed gain in this case with a small test case.&nbsp;In the following example, we implement a simple loop that increments a variable 100 times. With Cython, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"example"}]},{"block_type":"text","content":"function can be coded as follows:"}]},{"block_type":"element","block":"k68oco6j","search_text":"%%cython def example(): cdef int i, j=0 for i in range(100): j += 1 return j example() # Result: # 100 ","text_count":103,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%%cython \n    def example(): \n       cdef int i, j=0 \n       for i in range(100):\n           j += 1 \n       return j \n\n    example() \n    # Result:\n    # 100"}]}]},{"block_type":"element","block":"k68oco6k","search_text":"We can compare the speed of an analogous, untyped, pure Python loop:","text_count":68,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can compare the speed of an analogous, untyped, pure Python loop:"}]},{"block_type":"element","block":"k68oco6l","search_text":"def example_python(): j=0 for i in range(100): j += 1 return j %timeit example() 10000000 loops, best of 3: 25 ns per loop %timeit example_python() 100000 loops, best of 3: 2.74 us per loop ","text_count":190,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def example_python(): \n        j=0 \n        for i in range(100):\n            j += 1 \n        return j \n\n    %timeit example() \n    10000000 loops, best of 3: 25 ns per loop \n    %timeit example_python() \n    100000 loops, best of 3: 2.74 us per loop"}]}]},{"block_type":"element","block":"k68oco6m","search_text":"The speedup obtained by implementing this simple type declaration is a whopping 100x! This works because the Cython loop has first been converted to pure C and then to efficient machine code, while the Python loop still relies on the slow interpreter.","text_count":251,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The speedup obtained by implementing this simple type declaration&nbsp;is a whopping 100x! This works because the Cython loop has first been converted to pure C and then to efficient machine code, while the Python loop still relies on the slow interpreter."}]},{"block_type":"element","block":"k68oco6n","search_text":"In Cython, it is possible to declare a variable to be of any standard C type, and it is also possible to define custom types using classic C constructs, such as struct , enum , and typedef .","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Cython, it is possible to declare a variable to be of any standard C type, and it is also possible&nbsp;to&nbsp;define custom types using classic C constructs, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"struct"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"enum"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"typedef"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68oco6o","search_text":"An interesting example is that if we declare a variable to be of the object type, the variable will accept any kind of Python object:","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An interesting example is that if we declare a variable to be of the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"object"}]},{"block_type":"text","content":"type, the variable will accept any kind of Python object:"}]},{"block_type":"element","block":"k68oco6p","search_text":"cdef object a_py # both 'hello' and 1 are Python objects a_py = 'hello' a_py = 1 ","text_count":81,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef object a_py \n    # both 'hello' and 1 are Python objects \n    a_py = 'hello' \n    a_py = 1"}]}]},{"block_type":"element","block":"k68oco6q","search_text":"Note that declaring a variable as object has no performance benefits as accessing and operating on the object will still require the interpreter to look up the underlying type of the variable and its attributes and methods.","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that declaring a variable as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"object"}]},{"block_type":"text","content":"has no performance benefits as accessing and operating on the object will still require the interpreter to look up the underlying type of the variable and its attributes and methods."}]},{"block_type":"element","block":"k68oco6r","search_text":"Sometimes, certain data types (such as float and int numbers) are compatible in the sense that they can be converted into each other. In Cython, it is possible to convert ( cast ) between types by surrounding the destination type between pointy brackets, as shown in the following snippet:","text_count":289,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sometimes, certain data types (such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int"}]},{"block_type":"text","content":"numbers) are compatible in the sense that they can be converted into each other. In Cython, it is possible to convert ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"cast"}]},{"block_type":"text","content":") between types by surrounding the destination type between pointy brackets, as shown in the following snippet:"}]},{"block_type":"element","block":"k68oco6s","search_text":"cdef int a = 0 cdef double b b = <double> a ","text_count":44,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef int a = 0 \n    cdef double b \n    b = &lt;double&gt; a"}]}]},{"block_type":"element","block":"k68oco6t","search_text":"Functions","text_count":9,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Functions"}]},{"block_type":"element","block":"k68oco6u","search_text":"You can add type information to the arguments of a Python function by specifying the type in front of each of the argument names. Functions specified in this way will work and perform like regular Python functions, but their arguments will be type-checked. We can write a max_python function, which returns the greater value between two integers:","text_count":346,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can add type information to the arguments of a Python function by specifying the type in front of each of the argument names. Functions specified in this way will work and perform like regular Python functions, but their arguments will be type-checked. We can write a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max_python"}]},{"block_type":"text","content":"function, which returns the greater value between two integers:"}]},{"block_type":"element","block":"k68oco6v","search_text":"def max_python(int a, int b): return a if a > b else b ","text_count":55,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def max_python(int a, int b):\n        return a if a &gt; b else b"}]}]},{"block_type":"element","block":"k68oco6w","search_text":"A function specified in this way will perform type-checking and treat the arguments as typed variables, just like in cdef definitions. However, the function will still be a Python function, and calling it multiple times will still need to switch back to the interpreter. To allow Cython for function call optimizations, we should declare the type of the return type using a cdef statement:","text_count":389,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A function specified in this way will perform type-checking and treat the arguments as typed variables, just like in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cdef"}]},{"block_type":"text","content":"definitions. However, the function will still be a Python function, and calling it multiple times will still need to switch back to the interpreter. To allow Cython for function call optimizations, we should declare the type of the return type using a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cdef"}]},{"block_type":"text","content":"statement:"}]},{"block_type":"element","block":"k68oco6x","search_text":"cdef int max_cython(int a, int b): return a if a > b else b ","text_count":60,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef int max_cython(int a, int b): \n        return a if a &gt; b else b"}]}]},{"block_type":"element","block":"k68oco6y","search_text":"Functions declared in this way are translated to native C functions and have much less overhead compared to Python functions. A substantial drawback is that they can't be used from Python, but only from Cython, and their scope is restricted to the same Cython file unless they're exposed in a definition file (refer to the Sharing declarations section).","text_count":353,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Functions declared in this way are translated to native C functions and have much less overhead compared to Python functions. A substantial drawback is that they can't be used from Python, but only from Cython, and their scope is restricted to the same Cython file unless they're exposed in a definition file (refer to the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Sharing declarations"}]},{"block_type":"text","content":"section)."}]},{"block_type":"element","block":"k68oco6z","search_text":"Fortunately, Cython allows you to define functions that are both callable from Python and translatable to performant C functions. If you declare a function with a cpdef statement, Cython will generate two versions of the function: a Python version available to the interpreter, and a fast C function usable from Cython. The cpdef syntax is equivalent to cdef , shown as follows:","text_count":378,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Fortunately, Cython allows you to define functions that are both callable from Python and translatable to performant C functions. If you declare a function with a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cpdef"}]},{"block_type":"text","content":"statement, Cython will generate two versions of the function: a Python version available to the interpreter, and a fast C function usable from Cython. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cpdef"}]},{"block_type":"text","content":"syntax is equivalent to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cdef"}]},{"block_type":"text","content":", shown as follows:"}]},{"block_type":"element","block":"k68oco70","search_text":"cpdef int max_hybrid(int a, int b): return a if a > b else b ","text_count":61,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cpdef int max_hybrid(int a, int b): \n        return a if a &gt; b else b"}]}]},{"block_type":"element","block":"k68oco71","search_text":"Sometimes, the call overhead can be a performance issue even with C functions, especially when the same function is called many times in a critical loop. When the function body is small, it is convenient to add the inline keyword in front of the function definition; the function call will be replaced by the function body itself. Our max function is a good candidate for inlining :","text_count":382,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sometimes, the call overhead can be a performance issue even with C functions, especially when the same function is called many times in a critical loop. When the function body is small, it is convenient to add the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"inline"}]},{"block_type":"text","content":"keyword in front of the function definition; the function call will be replaced by the function body itself. Our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max"}]},{"block_type":"text","content":"function is a good candidate for"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"inlining"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco72","search_text":"cdef inline int max_inline(int a, int b): return a if a > b else b ","text_count":67,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef inline int max_inline(int a, int b): \n        return a if a &gt; b else b"}]}]},{"block_type":"element","block":"k68oco73","search_text":"Classes","text_count":7,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Classes"}]},{"block_type":"element","block":"k68oco74","search_text":"We can define an extension type using the cdef class statement and declaring its attributes in the class body. For example, we can create an extension type-- Point --as shown in the following code, which stores two coordinates ( x , y ) of the double type:","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can define an extension type using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cdef class"}]},{"block_type":"text","content":"statement and declaring its attributes in the class body. For example, we can create an extension type--"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Point"}]},{"block_type":"text","content":"--as shown in the following code, which stores two coordinates ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":") of the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"double"}]},{"block_type":"text","content":"&nbsp;type:"}]},{"block_type":"element","block":"k68oco75","search_text":"cdef class Point cdef double x cdef double y def __init__(self, double x, double y): self.x = x self.y = y ","text_count":107,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef class Point\n        cdef double x \n        cdef double y\n        def __init__(self, double x, double y): \n            self.x = x \n            self.y = y"}]}]},{"block_type":"element","block":"k68oco76","search_text":"Accessing the declared attributes in the class methods allows Cython to bypass expensive Python attribute look-ups by direct access to the given fields in the underlying C struct . For this reason, attribute access in typed classes is an extremely fast operation.","text_count":263,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Accessing the declared attributes in the class methods allows Cython to bypass expensive Python attribute look-ups by direct access to the given fields in the underlying C"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"struct"}]},{"block_type":"text","content":". For this reason, attribute access in typed classes is an extremely fast operation."}]},{"block_type":"element","block":"k68oco77","search_text":"To use the cdef class in your code, you need to explicitly declare the type of the variables you intend to use at compile time. You can use the extension type name (such as Point ) in any context where you will use a standard type (such as double , float , and int ). For example, if we want a Cython function that calculates the distance from the origin (in the example, the function is called norm ) of a Point , we have to declare the input variable as Point , as shown in the following code:","text_count":495,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cdef class"}]},{"block_type":"text","content":"in your code, you need to explicitly declare the type of the variables you intend to use at compile time. You can use the extension type name (such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Point"}]},{"block_type":"text","content":") in any context where you will&nbsp;use a standard type (such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"double"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float"}]},{"block_type":"text","content":", and&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int"}]},{"block_type":"text","content":"). For example, if we want a Cython function that calculates the distance from the origin (in the example, the function is called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"norm"}]},{"block_type":"text","content":") of a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Point"}]},{"block_type":"text","content":", we have to declare the input variable as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Point"}]},{"block_type":"text","content":", as shown in the following code:"}]},{"block_type":"element","block":"k68oco78","search_text":"cdef double norm(Point p): return (p.x**2 + p.y**2)**0.5 ","text_count":57,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef double norm(Point p): \n        return (p.x**2 + p.y**2)**0.5"}]}]},{"block_type":"element","block":"k68oco79","search_text":"Just like typed functions, typed classes have some limitations. If you try to access an extension type attribute from Python, you will get an AttributeError , as follows:","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Just like typed functions, typed classes have some limitations. If you try to access an extension type attribute from Python, you will get an"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"AttributeError"}]},{"block_type":"text","content":", as follows:"}]},{"block_type":"element","block":"k68oco7a","search_text":">>> a = Point(0.0, 0.0) >>> a.x AttributeError: 'Point' object has no attribute 'x' ","text_count":84,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&gt;&gt;&gt; a = Point(0.0, 0.0) \n    &gt;&gt;&gt; a.x \n    AttributeError: 'Point' object has no attribute 'x'"}]}]},{"block_type":"element","block":"k68oco7b","search_text":"In order to access attributes from Python code, you have to use the public (for read/write access) or readonly specifiers in the attribute declaration, as shown in the following code:","text_count":183,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In order to access attributes from Python code, you have to use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"public"}]},{"block_type":"text","content":"(for read/write access) or"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"readonly"}]},{"block_type":"text","content":"specifiers in the attribute declaration, as shown in the following code:"}]},{"block_type":"element","block":"k68oco7c","search_text":"cdef class Point: cdef public double x ","text_count":39,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef class Point: \n        cdef public double x"}]}]},{"block_type":"element","block":"k68oco7d","search_text":"Additionally, methods can be declared with the cpdef statement, just like regular functions.","text_count":92,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Additionally, methods can be declared with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cpdef"}]},{"block_type":"text","content":"statement, just like regular functions."}]},{"block_type":"element","block":"k68oco7e","search_text":"Extension types do not support the addition of extra attributes at runtime. In order to do that, a solution is defining a Python class that is a subclass of the typed class and extends its attributes and methods in pure Python.","text_count":227,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Extension types do not support the addition of extra attributes at runtime. In order to do that, a solution is defining a Python class that is a subclass of the typed class and extends its attributes and methods in pure Python."}]},{"block_type":"element","block":"k68oco7f","search_text":"Sharing declarations","text_count":20,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Sharing declarations"}]},{"block_type":"element","block":"k68oco7g","search_text":"When writing your Cython modules, you may want to reorganize your most used functions and classes declaration in a separate file so that they can be reused in different modules. Cython allows you to put these components in a definition file and access them with cimport statements .","text_count":282,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When writing your Cython modules, you may want to reorganize your most used functions and classes declaration in a separate file so that they can be reused in different modules. Cython allows you to put these components in a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"definition file"}]},{"block_type":"text","content":"and access them with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cimport"}]},{"block_type":"text","content":"statements"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68oco7h","search_text":"Let's say that we have a module with the max and min functions, and we want to reuse those functions in multiple Cython programs. If we simply write a bunch of functions in a .pyx file, the declarations will be confined to the same file.","text_count":237,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's say that we have a module with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"min"}]},{"block_type":"text","content":"&nbsp;functions, and we want to reuse those functions in multiple Cython programs. If we simply write a bunch of functions in a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".pyx"}]},{"block_type":"text","content":"file, the declarations will be confined to the same file."}]},{"block_type":"element","block":"k68oco7i","search_text":"Note Definition files are also used to interface Cython with external C code. The idea is to copy (or, more accurately, translate) the types and function prototypes in the definition file and leave the implementation in the external C code that will be compiled and linked in a separate step. ","text_count":293,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Definition files are also used to interface Cython with external C code. The idea is to copy (or, more accurately, translate) the types and function prototypes in the definition file and leave the implementation in the external C code that will be compiled and linked in a separate step."}]}]},{"block_type":"element","block":"k68oco7j","search_text":"To share the max and min functions, we need to write a definition file with a .pxd extension. Such a file only contains the types and function prototypes that we want to share with other modules--a public interface. We can declare the prototypes of our max and min functions in a file named mathlib.pxd , as follows:","text_count":316,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To share the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"min"}]},{"block_type":"text","content":"functions, we need to write a definition file with a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".pxd"}]},{"block_type":"text","content":"extension. Such a file only contains the types and function prototypes that we want to share with&nbsp;other modules--a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"public"}]},{"block_type":"text","content":"interface. We can declare the prototypes of our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"min"}]},{"block_type":"text","content":"functions in a file named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mathlib.pxd"}]},{"block_type":"text","content":", as follows:"}]},{"block_type":"element","block":"k68oco7k","search_text":"cdef int max(int a, int b) cdef int min(int a, int b) ","text_count":54,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef int max(int a, int b) \n    cdef int min(int a, int b)"}]}]},{"block_type":"element","block":"k68oco7l","search_text":"As you can see, we only write the function name and arguments without implementing the function body.","text_count":101,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, we only write the function name and arguments without implementing the function body."}]},{"block_type":"element","block":"k68oco7m","search_text":"The function implementation goes into the implementation file with the same base name but the .pyx extension-- mathlib.pyx :","text_count":124,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The function implementation goes into the implementation file with the same base name but the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".pyx"}]},{"block_type":"text","content":"extension--"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mathlib.pyx"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco7n","search_text":"cdef int max(int a, int b): return a if a > b else b cdef int min(int a, int b): return a if a < b else b ","text_count":106,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef int max(int a, int b): \n      return a if a &gt; b else b \n\n    cdef int min(int a, int b): \n      return a if a &lt; b else b"}]}]},{"block_type":"element","block":"k68oco7o","search_text":"The mathlib module is now importable from another Cython module.","text_count":64,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mathlib"}]},{"block_type":"text","content":"module is now importable from another Cython module."}]},{"block_type":"element","block":"k68oco7p","search_text":"To test our new Cython module, we will create a file named distance.pyx containing a function named chebyshev . The function will calculate the Chebyshev distance between two points, as shown in the following code. The Chebyshev distance between two coordinates-- (x1, y1) and (x2, y2) --is defined as the maximum value of the difference between each coordinate:","text_count":362,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To test our new Cython module, we will create a file named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"distance.pyx"}]},{"block_type":"text","content":"containing a function named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"chebyshev"}]},{"block_type":"text","content":". The function will calculate the Chebyshev distance between two points, as shown in the following code. The Chebyshev distance between two coordinates--"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(x1, y1)"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(x2, y2)"}]},{"block_type":"text","content":"--is defined as the maximum value of the difference between each coordinate:"}]},{"block_type":"element","block":"k68oco7q","search_text":"max(abs(x1 - x2), abs(y1 - y2)) ","text_count":32,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"max(abs(x1 - x2), abs(y1 - y2))"}]}]},{"block_type":"element","block":"k68oco7r","search_text":"To implement the chebyshev function, we will use the max function declared in mathlib.pxd by importing it with the cimport statement, as shown in the following code snippet:","text_count":173,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To implement the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"chebyshev"}]},{"block_type":"text","content":"function, we will use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max"}]},{"block_type":"text","content":"function declared in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mathlib.pxd"}]},{"block_type":"text","content":"by importing it with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cimport"}]},{"block_type":"text","content":"statement, as shown in the following code snippet:"}]},{"block_type":"element","block":"k68oco7s","search_text":"from mathlib cimport max def chebyshev(int x1, int y1, int x2, int y2): return max(abs(x1 - x2), abs(y1 - y2)) ","text_count":111,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from mathlib cimport max \n\n    def chebyshev(int x1, int y1, int x2, int y2): \n        return max(abs(x1 - x2), abs(y1 - y2))"}]}]},{"block_type":"element","block":"k68oco7t","search_text":"The cimport statement will read hello.pxd and the max definition will be used to generate the distance.c file.","text_count":110,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cimport"}]},{"block_type":"text","content":"statement will read"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello.pxd"}]},{"block_type":"text","content":"and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max"}]},{"block_type":"text","content":"definition will be used to generate the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"distance.c"}]},{"block_type":"text","content":"file."}]},{"block_type":"element","block":"k68oco7u","search_text":"Working with arrays","text_count":19,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Working with arrays"}]},{"block_type":"element","block":"k68oco7v","search_text":"Numerical and high performance calculations often make use of arrays. Cython provides an easy way to interact with them, using directly low-level C arrays, or the more general typed memoryviews .","text_count":195,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numerical and high performance calculations often make use of arrays. Cython provides an easy way to interact with them, using directly low-level C arrays, or the more general"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"typed memoryviews"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68oco7w","search_text":"C arrays and pointers","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"C arrays and pointers"}]},{"block_type":"element","block":"k68oco7x","search_text":"C arrays are a collection of items of the same type, stored contiguously in memory. Before digging into the details, it is helpful to understand (or review) how memory is managed in C.","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"C arrays are a collection of items of the same type, stored contiguously in memory. Before digging into the details, it is helpful to understand (or review) how memory is managed in C."}]},{"block_type":"element","block":"k68oco7y","search_text":"Variables in C are like containers. When creating a variable, a space in memory is reserved to store its value. For example, if we create a variable containing a 64 bit floating point number ( double ), the program will allocate 64 bit (16 bytes) of memory. This portion of memory can be accessed through an address to that memory location.","text_count":340,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Variables in C are like containers. When creating a variable, a space in memory is reserved to store its value. For example, if we create a variable containing a 64 bit floating point number ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"double"}]},{"block_type":"text","content":"), the program will allocate 64 bit (16 bytes) of memory. This portion of memory can be accessed through an address to that memory location."}]},{"block_type":"element","block":"k68oco7z","search_text":"To obtain the address of a variable, we can use the address operator denoted by the & symbol. We can also use the printf function, as follows, available in the libc.stdio Cython module to print the address of this variable:","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To obtain the address of a variable, we can use the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"address operator"}]},{"block_type":"text","content":"&nbsp;denoted by&nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"&amp;"}]},{"block_type":"text","content":"symbol. We can also use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"printf"}]},{"block_type":"text","content":"function, as follows, available in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"libc.stdio"}]},{"block_type":"text","content":"Cython module to print the address of this variable:"}]},{"block_type":"element","block":"k68oco80","search_text":"%%cython cdef double a from libc.stdio cimport printf printf(\"%p\", &a) # Output: # 0x7fc8bb611210 ","text_count":98,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%%cython \n    cdef double a \n    from libc.stdio cimport printf \n    printf(\"%p\", &amp;a)\n    # Output:\n    # 0x7fc8bb611210"}]}]},{"block_type":"element","block":"k68oco81","search_text":"Memory addresses can be stored in special variables, pointers , that can be declared by putting a * prefix in front of the variable name, as follows:","text_count":149,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Memory addresses can be stored in special variables,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pointers"}]},{"block_type":"text","content":", that can be declared by putting a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"*"}]},{"block_type":"text","content":"prefix in front of the variable name, as follows:"}]},{"block_type":"element","block":"k68oco82","search_text":"from libc.stdio cimport printf cdef double a cdef double *a_pointer a_pointer = &a # a_pointer and &a are of the same type ","text_count":123,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from libc.stdio cimport printf \n    cdef double a \n    cdef double *a_pointer \n    a_pointer = &amp;a # a_pointer and &amp;a are of the same type"}]}]},{"block_type":"element","block":"k68oco83","search_text":"If we have a pointer, and we want to grab the value contained in the address it's pointing at, we can use the dereference operator denoted by the * symbol. Be careful, the * used in this context has a different meaning from the * used in the variable declaration:","text_count":263,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we have a pointer, and we want to grab the value contained in the address it's pointing at, we can use the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"dereference operator"}]},{"block_type":"text","content":"&nbsp;denoted by&nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"*"}]},{"block_type":"text","content":"symbol. Be careful, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"*"}]},{"block_type":"text","content":"used in this context has a different meaning from the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"*"}]},{"block_type":"text","content":"used in the variable declaration:"}]},{"block_type":"element","block":"k68oco84","search_text":"cdef double a cdef double *a_pointer a_pointer = &a a = 3.0 print(*a_pointer) # prints 3.0 ","text_count":91,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef double a \n    cdef double *a_pointer \n    a_pointer = &amp;a \n\n    a = 3.0 \n    print(*a_pointer) # prints 3.0"}]}]},{"block_type":"element","block":"k68oco85","search_text":"When declaring a C array, the program allocates enough space to accommodate all the elements requested. For instance, to create an array that has 10 double values (16 bytes each), the program will reserve 16 * 10 = 160 bytes of contiguous space in memory. In Cython, we can declare such arrays using the following syntax:","text_count":321,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When declaring a C array, the program allocates enough space to accommodate all the elements requested. For instance, to create an array that has 10"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"double"}]},{"block_type":"text","content":"values (16 bytes each), the program will reserve&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"16 * 10 = 160"}]},{"block_type":"text","content":"bytes of contiguous space in memory. In Cython, we can declare such arrays using the following syntax:"}]},{"block_type":"element","block":"k68oco86","search_text":"cdef double arr[10] ","text_count":20,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef double arr[10]"}]}]},{"block_type":"element","block":"k68oco87","search_text":"We can also declare a multidimensional array, such as an array with 5 rows and 2 columns, using the following syntax:","text_count":117,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can also declare a multidimensional array, such as&nbsp;an array with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"5"}]},{"block_type":"text","content":"rows and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"2"}]},{"block_type":"text","content":"columns, using the following syntax:"}]},{"block_type":"element","block":"k68oco88","search_text":"cdef double arr[5][2] ","text_count":22,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef double arr[5][2]"}]}]},{"block_type":"element","block":"k68oco89","search_text":"The memory will be allocated in a single block of memory, row after row. This order is commonly referred to as row-major and is depicted in the following figure. Arrays can also be ordered column-major , as is the case for the FORTRAN programming language:","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The memory will be allocated in a single block of memory, row after row. This order is commonly referred to as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"row-major"}]},{"block_type":"text","content":"and is depicted in the following figure. Arrays can also be ordered"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"column-major"}]},{"block_type":"text","content":", as is the case for the FORTRAN programming language:"}]},{"block_type":"element","block":"k68oco8a","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000005.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68oco8b","search_text":"Tip Array ordering has important consequences. When iterating a C array over the last dimension, we access contiguous memory blocks (in our example, 0, 1, 2, 3 ...) while when we iterate on the first dimension, we skip a few positions (0, 2, 4, 6, 8, 1 ... ). You should always try to access memory sequentially as this optimizes cache and memory usage. ","text_count":354,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Array ordering has important consequences. When iterating a C array over the last dimension, we access contiguous memory blocks (in our example, 0, 1, 2, 3 ...) while when we iterate on the first dimension, we skip a few positions (0, 2, 4, 6, 8, 1 ... ). You should always try to access memory sequentially as this optimizes cache and memory usage."}]}]},{"block_type":"element","block":"k68oco8c","search_text":"We can store and retrieve elements from the array using standard indexing; C arrays don't support fancy indexing or slices:","text_count":123,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can store and retrieve elements from the array using standard indexing; C arrays don't support fancy indexing or slices:"}]},{"block_type":"element","block":"k68oco8d","search_text":"arr[0] = 1.0 ","text_count":13,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"arr[0] = 1.0"}]}]},{"block_type":"element","block":"k68oco8e","search_text":"C arrays have many of the same behaviors as pointers. The arr variable, in fact, points to the memory location of the first element of the array. We can verify that the address of the first element of the array is the same as the address contained in the arr variable using the dereference operator, as follows:","text_count":311,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"C arrays have many of the same behaviors as pointers. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"arr"}]},{"block_type":"text","content":"variable, in fact, points to the memory location of the first element of the array. We can verify that the address of the first element of the array is the same as the address contained in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"arr"}]},{"block_type":"text","content":"&nbsp;variable using the dereference operator, as follows:"}]},{"block_type":"element","block":"k68oco8f","search_text":"%%cython from libc.stdio cimport printf cdef double arr[10] printf(\"%pn\", arr) printf(\"%pn\", &arr[0]) # Output # 0x7ff6de204220 # 0x7ff6de204220 ","text_count":145,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%%cython \n    from libc.stdio cimport printf \n    cdef double arr[10] \n    printf(\"%pn\", arr) \n    printf(\"%pn\", &amp;arr[0]) \n\n    # Output\n    # 0x7ff6de204220 \n    # 0x7ff6de204220"}]}]},{"block_type":"element","block":"k68oco8g","search_text":"You should use C arrays and pointers when interfacing with the existing C libraries or when you need a fine control over the memory (also, they are very performant). This level of fine control is also prone to mistakes as it doesn't prevent you from accessing the wrong memory locations. For more common use cases and improved safety, you can use NumPy arrays or typed memoryviews.","text_count":381,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You should use C arrays and pointers when interfacing with the existing C libraries or when you need a fine control over the memory (also, they are very performant). This level of fine control is also prone to mistakes as it doesn't prevent you from accessing the wrong memory locations. For more common use cases and improved safety, you can use NumPy arrays or typed memoryviews."}]},{"block_type":"element","block":"k68oco8h","search_text":"NumPy arrays","text_count":12,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"NumPy arrays"}]},{"block_type":"element","block":"k68oco8i","search_text":"NumPy arrays can be used as normal Python objects in Cython using their already optimized broadcasted operations. However, Cython provides a numpy module with better support for direct iteration.","text_count":195,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"NumPy arrays can be used as normal Python objects in Cython using their already optimized broadcasted operations. However, Cython provides a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy"}]},{"block_type":"text","content":"module with better support for direct iteration."}]},{"block_type":"element","block":"k68oco8j","search_text":"When we normally access an element of a NumPy array, a few other operations take place at the interpreter level causing a major overhead. Cython can bypass those operations and checks by acting directly on the underlying memory area used by NumPy arrays, and thus obtaining impressive performance gains.","text_count":303,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When we normally access an element of a NumPy array, a few other operations take place at the interpreter level causing a major overhead. Cython can bypass those operations and checks by acting directly on the underlying memory area used by NumPy arrays, and thus obtaining impressive performance gains."}]},{"block_type":"element","block":"k68oco8k","search_text":"NumPy arrays can be declared as the ndarray data type. To use the data type in our code, we first need to cimport the numpy Cython module (which is not the same as the Python NumPy module). We will bind the module to the c_np variable to make the difference with the Python numpy module more explicit:","text_count":301,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"NumPy arrays can be declared as the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ndarray"}]},{"block_type":"text","content":"data type. To use the data type in our code, we first need to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cimport"}]},{"block_type":"text","content":"the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy"}]},{"block_type":"text","content":"Cython module (which is not the same as the Python NumPy module). We will bind the module to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"c_np"}]},{"block_type":"text","content":"variable to make the difference with the Python"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy"}]},{"block_type":"text","content":"module more explicit:"}]},{"block_type":"element","block":"k68oco8l","search_text":"cimport numpy as c_np import numpy as np ","text_count":41,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cimport numpy as c_np\n    import numpy as np"}]}]},{"block_type":"element","block":"k68oco8m","search_text":"We can now declare a NumPy array by specifying its type and the number of dimensions between square brackets (this is called buffer syntax ). To declare a two-dimensional array of type double , we can use the following code:","text_count":224,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now declare a NumPy array by specifying its&nbsp;type and the number of dimensions between square brackets (this is called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"buffer syntax"}]},{"block_type":"text","content":"). To declare a two-dimensional array of type"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"double"}]},{"block_type":"text","content":", we can use the following code:"}]},{"block_type":"element","block":"k68oco8n","search_text":"cdef c_np.ndarray[double, ndim=2] arr ","text_count":38,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef c_np.ndarray[double, ndim=2] arr"}]}]},{"block_type":"element","block":"k68oco8o","search_text":"Access to this array will be performed by directly operating on the underlying memory area; the operation will avoid stepping into the interpreter, giving us a tremendous speed boost.","text_count":183,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Access to this array will be performed by directly operating on the&nbsp;underlying memory area; the operation will avoid stepping into the interpreter, giving us a tremendous speed boost."}]},{"block_type":"element","block":"k68oco8p","search_text":"In the next example, we will show the usage of typed numpy arrays and compare them with the normal Python version.","text_count":114,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next example, we will show the usage of typed numpy arrays and compare them&nbsp;with the normal Python version."}]},{"block_type":"element","block":"k68oco8q","search_text":"We first write the numpy_bench_py function that increments each element of py_arr . We declare the i index as an integer so that we avoid the for-loop overhead:","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We first write the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy_bench_py"}]},{"block_type":"text","content":"function that increments each element of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"py_arr"}]},{"block_type":"text","content":".&nbsp;We declare the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"i"}]},{"block_type":"text","content":"index as an integer so that we avoid the for-loop overhead:"}]},{"block_type":"element","block":"k68oco8r","search_text":"%%cython import numpy as np def numpy_bench_py(): py_arr = np.random.rand(1000) cdef int i for i in range(1000): py_arr[i] += 1 ","text_count":128,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%%cython \n    import numpy as np \n    def numpy_bench_py(): \n        py_arr = np.random.rand(1000) \n        cdef int i \n        for i in range(1000): \n            py_arr[i] += 1"}]}]},{"block_type":"element","block":"k68oco8s","search_text":"Then, we write the same function using the ndarray type. Note that after we define the c_arr variable using c_np.ndarray , we can assign to it an array from the numpy Python module:","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we write the same function using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ndarray"}]},{"block_type":"text","content":"type. Note that after we define the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"c_arr"}]},{"block_type":"text","content":"variable using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"c_np.ndarray"}]},{"block_type":"text","content":", we can assign to it an array from the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy"}]},{"block_type":"text","content":"Python module:"}]},{"block_type":"element","block":"k68oco8t","search_text":"%%cython import numpy as np cimport numpy as c_np def numpy_bench_c(): cdef c_np.ndarray[double, ndim=1] c_arr c_arr = np.random.rand(1000) cdef int i for i in range(1000): c_arr[i] += 1 ","text_count":187,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%%cython \n    import numpy as np \n    cimport numpy as c_np \n\n    def numpy_bench_c(): \n        cdef c_np.ndarray[double, ndim=1] c_arr \n        c_arr = np.random.rand(1000) \n        cdef int i\n\n        for i in range(1000): \n           c_arr[i] += 1"}]}]},{"block_type":"element","block":"k68oco8u","search_text":"We can time the results using timeit , and we can see how the typed version is 50x faster:","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can time the results using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":", and we can see how the typed version is&nbsp;50x faster:"}]},{"block_type":"element","block":"k68oco8v","search_text":"%timeit numpy_bench_c() 100000 loops, best of 3: 11.5 us per loop %timeit numpy_bench_py() 1000 loops, best of 3: 603 us per loop ","text_count":130,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%timeit numpy_bench_c() \n    100000 loops, best of 3: 11.5 us per loop \n    %timeit numpy_bench_py() \n    1000 loops, best of 3: 603 us per loop"}]}]},{"block_type":"element","block":"k68oco8w","search_text":"Typed memoryviews","text_count":17,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Typed memoryviews"}]},{"block_type":"element","block":"k68oco8x","search_text":"C and NumPy arrays as well as the built-in bytes , bytearray , and array.array objects are similar in the sense that they all operate on a contiguous memory area (also called memory buffer ). Cython provides a universal interface--the typed memoryview-- that unifies and simplifies the access to all these data types.","text_count":317,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"C and NumPy arrays as well as the built-in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bytes"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bytearray"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"array.array"}]},{"block_type":"text","content":"objects are similar in the sense that they all operate on a contiguous memory area (also called memory"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"buffer"}]},{"block_type":"text","content":"). Cython provides a universal interface--the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"typed memoryview--"}]},{"block_type":"text","content":"that unifies and simplifies the access to all these data types."}]},{"block_type":"element","block":"k68oco8y","search_text":"A memoryview is an object that maintains a reference on a specific memory area. It doesn't actually own the memory, but it can read and change its contents; in other words, it is a view on the underlying data. Memoryviews can be defined using a special syntax. For example, we can define a memoryview of int and a two-dimensional memoryview of double in the following way:","text_count":372,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"memoryview"}]},{"block_type":"text","content":"is an object that maintains a reference on a specific memory area. It doesn't actually own the memory, but it can read and change its contents; in other words, it is a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"view"}]},{"block_type":"text","content":"&nbsp;on the underlying data. Memoryviews can be defined using a special syntax. For example, we can define a memoryview of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int"}]},{"block_type":"text","content":"and a &nbsp;two-dimensional memoryview of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"double"}]},{"block_type":"text","content":"in the following way:"}]},{"block_type":"element","block":"k68oco8z","search_text":"cdef int[:] a cdef double[:, :] b ","text_count":34,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef int[:] a \n    cdef double[:, :] b"}]}]},{"block_type":"element","block":"k68oco90","search_text":"The same syntax applies to the declaration of any type in variables, function definitions, class attributes, and so on. Any object that exposes a buffer interface (for example, NumPy arrays, bytes , and array.array objects) will be bound to the memoryview automatically. For example, we can bind the memoryview to a NumPy array using a simple variable assignment:","text_count":363,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The same syntax applies to the declaration of any type in variables, function definitions, class attributes, and so on. Any object that exposes a buffer interface (for example, NumPy arrays,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bytes"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"array.array"}]},{"block_type":"text","content":"objects) will be bound to the memoryview automatically. For example, we can bind the memoryview to a NumPy array using&nbsp;a&nbsp;simple variable assignment:"}]},{"block_type":"element","block":"k68oco91","search_text":"import numpy as np cdef int[:] arr arr_np = np.zeros(10, dtype='int32') arr = arr_np # We bind the array to the memoryview ","text_count":123,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np \n\n    cdef int[:] arr \n    arr_np = np.zeros(10, dtype='int32') \n    arr = arr_np # We bind the array to the memoryview"}]}]},{"block_type":"element","block":"k68oco92","search_text":"It is important to note that the memoryview does not own the data, but it only provides a way to access and change the data it is bound to; the ownership, in this case, is left to the NumPy array. As you can see in the following example, changes made through the memoryview will act on the underlying memory area and will be reflected in the original NumPy structure (and vice versa):","text_count":384,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is important to note that the memoryview does not"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"own"}]},{"block_type":"text","content":"the data, but it only provides a way to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"access"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"change"}]},{"block_type":"text","content":"the data it is bound to; the ownership, in this case, is left to the NumPy array. As you can see in the following example, changes made through the memoryview will act on the underlying memory area and will be reflected in the original NumPy structure (and vice versa):"}]},{"block_type":"element","block":"k68oco93","search_text":"arr[2] = 1 # Changing memoryview print(arr_np) # [0 0 1 0 0 0 0 0 0 0] ","text_count":71,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"arr[2] = 1 # Changing memoryview \n    print(arr_np) \n    # [0 0 1 0 0 0 0 0 0 0]"}]}]},{"block_type":"element","block":"k68oco94","search_text":"In a certain sense, the mechanism behind memoryviews is similar to what NumPy produces when we slice an array. As we have seen in Chapter 3, Fast Array Operations with NumPy and Pandas , slicing a NumPy array does not copy the data but returns a view on the same memory area, and changes to the view will reflect on the original array.","text_count":335,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a certain sense, the mechanism behind&nbsp;memoryviews is similar to what&nbsp;NumPy produces when we slice an array. As we have seen in Chapter 3,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Fast Array Operations with NumPy and Pandas"}]},{"block_type":"text","content":", slicing a NumPy array does not copy the data but returns a view on the same memory area, and changes to the view will reflect on the original array."}]},{"block_type":"element","block":"k68oco95","search_text":"Memoryviews also support array slicing with the standard NumPy syntax:","text_count":70,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Memoryviews also support array slicing with the standard NumPy syntax:"}]},{"block_type":"element","block":"k68oco96","search_text":"cdef int[:, :, :] a arr[0, :, :] # Is a 2-dimensional memoryview arr[0, 0, :] # Is a 1-dimensional memoryview arr[0, 0, 0] # Is an int ","text_count":135,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef int[:, :, :] a \n    arr[0, :, :] # Is a 2-dimensional memoryview \n    arr[0, 0, :] # Is a 1-dimensional memoryview \n    arr[0, 0, 0] # Is an int"}]}]},{"block_type":"element","block":"k68oco97","search_text":"To copy data between one memoryview and another, you can use syntax similar to slice assignment, as shown in the following code:","text_count":128,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To copy data between one memoryview and another, you can use syntax similar to slice assignment, as shown in the following code:"}]},{"block_type":"element","block":"k68oco98","search_text":"import numpy as np cdef double[:, :] b cdef double[:] r b = np.random.rand(10, 3) r = np.zeros(3, dtype='float64') b[0, :] = r # Copy the value of r in the first row of b ","text_count":171,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np \n\n    cdef double[:, :] b \n    cdef double[:] r \n    b = np.random.rand(10, 3) \n    r = np.zeros(3, dtype='float64') \n\n    b[0, :] = r # Copy the value of r in the first row of b"}]}]},{"block_type":"element","block":"k68oco99","search_text":"In the next section, we will use the typed memoryviews to declare types for the arrays in our particle simulator.","text_count":113,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next section, we will use the typed memoryviews to declare types for&nbsp;the arrays in our particle simulator."}]},{"block_type":"element","block":"k68oco9a","search_text":"Particle simulator in Cython","text_count":28,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Particle simulator in Cython"}]},{"block_type":"element","block":"k68oco9b","search_text":"Now that we have a basic understanding of how Cython works, we can rewrite the ParticleSimulator.evolve method. Thanks to Cython, we can convert our loops in C, thus removing the overhead introduced by the Python interpreter.","text_count":225,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have a basic understanding of how Cython works, we can rewrite the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator.evolve"}]},{"block_type":"text","content":"method. Thanks to Cython, we can convert our loops in C, thus removing the overhead introduced by the Python interpreter."}]},{"block_type":"element","block":"k68oco9c","search_text":"In Chapter 3, Fast Array Operations with NumPy and Pandas , we wrote a fairly efficient version of the evolve method using NumPy. We can rename the old version as evolve_numpy to differentiate it from the new version:","text_count":217,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Chapter 3,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Fast Array Operations with NumPy and Pandas"}]},{"block_type":"text","content":", we wrote a fairly efficient version of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"evolve"}]},{"block_type":"text","content":"method using NumPy. We can rename the old version as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"evolve_numpy"}]},{"block_type":"text","content":"to differentiate it from the new version:"}]},{"block_type":"element","block":"k68oco9d","search_text":"def evolve_numpy(self, dt): timestep = 0.00001 nsteps = int(dt/timestep) r_i = np.array([[p.x, p.y] for p in self.particles]) ang_speed_i = np.array([p.ang_speed for p in self.particles]) v_i = np.empty_like(r_i) for i in range(nsteps): norm_i = np.sqrt((r_i ** 2).sum(axis=1)) v_i = r_i[:, [1, 0]] v_i[:, 0] *= -1 v_i /= norm_i[:, np.newaxis] d_i = timestep * ang_speed_i[:, np.newaxis] * v_i r_i += d_i for i, p in enumerate(self.particles): p.x, p.y = r_i[i] ","text_count":462,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def evolve_numpy(self, dt): \n        timestep = 0.00001 \n        nsteps = int(dt/timestep) \n\n        r_i = np.array([[p.x, p.y] for p in self.particles])     \n        ang_speed_i = np.array([p.ang_speed for p in self.particles]) \n        v_i = np.empty_like(r_i) \n\n        for i in range(nsteps): \n            norm_i = np.sqrt((r_i ** 2).sum(axis=1)) \n\n            v_i = r_i[:, [1, 0]] \n            v_i[:, 0] *= -1 \n            v_i /= norm_i[:, np.newaxis]         \n\n            d_i = timestep * ang_speed_i[:, np.newaxis] * v_i \n\n            r_i += d_i \n\n        for i, p in enumerate(self.particles): \n            p.x, p.y = r_i[i]"}]}]},{"block_type":"element","block":"k68oco9e","search_text":"We want to convert this code to Cython. Our strategy will be to take advantage of the fast indexing operations by removing the NumPy array broadcasting, thus reverting to an indexing-based algorithm. Since Cython generates efficient C code, we are free to use as many loops as we like without any performance penalty.","text_count":317,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We want to convert this code to Cython. Our strategy will be to take advantage of the fast indexing operations by removing the NumPy array broadcasting, thus reverting to an indexing-based algorithm. Since Cython generates efficient C code, we are free to use as many loops as we like without any performance penalty."}]},{"block_type":"element","block":"k68oco9f","search_text":"As a design choice, we can decide to encapsulate the loop in a function that we will rewrite in a Cython module called cevolve.pyx . The module will contain a single Python function, c_evolve , that will take the particle positions, angular velocities, timestep, and number of steps as input.","text_count":292,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a design choice, we can decide to encapsulate the loop in a function that we will rewrite in a Cython module called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cevolve.pyx"}]},{"block_type":"text","content":". The module will contain a single Python function,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"c_evolve"}]},{"block_type":"text","content":", that will take the particle positions, angular velocities, timestep, and number of steps as input."}]},{"block_type":"element","block":"k68oco9g","search_text":"At first, we are not adding typing information; we just want to isolate the function and ensure that we can compile our module without errors:","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At first, we are not adding typing information; we just want to isolate the function and ensure that we can compile our module without errors:"}]},{"block_type":"element","block":"k68oco9h","search_text":"# file: simul.py def evolve_cython(self, dt): timestep = 0.00001 nsteps = int(dt/timestep) r_i = np.array([[p.x, p.y] for p in self.particles]) ang_speed_i = np.array([p.ang_speed for p in self.particles]) c_evolve(r_i, ang_speed_i, timestep, nsteps) for i, p in enumerate(self.particles): p.x, p.y = r_i[i] # file: cevolve.pyx import numpy as np def c_evolve(r_i, ang_speed_i, timestep, nsteps): v_i = np.empty_like(r_i) for i in range(nsteps): norm_i = np.sqrt((r_i ** 2).sum(axis=1)) v_i = r_i[:, [1, 0]] v_i[:, 0] *= -1 v_i /= norm_i[:, np.newaxis] d_i = timestep * ang_speed_i[:, np.newaxis] * v_i r_i += d_i ","text_count":614,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# file: simul.py \n    def evolve_cython(self, dt): \n        timestep = 0.00001 \n        nsteps = int(dt/timestep) \n\n        r_i = np.array([[p.x, p.y] for p in self.particles])     \n        ang_speed_i = np.array([p.ang_speed for p in self.particles]) \n\n        c_evolve(r_i, ang_speed_i, timestep, nsteps) \n\n        for i, p in enumerate(self.particles): \n            p.x, p.y = r_i[i] \n\n    # file: cevolve.pyx \n    import numpy as np \n\n    def c_evolve(r_i, ang_speed_i, timestep, nsteps): \n        v_i = np.empty_like(r_i) \n\n        for i in range(nsteps): \n            norm_i = np.sqrt((r_i ** 2).sum(axis=1)) \n\n            v_i = r_i[:, [1, 0]] \n            v_i[:, 0] *= -1 \n            v_i /= norm_i[:, np.newaxis]         \n     \n            d_i = timestep * ang_speed_i[:, np.newaxis] * v_i \n\n            r_i += d_i"}]}]},{"block_type":"element","block":"k68oco9i","search_text":"Note that we don't need a return value for c_evolve as values are updated in the r_i array in-place. We can benchmark the untyped Cython version against the old NumPy version by slightly changing our benchmark function, as follows:","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that we don't need a return value for"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"c_evolve"}]},{"block_type":"text","content":"&nbsp;as values are updated in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"r_i"}]},{"block_type":"text","content":"array in-place. We can benchmark the untyped Cython version against the old NumPy version by slightly changing our benchmark function, as follows:"}]},{"block_type":"element","block":"k68oco9j","search_text":"def benchmark(npart=100, method='python'): particles = [Particle(uniform(-1.0, 1.0), uniform(-1.0, 1.0), uniform(-1.0, 1.0)) for i in range(npart)] simulator = ParticleSimulator(particles) if method=='python': simulator.evolve_python(0.1) elif method == 'cython': simulator.evolve_cython(0.1) elif method == 'numpy': simulator.evolve_numpy(0.1) ","text_count":345,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def benchmark(npart=100, method='python'): \n        particles = [Particle(uniform(-1.0, 1.0),\n                              uniform(-1.0, 1.0),\n                              uniform(-1.0, 1.0)) \n                              for i in range(npart)] \n        simulator = ParticleSimulator(particles) \n        if method=='python': \n            simulator.evolve_python(0.1)\n        elif method == 'cython': \n            simulator.evolve_cython(0.1) \n        elif method == 'numpy': \n            simulator.evolve_numpy(0.1)"}]}]},{"block_type":"element","block":"k68oco9k","search_text":"We can time the different versions in an IPython shell:","text_count":55,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can time the different versions in an IPython shell:"}]},{"block_type":"element","block":"k68oco9l","search_text":"%timeit benchmark(100, 'cython') 1 loops, best of 3: 401 ms per loop %timeit benchmark(100, 'numpy') 1 loops, best of 3: 413 ms per loop ","text_count":137,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%timeit benchmark(100, 'cython') \n    1 loops, best of 3: 401 ms per loop \n    %timeit benchmark(100, 'numpy') \n    1 loops, best of 3: 413 ms per loop"}]}]},{"block_type":"element","block":"k68oco9m","search_text":"The two versions have the same speed. Compiling the Cython module without static typing doesn't have any advantage over pure Python. The next step is to declare the type of all the important variables so that Cython can perform its optimizations.","text_count":246,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The two versions have the same speed. Compiling the Cython module without static typing doesn't have any advantage over pure Python. The next step is to declare the type of all the important variables so that Cython can perform its optimizations."}]},{"block_type":"element","block":"k68oco9n","search_text":"We can start adding types to the function arguments and see how the performance changes. We can declare the arrays as typed memoryviews containing double values. It's worth mentioning that if we pass an array of the int or float32 type, the casting won't happen automatically and we will get an error:","text_count":301,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can start adding types to the function arguments and see how the performance changes. We can declare the arrays as typed memoryviews containing"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"double"}]},{"block_type":"text","content":"values. It's worth mentioning that if we pass an array of the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float32"}]},{"block_type":"text","content":"type, the casting won't happen automatically and we will get an error:"}]},{"block_type":"element","block":"k68oco9o","search_text":"def c_evolve(double[:, :] r_i, double[:] ang_speed_i, double timestep, int nsteps): ","text_count":84,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def c_evolve(double[:, :] r_i,\n                 double[:] ang_speed_i,\n                 double timestep,\n                 int nsteps):"}]}]},{"block_type":"element","block":"k68oco9p","search_text":"At this point, we can rewrite the loops over the particles and timesteps. We can declare the i and j iteration indices and the nparticles particle number as int :","text_count":162,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we can rewrite the loops over the particles and timesteps. We can declare the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"i"}]},{"block_type":"text","content":"&nbsp;and&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"j"}]},{"block_type":"text","content":"iteration indices and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nparticles"}]},{"block_type":"text","content":"particle number as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68oco9q","search_text":"cdef int i, j cdef int nparticles = r_i.shape[0] ","text_count":49,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef int i, j \n    cdef int nparticles = r_i.shape[0]"}]}]},{"block_type":"element","block":"k68oco9r","search_text":"The algorithm is very similar to the pure Python version; we iterate over the particles and timesteps, and we compute the velocity and displacement vectors for each particle coordinate using the following code:","text_count":210,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The algorithm is very similar to the pure Python version; we iterate over the particles and timesteps, and we compute the velocity and displacement vectors for each particle coordinate using the following code:"}]},{"block_type":"element","block":"k68oco9s","search_text":"for i in range(nsteps): for j in range(nparticles): x = r_i[j, 0] y = r_i[j, 1] ang_speed = ang_speed_i[j] norm = sqrt(x ** 2 + y ** 2) vx = (-y)/norm vy = x/norm dx = timestep * ang_speed * vx dy = timestep * ang_speed * vy r_i[j, 0] += dx r_i[j, 1] += dy ","text_count":257,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"for i in range(nsteps): \n          for j in range(nparticles): \n              x = r_i[j, 0] \n              y = r_i[j, 1] \n              ang_speed = ang_speed_i[j] \n\n              norm = sqrt(x ** 2 + y ** 2) \n\n              vx = (-y)/norm \n              vy = x/norm \n\n              dx = timestep * ang_speed * vx \n              dy = timestep * ang_speed * vy \n\n              r_i[j, 0] += dx \n              r_i[j, 1] += dy"}]}]},{"block_type":"element","block":"k68oco9t","search_text":"In the preceding code, we added the x , y , ang_speed , norm , vx , vy , dx , and dy variables. To avoid the Python interpreter overhead, we have to declare them with their corresponding types at the beginning of the function, as follows:","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding&nbsp;code, we added the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ang_speed"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"norm"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"vx"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"vy"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dx"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dy"}]},{"block_type":"text","content":"variables. To avoid the Python interpreter overhead, we have to declare them with their corresponding types at the beginning of the function, as follows:"}]},{"block_type":"element","block":"k68oco9u","search_text":"cdef double norm, x, y, vx, vy, dx, dy, ang_speed ","text_count":50,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cdef double norm, x, y, vx, vy, dx, dy, ang_speed"}]}]},{"block_type":"element","block":"k68oco9v","search_text":"We also used a function called sqrt to calculate the norm. If we use the sqrt present in the math module or the one in numpy , we will again include a slow Python function in our critical loop, thus killing our performance. A fast sqrt is available in the standard C library, already wrapped in the libc.math Cython module:","text_count":323,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We also used a function called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sqrt"}]},{"block_type":"text","content":"to calculate the norm. If we use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sqrt"}]},{"block_type":"text","content":"present in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"math"}]},{"block_type":"text","content":"module or the one in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy"}]},{"block_type":"text","content":", we will&nbsp;again include a slow Python function in our critical loop, thus killing our performance. A fast"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sqrt"}]},{"block_type":"text","content":"is available in the standard C library, already wrapped in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"libc.math"}]},{"block_type":"text","content":"Cython module:"}]},{"block_type":"element","block":"k68oco9w","search_text":"from libc.math cimport sqrt ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from libc.math cimport sqrt"}]}]},{"block_type":"element","block":"k68oco9x","search_text":"We can rerun our benchmark to assess our improvements, as follows:","text_count":66,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can rerun our benchmark to assess our improvements, as follows:"}]},{"block_type":"element","block":"k68oco9y","search_text":"In [4]: %timeit benchmark(100, 'cython') 100 loops, best of 3: 13.4 ms per loop In [5]: %timeit benchmark(100, 'numpy') 1 loops, best of 3: 429 ms per loop ","text_count":156,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"In [4]: %timeit benchmark(100, 'cython') \n    100 loops, best of 3: 13.4 ms per loop \n    In [5]: %timeit benchmark(100, 'numpy') \n    1 loops, best of 3: 429 ms per loop"}]}]},{"block_type":"element","block":"k68oco9z","search_text":"For small particle numbers, the speed-up is massive as we obtained a 40x performance over the previous version. However, we should also try to test the performance scaling with a larger number of particles:","text_count":206,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For small particle numbers, the speed-up is massive as we obtained a 40x performance over the previous version. However, we should also try to test the performance scaling with a larger number of particles:"}]},{"block_type":"element","block":"k68ocoa0","search_text":"In [2]: %timeit benchmark(1000, 'cython') 10 loops, best of 3: 134 ms per loop In [3]: %timeit benchmark(1000, 'numpy') 1 loops, best of 3: 877 ms per loop ","text_count":156,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"In [2]: %timeit benchmark(1000, 'cython') \n    10 loops, best of 3: 134 ms per loop \n    In [3]: %timeit benchmark(1000, 'numpy') \n    1 loops, best of 3: 877 ms per loop"}]}]},{"block_type":"element","block":"k68ocoa1","search_text":"As we increase the number of particles, the two versions get closer in speed. By increasing the particle size to 1000, we already decreased our speed-up to a more modest 6x. This is likely due to the fact that, as we increase the number of particles, the Python for-loop overhead becomes less and less significant compared to the speed of other operations.","text_count":356,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we increase the number of particles, the two versions get closer in speed. By increasing the particle size to 1000, we already decreased our speed-up to a more modest 6x. This is likely due to the fact that, as we increase the number of particles, the Python for-loop overhead becomes less and less significant compared to the speed of other operations."}]},{"block_type":"element","block":"k68ocoa2","search_text":"Profiling Cython","text_count":16,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Profiling Cython"}]},{"block_type":"element","block":"k68ocoa3","search_text":"Cython provides a feature, called annotated view , that helps find which lines are executed in the Python interpreter and which are good candidates for ulterior optimizations. We can turn this feature on by compiling a Cython file with the -a option. In this way, Cython will generate an HTML file containing our code annotated with some useful information. The usage of the -a option is as follows:","text_count":399,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Cython provides a feature, called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"annotated view"}]},{"block_type":"text","content":", that helps&nbsp;find which lines are executed in the Python interpreter and which are good candidates for ulterior optimizations.&nbsp;We can turn this feature on by compiling a Cython file with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-a"}]},{"block_type":"text","content":"option. In this way, Cython will generate an HTML file containing our code annotated with some useful information. The usage of the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-a"}]},{"block_type":"text","content":"option is as follows:"}]},{"block_type":"element","block":"k68ocoa4","search_text":"$ cython -a cevolve.pyx $ firefox cevolve.html ","text_count":47,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ cython -a cevolve.pyx\n$ firefox cevolve.html"}]}]},{"block_type":"element","block":"k68ocoa5","search_text":"The HTML file displayed in the following screenshot shows our Cython file line by line:","text_count":87,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The HTML file displayed in the following screenshot shows our Cython file line by line:"}]},{"block_type":"element","block":"k68ocoa6","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000035.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocoa7","search_text":"Each line in the source code can appear in different shades of yellow. A more intense color corresponds to more interpreter-related calls, while white lines are translated to regular C code. Since interpreter calls substantially slow down execution, the objective is to make the function body as white as possible. By clicking on any of the lines, we can inspect the code generated by the Cython compiler. For example, the v_y = x/norm line checks that the norm is not 0 and raises a ZeroDivisionError if the condition is not verified. The x = r_i[j, 0] line shows that Cython checks whether the indexes are within the bounds of the array. You may note that the last line is of a very intense color; by inspecting the code, we can see that this is actually a glitch; the code refers to a boilerplate related to the end of the function.","text_count":835,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Each line in the source code can appear&nbsp;in different shades of yellow. A more intense&nbsp;color corresponds to more&nbsp;interpreter-related calls, while white lines are translated to regular&nbsp;C code. Since interpreter calls substantially slow down execution, the objective is to make the function body as white as possible. By clicking on any of the lines, we can inspect the code generated by the Cython compiler. For example, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"v_y = x/norm"}]},{"block_type":"text","content":"line checks that the norm is not"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"&nbsp;and raises a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ZeroDivisionError"}]},{"block_type":"text","content":"&nbsp;if the condition is not verified. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x = r_i[j, 0]"}]},{"block_type":"text","content":"line shows that Cython checks whether&nbsp;the indexes are within the bounds of the array. You may note that the last line is of a very intense color; by inspecting the code, we can see that this is actually a glitch; the code refers to a boilerplate related to the end of the function."}]},{"block_type":"element","block":"k68ocoa8","search_text":"Cython can shut down checks, such as division by zero, so that it can remove those extra interpreter related calls; this is usually accomplished through compiler directives. There are a few different ways to add compiler directives:","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Cython can shut down checks, such as division by zero, so that it can remove those extra interpreter related calls; this is usually accomplished through compiler directives. There are a few different ways to add compiler directives:"}]},{"block_type":"element","block":"k68ocoa9","search_text":"Using a decorator or a context manager Using a comment at the beginning of the file Using the Cython command-line options ","text_count":122,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using a decorator or a context manager"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using a comment at the beginning of the file"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using the Cython command-line options"}]}]},{"block_type":"element","block":"k68ocoaa","search_text":"Note For a complete list of the Cython compiler directives, you can refer to the official documentation at http://docs.cython.org/src/reference/compilation.html#compiler-directives . ","text_count":183,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For a complete list of the Cython compiler directives, you can refer to the official documentation at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://docs.cython.org/src/reference/compilation.html#compiler-directives"},"children":[{"block_type":"text","content":"http://docs.cython.org/src/reference/compilation.html#compiler-directives"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68ocoab","search_text":"For example, to disable bounds checking for arrays, it is sufficient to decorate a function with cython.boundscheck , in the following way:","text_count":139,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For example, to disable bounds&nbsp;checking for arrays, it is sufficient to decorate a function with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cython.boundscheck"}]},{"block_type":"text","content":", in the following way:"}]},{"block_type":"element","block":"k68ocoac","search_text":"cimport cython @cython.boundscheck(False) def myfunction(): # Code here ","text_count":72,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cimport cython \n\n    @cython.boundscheck(False) \n    def myfunction(): \n        # Code here"}]}]},{"block_type":"element","block":"k68ocoad","search_text":"Alternatively, we can use cython.boundscheck to wrap a block of code into a context manager, as follows:","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Alternatively, we can use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cython.boundscheck"}]},{"block_type":"text","content":"to wrap a block of code into a context manager, as follows:"}]},{"block_type":"element","block":"k68ocoae","search_text":"with cython.boundscheck(False): # Code here ","text_count":44,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"with cython.boundscheck(False): \n        # Code here"}]}]},{"block_type":"element","block":"k68ocoaf","search_text":"If we want to disable bounds checking for a whole module, we can add the following line of code at the beginning of the file:","text_count":125,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we want to disable bounds checking for a whole module, we can add the following line of code at the beginning of the file:"}]},{"block_type":"element","block":"k68ocoag","search_text":"# cython: boundscheck=False ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# cython: boundscheck=False"}]}]},{"block_type":"element","block":"k68ocoah","search_text":"To alter the directives with the command-line options, you can use the -X option as follows:","text_count":92,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To alter the directives with the command-line options, you can use the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-X"}]},{"block_type":"text","content":"&nbsp;option as follows:"}]},{"block_type":"element","block":"k68ocoai","search_text":"$ cython -X boundscheck=True ","text_count":29,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ cython -X boundscheck=True"}]}]},{"block_type":"element","block":"k68ocoaj","search_text":"To disable the extra checks in our c_evolve function, we can disable the boundscheck directive and enable cdivision (this prevents checks for ZeroDivisionError ), as in the following code:","text_count":188,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To disable&nbsp;the extra checks in our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"c_evolve"}]},{"block_type":"text","content":"function, we can disable the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"boundscheck"}]},{"block_type":"text","content":"directive and enable&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cdivision"}]},{"block_type":"text","content":"(this prevents checks for&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ZeroDivisionError"}]},{"block_type":"text","content":"), as in the following code:"}]},{"block_type":"element","block":"k68ocoak","search_text":"cimport cython @cython.boundscheck(False) @cython.cdivision(True) def c_evolve(double[:, :] r_i, double[:] ang_speed_i, double timestep, int nsteps): ","text_count":150,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cimport cython \n\n    @cython.boundscheck(False) \n    @cython.cdivision(True) \n    def c_evolve(double[:, :] r_i,\n                 double[:] ang_speed_i,\n                 double timestep,\n                 int nsteps):"}]}]},{"block_type":"element","block":"k68ocoal","search_text":"If we look at the annotated view again, the loop body has become completely white--we removed all traces of the interpreter from the inner loop. In order to recompile, just type python setup.py build_ext --inplace again. By running the benchmark, however, we note that we didn't obtain a performance improvement, suggesting that those checks are not part of the bottleneck:","text_count":373,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we look at the annotated view again, the loop body has become&nbsp;completely white--we removed all traces of the interpreter from the inner loop. In order to recompile, just type"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"python setup.py build_ext --inplace"}]},{"block_type":"text","content":"again. By running the benchmark, however, we note that we didn't obtain a performance improvement, suggesting that those checks are not part of the bottleneck:"}]},{"block_type":"element","block":"k68ocoam","search_text":"In [3]: %timeit benchmark(100, 'cython') 100 loops, best of 3: 13.4 ms per loop ","text_count":80,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"In [3]: %timeit benchmark(100, 'cython') \n    100 loops, best of 3: 13.4 ms per loop"}]}]},{"block_type":"element","block":"k68ocoan","search_text":"Another way to profile Cython code is through the use of the cProfile module. As an example, we can write a simple function that calculates the Chebyshev distance between coordinate arrays. Create a cheb.py file:","text_count":212,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another way to profile Cython code is through the use of&nbsp;the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"&nbsp;module.&nbsp;As an example,&nbsp;we can write a simple function that calculates&nbsp;the Chebyshev distance between coordinate arrays. Create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cheb.py"}]},{"block_type":"text","content":"&nbsp;file:"}]},{"block_type":"element","block":"k68ocoao","search_text":"import numpy as np from distance import chebyshev def benchmark(): a = np.random.rand(100, 2) b = np.random.rand(100, 2) for x1, y1 in a: for x2, y2 in b: chebyshev(x1, x2, y1, y2) ","text_count":181,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np \n    from distance import chebyshev \n\n    def benchmark(): \n        a = np.random.rand(100, 2) \n        b = np.random.rand(100, 2) \n        for x1, y1 in a: \n            for x2, y2 in b: \n                chebyshev(x1, x2, y1, y2)"}]}]},{"block_type":"element","block":"k68ocoap","search_text":"If we try profiling this script as-is, we won't get any statistics regarding the functions that we implemented in Cython. If we want to collect profiling information for the max and min functions, we need to add the profile=True option to the mathlib.pyx file, as shown in the following code:","text_count":292,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we try profiling this script as-is, we won't get any statistics regarding the functions that we implemented in Cython. If we want to collect&nbsp;profiling information&nbsp;for the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"min"}]},{"block_type":"text","content":"functions, we need&nbsp;to add the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"profile=True"}]},{"block_type":"text","content":"option to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mathlib.pyx"}]},{"block_type":"text","content":"file, as shown in the following code:"}]},{"block_type":"element","block":"k68ocoaq","search_text":"# cython: profile=True cdef int max(int a, int b): # Code here ","text_count":63,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# cython: profile=True \n\n    cdef int max(int a, int b): \n        # Code here"}]}]},{"block_type":"element","block":"k68ocoar","search_text":"We can now profile our script with %prun using IPython, as follows:","text_count":67,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now profile our script with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%prun"}]},{"block_type":"text","content":"using IPython, as follows:"}]},{"block_type":"element","block":"k68ocoas","search_text":"import cheb %prun cheb.benchmark() # Output: 2000005 function calls in 2.066 seconds Ordered by: internal time ncalls tottime percall cumtime percall filename:lineno(function) 1 1.664 1.664 2.066 2.066 cheb.py:4(benchmark) 1000000 0.351 0.000 0.401 0.000 {distance.chebyshev} 1000000 0.050 0.000 0.050 0.000 mathlib.pyx:2(max) 2 0.000 0.000 0.000 0.000 {method 'rand' of 'mtrand.RandomState' objects} 1 0.000 0.000 2.066 2.066 <string>:1(<module>) 1 0.000 0.000 0.000 0.000 {method 'disable' of '_lsprof.Profiler' objects} ","text_count":523,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import cheb \n    %prun cheb.benchmark() \n\n# Output:\n2000005 function calls in 2.066 seconds \n\n  Ordered by: internal time \n\n  ncalls tottime percall cumtime percall filename:lineno(function) \n       1   1.664   1.664   2.066   2.066 cheb.py:4(benchmark) \n 1000000   0.351   0.000   0.401   0.000 {distance.chebyshev} \n 1000000   0.050   0.000   0.050   0.000 mathlib.pyx:2(max) \n       2   0.000   0.000   0.000   0.000 {method 'rand' of        'mtrand.RandomState' objects} \n       1   0.000   0.000   2.066   2.066 &lt;string&gt;:1(&lt;module&gt;) \n       1   0.000   0.000   0.000   0.000 {method 'disable' of        '_lsprof.Profiler' objects}"}]}]},{"block_type":"element","block":"k68ocoat","search_text":"From the output, we can see that the max function is present and is not a bottleneck. Most of the time seems to be spent in the benchmark function, meaning that the bottleneck is likely the pure Python for-loop. In this case, the best strategy will be rewriting the loop in NumPy or porting the code to Cython.","text_count":310,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From the output, we can see that the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max"}]},{"block_type":"text","content":"function is present and is not a bottleneck. Most of the time&nbsp;seems to be&nbsp;spent&nbsp;in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"benchmark"}]},{"block_type":"text","content":"function, meaning that the bottleneck is likely the pure Python for-loop. In this case, the best strategy will&nbsp;be rewriting the loop in NumPy or porting the code to Cython."}]},{"block_type":"element","block":"k68ocoau","search_text":"Using Cython with Jupyter","text_count":25,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Using Cython with Jupyter"}]},{"block_type":"element","block":"k68ocoav","search_text":"Optimizing Cython code requires substantial trial and error. Fortunately, Cython tools can be conveniently accessed through the Jupyter notebook for a more streamlined and integrated experience.","text_count":194,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Optimizing Cython code requires substantial trial and error. Fortunately, Cython tools can be conveniently accessed through the Jupyter notebook for a more streamlined and integrated experience."}]},{"block_type":"element","block":"k68ocoaw","search_text":"You can launch a notebook session by typing jupyter notebook in the command line and you can load the Cython magic by typing %load_ext cython in a cell.","text_count":152,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can launch a notebook session by typing"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"jupyter notebook"}]},{"block_type":"text","content":"in the command line and you can load the Cython magic by typing"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%load_ext cython"}]},{"block_type":"text","content":"in a cell."}]},{"block_type":"element","block":"k68ocoax","search_text":"As already mentioned earlier, the %%cython magic can be used to compile and load the Cython code inside the current session. As an example, we may copy the contents of cheb.py into a notebook cell:","text_count":197,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As already mentioned earlier, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%%cython"}]},{"block_type":"text","content":"magic can be used to compile and load the Cython code inside the current session. As an example, we may copy the contents of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cheb.py"}]},{"block_type":"text","content":"into a notebook cell:"}]},{"block_type":"element","block":"k68ocoay","search_text":"%%cython import numpy as np cdef int max(int a, int b): return a if a > b else b cdef int chebyshev(int x1, int y1, int x2, int y2): return max(abs(x1 - x2), abs(y1 - y2)) def c_benchmark(): a = np.random.rand(1000, 2) b = np.random.rand(1000, 2) for x1, y1 in a: for x2, y2 in b: chebyshev(x1, x2, y1, y2) ","text_count":307,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%%cython\n    import numpy as np\n\n    cdef int max(int a, int b):\n        return a if a &gt; b else b\n\n    cdef int chebyshev(int x1, int y1, int x2, int y2):\n        return max(abs(x1 - x2), abs(y1 - y2))\n\n    def c_benchmark():\n        a = np.random.rand(1000, 2)\n        b = np.random.rand(1000, 2)\n\n        for x1, y1 in a:\n           for x2, y2 in b:\n               chebyshev(x1, x2, y1, y2)"}]}]},{"block_type":"element","block":"k68ocoaz","search_text":"A useful feature of the %%cython magic is the -a option that will compile the code and produce an annotated view (just like the command line -a option) of the source directly in the notebook, as shown in the following screenshot:","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A useful feature of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%%cython"}]},{"block_type":"text","content":"magic is the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-a"}]},{"block_type":"text","content":"option that will compile the code and produce an annotated view (just like the command line"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-a"}]},{"block_type":"text","content":"option) of the source directly in the notebook, as shown in the following screenshot:"}]},{"block_type":"element","block":"k68ocob0","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000004.png","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k68ocob1","search_text":"This allows you to quickly test different versions of your code and also use the other integrated tools available in Jupyter. For example, we can time and profile the code (provided that we activate the profile directive in the cell) in the same session using tools such as %prun and %timeit . For example, we can inspect the profiling results by taking advantage of the %prun magic, as shown in the following screenshot:","text_count":421,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This allows you to quickly test different versions of your code and also use the other integrated tools available in Jupyter. For example, we can time and profile the code (provided that we activate the profile directive in the cell) in the same session using tools such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%prun"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%timeit"}]},{"block_type":"text","content":". For example, we can inspect the profiling results by taking advantage of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%prun"}]},{"block_type":"text","content":"magic, as shown in the following screenshot:"}]},{"block_type":"element","block":"k68ocob2","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000023.png","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k68ocob3","search_text":"It is also possible to use the line_profiler tool we discussed in Chapter 1, Benchmarking and Profiling , directly in the notebook. In order to support line annotations, it is necessary to do the following things:","text_count":213,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is also possible to use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"line_profiler"}]},{"block_type":"text","content":"tool we discussed in Chapter 1,&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Benchmarking and Profiling"}]},{"block_type":"text","content":", directly in the notebook. In order to support line annotations, it is necessary to do the following things:"}]},{"block_type":"element","block":"k68ocob4","search_text":"Enable the linetrace=True and binding=True compiler directives Enable the CYTHON_TRACE=1 flag at compile time ","text_count":110,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Enable the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"linetrace=True"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"binding=True"}]},{"block_type":"text","content":"&nbsp;compiler directives"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Enable the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"CYTHON_TRACE=1"}]},{"block_type":"text","content":"flag at compile time"}]}]},{"block_type":"element","block":"k68ocob5","search_text":"This can be easily accomplished by adding the respective arguments to the %%cython magic, and by setting the compiler directives, as shown in the following code:","text_count":161,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This can be easily accomplished by adding the respective arguments to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%%cython"}]},{"block_type":"text","content":"magic, and by setting the compiler directives, as shown in the following code:"}]},{"block_type":"element","block":"k68ocob6","search_text":"%%cython -a -f -c=-DCYTHON_TRACE=1 # cython: linetrace=True # cython: binding=True import numpy as np cdef int max(int a, int b): return a if a > b else b def chebyshev(int x1, int y1, int x2, int y2): return max(abs(x1 - x2), abs(y1 - y2)) def c_benchmark(): a = np.random.rand(1000, 2) b = np.random.rand(1000, 2) for x1, y1 in a: for x2, y2 in b: chebyshev(x1, x2, y1, y2) ","text_count":376,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%%cython -a -f -c=-DCYTHON_TRACE=1\n    # cython: linetrace=True\n    # cython: binding=True\n\n    import numpy as np\n\n    cdef int max(int a, int b):\n        return a if a &gt; b else b\n\n    def chebyshev(int x1, int y1, int x2, int y2):\n        return max(abs(x1 - x2), abs(y1 - y2))\n\n    def c_benchmark():\n        a = np.random.rand(1000, 2)\n        b = np.random.rand(1000, 2)\n    \n        for x1, y1 in a:\n            for x2, y2 in b:\n                chebyshev(x1, x2, y1, y2)"}]}]},{"block_type":"element","block":"k68ocob7","search_text":"Once the code is instrumented, we can profile using the %lprun magic:","text_count":69,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once the code is instrumented, we can profile using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"%lprun"}]},{"block_type":"text","content":"magic:"}]},{"block_type":"element","block":"k68ocob8","search_text":"%lprun -f c_benchmark c_benchmark() # Output: Timer unit: 1e-06 s Total time: 2.322 s File: /home/gabriele/.cache/ipython/cython/_cython_magic_18ad8204e9d29650f3b09feb48ab0f44.pyx Function: c_benchmark at line 11 Line # Hits Time Per Hit % Time Line Contents ============================================================== 11 def c_benchmark(): 12 1 226 226.0 0.0 a = np.random.rand... 13 1 67 67.0 0.0 b = np.random.rand... 14 15 1001 1715 1.7 0.1 for x1, y1 in a: 16 1001000 1299792 1.3 56.0 for x2, y2 in b: 17 1000000 1020203 1.0 43.9 chebyshev... ","text_count":551,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%lprun -f c_benchmark c_benchmark()\n# Output:\nTimer unit: 1e-06 s\n\nTotal time: 2.322 s\nFile: /home/gabriele/.cache/ipython/cython/_cython_magic_18ad8204e9d29650f3b09feb48ab0f44.pyx\nFunction: c_benchmark at line 11\n\nLine #      Hits         Time  Per Hit   % Time  Line Contents\n==============================================================\n    11                                           def c_benchmark():\n    12         1          226    226.0      0.0      a = np.random.rand...\n    13         1           67     67.0      0.0      b = np.random.rand...    \n    14                                               \n    15      1001         1715      1.7      0.1      for x1, y1 in a:\n    16   1001000      1299792      1.3     56.0          for x2, y2 in b:\n    17   1000000      1020203      1.0     43.9              chebyshev..."}]}]},{"block_type":"element","block":"k68ocob9","search_text":"As you can see, a good chunk of time is actually spent in line 16, which is a pure Python loop and a good candidate for further optimization.","text_count":141,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, a good chunk of time is actually spent in line 16, which is a pure Python loop and a good candidate for further optimization."}]},{"block_type":"element","block":"k68ocoba","search_text":"The tools available in Jupyter notebook allow for a fast edit-compile-test cycle so that you can quickly prototype and save time when testing different solutions.","text_count":162,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The tools available in Jupyter notebook allow for a fast edit-compile-test cycle so that you can quickly prototype and save time when testing different solutions."}]},{"block_type":"element","block":"k68ocobb","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k68ocobc","search_text":"Cython is a tool that bridges the convenience of Python with the speed of C. Compared to C bindings, Cython programs are much easier to maintain and debug, thanks to the tight integration and compatibility with Python and the availability of excellent tools.","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Cython is a tool that bridges the convenience of Python with the speed of C. Compared to&nbsp;C bindings, Cython programs are much easier to maintain and debug, thanks to the tight integration and compatibility with Python and the availability of excellent tools."}]},{"block_type":"element","block":"k68ocobd","search_text":"In this chapter, we introduced the basics of the Cython language and how to make our programs faster by adding static types to our variables and functions. We also learned how to work with C arrays, NumPy arrays, and memoryviews.","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we introduced the basics of the Cython language and how to make our programs faster by adding static types to our variables and functions. We also learned how to work with C arrays, NumPy arrays, and memoryviews."}]},{"block_type":"element","block":"k68ocobe","search_text":"We optimized our particle simulator by rewriting the critical evolve function, obtaining a tremendous speed gain. Finally, we learned how to use the annotated view to spot hard-to-find interpreter related calls and how to enable cProfile support in Cython. Also, we learned how to take advantage of the Jupyter notebook for integrated profiling and analysis of Cython codes.","text_count":374,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We optimized our particle simulator by rewriting the critical"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"evolve"}]},{"block_type":"text","content":"function, obtaining a tremendous speed gain. Finally, we learned how to use the annotated view to spot hard-to-find interpreter related calls and how to enable"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cProfile"}]},{"block_type":"text","content":"&nbsp;support in Cython. Also, we learned how to take advantage of the Jupyter notebook&nbsp;for integrated profiling and analysis of Cython codes."}]},{"block_type":"element","block":"k68ocobf","search_text":"In the next chapter, we will explore other tools that can generate fast machine code on the fly, without requiring compilation of our code to C ahead of time.","text_count":158,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter, we will explore other tools&nbsp;that can generate fast machine code on the fly, without requiring compilation of our code to C ahead of time."}]}]},{"title":"Exploring Compilers","author":"Gabriele Lanaro","block":"k68ocgu0","number":5,"contents":[{"block_type":"element","block":"k68ocobg","search_text":"Python is a mature and widely used language and there is a large interest in improving its performance by compiling functions and methods directly to machine code rather than executing instructions in the interpreter. We have already seen a compiler example in Chapter 4, C Performance with Cython , where Python code is enhanced with types, compiled to efficient C code, and the interpreter calls are side-stepped.","text_count":415,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Python is a mature and widely used language and there is a large interest in improving its performance by compiling functions and methods directly to machine code rather than executing instructions in the interpreter. We have already seen a compiler example in Chapter 4,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"C Performance with Cython"}]},{"block_type":"text","content":", where Python code is enhanced with types, compiled to efficient C code, and the interpreter calls are side-stepped."}]},{"block_type":"element","block":"k68ocobh","search_text":"In this chapter, we will explore two projects--Numba and PyPy--that approach compilation in a slightly different way. Numba is a library designed to compile small functions on the fly. Instead of transforming Python code to C, Numba analyzes and compiles Python functions directly to machine code. PyPy is a replacement interpreter that works by analyzing the code at runtime and optimizing the slow loops automatically.","text_count":420,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will explore two projects--Numba and PyPy--that approach compilation in a slightly different way."},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Numba"}]},{"block_type":"text","content":"is a library designed to compile small functions on the fly. Instead of transforming Python code to C, Numba analyzes and compiles Python functions directly to machine code."},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"PyPy"}]},{"block_type":"text","content":"is a replacement interpreter that works by analyzing the code at runtime and optimizing the slow loops automatically."}]},{"block_type":"element","block":"k68ocobi","search_text":"These tools are called Just - In - Time ( JIT ) compilers because the compilation is performed at runtime rather than before running the code (in other cases, the compiler is called ahead-of-time or AOT).","text_count":204,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"These tools are called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Just"}]},{"block_type":"text","content":"-"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"In"}]},{"block_type":"text","content":"-"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Time"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"JIT"}]},{"block_type":"text","content":") compilers because the compilation is performed at runtime rather than before running the code (in other cases, the compiler is called ahead-of-time or AOT)."}]},{"block_type":"element","block":"k68ocobj","search_text":"The list of topics to be covered in this chapter is as follows:","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The list of topics to be covered in this chapter is as follows:"}]},{"block_type":"element","block":"k68ocobk","search_text":"Getting started with Numba Implementing fast functions with native mode compilation Understanding and implementing universal functions JIT classes Setting up PyPy Running the particle simulator with PyPy Other interesting compilers ","text_count":232,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Getting started with Numba"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Implementing fast functions with native mode compilation"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Understanding and implementing universal functions"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"JIT classes"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Setting up PyPy"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Running the particle simulator with PyPy"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Other interesting compilers"}]}]},{"block_type":"element","block":"k68ocobl","search_text":"Numba","text_count":5,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Numba"}]},{"block_type":"element","block":"k68ocobm","search_text":"Numba was started in 2012 by Travis Oliphant, the original author of NumPy, as a library for compiling individual Python functions at runtime using the Low-Level Virtual Machine ( LLVM ) toolchain.","text_count":197,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numba was started in 2012 by Travis Oliphant, the original author of NumPy, as a library for compiling individual Python functions at runtime using the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Low-Level Virtual Machine"}]},{"block_type":"text","content":"&nbsp;("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"LLVM"}]},{"block_type":"text","content":") toolchain."}]},{"block_type":"element","block":"k68ocobn","search_text":"LLVM is a set of tools designed to write compilers. LLVM is language agnostic and is used to write compilers for a wide range of languages (an important example is the clang compiler). One of the core aspects of LLVM is the intermediate representation (the LLVM IR), a very low-level platform-agnostic language similar to assembly, that can be compiled to machine code for the specific target platform.","text_count":402,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"LLVM is a set of tools designed to write compilers. LLVM is language agnostic and is used to write compilers for a wide range of languages (an important example is the clang&nbsp;compiler). One of the core aspects of LLVM is the intermediate representation (the LLVM IR), a very low-level platform-agnostic language similar to assembly, that can be compiled to machine code for the specific target platform."}]},{"block_type":"element","block":"k68ocobo","search_text":"Numba works by inspecting Python functions and by compiling them, using LLVM, to the IR. As we have already seen in the last chapter, the speed gains can be obtained when we introduce types for variables and functions. Numba implements clever algorithms to guess the types (this is called type inference) and compiles type-aware versions of the functions for fast execution.","text_count":374,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numba works by inspecting Python functions and by compiling them, using LLVM, to the IR. As we have already seen in the last&nbsp;chapter, the speed gains can be obtained when we introduce types for variables and functions. Numba implements clever algorithms to guess the types (this is called type inference) and compiles type-aware versions of the functions for fast execution."}]},{"block_type":"element","block":"k68ocobp","search_text":"Note that Numba was developed to improve the performance of numerical code. The development efforts often prioritize the optimization of applications that intensively use NumPy arrays.","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that Numba was developed to improve the performance of numerical code. The development efforts often prioritize the optimization of applications that intensively use NumPy arrays."}]},{"block_type":"element","block":"k68ocobq","search_text":"Note Numba is evolving really fast and can have substantial improvements between releases and, sometimes, backward incompatible changes. To keep up, ensure that you refer to the release notes for each version. In the rest of this chapter, we will use Numba version 0.30.1; ensure that you install the correct version to avoid any error. The complete code examples in this chapter can be found in the Numba.ipynb notebook. ","text_count":422,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numba is evolving really fast and can have substantial improvements between releases and, sometimes, backward incompatible changes.&nbsp; To keep up, ensure that you refer to the release notes for each version. In the rest of this chapter, we will use Numba version 0.30.1; ensure that you install the correct version to avoid any error. The complete code examples in this chapter can be found in the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Numba.ipynb"}]},{"block_type":"text","content":"&nbsp;notebook."}]}]},{"block_type":"element","block":"k68ocobr","search_text":"First steps with Numba","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"First steps with Numba"}]},{"block_type":"element","block":"k68ocobs","search_text":"Getting started with Numba is fairly straightforward. As a first example, we will implement a function that calculates the sum of squares of an array. The function definition is as follows:","text_count":189,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Getting started with Numba is fairly straightforward. As a first example, we will implement a function that calculates the sum of squares of an array. The function definition is as follows:"}]},{"block_type":"element","block":"k68ocobt","search_text":"def sum_sq(a): result = 0 N = len(a) for i in range(N): result += a[i] return result ","text_count":85,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def sum_sq(a):\n        result = 0\n        N = len(a)\n        for i in range(N):\n            result += a[i]\n        return result"}]}]},{"block_type":"element","block":"k68ocobu","search_text":"To set up this function with Numba, it is sufficient to apply the nb.jit decorator:","text_count":83,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To set up this function with Numba, it is sufficient to apply the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jit"}]},{"block_type":"text","content":"decorator:"}]},{"block_type":"element","block":"k68ocobv","search_text":"from numba import nb @nb.jit def sum_sq(a): ... ","text_count":48,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from numba import nb\n\n    @nb.jit\n    def sum_sq(a):\n        ..."}]}]},{"block_type":"element","block":"k68ocobw","search_text":"The nb.jit decorator won't do much when applied. However, when the function will be invoked for the first time, Numba will detect the type of the input argument, a , and compile a specialized, performant version of the original function.","text_count":237,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jit"}]},{"block_type":"text","content":"decorator won't do much when applied. However, when the function will be invoked for the first time, Numba will detect the type of the input argument,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":", and compile a specialized, performant version of the original function."}]},{"block_type":"element","block":"k68ocobx","search_text":"To measure the performance gain obtained by the Numba compiler, we can compare the timings of the original and the specialized functions. The original, undecorated function can be easily accessed through the py_func attribute. The timings for the two functions are as follows:","text_count":276,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To measure the performance gain obtained by the Numba compiler, we can compare the timings of the original and the specialized functions. The original, undecorated function can be easily accessed through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"py_func"}]},{"block_type":"text","content":"&nbsp;attribute. The timings for the two functions are as follows:"}]},{"block_type":"element","block":"k68ocoby","search_text":"import numpy as np x = np.random.rand(10000) # Original %timeit sum_sq.py_func(x) 100 loops, best of 3: 6.11 ms per loop # Numba %timeit sum_sq(x) 100000 loops, best of 3: 11.7 µs per loop ","text_count":189,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np\n\n    x = np.random.rand(10000)\n\n    # Original\n    %timeit sum_sq.py_func(x)\n    100 loops, best of 3: 6.11 ms per loop\n\n    # Numba\n    %timeit sum_sq(x)\n    100000 loops, best of 3: 11.7 &micro;s per loop"}]}]},{"block_type":"element","block":"k68ocobz","search_text":"From the previous code, you can see how the Numba version (11.7 µs) is one order of magnitude faster than the Python version (6.11 ms). We can also compare how this implementation stacks up against NumPy standard operators:","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From the previous code, you can see how the Numba version&nbsp;(11.7 &micro;s) is one order of magnitude faster than the Python version (6.11 ms). We can also compare how this implementation stacks up against NumPy standard operators:"}]},{"block_type":"element","block":"k68ococ0","search_text":"%timeit (x**2).sum() 10000 loops, best of 3: 14.8 µs per loop ","text_count":62,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"%timeit (x**2).sum()\n    10000 loops, best of 3: 14.8 &micro;s per loop"}]}]},{"block_type":"element","block":"k68ococ1","search_text":"In this case, the Numba compiled function is marginally faster than NumPy vectorized operations. The reason for the extra speed of the Numba version is likely that the NumPy version allocates an extra array before performing the sum in comparison with the in-place operations performed by our sum_sq function.","text_count":309,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this case, the Numba compiled function is marginally faster than NumPy vectorized operations. The reason for the extra speed of the Numba version is likely that the NumPy version allocates an extra array before performing the sum in comparison with the in-place operations performed by our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_sq"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","block":"k68ococ2","search_text":"As we didn't use array-specific methods in sum_sq , we can also try to apply the same function on a regular Python list of floating point numbers. Interestingly, Numba is able to obtain a substantial speed up even in this case, as compared to a list comprehension:","text_count":264,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we didn't use array-specific methods in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_sq"}]},{"block_type":"text","content":", we can also try to apply the same function on a regular Python list of floating point numbers. Interestingly, Numba is able to obtain a substantial speed up even in this case, as compared to a list comprehension:"}]},{"block_type":"element","block":"k68ococ3","search_text":"x_list = x.tolist() %timeit sum_sq(x_list) 1000 loops, best of 3: 199 µs per loop %timeit sum([x**2 for x in x_list]) 1000 loops, best of 3: 1.28 ms per loop ","text_count":158,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"x_list = x.tolist()\n    %timeit sum_sq(x_list)\n    1000 loops, best of 3: 199 &micro;s per loop\n\n    %timeit sum([x**2 for x in x_list])\n    1000 loops, best of 3: 1.28 ms per loop"}]}]},{"block_type":"element","block":"k68ococ4","search_text":"Considering that all we needed to do was apply a simple decorator to obtain an incredible speed up over different data types, it's no wonder that what Numba does looks like magic. In the following sections, we will dig deeper and understand how Numba works and evaluate the benefits and limitations of the Numba compiler.","text_count":321,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Considering that all we needed to do was apply a simple decorator to obtain an incredible speed up over different data types, it's no wonder that what Numba does looks like magic. In the following sections, we will dig deeper and understand how Numba works and evaluate the benefits and limitations of the Numba compiler."}]},{"block_type":"element","block":"k68ococ5","search_text":"Type specializations","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Type specializations"}]},{"block_type":"element","block":"k68ococ6","search_text":"As shown earlier, the nb.jit decorator works by compiling a specialized version of the function once it encounters a new argument type. To better understand how this works, we can inspect the decorated function in the sum_sq example.","text_count":233,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As shown earlier, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jit"}]},{"block_type":"text","content":"decorator works by compiling a specialized version of the function once it encounters a new argument type. To better understand how this works, we can inspect the decorated function in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_sq"}]},{"block_type":"text","content":"example."}]},{"block_type":"element","block":"k68ococ7","search_text":"Numba exposes the specialized types using the signatures attribute. Right after the sum_sq definition, we can inspect the available specialization by accessing the sum_sq.signatures , as follows:","text_count":195,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numba exposes the specialized types using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"signatures"}]},{"block_type":"text","content":"attribute. Right after the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_sq"}]},{"block_type":"text","content":"definition, we can inspect the available specialization by accessing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_sq.signatures"}]},{"block_type":"text","content":", as follows:"}]},{"block_type":"element","block":"k68ococ8","search_text":"sum_sq.signatures # Output: # [] ","text_count":33,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"sum_sq.signatures\n    # Output:\n    # []"}]}]},{"block_type":"element","block":"k68ococ9","search_text":"If we call this function with a specific argument, for instance, an array of float64 numbers, we can see how Numba compiles a specialized version on the fly. If we also apply the function on an array of float32 , we can see how a new entry is added to the sum_sq.signatures list:","text_count":279,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we call this function with a specific argument, for instance, an array of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float64"}]},{"block_type":"text","content":"numbers, we can see how Numba compiles a specialized version on the fly. If we also apply the function on an array of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float32"}]},{"block_type":"text","content":", we can see how a new entry is added to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_sq.signatures"}]},{"block_type":"text","content":"list:"}]},{"block_type":"element","block":"k68ococa","search_text":"x = np.random.rand(1000).astype('float64') sum_sq(x) sum_sq.signatures # Result: # [(array(float64, 1d, C),)] x = np.random.rand(1000).astype('float32') sum_sq(x) sum_sq.signatures # Result: # [(array(float64, 1d, C),), (array(float32, 1d, C),)] ","text_count":246,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"x = np.random.rand(1000).astype('float64')\n    sum_sq(x)\n    sum_sq.signatures\n    # Result:\n    # [(array(float64, 1d, C),)]\n\n    x = np.random.rand(1000).astype('float32')\n    sum_sq(x)\n    sum_sq.signatures\n    # Result:\n    # [(array(float64, 1d, C),), (array(float32, 1d, C),)]"}]}]},{"block_type":"element","block":"k68ococb","search_text":"It is possible to explicitly compile the function for certain types by passing a signature to the nb.jit function.","text_count":114,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is possible to explicitly compile the function for certain types by passing a signature to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jit"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","block":"k68ococc","search_text":"An individual signature can be passed as a tuple that contains the type we would like to accept. Numba provides a great variety of types that can be found in the nb.types module, and they are also available in the top-level nb namespace. If we want to specify an array of a specific type, we can use the slicing operator, [:] , on the type itself. In the following example, we demonstrate how to declare a function that takes an array of float64 as its only argument:","text_count":467,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An individual signature can be passed as a tuple that contains the type we would like to accept. Numba provides a great variety of types that can be found in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.types"}]},{"block_type":"text","content":"module, and they are also available in the top-level"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb"}]},{"block_type":"text","content":"namespace. If we want to specify an array of a specific type, we can use the slicing operator,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"[:]"}]},{"block_type":"text","content":", on the type itself. In the following example, we demonstrate how to declare a function that takes an array of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float64"}]},{"block_type":"text","content":"&nbsp;as its only argument:"}]},{"block_type":"element","block":"k68ococd","search_text":"@nb.jit((nb.float64[:],)) def sum_sq(a): ","text_count":41,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@nb.jit((nb.float64[:],))\n    def sum_sq(a):"}]}]},{"block_type":"element","block":"k68ococe","search_text":"Note that when we explicitly declare a signature, we are prevented from using other types, as demonstrated in the following example. If we try to pass an array, x , as float32 , Numba will raise a TypeError :","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that when we explicitly declare a signature, we are prevented from using other types, as demonstrated in the following example. If we try to pass an array,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":", as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float32"}]},{"block_type":"text","content":", Numba will raise a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"TypeError"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ococf","search_text":"sum_sq(x.astype('float32')) # TypeError: No matching definition for argument type(s) array(float32, 1d, C) ","text_count":107,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"sum_sq(x.astype('float32'))\n    # TypeError: No matching definition for argument type(s) \n    array(float32, 1d, C)"}]}]},{"block_type":"element","block":"k68ococg","search_text":"Another way to declare signatures is through type strings. For example, a function that takes a float64 as input and returns a float64 as output can be declared with the float64(float64) string. Array types can be declared using a [:] suffix. To put this together, we can declare a signature for our sum_sq function, as follows:","text_count":328,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another way to declare signatures is through type strings. For example, a function that takes a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float64"}]},{"block_type":"text","content":"as input and returns a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float64"}]},{"block_type":"text","content":"as output can be declared with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float64(float64)"}]},{"block_type":"text","content":"&nbsp;string. Array types can be declared using a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"[:]"}]},{"block_type":"text","content":"suffix. To put this together, we can declare a signature for our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_sq"}]},{"block_type":"text","content":"&nbsp;function, as follows:"}]},{"block_type":"element","block":"k68ococh","search_text":"@nb.jit(\"float64(float64[:])\") def sum_sq(a): ","text_count":46,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@nb.jit(\"float64(float64[:])\")\n    def sum_sq(a):"}]}]},{"block_type":"element","block":"k68ococi","search_text":"You can also pass multiple signatures by passing a list:","text_count":56,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can also pass multiple signatures by passing a list:"}]},{"block_type":"element","block":"k68ococj","search_text":"@nb.jit([\"float64(float64[:])\", \"float64(float32[:])\"]) def sum_sq(a): ","text_count":71,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@nb.jit([\"float64(float64[:])\",\n             \"float64(float32[:])\"])\n    def sum_sq(a):"}]}]},{"block_type":"element","block":"k68ocock","search_text":"Object mode versus native mode","text_count":30,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Object mode versus native mode"}]},{"block_type":"element","block":"k68ococl","search_text":"So far, we have shown how Numba behaves when handling a fairly simple function. In this case, Numba worked exceptionally well, and we obtained great performance on arrays and lists.","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So far, we have shown how Numba behaves when handling a fairly simple function. In this case, Numba worked exceptionally well, and we obtained great performance on arrays and lists."}]},{"block_type":"element","block":"k68ococm","search_text":"The degree of optimization obtainable from Numba depends on how well Numba is able to infer the variable types and how well it can translate those standard Python operations to fast type-specific versions. If this happens, the interpreter is side-stepped and we can get performance gains similar to those of Cython.","text_count":315,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The degree of optimization obtainable from Numba depends on how well Numba is able to infer the variable types and how well it can translate those standard Python operations to fast type-specific versions. If this happens, the interpreter is side-stepped and we can get performance gains similar to those of Cython."}]},{"block_type":"element","block":"k68ococn","search_text":"When Numba cannot infer variable types, it will still try and compile the code, reverting to the interpreter when the types can't be determined or when certain operations are unsupported. In Numba, this is called object mode and is in contrast to the interpreter-free scenario, called native mode .","text_count":298,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When Numba cannot infer variable types, it will still try and compile the code, reverting to the interpreter when the types can't be determined or when certain operations are unsupported. In Numba, this is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"object mode"}]},{"block_type":"text","content":"and is in contrast to the interpreter-free scenario, called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"native mode"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ococo","search_text":"Numba provides a function, called inspect_types , that helps understand how effective the type inference was and which operations were optimized. As an example, we can take a look at the types inferred for our sum_sq function:","text_count":226,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numba provides a function, called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"inspect_types"}]},{"block_type":"text","content":", that helps understand how effective the type inference was and which operations were optimized. As an example, we can take a look at the types inferred for our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_sq"}]},{"block_type":"text","content":"&nbsp;function:"}]},{"block_type":"element","block":"k68ococp","search_text":"sum_sq.inspect_types() ","text_count":23,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"sum_sq.inspect_types()"}]}]},{"block_type":"element","block":"k68ococq","search_text":"When this function is called, Numba will print the type inferred for each specialized version of the function. The output consists of blocks that contain information about variables and types associated with them. For example, we can examine the N = len(a) line:","text_count":262,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When this function is called, Numba will print the type inferred for each specialized version of the function. The output consists of blocks that contain information about variables and types associated with them. For example, we can examine the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"N = len(a)"}]},{"block_type":"text","content":"&nbsp;line:"}]},{"block_type":"element","block":"k68ococr","search_text":"# --- LINE 4 --- # a = arg(0, name=a) :: array(float64, 1d, A) # $0.1 = global(len: <built-in function len>) :: Function(<built-in function len>) # $0.3 = call $0.1(a) :: (array(float64, 1d, A),) -> int64 # N = $0.3 :: int64 N = len(a) ","text_count":236,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# --- LINE 4 --- \n    #   a = arg(0, name=a)  :: array(float64, 1d, A)\n    #   $0.1 = global(len: &lt;built-in function len&gt;)  :: \n    Function(&lt;built-in function len&gt;)\n    #   $0.3 = call $0.1(a)  :: (array(float64, 1d, A),) -&gt; int64\n    #   N = $0.3  :: int64\n\n    N = len(a)"}]}]},{"block_type":"element","block":"k68ococs","search_text":"For each line, Numba prints a thorough description of variables, functions, and intermediate results. In the preceding example, you can see (second line) that the argument a is correctly identified as an array of float64 numbers. At LINE 4 , the input and return type of the len function is also correctly identified (and likely optimized) as taking an array of float64 numbers and returning an int64 .","text_count":402,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For each line, Numba prints a thorough description of variables, functions, and intermediate results. In the preceding example, you can see (second line) that the argument"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"is correctly identified as an array of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float64"}]},{"block_type":"text","content":"numbers. At"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LINE&nbsp;4"}]},{"block_type":"text","content":", the input and return type of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"len"}]},{"block_type":"text","content":"function is also correctly identified (and likely optimized) as taking an array of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float64"}]},{"block_type":"text","content":"numbers and returning an"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int64"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ococt","search_text":"If you scroll through the output, you can see how all the variables have a well-defined type. Therefore, we can be certain that Numba is able to compile the code quite efficiently. This form of compilation is called native mode .","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you scroll through the output, you can see how all the variables have a well-defined type. Therefore, we can be certain that Numba is able to compile the code quite efficiently. This form of compilation is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"native mode"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ococu","search_text":"As a counter example, we can see what happens if we write a function with unsupported operations. For example, as of version 0.30.1, Numba has limited support for string operations.","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a counter example, we can see what happens if we write a function with unsupported operations. For example, as of version 0.30.1, Numba has limited support for string operations."}]},{"block_type":"element","block":"k68ococv","search_text":"We can implement a function that concatenates a series of strings, and compiles it as follows:","text_count":94,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can implement a function that concatenates a series of strings, and compiles it as follows:"}]},{"block_type":"element","block":"k68ococw","search_text":"@nb.jit def concatenate(strings): result = '' for s in strings: result += s return result ","text_count":90,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@nb.jit\n    def concatenate(strings):\n        result = ''\n        for s in strings:\n            result += s\n        return result"}]}]},{"block_type":"element","block":"k68ococx","search_text":"Now, we can invoke this function with a list of strings and inspect the types:","text_count":78,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, we can invoke this function with a list of strings and inspect the types:"}]},{"block_type":"element","block":"k68ococy","search_text":"concatenate(['hello', 'world']) concatenate.signatures # Output: [(reflected list(str),)] concatenate.inspect_types() ","text_count":118,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"concatenate(['hello', 'world'])\n    concatenate.signatures\n    # Output: [(reflected list(str),)]\n    concatenate.inspect_types()"}]}]},{"block_type":"element","block":"k68ococz","search_text":"Numba will return the output of the function for the reflected list (str) type. We can, for instance, examine how line 3 gets inferred. The output of concatenate.inspect_types() is reproduced here:","text_count":197,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numba will return the output of the function for the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"reflected list (str)"}]},{"block_type":"text","content":"&nbsp;type. We can, for instance, examine how line 3 gets inferred. The output of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concatenate.inspect_types()"}]},{"block_type":"text","content":"is reproduced here:"}]},{"block_type":"element","block":"k68ocod0","search_text":"# --- LINE 3 --- # strings = arg(0, name=strings) :: pyobject # $const0.1 = const(str, ) :: pyobject # result = $const0.1 :: pyobject # jump 6 # label 6 result = '' ","text_count":165,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# --- LINE 3 --- \n    #   strings = arg(0, name=strings)  :: pyobject\n    #   $const0.1 = const(str, )  :: pyobject\n    #   result = $const0.1  :: pyobject\n    #   jump 6\n    # label 6\n\n    result = ''"}]}]},{"block_type":"element","block":"k68ocod1","search_text":"You can see how this time, each variable or function is of the generic pyobject type rather than a specific one. This means that, in this case, Numba is unable to compile this operation without the help of the Python interpreter. Most importantly, if we time the original and compiled function, we note that the compiled function is about three times slower than the pure Python counterpart:","text_count":391,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can see how this time, each variable or function is of the generic"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyobject"}]},{"block_type":"text","content":"type rather than a specific one. This means that, in this case, Numba is unable to compile this operation without the help of the Python interpreter. Most importantly, if we time the original and compiled function, we note that the compiled function is about three times"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"slower"}]},{"block_type":"text","content":"than the pure Python counterpart:"}]},{"block_type":"element","block":"k68ocod2","search_text":"x = ['hello'] * 1000 %timeit concatenate.py_func(x) 10000 loops, best of 3: 111 µs per loop %timeit concatenate(x) 1000 loops, best of 3: 317 µs per loop ","text_count":154,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"x = ['hello'] * 1000\n    %timeit concatenate.py_func(x)\n    10000 loops, best of 3: 111 &micro;s per loop\n\n    %timeit concatenate(x)\n    1000 loops, best of 3: 317 &micro;s per loop"}]}]},{"block_type":"element","block":"k68ocod3","search_text":"This is because the Numba compiler is not able to optimize the code and adds some extra overhead to the function call.","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is because the Numba compiler is not able to optimize the code and adds some extra overhead to the function call."}]},{"block_type":"element","block":"k68ocod4","search_text":"As you may have noted, Numba compiled the code without complaints even if it is inefficient. The main reason for this is that Numba can still compile other sections of the code in an efficient manner while falling back to the Python interpreter for other parts of the code. This compilation strategy is called object mode .","text_count":323,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you may have noted, Numba compiled the code without complaints even if it is inefficient. The main reason for this is that Numba can still compile other sections of the code in an efficient manner while falling back to the Python interpreter for other parts of the code. This compilation strategy is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"object mode"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocod5","search_text":"It is possible to force the use of native mode by passing the nopython=True option to the nb.jit decorator. If, for example, we apply this decorator to our concatenate function, we observe that Numba throws an error on first invocation:","text_count":236,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is possible to force the use of native mode by passing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nopython=True"}]},{"block_type":"text","content":"option to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jit"}]},{"block_type":"text","content":"decorator. If, for example, we apply this decorator to our concatenate function, we observe that Numba throws an error on first invocation:"}]},{"block_type":"element","block":"k68ocod6","search_text":"@nb.jit(nopython=True) def concatenate(strings): result = '' for s in strings: result += s return result concatenate(x) # Exception: # TypingError: Failed at nopython (nopython frontend) ","text_count":187,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@nb.jit(nopython=True)\n    def concatenate(strings):\n        result = ''\n        for s in strings:\n            result += s\n        return result\n\n    concatenate(x)\n    # Exception:\n    # TypingError: Failed at nopython (nopython frontend)"}]}]},{"block_type":"element","block":"k68ocod7","search_text":"This feature is quite useful for debugging and ensuring that all the code is fast and correctly typed.","text_count":102,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This feature is quite useful for debugging and ensuring that all the code is fast and correctly typed."}]},{"block_type":"element","block":"k68ocod8","search_text":"Numba and NumPy","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Numba and NumPy"}]},{"block_type":"element","block":"k68ocod9","search_text":"Numba was originally developed to easily increase performance of code that uses NumPy arrays. Currently, many NumPy features are implemented efficiently by the compiler.","text_count":169,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numba was originally developed to easily increase performance of code that uses NumPy arrays. Currently, many NumPy features are implemented efficiently by the compiler."}]},{"block_type":"element","block":"k68ocoda","search_text":"Universal functions with Numba","text_count":30,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Universal functions with Numba"}]},{"block_type":"element","block":"k68ocodb","search_text":"Universal functions are special functions defined in NumPy that are able to operate on arrays of different sizes and shapes according to the broadcasting rules. One of the best features of Numba is the implementation of fast ufuncs .","text_count":233,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Universal functions are special functions defined in NumPy that are able to operate on arrays of different sizes and shapes according to the broadcasting rules. One of the best features of Numba is the implementation of fast"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ufuncs"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocodc","search_text":"We have already seen some ufunc examples in Chapter 3 , Fast Array Operations with NumPy and Pandas . For instance, the np.log function is a ufunc because it can accept scalars and arrays of different sizes and shapes. Also, universal functions that take multiple arguments still work according to the broadcasting rules. Examples of universal functions that take multiple arguments are np.sum or np.difference .","text_count":412,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We have already seen some"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ufunc"}]},{"block_type":"text","content":"examples in Chapter 3"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":", Fast Array Operations with NumPy and Pandas"}]},{"block_type":"text","content":". For instance, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.log"}]},{"block_type":"text","content":"function is a&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ufunc"}]},{"block_type":"text","content":"because it can accept scalars and arrays of different sizes and shapes. Also, universal functions that take multiple arguments still work according to the&nbsp; broadcasting rules. Examples of universal functions that take multiple arguments are"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.sum"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.difference"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocodd","search_text":"Universal functions can be defined in standard NumPy by implementing the scalar version and using the np.vectorize function to enhance the function with the broadcasting feature. As an example, we will see how to write the Cantor pairing function .","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Universal functions can be defined in standard NumPy by implementing the scalar version and using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.vectorize"}]},{"block_type":"text","content":"function to enhance the function with the broadcasting feature. As an example, we will see how to write the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Cantor pairing function"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocode","search_text":"A pairing function is a function that encodes two natural numbers into a single natural number so that you can easily interconvert between the two representations. The Cantor pairing function can be written as follows:","text_count":218,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A pairing function is a function that encodes two natural numbers into a single natural number so that you can easily interconvert between the two representations. The Cantor pairing function can be written as follows:"}]},{"block_type":"element","block":"k68ocodf","search_text":"import numpy as np def cantor(a, b): return int(0.5 * (a + b)*(a + b + 1) + b) ","text_count":79,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np\n\n    def cantor(a, b):\n        return  int(0.5 * (a + b)*(a + b + 1) + b)"}]}]},{"block_type":"element","block":"k68ocodg","search_text":"As already mentioned, it is possible to create a ufunc in pure Python using the np.vectorized decorator:","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As already mentioned, it is possible to create a ufunc in pure Python using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.vectorized"}]},{"block_type":"text","content":"decorator:"}]},{"block_type":"element","block":"k68ocodh","search_text":"@np.vectorize def cantor(a, b): return int(0.5 * (a + b)*(a + b + 1) + b) cantor(np.array([1, 2]), 2) # Result: # array([ 8, 12]) ","text_count":130,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@np.vectorize\n    def cantor(a, b):\n        return  int(0.5 * (a + b)*(a + b + 1) + b)\n\n    cantor(np.array([1, 2]), 2)\n    # Result:\n    # array([ 8, 12])"}]}]},{"block_type":"element","block":"k68ocodi","search_text":"Except for the convenience, defining universal functions in pure Python is not very useful as it requires a lot of function calls affected by interpreter overhead. For this reason, ufunc implementation is usually done in C or Cython, but Numba beats all these methods by its convenience.","text_count":287,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Except for the convenience, defining universal functions in pure Python is not very useful as it requires a lot of function calls affected by interpreter overhead. For this reason, ufunc implementation is usually done in C or Cython, but Numba beats all these methods by its convenience."}]},{"block_type":"element","block":"k68ocodj","search_text":"All that is needed to do in order to perform the conversion is using the equivalent decorator, nb.vectorize . We can compare the speed of the standard np.vectorized version which, in the following code, is called cantor_py , and the same function is implemented using standard NumPy operations:","text_count":294,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All that is needed to do in order to perform the conversion is using the equivalent decorator,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.vectorize"}]},{"block_type":"text","content":". We can compare the speed of the standard"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.vectorized"}]},{"block_type":"text","content":"version which, in the following code, is&nbsp;called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cantor_py"}]},{"block_type":"text","content":", and the same function is implemented using standard NumPy operations:"}]},{"block_type":"element","block":"k68ocodk","search_text":"# Pure Python %timeit cantor_py(x1, x2) 100 loops, best of 3: 6.06 ms per loop # Numba %timeit cantor(x1, x2) 100000 loops, best of 3: 15 µs per loop # NumPy %timeit (0.5 * (x1 + x2)*(x1 + x2 + 1) + x2).astype(int) 10000 loops, best of 3: 57.1 µs per loop ","text_count":256,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# Pure Python\n    %timeit cantor_py(x1, x2)\n    100 loops, best of 3: 6.06 ms per loop\n    # Numba\n    %timeit cantor(x1, x2)\n    100000 loops, best of 3: 15 &micro;s per loop\n    # NumPy\n    %timeit (0.5 * (x1 + x2)*(x1 + x2 + 1) + x2).astype(int)\n    10000 loops, best of 3: 57.1 &micro;s per loop"}]}]},{"block_type":"element","block":"k68ocodl","search_text":"You can see how the Numba version beats all the other options by a large margin! Numba works extremely well because the function is simple and type inference is possible.","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can see how the Numba version beats all the other options by a large margin! Numba works extremely well because the function is simple and type inference is possible."}]},{"block_type":"element","block":"k68ocodm","search_text":"Note An additional advantage of universal functions is that, since they depend on individual values, their evaluation can also be executed in parallel. Numba provides an easy way to parallelize such functions by passing the target=\"cpu\" or target=\"gpu\" keyword argument to the nb.vectorize decorator. ","text_count":301,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An additional advantage of universal functions is that, since they depend on individual values, their evaluation can also be executed in parallel. Numba provides an easy way to parallelize such functions by passing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"target=\"cpu\""}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"target=\"gpu\""}]},{"block_type":"text","content":"keyword argument to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.vectorize"}]},{"block_type":"text","content":"decorator."}]}]},{"block_type":"element","block":"k68ocodn","search_text":"Generalized universal functions","text_count":31,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Generalized universal functions"}]},{"block_type":"element","block":"k68ocodo","search_text":"One of the main limitations of universal functions is that they must be defined on scalar values. A generalized universal function, abbreviated gufunc , is an extension of universal functions to procedures that take arrays.","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the main limitations of universal functions is that they must be defined on scalar values. A generalized universal function, abbreviated"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"gufunc"}]},{"block_type":"text","content":", is an extension of universal functions to procedures that take arrays."}]},{"block_type":"element","block":"k68ocodp","search_text":"A classic example is the matrix multiplication. In NumPy, matrix multiplication can be applied using the np.matmul function, which takes two 2D arrays and returns another 2D array. An example usage of np.matmul is as follows:","text_count":225,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A&nbsp;classic example is the matrix multiplication. In NumPy, matrix multiplication can be applied using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.matmul"}]},{"block_type":"text","content":"function, which takes two 2D arrays and returns another 2D array. An example usage of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.matmul"}]},{"block_type":"text","content":"is as follows:"}]},{"block_type":"element","block":"k68ocodq","search_text":"a = np.random.rand(3, 3) b = np.random.rand(3, 3) c = np.matmul(a, b) c.shape # Result: # (3, 3) ","text_count":97,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.random.rand(3, 3)\n    b = np.random.rand(3, 3)\n\n    c = np.matmul(a, b)\n    c.shape\n    # Result:\n    # (3, 3)"}]}]},{"block_type":"element","block":"k68ocodr","search_text":"As we saw in the previous subsection, a ufunc broadcasts the operation over arrays of scalars , its natural generalization will be to broadcast over an array of arrays . If, for instance, we take two arrays of 3 by 3 matrices, we will expect np.matmul to take to match the matrices and take their product. In the following example, we take two arrays containing 10 matrices of shape (3, 3) . If we apply np.matmul , the product will be applied matrix-wise to obtain a new array containing the 10 results (which are, again, (3, 3) matrices):","text_count":540,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we saw in the previous subsection, a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ufunc"}]},{"block_type":"text","content":"broadcasts the operation over arrays of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"scalars"}]},{"block_type":"text","content":", its natural generalization will&nbsp;be to broadcast over an array of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"arrays"}]},{"block_type":"text","content":". If, for instance, we take two arrays of 3 by 3 matrices, we will expect"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.matmul"}]},{"block_type":"text","content":"to take to match the matrices and take their product. In the following example, we take two arrays containing 10 matrices of shape"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3, 3)"}]},{"block_type":"text","content":". If we apply"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.matmul"}]},{"block_type":"text","content":", the product will be applied&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"matrix-wise"}]},{"block_type":"text","content":"to obtain a new array containing the 10 results (which are, again,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3, 3)"}]},{"block_type":"text","content":"matrices):"}]},{"block_type":"element","block":"k68ocods","search_text":"a = np.random.rand(10, 3, 3) b = np.random.rand(10, 3, 3) c = np.matmul(a, b) c.shape # Output # (10, 3, 3) ","text_count":108,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.random.rand(10, 3, 3)\n    b = np.random.rand(10, 3, 3)\n\n    c = np.matmul(a, b)\n    c.shape\n    # Output\n    # (10, 3, 3)"}]}]},{"block_type":"element","block":"k68ocodt","search_text":"The usual rules for broadcasting will work in a similar way. For example, if we have an array of (3, 3) matrices, which will have a shape of (10, 3, 3) , we can use np.matmul to calculate the matrix multiplication of each element with a single (3, 3) matrix. According to the broadcasting rules, we obtain that the single matrix will be repeated to obtain a size of (10, 3, 3) :","text_count":378,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The usual rules for broadcasting will work in a similar way. For example, if we have an array of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3, 3)"}]},{"block_type":"text","content":"matrices, which will have a shape of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(10, 3, 3)"}]},{"block_type":"text","content":", we can use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"np.matmul"}]},{"block_type":"text","content":"to calculate the matrix multiplication of each element with a single"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(3, 3)"}]},{"block_type":"text","content":"matrix. According to the broadcasting rules, we obtain that the single matrix will be repeated to obtain a size of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(10, 3, 3)"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocodu","search_text":"a = np.random.rand(10, 3, 3) b = np.random.rand(3, 3) # Broadcasted to shape (10, 3, 3) c = np.matmul(a, b) c.shape # Result: # (10, 3, 3) ","text_count":139,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.random.rand(10, 3, 3)\n    b = np.random.rand(3, 3) # Broadcasted to shape (10, 3, 3)\n    c = np.matmul(a, b)\n    c.shape\n    # Result:\n    # (10, 3, 3)"}]}]},{"block_type":"element","block":"k68ocodv","search_text":"Numba supports the implementation of efficient generalized universal functions through the nb.guvectorize decorator. As an example, we will implement a function that computes the euclidean distance between two arrays as a gufunc . To create a gufunc , we have to define a function that takes the input arrays, plus an output array where we will store the result of our calculation.","text_count":381,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numba supports the implementation of efficient generalized universal functions through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.guvectorize"}]},{"block_type":"text","content":"&nbsp;decorator. As an example, we will implement a function that computes the euclidean distance between two arrays as a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"gufunc"}]},{"block_type":"text","content":". To create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"gufunc"}]},{"block_type":"text","content":", we have to define a function that takes the input arrays, plus an output array where we will store the result of our calculation."}]},{"block_type":"element","block":"k68ocodw","search_text":"The nb.guvectorize decorator requires two arguments:","text_count":52,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.guvectorize"}]},{"block_type":"text","content":"decorator requires two arguments:"}]},{"block_type":"element","block":"k68ocodx","search_text":"The types of the input and output: two 1D arrays as input and a scalar as output The so called layout string, which is a representation of the input and output sizes; in our case, we take two arrays of the same size (denoted arbitrarily by n ), and we output a scalar ","text_count":268,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The types of the input and output: two 1D arrays as input and a scalar as output"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The so called layout string, which is a representation of the input and output sizes; in our case, we take two arrays of the same size (denoted arbitrarily by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"n"}]},{"block_type":"text","content":"), and we output a scalar"}]}]},{"block_type":"element","block":"k68ocody","search_text":"In the following example, we show the implementation of the euclidean function using the nb.guvectorize decorator:","text_count":114,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following example, we show the implementation of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"euclidean"}]},{"block_type":"text","content":"function using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.guvectorize"}]},{"block_type":"text","content":"decorator:"}]},{"block_type":"element","block":"k68ocodz","search_text":"@nb.guvectorize(['float64[:], float64[:], float64[:]'], '(n), (n) - > ()') def euclidean(a, b, out): N = a.shape[0] out[0] = 0.0 for i in range(N): out[0] += (a[i] - b[i])**2 ","text_count":175,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@nb.guvectorize(['float64[:], float64[:], float64[:]'], '(n), (n) -\n    &gt; ()')\n    def euclidean(a, b, out):\n        N = a.shape[0]\n        out[0] = 0.0\n        for i in range(N):\n            out[0] += (a[i] - b[i])**2"}]}]},{"block_type":"element","block":"k68ocoe0","search_text":"There are a few very important points to be made. Predictably, we declared the types of the inputs a and b as float64[:] , because they are 1D arrays. However, what about the output argument? Wasn't it supposed to be a scalar? Yes, however, Numba treats scalar argument as arrays of size 1 . That's why it was declared as float64[:] .","text_count":334,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are a few very important points to be made. Predictably, we declared the types of the inputs"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"b"}]},{"block_type":"text","content":"as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float64[:]"}]},{"block_type":"text","content":", because they are 1D arrays. However,&nbsp;what about the output argument? Wasn't it supposed to be a scalar? Yes, however,"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Numba treats scalar argument as arrays of size 1"}]},{"block_type":"text","content":". That's why it was declared as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float64[:]"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocoe1","search_text":"Similarly, the layout string indicates that we have two arrays of size (n) and the output is a scalar, denoted by empty brackets-- () . However, the array out will be passed as an array of size 1.","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Similarly, the layout string indicates that we have two arrays of size"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(n)"}]},{"block_type":"text","content":"and the output is a scalar, denoted by empty brackets--"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"()"}]},{"block_type":"text","content":". However, the array out will be passed as an array of size 1."}]},{"block_type":"element","block":"k68ocoe2","search_text":"Also, note that we don't return anything from the function; all the output has to be written in the out array.","text_count":110,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, note that we don't return anything from the function; all the output has to be written in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"out"}]},{"block_type":"text","content":"array."}]},{"block_type":"element","block":"k68ocoe3","search_text":"Tip The letter n in the layout string is completely arbitrary; you may choose to use k or other letters of your liking. Also, if you want to combine arrays of uneven sizes, you can use layouts strings, such as (n, m) . ","text_count":219,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The letter"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"n"}]},{"block_type":"text","content":"in the layout string is completely arbitrary; you may choose to use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"k"}]},{"block_type":"text","content":"&nbsp; or other letters of your liking. Also, if you want to combine arrays of uneven sizes, you can use layouts strings, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(n, m)"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68ocoe4","search_text":"Our brand new euclidean function can be conveniently used on arrays of different shapes, as shown in the following example:","text_count":123,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our brand new"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"euclidean"}]},{"block_type":"text","content":"function can be conveniently used on arrays of different shapes, as shown in the following example:"}]},{"block_type":"element","block":"k68ocoe5","search_text":"a = np.random.rand(2) b = np.random.rand(2) c = euclidean(a, b) # Shape: (1,) a = np.random.rand(10, 2) b = np.random.rand(10, 2) c = euclidean(a, b) # Shape: (10,) a = np.random.rand(10, 2) b = np.random.rand(2) c = euclidean(a, b) # Shape: (10,) ","text_count":248,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.random.rand(2)\n    b = np.random.rand(2)\n    c = euclidean(a, b) # Shape: (1,)\n\n    a = np.random.rand(10, 2)\n    b = np.random.rand(10, 2)\n    c = euclidean(a, b) # Shape: (10,)\n\n    a = np.random.rand(10, 2)\n    b = np.random.rand(2)\n    c = euclidean(a, b) # Shape: (10,)"}]}]},{"block_type":"element","block":"k68ocoe6","search_text":"How does the speed of euclidean compare to standard NumPy? In the following code, we benchmark a NumPy vectorized version with our previously defined euclidean function:","text_count":169,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"How does the speed of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"euclidean"}]},{"block_type":"text","content":"compare to standard NumPy? In the following code, we benchmark a NumPy vectorized version with our previously defined"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"euclidean"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k68ocoe7","search_text":"a = np.random.rand(10000, 2) b = np.random.rand(10000, 2) %timeit ((a - b)**2).sum(axis=1) 1000 loops, best of 3: 288 µs per loop %timeit euclidean(a, b) 10000 loops, best of 3: 35.6 µs per loop ","text_count":195,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = np.random.rand(10000, 2)\n    b = np.random.rand(10000, 2)\n\n    %timeit ((a - b)**2).sum(axis=1)\n    1000 loops, best of 3: 288 &micro;s per loop\n\n    %timeit euclidean(a, b)\n    10000 loops, best of 3: 35.6 &micro;s per loop"}]}]},{"block_type":"element","block":"k68ocoe8","search_text":"The Numba version, again, beats the NumPy version by a large margin!","text_count":68,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Numba version, again, beats the NumPy version by a large margin!"}]},{"block_type":"element","block":"k68ocoe9","search_text":"JIT classes","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"JIT classes"}]},{"block_type":"element","block":"k68ocoea","search_text":"As of today, Numba doesn't support optimization of generic Python objects. This limitation, however, doesn't have a huge impact on numerical codes as they usually involve arrays and math operations exclusively.","text_count":210,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As of today, Numba doesn't support optimization of generic Python objects. This limitation, however, doesn't have a huge impact on numerical codes as they usually involve arrays and math operations exclusively."}]},{"block_type":"element","block":"k68ocoeb","search_text":"Nevertheless, certain data structures are much more naturally implemented using objects; therefore, Numba provides support for defining classes that can be used and compiled to fast, native code.","text_count":195,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Nevertheless, certain data structures are much more naturally implemented using objects; therefore, Numba provides support for defining classes that can be used and compiled to fast, native code."}]},{"block_type":"element","block":"k68ocoec","search_text":"Bear in mind that this is one of the newest (almost experimental) features, and it is extremely useful as it allows us to extend Numba to support fast data structures that are not easily implemented with arrays.","text_count":211,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Bear in mind that this is one of the newest (almost experimental) features, and it is extremely useful as it allows us to extend Numba to support fast data structures that are not easily implemented with arrays."}]},{"block_type":"element","block":"k68ocoed","search_text":"As an example, we will show how to implement a simple linked list using JIT classes. A linked list can be implemented by defining a Node class that contains two fields: a value and the next item in the list. As you can see in the following figure, each Node connects to the next and holds a value, and the last node contains a broken link, to which we assign a value of None :","text_count":376,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As an example, we will show how to implement a simple linked list using JIT classes. A linked list can be implemented by defining a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"class that contains two fields: a value and the next item in the list. As you can see in the following figure, each"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"connects to the next and holds a value, and the last node contains a broken link, to which we assign a value of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"None"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocoee","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000015.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocoef","search_text":"In Python, we can define the Node class as follows:","text_count":51,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Python, we can define the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"class as follows:"}]},{"block_type":"element","block":"k68ocoeg","search_text":"class Node: def __init__(self, value): self.next = None self.value = value ","text_count":75,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class Node:\n        def __init__(self, value):\n            self.next = None\n            self.value = value"}]}]},{"block_type":"element","block":"k68ocoeh","search_text":"We can manage the collection of Node instances by creating another class, called LinkedList . This class will keep track of the head of the list (in the preceding figure, this corresponds to the Node with value 3 ). To insert an element in the front of the list, we can simply create a new Node and link it to the current head.","text_count":327,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can manage the collection of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"instances by creating another class, called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LinkedList"}]},{"block_type":"text","content":". This class will keep track of the head of the list (in the preceding figure, this corresponds to the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"with"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"value"}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"3"}]},{"block_type":"text","content":"). To insert an element in the front of the list, we can simply create a new"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"and link it to the current head."}]},{"block_type":"element","block":"k68ocoei","search_text":"In the following code, we develop the initialization function for LinkedList and the LinkedList.push_back method that inserts an element in the front of the list using the strategy outlined earlier:","text_count":198,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following code, we develop the initialization function for"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LinkedList"}]},{"block_type":"text","content":"and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LinkedList.push_back"}]},{"block_type":"text","content":"method that inserts an element in the front of the list using the strategy outlined earlier:"}]},{"block_type":"element","block":"k68ocoej","search_text":"class LinkedList: def __init__(self): self.head = None def push_front(self, value): if self.head == None: self.head = Node(value) else: # We replace the head new_head = Node(value) new_head.next = self.head self.head = new_head ","text_count":228,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class LinkedList:\n    \n        def __init__(self):\n            self.head = None\n    \n        def push_front(self, value):\n            if self.head == None:\n                self.head = Node(value)\n            else:\n                # We replace the head\n                new_head = Node(value)\n                new_head.next = self.head\n                self.head = new_head"}]}]},{"block_type":"element","block":"k68ocoek","search_text":"For debugging purposes, we can also implement the LinkedList.show method that traverses and prints each element in the list. The method is shown in the following snippet:","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For debugging purposes, we can also implement the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LinkedList.show"}]},{"block_type":"text","content":"method that traverses and prints each element in the list. The method is shown in the following snippet:"}]},{"block_type":"element","block":"k68ocoel","search_text":"def show(self): node = self.head while node is not None: print(node.value) node = node.next ","text_count":92,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def show(self):\n            node = self.head\n            while node is not None:\n                print(node.value)\n                node = node.next"}]}]},{"block_type":"element","block":"k68ocoem","search_text":"At this point, we can test our LinkedList and see whether it behaves correctly. We can create an empty list, add a few elements, and print its content. Note that since we are pushing elements at the front of the list, the last elements inserted will be the first to be printed:","text_count":277,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we can test our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LinkedList"}]},{"block_type":"text","content":"and see whether&nbsp;it behaves correctly. We can create an empty list, add a few elements, and print its content. Note that since we are pushing elements at the front of the list, the last elements inserted will be the first to be printed:"}]},{"block_type":"element","block":"k68ocoen","search_text":"lst = LinkedList() lst.push_front(1) lst.push_front(2) lst.push_front(3) lst.show() # Output: # 3 # 2 # 1 ","text_count":106,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"lst = LinkedList()\n    lst.push_front(1)\n    lst.push_front(2)\n    lst.push_front(3)\n    lst.show()\n    # Output:\n    # 3\n    # 2\n    # 1"}]}]},{"block_type":"element","block":"k68ocoeo","search_text":"Finally, we can implement a function, sum_list , that returns the sum of the elements in the linked list. We will use this method to time differences between the Numba and pure Python version:","text_count":192,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we can implement a function,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_list"}]},{"block_type":"text","content":", that returns the sum of the elements in the linked list. We will use this method to time differences between the Numba and pure Python version:"}]},{"block_type":"element","block":"k68ocoep","search_text":"@nb.jit def sum_list(lst): result = 0 node = lst.head while node is not None: result += node.value node = node.next return result ","text_count":130,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@nb.jit\n    def sum_list(lst):\n        result = 0\n        node = lst.head\n        while node is not None:\n            result += node.value\n            node = node.next\n        return result"}]}]},{"block_type":"element","block":"k68ocoeq","search_text":"If we measure the execution time of the original sum_list version and the nb.jit version, we see that there is not much difference. The reason is that Numba cannot infer the type of classes:","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we measure the execution time of the original"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_list"}]},{"block_type":"text","content":"version and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jit"}]},{"block_type":"text","content":"version, we see that there is not much difference. The reason is that Numba cannot infer the type of classes:"}]},{"block_type":"element","block":"k68ocoer","search_text":"lst = LinkedList() [lst.push_front(i) for i in range(10000)] %timeit sum_list.py_func(lst) 1000 loops, best of 3: 2.36 ms per loop %timeit sum_list(lst) 100 loops, best of 3: 1.75 ms per loop ","text_count":192,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"lst = LinkedList()\n    [lst.push_front(i) for i in range(10000)]\n\n    %timeit sum_list.py_func(lst)\n    1000 loops, best of 3: 2.36 ms per loop\n\n    %timeit sum_list(lst)\n    100 loops, best of 3: 1.75 ms per loop"}]}]},{"block_type":"element","block":"k68ocoes","search_text":"We can improve the performance of sum_list by compiling the Node and LinkedList classes using the nb.jitclass decorator.","text_count":120,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can improve the performance of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_list"}]},{"block_type":"text","content":"by compiling the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LinkedList"}]},{"block_type":"text","content":"classes using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jitclass"}]},{"block_type":"text","content":"decorator."}]},{"block_type":"element","block":"k68ocoet","search_text":"The nb.jitclass decorator takes a single argument that contains the attribute types. In the Node class, the attribute types are int64 for value and Node for next . The nb.jitclass decorator will also compile all the methods defined for the class. Before delving into the code, there are two observations that need to be made.","text_count":325,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jitclass"}]},{"block_type":"text","content":"decorator takes a single argument that contains the attribute types. In the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"class, the attribute types are"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"int64"}]},{"block_type":"text","content":"for"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"value"}]},{"block_type":"text","content":"&nbsp;and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"for"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":". The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jitclass"}]},{"block_type":"text","content":"decorator will also compile all the methods defined for the class. Before delving into the code, there are two observations that need to be made."}]},{"block_type":"element","block":"k68ocoeu","search_text":"First, the attribute declaration has to be done before the class is defined, but how do we declare a type we haven't defined yet? Numba provides the nb.deferred_type() function, which can be used for this purpose.","text_count":213,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First, the attribute declaration has to be done before the class is defined, but how do we declare a type we haven't defined yet? Numba provides the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.deferred_type()"}]},{"block_type":"text","content":"function, which can be used for this purpose."}]},{"block_type":"element","block":"k68ocoev","search_text":"Second, the next attribute can be either None or a Node instance. This is what is called an optional type, and Numba provides a utility, called nb.optional , that lets you declare variables that can be (optionally) None .","text_count":221,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Second, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":"attribute can be either"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"None"}]},{"block_type":"text","content":"or a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"instance. This is what is called an optional type, and Numba provides a utility, called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.optional"}]},{"block_type":"text","content":", that lets you declare variables that can be (optionally)"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"None"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocoew","search_text":"This Node class is illustrated in the following code sample. As you can see, node_type is predeclared using nb.deferred_type() . The attributes are declared as a list of pairs containing the attribute name and the type (also note the use of nb.optional ). After the class declaration, we are required to declare the deferred type:","text_count":330,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"class is illustrated in the following code sample. As you can see,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"node_type"}]},{"block_type":"text","content":"is predeclared using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.deferred_type()"}]},{"block_type":"text","content":". The attributes are declared as a list of pairs containing the attribute name and the type (also note the use of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.optional"}]},{"block_type":"text","content":"). After the class declaration, we are required to declare the deferred type:"}]},{"block_type":"element","block":"k68ocoex","search_text":"node_type = nb.deferred_type() node_spec = [ ('next', nb.optional(node_type)), ('value', nb.int64) ] @nb.jitclass(node_spec) class Node: # Body of Node is unchanged node_type.define(Node.class_type.instance_type) ","text_count":213,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node_type = nb.deferred_type()\n\n    node_spec = [\n        ('next', nb.optional(node_type)),\n        ('value', nb.int64)\n    ]\n\n    @nb.jitclass(node_spec)\n    class Node:\n        # Body of Node is unchanged\n\n    node_type.define(Node.class_type.instance_type)"}]}]},{"block_type":"element","block":"k68ocoey","search_text":"The LinkedList class can be easily compiled, as follows. All that's needed is to define the head attribute and to apply the nb.jitclass decorator:","text_count":146,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LinkedList"}]},{"block_type":"text","content":"class can be easily compiled, as follows. All that's needed is to define the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"head"}]},{"block_type":"text","content":"attribute and to apply the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jitclass"}]},{"block_type":"text","content":"decorator:"}]},{"block_type":"element","block":"k68ocoez","search_text":"ll_spec = [ ('head', nb.optional(Node.class_type.instance_type)) ] @nb.jitclass(ll_spec) class LinkedList: # Body of LinkedList is unchanged ","text_count":141,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"ll_spec = [\n        ('head', nb.optional(Node.class_type.instance_type))\n    ]\n\n    @nb.jitclass(ll_spec)\n    class LinkedList:\n        # Body of LinkedList is unchanged"}]}]},{"block_type":"element","block":"k68ocof0","search_text":"We can now measure the execution time of the sum_list function when we pass a JIT LinkedList :","text_count":94,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now measure the execution time of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_list"}]},{"block_type":"text","content":"function when we pass a JIT"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LinkedList"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocof1","search_text":"lst = LinkedList() [lst.push_front(i) for i in range(10000)] %timeit sum_list(lst) 1000 loops, best of 3: 345 µs per loop %timeit sum_list.py_func(lst) 100 loops, best of 3: 3.36 ms per loop ","text_count":191,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"lst = LinkedList()\n    [lst.push_front(i) for i in range(10000)]\n\n    %timeit sum_list(lst)\n    1000 loops, best of 3: 345 &micro;s per loop\n\n    %timeit sum_list.py_func(lst)\n    100 loops, best of 3: 3.36 ms per loop"}]}]},{"block_type":"element","block":"k68ocof2","search_text":"Interestingly, when using a JIT class from a compiled function, we obtain a substantial performance improvement against the pure Python version. However, using the JIT class from the original sum_list.py_func actually results in worse performance. Ensure that you use JIT classes only inside compiled functions!","text_count":311,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Interestingly, when using a JIT class from a compiled function, we obtain a substantial performance improvement against the pure Python version. However, using the JIT class from the original"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum_list.py_func"}]},{"block_type":"text","content":"&nbsp;actually results in worse performance. Ensure that you use JIT classes only inside compiled functions!"}]},{"block_type":"element","block":"k68ocof3","search_text":"Limitations in Numba","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Limitations in Numba"}]},{"block_type":"element","block":"k68ocof4","search_text":"There are some instances where Numba cannot properly infer the variable types and will refuse to compile. In the following example, we define a function that takes a nested list of integers and returns the sum of the element in every sublist. In this case, Numba will raise ValueError and refuse to compile:","text_count":307,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are some instances where Numba cannot properly infer the variable types and will refuse to compile. In the following example, we define a function that takes a nested list of integers and returns the sum of the element in every sublist. In this case, Numba will raise"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ValueError"}]},{"block_type":"text","content":"and refuse to compile:"}]},{"block_type":"element","block":"k68ocof5","search_text":"a = [[0, 1, 2], [3, 4], [5, 6, 7, 8]] @nb.jit def sum_sublists(a): result = [] for sublist in a: result.append(sum(sublist)) return result sum_sublists(a) # ValueError: cannot compute fingerprint of empty list ","text_count":210,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = [[0, 1, 2], \n         [3, 4], \n         [5, 6, 7, 8]]\n\n    @nb.jit\n    def sum_sublists(a):\n        result = []\n        for sublist in a:\n            result.append(sum(sublist))\n        return result\n\n    sum_sublists(a)\n    # ValueError: cannot compute fingerprint of empty list"}]}]},{"block_type":"element","block":"k68ocof6","search_text":"The problem with this code is that Numba is not able to determine the type of the list and fails. A way to fix this problem is to help the compiler determine the right type by initializing the list with a sample element and removing it at the end:","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The problem with this code is that Numba is not able to determine the type of the list and fails. A way to fix this problem is to help the compiler determine the right type by initializing the list with a sample element and removing it at the end:"}]},{"block_type":"element","block":"k68ocof7","search_text":"@nb.jit def sum_sublists(a): result = [0] for sublist in a: result.append(sum(sublist)) return result[1:] ","text_count":106,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@nb.jit\n    def sum_sublists(a):\n        result = [0]\n        for sublist in a:\n            result.append(sum(sublist))\n        return result[1:]"}]}]},{"block_type":"element","block":"k68ocof8","search_text":"Among other features that are not yet implemented in the Numba compiler are function and class definitions, list, set and dict comprehension, generators, the with statement, and try except blocks. Note, however, that many of these features may become supported in the future.","text_count":275,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Among other features that are not yet implemented in the Numba compiler are function and class definitions, list, set and dict comprehension, generators, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"with"}]},{"block_type":"text","content":"statement, and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"try"}]},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"except"}]},{"block_type":"text","content":"blocks. Note, however, that many of these features may become supported in the future."}]},{"block_type":"element","block":"k68ocof9","search_text":"The PyPy project","text_count":16,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"The PyPy project"}]},{"block_type":"element","block":"k68ocofa","search_text":"PyPy is a very ambitious project at improving the performance of the Python interpreter. The way PyPy improves performance is by automatically compiling slow sections of the code at runtime.","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"PyPy is a very ambitious project at improving the performance of the Python interpreter. The way PyPy improves performance is by automatically compiling slow sections of the code at runtime."}]},{"block_type":"element","block":"k68ocofb","search_text":"PyPy is written in a special language called RPython (rather than C) that allows developers to quickly and reliably implement advanced features and improvements. RPython means Restricted Python because it implements a restricted subset of the Python language targeted to the compiler development.","text_count":296,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"PyPy is written in a special language called RPython (rather than C) that allows developers to quickly and reliably implement advanced features and improvements. RPython means"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Restricted Python"}]},{"block_type":"text","content":"because it implements a restricted subset of the Python language targeted to the compiler development."}]},{"block_type":"element","block":"k68ocofc","search_text":"As of today, PyPy version 5.6 supports a lot of Python features and is a possible choice for a large variety of applications.","text_count":125,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As of today, PyPy version 5.6 supports a lot of Python features and is a possible choice for a large variety of applications."}]},{"block_type":"element","block":"k68ocofd","search_text":"PyPy compiles code using a very clever strategy, called tracing JIT compilation . At first, the code is executed normally using interpreter calls. PyPy then starts to profile the code and identifies the most intensive loops. After the identification takes place, the compiler then observes ( traces ) the operations and is able to compile its optimized, interpreter-free version.","text_count":379,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"PyPy compiles code using a very clever strategy, called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"tracing JIT compilation"}]},{"block_type":"text","content":". At first, the code is executed normally using interpreter calls. PyPy then starts to profile the code and identifies the most intensive loops. After the identification takes place, the compiler then observes ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"traces"}]},{"block_type":"text","content":") the operations and is able to compile its optimized, interpreter-free version."}]},{"block_type":"element","block":"k68ocofe","search_text":"Once an optimized version of the code is present, PyPy is able to run the slow loop much faster than the interpreted version.","text_count":125,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once an optimized version of the code is present, PyPy is able to run the slow loop much faster than the interpreted version."}]},{"block_type":"element","block":"k68ocoff","search_text":"This strategy can be contrasted with what Numba does. In Numba, the units of compilation are methods and functions, while the PyPy focus is just slow loops. Overall, the focus of the projects is also very different as Numba has a limited scope for numerical code and requires a lot of instrumentation while PyPy aims at replacing the CPython interpreter.","text_count":354,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This strategy can be contrasted with what Numba does. In Numba, the units of compilation are methods and functions, while the PyPy focus is&nbsp;just slow loops. Overall, the focus of the projects is also very different as Numba has a limited scope for numerical code and requires a lot of instrumentation while PyPy aims at replacing the CPython interpreter."}]},{"block_type":"element","block":"k68ocofg","search_text":"In this section, we will demonstrate and benchmark PyPy on our particle simulator application.","text_count":94,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will demonstrate and benchmark PyPy on our particle simulator application."}]},{"block_type":"element","block":"k68ocofh","search_text":"Setting up PyPy","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Setting up PyPy"}]},{"block_type":"element","block":"k68ocofi","search_text":"PyPy is distributed as a precompiled binary that can be downloaded from http://pypy.org/download.html , and it currently supports Python versions 2.7 (beta support in PyPy 5.6) and 3.3 (alpha support in PyPy 5.5). In this chapter, we will demonstrate the usage of the 2.7 version.","text_count":280,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"PyPy is distributed as a precompiled binary that can be downloaded from"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://pypy.org/download.html"},"children":[{"block_type":"text","content":"http://pypy.org/download.html"}]},{"block_type":"text","content":", and it currently supports Python versions 2.7 (beta support in PyPy 5.6) and 3.3 (alpha support in PyPy 5.5). In this chapter, we will demonstrate the usage of the 2.7 version."}]},{"block_type":"element","block":"k68ocofj","search_text":"Once PyPy is downloaded and unpacked, you can locate the interpreter in the bin/pypy directory relative to the unpacked archive. You can initialize a new virtual environment where we can install additional packages using the following command:","text_count":243,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once PyPy is downloaded and unpacked, you can locate the interpreter in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"bin/pypy"}]},{"block_type":"text","content":"&nbsp;directory relative to the unpacked archive. You can initialize a new virtual environment where we can install additional packages using the following command:"}]},{"block_type":"element","block":"k68ocofk","search_text":"$ /path/to/bin/pypy -m ensurepip $ /path/to/bin/pypy -m pip install virtualenv $ /path/to/bin/virtualenv my-pypy-env ","text_count":117,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ /path/to/bin/pypy -m ensurepip\n$ /path/to/bin/pypy -m pip install virtualenv\n$ /path/to/bin/virtualenv my-pypy-env"}]}]},{"block_type":"element","block":"k68ocofl","search_text":"To activate the environment, we will use the following command:","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To activate the environment, we will use the following command:"}]},{"block_type":"element","block":"k68ocofm","search_text":"$ source my-pypy-env/bin/activate ","text_count":34,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ source my-pypy-env/bin/activate"}]}]},{"block_type":"element","block":"k68ocofn","search_text":"At this point, you can verify that the binary Python is linked to the PyPy executable by typing python -V . At this point, we can go ahead and install some packages we may need. As of version 5.6, PyPy has limited support for software that uses the Python C API (most notably, packages such as numpy and matplotlib ). We can go ahead and install them in the usual way:","text_count":368,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, you can verify that the binary Python is linked to the PyPy executable by typing"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"python -V"}]},{"block_type":"text","content":". At this point, we can go ahead and install some packages we may need. As of version 5.6, PyPy has limited support for software that uses the Python C API (most notably, packages such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib"}]},{"block_type":"text","content":"). We can go ahead and install them in the usual way:"}]},{"block_type":"element","block":"k68ocofo","search_text":"(my-pypy-env) $ pip install numpy matplotlib ","text_count":45,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"(my-pypy-env) $ pip install numpy matplotlib"}]}]},{"block_type":"element","block":"k68ocofp","search_text":"Tip On certain platforms, installation of numpy and matplotlib can be tricky. You can skip the installation step and remove any imports on these two packages from the scripts we will run. ","text_count":188,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On certain platforms, installation of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numpy"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib"}]},{"block_type":"text","content":"can be tricky. You can skip the installation step and remove any imports on these two packages from the scripts we will&nbsp;run."}]}]},{"block_type":"element","block":"k68ocofq","search_text":"Running a particle simulator in PyPy","text_count":36,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Running a particle simulator in PyPy"}]},{"block_type":"element","block":"k68ocofr","search_text":"Now that we have successfully set up the PyPy installation, we can go ahead and run our particle simulator. As a first step, we will time the particle simulator from Chapter 1, Benchmarking and Profiling , on the standard Python interpreter. If the virtual environment is still active, you can issue the command deactivate to exit the environment. We can confirm that the Python interpreter is the standard one by using the python -V command:","text_count":442,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have successfully set up the PyPy installation, we can go ahead and run our particle simulator. As a first step, we will&nbsp;time the particle simulator from Chapter 1,&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Benchmarking and Profiling"}]},{"block_type":"text","content":", on the standard Python interpreter. If the virtual environment is still active, you can issue the command deactivate to exit the environment. We can confirm that the Python interpreter is the standard one by using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"python -V"}]},{"block_type":"text","content":"command:"}]},{"block_type":"element","block":"k68ocofs","search_text":"(my-pypy-env) $ deactivate $ python -V Python 3.5.2 :: Continuum Analytics, Inc. ","text_count":81,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"(my-pypy-env) $ deactivate\n$ python -V\nPython 3.5.2 :: Continuum Analytics, Inc."}]}]},{"block_type":"element","block":"k68ocoft","search_text":"At this point, we can time our code using the timeit command-line interface:","text_count":76,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we can time our code using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"command-line interface:"}]},{"block_type":"element","block":"k68ocofu","search_text":"$ python -m timeit --setup \"from simul import benchmark\" \"benchmark()\" 10 loops, best of 3: 886 msec per loop ","text_count":110,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ python -m timeit --setup \"from simul import benchmark\" \"benchmark()\"\n10 loops, best of 3: 886 msec per loop"}]}]},{"block_type":"element","block":"k68ocofv","search_text":"We can reactivate the environment and run the exact same code from PyPy. On Ubuntu, you may have problems importing the matplotlib.pyplot module. You can try issuing the following export command to fix the issue or removing the matplotlib imports from simul.py :","text_count":262,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can reactivate the environment and run the exact same code from PyPy. On Ubuntu, you may have problems importing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib.pyplot"}]},{"block_type":"text","content":"module. You can try issuing the following"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"export"}]},{"block_type":"text","content":"command to fix the issue or removing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib"}]},{"block_type":"text","content":"imports from"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"simul.py"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocofw","search_text":"$ export MPLBACKEND='agg' ","text_count":26,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ export MPLBACKEND='agg'"}]}]},{"block_type":"element","block":"k68ocofx","search_text":"Now, we can go ahead and time the code using PyPy:","text_count":50,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, we can go ahead and time the code using PyPy:"}]},{"block_type":"element","block":"k68ocofy","search_text":"$ source my-pypy-env/bin/activate Python 2.7.12 (aff251e54385, Nov 09 2016, 18:02:49) [PyPy 5.6.0 with GCC 4.8.2] (my-pypy-env) $ python -m timeit --setup \"from simul import benchmark\" \"benchmark()\" WARNING: timeit is a very unreliable tool. use perf or something else for real measurements 10 loops, average of 7: 106 +- 0.383 msec per loop (using standard deviation) ","text_count":369,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ source my-pypy-env/bin/activate\nPython 2.7.12 (aff251e54385, Nov 09 2016, 18:02:49)\n[PyPy 5.6.0 with GCC 4.8.2]\n\n(my-pypy-env) $ python -m timeit --setup \"from simul import benchmark\" \"benchmark()\"\nWARNING: timeit is a very unreliable tool. use perf or something else for real measurements\n10 loops, average of 7: 106 +- 0.383 msec per loop (using standard deviation)"}]}]},{"block_type":"element","block":"k68ocofz","search_text":"Note that we obtained a large, more than eight times, speedup! PyPy, however, warns us that the timeit module can be unreliable. We can confirm our timings using the perf module, as suggested by PyPy:","text_count":200,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that we obtained a large, more than eight times, speedup! PyPy, however, warns us that the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"module can be unreliable. We can confirm our timings using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"perf"}]},{"block_type":"text","content":"module, as suggested by PyPy:"}]},{"block_type":"element","block":"k68ocog0","search_text":"(my-pypy-env) $ pip install perf (my-pypy-env) $ python -m perf timeit --setup 'from simul import benchmark' 'benchmark()' ....... Median +- std dev: 97.8 ms +- 2.3 ms ","text_count":168,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"(my-pypy-env) $ pip install perf\n(my-pypy-env) $ python -m perf timeit --setup 'from simul import benchmark' 'benchmark()'\n.......\nMedian +- std dev: 97.8 ms +- 2.3 ms"}]}]},{"block_type":"element","block":"k68ocog1","search_text":"Other interesting projects","text_count":26,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Other interesting projects"}]},{"block_type":"element","block":"k68ocog2","search_text":"Over the years, many projects attempted to improve Python performance through several strategies and, sadly, many of them failed. As of today, there are a few projects that survive and hold the promise for a faster Python.","text_count":222,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Over the years, many projects attempted to improve Python performance through several strategies and, sadly, many of them failed. As of today, there are a few projects that survive and hold the promise for a faster Python."}]},{"block_type":"element","block":"k68ocog3","search_text":"Numba and PyPy are mature projects that are steadily improving over the years. Features are continuously being added and they hold great promise for the future of Python.","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numba and PyPy are mature projects that are steadily improving over the years. Features are continuously being added and they hold great promise for the future of Python."}]},{"block_type":"element","block":"k68ocog4","search_text":"Nuitka is a program developed by Kay Hayen that compiles Python code to C. As of right now (version 0.5.x), it provides extreme compatibility with the Python language and produces efficient code that results in moderate performance improvements over CPython.","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Nuitka"}]},{"block_type":"text","content":"is a program developed by Kay Hayen that compiles Python code to C. As of right now (version 0.5.x), it provides extreme compatibility with the Python language and produces efficient code that results in moderate performance improvements over CPython."}]},{"block_type":"element","block":"k68ocog5","search_text":"Nuitka is quite different than Cython in the sense that it focuses on extreme compatibility with the Python language, and it doesn't extend the language with additional constructs.","text_count":180,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Nuitka is quite different than Cython in the sense that it focuses on extreme compatibility with the Python language, and it doesn't extend the language with additional constructs."}]},{"block_type":"element","block":"k68ocog6","search_text":"Pyston is a new interpreter developed by Dropbox that powers JIT compilers. It differs substantially from PyPy as it doesn't employ a tracing JIT, but rather a method-at-a-time JIT (similar to what Numba does). Pyston, like Numba, is also built on top of the LLVM compiler infrastructure.","text_count":288,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pyston"}]},{"block_type":"text","content":"is a new interpreter developed by Dropbox that powers JIT compilers. It differs substantially from PyPy as it doesn't employ a tracing JIT, but rather a method-at-a-time JIT (similar to what Numba does). Pyston, like Numba, is also built on top of the LLVM compiler infrastructure."}]},{"block_type":"element","block":"k68ocog7","search_text":"Pyston is still in early development (alpha stage) and only supports Python 2.7. Benchmarks show that it is faster than CPython but slower than PyPy; that said, it is still an interesting project to follow as new features are added and compatibility is increased.","text_count":263,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Pyston is still in early development (alpha stage) and only supports Python 2.7. Benchmarks show that it is faster than CPython but slower than PyPy; that said, it is still an interesting project to follow as new features are added and compatibility is increased."}]},{"block_type":"element","block":"k68ocog8","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k68ocog9","search_text":"Numba is a tool that compiles fast, specialized versions of Python functions at runtime. In this chapter, we learned how to compile, inspect, and analyze functions compiled by Numba. We also learned how to implement fast NumPy universal functions that are useful in a wide array of numerical applications. Finally, we implemented more complex data structures using the nb.jitclass decorator.","text_count":391,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Numba is a tool that compiles fast, specialized versions of Python functions at runtime. In this chapter, we learned how to compile, inspect, and analyze functions compiled by Numba. We also learned how to implement fast NumPy universal functions that are useful in a wide array of numerical applications. Finally, we implemented more complex data structures using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.jitclass"}]},{"block_type":"text","content":"decorator."}]},{"block_type":"element","block":"k68ocoga","search_text":"Tools such as PyPy allow us to run Python programs unchanged to obtain significant speed improvements. We demonstrated how to set up PyPy, and we assessed the performance improvements on our particle simulator application.","text_count":222,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Tools such as PyPy allow us to run Python programs unchanged to obtain significant speed improvements. We demonstrated how to set up PyPy, and we assessed the performance improvements on our particle simulator application."}]},{"block_type":"element","block":"k68ocogb","search_text":"We also, briefly, described the current ecosystem of the Python compilers and compared them with each other. ","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We also, briefly, described the current ecosystem of the Python compilers and compared them with each other.&nbsp;"}]},{"block_type":"element","block":"k68ocogc","search_text":"In the next chapter, we will learn about concurrency and asynchronous programming. Using these techniques, we will be able to improve the responsiveness and design of applications that spend a lot of time waiting for network and disk resources. ","text_count":245,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter, we will learn about concurrency and asynchronous programming. Using these techniques, we will be able to improve the responsiveness&nbsp;and design&nbsp;of applications that spend a lot of time waiting for network and disk resources.&nbsp;"}]}]},{"title":"Implementing Concurrency","author":"Gabriele Lanaro","block":"k68ocgux","number":6,"contents":[{"block_type":"element","block":"k68ocogd","search_text":"So far, we have explored how to measure and improve the performance of programs by reducing the number of operations performed by the CPU through clever algorithms and more efficient machine code. In this chapter, we will shift our focus to programs where most of the time is spent waiting for resources that are much slower than the CPU, such as persistent storage and network resources.","text_count":388,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So far, we have explored how to measure and improve the performance of programs by reducing the number of operations performed by the CPU through clever algorithms and more efficient machine code. In this chapter, we will shift our focus to programs where most of the time is spent waiting for resources that are much slower than the CPU, such as persistent storage and network resources."}]},{"block_type":"element","block":"k68ocoge","search_text":"Asynchronous programming is a programming paradigm that helps to deal with slow and unpredictable resources (such as users) and is widely used to build responsive services and user interfaces. In this chapter, we will show you how to program asynchronously in Python using techniques such as coroutines and reactive programming.","text_count":328,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Asynchronous programming is a programming paradigm that helps to deal with slow and unpredictable resources (such as users) and is widely used to build responsive services and user interfaces. In this chapter, we will show you how to program asynchronously in Python using techniques such as coroutines and reactive programming."}]},{"block_type":"element","block":"k68ocogf","search_text":"In this chapter, we will cover the following topics:","text_count":52,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will cover the following topics:"}]},{"block_type":"element","block":"k68ocogg","search_text":"The memory hierarchy Callbacks Futures Event loops Writing coroutines with asyncio Converting synchronous code to asynchronous code Reactive programming with RxPy Working with observables Building a memory monitor with RxPY ","text_count":224,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The memory hierarchy"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Callbacks"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Futures"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Event loops"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Writing coroutines with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Converting synchronous code to asynchronous code"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Reactive programming with RxPy"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Working with observables"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Building a memory monitor with RxPY"}]}]},{"block_type":"element","block":"k68ocogh","search_text":"Asynchronous programming","text_count":24,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Asynchronous programming"}]},{"block_type":"element","block":"k68ocogi","search_text":"Asynchronous programming is a way of dealing with slow and unpredictable resources. Rather than waiting idle for resources to become available, asynchronous programs are able to handle multiple resources concurrently and efficiently. Programming in an asynchronous way can be challenging because it is necessary to deal with external requests that can arrive in any order, may take a variable amount of time, or may fail unpredictably. In this section, we will introduce the topic by explaining the main concepts and terminology as well as by giving an idea of how asynchronous programs work.","text_count":592,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Asynchronous programming is a way of dealing with slow and unpredictable resources. Rather than waiting idle for resources to become available, asynchronous programs are able to handle multiple resources concurrently and efficiently. Programming in an asynchronous way can be challenging because it is necessary&nbsp;to deal with external requests that can arrive in any order, may take a variable amount of time, or may fail unpredictably. In this section, we will introduce the topic by explaining the main concepts and terminology as well as by giving an idea of how asynchronous programs work."}]},{"block_type":"element","block":"k68ocogj","search_text":"Waiting for I/O","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Waiting for I/O"}]},{"block_type":"element","block":"k68ocogk","search_text":"A modern computer employs different kinds of memory to store data and perform operations. In general, a computer possesses a combination of expensive memory that is capable of operating at fast speeds and cheaper, and more abundant memory that operates at lower speeds and is used to store a larger amount of data.","text_count":314,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A modern computer employs different kinds of memory to store data and perform operations. In general, a computer possesses a combination of expensive memory that is capable of operating at fast speeds and cheaper, and more abundant memory that operates at lower speeds and is used to store a larger amount of data."}]},{"block_type":"element","block":"k68ocogl","search_text":"The memory hierarchy is shown in the following diagram:","text_count":55,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The memory hierarchy is shown in the following diagram:"}]},{"block_type":"element","block":"k68ocogm","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000027.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocogn","search_text":"At the top of the memory hierarchy are the CPU registers. Those are integrated in the CPU and are used to store and execute machine instructions. Accessing data in a register generally takes one clock cycle. This means that if the CPU operates at 3 GHz, the time it takes to access one element in a CPU register is in the order of 0.3 nanoseconds.","text_count":347,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At the top of the memory hierarchy are the CPU registers. Those are integrated in the CPU and are used to store and execute machine instructions. Accessing data in a register generally takes one clock cycle. This means that if the CPU operates at 3 GHz, the time it takes to access one element in a CPU register is in the order of 0.3 nanoseconds."}]},{"block_type":"element","block":"k68ocogo","search_text":"At the layer just below the registers , you can find the CPU cache, which is comprised of multiple levels and is integrated in the processor. The cache operates at a slightly slower speed than the registers but within the same order of magnitude.","text_count":246,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At the layer just below the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"registers"}]},{"block_type":"text","content":", you can find the CPU cache, which is comprised of multiple levels and is integrated in the processor. The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"cache"}]},{"block_type":"text","content":"operates at a slightly slower speed than the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"registers"}]},{"block_type":"text","content":"but within the same order of magnitude."}]},{"block_type":"element","block":"k68ocogp","search_text":"The next item in the hierarchy is the main memory ( RAM ), which holds much more data but is slower than the cache. Fetching an item from memory can take a few hundred clock cycles.","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next item in the hierarchy is the main memory ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"RAM"}]},{"block_type":"text","content":"), which holds much more data but is slower than the cache. Fetching an item from memory can take a few hundred clock cycles."}]},{"block_type":"element","block":"k68ocogq","search_text":"At the bottom layer, you can find persistent storage, such as a rotating disks (HDD) and Solid State Drives ( SSD ). These devices hold the most data and are orders of magnitude slower than the main memory. An HDD may take a few milliseconds to seek and retrieve an item, while an SSD is substantially faster and takes only a fraction of a millisecond.","text_count":352,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At the bottom layer, you can find persistent storage, such as a rotating disks (HDD) and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Solid State Drives"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"SSD"}]},{"block_type":"text","content":"). These devices hold the most data and are orders of magnitude slower than the main memory. An HDD may take a few milliseconds to seek and retrieve an item, while an SSD is substantially faster and takes only a fraction of a millisecond."}]},{"block_type":"element","block":"k68ocogr","search_text":"To put the relative speed of each memory type into perspective, if you were to have the CPU with a clock speed of about one second, a register access would be equivalent to picking up a pen from the table. A cache access will be equivalent to picking up a book from the shelf. Moving higher in the hierarchy, a RAM access will be equivalent to loading up the laundry (about twenty x slower than the cache). When we move to persistent storage, things are quite a bit different. Retrieving an element from an SSD will be equivalent to doing a four day trip, while retrieving an element from an HDD can take up to six months! The times can stretch even further if we move on to access resources over the network.","text_count":709,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To put the relative speed of each memory type into perspective, if you were to have the CPU with a clock speed of about one&nbsp;second, a register access would be equivalent to picking up a pen from the table. A cache access will be equivalent to picking up a book from the shelf. Moving higher in the hierarchy, a RAM access will&nbsp;be equivalent to&nbsp;loading up the laundry (about twenty x slower than the cache). When we move to persistent storage, things are quite a bit different. Retrieving an element from an SSD will&nbsp;be equivalent to doing a four&nbsp;day trip, while retrieving an element from an HDD can take up to six&nbsp;months! The times can stretch even further if we move on to access resources over the network."}]},{"block_type":"element","block":"k68ocogs","search_text":"From the preceding example, it should be clear that accessing data from storage and other I/O devices is much slower compared to the CPU; therefore, it is very important to handle those resources so that the CPU is never stuck waiting aimlessly. This can be accomplished by carefully designing software capable of managing multiple, ongoing requests at the same time.","text_count":367,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From the preceding&nbsp;example, it should be clear that accessing data from storage and other I/O devices is much slower compared to the CPU; therefore, it is very important to handle those resources so that the CPU is never stuck waiting aimlessly. This can be accomplished by carefully designing software capable of managing multiple, ongoing requests at the same time."}]},{"block_type":"element","block":"k68ocogt","search_text":"Concurrency","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Concurrency"}]},{"block_type":"element","block":"k68ocogu","search_text":"Concurrency is a way to implement a system that is able to deal with multiple requests at the same time. The idea is that we can move on and start handling other resources while we wait for a resource to become available. Concurrency works by splitting a task into smaller subtasks that can be executed out of order so that multiple tasks can be partially advanced without waiting for the previous tasks to finish. ","text_count":415,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Concurrency is a way to implement a&nbsp;system that is able to deal with multiple requests at the same time. The idea is that we can move on and start handling other resources while we wait for a resource to become available. Concurrency works by splitting a task into smaller subtasks that&nbsp;can be executed out of order so that multiple tasks can be partially advanced without waiting for the previous tasks to finish. &nbsp;"}]},{"block_type":"element","block":"k68ocogv","search_text":"As a first example, we will describe how to implement concurrent access to a slow network resource. Let's say we have a web service that takes the square of a number, and the time between our request and the response will be approximately one second. We can implement the network_request function that takes a number and returns a dictionary that contains information about the success of the operation and the result. We can simulate such services using the time.sleep function, as follows:","text_count":491,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a first example, we will describe how to implement concurrent&nbsp;access to a slow network resource. Let's say we have a web service that takes the square of a number, and the time between our request and the response will&nbsp;be approximately one second. &nbsp;We can implement the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request"}]},{"block_type":"text","content":"function that takes a number and returns a dictionary that contains information about the success of the operation and the result.&nbsp;We can simulate such services using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time.sleep"}]},{"block_type":"text","content":"function, as follows:"}]},{"block_type":"element","block":"k68ocogw","search_text":"import time def network_request(number): time.sleep(1.0) return {\"success\": True, \"result\": number ** 2} ","text_count":105,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import time\n\n    def network_request(number):\n        time.sleep(1.0)\n        return {\"success\": True, \"result\": number ** 2}"}]}]},{"block_type":"element","block":"k68ocogx","search_text":"We will also write some additional code that performs the request, verifies that the request was successful, and prints the result. In the following code, we define the fetch_square function and use it to calculate the square of the number two using a call to network_request :","text_count":277,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will also write some additional&nbsp;code that performs the request, verifies that the request was successful, and prints the result. In the following code, we define the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fetch_square"}]},{"block_type":"text","content":"function and use it to calculate the square of the number two&nbsp;using a call to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocogy","search_text":"def fetch_square(number): response = network_request(number) if response[\"success\"]: print(\"Result is: {}\".format(response[\"result\"])) fetch_square(2) # Output: # Result is: 4 ","text_count":176,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def fetch_square(number):\n        response = network_request(number)\n        if response[\"success\"]:\n            print(\"Result is: {}\".format(response[\"result\"]))\n\n    fetch_square(2)\n    # Output:\n    # Result is: 4"}]}]},{"block_type":"element","block":"k68ocogz","search_text":"Fetching a number from the network will take one second because of the slow network. What if we want to calculate the square of multiple numbers? We can call fetch_square , which will start a network request as soon as the previous one is done:","text_count":244,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Fetching a number from the network will&nbsp;take one second because of the slow network. What if we want to calculate the square of multiple numbers? We can call"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fetch_square"}]},{"block_type":"text","content":", which will start a network request as soon as the previous one is done:"}]},{"block_type":"element","block":"k68ocoh0","search_text":"fetch_square(2) fetch_square(3) fetch_square(4) # Output: # Result is: 4 # Result is: 9 # Result is: 16 ","text_count":104,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fetch_square(2)\n    fetch_square(3)\n    fetch_square(4)\n    # Output:\n    # Result is: 4\n    # Result is: 9\n    # Result is: 16"}]}]},{"block_type":"element","block":"k68ocoh1","search_text":"The previous code will take three seconds to run, but it's not the best we can do. Waiting for the previous result to finish is unnecessary as we can technically submit multiple requests at and wait for them parallely.","text_count":218,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The previous code will take three seconds to run, but it's not the best we can do. Waiting for the previous result to finish is unnecessary as we can technically submit multiple requests at and wait for them parallely."}]},{"block_type":"element","block":"k68ocoh2","search_text":"In the following diagram, the three tasks are represented as boxes. The time spent by the CPU processing and submitting the request is in orange while the waiting times are in blue. You can see how most of the time is spent waiting for the resources while our machine sits idle without doing anything else:","text_count":306,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following diagram, the three tasks are represented as boxes.&nbsp;The&nbsp;time spent by the CPU processing and submitting the request is in orange while the&nbsp;waiting times are in blue. You can see how most of the time is spent waiting for the resources while our machine sits idle without doing anything else:"}]},{"block_type":"element","block":"k68ocoh3","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000003.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocoh4","search_text":"Ideally, we would like to start other new task while we are waiting for the already submitted tasks to finish. In the following figure, you can see that as soon as we submit our request in fetch_square(2) , we can start preparing for fetch_square(3) and so on. This allows us to reduce the CPU waiting time and to start processing the results as soon as they become available:","text_count":376,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Ideally, we would like to start other new task while we are waiting for the already submitted tasks to finish. In the following figure,&nbsp;you can see that as soon as we submit our request in"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"fetch_square(2)"}]},{"block_type":"text","content":", we can&nbsp;start preparing&nbsp;for"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"fetch_square(3)"}]},{"block_type":"text","content":"and so on. This allows us to reduce the CPU waiting time and to start processing the results as soon as they become available:"}]},{"block_type":"element","block":"k68ocoh5","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000016.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocoh6","search_text":"This strategy is made possible by the fact that the three requests are completely independent, and we don't need to wait for the completion of a previous task to start the next one. Also, note how a single CPU can comfortably handle this scenario. While distributing the work on multiple CPUs can further speedup the execution, if the waiting time is large compared to the processing times, the speedup will be minimal.","text_count":419,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This strategy is made possible by the fact that the three requests are completely independent, and we don't need to wait for the completion of a previous&nbsp;task to start the next one. Also, note how a single CPU can comfortably handle this scenario. While distributing the work on multiple CPUs can further speedup the execution, if the waiting time is large compared to the processing times, the speedup will be minimal."}]},{"block_type":"element","block":"k68ocoh7","search_text":"To implement concurrency, it is necessary to think and code differently; in the following sections, we'll demonstrate techniques and best practices to implement robust concurrent applications.","text_count":192,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To implement concurrency, it is necessary to think and code differently; in the following sections, we'll demonstrate techniques and best practices to implement robust concurrent applications."}]},{"block_type":"element","block":"k68ocoh8","search_text":"Callbacks","text_count":9,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Callbacks"}]},{"block_type":"element","block":"k68ocoh9","search_text":"The code we have seen so far blocks the execution of the program until the resource is available. The call responsible for the waiting is time.sleep . To make the code start working on other tasks, we need to find a way to avoid blocking the program flow so that the rest of the program can go on with the other tasks.","text_count":318,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code we have seen so far blocks the execution of the program until the resource is available. The call responsible for the waiting is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time.sleep"}]},{"block_type":"text","content":". To make the code start working on other tasks, we need to find a way to avoid blocking the program flow so that the rest of the program can go on with the other tasks."}]},{"block_type":"element","block":"k68ocoha","search_text":"One of the simplest ways to accomplish this behavior is through callbacks. The strategy is quite similar to what we do when we request a cab.","text_count":141,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the simplest ways to accomplish this behavior is through callbacks. The strategy is quite similar to what we do when we request a cab."}]},{"block_type":"element","block":"k68ocohb","search_text":"Imagine that you are at a restaurant and you've had a few drinks. It's raining outside, and you'd rather not take the bus; therefore, you request a taxi and ask them to call when they're outside so that you can come out, and you don't have to wait in the rain.","text_count":260,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Imagine that you are at a restaurant and you've had a few drinks. It's raining outside, and you'd rather not take the bus; therefore, you request a taxi and ask them to call when they're outside so that you can come out, and you don't have to wait in the rain."}]},{"block_type":"element","block":"k68ocohc","search_text":"What you did in this case is request a taxi (that is, the slow resource) but instead of waiting outside until the taxi arrives, you provide your number and instructions (callback) so that you can come outside when they're ready and go home.","text_count":240,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What you did in this case is request a taxi (that is, the slow resource) but instead of waiting outside until the taxi arrives, you provide your number and instructions (callback) so that you can come outside when they're ready and go home."}]},{"block_type":"element","block":"k68ocohd","search_text":"We will now show how this mechanism can work in code. We will compare the blocking code of time.sleep with the equivalent non-blocking code of threading.Timer .","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will now show how this mechanism can work in code.&nbsp;We will compare the blocking code of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time.sleep"}]},{"block_type":"text","content":"with the equivalent non-blocking code of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"threading.Timer"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocohe","search_text":"For this example, we will write a function, wait_and_print , that will block the program execution for one second and then print a message:","text_count":139,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For this example, we will write a function,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"wait_and_print"}]},{"block_type":"text","content":", that will block the program execution for one second and then print a message:"}]},{"block_type":"element","block":"k68ocohf","search_text":"def wait_and_print(msg): time.sleep(1.0) print(msg) ","text_count":52,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def wait_and_print(msg):\n        time.sleep(1.0)\n        print(msg)"}]}]},{"block_type":"element","block":"k68ocohg","search_text":"If we want to write the same function in a non-blocking way, we can use the threading.Timer class. We can initialize a threading.Timer instance by passing the amount of time we want to wait and a callback. A callback is simply a function that will be called when the timer expires. Note that we have to also call the Timer.start method to activate the timer:","text_count":358,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we want to write the same function in a non-blocking way, we can&nbsp;use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"threading.Timer"}]},{"block_type":"text","content":"class. We can initialize a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"threading.Timer"}]},{"block_type":"text","content":"&nbsp;instance by passing the amount of time we want to wait and a callback. A"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"is simply a function that will be called when the timer expires. Note that we have to also call the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Timer.start"}]},{"block_type":"text","content":"method to activate the timer:"}]},{"block_type":"element","block":"k68ocohh","search_text":"import threading def wait_and_print_async(msg): def callback(): print(msg) timer = threading.Timer(1.0, callback) timer.start() ","text_count":128,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import threading\n\n    def wait_and_print_async(msg):\n        def callback():\n            print(msg)\n\n        timer = threading.Timer(1.0, callback)\n        timer.start()"}]}]},{"block_type":"element","block":"k68ocohi","search_text":"An important feature of the wait_and_print_async function is that none of the statements are blocking the execution flow of the program.","text_count":136,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An important feature&nbsp;of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"wait_and_print_async"}]},{"block_type":"text","content":"function is that none of the statements are blocking the execution flow of the program."}]},{"block_type":"element","block":"k68ocohj","search_text":"Tip How is threading.Timer capable of waiting without blocking? The strategy used by threading.Timer involves starting a new thread that is able to execute code in parallel. If this is confusing, don't worry, we will explore threading and parallel programming in detail in the following chapters. ","text_count":297,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"How is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"threading.Timer"}]},{"block_type":"text","content":"capable of waiting without blocking?"},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"text","content":"The strategy used by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"threading.Timer"}]},{"block_type":"text","content":"involves starting a new thread that&nbsp;is able to execute code in parallel. If this is confusing, don't worry, we will explore threading and parallel programming in detail in the following chapters."}]}]},{"block_type":"element","block":"k68ocohk","search_text":"This technique of registering callbacks for execution in response to certain events is commonly called the Hollywood principle . This is because, after an audition for a role at Hollywood, you may be told \" Don't call us, we'll call you \", meaning that they won't tell you if they chose you for the role immediately, but they'll call you in case they do.","text_count":354,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This technique of registering callbacks for execution in response to certain events is commonly called the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Hollywood principle"}]},{"block_type":"text","content":". This is because, after an audition for a role at Hollywood, you may be told \""},{"block_type":"element","tag_name":"q","attributes":{},"children":[{"block_type":"text","content":"Don't call us, we'll call you"}]},{"block_type":"text","content":"\", meaning that they won't tell you if they chose you for the role immediately, but they'll call you in case they do."}]},{"block_type":"element","block":"k68ocohl","search_text":"To highlight the difference between the blocking and non-blocking version of wait_and_print , we can test and compare the execution of the two versions. In the output comments, the waiting periods are indicated by <wait...> :","text_count":225,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To highlight the&nbsp;difference between the blocking and non-blocking version of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"wait_and_print"}]},{"block_type":"text","content":", we can test and compare the execution of the two versions. In the output comments, the waiting periods are indicated by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"&lt;wait...&gt;"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocohm","search_text":"# Syncronous wait_and_print(\"First call\") wait_and_print(\"Second call\") print(\"After call\") # Output: # <wait...> # First call # <wait...> # Second call # After call # Async wait_and_print_async(\"First call async\") wait_and_print_async(\"Second call async\") print(\"After submission\") # Output: # After submission # <wait...> # First call # Second call ","text_count":351,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# Syncronous\n    wait_and_print(\"First call\")\n    wait_and_print(\"Second call\")\n    print(\"After call\")\n    # Output:\n    # &lt;wait...&gt;\n    # First call  \n    # &lt;wait...&gt;\n    # Second call\n    # After call\n    # Async\n    wait_and_print_async(\"First call async\")\n    wait_and_print_async(\"Second call async\")\n    print(\"After submission\")\n    # Output:\n    # After submission \n    # &lt;wait...&gt;\n    # First call\n    # Second call"}]}]},{"block_type":"element","block":"k68ocohn","search_text":"The synchronous version behaves in a very familiar way. The code waits for a second, prints First call , waits for another second, and then prints the Second call and After call messages.","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The synchronous version behaves in a very familiar way. The code waits for a second, prints"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"First call"}]},{"block_type":"text","content":", waits for another second, and then prints the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Second call"}]},{"block_type":"text","content":"&nbsp;and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"After call"}]},{"block_type":"text","content":"&nbsp;messages."}]},{"block_type":"element","block":"k68ocoho","search_text":"In the asynchronous version, wait_and_print_async submits ( rather than execute ) those calls and moves on immediately . You can see this mechanism in action by acknowledging that the \"After submission\" message is printed immediately.","text_count":234,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the asynchronous version,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"wait_and_print_async"}]},{"block_type":"text","content":"&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"submits&nbsp; ("}]},{"block_type":"text","content":"rather than"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"execute"}]},{"block_type":"text","content":")"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"&nbsp;"}]},{"block_type":"text","content":"those calls and moves on"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"immediately"}]},{"block_type":"text","content":". You can see this mechanism in action&nbsp;by acknowledging that the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"\"After submission\""}]},{"block_type":"text","content":"message is printed immediately."}]},{"block_type":"element","block":"k68ocohp","search_text":"With this in mind, we can explore a slightly more complex situation by rewriting our network_request function using callbacks. In the following code, we define the network_request_async function. The biggest difference between network_request_async and its blocking counterpart is that network_request_async doesn't return anything . This is because we are merely submitting the request when network_request_async is called, but the value is available only when the request is completed.","text_count":487,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this in mind, we can explore a slightly more complex situation by rewriting our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request"}]},{"block_type":"text","content":"function using callbacks. In the following code, we define the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request_async"}]},{"block_type":"text","content":"&nbsp;function. The biggest difference between"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request_async"}]},{"block_type":"text","content":"&nbsp;and its blocking counterpart is that"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request_async"}]},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"doesn't return anything"}]},{"block_type":"text","content":". This is because we are merely submitting the request when"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request_async"}]},{"block_type":"text","content":"is called, but the value is available only when the request is completed."}]},{"block_type":"element","block":"k68ocohq","search_text":"If we can't return anything, how do we pass the result of the request? Rather than returning the value, we will pass the result as an argument to the on_done callback.","text_count":167,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we can't return anything, how do we pass the result of the request? Rather than returning the value, we will pass the result as an argument to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"on_done"}]},{"block_type":"text","content":"callback."}]},{"block_type":"element","block":"k68ocohr","search_text":"The rest of the function consists of submitting a callback (called timer_done ) to the timer.Timer class that will call on_done when it's ready:","text_count":144,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The rest of the function consists of submitting a callback (called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timer_done"}]},{"block_type":"text","content":") to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timer.Timer"}]},{"block_type":"text","content":"class that will call"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"on_done"}]},{"block_type":"text","content":"when it's ready:"}]},{"block_type":"element","block":"k68ocohs","search_text":"def network_request_async(number, on_done): def timer_done(): on_done({\"success\": True, \"result\": number ** 2}) timer = threading.Timer(1.0, timer_done) timer.start() ","text_count":167,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def network_request_async(number, on_done):\n\n        def timer_done():\n            on_done({\"success\": True, \n                     \"result\": number ** 2})\n\n        timer = threading.Timer(1.0, timer_done)\n        timer.start()"}]}]},{"block_type":"element","block":"k68ocoht","search_text":"The usage of network_request_async is quite similar to timer.Timer ; all we have to do is pass the number we want to square and a callback that will receive the result when it's ready . This is demonstrated in the following snippet:","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The usage of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request_async"}]},{"block_type":"text","content":"is quite similar to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timer.Timer"}]},{"block_type":"text","content":"; all we have to do is pass the number we want to square and a callback that will receive the result"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"when it's ready"}]},{"block_type":"text","content":". This is demonstrated in the following snippet:"}]},{"block_type":"element","block":"k68ocohu","search_text":"def on_done(result): print(result) network_request_async(2, on_done) ","text_count":69,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def on_done(result):\n        print(result)\n\n    network_request_async(2, on_done)"}]}]},{"block_type":"element","block":"k68ocohv","search_text":"Now, if we submit multiple network requests, we note that the calls get executed concurrently and do not block the code:","text_count":120,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, if we submit&nbsp;multiple network requests, we note that the calls get executed concurrently and do not block the code:"}]},{"block_type":"element","block":"k68ocohw","search_text":"network_request_async(2, on_done) network_request_async(3, on_done) network_request_async(4, on_done) print(\"After submission\") ","text_count":128,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"network_request_async(2, on_done)\n    network_request_async(3, on_done)\n    network_request_async(4, on_done)\n    print(\"After submission\")"}]}]},{"block_type":"element","block":"k68ocohx","search_text":"In order to use network_request_async in fetch_square , we need to adapt the code to use asynchronous constructs. In the following code, we modify fetch_square by defining and passing the on_done callback to network_request_async :","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In order to use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request_async"}]},{"block_type":"text","content":"in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fetch_square"}]},{"block_type":"text","content":", we need to adapt the code to use asynchronous constructs. In the following code, we modify"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fetch_square"}]},{"block_type":"text","content":"by defining and passing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"on_done"}]},{"block_type":"text","content":"callback to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request_async"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocohy","search_text":"def fetch_square(number): def on_done(response): if response[\"success\"]: print(\"Result is: {}\".format(response[\"result\"])) network_request_async(number, on_done) ","text_count":162,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def fetch_square(number):\n        def on_done(response):\n            if response[\"success\"]:\n                print(\"Result is: {}\".format(response[\"result\"]))\n\n        network_request_async(number, on_done)"}]}]},{"block_type":"element","block":"k68ocohz","search_text":"You may have noted that the asynchronous code is significantly more convoluted than its synchronous counterpart. This is due to the fact that we are required to write and pass a callback every time we need to retrieve a certain result, causing the code to become nested and hard to follow.","text_count":289,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You may have noted that the asynchronous code is significantly more convoluted than its synchronous&nbsp;counterpart. This is due to the fact that we are required to write and pass a callback every time we need to retrieve a certain result, causing the code to become nested and hard to follow."}]},{"block_type":"element","block":"k68ocoi0","search_text":"Futures","text_count":7,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Futures"}]},{"block_type":"element","block":"k68ocoi1","search_text":"Futures are a more convenient pattern that can be used to keep track of the results of asynchronous calls. In the preceding code, we saw that rather than returning values, we accept callbacks and pass the results when they are ready. It is interesting to note that, so far, there is no easy way to track the status of the resource.","text_count":331,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Futures are a more convenient pattern that can be used to keep track of the results of asynchronous calls. In the preceding code, we saw that rather than returning values, we accept callbacks and pass the results when they are ready. It is interesting to note that, so far, there is no easy way to track the status of the resource."}]},{"block_type":"element","block":"k68ocoi2","search_text":"A future is an abstraction that helps us keep track of the requested resources and that we are waiting to become available. In Python, you can find a future implementation in the concurrent.futures.Future class. A Future instance can be created by calling its constructor with no arguments:","text_count":290,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"future"}]},{"block_type":"text","content":"is an abstraction that helps us keep track of the requested resources and that we are waiting to become available. In Python, you can find a future implementation in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concurrent.futures.Future"}]},{"block_type":"text","content":"class. A"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":"instance can be&nbsp;created by calling its constructor with no arguments:"}]},{"block_type":"element","block":"k68ocoi3","search_text":"fut = Future() # Result: # <Future at 0x7f03e41599e8 state=pending> ","text_count":68,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fut = Future()\n    # Result:\n    # &lt;Future at 0x7f03e41599e8 state=pending&gt;"}]}]},{"block_type":"element","block":"k68ocoi4","search_text":"A future represents a value that is not yet available. You can see that its string representation reports the current status of the result which, in our case, is still pending. In order to make a result available, we can use the Future.set_result method:","text_count":254,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A future represents a value that is not yet available. You can see that its string&nbsp;representation reports the current status of the result which, in our case, is still pending. In order to make a result available, we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future.set_result"}]},{"block_type":"text","content":"&nbsp;method:"}]},{"block_type":"element","block":"k68ocoi5","search_text":"fut.set_result(\"Hello\") # Result: # <Future at 0x7f03e41599e8 state=finished returned str> fut.result() # Result: # \"Hello\" ","text_count":124,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fut.set_result(\"Hello\")\n    # Result:\n    # &lt;Future at 0x7f03e41599e8 state=finished returned str&gt;\n\n    fut.result()\n    # Result:\n    # \"Hello\""}]}]},{"block_type":"element","block":"k68ocoi6","search_text":"You can see that once we set the result, the Future will report that the task is finished and can be accessed using the Future.result method. It is also possible to subscribe a callback to a future so that, as soon as the result is available, the callback is executed. To attach a callback, it is sufficient to pass a function to the Future.add_done_callback method. When the task completes, the function will be called with the Future instance as its first argument and the result can be retrieved using the Future.result() method:","text_count":532,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can see that once we set the result, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":"will report that the task is finished and can be accessed using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future.result"}]},{"block_type":"text","content":"&nbsp;method. It is also possible to subscribe a callback to a future so that, as soon as the result is available, the callback is executed. To attach a callback, it is sufficient to pass a function to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future.add_done_callback"}]},{"block_type":"text","content":"&nbsp;method. When the task completes, the function&nbsp;will be called with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":"instance as its first argument and the result can be retrieved using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future.result()"}]},{"block_type":"text","content":"&nbsp;method:"}]},{"block_type":"element","block":"k68ocoi7","search_text":"fut = Future() fut.add_done_callback(lambda future: print(future.result(), flush=True)) fut.set_result(\"Hello\") # Output: # Hello ","text_count":130,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fut = Future()\n    fut.add_done_callback(lambda future: print(future.result(), flush=True))\n    fut.set_result(\"Hello\")\n    # Output:\n    # Hello"}]}]},{"block_type":"element","block":"k68ocoi8","search_text":"To get a grasp on how futures can be used in practice, we will adapt the network_request_async function to use futures. The idea is that, this time, instead of returning nothing, we return a Future that will keep track of the result for us. Note two things:","text_count":257,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To get a grasp on how futures can be used in practice, we will adapt the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request_async"}]},{"block_type":"text","content":"function to use futures. The idea is that, this time, instead of returning nothing, we return a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":"that will keep track of the result for us. Note two things:"}]},{"block_type":"element","block":"k68ocoi9","search_text":"We don't need to accept an on_done callback as callbacks can be connected later using the Future.add_done_callback method. Also, we pass the generic Future.set_result method as the callback for threading.Timer . This time we are able to return a value, thus making the code a bit more similar to the blocking version we saw in the preceding section: ","text_count":350,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We don't need to accept an&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"on_done callback"}]},{"block_type":"text","content":"&nbsp;as callbacks can be connected later using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future.add_done_callback"}]},{"block_type":"text","content":"method. Also, we pass the generic"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future.set_result"}]},{"block_type":"text","content":"method as the callback for&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"threading.Timer"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"This time we are able to return a value, thus making the code a bit more similar to the blocking version we saw in the preceding&nbsp;section:"}]}]},{"block_type":"element","block":"k68ocoia","search_text":"from concurrent.futures import Future def network_request_async(number): future = Future() result = {\"success\": True, \"result\": number ** 2} timer = threading.Timer(1.0, lambda: future.set_result(result)) timer.start() return future fut = network_request_async(2) ","text_count":264,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from concurrent.futures import Future\n\n    def network_request_async(number):\n        future = Future()\n        result = {\"success\": True, \"result\": number ** 2}\n        timer = threading.Timer(1.0, lambda: future.set_result(result))\n        timer.start()\n        return future\n\n    fut = network_request_async(2)"}]}]},{"block_type":"element","block":"k68ocoib","search_text":"Note Even though we instantiate and manage futures directly in these examples; in practical applications, the futures are handled by frameworks. ","text_count":145,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even though we instantiate and manage&nbsp;futures directly in these examples; in practical applications, the futures are handled by frameworks.&nbsp;"}]}]},{"block_type":"element","block":"k68ocoic","search_text":"If you execute the preceding code, nothing will happen as the code only consists of preparing and returning a Future instance. To enable further operation of the future results, we need to use the Future.add_done_callback method. In the following code, we adapt the fetch_square function to use futures:","text_count":303,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you execute the preceding&nbsp;code, nothing will happen as the code only consists of&nbsp;preparing and returning a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":"instance. To enable further operation of the future results, we need to use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future.add_done_callback"}]},{"block_type":"text","content":"&nbsp;method. In the following code, we adapt the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fetch_square"}]},{"block_type":"text","content":"function to use futures:"}]},{"block_type":"element","block":"k68ocoid","search_text":"def fetch_square(number): fut = network_request_async(number) def on_done_future(future): response = future.result() if response[\"success\"]: print(\"Result is: {}\".format(response[\"result\"])) fut.add_done_callback(on_done_future) ","text_count":229,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def fetch_square(number):\n        fut = network_request_async(number)\n\n        def on_done_future(future):\n            response = future.result()\n            if response[\"success\"]:\n                print(\"Result is: {}\".format(response[\"result\"]))\n        \n        fut.add_done_callback(on_done_future)"}]}]},{"block_type":"element","block":"k68ocoie","search_text":"The code still looks quite similar to the callback version. Futures are a different and slightly more convenient way of working with callbacks. Futures are also advantageous, because they can keep track of the resource status, cancel (unschedule) scheduled tasks, and handle exceptions more naturally.","text_count":301,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code still looks quite similar to the callback version. Futures are a different and slightly more convenient way of working with callbacks. Futures are also advantageous, because they can&nbsp;keep track of the&nbsp;resource status, cancel (unschedule) scheduled tasks, and&nbsp;handle exceptions more naturally."}]},{"block_type":"element","block":"k68ocoif","search_text":"Event loops","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Event loops"}]},{"block_type":"element","block":"k68ocoig","search_text":"So far, we have implemented parallelism using OS threads. However, in many asynchronous frameworks, the coordination of concurrent tasks is managed by an event loop .","text_count":166,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So far, we have implemented parallelism&nbsp;using OS&nbsp;threads. However, in many asynchronous frameworks, the coordination of concurrent tasks is managed by an"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"event loop"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocoih","search_text":"The idea behind an event loop is to continuously monitor the status of the various resources (for example, network connections and database queries) and trigger the execution of callbacks when events take place (for example, when a resource is ready or when a timer expires).","text_count":275,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The idea behind an event loop is to continuously monitor the status of the various resources (for example,&nbsp;network connections and database queries) and trigger the execution of callbacks when events take place (for example, when a resource is ready or when a timer expires)."}]},{"block_type":"element","block":"k68ocoii","search_text":"Note Why not just stick to threading? Events loops are sometimes preferred as every unit of execution never runs at the same time as another and this can simplify dealing with shared variables, data structures, and resources. Read the next chapter for more details about parallel execution and its shortcomings. ","text_count":312,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Why not just stick to&nbsp;threading?"},{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"text","content":"Events loops are sometimes preferred as every unit of execution never runs at the same time as another and this can simplify dealing with shared variables, data structures,&nbsp;and resources.&nbsp;Read the next chapter for more details about parallel execution and its shortcomings."}]}]},{"block_type":"element","block":"k68ocoij","search_text":"As a first example, we will implement a thread-free version of threading.Timer . We can define a Timer class that will take a timeout and implement the Timer.done method that returns True if the timer has expired:","text_count":213,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a first example, we will implement a thread-free version of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"threading.Timer"}]},{"block_type":"text","content":". We can define a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Timer"}]},{"block_type":"text","content":"class that will take a timeout and implement the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Timer.done"}]},{"block_type":"text","content":"&nbsp;method that&nbsp;returns&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"True"}]},{"block_type":"text","content":"if the timer has expired:"}]},{"block_type":"element","block":"k68ocoik","search_text":"class Timer: def __init__(self, timeout): self.timeout = timeout self.start = time.time() def done(self): return time.time() - self.start > self.timeout ","text_count":153,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class Timer:\n    \n        def __init__(self, timeout):\n            self.timeout = timeout\n            self.start = time.time()\n    \n        def done(self):\n            return time.time() - self.start &gt; self.timeout"}]}]},{"block_type":"element","block":"k68ocoil","search_text":"To determine whether the timer has expired, we can write a loop that continuously checks the timer status by calling the Timer.done method. When the timer expires, we can print a message and exit the cycle:","text_count":206,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To determine whether&nbsp;the timer has expired, we can write a loop that continuously checks the timer status by calling the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Timer.done"}]},{"block_type":"text","content":"method. When the timer expires, we can print a message and exit&nbsp;the cycle:"}]},{"block_type":"element","block":"k68ocoim","search_text":"timer = Timer(1.0) while True: if timer.done(): print(\"Timer is done!\") break ","text_count":78,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"timer = Timer(1.0)\n\n    while True:\n        if timer.done():\n            print(\"Timer is done!\")\n            break"}]}]},{"block_type":"element","block":"k68ocoin","search_text":"By implementing the timer in this way, the flow of execution is never blocked and we can, in principle, do other work inside the while loop.","text_count":140,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By implementing the timer in this way, the flow of execution is never blocked and we can, in principle, do other work inside the while loop."}]},{"block_type":"element","block":"k68ocoio","search_text":"Note Waiting for events to happen by continuously polling using a loop is commonly termed as busy-waiting . ","text_count":108,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Waiting for events to happen by continuously polling using a loop is commonly termed as&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"busy-waiting"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68ocoip","search_text":"Ideally, we would like to attach a custom function that executes when the timer goes off, just like we did in threading.Timer . To do this, we can implement a method, Timer.on_timer_done , that will accept a callback to be executed when the timer goes off:","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Ideally, we would like to attach a custom function that executes when the timer goes off, just like we did in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"threading.Timer"}]},{"block_type":"text","content":". To do this, we can implement a method,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Timer.on_timer_done"}]},{"block_type":"text","content":", that will accept a callback to&nbsp;be executed when the timer goes off:"}]},{"block_type":"element","block":"k68ocoiq","search_text":"class Timer: # ... previous code def on_timer_done(self, callback): self.callback = callback ","text_count":93,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class Timer:\n       # ... previous code \n       def on_timer_done(self, callback):\n            self.callback = callback"}]}]},{"block_type":"element","block":"k68ocoir","search_text":"Note that on_timer_done merely stores a reference to the callback. The entity that monitors the event and executes the callback is the loop. This concept is demonstrated as follows. Rather than using the print function, the loop will call timer.callback when appropriate:","text_count":271,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"on_timer_done"}]},{"block_type":"text","content":"merely stores&nbsp;a reference to the callback. The entity that monitors the event and executes the callback is the loop. This concept is demonstrated as follows. Rather than using the print function, the loop will call"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timer.callback"}]},{"block_type":"text","content":"when appropriate:"}]},{"block_type":"element","block":"k68ocois","search_text":"timer = Timer(1.0) timer.on_timer_done(lambda: print(\"Timer is done!\")) while True: if timer.done(): timer.callback() break ","text_count":124,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"timer = Timer(1.0)\n    timer.on_timer_done(lambda: print(\"Timer is done!\"))\n\n    while True:\n        if timer.done():\n            timer.callback()\n            break"}]}]},{"block_type":"element","block":"k68ocoit","search_text":"As you can see, an asynchronous framework is starting to take place. All we did outside the loop was define the timer and the callback, while the loop took care of monitoring the timer and executing the associated callback. We can further extend our code by implementing support for multiple timers.","text_count":299,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, an asynchronous framework is starting to take place. All we did outside the loop was define the timer and the callback, while the loop took care of monitoring the timer and executing the associated callback. We can further extend our code by implementing support for multiple timers."}]},{"block_type":"element","block":"k68ocoiu","search_text":"A natural way to implement multiple timers is to add a few Timer instances to a list and modify our event loop to periodically check all the timers and dispatch the callbacks when required. In the following code, we define two timers and attach a callback to each of them. Those timers are added to a list, timers , that is continuously monitored by our event loop. As soon as a timer is done, we execute the callback and remove the event from the list:","text_count":453,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A natural way to implement multiple timers is to add a few"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Timer"}]},{"block_type":"text","content":"instances to a list and modify our event loop to periodically check all the timers and dispatch the callbacks when required. In the following code, we define two timers and attach a callback to each of them. Those timers are added to a list,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timers"}]},{"block_type":"text","content":", that is continuously monitored by our event loop. As soon as a timer is done, we execute the callback and remove the event from the list:"}]},{"block_type":"element","block":"k68ocoiv","search_text":"timers = [] timer1 = Timer(1.0) timer1.on_timer_done(lambda: print(\"First timer is done!\")) timer2 = Timer(2.0) timer2.on_timer_done(lambda: print(\"Second timer is done!\")) timers.append(timer1) timers.append(timer2) while True: for timer in timers: if timer.done(): timer.callback() timers.remove(timer) # If no more timers are left, we exit the loop if len(timers) == 0: break ","text_count":379,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"timers = []\n\n    timer1 = Timer(1.0)\n    timer1.on_timer_done(lambda: print(\"First timer is done!\"))\n\n    timer2 = Timer(2.0)\n    timer2.on_timer_done(lambda: print(\"Second timer is done!\"))\n\n    timers.append(timer1)\n    timers.append(timer2)\n\n    while True:\n        for timer in timers:\n            if timer.done():\n                timer.callback()\n                timers.remove(timer)\n        # If no more timers are left, we exit the loop \n        if len(timers) == 0:\n            break"}]}]},{"block_type":"element","block":"k68ocoiw","search_text":"The main restriction of an event loop is, since the flow of execution is managed by a continuously running loop, that it never uses blocking calls . If we use any blocking statement (such as time.sleep ) inside the loop, you can imagine how the event monitoring and callback dispatching will stop until the blocking call is done.","text_count":329,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The main restriction of&nbsp;an event loop is, since the flow of execution is managed by a continuously running loop, that it&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"never uses blocking calls"}]},{"block_type":"text","content":". If we use any blocking statement (such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time.sleep"}]},{"block_type":"text","content":") inside the loop, you can imagine how the event monitoring and callback dispatching will stop until the blocking call is done."}]},{"block_type":"element","block":"k68ocoix","search_text":"To avoid this, rather than using a blocking call, such as time.sleep , we let the event loop detect and execute the callback when the resource is ready. By not blocking the execution flow, the event loop is free to monitor multiple resources in a concurrent way.","text_count":262,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To avoid this, rather than using a blocking call, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time.sleep"}]},{"block_type":"text","content":", we let the event loop detect and execute the callback when the resource is ready. By not blocking the execution flow, the event loop is free to monitor multiple resources in a concurrent way."}]},{"block_type":"element","block":"k68ocoiy","search_text":"Note The notification for events is usually implemented through operating system calls (such as the select Unix tool) that will resume the execution of the program whenever an event is ready (in contrast to busy-waiting). ","text_count":222,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The notification for events is usually implemented through operating system calls (such as the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"select"}]},{"block_type":"text","content":"&nbsp;Unix tool) that will resume the execution of the program whenever an event is ready (in contrast to busy-waiting)."}]}]},{"block_type":"element","block":"k68ocoiz","search_text":"The Python standard libraries include a very convenient event loop-based concurrency framework, asyncio , which will be the topic of the next section.","text_count":150,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Python standard libraries include a very convenient event loop-based concurrency framework,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":", which will be the topic of the next section."}]},{"block_type":"element","block":"k68ocoj0","search_text":"The asyncio framework","text_count":21,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"The asyncio framework"}]},{"block_type":"element","block":"k68ocoj1","search_text":"By now, you should have a solid foundation of how concurrency works, and how to use callbacks and futures. We can now move on and learn how to use the asyncio package present in the standard library since version 3.4. We will also explore the brand new async / await syntax to deal with asynchronous programming in a very natural way.","text_count":334,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By now, you should have a solid foundation of how concurrency works, and how to use callbacks and futures. We can now move on and learn how to use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"package present in the standard library since version 3.4. We will also explore the brand new"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"/"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"await"}]},{"block_type":"text","content":"syntax to deal with asynchronous programming in a very natural way."}]},{"block_type":"element","block":"k68ocoj2","search_text":"As a first example, we will see how to retrieve and execute a simple callback using asyncio . The asyncio loop can be retrieved by calling the asyncio.get_event_loop() function. We can schedule a callback for execution using loop.call_later that takes a delay in seconds and a callback. We can also use the loop.stop method to halt the loop and exit the program. To start processing the scheduled call, it is necessary to start the loop, which can be done using loop.run_forever . The following example demonstrates the usage of these basic methods by scheduling a callback that will print a message and halt the loop:","text_count":618,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a first example, we will see how to retrieve and execute a simple callback using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":". The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"loop can be retrieved by calling the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio.get_event_loop()"}]},{"block_type":"text","content":"&nbsp;function. We can schedule a callback for execution using&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"loop.call_later"}]},{"block_type":"text","content":"that takes a delay in seconds and a callback. We can also use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"loop.stop"}]},{"block_type":"text","content":"method to halt the loop and exit the program.&nbsp; To start processing the scheduled call, it is necessary to start the loop, which&nbsp;can be done using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"loop.run_forever"}]},{"block_type":"text","content":". The following example demonstrates the usage of these basic methods by scheduling a callback that will print a message and halt the loop:"}]},{"block_type":"element","block":"k68ocoj3","search_text":"import asyncio loop = asyncio.get_event_loop() def callback(): print(\"Hello, asyncio\") loop.stop() loop.call_later(1.0, callback) loop.run_forever() ","text_count":149,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import asyncio\n\n    loop = asyncio.get_event_loop()\n\n    def callback():\n        print(\"Hello, asyncio\")\n        loop.stop()\n\n    loop.call_later(1.0, callback)\n    loop.run_forever()"}]}]},{"block_type":"element","block":"k68ocoj4","search_text":"Coroutines","text_count":10,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Coroutines"}]},{"block_type":"element","block":"k68ocoj5","search_text":"One of the main problems with callbacks is that they require you to break the program execution into small functions that will be invoked when a certain event takes place. As we saw in the earlier sections, callbacks can quickly become cumbersome.","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the main problems with callbacks is that they require you to break the program execution into small functions that will be invoked when a certain event takes place. As we saw&nbsp;in the earlier&nbsp;sections, callbacks can quickly become cumbersome."}]},{"block_type":"element","block":"k68ocoj6","search_text":"Coroutines are another, perhaps a more natural, way to break up the program execution into chunks. They allow the programmer to write code that resembles synchronous code but will execute asynchronously. You may think of a coroutine as a function that can be stopped and resumed. A basic example of coroutines is generators.","text_count":324,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Coroutines are another, perhaps a more natural, way to break up the program execution into chunks. They allow the programmer to write code that resembles synchronous code but will execute asynchronously. You may think of a coroutine as&nbsp;a function that can be stopped and resumed. A&nbsp;basic example of coroutines is&nbsp;generators."}]},{"block_type":"element","block":"k68ocoj7","search_text":"Generators can be defined in Python using the yield statement inside a function. In the following example, we implement the range_generator function, which produces and returns values from 0 to n . We also add a print statement to log the internal state of the generator:","text_count":271,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Generators can be defined in Python using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"statement inside a function. In the following example, we implement the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"range_generator"}]},{"block_type":"text","content":"&nbsp;function, which&nbsp;produces and returns values from"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"n"}]},{"block_type":"text","content":". We also add a print statement to log the internal state of the generator:"}]},{"block_type":"element","block":"k68ocoj8","search_text":"def range_generator(n): i = 0 while i < n: print(\"Generating value {}\".format(i)) yield i i += 1 ","text_count":97,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def range_generator(n):\n        i = 0\n        while i &lt; n:\n            print(\"Generating value {}\".format(i))\n            yield i\n            i += 1"}]}]},{"block_type":"element","block":"k68ocoj9","search_text":"When we call the range_generator function, the code is not executed immediately. Note that nothing is printed to output when the following snippet is executed. Instead, a generator object is returned:","text_count":200,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When we call the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"range_generator"}]},{"block_type":"text","content":"&nbsp;function, the code is not executed immediately. Note that nothing is printed to output when the following snippet is executed. Instead, a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"generator object"}]},{"block_type":"text","content":"is returned:"}]},{"block_type":"element","block":"k68ocoja","search_text":"generator = range_generator(3) generator # Result: # <generator object range_generator at 0x7f03e418ba40> ","text_count":106,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"generator = range_generator(3)\n    generator\n    # Result:\n    # &lt;generator object range_generator at 0x7f03e418ba40&gt;"}]}]},{"block_type":"element","block":"k68ocojb","search_text":"In order to start pulling values from a generator, it is necessary to use the next function:","text_count":92,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In order to start pulling values from a generator, it is necessary to use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":"&nbsp;function:"}]},{"block_type":"element","block":"k68ocojc","search_text":"next(generator) # Output: # Generating value 0 next(generator) # Output: # Generating value 1 ","text_count":94,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"next(generator)\n    # Output:\n    # Generating value 0\n\n    next(generator)\n    # Output:\n    # Generating value 1"}]}]},{"block_type":"element","block":"k68ocojd","search_text":"Note that every time we invoke next , the code runs until it encounters the next yield statement and it is necessary to issue another next statement to resume the generator execution. You can think of a yield statement as a breakpoint where we can stop and resume execution (while also maintaining the internal state of the generator). This ability of stopping and resuming execution can be leveraged by the event loop to allow for concurrency. ","text_count":445,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that every time we invoke"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":", the code runs until it encounters the next"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"statement and it is necessary to issue another"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":"statement to resume the generator execution. You can think of a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"statement as a breakpoint where we can stop and resume execution (while also maintaining the internal state of the generator). This ability of stopping and resuming execution can be leveraged by the event loop to allow for concurrency.&nbsp;"}]},{"block_type":"element","block":"k68ocoje","search_text":"It is also possible to inject (rather than extract) values in the generator through the yield statement. In the following example, we declare a function parrot that will repeat each message that we send. To allow a generator to receive a value, you can assign yield to a variable (in our case, it is message = yield ). To insert values in the generator, we can use the send method. In the Python world, a generator that can also receive values is called a generator-based coroutine :","text_count":483,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is also possible to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"inject"}]},{"block_type":"text","content":"(rather than"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"extract)"}]},{"block_type":"text","content":"values in the generator through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"statement. In the following example, we declare a function parrot that will repeat each message that we send. To allow a generator to receive a value, you can assign yield to a variable (in our case, it is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"message = yield"}]},{"block_type":"text","content":"). To insert values in the generator, we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"send"}]},{"block_type":"text","content":"method. In the Python world, a generator that can also receive values is called a&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"generator-based coroutine"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocojf","search_text":"def parrot(): while True: message = yield print(\"Parrot says: {}\".format(message)) generator = parrot() generator.send(None) generator.send(\"Hello\") generator.send(\"World\") ","text_count":173,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def parrot():\n        while True:\n            message = yield\n            print(\"Parrot says: {}\".format(message))\n\n    generator = parrot()\n    generator.send(None)\n    generator.send(\"Hello\")\n    generator.send(\"World\")"}]}]},{"block_type":"element","block":"k68ocojg","search_text":"Note that we also need to issue a generator.send(None) before we can start sending messages; this is done to bootstrap the function execution and bring us to the first yield statement. Also, note that there is an infinite loop inside parrot ; if we implement this without using generators, we will get stuck running the loop forever!","text_count":333,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that we also need to issue a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"generator.send(None)"}]},{"block_type":"text","content":"before we can start sending messages; this is done to bootstrap the function execution and bring us to the first"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"statement. Also, note that there is an infinite loop inside"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"parrot"}]},{"block_type":"text","content":"; if we implement this without using generators, we will&nbsp;get stuck running the loop forever!"}]},{"block_type":"element","block":"k68ocojh","search_text":"With this in mind, you can imagine how an event loop can partially progress several of these generators without blocking the execution of the whole program. You can also imagine how a generator can be advanced only when some resource is ready, therefore eliminating the need for a callback.","text_count":290,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this in mind, you can imagine how an event loop can partially progress several of these generators without blocking the execution of the whole program. You can also imagine how a generator can&nbsp;be advanced only when some resource is ready, therefore eliminating the need for a callback."}]},{"block_type":"element","block":"k68ocoji","search_text":"It is possible to implement coroutines in asyncio using the yield statement. However, Python supports the definition of powerful coroutines using a more intuitive syntax since version 3.5.","text_count":188,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is possible to implement coroutines in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"&nbsp;using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"statement. However, Python supports the definition of powerful coroutines using a more intuitive syntax since version 3.5."}]},{"block_type":"element","block":"k68ocojj","search_text":"To define a coroutine with asyncio , you can use the async def statement:","text_count":73,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To define a coroutine with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":", you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"async def"}]},{"block_type":"text","content":"statement:"}]},{"block_type":"element","block":"k68ocojk","search_text":"async def hello(): print(\"Hello, async!\") coro = hello() coro # Output: # <coroutine object hello at 0x7f314846bd58> ","text_count":117,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"async def hello():\n        print(\"Hello, async!\")\n\n    coro = hello()\n    coro\n    # Output:\n    # &lt;coroutine object hello at 0x7f314846bd58&gt;"}]}]},{"block_type":"element","block":"k68ocojl","search_text":"As you can see, if we call the hello function, the function body is not executed immediately, but a coroutine object is returned. The asyncio coroutines do not support next , but they can be easily run in the asyncio event loop using the run_until_complete method:","text_count":264,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, if we call the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello"}]},{"block_type":"text","content":"function, the function body is not executed immediately, but a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"coroutine object"}]},{"block_type":"text","content":"is returned. The&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"coroutines do not support"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":", but they can be easily run in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"event loop using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"run_until_complete"}]},{"block_type":"text","content":"&nbsp;method:"}]},{"block_type":"element","block":"k68ocojm","search_text":"loop = asyncio.get_event_loop() loop.run_until_complete(coro) ","text_count":62,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"loop = asyncio.get_event_loop()\n    loop.run_until_complete(coro)"}]}]},{"block_type":"element","block":"k68ocojn","search_text":"Note Coroutines defined with the async def statement are also called native coroutines . ","text_count":89,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Coroutines defined with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"async def"}]},{"block_type":"text","content":"statement are also called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"native coroutines"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68ocojo","search_text":"The asyncio module provides resources (called awaitables ) that can be requested inside coroutines through the await syntax. For example, if we want to wait for a certain time and then execute a statement, we can use the asyncio.sleep function:","text_count":244,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"&nbsp; module&nbsp;provides resources (called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"awaitables"}]},{"block_type":"text","content":") that can be requested inside coroutines through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"await"}]},{"block_type":"text","content":"syntax. For example, if we want to wait for a certain time and then execute a statement, we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio.sleep"}]},{"block_type":"text","content":"&nbsp;function:"}]},{"block_type":"element","block":"k68ocojp","search_text":"async def wait_and_print(msg): await asyncio.sleep(1) print(\"Message: \", msg) loop.run_until_complete(wait_and_print(\"Hello\")) ","text_count":127,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"async def wait_and_print(msg):\n        await asyncio.sleep(1)\n        print(\"Message: \", msg)\n    \n    loop.run_until_complete(wait_and_print(\"Hello\"))"}]}]},{"block_type":"element","block":"k68ocojq","search_text":"The result is beautiful, clean code. We are writing perfectly functional asynchronous code without all the ugliness of callbacks!","text_count":129,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The result is beautiful, clean code. We are writing perfectly functional asynchronous code without all the ugliness of callbacks!"}]},{"block_type":"element","block":"k68ocojr","search_text":"Tip You may have noted how await provides a breakpoint for the event loop so that, as it wait for the resource, the event loop can move on and concurrently manage other coroutines. ","text_count":181,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You may have noted how"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"await"}]},{"block_type":"text","content":"provides a breakpoint for the event loop so that, as it wait for the resource, the event loop can move on and concurrently manage other coroutines."}]}]},{"block_type":"element","block":"k68ocojs","search_text":"Even better, coroutines are also awaitable , and we can use the await statement to chain coroutines asynchronously. In the following example, we rewrite the network_request function, which we defined earlier, by replacing the call to time.sleep with asyncio.sleep :","text_count":265,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even better, coroutines are also"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"awaitable"}]},{"block_type":"text","content":", and we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"await"}]},{"block_type":"text","content":"statement to chain coroutines asynchronously. In the following example, we rewrite the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request"}]},{"block_type":"text","content":"&nbsp;function, which we defined earlier, by replacing the call to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time.sleep"}]},{"block_type":"text","content":"with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio.sleep"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocojt","search_text":"async def network_request(number): await asyncio.sleep(1.0) return {\"success\": True, \"result\": number ** 2} ","text_count":108,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"async def network_request(number):\n         await asyncio.sleep(1.0)\n         return {\"success\": True, \"result\": number ** 2}"}]}]},{"block_type":"element","block":"k68ocoju","search_text":"We can follow up by reimplementing fetch_square . As you can see, we can await network_request directly without needing additional futures or callbacks.","text_count":152,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can follow up by reimplementing"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fetch_square"}]},{"block_type":"text","content":". As you can see, we can await"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"network_request"}]},{"block_type":"text","content":"directly without needing additional futures or callbacks."}]},{"block_type":"element","block":"k68ocojv","search_text":"async def fetch_square(number): response = await network_request(number) if response[\"success\"]: print(\"Result is: {}\".format(response[\"result\"])) ","text_count":147,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"async def fetch_square(number):\n         response = await network_request(number)\n         if response[\"success\"]:\n             print(\"Result is: {}\".format(response[\"result\"]))"}]}]},{"block_type":"element","block":"k68ocojw","search_text":"The coroutines can be executed individually using loop.run_until_complete :","text_count":75,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The coroutines can be executed individually using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"loop.run_until_complete"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocojx","search_text":"loop.run_until_complete(fetch_square(2)) loop.run_until_complete(fetch_square(3)) loop.run_until_complete(fetch_square(4)) ","text_count":123,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"loop.run_until_complete(fetch_square(2))\n    loop.run_until_complete(fetch_square(3))\n    loop.run_until_complete(fetch_square(4))"}]}]},{"block_type":"element","block":"k68ocojy","search_text":"Running tasks using run_until_complete is fine for testing and debugging. However, our program will be started with loop.run_forever most of the times, and we will need to submit our tasks while the loop is already running.","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Running tasks using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"run_until_complete"}]},{"block_type":"text","content":"is fine for testing and debugging. However, our program will be started with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"loop.run_forever"}]},{"block_type":"text","content":"most of the times, and we will need to submit our tasks while the loop is already running."}]},{"block_type":"element","block":"k68ocojz","search_text":"asyncio provides the ensure_future function, which schedules coroutines (as well as futures) for execution. ensure_future can be used by simply passing the coroutine we want to schedule. The following code will schedule multiple calls to fetch_square that will be executed concurrently:","text_count":286,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"provides the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ensure_future"}]},{"block_type":"text","content":"&nbsp;function, which&nbsp;schedules coroutines (as well as futures) for execution."},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ensure_future"}]},{"block_type":"text","content":"can be used by simply passing the coroutine we want to schedule. The following code will schedule multiple calls to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fetch_square"}]},{"block_type":"text","content":"that will be executed concurrently:"}]},{"block_type":"element","block":"k68ocok0","search_text":"asyncio.ensure_future(fetch_square(2)) asyncio.ensure_future(fetch_square(3)) asyncio.ensure_future(fetch_square(4)) loop.run_forever() # Hit Ctrl-C to stop the loop ","text_count":166,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"asyncio.ensure_future(fetch_square(2))\n    asyncio.ensure_future(fetch_square(3))\n    asyncio.ensure_future(fetch_square(4))\n\n    loop.run_forever()\n    # Hit Ctrl-C to stop the loop"}]}]},{"block_type":"element","block":"k68ocok1","search_text":"As a bonus, when passing a coroutine, the asyncio.ensure_future function will return a Task instance (which is a subclass of Future ) so that we can take advantage of the await syntax without having to give up the resource tracking capabilities of regular futures.","text_count":264,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a bonus, when passing a coroutine, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio.ensure_future"}]},{"block_type":"text","content":"function will return a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Task"}]},{"block_type":"text","content":"instance (which is a subclass of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":") so that we can take advantage of the await syntax without having to give up the resource tracking capabilities of regular futures."}]},{"block_type":"element","block":"k68ocok2","search_text":"Converting blocking code into non-blocking code","text_count":47,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Converting blocking code into non-blocking code"}]},{"block_type":"element","block":"k68ocok3","search_text":"While asyncio supports connecting to resources in an asynchronous way, it is required to use blocking calls in certain cases. This happens, for example, when third-party APIs exclusively expose blocking calls (for example, many database libraries), but also when executing long-running computations. In this subsection, we will learn how to deal with blocking APIs and make them compatible with asyncio .","text_count":404,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"While"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"supports connecting to resources in an asynchronous way, it is required to use blocking calls in certain cases. This happens, for example, when third-party APIs exclusively expose blocking calls (for example, many database libraries), but also when executing long-running computations. In this subsection, we will learn how to deal with blocking APIs and make them compatible with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocok4","search_text":"An effective strategy for dealing with blocking code is to run it in a separate thread. Threads are implemented at the Operating System ( OS ) level and allow parallel execution of blocking code. For this purpose, Python provides the Executor interface designed to run tasks in a separate thread and to monitor their progress using futures.","text_count":340,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An effective strategy for dealing with blocking code is to run it in a separate thread. Threads are implemented at the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Operating System"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"OS"}]},{"block_type":"text","content":") level and allow parallel execution of blocking code. For this purpose, Python provides the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Executor"}]},{"block_type":"text","content":"interface designed to run tasks in a separate thread and to monitor their progress using futures."}]},{"block_type":"element","block":"k68ocok5","search_text":"You can initialize a ThreadPoolExecutor by importing it from the concurrent.futures module. The executor will spawn a collection of threads (called workers ) that will wait to execute whatever task we throw at them. Once a function is submitted, the executor will take care of dispatching its execution to an available worker thread and keep track of the result. The max_workers argument can be used to select the number of threads.","text_count":432,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can initialize a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ThreadPoolExecutor"}]},{"block_type":"text","content":"by importing it from the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concurrent.futures"}]},{"block_type":"text","content":"module. The executor will spawn a collection of threads (called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"workers"}]},{"block_type":"text","content":") that will wait to execute whatever task we throw at them. Once a function is submitted, the executor will take care of dispatching its execution to an available worker thread and keep track of the result. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max_workers"}]},{"block_type":"text","content":"argument can be used to select the number of threads."}]},{"block_type":"element","block":"k68ocok6","search_text":"Note that the executor will not destroy a thread once a task is completed. By doing so, it reduces the cost associated with the creation and destruction of threads. ","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that the executor will not destroy a thread once a task is completed. By doing so, it reduces the cost associated with the creation and destruction of threads.&nbsp;"}]},{"block_type":"element","block":"k68ocok7","search_text":"In the following example, we create a ThreadPoolExecutor with three workers, and we submit a wait_and_return function that will block the program execution for one second and return a message string. We then use the submit method to schedule its execution:","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following example, we create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ThreadPoolExecutor"}]},{"block_type":"text","content":"with three&nbsp;workers, and we submit a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"wait_and_return"}]},{"block_type":"text","content":"function that will block the program execution for one&nbsp;second and return a message string. We then use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"submit"}]},{"block_type":"text","content":"method to schedule its execution:"}]},{"block_type":"element","block":"k68ocok8","search_text":"from concurrent.futures import ThreadPoolExecutor executor = ThreadPoolExecutor(max_workers=3) def wait_and_return(msg): time.sleep(1) return msg executor.submit(wait_and_return, \"Hello. executor\") # Result: # <Future at 0x7ff616ff6748 state=running> ","text_count":251,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from concurrent.futures import ThreadPoolExecutor\n    executor = ThreadPoolExecutor(max_workers=3)\n\n    def wait_and_return(msg):\n        time.sleep(1)\n        return msg\n\n    executor.submit(wait_and_return, \"Hello. executor\")\n    # Result:\n    # &lt;Future at 0x7ff616ff6748 state=running&gt;"}]}]},{"block_type":"element","block":"k68ocok9","search_text":"The executor.submit method immediately schedules the function and returns a future. It is possible to manage the execution of tasks in asyncio using the loop.run_in_executor method, which works quite similarly to executor.submit :","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"executor.submit"}]},{"block_type":"text","content":"method immediately schedules the function and returns a future. It is possible to manage the execution of tasks in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"&nbsp;using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"loop.run_in_executor"}]},{"block_type":"text","content":"method, which works quite similarly to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"executor.submit"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocoka","search_text":"fut = loop.run_in_executor(executor, wait_and_return, \"Hello, asyncio executor\") # <Future pending ...more info...> ","text_count":116,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fut = loop.run_in_executor(executor, wait_and_return, \"Hello, asyncio \n    executor\")\n    # &lt;Future pending ...more info...&gt;"}]}]},{"block_type":"element","block":"k68ocokb","search_text":"The run_in_executor method will also return an asyncio.Future instance that can be awaited from other code, the main difference being that the future will not be run until we start the loop. We can run and obtain the response using loop.run_until_complete :","text_count":257,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"run_in_executor"}]},{"block_type":"text","content":"method will also return an"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio.Future"}]},{"block_type":"text","content":"instance that can be awaited from other code, the main difference being that the future will not be run until we start the loop. We can run and obtain the response using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"loop.run_until_complete"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocokc","search_text":"loop.run_until_complete(fut) # Result: # 'Hello, executor' ","text_count":59,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"loop.run_until_complete(fut)\n    # Result:\n    # 'Hello, executor'"}]}]},{"block_type":"element","block":"k68ocokd","search_text":"As a practical example, we can use this technique to implement concurrent fetching of several web pages. To do this, we will import the popular (blocking) requests library and run the requests.get function in the executor:","text_count":222,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a practical example, we can use this technique to implement concurrent fetching of several web pages. To do this, we will import the popular (blocking)"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"requests"}]},{"block_type":"text","content":"library and run the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"requests.get"}]},{"block_type":"text","content":"function in the executor:"}]},{"block_type":"element","block":"k68ocoke","search_text":"import requests async def fetch_urls(urls): responses = [] for url in urls: responses.append(await loop.run_in_executor (executor, requests.get, url)) return responses loop.run_until_complete(fetch_ruls(['http://www.google.com', 'http://www.example.com', 'http://www.facebook.com'])) # Result # [] ","text_count":298,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import requests\n\n    async def fetch_urls(urls):\n        responses = []\n        for url in urls:\n            responses.append(await loop.run_in_executor\n                                (executor, requests.get, url))\n        return responses\n\n    loop.run_until_complete(fetch_ruls(['http://www.google.com', \n                                        'http://www.example.com',\n                                        'http://www.facebook.com']))\n    # Result\n    # []"}]}]},{"block_type":"element","block":"k68ocokf","search_text":"This version of fetch_url will not block the execution and allow other coroutines in asyncio to run; however, it is not optimal as the function will not fetch a URL in parallel. To do this, we can use asyncio.ensure_future or employ the asyncio.gather convenience function that will submit all the coroutines at once and gather the results as they come. The usage of asyncio.gather is demonstrated here:","text_count":403,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This version of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"fetch_url"}]},{"block_type":"text","content":"will not block the execution and allow other coroutines in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"to run; however, it is not optimal as the function will not fetch a URL&nbsp;in parallel. To do this, we can use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio.ensure_future"}]},{"block_type":"text","content":"or employ the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio.gather"}]},{"block_type":"text","content":"convenience function that will submit all the coroutines at once and gather the results as they come. The usage of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio.gather"}]},{"block_type":"text","content":"is demonstrated here:"}]},{"block_type":"element","block":"k68ocokg","search_text":"def fetch_urls(urls): return asyncio.gather(*[loop.run_in_executor (executor, requests.get, url) for url in urls]) ","text_count":115,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def fetch_urls(urls):\n        return asyncio.gather(*[loop.run_in_executor\n                                 (executor, requests.get, url) \n                                 for url in urls])"}]}]},{"block_type":"element","block":"k68ocokh","search_text":"Note The number of URLs you can fetch in parallel with this method will be dependent on the number of worker threads you have. To avoid this limitation, you should use a natively non-blocking library, such as aiohttp . ","text_count":219,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The number of URLs&nbsp;you can fetch in parallel with this method will be dependent on the number of worker threads you have. To avoid this limitation, you should use a natively non-blocking library, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"aiohttp"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k68ocoki","search_text":"Reactive programming","text_count":20,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Reactive programming"}]},{"block_type":"element","block":"k68ocokj","search_text":"Reactive programming is a paradigm that aims at building better concurrent systems. Reactive applications are designed to comply with the requirements exemplified by the reactive manifesto:","text_count":189,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Reactive programming is a paradigm that aims at building better concurrent systems. Reactive applications are designed to comply with the requirements exemplified by the reactive manifesto:"}]},{"block_type":"element","block":"k68ocokk","search_text":"Responsive : The system responds immediately to the user. Elastic : The system is capable of handling different levels of load and is able to adapt to accommodate increasing demands. Resilient : The system deals with failure gracefully. This is achieved by modularity and avoiding having a single point of failure. Message driven : The system should not block and take advantage of events and messages. A message-driven application helps achieve all the previous requirements. ","text_count":477,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Responsive"}]},{"block_type":"text","content":": &nbsp;The system responds immediately to the user."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Elastic"}]},{"block_type":"text","content":": The system is capable of handling different levels of load and is able to adapt to accommodate increasing demands."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Resilient"}]},{"block_type":"text","content":": The system deals with failure gracefully. This is achieved by modularity and avoiding having a single point of failure."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Message driven"}]},{"block_type":"text","content":": The system should not block and take advantage of events and messages. A message-driven application helps achieve all the previous requirements."}]}]},{"block_type":"element","block":"k68ocokl","search_text":"As you can see, the intent of reactive systems is quite noble, but how exactly does reactive programming work? In this section, we will learn about the principles of reactive programming using the RxPy library.","text_count":210,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, the intent of reactive systems is quite noble, but how exactly does reactive programming work? In this section, we will learn about the principles of reactive programming using the RxPy library."}]},{"block_type":"element","block":"k68ocokm","search_text":"Note The RxPy library is part of ReactiveX ( http://reactivex.io/ ), which is a project that implements reactive programming tools for a large variety of languages. ","text_count":165,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The RxPy library is part of ReactiveX ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://reactivex.io/"},"children":[{"block_type":"text","content":"http://reactivex.io/"}]},{"block_type":"text","content":"), which is a project that implements reactive programming tools for a large variety of languages."}]}]},{"block_type":"element","block":"k68ocokn","search_text":"Observables","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Observables"}]},{"block_type":"element","block":"k68ocoko","search_text":"As the name implies, the main idea of reactive programming is to react to events. In the preceding section, we saw some examples of this idea with callbacks; you subscribe to them and the callback is executed as soon as the event takes place.","text_count":242,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As the name implies, the main idea of reactive programming is to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"react"}]},{"block_type":"text","content":"to events. In the preceding section, we saw some examples of this idea with callbacks; you subscribe to them and the callback is executed as soon as the event takes place."}]},{"block_type":"element","block":"k68ocokp","search_text":"In reactive programming, this idea is expanded by thinking of events as streams of data. This can be exemplified by showing examples of such streams in RxPy. A data stream can be created from an iterator using the Observable.from_iterable factory method, as follows:","text_count":266,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In reactive programming, this idea is expanded by thinking of events as streams of data. This can be exemplified by showing examples of such streams in RxPy. A data stream can be created from an iterator using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Observable.from_iterable"}]},{"block_type":"text","content":"factory method, as follows:"}]},{"block_type":"element","block":"k68ocokq","search_text":"from rx import Observable obs = Observable.from_iterable(range(4)) ","text_count":67,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from rx import Observable\n    obs = Observable.from_iterable(range(4))"}]}]},{"block_type":"element","block":"k68ocokr","search_text":"In order to receive data from obs , we can use the Observable.subscribe method, which will execute the function we pass for each value that the data source emits:","text_count":162,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In order to receive data from"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"obs"}]},{"block_type":"text","content":", we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Observable.subscribe"}]},{"block_type":"text","content":"&nbsp;method, which&nbsp;will execute the function we pass for each value that the data source emits:"}]},{"block_type":"element","block":"k68ocoks","search_text":"obs.subscribe(print) # Output: # 0 # 1 # 2 # 3 ","text_count":47,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"obs.subscribe(print)\n    # Output:\n    # 0\n    # 1\n    # 2\n    # 3"}]}]},{"block_type":"element","block":"k68ocokt","search_text":"You may have noted that observables are ordered collections of items just like lists or, more generally, iterators. This is not a coincidence.","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You may have noted that observables are ordered collections of items just like lists or, more generally, iterators. This is not a coincidence."}]},{"block_type":"element","block":"k68ocoku","search_text":"Note The term observable comes from the combination of observer and iterable. An observer is an object that reacts to changes of the variable it observes, while an iterable is an object that is capable of producing and keeping track of an iterator. ","text_count":249,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The term observable comes from the combination of observer and iterable. An"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"observer"}]},{"block_type":"text","content":"is an object that reacts to changes of the variable it observes, while an"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"iterable"}]},{"block_type":"text","content":"is an object that is capable of producing and keeping track of an iterator."}]}]},{"block_type":"element","block":"k68ocokv","search_text":"In Python, iterators are objects that define the __next__ method, and whose elements can be extracted by calling next . An iterator can generally be obtained by a collection using iter ; then we can extract elements using next or a for loop. Once an element is consumed from the iterator, we can't go back. We can demonstrate its usage by creating an iterator from a list:","text_count":372,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Python, iterators are objects that define the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"__next__"}]},{"block_type":"text","content":"method, and whose elements can be extracted by calling"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":". An iterator can generally be obtained by a collection using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"iter"}]},{"block_type":"text","content":"; then we can extract elements using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":"or a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"for"}]},{"block_type":"text","content":"loop. Once an element is consumed from the iterator, we can't go back. We can demonstrate its usage by creating an iterator from a list:"}]},{"block_type":"element","block":"k68ocokw","search_text":"collection = list([1, 2, 3, 4, 5]) iterator = iter(collection) print(\"Next\") print(next(iterator)) print(next(iterator)) print(\"For loop\") for i in iterator: print(i) # Output: # Next # 1 # 2 # For loop # 3 # 4 # 5 ","text_count":215,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"collection = list([1, 2, 3, 4, 5])\n    iterator = iter(collection)\n\n    print(\"Next\")\n    print(next(iterator))\n    print(next(iterator))\n\n    print(\"For loop\")\n    for i in iterator:\n         print(i)\n\n    # Output:\n    # Next\n    # 1\n    # 2\n    # For loop\n    # 3\n    # 4\n    # 5"}]}]},{"block_type":"element","block":"k68ocokx","search_text":"You can see how, every time we call next or we iterate, the iterator produces a value and advances. In a sense, we are pulling results from the iterator.","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can see how, every time we call"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":"or we iterate, the iterator produces a value and advances. In a sense, we are"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pulling"}]},{"block_type":"text","content":"results from the iterator."}]},{"block_type":"element","block":"k68ocoky","search_text":"Note Iterators sound a lot like generators; however, they are more general. In Python, generators are returned by functions that use yield expressions. As we saw, generators support next , therefore, they are a special class of iterators. ","text_count":239,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Iterators sound a lot like generators; however, they are more general. In Python, generators are returned by functions that use yield expressions. As we saw, generators support"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":", therefore, they are a special class of iterators."}]}]},{"block_type":"element","block":"k68ocokz","search_text":"Now you can appreciate the contrast between an iterator and an observable. An observable pushes a stream of data to us whenever it's ready, but that's not everything. An observable is also able to tell us when there is an error and where there is no more data. In fact, it is possible to register further callbacks to the Observable.subscribe method. In the following example, we create an observable and register callbacks to be called using on_next whenever the next item is available and using the on_completed argument when there is no more data:","text_count":550,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now you can appreciate the contrast between an iterator and an observable.&nbsp; An observable"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pushes"}]},{"block_type":"text","content":"a stream of data to us whenever it's ready, but that's not everything. An observable is also able to tell us when there is an error and where there is no more data. In fact, it is possible to register further callbacks to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Observable.subscribe"}]},{"block_type":"text","content":"method. In the following example, we create an observable and register callbacks to be called using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"on_next"}]},{"block_type":"text","content":"&nbsp;whenever the next item is available and using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"on_completed"}]},{"block_type":"text","content":"argument when there is no more data:"}]},{"block_type":"element","block":"k68ocol0","search_text":"obs = Observable.from_iter(range(4)) obs.subscribe(on_next=lambda x: print(on_next=\"Next item: {}\"), on_completed=lambda: print(\"No more data\")) # Output: # Next element: 0 # Next element: 1 # Next element: 2 # Next element: 3 # No more data ","text_count":242,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"obs = Observable.from_iter(range(4))\n    obs.subscribe(on_next=lambda x: print(on_next=\"Next item: {}\"),\n                  on_completed=lambda: print(\"No more data\"))\n    # Output:\n    # Next element: 0\n    # Next element: 1\n    # Next element: 2\n    # Next element: 3\n    # No more data"}]}]},{"block_type":"element","block":"k68ocol1","search_text":"This analogy with the iterator is important because we can use the same techniques that can be used with iterators to handle streams of events.","text_count":143,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This analogy with the iterator is important because we can use the same techniques that can be used with iterators to handle streams of events."}]},{"block_type":"element","block":"k68ocol2","search_text":"RxPy provides operators that can be used to create, transform, filter, and group observables. The power of reactive programming lies in the fact that those operations return other observables that can be conveniently chained and composed together. For a quick taste, we will demonstrate the usage of the take operator.","text_count":318,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"RxPy provides operators that can be used to create, transform, filter, and group observables. The power of reactive programming lies in the fact that those operations return other observables that can be conveniently chained and composed together. For a quick taste, we will demonstrate the usage of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"take"}]},{"block_type":"text","content":"&nbsp;operator."}]},{"block_type":"element","block":"k68ocol3","search_text":"Given an observable, take will return a new observable that will stop after n items. Its usage is straightforward:","text_count":114,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Given an observable,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"take"}]},{"block_type":"text","content":"will return a new observable that will stop after"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"n"}]},{"block_type":"text","content":"items. Its usage is straightforward:"}]},{"block_type":"element","block":"k68ocol4","search_text":"obs = Observable.from_iterable(range(100000)) obs2 = obs.take(4) obs2.subscribe(print) # Output: # 0 # 1 # 2 # 3 ","text_count":113,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"obs = Observable.from_iterable(range(100000))\n    obs2 = obs.take(4)\n\n    obs2.subscribe(print)\n    # Output:\n    # 0\n    # 1\n    # 2\n    # 3"}]}]},{"block_type":"element","block":"k68ocol5","search_text":"The collection of operations implemented in RxPy is varied and rich, and can be used to build complex applications using these operators as building blocks.","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The collection of operations implemented in RxPy is varied and rich, and can be used to build complex applications using these operators as building blocks."}]},{"block_type":"element","block":"k68ocol6","search_text":"Useful operators","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Useful operators"}]},{"block_type":"element","block":"k68ocol7","search_text":"In this subsection, we will explore operators that transform the elements of a source observable in some way. The most prominent member of this family of operators is the familiar map , which emits the elements of the source observable after applying a function to them. For example, we may use map to calculate the square of a sequence of numbers:","text_count":348,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this subsection, we will explore operators that transform the elements of a source observable in some way. The most prominent member of this family of operators is the familiar"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":", which emits the elements of the source observable after applying a function to them. For example, we may use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"to calculate the square of a sequence of numbers:"}]},{"block_type":"element","block":"k68ocol8","search_text":"(Observable.from_iterable(range(4)) .map(lambda x: x**2) .subscribe(print)) # Output: # 0 # 1 # 4 # 9 ","text_count":102,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"(Observable.from_iterable(range(4))\n               .map(lambda x: x**2)\n               .subscribe(print))\n    # Output:\n    # 0\n    # 1\n    # 4\n    # 9"}]}]},{"block_type":"element","block":"k68ocol9","search_text":"Operators can be represented with marble diagrams that help us better understand how the operator works, especially when taking into account the fact that elements can be emitted over a region of time. In a marble diagram, a data stream (in our case, an observable) is represented by a solid line. A circle (or other shape) identifies a value emitted by the observable, an X symbol represents an error, and a vertical line represents the end of the stream.","text_count":456,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Operators can be represented with marble diagrams that help us better understand how the operator works, especially when taking into account the fact that elements can be emitted over a region of time. In a marble diagram, a data stream (in our case, an observable) is represented by a solid line. A circle (or other shape) identifies a value emitted by the observable, an"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"X"}]},{"block_type":"text","content":"symbol represents an error, and a vertical line represents the end of the stream."}]},{"block_type":"element","block":"k68ocola","search_text":"In the following figure, we can see the marble diagram of map :","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following figure, we can see the marble diagram of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocolb","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000017.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocolc","search_text":"The source observable is placed at the top of the diagram, the transformation is placed in the middle, and the resulting observable is placed at the bottom.","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The source observable is placed at the top of the diagram, the transformation is placed in the middle, and the resulting observable is placed at the bottom."}]},{"block_type":"element","block":"k68ocold","search_text":"Another example of a transformation is group_by , which sorts the items into groups based on a key. The group_by operator takes a function that extracts a key when given an element and produces an observable for each key with the elements associated to it.","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another example of a transformation is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"group_by"}]},{"block_type":"text","content":", which&nbsp;sorts the items into groups based on a key. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"group_by"}]},{"block_type":"text","content":"operator takes a function that extracts a key when given an element&nbsp;and produces an observable for each key with the elements associated to it."}]},{"block_type":"element","block":"k68ocole","search_text":"The group_by operation can be expressed more clearly using a marble diagram. In the following figure, you can see how group_by emits two observables. Additionally, the items are dynamically sorted into groups as soon as they are emitted :","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"group_by"}]},{"block_type":"text","content":"operation can be expressed more clearly using a marble diagram. In the following figure, you can see how"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"group_by"}]},{"block_type":"text","content":"emits two observables. Additionally, the items are dynamically sorted into groups"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"as soon as they are emitted"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocolf","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000018.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocolg","search_text":"We can further understand how group_by works with a simple example. Let's say that we want to group the number according to the fact that they're even or odd. We can implement this using group_by by passing the lambda x: x % 2 expression as a key function, which will return 0 if the number is even and 1 if the number is odd:","text_count":326,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can further understand how"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"group_by"}]},{"block_type":"text","content":"works with a simple example. Let's say that we want to group the number according to the fact that&nbsp;they're even or odd. We can implement this using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"group_by"}]},{"block_type":"text","content":"by passing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"lambda x: x % 2"}]},{"block_type":"text","content":"&nbsp;expression as a key function, which will return"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"if the number is even and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"if the number is odd:"}]},{"block_type":"element","block":"k68ocolh","search_text":"obs = (Observable.from_range(range(4)) .group_by(lambda x: x % 2)) ","text_count":67,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"obs = (Observable.from_range(range(4))\n                     .group_by(lambda x: x % 2))"}]}]},{"block_type":"element","block":"k68ocoli","search_text":"At this point, if we subscribe and print the content of obs , actually two observables are printed:","text_count":99,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, if we subscribe and print the content of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"obs"}]},{"block_type":"text","content":", actually two observables are printed:"}]},{"block_type":"element","block":"k68ocolj","search_text":"obs.subscribe(print) # <rx.linq.groupedobservable.GroupedObservable object at 0x7f0fba51f9e8> # <rx.linq.groupedobservable.GroupedObservable object at 0x7f0fba51fa58> ","text_count":167,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"obs.subscribe(print)\n    # &lt;rx.linq.groupedobservable.GroupedObservable object at 0x7f0fba51f9e8&gt;\n    # &lt;rx.linq.groupedobservable.GroupedObservable object at 0x7f0fba51fa58&gt;"}]}]},{"block_type":"element","block":"k68ocolk","search_text":"You can determine the group key using the key attribute. To extract all the even numbers, we can take the first observable (corresponding to a key equal to 0) and subscribe to it. In the following code, we show how this works:","text_count":226,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can determine the group key using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"key"}]},{"block_type":"text","content":"attribute. To extract all the even numbers, we can take the first observable (corresponding to a key equal to 0) and subscribe to it. In the following code, we show how this works:"}]},{"block_type":"element","block":"k68ocoll","search_text":"obs.subscribe(lambda x: print(\"group key: \", x.key)) # Output: # group key: 0 # group key: 1 obs.take(1).subscribe(lambda x: x.subscribe(print)) # Output: # 0 # 2 ","text_count":163,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"obs.subscribe(lambda x: print(\"group key: \", x.key))\n    # Output:\n    # group key:  0\n    # group key:  1\n    obs.take(1).subscribe(lambda x: x.subscribe(print))\n    # Output:\n    # 0\n    # 2"}]}]},{"block_type":"element","block":"k68ocolm","search_text":"With group_by , we introduced an observable that emits other observables. This turns out to be quite a common pattern in reactive programming, and there are functions that allow you to combine different observables.","text_count":215,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"group_by"}]},{"block_type":"text","content":", we introduced an observable that emits other observables. This turns out to be quite a common pattern in reactive programming, and there are functions that allow you to combine different observables."}]},{"block_type":"element","block":"k68ocoln","search_text":"Two useful tools for combining observables are merge_all and concat_all . Merge takes multiple observables and produces a single observable that contains the element of the two observables in the order they are emitted. This is better illustrated using a marble diagram:","text_count":270,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Two useful tools for combining observables are"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"merge_all"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concat_all"}]},{"block_type":"text","content":". Merge takes multiple observables and produces a single observable that contains the element of the two observables in the order they are emitted. This is better illustrated using a marble diagram:"}]},{"block_type":"element","block":"k68ocolo","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000019.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocolp","search_text":"merge_all can be compared to a similar operator, concat_all , which returns a new observable that emits the elements of all the elements of the first observable, followed by the elements of the second observable and so on. The marble diagram for concat_all is presented here:","text_count":275,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"merge_all"}]},{"block_type":"text","content":"can be compared to a similar operator,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concat_all"}]},{"block_type":"text","content":", which&nbsp;returns a new observable that emits the elements of all the elements of the first observable, followed by the elements of the second observable and so on. The marble diagram for"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concat_all"}]},{"block_type":"text","content":"is presented here:"}]},{"block_type":"element","block":"k68ocolq","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000020.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocolr","search_text":"To demonstrate the usage of these two operators, we can apply those operations to the observable of observables returned by group_by . In the case of merge_all , the items are returned in the same order as they were initially (remember that group_by emits elements in the two groups as they come):","text_count":297,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate the usage of these two operators, we can apply those operations to the observable of observables returned by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"group_by"}]},{"block_type":"text","content":". In the case of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"merge_all"}]},{"block_type":"text","content":", the items are returned in the same order as they were initially (remember that"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"group_by"}]},{"block_type":"text","content":"emits elements in the two groups as they come):"}]},{"block_type":"element","block":"k68ocols","search_text":"obs.merge_all().subscribe(print) # Output # 0 # 1 # 2 # 3 ","text_count":58,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"obs.merge_all().subscribe(print)\n    # Output\n    # 0\n    # 1\n    # 2\n    # 3"}]}]},{"block_type":"element","block":"k68ocolt","search_text":"On the other hand, concat_all first returns the even elements and then the odd elements as it waits for the first observable to complete, and then starts emitting the elements of the second observable. This is demonstrated in the following snippet. In this specific example, we also applied a function, make_replay ; this is needed because, by the time the \"even\" stream is consumed, the elements of the second stream have already been produced and will not be available to concat_all . This concept will become much clearer after reading the Hot and cold observables section:","text_count":576,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other hand,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concat_all"}]},{"block_type":"text","content":"first returns the even elements and then the odd elements as it waits for the first observable to complete, and then starts emitting the elements of the second observable. This is demonstrated in the following snippet.&nbsp;In this specific example, we also applied a function,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"make_replay"}]},{"block_type":"text","content":"; this is needed because, by the time the \"even\" stream is consumed, the elements of the second stream have already been produced and will not be available to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concat_all"}]},{"block_type":"text","content":". This concept will become much clearer after reading the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Hot and cold observables"}]},{"block_type":"text","content":"&nbsp;section:"}]},{"block_type":"element","block":"k68ocolu","search_text":"def make_replay(a): result = a.replay(None) result.connect() return result obs.map(make_replay).concat_all().subscribe(print) # Output # 0 # 2 # 1 # 3 ","text_count":151,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def make_replay(a):\n        result = a.replay(None)\n        result.connect()\n        return result\n\n    obs.map(make_replay).concat_all().subscribe(print)\n    # Output\n    # 0\n    # 2\n    # 1\n    # 3"}]}]},{"block_type":"element","block":"k68ocolv","search_text":"This time around, the even numbers are printed first, followed by the odd numbers. ","text_count":83,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This time around, the even numbers are printed first, followed by the odd numbers.&nbsp;"}]},{"block_type":"element","block":"k68ocolw","search_text":"Tip RxPy also provides the merge and concat operations that can be used to combine individual observables ","text_count":106,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"RxPy also provides the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"merge"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concat"}]},{"block_type":"text","content":"operations that can be used to combine individual observables"}]}]},{"block_type":"element","block":"k68ocolx","search_text":"Hot and cold observables","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Hot and cold observables"}]},{"block_type":"element","block":"k68ocoly","search_text":"In the preceding section, we learned how to create an observable using the Observable.from_iterable method. RxPy provides many other tools to create more interesting event sources.","text_count":180,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding&nbsp;section, we learned&nbsp;how to create an observable using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Observable.from_iterable"}]},{"block_type":"text","content":"method. RxPy provides many other tools to create more interesting event sources."}]},{"block_type":"element","block":"k68ocolz","search_text":"Observable.interval takes a time interval in milliseconds, period , and will create an observable that emits a value every time the period has passed. The following line of code can be used to define an observable, obs , that will emit a number, starting from zero, every second. We use the take operator to limit the timer to four events:","text_count":339,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Observable.interval"}]},{"block_type":"text","content":"takes a time interval in milliseconds,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"period"}]},{"block_type":"text","content":", and will create an observable that emits a value every time the period has passed. The following line of code can be used to define an observable,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"obs"}]},{"block_type":"text","content":", that will emit a number, starting from zero, every second. We use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"take"}]},{"block_type":"text","content":"operator to limit the timer to four&nbsp;events:"}]},{"block_type":"element","block":"k68ocom0","search_text":"obs = Observable.interval(1000) obs.take(4).subscribe(print) # Output: # 0 # 1 # 2 # 3 ","text_count":87,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"obs = Observable.interval(1000)\n    obs.take(4).subscribe(print)\n    # Output:\n    # 0\n    # 1\n    # 2\n    # 3"}]}]},{"block_type":"element","block":"k68ocom1","search_text":"A very important fact about Observable.interval is that the timer doesn't start until we subscribe. We can observe this by printing both the index and the delay from when the timer starts definition using time.time() , as follows:","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A very important fact about"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Observable.interval"}]},{"block_type":"text","content":"is that the timer doesn't start until we subscribe. We can observe this by printing both the index and the delay from when the timer starts definition using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"time.time()"}]},{"block_type":"text","content":", as follows:"}]},{"block_type":"element","block":"k68ocom2","search_text":"import time start = time.time() obs = Observable.interval(1000).map(lambda a: (a, time.time() - start)) # Let's wait 2 seconds before starting the subscription time.sleep(2) obs.take(4).subscribe(print) # Output: # (0, 3.003735303878784) # (1, 4.004871129989624) # (2, 5.005947589874268) # (3, 6.00749135017395) ","text_count":312,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import time\n\n    start = time.time()\n    obs = Observable.interval(1000).map(lambda a: \n                                           (a, time.time() - start))\n\n    # Let's wait 2 seconds before starting the subscription\n    time.sleep(2)\n    obs.take(4).subscribe(print)\n    # Output:\n    # (0, 3.003735303878784)\n    # (1, 4.004871129989624)\n    # (2, 5.005947589874268)\n    # (3, 6.00749135017395)"}]}]},{"block_type":"element","block":"k68ocom3","search_text":"As you can see, the first element (corresponding to a 0 index) is produced after three seconds, which means that the timer started when we issue the subscribe(print) method.","text_count":173,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, the first element (corresponding to a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"index) is produced after three&nbsp;seconds, which means that the timer started when we issue the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"subscribe(print)"}]},{"block_type":"text","content":"method."}]},{"block_type":"element","block":"k68ocom4","search_text":"Observables, such as Observable.interval , are called lazy because they start producing values only when requested (think of them as vending machines, which won't dispense food unless we press the button). In Rx jargon, these kind of observables are called cold . A property of cold observables is that, if we attach two subscribers, the interval timer will be started multiple times. This is quite evident from the following example. Here, we add a new subscription 0.5 seconds after the first, and you can see how the output of the two subscriptions come at different times:","text_count":576,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Observables, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Observable.interval"}]},{"block_type":"text","content":", are called&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"lazy"}]},{"block_type":"text","content":"&nbsp;because they start producing values only when requested (think of them as vending machines, which won't dispense food unless we press the button). In Rx jargon, these&nbsp;kind of observables are called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"cold"}]},{"block_type":"text","content":". A property of cold observables is that, if we attach two subscribers, the interval timer will be started multiple times. This is quite evident from the following example. Here, we add a new subscription 0.5 seconds after the first, and you can see how the output of the two subscriptions come at different times:"}]},{"block_type":"element","block":"k68ocom5","search_text":"start = time.time() obs = Observable.interval(1000).map(lambda a: (a, time.time() - start)) # Let's wait 2 seconds before starting the subscription time.sleep(2) obs.take(4).subscribe(lambda x: print(\"First subscriber: {}\".format(x))) time.sleep(0.5) obs.take(4).subscribe(lambda x: print(\"Second subscriber: {}\".format(x))) # Output: # First subscriber: (0, 3.0036110877990723) # Second subscriber: (0, 3.5052847862243652) # First subscriber: (1, 4.004414081573486) # Second subscriber: (1, 4.506155252456665) # First subscriber: (2, 5.005316972732544) # Second subscriber: (2, 5.506817102432251) # First subscriber: (3, 6.0062034130096436) # Second subscriber: (3, 6.508296489715576) ","text_count":686,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"start = time.time()\n    obs = Observable.interval(1000).map(lambda a: \n                                           (a, time.time() - start))\n\n    # Let's wait 2 seconds before starting the subscription\n    time.sleep(2)\n    obs.take(4).subscribe(lambda x: print(\"First subscriber: \n                                             {}\".format(x)))\n    time.sleep(0.5)\n    obs.take(4).subscribe(lambda x: print(\"Second subscriber: \n                                             {}\".format(x)))\n    # Output:\n    # First subscriber: (0, 3.0036110877990723)\n    # Second subscriber: (0, 3.5052847862243652)\n    # First subscriber: (1, 4.004414081573486)\n    # Second subscriber: (1, 4.506155252456665)\n    # First subscriber: (2, 5.005316972732544)\n    # Second subscriber: (2, 5.506817102432251)\n    # First subscriber: (3, 6.0062034130096436)\n    # Second subscriber: (3, 6.508296489715576)"}]}]},{"block_type":"element","block":"k68ocom6","search_text":"Sometimes we may not want this behavior as we may want multiple subscribers to subscribe to the same data source. To make the observable produce the same data, we can delay the data production and ensure that all the subscribers will get the same data using the publish method.","text_count":277,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sometimes we may not want this behavior as we may want multiple subscribers to subscribe to the same data source. To make the observable produce the same data, we can delay the data production and ensure that all the subscribers will get the same data using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"publish"}]},{"block_type":"text","content":"&nbsp;method."}]},{"block_type":"element","block":"k68ocom7","search_text":"Publish will transform our observable into a ConnectableObservable , which won't start pushing data immediately, but only when we call the connect method. The usage of publish and connect is demonstrated in the following snippet:","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Publish will transform our observable into a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ConnectableObservable"}]},{"block_type":"text","content":", which won't start pushing data immediately, but only when we call the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"connect"}]},{"block_type":"text","content":"method. The usage of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"publish"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"connect"}]},{"block_type":"text","content":"is demonstrated in the following snippet:"}]},{"block_type":"element","block":"k68ocom8","search_text":"start = time.time() obs = Observable.interval(1000).map(lambda a: (a, time.time() - start)).publish() obs.take(4).subscribe(lambda x: print(\"First subscriber: {}\".format(x))) obs.connect() # Data production starts here time.sleep(2) obs.take(4).subscribe(lambda x: print(\"Second subscriber: {}\".format(x))) # Output: # First subscriber: (0, 1.0016899108886719) # First subscriber: (1, 2.0027990341186523) # First subscriber: (2, 3.003532648086548) # Second subscriber: (2, 3.003532648086548) # First subscriber: (3, 4.004265308380127) # Second subscriber: (3, 4.004265308380127) # Second subscriber: (4, 5.005320310592651) # Second subscriber: (5, 6.005795240402222) ","text_count":667,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"start = time.time()\n    obs = Observable.interval(1000).map(lambda a: (a, time.time() - \n    start)).publish()\n    obs.take(4).subscribe(lambda x: print(\"First subscriber: \n                                             {}\".format(x)))\n    obs.connect() # Data production starts here\n\n    time.sleep(2)\n    obs.take(4).subscribe(lambda x: print(\"Second subscriber: \n                                             {}\".format(x)))\n    # Output:\n    # First subscriber: (0, 1.0016899108886719)\n    # First subscriber: (1, 2.0027990341186523)\n    # First subscriber: (2, 3.003532648086548)\n    # Second subscriber: (2, 3.003532648086548)\n    # First subscriber: (3, 4.004265308380127)\n    # Second subscriber: (3, 4.004265308380127)\n    # Second subscriber: (4, 5.005320310592651)\n    # Second subscriber: (5, 6.005795240402222)"}]}]},{"block_type":"element","block":"k68ocom9","search_text":"In the preceding example, you can see how we first issue publish , then we subscribe the first subscriber and, finally, we issue connect . When connect is issued, the timer will start producing data. The second subscriber joins the party late and, in fact, won't receive the first two messages but will start receiving data from the third and so on. Note how, this time around, the subscribers share the exact same data. This kind of data source, where data is produced independently of the subscribers, is called hot .","text_count":519,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding&nbsp;example, you can see how we first issue"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"publish"}]},{"block_type":"text","content":", then we subscribe the first subscriber and, finally, we issue"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"connect"}]},{"block_type":"text","content":". When"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"connect"}]},{"block_type":"text","content":"is issued, the timer will start producing data. The second subscriber joins the party late and, in fact, won't receive the first two messages but will start receiving data from the third and so on. Note how, this time around, the subscribers share the exact same data. This kind of data source, where data is produced independently of the subscribers, is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"hot"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocoma","search_text":"Similar to publish , you can use the replay method that will produce the data from the beginning for each new subscriber. This is illustrated in the following example that, which is identical to the preceding one except that we replaced publish with replay :","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Similar to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"publish"}]},{"block_type":"text","content":", you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"replay"}]},{"block_type":"text","content":"method that will produce the data&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"from the beginning"}]},{"block_type":"text","content":"&nbsp;for each new subscriber. This is illustrated in the following example that, which is identical to the preceding&nbsp;one except that we replaced"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"publish"}]},{"block_type":"text","content":"with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"replay"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocomb","search_text":"import time start = time.time() obs = Observable.interval(1000).map(lambda a: (a, time.time() - start)).replay(None) obs.take(4).subscribe(lambda x: print(\"First subscriber: {}\".format(x))) obs.connect() time.sleep(2) obs.take(4).subscribe(lambda x: print(\"Second subscriber: {}\".format(x))) First subscriber: (0, 1.0008857250213623) First subscriber: (1, 2.0019824504852295) Second subscriber: (0, 1.0008857250213623) Second subscriber: (1, 2.0019824504852295) First subscriber: (2, 3.0030810832977295) Second subscriber: (2, 3.0030810832977295) First subscriber: (3, 4.004604816436768) Second subscriber: (3, 4.004604816436768) ","text_count":630,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import time\n\n    start = time.time()\n    obs = Observable.interval(1000).map(lambda a: (a, time.time() - \n    start)).replay(None)\n    obs.take(4).subscribe(lambda x: print(\"First subscriber: \n                                             {}\".format(x)))\n    obs.connect()\n\n    time.sleep(2)\n    obs.take(4).subscribe(lambda x: print(\"Second subscriber: \n                                             {}\".format(x)))\n\n    First subscriber: (0, 1.0008857250213623)\n    First subscriber: (1, 2.0019824504852295)\n    Second subscriber: (0, 1.0008857250213623)\n    Second subscriber: (1, 2.0019824504852295)\n    First subscriber: (2, 3.0030810832977295)\n    Second subscriber: (2, 3.0030810832977295)\n    First subscriber: (3, 4.004604816436768)\n    Second subscriber: (3, 4.004604816436768)"}]}]},{"block_type":"element","block":"k68ocomc","search_text":"You can see how, this time around, even though the second subscriber arrives late to the party, it is still given all the items that have been given out so far.","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can see how, this time around, even though the second subscriber arrives late to the party, it is still given all the items that have been given out so far."}]},{"block_type":"element","block":"k68ocomd","search_text":"Another way of creating hot observables is through the Subject class. Subject is interesting because it's capable of both receiving and pushing data, and thus it can be used to manually push items to an observable. Using Subject is very intuitive; in the following code, we create a Subject and subscribe to it. Later, we push values to it using the on_next method; as soon as we do that, the subscriber is called:","text_count":414,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another way of creating hot observables is through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Subject"}]},{"block_type":"text","content":"class."},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Subject"}]},{"block_type":"text","content":"is interesting because it's capable of both receiving and pushing data, and thus it can be used to manually"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"push"}]},{"block_type":"text","content":"items to an observable. Using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Subject"}]},{"block_type":"text","content":"is very intuitive; in the following code, we create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Subject"}]},{"block_type":"text","content":"and subscribe to it. Later, we push values to it using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"on_next"}]},{"block_type":"text","content":"&nbsp;method; as soon as we do that, the subscriber is called:"}]},{"block_type":"element","block":"k68ocome","search_text":"s = Subject() s.subscribe(lambda a: print(\"Subject emitted value: {}\".format(x)) s.on_next(1) # Subject emitted value: 1 s.on_next(2) # Subject emitted value: 2 ","text_count":161,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"s = Subject()\n    s.subscribe(lambda a: print(\"Subject emitted value: {}\".format(x))\n    s.on_next(1)\n    # Subject emitted value: 1\n    s.on_next(2)\n    # Subject emitted value: 2"}]}]},{"block_type":"element","block":"k68ocomf","search_text":"Note that Subject is another example of hot observables.","text_count":56,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Subject"}]},{"block_type":"text","content":"is another example of hot observables."}]},{"block_type":"element","block":"k68ocomg","search_text":"Building a CPU monitor","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Building a CPU monitor"}]},{"block_type":"element","block":"k68ocomh","search_text":"Now that we have a grasp on the main reactive programming concepts, we can implement a sample application. In this subsection, we will implement a monitor that will give us real-time information about our CPU usage and is capable of detecting spikes.","text_count":250,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have a grasp on the main reactive programming concepts, we can implement a sample application. In this subsection, we will implement a monitor that will give us real-time information about our CPU usage and is capable of detecting spikes."}]},{"block_type":"element","block":"k68ocomi","search_text":"Note The complete code for the CPU monitor can be found in the cpu_monitor.py file. ","text_count":84,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The complete code for the CPU&nbsp;monitor can be found in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cpu_monitor.py"}]},{"block_type":"text","content":"&nbsp;file."}]}]},{"block_type":"element","block":"k68ocomj","search_text":"As a first step, let's implement a data source. We will use the psutil module that provides a function, psutil.cpu_percent , that returns the latest available CPU usage as a percent (and doesn't block):","text_count":202,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a first step, let's implement a data source. We will use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"psutil"}]},{"block_type":"text","content":"module that&nbsp;provides a function,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"psutil.cpu_percent"}]},{"block_type":"text","content":", that returns the latest available CPU usage as a percent (and doesn't block):"}]},{"block_type":"element","block":"k68ocomk","search_text":"import psutil psutil.cpu_percent() # Result: 9.7 ","text_count":49,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import psutil\n    psutil.cpu_percent()\n    # Result: 9.7"}]}]},{"block_type":"element","block":"k68ocoml","search_text":"Since we are developing a monitor, we would like to sample this information over a few time intervals. To accomplish this we can use the familiar Observable.interval , followed by map just like we did in the previous section. Also, we would like to make this observable hot as, for this application, all subscribers should receive a single source of data; to make Observable.interval hot, we can use the publish and connect methods. The full code for the creation of the cpu_data observable is as follows","text_count":504,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Since we are developing a monitor, we would like to sample this information over a few time intervals. To accomplish this we can use the familiar"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Observable.interval"}]},{"block_type":"text","content":", followed by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"just like we did in the previous section. Also, we would like to make this observable"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"hot"}]},{"block_type":"text","content":"as, for this application, all subscribers should receive a single source of data; to make"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Observable.interval"}]},{"block_type":"text","content":"hot,&nbsp; we can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"publish"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"connect"}]},{"block_type":"text","content":"methods. The full code for the creation of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cpu_data"}]},{"block_type":"text","content":"observable is as follows"}]},{"block_type":"element","block":"k68ocomm","search_text":"cpu_data = (Observable .interval(100) # Each 100 milliseconds .map(lambda x: psutil.cpu_percent()) .publish()) cpu_data.connect() # Start producing data ","text_count":153,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cpu_data = (Observable\n                .interval(100) # Each 100 milliseconds\n                .map(lambda x: psutil.cpu_percent())\n                .publish())\n    cpu_data.connect() # Start producing data"}]}]},{"block_type":"element","block":"k68ocomn","search_text":"We can test our monitor by printing a sample of 4 items","text_count":55,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can test our monitor by printing a sample of 4 items"}]},{"block_type":"element","block":"k68ocomo","search_text":"cpu_data.take(4).subscribe(print) # Output: # 12.5 # 5.6 # 4.5 # 9.6 ","text_count":69,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cpu_data.take(4).subscribe(print)\n    # Output:\n    # 12.5\n    # 5.6\n    # 4.5\n    # 9.6"}]}]},{"block_type":"element","block":"k68ocomp","search_text":"Now that our main data source is in place, we can implement a monitor visualization using matplotlib . The idea is to create a plot that contains a fixed amount of measurements and, as new data arrives, we include the newest measurement and remove the oldest one. This is commonly referred to as a moving window and is better understood with an illustration. In the following figure, our cpu_data stream is represented as a list of numbers. The first plot is produced as soon as we have the first four numbers and, each time a new number arrives, we shift the window by one position and update the plot:","text_count":603,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that our main data source is in place, we can implement a monitor visualization using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib"}]},{"block_type":"text","content":". The idea is to create a plot that contains a fixed amount of measurements and, as new data arrives, we include the newest measurement and remove the oldest one. This is commonly referred to as a&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"moving window"}]},{"block_type":"text","content":"and is better understood with an illustration. In the following figure, our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cpu_data"}]},{"block_type":"text","content":"stream is represented as a list of numbers. The first plot is produced as soon as we have the first four numbers and, each time a new number arrives, we shift the window by one position and update the plot:"}]},{"block_type":"element","block":"k68ocomq","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000022.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocomr","search_text":"To implement this algorithm, we can write a function, called monitor_cpu , that will create and update our plotting window. The function will do the following things:","text_count":166,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To implement this algorithm, we can write a function, called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"monitor_cpu"}]},{"block_type":"text","content":", that will create and update our plotting window. The function will do the following things:"}]},{"block_type":"element","block":"k68ocoms","search_text":"Initialize an empty plot and set up the correct plot limits. Transform our cpu_data observable to return a moving window over the data. This can be accomplished using the buffer_with_count operator, which will take the number of points in our window, npoints , as parameters and the shift as 1 . Subscribe to this new data stream and update the plot with the incoming data. ","text_count":374,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Initialize an empty plot and set up the correct plot limits."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Transform our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cpu_data"}]},{"block_type":"text","content":"observable to return a moving window over the data. This can be accomplished using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"buffer_with_count"}]},{"block_type":"text","content":"operator, which will take the number of points in our window,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"npoints"}]},{"block_type":"text","content":", as parameters and the shift as&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Subscribe to this new data stream and update the plot with the incoming data."}]}]},{"block_type":"element","block":"k68ocomt","search_text":"The complete code for the function is shown here and, as you can see, is extremely compact. Take some time to run the function and play with the parameters:","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The complete code for the function is shown here&nbsp;and, as you can see, is extremely compact. Take some time to run the function and play with the parameters:"}]},{"block_type":"element","block":"k68ocomu","search_text":"import numpy as np from matplotlib import pyplot as plt def monitor_cpu(npoints): lines, = plt.plot([], []) plt.xlim(0, npoints) plt.ylim(0, 100) # 0 to 100 percent cpu_data_window = cpu_data.buffer_with_count(npoints, 1) def update_plot(cpu_readings): lines.set_xdata(np.arange(npoints)) lines.set_ydata(np.array(cpu_readings)) plt.draw() cpu_data_window.subscribe(update_plot) plt.show() ","text_count":390,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np\n    from matplotlib import pyplot as plt\n\n    def monitor_cpu(npoints):\n        lines, = plt.plot([], [])\n        plt.xlim(0, npoints) \n        plt.ylim(0, 100) # 0 to 100 percent\n\n        cpu_data_window = cpu_data.buffer_with_count(npoints, 1)\n\n        def update_plot(cpu_readings):\n            lines.set_xdata(np.arange(npoints))\n            lines.set_ydata(np.array(cpu_readings))\n            plt.draw()\n\n        cpu_data_window.subscribe(update_plot)\n\n        plt.show()"}]}]},{"block_type":"element","block":"k68ocomv","search_text":"Another feature we may want to develop is, for example, an alert that triggers when the CPU has been high for a certain amount of time as this may indicate that some of the processes in our machine are working very hard. This can be accomplished by combining buffer_with_count and map . We can take the CPU stream and a window, and then we will test whether all items have a value higher than twenty percent usage (in a quad-core CPU that corresponds to about one processor working at hundred percent) in the map function. If all the points in the window have a higher than twenty percent usage, we display a warning in our plot window.","text_count":636,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another feature we may want to develop is, for example, an alert that triggers when the CPU has been high for a certain amount of time as this may indicate that some of the&nbsp; processes in our machine are working very hard. This can be accomplished by combining"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"buffer_with_count"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":". We can take the CPU stream and a window, and then we will test whether&nbsp;all items have a value higher than twenty percent&nbsp;usage (in a quad-core CPU that corresponds to about one processor working at hundred percent) in the map function. If all the points in the window have a higher than twenty percent usage, we display a warning in our plot window."}]},{"block_type":"element","block":"k68ocomw","search_text":"The implementation of the new observable can be written as follows and will produce an observable that emits True if the CPU has high usage, and False otherwise:","text_count":161,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The implementation of the new observable can be written as follows and will produce an observable that emits"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"True"}]},{"block_type":"text","content":"if the CPU&nbsp;has high usage, and&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"False"}]},{"block_type":"text","content":"otherwise:"}]},{"block_type":"element","block":"k68ocomx","search_text":"alertpoints = 4 high_cpu = (cpu_data .buffer_with_count(alertpoints, 1) .map(lambda readings: all(r > 20 for r in readings))) ","text_count":126,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"alertpoints = 4    \n    high_cpu = (cpu_data\n                .buffer_with_count(alertpoints, 1)\n                .map(lambda readings: all(r &gt; 20 for r in readings)))"}]}]},{"block_type":"element","block":"k68ocomy","search_text":"Now that the high_cpu observable is ready, we can create a matplotlib label and subscribe to it for updates:","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"high_cpu"}]},{"block_type":"text","content":"observable is ready, we can create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"matplotlib"}]},{"block_type":"text","content":"label and subscribe to it for updates:"}]},{"block_type":"element","block":"k68ocomz","search_text":"label = plt.text(1, 1, \"normal\") def update_warning(is_high): if is_high: label.set_text(\"high\") else: label.set_text(\"normal\") high_cpu.subscribe(update_warning) ","text_count":163,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"label = plt.text(1, 1, \"normal\")\n    def update_warning(is_high):\n        if is_high:\n            label.set_text(\"high\")\n        else:\n            label.set_text(\"normal\")\n    high_cpu.subscribe(update_warning)"}]}]},{"block_type":"element","block":"k68ocon0","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k68ocon1","search_text":"Asynchronous programming is useful when our code deals with slow and unpredictable resources, such as I/O devices and networks. In this chapter, we explored the fundamental concepts of concurrency and asynchronous programming and how to write concurrent code with the asyncio and RxPy libraries.","text_count":295,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Asynchronous programming is useful when our code deals with slow and unpredictable resources, such as I/O devices and networks. In this chapter, we explored the fundamental concepts of concurrency and&nbsp;asynchronous programming and how to write concurrent code with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"and RxPy libraries."}]},{"block_type":"element","block":"k68ocon2","search_text":"asyncio coroutines are an excellent choice when dealing with multiple, interconnected resources as they greatly simplify the code logic by cleverly avoiding callbacks. Reactive programming is also very good in these situations, but it truly shines when dealing with streams of data that are common in real-time applications and user interfaces.","text_count":344,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"coroutines are an excellent choice when dealing with multiple, interconnected resources as they&nbsp;greatly simplify the code logic by cleverly avoiding callbacks. Reactive programming is also very good in these situations, but it truly shines when dealing with streams of data that are common in real-time applications and user interfaces."}]},{"block_type":"element","block":"k68ocon3","search_text":"In the next two chapters, we will learn about parallel programming and how to achieve impressive performance gain by taking advantage of multiple cores and multiple machines.","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next two chapters, we will learn about parallel programming and how to achieve impressive performance gain by taking advantage of multiple cores and multiple machines."}]}]},{"title":"Parallel Processing","author":"Gabriele Lanaro","block":"k68ocgw8","number":7,"contents":[{"block_type":"element","block":"k68ocon4","search_text":"With parallel processing by using multiple cores, you can increase the amount of calculations your program can do in a given time frame without needing a faster processor. The main idea is to divide a problem into independent subunits and use multiple cores to solve those subunits in parallel.","text_count":294,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With parallel processing by using multiple cores, you can increase the amount of calculations your program can do in a given time frame without needing a faster processor. The main idea is to divide a problem&nbsp;into independent subunits and use multiple cores to solve those subunits in parallel."}]},{"block_type":"element","block":"k68ocon5","search_text":"Parallel processing is necessary to tackle large-scale problems. Companies produce massive quantities of data every day that need to be stored in multiple computers and analyzed. Scientists and engineers run parallel code on supercomputers to simulate massive systems.","text_count":268,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Parallel processing is necessary to tackle large-scale problems. Companies produce massive quantities of data every day that need to be stored in multiple computers and analyzed.&nbsp;Scientists and engineers run parallel code on supercomputers to simulate massive systems."}]},{"block_type":"element","block":"k68ocon6","search_text":"Parallel processing allows you to take advantage of multicore CPUs as well as GPUs that work extremely well with highly parallel problems. In this chapter, we will cover the following topics:","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Parallel processing allows you to take advantage of multicore CPUs as well as GPUs that work extremely well with&nbsp;highly parallel problems. In this chapter, we will cover the following topics:"}]},{"block_type":"element","block":"k68ocon7","search_text":"A brief introduction to the fundamentals of parallel processing Illustrating how to parallelize simple problems with the multiprocessing Python library Using the simple ProcessPoolExecutor interface Parallelizing our programs using multithreading with the help of Cython and OpenMP Achieving parallelism automatically with Theano and Tensorflow Executing code on a GPU with Theano, Tensorflow, and Numba ","text_count":404,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A brief introduction to the fundamentals of parallel processing"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Illustrating how to parallelize simple problems with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing"}]},{"block_type":"text","content":"Python library"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using the simple"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ProcessPoolExecutor"}]},{"block_type":"text","content":"interface"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Parallelizing our programs using multithreading with the help of Cython and OpenMP"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Achieving parallelism automatically with Theano and Tensorflow"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Executing code on a GPU with Theano, Tensorflow, and Numba"}]}]},{"block_type":"element","block":"k68ocon8","search_text":"Introduction to parallel programming","text_count":36,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Introduction to parallel programming"}]},{"block_type":"element","block":"k68ocon9","search_text":"In order to parallelize a program, it is necessary to divide the problem into subunits that can run independently (or almost independently) from each other.","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In order to parallelize a program,&nbsp;it is necessary to divide the problem into subunits that can run independently (or almost independently) from each other."}]},{"block_type":"element","block":"k68ocona","search_text":"A problem where the subunits are totally independent from each other is called embarrassingly parallel . An element-wise operation on an array is a typical example--the operation needs to only know the element it is handling at the moment. Another example is our particle simulator. Since there are no interactions, each particle can evolve independently from the others. Embarrassingly parallel problems are very easy to implement and perform very well on parallel architectures.","text_count":480,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A problem where the subunits are totally independent from each other is called&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"embarrassingly&nbsp;parallel"}]},{"block_type":"text","content":". An element-wise operation on an array is a typical example--the operation needs to only know the element it is handling at the moment. Another example is our particle simulator. Since there are no interactions, each particle can evolve independently from the others. Embarrassingly parallel problems are very easy to implement and perform very well on parallel architectures."}]},{"block_type":"element","block":"k68oconb","search_text":"Other problems may be divided into subunits but have to share some data to perform their calculations. In those cases, the implementation is less straightforward and can lead to performance issues because of the communication costs.","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Other problems may be divided into subunits but have to share some data to perform their calculations. In those cases, the implementation is less straightforward and can lead to performance issues because of the communication costs."}]},{"block_type":"element","block":"k68oconc","search_text":"We will illustrate the concept with an example. Imagine that you have a particle simulator, but this time the particles attract other particles within a certain distance (as shown in the following figure). To parallelize this problem, we divide the simulation box into regions and assign each region to a different processor. If we evolve the system one step at a time, some particles will interact with particles in a neighboring region. To perform the next iteration, communication with the new particle positions of the neighboring region is required.","text_count":554,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will illustrate the concept with an example. Imagine that you have a particle simulator, but this time the particles attract other particles within a certain distance (as shown in the following figure). To parallelize this problem, we divide the simulation box into regions and assign each region to a different processor. If we evolve the system one step at a time, some particles will interact with particles in a neighboring region. To perform the next iteration, communication with the new particle positions of the neighboring region is required."}]},{"block_type":"element","block":"k68ocond","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000006.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocone","search_text":"Communication between processes is costly and can seriously hinder the performance of parallel programs. There exist two main ways to handle data communication in parallel programs:","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Communication between processes is costly and can seriously hinder the performance of parallel programs. There exist two main ways to handle data communication in parallel programs:"}]},{"block_type":"element","block":"k68oconf","search_text":"Shared memory Distributed memory ","text_count":33,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Shared memory"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Distributed memory"}]}]}]},{"block_type":"element","block":"k68ocong","search_text":"In shared memory, the subunits have access to the same memory space. The advantage of this approach is that you don't have to explicitly handle the communication as it is sufficient to write or read from the shared memory. However, problems arise when multiple processes try to access and change the same memory location at the same time. Care should be taken to avoid such conflict using synchronization techniques.","text_count":416,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In shared memory, the subunits have access to the same memory space. The advantage of this approach is that you don't have to explicitly handle the communication as it is sufficient to write or read from the shared memory. However, problems arise when multiple processes try to access and change the same memory location at the same time. Care should be taken to avoid such conflict using synchronization techniques."}]},{"block_type":"element","block":"k68oconh","search_text":"In the distributed memory model, each process is completely separated from the others and possesses its own memory space. In this case, communication is handled explicitly between the processes. The communication overhead is typically costlier compared to shared memory as data can potentially travel through a network interface.","text_count":329,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the distributed memory model, each process is completely separated from the others and possesses its own memory space. In this case, communication is handled explicitly between the processes. The communication overhead is typically costlier compared to shared memory as data can potentially travel through a network interface."}]},{"block_type":"element","block":"k68oconi","search_text":"One common way to achieve parallelism with the shared memory model is threads . Threads are independent subtasks that originate from a process and share resources, such as memory. This concept is further illustrated in the following figure. Threads produce multiple execution context and share the same memory space, while processes provide multiple execution context that possess their own memory space and communication has to be handled explicitly.","text_count":451,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One common way to achieve parallelism with the shared memory model is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"threads"}]},{"block_type":"text","content":". Threads are independent subtasks that originate from a process and share resources, such as memory. This concept is further illustrated in the following figure. Threads produce multiple execution context and share the same memory space, while processes provide multiple execution context that possess their own memory space and communication has to be handled explicitly."}]},{"block_type":"element","block":"k68oconj","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000009.png","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k68oconk","search_text":"Python can spawn and handle threads, but they can't be used to increase performance; due to the Python interpreter design, only one Python instruction is allowed to run at a time--this mechanism is called Global Interpreter Lock ( GIL ). What happens is that each time a thread executes a Python statement, the thread acquires a lock and, when the execution is completed, the same lock is released. Since the lock can be acquired only by one thread at a time, other threads are prevented from executing Python statements while some other thread holds the lock.","text_count":560,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Python can spawn and handle threads, but they can't be used to increase performance; due to the Python interpreter design, only one Python instruction is allowed to run at a time--this mechanism is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Global Interpreter Lock"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"GIL"}]},{"block_type":"text","content":"). What happens is that each time a thread executes a Python statement, the thread acquires a lock and, when the execution is completed, the same lock is released. Since the lock can be acquired only by one thread at a time, other threads are prevented from executing Python statements while some other thread holds the lock."}]},{"block_type":"element","block":"k68oconl","search_text":"Even though the GIL prevents parallel execution of Python instructions, threads can still be used to provide concurrency in situations where the lock can be released, such as in time-consuming I/O operations or in C extensions.","text_count":227,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even though the GIL prevents parallel execution of Python instructions, threads can still be used to provide concurrency in situations where the lock can be released, such as in time-consuming I/O operations or in C extensions."}]},{"block_type":"element","block":"k68oconm","search_text":"Note Why not remove the GIL? In past years, many attempts have been made, including the most recent gilectomy experiment. First, removing the GIL is not an easy task and requires modification of most of the Python data structures. Additionally, such fine-grained locking can be costly and may introduce substantial performance loss in single-threaded programs. Despite this, some Python implementations (notable examples are Jython and IronPython) do not use the GIL. ","text_count":468,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Why not remove the GIL? In past years, many attempts have been made, including the most recent gilectomy&nbsp;experiment. First, removing the GIL is not an easy task and&nbsp;requires modification of most of the Python data structures. Additionally, such fine-grained locking can be costly and may introduce substantial performance loss in single-threaded programs. Despite this, some Python implementations (notable examples are Jython and IronPython) do not use the GIL."}]}]},{"block_type":"element","block":"k68oconn","search_text":"The GIL can be completely sidestepped using processes instead of threads. Processes don't share the same memory area and are independent from each other--each process has its own interpreter. Processes have a few disadvantages: starting up a new process is generally slower than starting a new thread, they consume more memory, and inter-process communication can be slow. On the other hand, processes are still very flexible, and they scale better as they can be distributed on multiple machines.","text_count":497,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The GIL can be completely sidestepped using processes instead of threads. Processes don't share the same memory area and are independent from each other--each process has its own interpreter. Processes have a few disadvantages: starting up a new process is generally slower than starting a new thread, they consume more memory, and&nbsp;inter-process communication can be slow. On the other hand, processes are still very flexible, and they scale better as they can be distributed on multiple machines."}]},{"block_type":"element","block":"k68ocono","search_text":"Graphic processing units","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Graphic processing units"}]},{"block_type":"element","block":"k68oconp","search_text":"Graphic processing units are special processors designed for computer graphics applications. Those applications usually require processing the geometry of a 3D scene and output an array of pixel to the screen. The operations performed by GPUs involve array and matrix operations on floating point numbers.","text_count":305,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Graphic processing units are special processors designed for computer graphics applications. Those applications usually require processing the geometry of a 3D scene and output an array of pixel to the screen. The operations performed by GPUs involve array and matrix operations on floating point numbers."}]},{"block_type":"element","block":"k68oconq","search_text":"GPUs are designed to run this graphics-related operation very efficiently, and they achieve this by adopting a highly parallel architecture. Compared to a CPU, a GPU has many more (thousands) of small processing units. GPUs are intended to produce data at about 60 frames per second, which is much slower than the typical response time of a CPU, which possesses higher clock speeds.","text_count":382,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"GPUs are designed to run this graphics-related&nbsp;operation very efficiently, and they achieve this by adopting a highly parallel architecture. Compared to a CPU, a GPU has many more (thousands) of small processing units. GPUs are intended to produce data at about 60 frames per second, which is much slower than the typical response time of a CPU, which possesses higher clock speeds."}]},{"block_type":"element","block":"k68oconr","search_text":"GPUs possess a very different architecture from a standard CPU and are specialized for computing floating point operations. Therefore, to compile programs for GPUs, it is necessary to utilize special programming platforms, such as CUDA and OpenCL.","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"GPUs possess a very different architecture from&nbsp;a standard CPU and are specialized for computing floating point operations. Therefore, to compile programs for GPUs, it is necessary to utilize special&nbsp;programming platforms, such as CUDA and OpenCL."}]},{"block_type":"element","block":"k68ocons","search_text":"Compute Unified Device Architecture ( CUDA ) is a proprietary NVIDIA technology. It provides an API that can be accessed from other languages. CUDA provides the NVCC tool that can be used to compile GPU programs written in a language similar to C (CUDA C) as well as numerous libraries that implement highly optimized mathematical routines.","text_count":340,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Compute Unified Device Architecture"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"CUDA"}]},{"block_type":"text","content":") is a proprietary NVIDIA technology. It provides an API that can be accessed from other languages. CUDA provides the NVCC&nbsp;tool that can be used to compile GPU programs written in a language similar to C (CUDA C) as well as numerous libraries that implement highly optimized mathematical routines."}]},{"block_type":"element","block":"k68ocont","search_text":"OpenCL is an open technology with the ability of writing parallel programs that can be compiled for a variety of target devices (CPUs and GPUs of several vendors) and is a good option for non-NVIDIA devices.","text_count":207,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"OpenCL"}]},{"block_type":"text","content":"&nbsp;is an open technology with the ability of writing parallel programs that can be compiled&nbsp;for a variety of target devices (CPUs and GPUs of several vendors) and is a good option for non-NVIDIA devices."}]},{"block_type":"element","block":"k68oconu","search_text":"GPU programming sounds wonderful on paper. However, don't throw away your CPU yet. GPU programming is tricky and only specific use cases benefit from the GPU architecture. Programmers need to be aware of the costs incurred in memory transfers to and from the main memory and how to implement algorithms to take advantage of the GPU architecture.","text_count":345,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"GPU programming sounds&nbsp;wonderful on paper. However, don't throw away your CPU yet. GPU programming is tricky and only specific use cases benefit from the GPU architecture. Programmers need to be aware&nbsp;of the costs incurred in memory transfers to and from the main memory and how to implement algorithms to take advantage of the GPU architecture."}]},{"block_type":"element","block":"k68oconv","search_text":"Generally, GPUs are great at increasing the amount of operations you can perform per unit of time (also called throughput ); however, they require more time to prepare the data for processing. In contrast, CPUs are much faster at producing an individual result from scratch (also called latency ).","text_count":297,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Generally, GPUs are great at increasing the amount of operations you can perform per unit of time (also called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"throughput"}]},{"block_type":"text","content":"); however, they require more time to prepare the data for processing. In contrast, CPUs are much faster at producing an individual result from scratch (also called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"latency"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k68oconw","search_text":"For the right problem, GPUs provide extreme (10 to 100 times) speedup. For this reason, they often constitute a very inexpensive (the same speedup will require hundreds of CPUs) solution to improve the performance of numerically intensive applications. We will illustrate how to execute some algorithms on a GPU in the Automatic Parallelism section.","text_count":349,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For the right problem, GPUs provide extreme (10 to 100 times) speedup. For this reason, they often constitute a very inexpensive (the same speedup will require hundreds of CPUs) solution to improve the performance of numerically intensive&nbsp;applications. We will illustrate how to execute some algorithms on a GPU in the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Automatic Parallelism"}]},{"block_type":"text","content":"section."}]},{"block_type":"element","block":"k68oconx","search_text":"Using multiple processes","text_count":24,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Using multiple processes"}]},{"block_type":"element","block":"k68ocony","search_text":"The standard multiprocessing module can be used to quickly parallelize simple tasks by spawning several processes, while avoiding the GIL problem. Its interface is easy to use and includes several utilities to handle task submission and synchronization.","text_count":253,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The standard"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing"}]},{"block_type":"text","content":"module can be used to quickly parallelize simple tasks by spawning several processes, while&nbsp;avoiding the GIL problem. Its interface is easy to use and includes several utilities to handle task submission and synchronization."}]},{"block_type":"element","block":"k68oconz","search_text":"The Process and Pool classes","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The Process and Pool classes"}]},{"block_type":"element","block":"k68ocoo0","search_text":"You can create a process that runs independently by subclassing multiprocessing.Process . You can extend the __init__ method to initialize resources, and you can write the portion of the code that will be executed in a subprocess by implementing the Process.run method. In the following code, we define a Process class that will wait for one second and print its assigned id :","text_count":376,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can create a process that runs independently by subclassing"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing.Process"}]},{"block_type":"text","content":". You can extend the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"__init__"}]},{"block_type":"text","content":"method to initialize resources, and you can write the portion of the code&nbsp;that will be executed in a subprocess by implementing the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Process.run"}]},{"block_type":"text","content":"method. In the following code, we define a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Process"}]},{"block_type":"text","content":"class that will wait for one second and print its assigned"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"id"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocoo1","search_text":"import multiprocessing import time class Process(multiprocessing.Process): def __init__(self, id): super(Process, self).__init__() self.id = id def run(self): time.sleep(1) print(\"I'm the process with id: {}\".format(self.id)) ","text_count":226,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import multiprocessing \n    import time \n\n    class Process(multiprocessing.Process): \n        def __init__(self, id): \n            super(Process, self).__init__() \n            self.id = id \n\n        def run(self): \n            time.sleep(1) \n            print(\"I'm the process with id: {}\".format(self.id))"}]}]},{"block_type":"element","block":"k68ocoo2","search_text":"To spawn the process, we have to instantiate the Process class and call the Process.start method. Note that you don't directly call Process.run ; the call to Process.start will create a new process that, in turn, will call the Process.run method. We can add the following lines at the end of the preceding snippet to create and start the new process:","text_count":350,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To spawn the process, we have to instantiate the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Process"}]},{"block_type":"text","content":"&nbsp;class and call the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Process.start"}]},{"block_type":"text","content":"method. Note that you don't directly call"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Process.run"}]},{"block_type":"text","content":"; the call to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Process.start"}]},{"block_type":"text","content":"will create a new process that, in turn, will call the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Process.run"}]},{"block_type":"text","content":"method. We can add the following lines at the end of the preceding&nbsp;snippet to create and start the new process:"}]},{"block_type":"element","block":"k68ocoo3","search_text":"if __name__ == '__main__': p = Process(0) p.start() ","text_count":52,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if __name__ == '__main__': \n        p = Process(0) \n        p.start()"}]}]},{"block_type":"element","block":"k68ocoo4","search_text":"The instructions after Process.start will be executed immediately without waiting for the p process to finish. To wait for the task completion, you can use the Process.join method, as follows:","text_count":192,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The instructions after"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Process.start"}]},{"block_type":"text","content":"will be executed immediately without waiting for the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"p"}]},{"block_type":"text","content":"process to finish. To wait for the task completion, you can use the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Process.join"}]},{"block_type":"text","content":"&nbsp;method, as follows:"}]},{"block_type":"element","block":"k68ocoo5","search_text":"if __name__ == '__main__': p = Process(0) p.start() p.join() ","text_count":61,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if __name__ == '__main__': \n       p = Process(0) \n       p.start() \n       p.join()"}]}]},{"block_type":"element","block":"k68ocoo6","search_text":"We can launch four different processes that will run parallely in the same way. In a serial program, the total required time will be four seconds. Since the execution is concurrent, the resulting wallclock time will be of one second. In the following code, we create four processes that will execute concurrently:","text_count":313,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can launch four different processes that will run parallely in the same way. In a serial program, the total required time will be four seconds. Since the execution is concurrent, the&nbsp;resulting wallclock time will be of one second. In the following code, we create four processes that will execute concurrently:"}]},{"block_type":"element","block":"k68ocoo7","search_text":"if __name__ == '__main__': processes = Process(1), Process(2), Process(3), Process(4) [p.start() for p in processes] ","text_count":117,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if __name__ == '__main__': \n        processes = Process(1), Process(2), Process(3), Process(4) \n        [p.start() for p in processes]"}]}]},{"block_type":"element","block":"k68ocoo8","search_text":"Note that the order of the execution for parallel processes is unpredictable and ultimately depends on how the OS schedules their execution. You can verify this behavior by executing the program multiple times; the order will likely be different between runs.","text_count":259,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that the order of the execution for parallel processes is unpredictable and ultimately depends on how the OS&nbsp;schedules their execution. You can verify this behavior by executing the program multiple times; the order will likely be different between runs."}]},{"block_type":"element","block":"k68ocoo9","search_text":"The multiprocessing module exposes a convenient interface that makes it easy to assign and distribute tasks to a set of processes that reside in the multiprocessing.Pool class.","text_count":176,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing"}]},{"block_type":"text","content":"module exposes a convenient interface that makes it easy to assign and distribute tasks to a set of processes that&nbsp;reside in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing.Pool"}]},{"block_type":"text","content":"class."}]},{"block_type":"element","block":"k68ocooa","search_text":"The multiprocessing.Pool class spawns a set of processes--called workers --and lets us submit tasks through the apply / apply_async and map / map_async methods.","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing.Pool"}]},{"block_type":"text","content":"class spawns a set of processes--called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"workers"}]},{"block_type":"text","content":"--and lets us submit tasks through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"apply"}]},{"block_type":"text","content":"/"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"apply_async"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"/"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map_async"}]},{"block_type":"text","content":"&nbsp;methods."}]},{"block_type":"element","block":"k68ocoob","search_text":"The Pool.map method applies a function to each element of a list and returns the list of results. Its usage is equivalent to the built-in (serial) map .","text_count":152,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Pool.map"}]},{"block_type":"text","content":"method applies a function to each element of a list and returns the list of results. Its usage is equivalent to the built-in (serial)"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocooc","search_text":"To use a parallel map, you should first initialize a multiprocessing.Pool object. It takes the number of workers as its first argument; if not provided, that number will be equal to the number of cores in the system. You can initialize a multiprocessing.Pool object in the following way:","text_count":287,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To use a parallel map, you should first initialize a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing.Pool"}]},{"block_type":"text","content":"object. It takes the number of workers as its first argument; if not provided, that number will be equal to the number of cores in the system. You can initialize a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing.Pool"}]},{"block_type":"text","content":"object in the following way:"}]},{"block_type":"element","block":"k68ocood","search_text":"pool = multiprocessing.Pool() pool = multiprocessing.Pool(processes=4) ","text_count":71,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"pool = multiprocessing.Pool() \n    pool = multiprocessing.Pool(processes=4)"}]}]},{"block_type":"element","block":"k68ocooe","search_text":"Let's see pool.map in action. If you have a function that computes the square of a number, you can map the function to the list by calling Pool.map and passing the function and the list of inputs as arguments, as follows:","text_count":221,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pool.map"}]},{"block_type":"text","content":"in action. If you have a function that computes the square of a number, you can map the function to the list by calling"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Pool.map"}]},{"block_type":"text","content":"and passing the function and the list of inputs as arguments, as follows:"}]},{"block_type":"element","block":"k68ocoof","search_text":"def square(x): return x * x inputs = [0, 1, 2, 3, 4] outputs = pool.map(square, inputs) ","text_count":88,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def square(x): \n        return x * x \n\n    inputs = [0, 1, 2, 3, 4] \n    outputs = pool.map(square, inputs)"}]}]},{"block_type":"element","block":"k68ocoog","search_text":"The Pool.map_async function is just like Pool.map but returns an AsyncResult object instead of the actual result. When we call Pool.map , the execution of the main program is stopped until all the workers are finished processing the result. With map_async , the AsyncResult object is returned immediately without blocking the main program and the calculations are done in the background. We can then retrieve the result using the AsyncResult.get method at any time, as shown in the following lines:","text_count":498,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Pool.map_async"}]},{"block_type":"text","content":"function is just like"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Pool.map"}]},{"block_type":"text","content":"but returns an"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"AsyncResult"}]},{"block_type":"text","content":"object instead of the actual result. When we call &nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Pool.map"}]},{"block_type":"text","content":", the execution of the main program is stopped until all the workers are finished processing the result. With"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map_async"}]},{"block_type":"text","content":", the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"AsyncResult"}]},{"block_type":"text","content":"object is returned immediately without blocking the main program and the calculations are done in the background. We can then retrieve the result using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"AsyncResult.get"}]},{"block_type":"text","content":"method at any time, as shown in the following lines:"}]},{"block_type":"element","block":"k68ocooh","search_text":"outputs_async = pool.map_async(square, inputs) outputs = outputs_async.get() ","text_count":77,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"outputs_async = pool.map_async(square, inputs) \n    outputs = outputs_async.get()"}]}]},{"block_type":"element","block":"k68ocooi","search_text":"Pool.apply_async assigns a task consisting of a single function to one of the workers. It takes the function and its arguments and returns an AsyncResult object. We can obtain an effect similar to map using apply_async , as shown:","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Pool.apply_async"}]},{"block_type":"text","content":"assigns a task consisting of a single function to one of the workers. It takes the function and its arguments and returns an"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"AsyncResult"}]},{"block_type":"text","content":"object. We can obtain an effect similar to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"&nbsp;using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"apply_async"}]},{"block_type":"text","content":", as shown:"}]},{"block_type":"element","block":"k68ocooj","search_text":"results_async = [pool.apply_async(square, i) for i in range(100))] results = [r.get() for r in results_async] ","text_count":110,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"results_async = [pool.apply_async(square, i) for i in range(100))] \n    results = [r.get() for r in results_async]"}]}]},{"block_type":"element","block":"k68ocook","search_text":"The Executor interface","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The Executor interface"}]},{"block_type":"element","block":"k68ocool","search_text":"From version 3.2 onward, it is possible to execute Python code in parallel using the Executor interface provided in the concurrent.futures module. We already saw the Executor interface in action in the previous chapter, when we used ThreadPoolExecutor to perform multiple tasks concurrently. In this subsection, we'll demonstrate the usage of the ProcessPoolExecutor class.","text_count":373,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From version 3.2 onward, it is possible to execute Python code in parallel using&nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Executor"}]},{"block_type":"text","content":"interface provided in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concurrent.futures"}]},{"block_type":"text","content":"module. We already saw the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Executor"}]},{"block_type":"text","content":"interface in action in the previous chapter, when we used&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ThreadPoolExecutor"}]},{"block_type":"text","content":"to perform&nbsp;multiple tasks concurrently. In this subsection, we'll demonstrate the usage of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ProcessPoolExecutor"}]},{"block_type":"text","content":"class."}]},{"block_type":"element","block":"k68ocoom","search_text":"ProcessPoolExecutor exposes a very lean interface, at least when compared to the more featureful multiprocessing.Pool . A ProcessPoolExecutor can be instantiated, similar to ThreadPoolExecutor , by passing a number of worker threads using the max_workers argument (by default, max_workers will be the number of CPU cores available). The main methods available to the ProcessPoolExecutor are submit and map .","text_count":407,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ProcessPoolExecutor"}]},{"block_type":"text","content":"&nbsp;exposes a&nbsp;very lean interface, at least when compared to the more featureful"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing.Pool"}]},{"block_type":"text","content":". A"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ProcessPoolExecutor"}]},{"block_type":"text","content":"can be instantiated, similar to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ThreadPoolExecutor"}]},{"block_type":"text","content":", by passing a number of worker threads using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max_workers"}]},{"block_type":"text","content":"argument (by default,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"max_workers"}]},{"block_type":"text","content":"will be the number of CPU cores available). The main methods available to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ProcessPoolExecutor"}]},{"block_type":"text","content":"&nbsp;are"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"submit"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocoon","search_text":"The submit method will take a function and return a Future (see the last chapter) that will keep track of the execution of the submitted function. The method map works similarly to the Pool.map function, except that it returns an iterator rather than a list:","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"submit"}]},{"block_type":"text","content":"method will take a function and return a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":"&nbsp;(see the last&nbsp;chapter) that will keep track of the execution of the submitted function. The method map works similarly to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Pool.map"}]},{"block_type":"text","content":"function, except that it returns an iterator rather than a list:"}]},{"block_type":"element","block":"k68ocooo","search_text":"from concurrent.futures import ProcessPoolExecutor executor = ProcessPoolExecutor(max_workers=4) fut = executor.submit(square, 2) # Result: # <Future at 0x7f5b5c030940 state=running> result = executor.map(square, [0, 1, 2, 3, 4]) list(result) # Result: # [0, 1, 4, 9, 16] ","text_count":272,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from concurrent.futures import ProcessPoolExecutor\n\n    executor = ProcessPoolExecutor(max_workers=4)\n    fut = executor.submit(square, 2)\n    # Result:\n    # &lt;Future at 0x7f5b5c030940 state=running&gt;\n\n    result = executor.map(square, [0, 1, 2, 3, 4])\n    list(result)\n    # Result:\n    # [0, 1, 4, 9, 16]"}]}]},{"block_type":"element","block":"k68ocoop","search_text":"To extract the result from one or more Future instances, you can use the concurrent.futures.wait and concurrent.futures.as_completed functions. The wait function accepts a list of future and will block the execution of the programs until all the futures have completed their execution. The result can then be extracted using the Future.result method. The as_completed function also accepts a function but will, instead, return an iterator over the results:","text_count":456,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To extract&nbsp;the result from one or more&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":"&nbsp;instances, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concurrent.futures.wait"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concurrent.futures.as_completed"}]},{"block_type":"text","content":"&nbsp;functions. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"wait"}]},{"block_type":"text","content":"function accepts a list of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"future"}]},{"block_type":"text","content":"and will block the execution of the programs until all the futures have completed their execution. The result can then be extracted using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future.result"}]},{"block_type":"text","content":"method. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"as_completed"}]},{"block_type":"text","content":"function also accepts a function but will, instead, return an iterator over the results:"}]},{"block_type":"element","block":"k68ocooq","search_text":"from concurrent.futures import wait, as_completed fut1 = executor.submit(square, 2) fut2 = executor.submit(square, 3) wait([fut1, fut2]) # Then you can extract the results using fut1.result() and fut2.result() results = as_completed([fut1, fut2]) list(results) # Result: # [4, 9] ","text_count":280,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from concurrent.futures import wait, as_completed\n\n    fut1 = executor.submit(square, 2)\n    fut2 = executor.submit(square, 3)\n    wait([fut1, fut2])\n    # Then you can extract the results using fut1.result() and fut2.result()\n\n    results = as_completed([fut1, fut2])\n    list(results)\n    # Result:\n    # [4, 9]"}]}]},{"block_type":"element","block":"k68ocoor","search_text":"Alternatively, you can generate futures using the asyncio.run_in_executor function and manipulate the results using all the tools and syntax provided by the asyncio libraries so that you can achieve concurrency and parallelism at the same time. ","text_count":245,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Alternatively, you can generate futures using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio.run_in_executor"}]},{"block_type":"text","content":"function and manipulate the results using all the tools and syntax provided by the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"asyncio"}]},{"block_type":"text","content":"libraries so that you can achieve concurrency and parallelism at the same time.&nbsp;&nbsp;"}]},{"block_type":"element","block":"k68ocoos","search_text":"Monte Carlo approximation of pi","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Monte Carlo approximation of pi"}]},{"block_type":"element","block":"k68ocoot","search_text":"As an example, we will implement a canonical, embarrassingly parallel program--the Monte Carlo approximation of pi . Imagine that we have a square of size 2 units; its area will be 4 units. Now, we inscribe a circle of 1 unit radius in this square; the area of the circle will be pi * r^2 . By substituting the value of r in the previous equation, we get that the numerical value for the area of the circle is pi * (1)^2 = pi . You can refer to the following figure for a graphical representation.","text_count":497,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As an example, we will implement a canonical, embarrassingly&nbsp;parallel program--the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Monte Carlo approximation of pi"}]},{"block_type":"text","content":". Imagine that we have a square of size 2 units; its area will be 4 units. Now, we inscribe a circle of 1 unit radius in this square; the area of the circle will be"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pi * r^2"}]},{"block_type":"text","content":". By substituting the value of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"r"}]},{"block_type":"text","content":"in the previous equation, we get that the numerical value for the area of the circle is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pi * (1)^2 = pi"}]},{"block_type":"text","content":". You can refer to the following figure for a graphical representation."}]},{"block_type":"element","block":"k68ocoou","search_text":"If we shoot a lot of random points on this figure, some points will fall into the circle, which we'll call hits, while the remaining points, misses, will be outside the circle. The area of the circle will be proportional to the number of hits, while the area of the square will be proportional to the total number of shots. To get the value of pi , it is sufficient to divide the area of the circle (equal to pi ) by the area of the square (equal to 4):","text_count":453,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we shoot a lot of random points on this figure, some points will fall into the circle, which we'll call&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"hits,&nbsp;"}]},{"block_type":"text","content":"while the remaining points,&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"misses,&nbsp;"}]},{"block_type":"text","content":"will be outside the circle. The area of the circle will be proportional to the number of hits, while the area of the square will be proportional to the total number of shots. To get the value of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pi"}]},{"block_type":"text","content":", it is sufficient to divide the area of the circle (equal to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pi"}]},{"block_type":"text","content":") by the area of the square (equal to 4):"}]},{"block_type":"element","block":"k68ocoov","search_text":"hits/total = area_circle/area_square = pi/4 pi = 4 * hits/total ","text_count":64,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"hits/total = area_circle/area_square = pi/4 \n    pi = 4 * hits/total"}]}]},{"block_type":"element","block":"k68ocoow","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000039.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocoox","search_text":"The strategy we will employ in our program will be as follows:","text_count":62,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The strategy we will employ in our program will be as follows:"}]},{"block_type":"element","block":"k68ocooy","search_text":"Generate a lot of uniformly random ( x , y ) numbers in the range ( -1 , 1 ) Test whether those numbers lie inside the circle by checking whether x**2 + y**2 <= 1 ","text_count":163,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Generate a lot of uniformly random&nbsp;("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":") numbers in the range ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"-1"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Test whether&nbsp;those numbers lie inside the circle by checking whether&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x**2 + y**2"}]},{"block_type":"text","content":"&lt;="},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"1"}]}]}]},{"block_type":"element","block":"k68ocooz","search_text":"The first step when writing a parallel program is to write a serial version and verify that it works. In a real-world scenario, you also want to leave the parallelization as the last step of your optimization process. First, we need to identify the slow parts, and second, parallelization is time-consuming and gives you at most a speedup equal to the number of processors. The implementation of the serial program is as follows:","text_count":429,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first step when writing a parallel program is to write a serial version and verify&nbsp;that it works. In a real-world scenario, you also want to leave the parallelization as the last step of your optimization process. First, we need to identify the slow parts, and second, parallelization is time-consuming and gives you"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"at most"}]},{"block_type":"text","content":"a speedup equal to the number of processors. The implementation of the serial program is as follows:"}]},{"block_type":"element","block":"k68ocop0","search_text":"import random samples = 1000000 hits = 0 for i in range(samples): x = random.uniform(-1.0, 1.0) y = random.uniform(-1.0, 1.0) if x**2 + y**2 <= 1: hits += 1 pi = 4.0 * hits/samples ","text_count":181,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import random \n\n    samples = 1000000 \n    hits = 0 \n\n    for i in range(samples): \n        x = random.uniform(-1.0, 1.0) \n        y = random.uniform(-1.0, 1.0) \n\n        if x**2 + y**2 &lt;= 1: \n            hits += 1 \n     \n    pi = 4.0 * hits/samples"}]}]},{"block_type":"element","block":"k68ocop1","search_text":"The accuracy of our approximation will improve as we increase the number of samples. You can note that each loop iteration is independent from the other--this problem is embarrassingly parallel.","text_count":194,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The accuracy of our approximation will improve as we increase the number of samples. You can note that each loop iteration is independent from the other--this problem is embarrassingly parallel."}]},{"block_type":"element","block":"k68ocop2","search_text":"To parallelize this code, we can write a function, called sample , that corresponds to a single hit-miss check. If the sample hits the circle, the function will return 1 ; otherwise, it will return 0 . By running sample multiple times and summing the results, we'll get the total number of hits. We can run sample over multiple processors with apply_async and get the results in the following way:","text_count":397,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To parallelize this code, we can write a function, called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sample"}]},{"block_type":"text","content":", that corresponds to a single hit-miss check. If the sample hits the circle, the function will return"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"; otherwise, it will return"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":". By running"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sample"}]},{"block_type":"text","content":"multiple times and summing the results, we'll get the total number of hits. We can run"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sample"}]},{"block_type":"text","content":"over multiple processors with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"apply_async"}]},{"block_type":"text","content":"and get the results in the following way:"}]},{"block_type":"element","block":"k68ocop3","search_text":"def sample(): x = random.uniform(-1.0, 1.0) y = random.uniform(-1.0, 1.0) if x**2 + y**2 <= 1: return 1 else: return 0 pool = multiprocessing.Pool() results_async = [pool.apply_async(sample) for i in range(samples)] hits = sum(r.get() for r in results_async) ","text_count":259,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def sample(): \n        x = random.uniform(-1.0, 1.0) \n        y = random.uniform(-1.0, 1.0) \n\n        if x**2 + y**2 &lt;= 1: \n            return 1 \n        else: \n            return 0 \n\n    pool = multiprocessing.Pool() \n    results_async = [pool.apply_async(sample) for i in range(samples)] \n    hits = sum(r.get() for r in results_async)"}]}]},{"block_type":"element","block":"k68ocop4","search_text":"We can wrap the two versions in the pi_serial and pi_apply_async functions (you can find their implementation in the pi.py file) and benchmark the execution speed, as follows:","text_count":175,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can wrap the two versions in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pi_serial"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pi_apply_async"}]},{"block_type":"text","content":"&nbsp;functions (you can find their implementation in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pi.py"}]},{"block_type":"text","content":"file) and benchmark the execution speed, as follows:"}]},{"block_type":"element","block":"k68ocop5","search_text":"$ time python -c 'import pi; pi.pi_serial()' real 0m0.734s user 0m0.731s sys 0m0.004s $ time python -c 'import pi; pi.pi_apply_async()' real 1m36.989s user 1m55.984s sys 0m50.386 ","text_count":179,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ time python -c 'import pi; pi.pi_serial()'\nreal    0m0.734s\nuser    0m0.731s\nsys     0m0.004s\n$ time python -c 'import pi; pi.pi_apply_async()'\nreal    1m36.989s\nuser    1m55.984s\nsys     0m50.386"}]}]},{"block_type":"element","block":"k68ocop6","search_text":"As shown in the earlier benchmark, our first parallel version literally cripples our code. The reason is that the time spent doing the actual calculation is small compared to the overhead required to send and distribute the tasks to the workers.","text_count":245,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As shown in the earlier&nbsp;benchmark, our first parallel version literally cripples our code. The reason is that the time spent doing the actual calculation is small compared to the overhead required to send and distribute the tasks to the workers."}]},{"block_type":"element","block":"k68ocop7","search_text":"To solve the issue, we have to make the overhead negligible compared to the calculation time. For example, we can ask each worker to handle more than one sample at a time, thus reducing the task communication overhead. We can write a sample_multiple function that processes more than one hit and modifies our parallel version by dividing our problem by 10; more intensive tasks are shown in the following code:","text_count":410,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To solve the issue, we have to make the overhead negligible compared to the calculation time. For example, we can ask each worker to handle more than one sample at a time, thus reducing the task communication overhead. We can write a&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sample_multiple"}]},{"block_type":"text","content":"&nbsp;function that processes more than one hit and modifies our parallel version by dividing our problem by 10; more intensive tasks are shown in the following code:"}]},{"block_type":"element","block":"k68ocop8","search_text":"def sample_multiple(samples_partial): return sum(sample() for i in range(samples_partial)) n_tasks = 10 chunk_size = samples/n_tasks pool = multiprocessing.Pool() results_async = [pool.apply_async(sample_multiple, chunk_size) for i in range(n_tasks)] hits = sum(r.get() for r in results_async) ","text_count":294,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def sample_multiple(samples_partial): \n        return sum(sample() for i in range(samples_partial)) \n\n    n_tasks = 10 \n    chunk_size = samples/n_tasks \n    pool = multiprocessing.Pool() \n    results_async = [pool.apply_async(sample_multiple, chunk_size) \n                     for i in range(n_tasks)] \n    hits = sum(r.get() for r in results_async)"}]}]},{"block_type":"element","block":"k68ocop9","search_text":"We can wrap this in a function called pi_apply_async_chunked and run it as follows:","text_count":83,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can wrap this in a function called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pi_apply_async_chunked"}]},{"block_type":"text","content":"and run it as follows:"}]},{"block_type":"element","block":"k68ocopa","search_text":"$ time python -c 'import pi; pi.pi_apply_async_chunked()' real 0m0.325s user 0m0.816s sys 0m0.008s ","text_count":99,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ time python -c 'import pi; pi.pi_apply_async_chunked()'\nreal    0m0.325s\nuser    0m0.816s\nsys     0m0.008s"}]}]},{"block_type":"element","block":"k68ocopb","search_text":"The results are much better; we more than doubled the speed of our program. You can also notice that the user metric is larger than real ; the total CPU time is larger than the total time because more than one CPU worked at the same time. If you increase the number of samples, you will note that the ratio of communication to calculation decreases, giving even better speedups.","text_count":378,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The results are much better; we more than doubled the speed of our program. You can also notice that the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"user"}]},{"block_type":"text","content":"metric is larger than"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"real"}]},{"block_type":"text","content":"; the total CPU time is larger than the total time because more than one CPU worked at the same time. If you increase the number of samples, you will note that the ratio of communication to calculation decreases, giving even better speedups."}]},{"block_type":"element","block":"k68ocopc","search_text":"Everything is nice and simple when dealing with embarrassingly parallel problems. However, sometimes you have to share data between processes.","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Everything is nice and simple when dealing with embarrassingly parallel problems. However,&nbsp;sometimes you have to share data between processes."}]},{"block_type":"element","block":"k68ocopd","search_text":"Synchronization and locks","text_count":25,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Synchronization and locks"}]},{"block_type":"element","block":"k68ocope","search_text":"Even if multiprocessing uses processes (with their own independent memory), it lets you define certain variables and arrays as shared memory. You can define a shared variable using multiprocessing.Value , passing its data type as a string ( i integer, d double, f float, and so on). You can update the content of the variable through the value attribute, as shown in the following code snippet:","text_count":394,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even if"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing"}]},{"block_type":"text","content":"uses processes (with their own independent memory), it lets you define certain variables and arrays as shared memory. You can define a shared variable using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing.Value"}]},{"block_type":"text","content":", passing its data type as a string ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"i"}]},{"block_type":"text","content":"integer,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"d"}]},{"block_type":"text","content":"double,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"f"}]},{"block_type":"text","content":"float, and so on). You can update the content of the variable through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"value"}]},{"block_type":"text","content":"attribute, as shown in the following code snippet:"}]},{"block_type":"element","block":"k68ocopf","search_text":"shared_variable = multiprocessing.Value('f') shared_variable.value = 0 ","text_count":71,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"shared_variable = multiprocessing.Value('f') \n    shared_variable.value = 0"}]}]},{"block_type":"element","block":"k68ocopg","search_text":"When using shared memory, you should be aware of concurrent accesses. Imagine that you have a shared integer variable and each process increments its value multiple times. You will define a process class as follows:","text_count":215,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When using shared memory, you should be aware of concurrent accesses. Imagine that you have a shared integer variable and each process increments its value multiple times. You will define a process class as follows:"}]},{"block_type":"element","block":"k68ocoph","search_text":"class Process(multiprocessing.Process): def __init__(self, counter): super(Process, self).__init__() self.counter = counter def run(self): for i in range(1000): self.counter.value += 1 ","text_count":185,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class Process(multiprocessing.Process): \n\n        def __init__(self, counter): \n            super(Process, self).__init__() \n            self.counter = counter \n\n        def run(self): \n            for i in range(1000): \n                self.counter.value += 1"}]}]},{"block_type":"element","block":"k68ocopi","search_text":"You can initialize the shared variable in the main program and pass it to 4 processes, as shown in the following code:","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can initialize the shared variable in the main program and pass it to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"4"}]},{"block_type":"text","content":"processes, as shown in the following code:"}]},{"block_type":"element","block":"k68ocopj","search_text":"def main(): counter = multiprocessing.Value('i', lock=True) counter.value = 0 processes = [Process(counter) for i in range(4)] [p.start() for p in processes] [p.join() for p in processes] # processes are done print(counter.value) ","text_count":230,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def main(): \n        counter = multiprocessing.Value('i', lock=True) \n        counter.value = 0 \n\n        processes = [Process(counter) for i in range(4)] \n        [p.start() for p in processes] \n        [p.join() for p in processes] # processes are done \n        print(counter.value)"}]}]},{"block_type":"element","block":"k68ocopk","search_text":"If you run this program ( shared.py in the code directory), you will note that the final value of counter is not 4000, but it has random values (on my machine, they are between 2000 and 2500). If we assume that the arithmetic is correct, we can conclude that there's a problem with the parallelization.","text_count":302,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you run this program ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"shared.py"}]},{"block_type":"text","content":"in the code directory), you will note that the final value of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"counter"}]},{"block_type":"text","content":"is not 4000, but it has random values (on my machine, they are between 2000 and 2500). If we assume that the arithmetic is correct, we can conclude that there's a problem with the parallelization."}]},{"block_type":"element","block":"k68ocopl","search_text":"What happens is that multiple processes are trying to access the same shared variable at the same time. The situation is best explained by looking at the following figure. In a serial execution, the first process reads (the number 0 ), increments it, and writes the new value ( 1 ); the second process reads the new value ( 1 ), increments it, and writes it again ( 2 ).","text_count":370,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What happens is that multiple processes are trying to access the same shared variable at the same time. The situation is best explained by looking at the following figure. In a serial execution, the first process reads (the number"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"), increments it, and writes the new value ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"); the second process reads the new value ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"), increments it, and writes it again ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"2"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k68ocopm","search_text":"In the parallel execution, the two processes read ( 0 ), increment it, and write the value ( 1 ) at the same time, leading to a wrong answer:","text_count":141,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the parallel execution, the two processes read ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"), increment it, and write the value ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":") at the same time, leading to a wrong answer:"}]},{"block_type":"element","block":"k68ocopn","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000010.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocopo","search_text":"To solve this problem, we need to synchronize the access to this variable so that only one process at a time can access, increment, and write the value on the shared variable. This feature is provided by the multiprocessing.Lock class. A lock can be acquired and released through the acquire method and release , or using the lock as a context manager. Since the lock can be acquired by only one process at a time, this method prevents multiple processes from executing the protected section of code at the same time.","text_count":517,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"br","attributes":{},"children":[]},{"block_type":"text","content":"To solve this problem, we need to synchronize the access to this variable so that only one process at a time can access, increment, and write the value on the shared variable. This feature is provided by the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing.Lock"}]},{"block_type":"text","content":"class. A lock can be acquired and released through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"acquire"}]},{"block_type":"text","content":"method and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"release"}]},{"block_type":"text","content":", or using the lock as a context manager. Since the lock can be acquired by only one process at a time, this method prevents multiple processes from&nbsp;executing the protected section of code at the same time."}]},{"block_type":"element","block":"k68ocopp","search_text":"We can define a global lock and use it as a context manager to restrict the access to the counter, as shown in the following code snippet:","text_count":138,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can define a global&nbsp;lock and use it as a context manager to restrict the access to the counter, as shown in the following code snippet:"}]},{"block_type":"element","block":"k68ocopq","search_text":"lock = multiprocessing.Lock() class Process(multiprocessing.Process): def __init__(self, counter): super(Process, self).__init__() self.counter = counter def run(self): for i in range(1000): with lock: # acquire the lock self.counter.value += 1 # release the lock ","text_count":264,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"lock = multiprocessing.Lock() \n\n    class Process(multiprocessing.Process): \n\n        def __init__(self, counter): \n            super(Process, self).__init__() \n            self.counter = counter \n\n        def run(self): \n            for i in range(1000): \n                with lock: # acquire the lock \n                    self.counter.value += 1 \n                # release the lock"}]}]},{"block_type":"element","block":"k68ocopr","search_text":"Synchronization primitives, such as locks, are essential to solve many problems, but they should be kept to a minimum to improve the performance of your program.","text_count":161,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Synchronization primitives, such as locks, are essential to solve many problems, but they should be kept to a minimum to improve the performance of your program."}]},{"block_type":"element","block":"k68ocops","search_text":"Note The multiprocessing module includes other communication and synchronization tools; you can refer to the official documentation at http://docs.python.org/3/library/multiprocessing.html for a complete reference. ","text_count":215,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing"}]},{"block_type":"text","content":"&nbsp;module&nbsp;includes other communication and synchronization tools; you can refer to the official documentation at&nbsp;"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://docs.python.org/3/library/multiprocessing.html"},"children":[{"block_type":"text","content":"http://docs.python.org/3/library/multiprocessing.html"}]},{"block_type":"text","content":"&nbsp;for a complete reference."}]}]},{"block_type":"element","block":"k68ocopt","search_text":"Parallel Cython with OpenMP","text_count":27,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Parallel Cython with OpenMP"}]},{"block_type":"element","block":"k68ocopu","search_text":"Cython provides a convenient interface to perform shared-memory parallel processing through OpenMP . This lets you write extremely efficient parallel code directly in Cython without having to create a C wrapper.","text_count":211,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Cython provides a convenient interface to perform shared-memory parallel processing through"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"OpenMP"}]},{"block_type":"text","content":". This lets you write extremely efficient parallel code directly in Cython without having to create a C wrapper."}]},{"block_type":"element","block":"k68ocopv","search_text":"OpenMP is a specification and an API designed to write multithreaded, parallel programs. The OpenMP specification includes a series of C preprocessor directives to manage threads and provides communication patterns, load balancing, and other synchronization features. Several C/C++ and Fortran compilers (including GCC) implement the OpenMP API.","text_count":345,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"OpenMP is a specification and an API designed to write multithreaded, parallel programs. The OpenMP specification&nbsp;includes a series of C preprocessor directives to manage threads and provides communication patterns, load balancing, and other synchronization features. Several C/C++ and Fortran compilers (including GCC) implement the OpenMP API."}]},{"block_type":"element","block":"k68ocopw","search_text":"We can introduce the Cython parallel features with a small example. Cython provides a simple API based on OpenMP in the cython.parallel module. The simplest way to achieve parallelism is through prange , which is a construct that automatically distributes loop operations in multiple threads.","text_count":292,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can introduce the Cython parallel features with a small example. Cython provides a simple API based on OpenMP in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cython.parallel"}]},{"block_type":"text","content":"module. The simplest way to achieve parallelism is through&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"prange"}]},{"block_type":"text","content":", which is a construct that automatically distributes loop operations in multiple threads."}]},{"block_type":"element","block":"k68ocopx","search_text":"First of all, we can write the serial version of a program that computes the square of each element of a NumPy array in the hello_parallel.pyx file. We define a function, square_serial , that takes a buffer as input and populates an output array with the squares of the input array elements; square_serial is shown in the following code snippet:","text_count":345,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First of all, we can write the serial version of a program that computes the square of each element of a NumPy array in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hello_parallel.pyx"}]},{"block_type":"text","content":"file. We define a function,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"square_serial"}]},{"block_type":"text","content":", that takes a buffer as input and populates an output array with the squares of the input array elements;&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"square_serial"}]},{"block_type":"text","content":"&nbsp;is shown in the following code snippet:"}]},{"block_type":"element","block":"k68ocopy","search_text":"import numpy as np def square_serial(double[:] inp): cdef int i, size cdef double[:] out size = inp.shape[0] out_np = np.empty(size, 'double') out = out_np for i in range(size): out[i] = inp[i]*inp[i] return out_np ","text_count":215,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np \n\n    def square_serial(double[:] inp): \n        cdef int i, size \n        cdef double[:] out \n        size = inp.shape[0] \n        out_np = np.empty(size, 'double') \n        out = out_np \n\n        for i in range(size): \n            out[i] = inp[i]*inp[i] \n\n        return out_np"}]}]},{"block_type":"element","block":"k68ocopz","search_text":"Implementing a parallel version of the loop over the array elements involves substituting the range call with prange . There's a caveat--to use prange , it is necessary that the body of the loop is interpreter-free. As already explained, we need to release the GIL and, since interpreter calls generally acquire the GIL, they need to be avoided to make use of threads.","text_count":368,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Implementing a parallel version of the loop over the array elements involves substituting the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"range"}]},{"block_type":"text","content":"call with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"prange"}]},{"block_type":"text","content":". There's a caveat--to use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"prange"}]},{"block_type":"text","content":", it is necessary that the body of the loop is interpreter-free. As already explained, we need to release the GIL and, since interpreter calls generally acquire the GIL, they need to be avoided to make use of threads."}]},{"block_type":"element","block":"k68ocoq0","search_text":"In Cython, you can release the GIL using the nogil context, as follows:","text_count":71,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Cython, you can release the GIL using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nogil"}]},{"block_type":"text","content":"&nbsp;context, as follows:"}]},{"block_type":"element","block":"k68ocoq1","search_text":"with nogil: for i in prange(size): out[i] = inp[i]*inp[i] ","text_count":58,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"with nogil: \n        for i in prange(size): \n            out[i] = inp[i]*inp[i]"}]}]},{"block_type":"element","block":"k68ocoq2","search_text":"Alternatively, you can use the option nogil=True of prange that will automatically wrap the loop body in a nogil block:","text_count":119,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Alternatively, you can use the option"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nogil=True"}]},{"block_type":"text","content":"of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"prange"}]},{"block_type":"text","content":"that will automatically wrap the loop body in a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nogil"}]},{"block_type":"text","content":"block:"}]},{"block_type":"element","block":"k68ocoq3","search_text":"for i in prange(size, nogil=True): out[i] = inp[i]*inp[i] ","text_count":58,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"for i in prange(size, nogil=True): \n        out[i] = inp[i]*inp[i]"}]}]},{"block_type":"element","block":"k68ocoq4","search_text":"Attempts to call Python code in a prange block will produce an error. Prohibited operations include function calls, objects initialization, and so on. To enable such operations in a prange block (you may want to do so for debugging purposes), you have to re-enable the GIL using the with gil statement:","text_count":302,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Attempts to call Python code in a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"prange"}]},{"block_type":"text","content":"block will produce an error. Prohibited operations include function calls, objects initialization, and so on. To enable&nbsp;such operations in a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"prange"}]},{"block_type":"text","content":"block (you may want to do so for debugging purposes), you have to re-enable the GIL using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"with gil"}]},{"block_type":"text","content":"statement:"}]},{"block_type":"element","block":"k68ocoq5","search_text":"for i in prange(size, nogil=True): out[i] = inp[i]*inp[i] with gil: x = 0 # Python assignment ","text_count":94,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"for i in prange(size, nogil=True): \n        out[i] = inp[i]*inp[i] \n        with gil:   \n            x = 0 # Python assignment"}]}]},{"block_type":"element","block":"k68ocoq6","search_text":"We can now test our code by compiling it as a Python extension module. To enable OpenMP support, it is necessary to change the setup.py file so that it includes the compilation option -fopenmp . This can be achieved by using the distutils.extension.Extension class in distutils and passing it to cythonize . The complete setup.py file is as follows:","text_count":349,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now test our code by compiling it as a Python extension module. To enable OpenMP support, it is necessary to change the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup.py"}]},{"block_type":"text","content":"&nbsp;file so that it includes the compilation option"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-fopenmp"}]},{"block_type":"text","content":"&nbsp;. This can be achieved by using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"distutils.extension.Extension"}]},{"block_type":"text","content":"class in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"distutils"}]},{"block_type":"text","content":"and passing it to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cythonize"}]},{"block_type":"text","content":". The complete"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup.py"}]},{"block_type":"text","content":"file is as follows:"}]},{"block_type":"element","block":"k68ocoq7","search_text":"from distutils.core import setup from distutils.extension import Extension from Cython.Build import cythonize hello_parallel = Extension('hello_parallel', ['hello_parallel.pyx'], extra_compile_args=['-fopenmp'], extra_link_args=['-fopenmp']) setup( name='Hello', ext_modules = cythonize(['cevolve.pyx', hello_parallel]), ) ","text_count":323,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from distutils.core import setup \n    from distutils.extension import Extension \n    from Cython.Build import cythonize \n\n    hello_parallel = Extension('hello_parallel', \n                               ['hello_parallel.pyx'], \n                                extra_compile_args=['-fopenmp'], \n                                extra_link_args=['-fopenmp']) \n\n    setup( \n       name='Hello', \n       ext_modules = cythonize(['cevolve.pyx', hello_parallel]), \n    )"}]}]},{"block_type":"element","block":"k68ocoq8","search_text":"Using prange , we can easily parallelize the Cython version of our ParticleSimulator . The following code contains the c_evolve function of the cevolve.pyx Cython module that was written in Chapter 4, C Performance with Cython :","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"prange"}]},{"block_type":"text","content":", we can easily parallelize the Cython version of our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ParticleSimulator"}]},{"block_type":"text","content":". The following code contains the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"c_evolve"}]},{"block_type":"text","content":"function of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cevolve.pyx"}]},{"block_type":"text","content":"Cython module that was written in Chapter 4,&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"C Performance with Cython"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocoq9","search_text":"def c_evolve(double[:, :] r_i,double[:] ang_speed_i, double timestep,int nsteps): # cdef declarations for i in range(nsteps): for j in range(nparticles): # loop body ","text_count":166,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def c_evolve(double[:, :] r_i,double[:] ang_speed_i, \n                 double timestep,int nsteps): \n\n        # cdef declarations \n\n        for i in range(nsteps): \n            for j in range(nparticles): \n                # loop body"}]}]},{"block_type":"element","block":"k68ocoqa","search_text":"First, we will invert the order of the loops so that the outermost loop will be executed in parallel (each iteration is independent from the other). Since the particles don't interact with each other, we can change the order of iteration safely, as shown in the following snippet:","text_count":280,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First,&nbsp;we will invert the order of the loops so that the outermost loop&nbsp;will be executed in parallel (each iteration is independent from the other). Since the particles don't interact with each other, we can change the order of iteration safely, as shown in the following snippet:"}]},{"block_type":"element","block":"k68ocoqb","search_text":"for j in range(nparticles): for i in range(nsteps): # loop body ","text_count":64,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"for j in range(nparticles): \n            for i in range(nsteps): \n\n                # loop body"}]}]},{"block_type":"element","block":"k68ocoqc","search_text":"Next, we will replace the range call of the outer loop with prange and remove calls that acquire the GIL. Since our code was already enhanced with static types, the nogil option can be applied safely as follows:","text_count":211,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, we will replace the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"range"}]},{"block_type":"text","content":"call of the outer loop with &nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"prange"}]},{"block_type":"text","content":"and remove calls that acquire the GIL. Since our code was already enhanced with static types, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nogil"}]},{"block_type":"text","content":"&nbsp;option can be applied safely as follows:"}]},{"block_type":"element","block":"k68ocoqd","search_text":"for j in prange(nparticles, nogil=True) ","text_count":40,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"for j in prange(nparticles, nogil=True)"}]}]},{"block_type":"element","block":"k68ocoqe","search_text":"We can now compare the functions by wrapping them in the benchmark function to assess any performance improvement:","text_count":114,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now compare the functions by wrapping them in the benchmark function to assess any performance improvement:"}]},{"block_type":"element","block":"k68ocoqf","search_text":"In [3]: %timeit benchmark(10000, 'openmp') # Running on 4 processors 1 loops, best of 3: 599 ms per loop In [4]: %timeit benchmark(10000, 'cython') 1 loops, best of 3: 1.35 s per loop ","text_count":184,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"In [3]: %timeit benchmark(10000, 'openmp') # Running on 4 processors\n    1 loops, best of 3: 599 ms per loop \n    In [4]: %timeit benchmark(10000, 'cython') \n    1 loops, best of 3: 1.35 s per loop"}]}]},{"block_type":"element","block":"k68ocoqg","search_text":"Interestingly, we achieved a 2x speedup by writing a parallel version using prange . ","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Interestingly, we achieved a 2x speedup by writing a parallel version using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"prange"}]},{"block_type":"text","content":". &nbsp;"}]},{"block_type":"element","block":"k68ocoqh","search_text":"Automatic parallelism","text_count":21,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Automatic parallelism"}]},{"block_type":"element","block":"k68ocoqi","search_text":"As we mentioned earlier, normal Python programs have trouble achieving thread parallelism because of the GIL. So far, we worked around this problem using separate processes; starting a process, however, takes significantly more time and memory than starting a thread.","text_count":267,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we mentioned earlier, normal Python programs have trouble achieving thread parallelism because of the GIL. So far, we worked around this problem using separate processes; starting a process, however, takes significantly more time and memory than starting a thread."}]},{"block_type":"element","block":"k68ocoqj","search_text":"We also saw that sidestepping the Python environment allowed us to achieve a 2x speedup on an already fast Cython code. This strategy allowed us to achieve lightweight parallelism but required a separate compilation step. In this section, we will further explore this strategy using special libraries that are capable of automatically translating our code into a parallel version for efficient execution.","text_count":404,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We also saw that sidestepping the Python environment allowed us to achieve a 2x speedup on an already fast Cython code. This strategy allowed us to achieve lightweight parallelism but required a separate compilation step. In this section, we will further explore this strategy using special libraries that are capable of automatically translating our code into a parallel version for efficient execution."}]},{"block_type":"element","block":"k68ocoqk","search_text":"Examples of packages that implement automatic parallelism are the (by now) familiar JIT compilers numexpr and Numba. Other packages have been developed to automatically optimize and parallelize array and matrix-intensive expressions, which are crucial in specific numerical and machine learning applications.","text_count":308,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Examples of packages that implement automatic parallelism are the (by now) familiar JIT compilers &nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"numexpr"}]},{"block_type":"text","content":"and Numba. Other packages have been developed to automatically optimize and parallelize array and matrix-intensive expressions, which are crucial in specific numerical and machine learning applications."}]},{"block_type":"element","block":"k68ocoql","search_text":"Theano is a project that allows you to define a mathematical expression on arrays (more generally, tensors ), and compile them to a fast language, such as C or C++. Many of the operations that Theano implements are parallelizable and can run on both CPU and GPU.","text_count":262,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Theano"}]},{"block_type":"text","content":"is a project that allows you to define a mathematical expression on arrays (more generally,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"tensors"}]},{"block_type":"text","content":"), and compile them to a fast language, such as C or C++. Many of the operations that Theano implements are parallelizable and can run on both CPU and GPU."}]},{"block_type":"element","block":"k68ocoqm","search_text":"Tensorflow is another library that, similar to Theano, is targeted towards expression of array-intensive mathematical expression but, rather than translating the expressions to specialized C code, executes the operations on an efficient C++ engine.","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Tensorflow"}]},{"block_type":"text","content":"is another library that, similar to Theano, is targeted towards&nbsp;expression of array-intensive mathematical expression but, rather than translating the expressions to specialized C code, executes the operations on an&nbsp;efficient C++ engine."}]},{"block_type":"element","block":"k68ocoqn","search_text":"Both Theano and Tensorflow are ideal when the problem at hand can be expressed in a chain of matrix and element-wise operations (such as neural networks ).","text_count":155,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Both Theano and Tensorflow are ideal when the problem at hand can be expressed in a chain&nbsp;of matrix and element-wise operations (such as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"neural networks"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k68ocoqo","search_text":"Getting started with Theano","text_count":27,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Getting started with Theano"}]},{"block_type":"element","block":"k68ocoqp","search_text":"Theano is somewhat similar to a compiler but with the added bonuses of being able to express, manipulate, and optimize mathematical expressions as well as run code on CPU and GPU. Since 2010, Theano has improved release after release and has been adopted by several other Python projects as a way to automatically generate efficient computational models on the fly.","text_count":365,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Theano is somewhat similar to a compiler but with the added bonuses of being able to express, manipulate, and optimize mathematical expressions as well as run code on CPU and GPU. Since 2010, Theano has improved release after release and has been adopted by several other Python projects as a way to automatically generate efficient computational models on the fly."}]},{"block_type":"element","block":"k68ocoqq","search_text":"In Theano, you first define the function you want to run by specifying variables and transformation using a pure Python API. This specification will then be compiled to machine code for execution.","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Theano, you first"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"define"}]},{"block_type":"text","content":"the function you want to run by specifying variables and transformation using a pure Python API. This specification will then be compiled to machine code for execution."}]},{"block_type":"element","block":"k68ocoqr","search_text":"As a first example, let's examine how to implement a function that computes the square of a number. The input will be represented by a scalar variable, a , and then we will transform it to obtain its square, indicated by a_sq . In the following code, we will use the T.scalar function to define the variable and use the normal ** operator to obtain a new variable:","text_count":364,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a first example, let's examine how to implement a function that computes the square of a number. The input will be represented by a scalar variable,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":", and then we will transform it to obtain its square, indicated by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a_sq"}]},{"block_type":"text","content":". In the following code, we will use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"T.scalar"}]},{"block_type":"text","content":"function to define the variable and use the normal"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"**"}]},{"block_type":"text","content":"operator to obtain a new variable:"}]},{"block_type":"element","block":"k68ocoqs","search_text":"import theano.tensor as T import theano as th a = T.scalar('a') a_sq = a ** 2 print(a_sq) # Output: # Elemwise{pow,no_inplace}.0 ","text_count":129,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import theano.tensor as T\n    import theano as th\n    a = T.scalar('a')\n    a_sq = a ** 2\n    print(a_sq)\n    # Output:\n    # Elemwise{pow,no_inplace}.0"}]}]},{"block_type":"element","block":"k68ocoqt","search_text":"As you can see, no specific value is computed and the transformation we apply is purely symbolic. In order to use this transformation, we need to generate a function. To compile a function, you can use the th.function utility that takes a list of the input variables as its first argument, and the output transformation (in our case a_sq ) as its second argument:","text_count":363,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, no specific value is computed and the transformation we apply is purely symbolic. In order to use this transformation, we need to generate a function. To compile a function, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"th.function"}]},{"block_type":"text","content":"utility that&nbsp;takes a list of the input variables as its&nbsp;first argument, and the output transformation (in our case"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a_sq"}]},{"block_type":"text","content":") as its second argument:"}]},{"block_type":"element","block":"k68ocoqu","search_text":"compute_square = th.function([a], a_sq) ","text_count":40,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"compute_square = th.function([a], a_sq)"}]}]},{"block_type":"element","block":"k68ocoqv","search_text":"Theano will take some time and translate the expression to efficient C code and compile it, all in the background! The return value of th.function will be a ready-to-use Python function and its usage is demonstrated in the next line of code:","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Theano will take some time and translate the expression to efficient C code and compile it, all in the background! The return value of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"th.function"}]},{"block_type":"text","content":"will be a ready-to-use Python function and its usage is demonstrated in the next line of code:"}]},{"block_type":"element","block":"k68ocoqw","search_text":"compute_square(2) 4.0 ","text_count":22,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"compute_square(2)\n    4.0"}]}]},{"block_type":"element","block":"k68ocoqx","search_text":"Unsurprisingly, compute_square correctly returns the input value squared. Note, however, that the return type is not an integer (like the input type) but a floating point number. This is because the Theano default variable type is float64 . you can verify that by inspecting the dtype attribute of the a variable:","text_count":313,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Unsurprisingly,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"compute_square"}]},{"block_type":"text","content":"&nbsp;correctly returns the input value squared. Note, however, that the return type is not an integer (like the input type) but a floating point number. This is because the Theano default variable type is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"float64"}]},{"block_type":"text","content":". you can verify that by inspecting the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dtype"}]},{"block_type":"text","content":"attribute of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"&nbsp;variable:"}]},{"block_type":"element","block":"k68ocoqy","search_text":"a.dtype # Result: # float64 ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a.dtype\n    # Result: \n    # float64"}]}]},{"block_type":"element","block":"k68ocoqz","search_text":"The Theano behavior is very different compared to what we saw with Numba. Theano doesn't compile generic Python code and, also, doesn't do any type inference; defining Theano functions requires a more precise specification of the types involved.","text_count":245,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Theano behavior is very&nbsp;different compared&nbsp;to what we saw with&nbsp;Numba. Theano doesn't compile generic Python code and, also, doesn't do any type inference; defining Theano functions requires a more precise specification of the types involved."}]},{"block_type":"element","block":"k68ocor0","search_text":"The real power of Theano comes from its support for array expressions. Defining a one-dimensional vector can be done with the T.vector function; the returned variable supports broadcasting operations with the same semantics of NumPy arrays. For instance, we can take two vectors and compute the element-wise sum of their squares, as follows:","text_count":341,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The real power of Theano comes from its support for array expressions.&nbsp;Defining a one-dimensional vector can be done with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"T.vector"}]},{"block_type":"text","content":"function; the returned variable supports broadcasting operations with the same semantics of&nbsp;NumPy arrays. For instance, we can take two vectors and compute the element-wise sum of their squares, as follows:"}]},{"block_type":"element","block":"k68ocor1","search_text":"a = T.vector('a') b = T.vector('b') ab_sq = a**2 + b**2 compute_square = th.function([a, b], ab_sq) compute_square([0, 1, 2], [3, 4, 5]) # Result: # array([ 9., 17., 29.]) ","text_count":172,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = T.vector('a')\n    b = T.vector('b')\n    ab_sq = a**2 + b**2\n    compute_square = th.function([a, b], ab_sq)\n\n    compute_square([0, 1, 2], [3, 4, 5])\n    # Result:\n    # array([  9.,  17.,  29.])"}]}]},{"block_type":"element","block":"k68ocor2","search_text":"The idea is, again, to use the Theano API as a mini-language to combine various Numpy array expressions will be compiled to efficient machine code.","text_count":147,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The idea is, again, to use the Theano API as a mini-language to combine various Numpy array expressions will be compiled to efficient machine code."}]},{"block_type":"element","block":"k68ocor3","search_text":"Note One of the selling points of Theano is its ability to perform arithmetic simplifications and automatic gradient calculations. For more information, refer to the official documentation ( http://deeplearning.net/software/theano/introduction.html ). ","text_count":252,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the selling points of Theano is its ability to perform arithmetic&nbsp;simplifications and automatic gradient calculations. For more information, refer to the official documentation ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://deeplearning.net/software/theano/introduction.html"},"children":[{"block_type":"text","content":"http://deeplearning.net/software/theano/introduction.html"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k68ocor4","search_text":"To demonstrate Theano functionality on a familiar use case, we can implement our parallel calculation of pi again. Our function will take a collection of two random coordinates as input and return the pi estimate. The input random numbers will be defined as vectors named x and y , and we can test their position inside the circle using standard element-wise operation that we will store in the hit_test variable:","text_count":413,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate Theano functionality on a familiar use case, we can implement our parallel calculation of pi again. Our function will take a collection of two random coordinates as input and return the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pi"}]},{"block_type":"text","content":"estimate. The input&nbsp;random numbers will be defined as vectors named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":", and we can test their position inside the circle using standard element-wise operation that we will store in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hit_test"}]},{"block_type":"text","content":"variable:"}]},{"block_type":"element","block":"k68ocor5","search_text":"x = T.vector('x') y = T.vector('y') hit_test = x ** 2 + y ** 2 < 1 ","text_count":67,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"x = T.vector('x')\n    y = T.vector('y')\n\n    hit_test = x ** 2 + y ** 2 &lt; 1"}]}]},{"block_type":"element","block":"k68ocor6","search_text":"At this point, we need to count the number of True elements in hit_test , which can be done taking its sum (it will be implicitly cast to integer). To obtain the pi estimate, we finally need to calculate the ratio of hits versus the total number of trials. The calculation is illustrated in the following code block:","text_count":316,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we need to count the number of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"True"}]},{"block_type":"text","content":"elements in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hit_test"}]},{"block_type":"text","content":", which can be done taking its sum (it will be implicitly cast to integer). &nbsp;To obtain the pi estimate, we finally need to calculate the ratio of hits versus the total number of trials. The calculation is illustrated in the following code block:"}]},{"block_type":"element","block":"k68ocor7","search_text":"hits = hit_test.sum() total = x.shape[0] pi_est = 4 * hits/total ","text_count":65,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"hits = hit_test.sum()\n    total = x.shape[0]\n    pi_est = 4 * hits/total"}]}]},{"block_type":"element","block":"k68ocor8","search_text":"We can benchmark the execution of the Theano implementation using th.function and the timeit module. In our test, we will pass two arrays of size 30,000 and use the timeit.timeit utility to execute the calculate_pi function multiple times:","text_count":239,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can benchmark the execution of the Theano implementation using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"th.function"}]},{"block_type":"text","content":"and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"module. In our test, we will pass two arrays of size 30,000 and use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit.timeit"}]},{"block_type":"text","content":"&nbsp;utility to execute the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"calculate_pi"}]},{"block_type":"text","content":"function multiple times:"}]},{"block_type":"element","block":"k68ocor9","search_text":"calculate_pi = th.function([x, y], pi_est) x_val = np.random.uniform(-1, 1, 30000) y_val = np.random.uniform(-1, 1, 30000) import timeit res = timeit.timeit(\"calculate_pi(x_val, y_val)\", \"from __main__ import x_val, y_val, calculate_pi\", number=100000) print(res) # Output: # 10.905971487998613 ","text_count":295,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"calculate_pi = th.function([x, y], pi_est)\n\n    x_val = np.random.uniform(-1, 1, 30000)\n    y_val = np.random.uniform(-1, 1, 30000)\n\n    import timeit\n    res = timeit.timeit(\"calculate_pi(x_val, y_val)\", \n    \"from __main__ import x_val, y_val, calculate_pi\", number=100000)\n    print(res)\n    # Output:\n    # 10.905971487998613"}]}]},{"block_type":"element","block":"k68ocora","search_text":"The serial execution of this function takes about 10 seconds. Theano is capable of automatically parallelizing the code by implementing element-wise and matrix operations using specialized packages, such as OpenMP and the Basic Linear Algebra Subprograms ( BLAS ) linear algebra routines. Parallel execution can be enabled using configuration options.","text_count":351,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The serial execution of this function takes about 10 seconds. Theano is capable of automatically parallelizing the code by implementing element-wise and matrix operations using specialized packages, such as OpenMP and the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Basic Linear Algebra Subprograms"}]},{"block_type":"text","content":"&nbsp;("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"BLAS"}]},{"block_type":"text","content":")&nbsp;linear algebra routines. Parallel execution can be enabled using configuration options."}]},{"block_type":"element","block":"k68ocorb","search_text":"In Theano, you can set up configuration options by modifying variables in the theano.config object at import time. For example, you can issue the following commands to enable OpenMP support:","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Theano, you can set up configuration options by modifying variables in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"theano.config"}]},{"block_type":"text","content":"object&nbsp;at import time. For example, you can issue the following commands&nbsp;to enable OpenMP support:"}]},{"block_type":"element","block":"k68ocorc","search_text":"import theano theano.config.openmp = True theano.config.openmp_elemwise_minsize = 10 ","text_count":85,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import theano\ntheano.config.openmp = True\ntheano.config.openmp_elemwise_minsize = 10"}]}]},{"block_type":"element","block":"k68ocord","search_text":"The parameters relevant to OpenMP are as follows:","text_count":49,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The parameters relevant to OpenMP&nbsp;are as follows:"}]},{"block_type":"element","block":"k68ocore","search_text":"openmp_elemwise_minsize : This is an integer number that represents the minimum size of the arrays where element-wise parallelization should be enabled (the overhead of the parallelization can harm performance for small arrays) openmp : This is a Boolean flag that controls the activation of OpenMP compilation (it should be activated by default) ","text_count":347,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"openmp_elemwise_minsize"}]},{"block_type":"text","content":": This&nbsp;is an integer number that represents the minimum size of the arrays where element-wise parallelization should be enabled (the overhead of the parallelization can harm performance for small arrays)"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"openmp"}]},{"block_type":"text","content":": This is a Boolean flag that controls the activation of OpenMP compilation (it should be activated by default)"}]}]},{"block_type":"element","block":"k68ocorf","search_text":"Controlling the number of threads assigned for OpenMP execution can be done by setting the OMP_NUM_THREADS environmental variable before executing the code.","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Controlling the number of threads assigned for OpenMP execution can be done by setting the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"OMP_NUM_THREADS"}]},{"block_type":"text","content":"&nbsp;environmental variable before executing the code."}]},{"block_type":"element","block":"k68ocorg","search_text":"We can now write a simple benchmark to demonstrate the OpenMP usage in practice. In a file test_theano.py , we will put the complete code for the pi estimation example:","text_count":168,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now write&nbsp;a simple&nbsp;benchmark to demonstrate the OpenMP usage in practice. In a file"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_theano.py"}]},{"block_type":"text","content":", we will put the complete&nbsp;code&nbsp;for the pi estimation&nbsp;example:"}]},{"block_type":"element","block":"k68ocorh","search_text":"# File: test_theano.py import numpy as np import theano.tensor as T import theano as th th.config.openmp_elemwise_minsize = 1000 th.config.openmp = True x = T.vector('x') y = T.vector('y') hit_test = x ** 2 + y ** 2 <= 1 hits = hit_test.sum() misses = x.shape[0] pi_est = 4 * hits/misses calculate_pi = th.function([x, y], pi_est) x_val = np.random.uniform(-1, 1, 30000) y_val = np.random.uniform(-1, 1, 30000) import timeit res = timeit.timeit(\"calculate_pi(x_val, y_val)\", \"from __main__ import x_val, y_val, calculate_pi\", number=100000) print(res) ","text_count":552,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# File: test_theano.py\n    import numpy as np\n    import theano.tensor as T\n    import theano as th\n    th.config.openmp_elemwise_minsize = 1000\n    th.config.openmp = True\n\n    x = T.vector('x')\n    y = T.vector('y')\n\n    hit_test = x ** 2 + y ** 2 &lt;= 1\n    hits = hit_test.sum()\n    misses = x.shape[0]\n    pi_est = 4 * hits/misses\n\n    calculate_pi = th.function([x, y], pi_est)\n\n    x_val = np.random.uniform(-1, 1, 30000)\n    y_val = np.random.uniform(-1, 1, 30000)\n\n    import timeit\n    res = timeit.timeit(\"calculate_pi(x_val, y_val)\", \n                        \"from __main__ import x_val, y_val, \n                        calculate_pi\", number=100000)\n    print(res)"}]}]},{"block_type":"element","block":"k68ocori","search_text":"At this point, we can run the code from the command line and assess the scaling with an increasing number of threads by setting the OMP_NUM_THREADS environment variable:","text_count":169,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we can run the code from the command line and assess the scaling with an increasing number of&nbsp;threads by setting the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"OMP_NUM_THREADS"}]},{"block_type":"text","content":"&nbsp;environment variable:"}]},{"block_type":"element","block":"k68ocorj","search_text":"$ OMP_NUM_THREADS=1 python test_theano.py 10.905971487998613 $ OMP_NUM_THREADS=2 python test_theano.py 7.538279129999864 $ OMP_NUM_THREADS=3 python test_theano.py 9.405846934998408 $ OMP_NUM_THREADS=4 python test_theano.py 14.634153957000308 ","text_count":242,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ OMP_NUM_THREADS=1 python test_theano.py\n    10.905971487998613\n    $ OMP_NUM_THREADS=2 python test_theano.py\n    7.538279129999864\n    $ OMP_NUM_THREADS=3 python test_theano.py\n    9.405846934998408\n    $ OMP_NUM_THREADS=4 python test_theano.py\n    14.634153957000308"}]}]},{"block_type":"element","block":"k68ocork","search_text":"Interestingly, there is a small speedup when using two threads, but the performance degrades quickly as we increase their number. This means that for this input size, it is not advantageous to use more than two threads as the price you pay to start new threads and synchronize their shared data is higher than the speedup that you can obtain from the parallel execution. ","text_count":371,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Interestingly, there is a small speedup when using two threads, but the performance degrades quickly as we increase their number. This means that for this input size, it is not advantageous to use more than two threads as the price you pay to start new threads and synchronize their shared data is higher than the speedup that you can obtain from the parallel execution.&nbsp;"}]},{"block_type":"element","block":"k68ocorl","search_text":"Achieving good parallel performance can be tricky as it will depend on the specific operations and how they access the underlying data. As a general rule, measuring the performance of a parallel program is crucial and obtaining substantial speedups is a work of trial and error.","text_count":278,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Achieving good parallel performance can be tricky as it will depend on the specific operations and how they access the underlying data. As a general rule, measuring the performance of a parallel program is crucial and&nbsp;obtaining&nbsp;substantial speedups&nbsp;is a work of trial and error."}]},{"block_type":"element","block":"k68ocorm","search_text":"As an example, we can see that the parallel performance quickly degrades using a slightly different code. In our hit test, we used the sum method directly and relied on the explicit casting of the hit_tests Boolean array. If we make the cast explicit, Theano will generate a slightly different code that benefits less from multiple threads. We can modify the test_theano.py file to verify this effect:","text_count":401,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As an example, we can see that the parallel performance quickly degrades using a slightly different code. In our hit test, we used the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum"}]},{"block_type":"text","content":"method directly and relied on the explicit casting of the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hit_tests"}]},{"block_type":"text","content":"Boolean array. If we make the cast explicit, Theano will generate a slightly different code that benefits less from multiple threads. We can modify the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_theano.py"}]},{"block_type":"text","content":"file to verify this effect:"}]},{"block_type":"element","block":"k68ocorn","search_text":"# Older version # hits = hit_test.sum() hits = hit_test.astype('int32').sum() ","text_count":78,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# Older version\n    # hits = hit_test.sum()\n    hits = hit_test.astype('int32').sum()"}]}]},{"block_type":"element","block":"k68ocoro","search_text":"If we rerun our benchmark, we see that the number of threads does not affect the running time significantly. Despite that, the timings improved considerably as compared to the original version:","text_count":193,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we rerun our benchmark, we see that the number of threads does not affect the running time significantly. Despite that, the timings improved considerably as compared to the original version:"}]},{"block_type":"element","block":"k68ocorp","search_text":"$ OMP_NUM_THREADS=1 python test_theano.py 5.822126664999814 $ OMP_NUM_THREADS=2 python test_theano.py 5.697357518001809 $ OMP_NUM_THREADS=3 python test_theano.py 5.636914656002773 $ OMP_NUM_THREADS=4 python test_theano.py 5.764030176000233 ","text_count":240,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ OMP_NUM_THREADS=1 python test_theano.py\n    5.822126664999814\n    $ OMP_NUM_THREADS=2 python test_theano.py\n    5.697357518001809\n    $ OMP_NUM_THREADS=3 python test_theano.py \n    5.636914656002773\n    $ OMP_NUM_THREADS=4 python test_theano.py\n    5.764030176000233"}]}]},{"block_type":"element","block":"k68ocorq","search_text":"Profiling Theano","text_count":16,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Profiling Theano"}]},{"block_type":"element","block":"k68ocorr","search_text":"Given the importance of measuring and analyzing performance, Theano provides powerful and informative profiling tools. To generate profiling data, the only modification needed is the addition of the profile=True option to th.function :","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Given the importance of measuring and analyzing performance, Theano provides powerful and informative profiling tools. To generate profiling data, the only modification needed is the addition of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"profile=True"}]},{"block_type":"text","content":"option to&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"th.function"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocors","search_text":"calculate_pi = th.function([x, y], pi_est, profile=True) ","text_count":57,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"calculate_pi = th.function([x, y], pi_est, profile=True)"}]}]},{"block_type":"element","block":"k68ocort","search_text":"The profiler will collect data as the function is being run (for example, through timeit or direct invocation). The profiling summary can be printed to output by issuing the summary command, as follows:","text_count":202,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The profiler will collect data as the function is being run (for example,&nbsp;through"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timeit"}]},{"block_type":"text","content":"or direct invocation). The profiling summary can be printed to output by&nbsp;issuing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"summary"}]},{"block_type":"text","content":"command, as follows:"}]},{"block_type":"element","block":"k68ocoru","search_text":"calculate_pi.profile.summary() ","text_count":31,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"calculate_pi.profile.summary()"}]}]},{"block_type":"element","block":"k68ocorv","search_text":"To generate profiling data, we can rerun our script after adding the profile=True option (for this experiment, we will set the OMP_NUM_THREADS environmental variable to 1). Also, we will revert our script to the version that performed the casting of hit_tests implicitly.","text_count":271,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To generate profiling data, we can rerun our script after adding the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"profile=True"}]},{"block_type":"text","content":"option (for this experiment, we will set the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"OMP_NUM_THREADS"}]},{"block_type":"text","content":"environmental variable to 1). Also, we will revert our script to the version that performed the casting of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hit_tests"}]},{"block_type":"text","content":"implicitly."}]},{"block_type":"element","block":"k68ocorw","search_text":"Tip You can also set up profiling globally using the config.profile option. ","text_count":76,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can also set up profiling globally using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"config.profile"}]},{"block_type":"text","content":"option."}]}]},{"block_type":"element","block":"k68ocorx","search_text":"The output printed by calculate_pi.profile.summary() is quite long and informative. A part of it is reported in the next block of text. The output is comprised of three sections that refer to timings sorted by Class , Ops , and Apply . In our example, we are concerned with Ops , which roughly maps to the functions used in the Theano compiled code. As you can see, roughly 80% of the time is spent in taking the element-wise square and sum of the two numbers, while the rest of the time is spent calculating the sum:","text_count":517,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The output printed by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"calculate_pi.profile.summary()"}]},{"block_type":"text","content":"is quite long and informative. A part of it is reported in the next block of text. The output is comprised of three sections that refer to timings sorted by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Class"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Ops"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Apply"}]},{"block_type":"text","content":". In our example, we are concerned with&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Ops"}]},{"block_type":"text","content":", which&nbsp;roughly maps to the functions used in the Theano compiled code. As you can see, roughly 80% of the time is spent in taking the element-wise square and sum of the two numbers, while the rest of the time is spent calculating the sum:"}]},{"block_type":"element","block":"k68ocory","search_text":"Function profiling ================== Message: test_theano.py:15 ... other output Time in 100000 calls to Function.__call__: 1.015549e+01s ... other output Class --- <% time> <sum %> <apply time> <time per call> <type> <#call> <#apply> <Class name> .... timing info by class Ops --- <% time> <sum %> <apply time> <time per call> <type> <#call> <#apply> <Op name> 80.0% 80.0% 6.722s 6.72e-05s C 100000 1 Elemwise{Composite{LT((sqr(i0) + sqr(i1)), i2)}} 19.4% 99.4% 1.634s 1.63e-05s C 100000 1 Sum{acc_dtype=int64} 0.3% 99.8% 0.027s 2.66e-07s C 100000 1 Elemwise{Composite{((i0 * i1) / i2)}} 0.2% 100.0% 0.020s 2.03e-07s C 100000 1 Shape_i{0} ... (remaining 0 Ops account for 0.00%(0.00s) of the runtime) Apply ------ <% time> <sum %> <apply time> <time per call> <#call> <id> <Apply name> ... timing info by apply ","text_count":813,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Function profiling\n==================\n  Message: test_theano.py:15\n\n... other output\nTime in 100000 calls to Function.__call__: 1.015549e+01s\n... other output\n\nClass\n---\n&lt;% time&gt; &lt;sum %&gt; &lt;apply time&gt; &lt;time per call&gt; &lt;type&gt; &lt;#call&gt; &lt;#apply&gt; &lt;Class name&gt;\n.... timing info by class\n\nOps\n---\n&lt;% time&gt; &lt;sum %&gt; &lt;apply time&gt; &lt;time per call&gt; &lt;type&gt; &lt;#call&gt; &lt;#apply&gt; &lt;Op name&gt;\n  80.0%    80.0%       6.722s       6.72e-05s     C     100000        1   Elemwise{Composite{LT((sqr(i0) + sqr(i1)), i2)}}\n  19.4%    99.4%       1.634s       1.63e-05s     C     100000        1   Sum{acc_dtype=int64}\n   0.3%    99.8%       0.027s       2.66e-07s     C     100000        1   Elemwise{Composite{((i0 * i1) / i2)}}\n   0.2%   100.0%       0.020s       2.03e-07s     C     100000        1   Shape_i{0}\n   ... (remaining 0 Ops account for   0.00%(0.00s) of the runtime)\n\nApply\n------\n&lt;% time&gt; &lt;sum %&gt; &lt;apply time&gt; &lt;time per call&gt; &lt;#call&gt; &lt;id&gt; &lt;Apply name&gt;\n... timing info by apply"}]}]},{"block_type":"element","block":"k68ocorz","search_text":"This information is consistent with what was found in our first benchmark. The code went from about 11 seconds to roughly 8 seconds when two threads were used. From these numbers, we can analyze how the time was spent.","text_count":218,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This information is consistent with what was found in our first benchmark. The code went from&nbsp;about 11 seconds to roughly 8 seconds when two threads were used. From these numbers, we can analyze how the time was spent."}]},{"block_type":"element","block":"k68ocos0","search_text":"Out of these 11 seconds, 80% of the time (about 8.8 seconds) was spent doing element-wise operations. This means that, in perfectly parallel conditions, the increase in speed by adding two threads will be 4.4 seconds. In this scenario, the theoretical execution time will be 6.6 seconds. Considering that we obtained a timing of about 8 seconds, it looks like there is some extra overhead (1.4 seconds) for the thread usage.","text_count":424,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Out of these 11 seconds, 80% of the time (about 8.8 seconds) was spent doing element-wise operations. This means that, in perfectly parallel conditions, the increase in speed by adding two threads will be 4.4 seconds. In this scenario, the theoretical execution time will be 6.6 seconds. Considering that we obtained a timing of about 8 seconds, it looks like there is some extra overhead (1.4 seconds) for the thread usage."}]},{"block_type":"element","block":"k68ocos1","search_text":"Tensorflow","text_count":10,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Tensorflow"}]},{"block_type":"element","block":"k68ocos2","search_text":"Tensorflow is another library designed for fast numerical calculations and automatic parallelism. It was released as an open source project by Google in 2015. Tensorflow works by building mathematical expressions similar to Theano, except that the computation is not compiled to machine code but is executed on an external engine written in C++. Tensorflow supports execution and deployment of parallel codes on one or more CPUs and GPUs.","text_count":438,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Tensorflow is another library designed for fast numerical calculations and automatic&nbsp;parallelism. It was released as an open source project&nbsp;by Google in 2015. Tensorflow works by building mathematical expressions similar to Theano, except that the computation is not compiled to machine code but is executed on an external engine written in C++. Tensorflow supports execution and deployment of parallel codes on one or more CPUs and GPUs."}]},{"block_type":"element","block":"k68ocos3","search_text":"The usage of Tensorflow is quite similar to that of Theano. To create a variable in Tensorflow, you can use the tf.placeholder function that takes a data type as input:","text_count":168,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The usage of Tensorflow is quite similar to that of Theano. To create a variable in Tensorflow, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tf.placeholder"}]},{"block_type":"text","content":"&nbsp;function that takes a data type as input:"}]},{"block_type":"element","block":"k68ocos4","search_text":"import tensorflow as tf a = tf.placeholder('float64') ","text_count":54,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import tensorflow as tf\n\n    a = tf.placeholder('float64')"}]}]},{"block_type":"element","block":"k68ocos5","search_text":"Tensorflow mathematical expressions can be expressed quite similarly to Theano, except for a few different naming conventions as well as a more restricted support for the NumPy semantics.","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Tensorflow&nbsp;mathematical expressions can be expressed quite similarly to Theano, except for a few different naming conventions as well as a more restricted support for the NumPy semantics."}]},{"block_type":"element","block":"k68ocos6","search_text":"Tensorflow doesn't compile functions to C and then machine code like Theano, but serializes the defined mathematical functions (the data structure containing variables and transformations is called computation graph ) and executes them on specific devices. The configuration of devices and context can be done using the tf.Session object.","text_count":338,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Tensorflow doesn't compile functions to C and then machine code like Theano, but serializes the defined mathematical functions (the data structure containing variables and transformations is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"computation graph"}]},{"block_type":"text","content":")&nbsp;and executes them on specific devices. The configuration of devices and context can be done using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tf.Session"}]},{"block_type":"text","content":"object."}]},{"block_type":"element","block":"k68ocos7","search_text":"Once the desired expression is defined, a tf.Session needs to be initialized and can be used to execute computation graphs using the Session.run method. In the following example, we demonstrate the usage of the Tensorflow API to implement a simple element-wise sum of squares:","text_count":276,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once the desired expression is defined, a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tf.Session"}]},{"block_type":"text","content":"needs to be initialized and can be used to execute computation graphs using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Session.run"}]},{"block_type":"text","content":"&nbsp;method. In the following example, we demonstrate the usage of the Tensorflow API to implement&nbsp;a simple element-wise sum of squares:"}]},{"block_type":"element","block":"k68ocos8","search_text":"a = tf.placeholder('float64') b = tf.placeholder('float64') ab_sq = a**2 + b**2 with tf.Session() as session: result = session.run(ab_sq, feed_dict={a: [0, 1, 2], b: [3, 4, 5]}) print(result) # Output: # array([ 9., 17., 29.]) ","text_count":227,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"a = tf.placeholder('float64')\n    b = tf.placeholder('float64')\n    ab_sq = a**2 + b**2\n\n    with tf.Session() as session:\n        result = session.run(ab_sq, feed_dict={a: [0, 1, 2], \n                                               b: [3, 4, 5]})\n        print(result)\n    # Output:\n    # array([  9.,  17.,  29.])"}]}]},{"block_type":"element","block":"k68ocos9","search_text":"Parallelism in Tensorflow is achieved automatically by its smart execution engine, and it generally works well without much fiddling. However, note that it is mostly suited for deep learning workloads that involve the definition of complex functions that use a lot of matrix multiplications and calculate their gradient.","text_count":320,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Parallelism in Tensorflow&nbsp;is achieved automatically by its smart execution engine, and it generally works well without much fiddling. However, note that it is&nbsp;mostly suited for deep learning workloads that involve the definition of complex functions that use a lot of matrix multiplications and calculate their gradient."}]},{"block_type":"element","block":"k68ocosa","search_text":"We can now replicate the estimation of the pi example using Tensorflow capabilities and benchmark its execution speed and parallelism against the Theano implementation. What we will do is this:","text_count":193,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now replicate the estimation of the&nbsp;pi example using&nbsp;Tensorflow capabilities and benchmark its execution speed and parallelism against the Theano implementation. What we will do is this:"}]},{"block_type":"element","block":"k68ocosb","search_text":"Define our x and y variables and perform a hit test using broadcasted operations. Calculate the sum of hit_tests using the tf.reduce_sum function. Initialize a Session object with the inter_op_parallelism_threads and intra_op_parallelism_threads configuration options. These options control the number of threads used for different classes of parallel operations. Note that the first Session created with such options sets the number of threads for the whole script (even future Session instances). ","text_count":499,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Define our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"&nbsp;and&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"variables and perform a hit test using broadcasted operations."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Calculate the sum of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hit_tests"}]},{"block_type":"text","content":"using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tf.reduce_sum"}]},{"block_type":"text","content":"&nbsp;function."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Initialize a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Session"}]},{"block_type":"text","content":"object with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"inter_op_parallelism_threads"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"intra_op_parallelism_threads"}]},{"block_type":"text","content":"&nbsp;configuration options. These options control the number of threads used for different classes&nbsp;of parallel operations. Note that the first"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Session"}]},{"block_type":"text","content":"created with such options&nbsp;sets the&nbsp;number of threads for the whole script (even future"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Session"}]},{"block_type":"text","content":"instances)."}]}]},{"block_type":"element","block":"k68ocosc","search_text":"We can now write a script name, test_tensorflow.py , containing the following code. Note that the number of threads is passed as the first argument of the script ( sys.argv[1] ):","text_count":178,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now write a script name,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_tensorflow.py"}]},{"block_type":"text","content":", containing the&nbsp;following code. Note that the number of threads is passed as the first argument of the script ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sys.argv[1]"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k68ocosd","search_text":"import tensorflow as tf import numpy as np import time import sys NUM_THREADS = int(sys.argv[1]) samples = 30000 print('Num threads', NUM_THREADS) x_data = np.random.uniform(-1, 1, samples) y_data = np.random.uniform(-1, 1, samples) x = tf.placeholder('float64', name='x') y = tf.placeholder('float64', name='y') hit_tests = x ** 2 + y ** 2 <= 1.0 hits = tf.reduce_sum(tf.cast(hit_tests, 'int32')) with tf.Session (config=tf.ConfigProto (inter_op_parallelism_threads=NUM_THREADS, intra_op_parallelism_threads=NUM_THREADS)) as sess: start = time.time() for i in range(10000): sess.run(hits, {x: x_data, y: y_data}) print(time.time() - start) ","text_count":641,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import tensorflow as tf\n    import numpy as np\n    import time\n    import sys\n\n    NUM_THREADS = int(sys.argv[1])\n    samples = 30000\n\n    print('Num threads', NUM_THREADS)\n    x_data = np.random.uniform(-1, 1, samples)\n    y_data = np.random.uniform(-1, 1, samples)\n\n    x = tf.placeholder('float64', name='x')\n    y = tf.placeholder('float64', name='y')\n\n    hit_tests = x ** 2 + y ** 2 &lt;= 1.0\n    hits = tf.reduce_sum(tf.cast(hit_tests, 'int32'))\n\n    with tf.Session\n        (config=tf.ConfigProto\n            (inter_op_parallelism_threads=NUM_THREADS,\n             intra_op_parallelism_threads=NUM_THREADS)) as sess:\n        start = time.time()\n        for i in range(10000):\n            sess.run(hits, {x: x_data, y: y_data})\n        print(time.time() - start)"}]}]},{"block_type":"element","block":"k68ocose","search_text":"If we run the script multiple times with different values of NUM_THREADS , we see that the performance is quite similar to Theano and that the speedup increased by parallelization is quite modest:","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we run the script multiple times with different values of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"NUM_THREADS"}]},{"block_type":"text","content":", we see that the performance is quite similar to Theano and that&nbsp;the speedup increased by parallelization is quite modest:"}]},{"block_type":"element","block":"k68ocosf","search_text":"$ python test_tensorflow.py 1 13.059704780578613 $ python test_tensorflow.py 2 11.938535928726196 $ python test_tensorflow.py 3 12.783955574035645 $ python test_tensorflow.py 4 12.158143043518066 ","text_count":196,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ python test_tensorflow.py 1\n    13.059704780578613\n    $ python test_tensorflow.py 2\n    11.938535928726196\n    $ python test_tensorflow.py 3\n    12.783955574035645\n    $ python test_tensorflow.py 4\n    12.158143043518066"}]}]},{"block_type":"element","block":"k68ocosg","search_text":"The main advantage of using software packages such as Tensorflow and Theano is the support for parallel matrix operations that are commonly used in machine learning algorithms. This is very effective because those operations can achieve impressive performance gains on GPU hardware that is designed to perform these operations with high throughput. ","text_count":349,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The main advantage of using software packages such as Tensorflow and Theano is the support for parallel matrix operations that are commonly used&nbsp;in machine learning algorithms. This is very effective because those operations can achieve impressive performance gains on GPU hardware that is designed to perform these operations&nbsp;with high throughput.&nbsp;"}]},{"block_type":"element","block":"k68ocosh","search_text":"Running code on a GPU","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Running code on a GPU"}]},{"block_type":"element","block":"k68ocosi","search_text":"In this subsection, we will demonstrate the usage of a GPU with Theano and Tensorflow. As an example, we will benchmark the execution of a very simple matrix multiplication on the GPU and compare it to its running time on a CPU.","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this subsection, we will demonstrate the usage of a GPU with Theano and Tensorflow. As an example, we will benchmark the execution of a very simple matrix multiplication on the GPU and compare it to its running time on a CPU."}]},{"block_type":"element","block":"k68ocosj","search_text":"Note The code in this subsection requires the possession of a GPU. For learning purposes, it is possible to use the Amazon EC2 service ( https://aws.amazon.com/ec2 ) to request a GPU-enabled instance. ","text_count":201,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code in this subsection requires the possession of a GPU. For learning purposes, it is possible to use the Amazon EC2 service ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://aws.amazon.com/ec2"},"children":[{"block_type":"text","content":"https://aws.amazon.com/ec2"}]},{"block_type":"text","content":") to request a GPU-enabled instance."}]}]},{"block_type":"element","block":"k68ocosk","search_text":"The following code performs a simple matrix multiplication using Theano. We use the T.matrix function to initialize a two-dimensional array, and then we use the T.dot method to perform the matrix multiplication:","text_count":211,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following code performs a simple matrix multiplication using Theano. We use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"T.matrix"}]},{"block_type":"text","content":"function to initialize a two-dimensional array, and then we use&nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"T.dot"}]},{"block_type":"text","content":"&nbsp;method to perform the matrix multiplication:"}]},{"block_type":"element","block":"k68ocosl","search_text":"from theano import function, config import theano.tensor as T import numpy as np import time N = 5000 A_data = np.random.rand(N, N).astype('float32') B_data = np.random.rand(N, N).astype('float32') A = T.matrix('A') B = T.matrix('B') f = function([A, B], T.dot(A, B)) start = time.time() f(A_data, B_data) print(\"Matrix multiply ({}) took {} seconds\".format(N, time.time() - start)) print('Device used:', config.device) ","text_count":420,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from theano import function, config\n    import theano.tensor as T\n    import numpy as np\n    import time\n\n    N = 5000\n\n    A_data = np.random.rand(N, N).astype('float32')\n    B_data = np.random.rand(N, N).astype('float32')\n\n    A = T.matrix('A')\n    B = T.matrix('B')\n\n    f = function([A, B], T.dot(A, B))\n\n    start = time.time()\n    f(A_data, B_data)\n\n    print(\"Matrix multiply ({}) took {} seconds\".format(N, time.time() - start))\n    print('Device used:', config.device)"}]}]},{"block_type":"element","block":"k68ocosm","search_text":"It is possible to ask Theano to execute this code on a GPU by setting the config.device=gpu option. For added convenience, we can set up the configuration value from the command line using the THEANO_FLAGS environmental variable, shown as follows. After copying the previous code in the test_theano_matmul.py file, we can benchmark the execution time by issuing the following command:","text_count":384,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is possible to ask Theano&nbsp;to execute this code on a GPU by setting the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"config.device=gpu"}]},{"block_type":"text","content":"&nbsp;option. For added convenience, we can set up the configuration value from the command line using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"THEANO_FLAGS"}]},{"block_type":"text","content":"environmental variable, shown as follows. After copying the previous code in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_theano_matmul.py"}]},{"block_type":"text","content":"&nbsp;file, we can benchmark the execution time by issuing the following command:"}]},{"block_type":"element","block":"k68ocosn","search_text":"$ THEANO_FLAGS=device=gpu python test_theano_gpu.py Matrix multiply (5000) took 0.4182612895965576 seconds Device used: gpu ","text_count":124,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ THEANO_FLAGS=device=gpu python test_theano_gpu.py \n    Matrix multiply (5000) took 0.4182612895965576 seconds\n    Device used: gpu"}]}]},{"block_type":"element","block":"k68ocoso","search_text":"We can analogously run the same code on the CPU using the device=cpu configuration option:","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can analogously run the same code on the CPU using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"device=cpu"}]},{"block_type":"text","content":"configuration option:"}]},{"block_type":"element","block":"k68ocosp","search_text":"$ THEANO_FLAGS=device=cpu python test_theano.py Matrix multiply (5000) took 2.9623231887817383 seconds Device used: cpu ","text_count":120,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ THEANO_FLAGS=device=cpu python test_theano.py \n    Matrix multiply (5000) took 2.9623231887817383 seconds\n    Device used: cpu"}]}]},{"block_type":"element","block":"k68ocosq","search_text":"As you can see, the GPU is 7.2 times faster than the CPU version for this example!","text_count":82,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, the GPU is 7.2 times faster than the CPU version for this example!"}]},{"block_type":"element","block":"k68ocosr","search_text":"For comparison, we may benchmark equivalent code using Tensorflow. The implementation of a Tensorflow version is reported in the next code snippet. The main differences with the Theano version are as follows:","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For comparison, we may benchmark equivalent code using Tensorflow. The implementation of a Tensorflow version is reported in the next code snippet. The main differences with the Theano version are as follows:"}]},{"block_type":"element","block":"k68ocoss","search_text":"The usage of the tf.device config manager that serves to specify the target device ( /cpu:0 or /gpu:0 ) The matrix multiplication is performed using the tf.matmul operator: ","text_count":173,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The usage of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tf.device"}]},{"block_type":"text","content":"config manager that serves to specify the target device ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"/cpu:0"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"/gpu:0"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The matrix multiplication is performed using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tf.matmul"}]},{"block_type":"text","content":"operator:"}]}]},{"block_type":"element","block":"k68ocost","search_text":"import tensorflow as tf import time import numpy as np N = 5000 A_data = np.random.rand(N, N) B_data = np.random.rand(N, N) # Creates a graph. with tf.device('/gpu:0'): A = tf.placeholder('float32') B = tf.placeholder('float32') C = tf.matmul(A, B) with tf.Session() as sess: start = time.time() sess.run(C, {A: A_data, B: B_data}) print('Matrix multiply ({}) took: {}'.format(N, time.time() - start)) ","text_count":402,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import tensorflow as tf\n    import time\n    import numpy as np\n    N = 5000\n\n    A_data = np.random.rand(N, N)\n    B_data = np.random.rand(N, N)\n\n    # Creates a graph.\n\n    with tf.device('/gpu:0'):\n        A = tf.placeholder('float32')\n        B = tf.placeholder('float32')\n\n        C = tf.matmul(A, B)\n\n    with tf.Session() as sess:\n        start = time.time()\n        sess.run(C, {A: A_data, B: B_data})\n        print('Matrix multiply ({}) took: {}'.format(N, time.time() - start))"}]}]},{"block_type":"element","block":"k68ocosu","search_text":"If we run the test_tensorflow_matmul.py script with the appropriate tf.device option, we obtain the following timings:","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we run the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"test_tensorflow_matmul.py"}]},{"block_type":"text","content":"script with the appropriate"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tf.device"}]},{"block_type":"text","content":"option, we obtain the following timings:"}]},{"block_type":"element","block":"k68ocosv","search_text":"# Ran with tf.device('/gpu:0') Matrix multiply (5000) took: 1.417285680770874 # Ran with tf.device('/cpu:0') Matrix multiply (5000) took: 2.9646761417388916 ","text_count":157,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# Ran with tf.device('/gpu:0')\n    Matrix multiply (5000) took: 1.417285680770874\n\n    # Ran with tf.device('/cpu:0')\n    Matrix multiply (5000) took: 2.9646761417388916"}]}]},{"block_type":"element","block":"k68ocosw","search_text":"As you can see, the performance gain is substantial (but not as good as the Theano version) in this simple case.","text_count":112,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, the performance gain is substantial (but not as good as the Theano version) in this simple case."}]},{"block_type":"element","block":"k68ocosx","search_text":"Another way to achieve automatic GPU computation is the now familiar Numba. With Numba, it is possible to compile Python code to programs that can be run on a GPU. This flexibility allows for advanced GPU programming as well as more simplified interfaces. In particular, Numba makes extremely easy-to-write, GPU-ready, generalized universal functions.","text_count":351,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another way to achieve automatic GPU computation is the now familiar Numba. With Numba, it is possible to compile Python code to programs that can be run on a GPU. This flexibility allows for advanced GPU programming as well as more simplified interfaces. In particular, Numba makes extremely easy-to-write, GPU-ready, generalized universal functions."}]},{"block_type":"element","block":"k68ocosy","search_text":"In the next example, we will demonstrate how to write a universal function that applies an exponential function on two numbers and sums the results. As we already saw in Chapter 5, Exploring Compilers this can be accomplished using the nb.vectorize function (we'll also specify the cpu target explicitly):","text_count":305,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next example, we will demonstrate how to write a universal function that applies an exponential function on two numbers and sums the results. As we already saw&nbsp;in Chapter 5,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Exploring Compilers"}]},{"block_type":"text","content":"&nbsp;this can be accomplished using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nb.vectorize"}]},{"block_type":"text","content":"function (we'll also specify the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cpu"}]},{"block_type":"text","content":"target explicitly):"}]},{"block_type":"element","block":"k68ocosz","search_text":"import numba as nb import math @nb.vectorize(target='cpu') def expon_cpu(x, y): return math.exp(x) + math.exp(y) ","text_count":113,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numba as nb\n    import math\n    @nb.vectorize(target='cpu')\n    def expon_cpu(x, y):\n        return math.exp(x) + math.exp(y)"}]}]},{"block_type":"element","block":"k68ocot0","search_text":"The expon_cpu universal function can be compiled for the GPU device using the target='cuda' option. Also, note that it is necessary to specify the input types for CUDA universal functions. The implementation of expon_gpu is as follows:","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"expon_cpu"}]},{"block_type":"text","content":"universal function can be compiled for the GPU device using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"target='cuda'"}]},{"block_type":"text","content":"&nbsp;option. Also, note that it is necessary to specify the input types for CUDA universal functions. The implementation of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"expon_gpu"}]},{"block_type":"text","content":"is as follows:"}]},{"block_type":"element","block":"k68ocot1","search_text":"@nb.vectorize(['float32(float32, float32)'], target='cuda') def expon_gpu(x, y): return math.exp(x) + math.exp(y) ","text_count":114,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"@nb.vectorize(['float32(float32, float32)'], target='cuda')\n    def expon_gpu(x, y):\n        return math.exp(x) + math.exp(y)"}]}]},{"block_type":"element","block":"k68ocot2","search_text":"We can now benchmark the execution of the two functions by applying the functions on two arrays of size 1,000,000. Also, note that we execute the function before measuring the timings to trigger the Numba just-in-time compilation:","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now benchmark the execution of the two functions by applying the functions on two arrays of size 1,000,000. Also, note that we execute the function before measuring the timings to trigger the Numba just-in-time compilation:"}]},{"block_type":"element","block":"k68ocot3","search_text":"import numpy as np import time N = 1000000 niter = 100 a = np.random.rand(N).astype('float32') b = np.random.rand(N).astype('float32') # Trigger compilation expon_cpu(a, b) expon_gpu(a, b) # Timing start = time.time() for i in range(niter): expon_cpu(a, b) print(\"CPU:\", time.time() - start) start = time.time() for i in range(niter): expon_gpu(a, b) print(\"GPU:\", time.time() - start) # Output: # CPU: 2.4762887954711914 # GPU: 0.8668839931488037 ","text_count":448,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np\n    import time\n\n    N = 1000000\n    niter = 100\n\n    a = np.random.rand(N).astype('float32')\n    b = np.random.rand(N).astype('float32')\n\n    # Trigger compilation\n    expon_cpu(a, b)\n    expon_gpu(a, b)\n\n    # Timing\n    start = time.time()\n    for i in range(niter):\n       expon_cpu(a, b)\n    print(\"CPU:\", time.time() - start)\n\n    start = time.time()\n    for i in range(niter): \n        expon_gpu(a, b) \n    print(\"GPU:\", time.time() - start) \n    # Output:\n    # CPU: 2.4762887954711914\n    # GPU: 0.8668839931488037"}]}]},{"block_type":"element","block":"k68ocot4","search_text":"Thanks to the GPU execution, we were able to achieve a 3x speedup over the CPU version. Note that transferring data on the GPU is quite expensive; therefore, GPU execution becomes advantageous only for very large arrays.","text_count":220,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Thanks to the GPU execution, we were able to achieve a 3x speedup over the CPU version. Note that transferring data on the GPU is quite expensive; therefore, GPU execution becomes advantageous only for very&nbsp;large arrays."}]},{"block_type":"element","block":"k68ocot5","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k68ocot6","search_text":"Parallel processing is an effective way to improve performance on large datasets. Embarrassingly parallel problems are excellent candidates for parallel execution that can be easily implemented to achieve good performance scaling.","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Parallel processing is an effective way to improve performance on large datasets. Embarrassingly parallel problems are excellent candidates for parallel execution that can be&nbsp;easily implemented to achieve good performance&nbsp;scaling."}]},{"block_type":"element","block":"k68ocot7","search_text":"In this chapter, we illustrated the basics of parallel programming in Python. We learned how to circumvent Python threading limitation by spawning processes using the tools available in the Python standard library. We also explored how to implement a multithreaded program using Cython and OpenMP.","text_count":297,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we illustrated the basics of parallel programming in Python. We learned how to circumvent Python threading limitation by spawning processes using the tools available in the Python standard library. We also explored how to implement a multithreaded program using&nbsp;Cython and OpenMP."}]},{"block_type":"element","block":"k68ocot8","search_text":"For more complex problems, we learned how to use the Theano, Tensorflow, and Numba packages to automatically compile array-intensive expressions for parallel execution on CPU and GPU devices.","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For more complex problems, we learned how to use the Theano, Tensorflow, and Numba packages to automatically compile array-intensive expressions for parallel execution on CPU and GPU devices."}]},{"block_type":"element","block":"k68ocot9","search_text":"In the next chapter, we will learn how to write and execute parallel programs on multiple processors and machines using libraries such as dask and PySpark.","text_count":155,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter, we will learn how to write and execute parallel programs on multiple processors and machines using libraries such as dask and PySpark."}]}]},{"title":"Distributed Processing","author":"Gabriele Lanaro","block":"k68ocgxa","number":8,"contents":[{"block_type":"element","block":"k68ocota","search_text":"In the last chapter, we introduced the concept of parallel processing and learned how to leverage multicore processors and GPUs. Now, we can step up our game a bit and turn our attention on distributed processing, which involves executing tasks across multiple machines to solve a certain problem.","text_count":297,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the last&nbsp;chapter, we introduced the concept of parallel processing and learned how to leverage multicore processors and GPUs. Now, we can step up our game a bit and turn our attention on distributed processing, which&nbsp;involves executing tasks across multiple machines to solve a certain problem."}]},{"block_type":"element","block":"k68ocotb","search_text":"In this chapter, we will illustrate the challenges, use cases, and examples of how to run code on a cluster of computers. Python offers easy-to-use and reliable packages for distribute processing, which will allow us to implement scalable and fault-tolerant code with relative ease.","text_count":282,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will illustrate the challenges, use cases, and examples of how to run&nbsp;code&nbsp;on a cluster of computers.&nbsp;Python offers easy-to-use and reliable packages for distribute processing, which&nbsp;will allow us to implement scalable and fault-tolerant code with relative ease."}]},{"block_type":"element","block":"k68ocotc","search_text":"The list of topics for this chapter is as follows:","text_count":50,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The list of topics for this chapter is as follows:"}]},{"block_type":"element","block":"k68ocotd","search_text":"Distributed computing and the MapReduce model Directed Acyclic Graphs with Dask Writing parallel code with Dask's array , Bag , and DataFrame data structures Distributing parallel algorithms with Dask Distributed An introduction to PySpark Spark's Resilient Distributed Datasets and DataFrame Scientific computing with mpi4py ","text_count":326,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Distributed computing and the MapReduce model"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Directed Acyclic Graphs with Dask"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Writing parallel code with Dask's&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"array"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Bag"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":"data structures"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Distributing parallel algorithms with Dask Distributed"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"An introduction to PySpark"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Spark's Resilient Distributed Datasets and DataFrame"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Scientific computing with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mpi4py"}]}]}]},{"block_type":"element","block":"k68ocote","search_text":"Introduction to distributed computing","text_count":37,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Introduction to distributed computing"}]},{"block_type":"element","block":"k68ocotf","search_text":"In today's world, computers, smartphones, and other devices have become an integral part of our lives. Every day, massive quantities of data is produced. Billions of people access services on the Internet, and companies are constantly collecting data to learn about their users to better target products and improve user experience. ","text_count":333,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In today's world, computers, smartphones, and other devices&nbsp;have become an integral part of our lives. Every day, massive quantities of data is produced. Billions of people access services on the Internet, and companies are constantly collecting data to learn about their users to better target products and improve user experience.&nbsp;"}]},{"block_type":"element","block":"k68ocotg","search_text":"Handling this ever increasing amount of data presents substantial challenges. Large companies and organizations often build clusters of machines designed to store, process, and analyze large and complex datasets. Similar datasets are also produced in data-intensive fields such as environmental sciences and health care. These large-scale datasets have been recently called big data . The analysis techniques applied to big data usually involve a combination of machine learning, information retrieval, and visualization.","text_count":521,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Handling&nbsp;this ever increasing amount of data presents substantial challenges. Large companies and organizations often build clusters of machines designed to store, process, and analyze large and complex datasets. Similar datasets are also produced in data-intensive fields such as environmental sciences and health care. These&nbsp;large-scale datasets have been recently called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"big data"}]},{"block_type":"text","content":". The analysis techniques applied to big data usually involve a combination of machine learning, information retrieval, and visualization."}]},{"block_type":"element","block":"k68ocoth","search_text":"Computing clusters have been used for decades in scientific computing, where the study of complex problems requires the use of parallel algorithms executed on high-performance distributed systems. For such applications, universities and other organizations provide and manage supercomputers for research and engineering purposes. Applications that run on supercomputers are generally focused on highly numerical workloads, such as protein and molecular simulations, quantum mechanical calculations, climate models, and much more.","text_count":529,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Computing clusters have been used for decades in scientific computing, where the study of complex problems requires the use of parallel algorithms executed on high-performance distributed systems. For such applications, universities and other organizations provide and manage supercomputers for research and engineering purposes. Applications that run on supercomputers are generally focused on highly numerical workloads, such as protein and molecular simulations, quantum mechanical calculations, climate models, and much more."}]},{"block_type":"element","block":"k68ocoti","search_text":"The challenges of programming for distributed systems are apparent if we think back on how the cost of communication increases as we distribute data and computational tasks across a local network. Network transfers are extremely slow compared to the processor speed, and when using distributed processing, it is even more important to keep network communications as limited as possible. This can be achieved using a few different strategies that favor local data processing and resort to data transfers only when strictly necessary.","text_count":532,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The challenges of programming for distributed systems are apparent if we think back on how the cost of communication increases as we distribute data and computational tasks&nbsp;across a local network. Network transfers are extremely slow compared to the processor speed, and when using distributed processing, it is even more important to keep network communications as limited as possible. This can be achieved using a few different strategies that favor&nbsp;local data processing and resort to data transfers only when strictly necessary."}]},{"block_type":"element","block":"k68ocotj","search_text":"Other challenges of distributed processing involve the general unreliability of computer networks. When you think that in a computing cluster there may be thousands of machines, it becomes clear that (probabilistically speaking) faulty nodes become very common. For this reason, distributed systems need to be able to handle node failures gracefully and without disrupting the ongoing work. Luckily, companies have invested a great deal of resources in developing fault-tolerant distributed engines that take care of these aspects automatically.","text_count":545,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Other challenges of distributed processing involve the general unreliability of computer networks. When you think that in a computing cluster there may be thousands of machines, it becomes clear that (probabilistically speaking) faulty nodes become very common. For this reason, distributed systems need to be able to handle node failures gracefully and without disrupting the ongoing work.&nbsp;Luckily, companies have invested a great deal of resources in developing fault-tolerant distributed engines&nbsp;that take care of these aspects automatically."}]},{"block_type":"element","block":"k68ocotk","search_text":"An introduction to MapReduce","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"An introduction to MapReduce"}]},{"block_type":"element","block":"k68ocotl","search_text":"MapReduce is a programming model that allows you to express algorithms for efficient execution on a distributed system. The MapReduce model was first introduced by Google in 2004 ( https://research.google.com/archive/mapreduce.html ), as a way to automatically partition datasets over different machines and for automatic local processing and the communication between cluster nodes .","text_count":384,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"MapReduce"}]},{"block_type":"text","content":"is a programming model that allows you to express algorithms for efficient execution on a distributed system. The MapReduce model was first introduced by Google in 2004 ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://research.google.com/archive/mapreduce.html"},"children":[{"block_type":"text","content":"https://research.google.com/archive/mapreduce.html"}]},{"block_type":"text","content":"), as a way&nbsp;to automatically partition datasets&nbsp;over different machines and for automatic local processing and the communication between"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"cluster nodes"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocotm","search_text":"The MapReduce framework was used in cooperation with a distributed filesystem, the Google File System (GFS or GoogleFS), which was designed to partition and replicate data across the computing cluster. Partitioning was useful for storing and processing datasets that wouldn't fit on a single node while replication ensured that the system was able to handle failures gracefully. MapReduce was used by Google, in conjunction with GFS, for indexing of their web pages. Later on, the MapReduce and GFS concepts were implemented by Doug Cutting (at the time, an employee at Yahoo!), resulting in the first versions of the Hadoop Distributed File System ( HDFS ) and Hadoop MapReduce.","text_count":679,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The MapReduce framework was used in cooperation with a distributed filesystem, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Google File System"}]},{"block_type":"text","content":"(GFS or GoogleFS), which was designed to partition and replicate data across the computing cluster. Partitioning was useful for storing and processing datasets that wouldn't fit on a single node while replication ensured that the system was able to handle failures gracefully. MapReduce was used by Google, in conjunction with GFS, for indexing of their web pages. Later on,&nbsp;the MapReduce and GFS concepts were&nbsp;implemented by Doug Cutting (at the time, an employee at Yahoo!), resulting in the first versions of the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Hadoop Distributed File System"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"HDFS"}]},{"block_type":"text","content":") and Hadoop MapReduce."}]},{"block_type":"element","block":"k68ocotn","search_text":"The programming model exposed by MapReduce is actually quite simple. The idea is to express the computation as a combination of two, fairly generic, steps: Map and Reduce . Some readers will probably be familiar with Python's map and reduce functions; however, in the context of MapReduce, the Map and Reduce steps are capable of representing a broader class of operations.","text_count":373,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The programming model exposed by MapReduce is actually quite simple. The idea is to express the computation as a combination of two, fairly generic, steps:"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Map"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Reduce"}]},{"block_type":"text","content":". Some readers will probably be familiar with Python's"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"reduce"}]},{"block_type":"text","content":"functions; however, in the context of MapReduce, the Map and Reduce steps are capable of representing a broader class of operations."}]},{"block_type":"element","block":"k68ocoto","search_text":"Map takes a collection of data as input and produces a transformation on this data. What is generally emitted by Map is a series of key value pairs that can be passed to a Reduce step. The Reduce step will aggregate items with the same key and apply a function to the collection to form a usually smaller collection of values.","text_count":326,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Map takes a collection of data as input and produces a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"transformation"}]},{"block_type":"text","content":"on this data. What is generally emitted by Map is a series of key value pairs that can be passed to a Reduce step. The Reduce step will aggregate items with the same key and apply a function to the collection to form a usually smaller collection of values."}]},{"block_type":"element","block":"k68ocotp","search_text":"The estimation of pi , which was shown in the last chapter, can be trivially converted using a series of Map and Reduce steps. In that case, the input was a collection of pairs of random numbers. The transformation (Map step) was the hit test, and the Reduce step was counting the number of times the hit test was True.","text_count":319,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The estimation of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pi"}]},{"block_type":"text","content":", which was shown in the last&nbsp;chapter, can be trivially converted using a series of Map and Reduce steps. In that case, the input was a collection of pairs of random numbers. The transformation (Map step) was the hit test, and the Reduce step was counting the number of times the hit test was True."}]},{"block_type":"element","block":"k68ocotq","search_text":"The prototypical example of the MapReduce model is the implementation of a word count; the program takes a series of documents as input, and returns, for each word, the total number of occurrences in the document collection. The following figure illustrates the Map and Reduce steps of the word count program. On the left, we have the input documents. The Map operation will produce a (key, value) entry where the first element is the word and the second element is 1 (that's because every word contributes 1 to the final count).","text_count":529,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The prototypical example of the MapReduce model is the implementation of a word count; the program takes a series of documents as input, and returns, for each word, the total number of occurrences in the document collection. The following figure illustrates&nbsp;the Map and Reduce steps of the word count program. On the left, we have the input documents. The Map operation will produce a (key, value) entry where the first element is the word and the second element is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"(that's because every word contributes"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"to the final count)."}]},{"block_type":"element","block":"k68ocotr","search_text":"We then perform the reduce operation to aggregate all the elements of the same key and produce the global count for each of the words. In the figure, we can see how all values of the items with key the are summed to produce the final entry ( the, 4 ): ","text_count":252,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We then perform the reduce operation to aggregate all the elements of the same key and produce the global count for each of the words. In the figure, we can see how all values of the items with key"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"the"}]},{"block_type":"text","content":"&nbsp;are summed to produce the final entry ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"the, 4"}]},{"block_type":"text","content":"): &nbsp;"}]},{"block_type":"element","block":"k68ocots","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000030.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocott","search_text":"If we implement our algorithm using the Map and Reduce operation, the framework implementation will ensure that data production and aggregation is done efficiently, by limiting the communication between nodes through clever algorithms.","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we implement our algorithm using the Map and Reduce operation, the framework implementation will ensure that data production and aggregation is done efficiently, by limiting the communication between nodes through clever algorithms."}]},{"block_type":"element","block":"k68ocotu","search_text":"However, how does MapReduce manage to keep communication to a minimum? Let's go through the journey of a MapReduce task. Imagine that you have a cluster with two nodes, and a partition of the data (this is usually found locally in each node) is loaded in each node from disk and is ready for processing. A mapper process is created in each node and processes the data to produce the intermediate results. ","text_count":405,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, how does MapReduce manage to keep communication to a minimum? Let's go through the journey of a MapReduce task. Imagine that you have a cluster with two&nbsp;nodes, and a partition of the data (this is usually found locally in each node) is loaded in each node from disk and is ready for processing. A mapper process is created in each node and processes the data to produce the intermediate results.&nbsp;"}]},{"block_type":"element","block":"k68ocotv","search_text":"Next, it is necessary to send the data to the reducer for further processing. In order to do this, however, it is necessary that all the items that possess the same key are shipped to the same reducer. This operation is called shuffling and is the principal communication task in the MapReduce model:","text_count":300,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, it is necessary to send the data to the reducer for further processing. In order to do this, however, it is necessary that all the items that possess the same key are shipped to the same reducer. This operation is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"shuffling"}]},{"block_type":"text","content":"and is the principal communication task in the MapReduce model:"}]},{"block_type":"element","block":"k68ocotw","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"text","content":"&nbsp;"},{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000021.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocotx","search_text":"Note that, before the data exchange happens, it is necessary to assign a subset of keys to each reducer; this step is called partitioning . Once a reducer receives its own partition of keys, it is free to process data and write the resulting output on disk.","text_count":257,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that, before the data exchange happens, it is necessary to assign a subset of keys to&nbsp;each reducer; this step is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"partitioning"}]},{"block_type":"text","content":". &nbsp;Once a reducer receives its own partition of keys, it is free to process&nbsp;data and write the resulting output on disk."}]},{"block_type":"element","block":"k68ocoty","search_text":"The MapReduce framework (through the Apache Hadoop project) has been extensively used in its original form by many companies and organizations. More recently, new frameworks that extend the ideas introduced by MapReduce have been developed to create systems able to express more complex workflows, to use memory more efficiently and to support a lean and efficient execution of distributed tasks.","text_count":396,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The MapReduce framework (through the Apache Hadoop project) has been extensively used in its original form by many companies and organizations. More recently, new frameworks that extend the ideas introduced by MapReduce have been developed to create systems able to express more complex workflows, to use memory more efficiently and to support a lean and efficient execution of distributed tasks."}]},{"block_type":"element","block":"k68ocotz","search_text":"In the following sections, we will describe two of the most used libraries in the Python distributed landscape: Dask and PySpark.","text_count":129,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following sections, we will describe two of the most used libraries in the Python distributed landscape:&nbsp;Dask and PySpark."}]},{"block_type":"element","block":"k68ocou0","search_text":"Dask","text_count":4,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Dask"}]},{"block_type":"element","block":"k68ocou1","search_text":"Dask is a project of Continuum Analytics (the same company that's responsible for Numba and the conda package manager) and a pure Python library for parallel and distributed computation. It excels at performing data analysis tasks and is very well integrated in the Python ecosystem.","text_count":283,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Dask"}]},{"block_type":"text","content":"is a project of Continuum Analytics (the same company that's responsible for Numba and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"conda"}]},{"block_type":"text","content":"package manager) and a pure Python library for parallel and distributed computation. It excels at performing data analysis tasks and is very well integrated in the Python ecosystem."}]},{"block_type":"element","block":"k68ocou2","search_text":"Dask was initially conceived as a package for bigger-than-memory calculations on a single machine. Recently, with the Dask Distributed project, its code has been adapted to execute tasks on a cluster with excellent performance and fault-tolerance capabilities. It supports MapReduce-style tasks as well as complex numerical algorithms.","text_count":335,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dask was initially conceived as a package for bigger-than-memory calculations on a single machine. Recently, with the Dask Distributed&nbsp;project, its code has been adapted to execute tasks on a cluster with excellent performance and fault-tolerance capabilities. It supports MapReduce-style tasks as well as complex numerical algorithms."}]},{"block_type":"element","block":"k68ocou3","search_text":"Directed Acyclic Graphs","text_count":23,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Directed Acyclic Graphs"}]},{"block_type":"element","block":"k68ocou4","search_text":"The idea behind Dask is quite similar to what we already saw in the last chapter with Theano and Tensorflow. We can use a familiar Pythonic API to build an execution plan, and the framework will automatically split the workflow into tasks that will be shipped and executed on multiple processes or computers.","text_count":308,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The idea behind&nbsp;Dask is quite similar to what we already saw in the last&nbsp;chapter with Theano and Tensorflow. We can use a familiar Pythonic API to build an execution plan, and the framework will automatically split the workflow into tasks that will be shipped and executed on multiple processes or computers."}]},{"block_type":"element","block":"k68ocou5","search_text":"Dask expresses its variables and operations as a Directed Acyclic Graph ( DAG ) that can be represented through a simple Python dictionary. To briefly illustrate how this works, we will implement the sum of two numbers with Dask. We will define our computational graph by storing the values of our input variables in the dictionary. The a and b input variables will be given a value of 2 :","text_count":389,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dask expresses its variables and operations as a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Directed Acyclic Graph"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"DAG"}]},{"block_type":"text","content":") that&nbsp;can be represented through&nbsp;a simple Python dictionary. To briefly illustrate how this works, we will implement the sum of two numbers with Dask. We will define our computational graph by storing the values of our input variables in the dictionary. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"b"}]},{"block_type":"text","content":"input variables&nbsp;will be given a value of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"2"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocou6","search_text":"dsk = { \"a\" : 2, \"b\" : 2, } ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"dsk = {\n      \"a\" : 2,\n      \"b\" : 2,\n    }"}]}]},{"block_type":"element","block":"k68ocou7","search_text":"Each variable represents a node in the DAG. The next step necessary to build our DAG is the execution of operations on the nodes we just defined. In Dask, a task can be defined by placing a tuple containing a Python function and its positional arguments in the dsk dictionary. To implement a sum , we can add a new node, named result , (the actual name is completely arbitrary) with a tuple containing the function we intend to execute, followed by its arguments. This is illustrated in the following code:","text_count":506,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Each variable represents a node in the DAG. The next step necessary to build our DAG is the execution of operations on the nodes we just defined. In Dask, a task can be defined by placing a tuple containing a Python function and its positional arguments&nbsp;in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dsk"}]},{"block_type":"text","content":"dictionary. To implement a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum"}]},{"block_type":"text","content":", we can add a new node, named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"result"}]},{"block_type":"text","content":", (the actual name is completely arbitrary) with a tuple containing the function we intend to execute, followed by its arguments. This is illustrated in the following code:"}]},{"block_type":"element","block":"k68ocou8","search_text":"dsk = { \"a\" : 2, \"b\" : 2, \"result\": (lambda x, y: x + y, \"a\", \"b\") } ","text_count":69,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"dsk = {\n      \"a\" : 2,\n      \"b\" : 2,\n      \"result\": (lambda x, y: x + y, \"a\", \"b\")\n    }"}]}]},{"block_type":"element","block":"k68ocou9","search_text":"For better style and clarity, we can calculate the sum by replacing the lambda statement with the standard operator.add library function:","text_count":137,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For better style and clarity, we can calculate the sum by replacing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"lambda"}]},{"block_type":"text","content":"statement with the standard"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"operator.add"}]},{"block_type":"text","content":"&nbsp;library function:"}]},{"block_type":"element","block":"k68ocoua","search_text":"from operator import add dsk = { \"a\" : 2, \"b\" : 2, \"result\": (add, \"a\", \"b\") } ","text_count":79,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from operator import add\n    dsk = {\n      \"a\" : 2,\n      \"b\" : 2,\n      \"result\": (add, \"a\", \"b\")\n    }"}]}]},{"block_type":"element","block":"k68ocoub","search_text":"It's important to note that the arguments we intend to pass to the function are the \"a\" and \"b\" strings, which refer to the a and b nodes in the graph. Note that we didn't use any Dask-specific functions to define the DAG; this is the first indication of how the framework is flexible and lean since all manipulations are performed on simple and familiar Python dictionaries.","text_count":375,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to note that the arguments we intend to pass to the function are the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"\"a\""}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"\"b\""}]},{"block_type":"text","content":"&nbsp;strings, which refer to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"b"}]},{"block_type":"text","content":"nodes in the graph. Note that we didn't use any Dask-specific functions to define the DAG; this is the&nbsp;first indication of how the framework is flexible and lean since all&nbsp;manipulations are performed on simple and familiar Python dictionaries."}]},{"block_type":"element","block":"k68ocouc","search_text":"The execution of tasks is performed by a scheduler, which is a function that takes a DAG and the task or tasks we'd like to perform and returns the computed value. The default Dask scheduler is the dask.get function, which can be used as follows:","text_count":246,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The execution of tasks is performed by a scheduler, which is a function that takes a DAG and the task or tasks we'd like to perform and returns the computed value. The default Dask scheduler is the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask.get"}]},{"block_type":"text","content":"&nbsp;function, which can be used as follows:"}]},{"block_type":"element","block":"k68ocoud","search_text":"import dask res = dask.get(dsk, \"result\") print(res) # Output: # 4 ","text_count":67,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import dask\n\n    res = dask.get(dsk, \"result\")\n    print(res)\n    # Output:\n    # 4"}]}]},{"block_type":"element","block":"k68ocoue","search_text":"All the complexity is hidden behind the scheduler, which will take care of distributing the tasks across threads, processes, or even different machines. The dask.get scheduler is a synchronous and serial implementation that is useful for testing and debugging purposes.","text_count":269,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All the complexity is hidden behind the scheduler, which will take care of distributing the tasks across&nbsp;threads, processes, or even different machines. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask.get"}]},{"block_type":"text","content":"scheduler is a synchronous and serial implementation that is useful for testing and debugging purposes."}]},{"block_type":"element","block":"k68ocouf","search_text":"Defining graphs using a simple dictionary is useful to understand how Dask does its magic and for debugging purposes. Raw dictionaries can also be used to implement more complex algorithms not covered by the Dask API. Now, we will learn how Dask is capable of generating tasks automatically through a familiar NumPy- and Pandas-like interface.","text_count":343,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Defining graphs using a simple dictionary is useful to understand how Dask does its magic and for debugging purposes. Raw dictionaries can also be used to implement more complex algorithms not covered by the Dask API. Now, we will learn how Dask is capable of generating tasks automatically through a familiar NumPy- and Pandas-like interface."}]},{"block_type":"element","block":"k68ocoug","search_text":"Dask arrays","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Dask arrays"}]},{"block_type":"element","block":"k68ocouh","search_text":"One of the main use-cases of Dask is the automatic generation of parallel array operations, which greatly simplifies the handling of arrays that don't fit into memory. The strategy employed by Dask is to split the array into a number of subunits that, in Dask array terminology, are called chunks .","text_count":298,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the main use-cases of Dask is the automatic generation of parallel array operations, which greatly simplifies the handling of arrays that don't fit into memory. The strategy employed by Dask is to split the array into a number of subunits that, in Dask array terminology, are called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"chunks"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocoui","search_text":"Dask implement a NumPy-like interface for arrays in the dask.array module (which we will abbreviate as da ). An array can be created from a NumPy-like array using the da.from_array function, which requires the specification of a chunk size. The da.from_array function will return a da.array object that will handle the splitting of the original array into subunits of the specified chunk size. In the following example, we create an array of 30 elements, and we split it into chunks with 10 elements each:","text_count":505,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dask implement a NumPy-like interface for arrays in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask.array"}]},{"block_type":"text","content":"module (which we will abbreviate as&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"da"}]},{"block_type":"text","content":"). An array can be created from a NumPy-like array using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"da.from_array"}]},{"block_type":"text","content":"&nbsp;function, which requires the specification of a chunk size. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"da.from_array"}]},{"block_type":"text","content":"function will return a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"da.array"}]},{"block_type":"text","content":"object&nbsp;that will handle the splitting of&nbsp;the original array into subunits of the specified chunk size. In the following example, we create an array of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"30"}]},{"block_type":"text","content":"elements, and we split it into chunks with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"10"}]},{"block_type":"text","content":"elements each:"}]},{"block_type":"element","block":"k68ocouj","search_text":"import numpy as np import dask.array as da a = np.random.rand(30) a_da = da.from_array(a, chunks=10) # Result: # dask.array<array-4..., shape=(30,), dtype=float64, chunksize=(10,)> ","text_count":181,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np\n    import dask.array as da\n\n    a = np.random.rand(30)\n\n    a_da = da.from_array(a, chunks=10)\n    # Result:\n    # dask.array&lt;array-4..., shape=(30,), dtype=float64, chunksize=(10,)&gt;"}]}]},{"block_type":"element","block":"k68ocouk","search_text":"The a_da variable maintains a Dask graph that can be accessed using the dask attribute. To understand what Dask does under the hood, we can inspect its content. In the following example, we can see that the Dask graph contains four nodes. One of them is the source array, denoted by the 'array-original-4c76' key, the other three keys in the a_da.dask dictionary are tasks that are used to access a chunk of the original array using the dask.array.core.getarray function and, as you can see, each task extracts a slice of 10 elements:","text_count":534,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a_da"}]},{"block_type":"text","content":"variable maintains a Dask graph that&nbsp;can be accessed using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask"}]},{"block_type":"text","content":"attribute. To understand what Dask does under the hood, we can inspect its content. In the following example, we can see that the Dask graph contains four nodes. One of them is the source array, denoted by the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"'array-original-4c76'"}]},{"block_type":"text","content":"&nbsp;key, the other three keys in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a_da.dask"}]},{"block_type":"text","content":"dictionary are tasks that are&nbsp;used to access a chunk of the original array using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask.array.core.getarray"}]},{"block_type":"text","content":"function and, as you can see, each task extracts a slice of 10 elements:"}]},{"block_type":"element","block":"k68ocoul","search_text":"dict(a_da.dask) # Result {('array-4c76', 0): (<function dask.array.core.getarray>, 'array-original-4c76', (slice(0, 10, None),)), ('array-4c76', 2): (<function dask.array.core.getarray>, 'array-original-4c76', (slice(20, 30, None),)), ('array-4c76', 1): (<function dask.array.core.getarray>, 'array-original-4c76', (slice(10, 20, None),)), 'array-original-4c76': array([ ... ]) } ","text_count":380,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"dict(a_da.dask)\n    # Result\n    {('array-4c76', 0): (&lt;function dask.array.core.getarray&gt;, \n                         'array-original-4c76',\n                         (slice(0, 10, None),)),\n     ('array-4c76', 2): (&lt;function dask.array.core.getarray&gt;,\n                         'array-original-4c76',\n                         (slice(20, 30, None),)),\n     ('array-4c76', 1): (&lt;function dask.array.core.getarray&gt;, \n                         'array-original-4c76',\n                         (slice(10, 20, None),)),\n     'array-original-4c76': array([ ... ])\n    }"}]}]},{"block_type":"element","block":"k68ocoum","search_text":"If we perform an operation on the a_da array, Dask will generate more subtasks that operate on the smaller chunks, opening the possibility of achieving parallelism. The interface exposed by da.array is compatible with common NumPy semantics and broadcasting rules. The complete code, shown as follows, demonstrates the good compatibility of Dask with NumPy broadcasting rules, element-wise operations, and other methods:","text_count":420,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we perform an operation on the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"a_da"}]},{"block_type":"text","content":"array, Dask will generate more subtasks that operate on the smaller chunks, opening the possibility of achieving parallelism. The interface exposed by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"da.array"}]},{"block_type":"text","content":"is compatible with common NumPy semantics and broadcasting rules. The complete code, shown as follows, demonstrates the good compatibility of Dask with NumPy broadcasting rules, element-wise operations, and other methods:"}]},{"block_type":"element","block":"k68ocoun","search_text":"N = 10000 chunksize = 1000 x_data = np.random.uniform(-1, 1, N) y_data = np.random.uniform(-1, 1, N) x = da.from_array(x_data, chunks=chunksize) y = da.from_array(y_data, chunks=chunksize) hit_test = x ** 2 + y ** 2 < 1 hits = hit_test.sum() pi = 4 * hits / N ","text_count":260,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"N = 10000\n    chunksize = 1000 \n\n    x_data = np.random.uniform(-1, 1, N)\n    y_data = np.random.uniform(-1, 1, N)\n\n    x = da.from_array(x_data, chunks=chunksize)\n    y = da.from_array(y_data, chunks=chunksize)\n\n    hit_test = x ** 2 + y ** 2 &lt; 1\n\n    hits = hit_test.sum()\n    pi = 4 * hits / N"}]}]},{"block_type":"element","block":"k68ocouo","search_text":"The value of pi can be calculated using the compute method, which can also be called with the get optional argument to specify a different scheduler (by default, da.array uses a multithreaded scheduler):","text_count":203,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The value of pi can be calculated using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"compute"}]},{"block_type":"text","content":"method, which can also be called with the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"get"}]},{"block_type":"text","content":"&nbsp;optional argument&nbsp;to specify a different scheduler (by default,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"da.array"}]},{"block_type":"text","content":"uses a multithreaded scheduler):"}]},{"block_type":"element","block":"k68ocoup","search_text":"pi.compute() # Alternative: pi.compute(get=dask.get) # Result: # 3.1804000000000001 ","text_count":84,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"pi.compute() # Alternative: pi.compute(get=dask.get)\n    # Result:\n    # 3.1804000000000001"}]}]},{"block_type":"element","block":"k68ocouq","search_text":"Even deceptively simple algorithms, such as the estimation of pi, may require a lot of tasks to be executed. Dask provides utilities to visualize the computational graph. The following figure shows part of the Dask graph for the estimation of pi, which can be obtained by executing the method pi.visualize() . In the graph, circles refer to transformations that get applied on the nodes, which are represented as rectangles. This example helps us to get a feel of the complexity of the Dask graph and to appreciate the scheduler's job of creating an efficient execution plan that includes proper ordering of tasks and the selection of tasks that will be executed in parallel: ","text_count":676,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even deceptively simple algorithms, such as the estimation of pi, may require a lot of tasks to be executed. Dask provides utilities to visualize the computational&nbsp;graph. The following figure shows part of the Dask graph for the estimation of pi, which can be obtained by executing the method"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pi.visualize()"}]},{"block_type":"text","content":". In the graph, circles refer to transformations that get applied on the nodes, which are represented as rectangles.&nbsp;This example helps us to get a feel of the complexity of the Dask graph and to appreciate the scheduler's job of creating&nbsp;an efficient execution plan that includes proper ordering of tasks and the selection of tasks that will be executed in parallel:&nbsp;"}]},{"block_type":"element","block":"k68ocour","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000038.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocous","search_text":"Dask Bag and DataFrame","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Dask Bag and DataFrame"}]},{"block_type":"element","block":"k68ocout","search_text":"Dask provides other data structures for automatic generation of computation graphs. In this subsection, we'll take a look at dask.bag.Bag , a generic collection of elements that can be used to code MapReduce-style algorithms, and dask.dataframe.DataFrame , a distributed version of pandas.DataFrame .","text_count":300,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dask provides other data structures for automatic generation of computation graphs. In this subsection, we'll take a look at&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask.bag.Bag"}]},{"block_type":"text","content":", a generic collection of elements that can be used to code MapReduce-style algorithms, and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask.dataframe.DataFrame"}]},{"block_type":"text","content":", a distributed version of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pandas.DataFrame"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocouu","search_text":"A Bag can be easily created from a Python collection. For example, you can create a Bag from a list using the from_sequence factory function. The level of parallelism can be specified using the npartitions argument (this will distribute the Bag content into a number of partitions). In the following example, we create a Bag containing numbers from 0 to 99 , partitioned into four chunks:","text_count":388,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Bag"}]},{"block_type":"text","content":"can be easily created from a Python collection. For example, you can create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Bag"}]},{"block_type":"text","content":"from a list using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"from_sequence"}]},{"block_type":"text","content":"&nbsp;factory function. The level of parallelism can be specified using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"npartitions"}]},{"block_type":"text","content":"argument (this will distribute the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Bag"}]},{"block_type":"text","content":"content into a number of partitions). In the following example, we create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Bag"}]},{"block_type":"text","content":"containing numbers from"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"99"}]},{"block_type":"text","content":", partitioned into&nbsp;four chunks:"}]},{"block_type":"element","block":"k68ocouv","search_text":"import dask.bag as dab dab.from_sequence(range(100), npartitions=4) # Result: # dask.bag<from_se..., npartitions=4> ","text_count":116,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import dask.bag as dab\n    dab.from_sequence(range(100), npartitions=4)\n    # Result:\n    # dask.bag&lt;from_se..., npartitions=4&gt;"}]}]},{"block_type":"element","block":"k68ocouw","search_text":"In the next example, we will demonstrate how to perform a word count of a set of strings using an algorithm that's similar to MapReduce. Given our collection of sequences, we apply str.split , followed by concat to obtain a linear list of words in the documents. Then, for each word, we produce a dictionary that contains a word and the value 1 (refer to the An introduction to MapReduce section for an illustration). We then write a Reduce step using the foldby operator to calculate the word count.","text_count":500,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next example, we will demonstrate how to perform a word count of a set of strings using an algorithm that's&nbsp;similar to MapReduce. Given our collection of sequences, we apply"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"str.split"}]},{"block_type":"text","content":", followed by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"concat"}]},{"block_type":"text","content":"to obtain a linear list of words in the documents. Then, for each word, we produce a dictionary that contains a word and the value"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"(refer to the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"An introduction to MapReduce"}]},{"block_type":"text","content":"section for an illustration). We then write a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Reduce"}]},{"block_type":"text","content":"step using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"foldby"}]},{"block_type":"text","content":"operator to calculate the word count."}]},{"block_type":"element","block":"k68ocoux","search_text":"The foldby transformation is useful to implement a Reduce step that combines the word counts without having to shuffle all the elements over the network. Imagine that our word dataset is divided into two partitions. A good strategy to calculate the total count is to first sum the word occurrences in each partition and then combine those partial sums to get the final result. The following figure illustrates the concept. On the left, we have our input partitions. The partial sum is calculated for each individual partition (this is done using a binary operation, binop ), and then the final sums are computed by combining the partial sums using a combine function.","text_count":667,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"foldby"}]},{"block_type":"text","content":"transformation is useful to implement&nbsp;a Reduce step that combines the word counts without having to shuffle all the elements over the network. Imagine that our word dataset is divided into two partitions. A good strategy to calculate the total count is to first sum the word occurrences in each partition and then combine those partial sums to get the final result. The following figure illustrates the concept. On the left, we have our input partitions. The partial sum is calculated for each individual partition (this is done using a binary operation,"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"binop"}]},{"block_type":"text","content":"), and then the final sums are computed by combining the partial sums using a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"combine"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","block":"k68ocouy","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000031.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocouz","search_text":"The following code illustrates how to use Bag and the foldby operator to compute the word count. For the foldby operator, we need to define two functions that take five arguments:","text_count":179,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following code illustrates how to use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Bag"}]},{"block_type":"text","content":"and the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"foldby"}]},{"block_type":"text","content":"&nbsp;operator to compute the word count. For the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"foldby"}]},{"block_type":"text","content":"operator, we need to define two functions that take&nbsp;five arguments:"}]},{"block_type":"element","block":"k68ocov0","search_text":"key : This is a function that returns the key for the reduce operation. binop : This is a function that takes two arguments: total and x . Given a total value (the values accumulated so far), binop incorporates the next item into the total. initial : This is the initial value for the binop accumulation. combine : This is a function that combines the totals for each partition (in this case it is a simple sum). initial_combine : This is the initial value for the combine accumulation. ","text_count":487,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"key"}]},{"block_type":"text","content":": This is a function that returns the key for the reduce operation."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"binop"}]},{"block_type":"text","content":": This is a function that takes two arguments:"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"total"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":". Given a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"total"}]},{"block_type":"text","content":"value (the values accumulated so far),"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"binop"}]},{"block_type":"text","content":"&nbsp;incorporates the next item into the total."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"initial"}]},{"block_type":"text","content":": This is the initial value for the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"binop"}]},{"block_type":"text","content":"accumulation."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"combine"}]},{"block_type":"text","content":": This is a function that combines the totals for each partition (in this case it is a simple sum)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"initial_combine"}]},{"block_type":"text","content":": This is the initial value for the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"combine"}]},{"block_type":"text","content":"accumulation."}]}]},{"block_type":"element","block":"k68ocov1","search_text":"Now, let's look at the code:","text_count":28,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's look at the code:"}]},{"block_type":"element","block":"k68ocov2","search_text":"collection = dab.from_sequence([\"the cat sat on the mat\", \"the dog sat on the mat\"], npartitions=2) binop = lambda total, x: total + x[\"count\"] combine = lambda a, b: a + b (collection .map(str.split) .concat() .map(lambda x: {\"word\": x, \"count\": 1}) .foldby(lambda x: x[\"word\"], binop, 0, combine, 0) .compute()) # Output: # [('dog', 1), ('cat', 1), ('sat', 2), ('on', 2), ('mat', 2), ('the', 4)] ","text_count":398,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"collection = dab.from_sequence([\"the cat sat on the mat\",\n                                    \"the dog sat on the mat\"], npartitions=2)\n\n    binop = lambda total, x: total + x[\"count\"]\n    combine = lambda a, b: a + b\n    (collection\n     .map(str.split)\n     .concat()\n     .map(lambda x: {\"word\": x, \"count\": 1})\n     .foldby(lambda x: x[\"word\"], binop, 0, combine, 0)\n     .compute())\n    # Output:\n    # [('dog', 1), ('cat', 1), ('sat', 2), ('on', 2), ('mat', 2), ('the', 4)]"}]}]},{"block_type":"element","block":"k68ocov3","search_text":"As we just saw, expressing complex operations in an efficient way using Bag can become cumbersome. For this reason, Dask provides another data structure designed for analytical workloads-- dask.dataframe.DataFrame . A DataFrame can be initialized in Dask using a variety of methods, such as from CSV files on distributed filesystems, or directly from a Bag . Just like da.array provides an API that closely mirrors NumPy features, Dask DataFrame can be used as a distributed version of pandas.DataFrame .","text_count":504,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we just saw, expressing complex operations in an efficient way using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Bag"}]},{"block_type":"text","content":"can become cumbersome. For this reason, Dask provides&nbsp;another data structure designed for analytical workloads--"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask.dataframe.DataFrame"}]},{"block_type":"text","content":". A"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":"can be initialized in Dask using a variety of methods, such as from&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"CSV"}]},{"block_type":"text","content":"files on distributed filesystems, or directly from a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Bag"}]},{"block_type":"text","content":". Just like"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"da.array"}]},{"block_type":"text","content":"provides an API that closely mirrors NumPy features, Dask"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":"can be used as a distributed version of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pandas.DataFrame"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocov4","search_text":"As a demonstration, we will re-implement the word count using a DataFrame . We first load the data to obtain a Bag of words, and then we convert the Bag to a DataFrame using the to_dataframe method. By passing a column name to the to_dataframe method, we can initialize a DataFrame , which contains a single column, named words :","text_count":329,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a demonstration, we will re-implement the word count using a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":". We first load the data to obtain a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Bag"}]},{"block_type":"text","content":"&nbsp;of words, and then we convert the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Bag"}]},{"block_type":"text","content":"to a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":"using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"to_dataframe"}]},{"block_type":"text","content":"method. By passing a column name to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"to_dataframe"}]},{"block_type":"text","content":"method, we can initialize a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":", which contains a single column, named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"words"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocov5","search_text":"collection = dab.from_sequence([\"the cat sat on the mat\", \"the dog sat on the mat\"], npartitions=2) words = collection.map(str.split).concat() df = words.to_dataframe(['words']) df.head() # Result: # words # 0 the # 1 cat # 2 sat # 3 on # 4 the ","text_count":245,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"collection = dab.from_sequence([\"the cat sat on the mat\",\n                                    \"the dog sat on the mat\"], npartitions=2)\n    words = collection.map(str.split).concat()\n    df = words.to_dataframe(['words'])\n    df.head()\n    # Result:\n    #   words\n    # 0   the\n    # 1   cat\n    # 2   sat\n    # 3    on\n    # 4   the"}]}]},{"block_type":"element","block":"k68ocov6","search_text":"Dask DataFrame closely replicates the pandas.DataFrame API. To compute the word count, we only need to call the value_counts method on the words column, and Dask will automatically devise a parallel computation strategy. To trigger the calculation, it is sufficient to call the compute method:","text_count":293,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dask"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":"closely replicates the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pandas.DataFrame"}]},{"block_type":"text","content":"API. To compute the word count, we only need to call the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"value_counts"}]},{"block_type":"text","content":"method on the words column, and Dask will automatically devise a parallel computation strategy. To trigger the calculation, it is sufficient to call the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"compute"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k68ocov7","search_text":"df.words.value_counts().compute() # Result: # the 4 # sat 2 # on 2 # mat 2 # dog 1 # cat 1 # Name: words, dtype: int64 ","text_count":119,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df.words.value_counts().compute()\n    # Result:\n    # the    4\n    # sat    2\n    # on     2\n    # mat    2\n    # dog    1\n    # cat    1\n    # Name: words, dtype: int64"}]}]},{"block_type":"element","block":"k68ocov8","search_text":"An interesting question one may ask is \" what kind of algorithm does DataFrame use under the hood? \". The answer can be found by looking at the upper part of the generated Dask graph, which is displayed in the following figure. The first two rectangles at the bottom represent two partitions of the dataset, which are stored as two pd.Series instances. To calculate the overall count, Dask will first execute value_counts on each of the pd.Series and then combine the counts along with the value_counts_aggregate step:","text_count":518,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An interesting question one may ask is \""},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"what kind of algorithm does DataFrame use under the hood?"}]},{"block_type":"text","content":"\". The answer can be found by looking at the upper part of the generated Dask graph,&nbsp;which is displayed in the following figure. The first two rectangles at the bottom represent two partitions of the dataset, which are stored as two"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"instances. To calculate the overall count, Dask will first execute"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"value_counts"}]},{"block_type":"text","content":"on each of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.Series"}]},{"block_type":"text","content":"and then combine the counts&nbsp;along with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"value_counts_aggregate"}]},{"block_type":"text","content":"step:"}]},{"block_type":"element","block":"k68ocov9","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000007.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocova","search_text":"As you can see, both Dask array and DataFrame take advantage of the fast vectorized implementations of NumPy and Pandas to achieve excellent performance and stability.","text_count":167,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, both Dask"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"array"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":"take advantage of the fast vectorized implementations of NumPy and Pandas to achieve excellent performance and stability."}]},{"block_type":"element","block":"k68ocovb","search_text":"Dask distributed","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Dask distributed"}]},{"block_type":"element","block":"k68ocovc","search_text":"The first iterations of the Dask project were designed to run on a single computer using a thread-based or a process-based scheduler. Recently, the implementation of a new distributed backend can be used to set up and run Dask graphs on a network of computers.","text_count":260,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first iterations of the Dask project were designed to run on a single computer using a thread-based or a process-based scheduler. Recently, the implementation of a new distributed backend can be used to set up and run Dask graphs on a network of computers."}]},{"block_type":"element","block":"k68ocovd","search_text":"Note Dask distributed is not installed automatically with Dask. The library is available through the conda package manager (use the $ conda install distributed command ) as well as pip (with the $ pip install distributed command). ","text_count":231,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dask distributed is not installed automatically with Dask. The library is available through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"conda"}]},{"block_type":"text","content":"package manager (use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"$&nbsp;conda install distributed"}]},{"block_type":"text","content":"command&nbsp;) as well as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip"}]},{"block_type":"text","content":"(with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"$&nbsp;pip install distributed"}]},{"block_type":"text","content":"command)."}]}]},{"block_type":"element","block":"k68ocove","search_text":"Getting started with Dask distributed is really easy. The most basic setup is obtained by instantiating a Client object:","text_count":120,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Getting started with Dask distributed is really easy. The most basic setup is obtained by instantiating a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client"}]},{"block_type":"text","content":"object:"}]},{"block_type":"element","block":"k68ocovf","search_text":"from dask.distributed import Client client = Client() # Result: # <Client: scheduler='tcp://127.0.0.1:46472' processes=4 cores=4> ","text_count":130,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from dask.distributed import Client\n     \n    client = Client()\n    # Result:\n    # &lt;Client: scheduler='tcp://127.0.0.1:46472' processes=4 cores=4&gt;"}]}]},{"block_type":"element","block":"k68ocovg","search_text":"By default, Dask will start a few key processes (on the local machine) necessary for scheduling and executing distributed tasks through the Client instance. The main components of a Dask cluster are a single scheduler and a collection of workers .","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By default, Dask will start a few key processes (on the local machine) necessary for scheduling and executing distributed tasks through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client"}]},{"block_type":"text","content":"instance. The main components of a Dask cluster are a single&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"scheduler"}]},{"block_type":"text","content":"and a collection of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"workers"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocovh","search_text":"The scheduler is the process responsible for distributing the work across the workers and to monitor and manage the results. Generally, when a task is submitted to the user, the scheduler will find a free worker and submit a task for execution. Once the worker is done, the scheduler is informed that the result is available.","text_count":325,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"scheduler"}]},{"block_type":"text","content":"is the process responsible for distributing the work across the workers and to monitor and manage the results. Generally, when a task is submitted to the user, the scheduler will find a free worker and submit a task for execution. Once the worker is done, the scheduler is informed that the result is available."}]},{"block_type":"element","block":"k68ocovi","search_text":"A worker is a process that accepts incoming tasks and produces results. Workers can reside on different machines over the network. Workers execute tasks using ThreadPoolExecutor . This can be used to achieve parallelism when using functions that do not acquire the GIL (such as Numpy, Pandas, and Cython functions in nogil blocks). When executing pure Python code, it is advantageous to start many single-threaded worker processes as this will enable parallelism for code that acquires the GIL.","text_count":494,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A worker is a process that accepts incoming tasks and produces results. Workers can reside on different machines over the network. Workers execute tasks using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ThreadPoolExecutor"}]},{"block_type":"text","content":". This can be used to achieve parallelism when using functions that do not acquire the GIL (such as Numpy, Pandas, and Cython functions in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nogil"}]},{"block_type":"text","content":"blocks). When executing pure Python code, it is advantageous to start many single-threaded worker processes as this will enable parallelism for code that acquires the GIL."}]},{"block_type":"element","block":"k68ocovj","search_text":"The Client class can be used to submit tasks manually to the scheduler using familiar asynchronous methods. For example, to submit a function for execution on the cluster, one can use the Client.map and Client.submit methods. In the following code, we demonstrate the use of Client.map and Client.submit to calculate the square of a few numbers. The Client will submit a series of tasks to the scheduler and we will receive a Future instance for each task:","text_count":456,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client"}]},{"block_type":"text","content":"class can be used to submit tasks manually to the scheduler using familiar asynchronous methods. For example, to submit a function for execution on the cluster, one can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client.map"}]},{"block_type":"text","content":"and&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client.submit"}]},{"block_type":"text","content":"methods.&nbsp;In the following code, we demonstrate the use of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client.map"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client.submit"}]},{"block_type":"text","content":"to calculate the square of a few numbers. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client"}]},{"block_type":"text","content":"will submit a series of tasks to the scheduler and we will receive a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":"instance for each task:"}]},{"block_type":"element","block":"k68ocovk","search_text":"def square(x): return x ** 2 fut = client.submit(square, 2) # Result: # <Future: status: pending, key: square-05236e00d545104559e0cd20f94cd8ab> client.map(square) futs = client.map(square, [0, 1, 2, 3, 4]) # Result: # [<Future: status: pending, key: square-d043f00c1427622a694f518348870a2f>, # <Future: status: pending, key: square-9352eac1fb1f6659e8442ca4838b6f8d>, # <Future: status: finished, type: int, key: # square-05236e00d545104559e0cd20f94cd8ab>, # <Future: status: pending, key: # square-c89f4c21ae6004ce0fe5206f1a8d619d>, # <Future: status: pending, key: # square-a66f1c13e2a46762b092a4f2922e9db9>] ","text_count":610,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"def square(x):\n       return x ** 2\n\n    fut = client.submit(square, 2)\n    # Result:\n    # &lt;Future: status: pending, key: square-05236e00d545104559e0cd20f94cd8ab&gt;\n\n    client.map(square)\n    futs = client.map(square, [0, 1, 2, 3, 4])\n    # Result:\n    # [&lt;Future: status: pending, key: square-d043f00c1427622a694f518348870a2f&gt;,\n    #  &lt;Future: status: pending, key: square-9352eac1fb1f6659e8442ca4838b6f8d&gt;,\n    #  &lt;Future: status: finished, type: int, key: \n    #  square-05236e00d545104559e0cd20f94cd8ab&gt;,\n    #  &lt;Future: status: pending, key: \n    #  square-c89f4c21ae6004ce0fe5206f1a8d619d&gt;,\n    #  &lt;Future: status: pending, key: \n    #  square-a66f1c13e2a46762b092a4f2922e9db9&gt;]"}]}]},{"block_type":"element","block":"k68ocovl","search_text":"So far, this is quite similar to what we saw in the earlier chapters with TheadPoolExecutor and ProcessPoolExecutor . Note however, that Dask Distributed not only submits the tasks, but also caches the computation results on the worker memory. You can see caching in action by looking at the preceding code example. When we first invoke client.submit , the square(2) task is created and its status is set to pending . When we subsequently invoke client.map , the square(2) task is resubmitted to the scheduler, but this time, rather than recalculating its value, the scheduler directly retrieves the result for the worker. As a result, the third Future returned by map already has a finished status.","text_count":699,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So far, this is quite similar to what we&nbsp;saw in the earlier chapters with&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"TheadPoolExecutor"}]},{"block_type":"text","content":"&nbsp;and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ProcessPoolExecutor"}]},{"block_type":"text","content":". Note however, that Dask Distributed not only submits the tasks, but also caches the computation results on the worker memory. You can see caching in action by looking at the&nbsp;preceding code example. When we first invoke"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"client.submit"}]},{"block_type":"text","content":", the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"square(2)"}]},{"block_type":"text","content":"task is created and its status is set to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pending"}]},{"block_type":"text","content":". When we subsequently invoke"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"client.map"}]},{"block_type":"text","content":", &nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"square(2)"}]},{"block_type":"text","content":"task is resubmitted to the scheduler, but this time, rather than recalculating its value, the scheduler directly retrieves the result for the worker. As a result, the third"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":"returned by map already has a finished status."}]},{"block_type":"element","block":"k68ocovm","search_text":"Results from a collection of Future instances can be retrieved using the Client.gather method:","text_count":94,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Results from a collection of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Future"}]},{"block_type":"text","content":"instances can be retrieved using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client.gather"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k68ocovn","search_text":"client.gather(futs) # Result: # [0, 1, 4, 9, 16] ","text_count":49,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"client.gather(futs)\n    # Result:\n    # [0, 1, 4, 9, 16]"}]}]},{"block_type":"element","block":"k68ocovo","search_text":"Client can also be used to run arbitrary Dask graphs. For example, we can trivially run our approximation of pi by passing the client.get function as an optional argument to pi.compute :","text_count":186,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client"}]},{"block_type":"text","content":"can also be used to run arbitrary Dask graphs. For example, we can trivially run our approximation of pi by passing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"client.get"}]},{"block_type":"text","content":"&nbsp;function as an optional argument to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pi.compute"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocovp","search_text":"pi.compute(get=client.get) ","text_count":27,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"pi.compute(get=client.get)"}]}]},{"block_type":"element","block":"k68ocovq","search_text":"This feature makes Dask extremely scalable as it is possible to develop and run algorithms on the local machine using one of the simpler schedulers and, in case the performance is not satisfactory, to reuse the same algorithms on a cluster of hundreds of machines. ","text_count":265,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This feature makes Dask extremely scalable as it is possible to develop and run algorithms on the local machine using one of the simpler schedulers and, in case the performance is not satisfactory, to reuse the same algorithms on a cluster of hundreds of machines. &nbsp;"}]},{"block_type":"element","block":"k68ocovr","search_text":"Manual cluster setup","text_count":20,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Manual cluster setup"}]},{"block_type":"element","block":"k68ocovs","search_text":"To instantiate scheduler and workers manually, one can use the dask-scheduler and dask-worker command-line utilities. First, we can initialize a scheduler using the dask-scheduler command:","text_count":188,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To instantiate scheduler and workers manually, one can&nbsp;use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask-scheduler"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask-worker"}]},{"block_type":"text","content":"command-line utilities. First, we can initialize&nbsp;a scheduler using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask-scheduler"}]},{"block_type":"text","content":"command:"}]},{"block_type":"element","block":"k68ocovt","search_text":"$ dask-scheduler distributed.scheduler - INFO - ----------------------------------------------- distributed.scheduler - INFO - Scheduler at: tcp://192.168.0.102:8786 distributed.scheduler - INFO - bokeh at: 0.0.0.0:8788 distributed.scheduler - INFO - http at: 0.0.0.0:9786 distributed.bokeh.application - INFO - Web UI: http://127.0.0.1:8787/status/ distributed.scheduler - INFO - ----------------------------------------------- ","text_count":429,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ dask-scheduler\ndistributed.scheduler - INFO - -----------------------------------------------\ndistributed.scheduler - INFO - Scheduler at: tcp://192.168.0.102:8786\ndistributed.scheduler - INFO - bokeh at: 0.0.0.0:8788\ndistributed.scheduler - INFO - http at: 0.0.0.0:9786\ndistributed.bokeh.application - INFO - Web UI: http://127.0.0.1:8787/status/\ndistributed.scheduler - INFO - -----------------------------------------------"}]}]},{"block_type":"element","block":"k68ocovu","search_text":"This will provide an address for the scheduler and a Web UI address that can be accessed to monitor the state of the cluster. Now, we can assign some workers to the scheduler; this can be accomplished using the dask-worker command and by passing the address of the scheduler to the worker. This will automatically start a worker with four threads:","text_count":347,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This will provide an address for the scheduler and a Web UI address that can be accessed to monitor the state of the cluster. Now, we can assign some workers to the scheduler; this can be accomplished using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"dask-worker"}]},{"block_type":"text","content":"command and by passing the address of the scheduler to the worker. This will automatically start a worker with&nbsp;four threads:"}]},{"block_type":"element","block":"k68ocovv","search_text":"$ dask-worker 192.168.0.102:8786 distributed.nanny - INFO - Start Nanny at: 'tcp://192.168.0.102:45711' distributed.worker - INFO - Start worker at: tcp://192.168.0.102:45928 distributed.worker - INFO - bokeh at: 192.168.0.102:8789 distributed.worker - INFO - http at: 192.168.0.102:46154 distributed.worker - INFO - nanny at: 192.168.0.102:45711 distributed.worker - INFO - Waiting to connect to: tcp://192.168.0.102:8786 distributed.worker - INFO - ------------------------------------------------- distributed.worker - INFO - Threads: 4 distributed.worker - INFO - Memory: 4.97 GB distributed.worker - INFO - Local Directory: /tmp/nanny-jh1esoo7 distributed.worker - INFO - ------------------------------------------------- distributed.worker - INFO - Registered to: tcp://192.168.0.102:8786 distributed.worker - INFO - ------------------------------------------------- distributed.nanny - INFO - Nanny 'tcp://192.168.0.102:45711' starts worker process 'tcp://192.168.0.102:45928' ","text_count":984,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ dask-worker 192.168.0.102:8786\ndistributed.nanny - INFO - Start Nanny at: 'tcp://192.168.0.102:45711'\ndistributed.worker - INFO - Start worker at: tcp://192.168.0.102:45928\ndistributed.worker - INFO - bokeh at: 192.168.0.102:8789\ndistributed.worker - INFO - http at: 192.168.0.102:46154\ndistributed.worker - INFO - nanny at: 192.168.0.102:45711\ndistributed.worker - INFO - Waiting to connect to: tcp://192.168.0.102:8786\ndistributed.worker - INFO - -------------------------------------------------\ndistributed.worker - INFO - Threads: 4\ndistributed.worker - INFO - Memory: 4.97 GB\ndistributed.worker - INFO - Local Directory: /tmp/nanny-jh1esoo7\ndistributed.worker - INFO - -------------------------------------------------\ndistributed.worker - INFO - Registered to: tcp://192.168.0.102:8786\ndistributed.worker - INFO - -------------------------------------------------\ndistributed.nanny - INFO - Nanny 'tcp://192.168.0.102:45711' starts worker process 'tcp://192.168.0.102:45928'"}]}]},{"block_type":"element","block":"k68ocovw","search_text":"The Dask scheduler is fairly resilient in the sense that if we add and remove a worker, it is able to track which results are unavailable and recompute them on-demand. Finally, in order to use the initialized scheduler from a Python session, it is sufficient to initialize a Client instance and provide the address for the scheduler:","text_count":333,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Dask scheduler is fairly resilient in the sense that if we add and remove a worker, it is able to track which results are unavailable and recompute them on-demand. Finally, in order to use the initialized scheduler from a Python session, it is sufficient to initialize a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Client"}]},{"block_type":"text","content":"instance and provide the address for the scheduler:"}]},{"block_type":"element","block":"k68ocovx","search_text":"client = Client(address='192.168.0.102:8786') # Result: # <Client: scheduler='tcp://192.168.0.102:8786' processes=1 cores=4> ","text_count":125,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"client = Client(address='192.168.0.102:8786')\n# Result: \n# &lt;Client: scheduler='tcp://192.168.0.102:8786' processes=1 cores=4&gt;"}]}]},{"block_type":"element","block":"k68ocovy","search_text":"Dask also provides a convenient diagnostic Web UI that can be used to monitor the status and time spent for each of the tasks performed on the cluster. In the next figure, the Task Stream shows the time taken for executing the pi estimation. In the plot, each horizontal gray line corresponds to a thread used by the workers (in our case, we have one worker with four threads, also called Worker Core ), and each rectangular box corresponds to a task, colored so that the same task types have the same color (for example, addition, power, or exponent). From this plot, you can observe how all the boxes are very small and far from each other. This means that the tasks are quite small compared to the overhead of communication.","text_count":727,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dask also provides a convenient diagnostic Web UI&nbsp;that can be used to monitor the status and time spent for each of the tasks performed on the cluster. In the next figure, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task Stream"}]},{"block_type":"text","content":"shows the time taken for executing the pi estimation. In the plot, each horizontal gray line corresponds to a thread used by the workers (in our case, we have one worker with four&nbsp;threads, also called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Worker Core"}]},{"block_type":"text","content":"), and each rectangular box corresponds to a task, colored&nbsp;so&nbsp;that&nbsp;the same task types have the same color (for example,&nbsp;addition, power, or exponent). From this plot, you can observe how all the boxes are very small and far from each other. This means that the tasks are quite small compared to the overhead of communication."}]},{"block_type":"element","block":"k68ocovz","search_text":"In this case, an increase in chunk size, which implies to an increase in the time required to run each task compared to the time of communication, will be beneficial.","text_count":166,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this case,&nbsp;an increase in chunk size, which implies to an increase&nbsp;in the time required to run each task compared to the time of communication, will be beneficial."}]},{"block_type":"element","block":"k68ocow0","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000037.png","class":"lazyload"},"children":[]}]},{"block_type":"text","content":"&nbsp;"}]},{"block_type":"element","block":"k68ocow1","search_text":"Using PySpark","text_count":13,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Using PySpark"}]},{"block_type":"element","block":"k68ocow2","search_text":"Nowadays, Apache Spark is one of the most popular projects for distributed computing. Developed in Scala, Spark was released in 2014, and integrates with HDFS and provides several advantages and improvements over the Hadoop MapReduce framework.","text_count":244,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Nowadays, Apache Spark is one of the most popular projects for distributed computing. Developed in Scala, Spark was released in 2014, and integrates with HDFS and provides several advantages and improvements over the Hadoop MapReduce framework."}]},{"block_type":"element","block":"k68ocow3","search_text":"Contrary to Hadoop MapReduce, Spark is designed to process data interactively and supports APIs for the Java, Scala, and Python programming languages. Given its different architecture, especially by the fact that Spark keep results in memory, Spark is generally much faster than Hadoop MapReduce. ","text_count":297,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Contrary to Hadoop MapReduce, Spark is designed to process data interactively and supports APIs for the Java, Scala, and Python programming languages. Given its different architecture, especially by the fact that Spark keep results in memory, Spark is generally much faster than Hadoop MapReduce.&nbsp;"}]},{"block_type":"element","block":"k68ocow4","search_text":"Setting up Spark and PySpark","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Setting up Spark and PySpark"}]},{"block_type":"element","block":"k68ocow5","search_text":"Setting up PySpark from scratch requires the installation of the Java and Scala runtimes, the compilation of the project from source, and the configuration of Python and Jupyter notebook so that they can be used alongside the Spark installation. An easier and less error-prone way to set up PySpark is to use an already configured Spark cluster made available through a Docker container. ","text_count":388,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Setting up PySpark from scratch requires the installation of the Java and Scala runtimes, the compilation of&nbsp;the project from source, and the configuration of&nbsp;Python and Jupyter notebook&nbsp;so that they can be used alongside the Spark installation. An easier and less error-prone way to set up PySpark is to use an already configured Spark cluster made available through a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Docker"}]},{"block_type":"text","content":"container. &nbsp;"}]},{"block_type":"element","block":"k68ocow6","search_text":"Note Docker can be downloaded at https://www.docker.com/ . If you're new to containers, you can read the next chapter for an introduction. ","text_count":139,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Docker can be downloaded at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.docker.com/"},"children":[{"block_type":"text","content":"https://www.docker.com/"}]},{"block_type":"text","content":"&nbsp;. If you're new to containers, you can read the next chapter for an introduction."}]}]},{"block_type":"element","block":"k68ocow7","search_text":"To set up a Spark cluster, it is sufficient to go in this chapter's code files (where a file named Dockerfile is located) and issue the following command:","text_count":154,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To set up a Spark cluster, it is sufficient to go in this chapter's code files (where&nbsp;a file named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Dockerfile"}]},{"block_type":"text","content":"is located) and issue the following command:"}]},{"block_type":"element","block":"k68ocow8","search_text":"$ docker build -t pyspark ","text_count":26,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ docker build -t pyspark"}]}]},{"block_type":"element","block":"k68ocow9","search_text":"This command will automatically download, install, and configure Spark, Python, and Jupyter notebook in an isolated environment. To start Spark and a Jupyter notebook session, you can execute the following command:","text_count":214,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This command will automatically download, install, and configure Spark, Python, and Jupyter notebook in an isolated environment. To start Spark and a Jupyter notebook session, you can execute the following command:"}]},{"block_type":"element","block":"k68ocowa","search_text":"$ docker run -d -p 8888:8888 -p 4040:4040 pyspark 22b9dbc2767c260e525dcbc562b84a399a7f338fe1c06418cbe6b351c998e239 ","text_count":115,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ docker run -d -p 8888:8888 -p 4040:4040 pyspark\n22b9dbc2767c260e525dcbc562b84a399a7f338fe1c06418cbe6b351c998e239"}]}]},{"block_type":"element","block":"k68ocowb","search_text":"The command will print a unique ID (called container id ) that you can use to reference the application container and will start Spark and Jupyter notebook in the background. The -p option ensures that we can access the SparkUI and Jupyter network ports from the local machine. After issuing the command, you can open a browser to http://127.0.0.1:8888 to access the Jupyter notebook session. You can test the correct initialization of Spark by creating a new notebook and executing the following content inside a cell:","text_count":519,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The command will print a unique&nbsp;ID (called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"container id"}]},{"block_type":"text","content":") that you can use to reference the application container and will start Spark and Jupyter notebook in the background. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-p"}]},{"block_type":"text","content":"option ensures that we can access the SparkUI and Jupyter network ports from the local machine. After issuing the command, you can open a browser to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"http://127.0.0.1:8888"}]},{"block_type":"text","content":"to access the Jupyter notebook session. You can test the correct initialization of Spark by creating a new notebook and executing the following content inside a cell:"}]},{"block_type":"element","block":"k68ocowc","search_text":"import pyspark sc = pyspark.SparkContext('local[*]') rdd = sc.parallelize(range(1000)) rdd.first() # Result: # 0 ","text_count":113,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import pyspark\n    sc = pyspark.SparkContext('local[*]')\n\n    rdd = sc.parallelize(range(1000))\n    rdd.first()\n    # Result:\n    # 0"}]}]},{"block_type":"element","block":"k68ocowd","search_text":"This will initialize a SparkContext and take the first element in a collection (those new terms will be explained in detail later). Once the SparkContext is initialized, we can also head over to http://127.0.0.1:4040 to open the Spark Web UI.","text_count":242,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This will initialize a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"SparkContext"}]},{"block_type":"text","content":"&nbsp;and take the first element in a collection (those new terms will be explained in detail later). Once the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"SparkContext"}]},{"block_type":"text","content":"is initialized, we can also head over to"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://127.0.0.1:4040"},"children":[{"block_type":"text","content":"http://127.0.0.1:4040"}]},{"block_type":"text","content":"to open the Spark Web UI."}]},{"block_type":"element","block":"k68ocowe","search_text":"Now that the setup is complete, we will understand how Spark works and how to implement simple parallel algorithms using its powerful API.","text_count":138,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that the setup is complete, we will understand how Spark works and how to implement simple parallel algorithms using its powerful API."}]},{"block_type":"element","block":"k68ocowf","search_text":"Spark architecture","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Spark architecture"}]},{"block_type":"element","block":"k68ocowg","search_text":"A Spark cluster is a set of processes distributed over different machines. The Driver Program is a process, such as a Scala or Python interpreter, used by the user to submit the tasks to be executed.","text_count":199,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A Spark cluster is a set of processes distributed over different machines. The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Driver Program"}]},{"block_type":"text","content":"is a process, such as a Scala or Python interpreter, used by the user to submit the tasks to be executed."}]},{"block_type":"element","block":"k68ocowh","search_text":"The user can build task graphs, similar to Dask, using a special API and submit those tasks to the Cluster Manager that is responsible for assigning these tasks to Executors , processes responsible for executing the tasks. In a multi-user system, the Cluster Manager is also responsible for allocating resources on a per-user basis.","text_count":332,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The user can build task graphs, similar to Dask, using a special API and submit those tasks to the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cluster Manager"}]},{"block_type":"text","content":"that is responsible for&nbsp;assigning these tasks to"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Executors"}]},{"block_type":"text","content":", processes responsible for executing&nbsp;the tasks. In a multi-user system, the Cluster Manager is also responsible for allocating resources on a per-user basis."}]},{"block_type":"element","block":"k68ocowi","search_text":"The user interacts with the Cluster Manager through the Driver Program. The class responsible for communication between the user and the Spark cluster is called SparkContext . This class is able to connect and configure the Executors on the cluster based on the resources available to the user.","text_count":294,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The user interacts with the Cluster Manager through&nbsp;the Driver Program. The class responsible for communication between the user and the Spark cluster is&nbsp;called"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"SparkContext"}]},{"block_type":"text","content":". This class is able to connect and configure the Executors&nbsp;on the cluster based on the resources available to the user."}]},{"block_type":"element","block":"k68ocowj","search_text":"For its most common use-cases, Spark manages its data through a data structure called Resilient Distributed Datasets ( RDD ), which represents a collection of items. RDDs are capable of handling massive datasets by separating their elements into partitions and operating on the partitions in parallel (note that this mechanism is mainly hidden from the user). RDDs can also be stored in memory (optionally, and when appropriate) for fast access and to cache expensive intermediate results.","text_count":489,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For its most common use-cases, Spark manages its data through a data structure called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Resilient Distributed Datasets"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"RDD"}]},{"block_type":"text","content":"), which represents a collection of items. RDDs are capable of handling massive datasets by separating their elements into partitions and operating on the partitions in parallel (note that this mechanism is mainly hidden from the user). RDDs can also be stored in memory (optionally, and when appropriate) for fast access and to cache expensive intermediate results."}]},{"block_type":"element","block":"k68ocowk","search_text":"Using RDDs, it is possible to define tasks and transformations (similarly to how we were automatically generating computation graphs in Dask) and, when requested, the Cluster Manager will automatically dispatch and execute tasks on the available Executors.","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using RDDs, it is possible to define tasks and transformations (similarly to how we were automatically generating computation graphs in Dask) and, when requested, the Cluster Manager will automatically dispatch and execute tasks on the available Executors."}]},{"block_type":"element","block":"k68ocowl","search_text":"The Executors will receive the tasks from the Cluster Manager, execute them, and keep the results around if needed. Note that an Executor can have multiple cores and each node in the cluster may have multiple Executors. Generally speaking, Spark is fault tolerant on Executor's failures.","text_count":287,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Executors will receive the tasks from the Cluster Manager, execute them, and keep the results around if needed. Note that an Executor can have multiple cores and each node in the cluster may have multiple Executors. Generally speaking, Spark is fault tolerant on Executor's failures."}]},{"block_type":"element","block":"k68ocowm","search_text":"In the following diagram, we show how the aforementioned components interact in a Spark cluster. The Driver Program interacts with the Cluster Manager that manages the Executor instances on different nodes (each Executor instance can also have multiple threads). Note that, even if the Driver Program doesn't directly control the Executors, the results, which are stored in the Executor instances, are transferred directly between the Executors and the Driver Program. For this reason, it's important that the Driver Program is network-reachable from the Executor processes: ","text_count":575,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following diagram, we show how the aforementioned components interact in a Spark cluster. The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Driver Program"}]},{"block_type":"text","content":"interacts with the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cluster Manager"}]},{"block_type":"text","content":"that manages the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Executor"}]},{"block_type":"text","content":"instances on different nodes (each Executor instance can also have multiple threads). Note that, even if the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Driver Program"}]},{"block_type":"text","content":"doesn't directly control the Executors, the results, which are stored in the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Executor"}]},{"block_type":"text","content":"instances, are transferred directly between the Executors and the Driver Program.&nbsp;For this reason, it's important that the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Driver Program"}]},{"block_type":"text","content":"is network-reachable from the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Executor"}]},{"block_type":"text","content":"processes:&nbsp;"}]},{"block_type":"element","block":"k68ocown","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000036.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocowo","search_text":"A natural question to ask is: How is Spark, a software written in Scala, able to execute Python code? The integration is done through the Py4J library, which maintains a Python process under-the-hood and communicates with it through sockets (a form of interprocess communication). In order to run the tasks, Executors maintain a series of Python processes so that they are able to process Python code in parallel. ","text_count":414,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A natural question to ask is: How is Spark, a software written in Scala, able to execute Python code? The integration is done through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Py4J"}]},{"block_type":"text","content":"library, which maintains a Python process under-the-hood and communicates with it through sockets (a form of interprocess communication). In order to run the tasks, Executors maintain a series of Python processes so that they are able to process Python code in parallel.&nbsp;"}]},{"block_type":"element","block":"k68ocowp","search_text":"RDDs and variables defined in a Python process in the Driver Program are serialized, and the communication between the Cluster Manager and the Executors (including shuffling) is dealt with by Spark's Scala code. The extra serialization steps necessary for the Python and Scala interchange, all contribute to the overhead of communication; therefore, when using PySpark, extra care must be taken to ensure that the data structures used are serialized efficiently and that the data partitions are big enough so that the cost of communication is negligible compared to the cost of execution. ","text_count":589,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"RDDs and variables defined in a Python process in the Driver Program are serialized, and the communication between the Cluster Manager and the Executors (including shuffling) is dealt with by Spark's Scala code. The extra serialization steps necessary for the Python and Scala interchange, all contribute to the overhead of communication; therefore, when using PySpark, extra care must be taken to ensure that the data structures used are serialized efficiently and that the data partitions are big enough so that the cost of communication is negligible compared to the cost of execution.&nbsp;"}]},{"block_type":"element","block":"k68ocowq","search_text":"The following diagram illustrates the additional Python processes needed for PySpark execution. These additional Python processes come with associated memory costs and an extra layer of indirection that complicate error reporting:","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following&nbsp;diagram illustrates the additional Python processes needed for PySpark execution. These additional Python processes come with associated memory costs and an extra layer of indirection that complicate error reporting:"}]},{"block_type":"element","block":"k68ocowr","search_text":"","text_count":0,"tag_name":"div","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/python-web-development-tools/images/000026.png","class":"lazyload"},"children":[]}]}]},{"block_type":"element","block":"k68ocows","search_text":"Despite these drawbacks, PySpark is still a widely used tool because it bridges the vivid Python ecosystem with the industrial strength of the Hadoop infrastructure. ","text_count":166,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Despite these drawbacks, PySpark is still a widely used tool because it&nbsp;bridges the vivid Python ecosystem with the industrial strength of the Hadoop infrastructure.&nbsp;"}]},{"block_type":"element","block":"k68ocowt","search_text":"Resilient Distributed Datasets","text_count":30,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Resilient Distributed Datasets"}]},{"block_type":"element","block":"k68ocowu","search_text":"The easiest way to create an RDD in Python is with the SparkContext.parallelize method. This method was also used earlier where we parallelized a collection of integers between 0 and 1000 :","text_count":189,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The easiest way to create an RDD in Python is&nbsp;with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"SparkContext.parallelize"}]},{"block_type":"text","content":"method. This method was also used earlier where we parallelized a collection of integers between"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"1000"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocowv","search_text":"rdd = sc.parallelize(range(1000)) # Result: # PythonRDD[3] at RDD at PythonRDD.scala:48 ","text_count":88,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"rdd = sc.parallelize(range(1000))\n    # Result:\n    # PythonRDD[3] at RDD at PythonRDD.scala:48"}]}]},{"block_type":"element","block":"k68ocoww","search_text":"The rdd collection will be divided into a number of partitions which, in this case, correspond to a default value of four (the default value can be changed using configuration options). To explicitly specify the number of partitions, one can pass an extra argument to parallelize :","text_count":281,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"rdd"}]},{"block_type":"text","content":"collection will be divided into a number of partitions which, in this case, correspond to a default value of&nbsp;four (the default value can be changed using configuration options). To explicitly specify the number of partitions, one can pass an extra argument to"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"parallelize"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocowx","search_text":"rdd = sc.parallelize(range(1000), 2) rdd.getNumPartitions() # This function will return the number of partitions # Result: # 2 ","text_count":127,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"rdd = sc.parallelize(range(1000), 2)\n    rdd.getNumPartitions() # This function will return the number of partitions\n    # Result:\n    # 2"}]}]},{"block_type":"element","block":"k68ocowy","search_text":"RDDs support a lot of functional programming operators, similar to what we used back in Chapter 6, Implementing Concurrency , with reactive programming and data streams (even though, in that case, the operators were designed to work on events over time rather than normal collections). For example, we may illustrate the basic map function which, by now, should be quite familiar. In the following code, we use map to calculate the square of a series of numbers:","text_count":462,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"RDDs support a lot of functional programming operators,&nbsp;similar to what we used back in Chapter 6,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Implementing Concurrency"}]},{"block_type":"text","content":",&nbsp;with reactive programming and data streams (even though, in that case, the operators were designed to work on events over time rather than normal collections). For example, we may illustrate the basic&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"function which, by now, should be quite familiar. In the following code, we use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"&nbsp;to calculate the square of a series of numbers:"}]},{"block_type":"element","block":"k68ocowz","search_text":"square_rdd = rdd.map(lambda x: x**2) # Result: # PythonRDD[5] at RDD at PythonRDD.scala:48 ","text_count":91,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"square_rdd = rdd.map(lambda x: x**2)\n    # Result:\n    # PythonRDD[5] at RDD at PythonRDD.scala:48"}]}]},{"block_type":"element","block":"k68ocox0","search_text":"The map function will return a new RDD but won't compute anything just yet. In order to trigger the execution, you can use the collect method, which will retrieve all the elements in the collection, or take , which will return only the first ten elements:","text_count":255,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"&nbsp;function will return a new RDD but won't compute anything just yet. In order to trigger the&nbsp;execution, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"collect"}]},{"block_type":"text","content":"method, which will retrieve all the elements in the collection, or&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"take"}]},{"block_type":"text","content":", which will return only the first ten&nbsp;elements:"}]},{"block_type":"element","block":"k68ocox1","search_text":"square_rdd.collect() # Result: # [0, 1, ... ] square_rdd.take(10) # Result: # [0, 1, 4, 9, 16, 25, 36, 49, 64, 81] ","text_count":115,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"square_rdd.collect()\n    # Result:\n    # [0, 1, ... ]\n\n    square_rdd.take(10)\n    # Result:\n    # [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]"}]}]},{"block_type":"element","block":"k68ocox2","search_text":"For a comparison between PySpark, Dask, and the other parallel programming libraries we explored in the earlier chapters, we will reimplement the approximation of pi. In the PySpark implementation, we will first create two RDDs of random numbers using parallelize , then we combine the datasets using the zip function (this is equivalent to Python's zip ), and we finally test whether the random points are inside the circle:","text_count":425,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For a comparison between&nbsp;PySpark, Dask, and the other parallel programming libraries we explored in the&nbsp;earlier chapters, we will reimplement the approximation of pi. In the PySpark implementation, we will first create two RDDs of random numbers using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"parallelize"}]},{"block_type":"text","content":", then we combine the datasets using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"zip"}]},{"block_type":"text","content":"function (this is equivalent to Python's"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"zip"}]},{"block_type":"text","content":"), and we finally test&nbsp;whether the random points are inside the circle:"}]},{"block_type":"element","block":"k68ocox3","search_text":"import numpy as np N = 10000 x = np.random.uniform(-1, 1, N) y = np.random.uniform(-1, 1, N) rdd_x = sc.parallelize(x) rdd_y = sc.parallelize(y) hit_test = rdd_x.zip(rdd_y).map(lambda xy: xy[0] ** 2 + xy[1] ** 2 < 1) pi = 4 * hit_test.sum()/N ","text_count":243,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import numpy as np\n\n    N = 10000\n    x = np.random.uniform(-1, 1, N)\n    y = np.random.uniform(-1, 1, N)\n\n    rdd_x = sc.parallelize(x)\n    rdd_y = sc.parallelize(y)\n\n    hit_test = rdd_x.zip(rdd_y).map(lambda xy: xy[0] ** 2 + xy[1] ** 2 &lt; 1)\n    pi = 4 * hit_test.sum()/N"}]}]},{"block_type":"element","block":"k68ocox4","search_text":"It's important to note that both the zip and map operations produce new RDDs and do not actually execute the instruction on the underlying data. In the preceding example, code execution is triggered when we call the hit_test.sum function, which returns an integer. This behavior is different from the Dask API where the whole computation (including the final result, pi ) did not trigger the execution.","text_count":402,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to note that both the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"zip"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"operations produce new RDDs and do not actually execute the instruction on the underlying data. In the&nbsp;preceding example, code execution is triggered when we call the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hit_test.sum"}]},{"block_type":"text","content":"function, which returns an integer. This behavior is different from the Dask API&nbsp;where the whole computation (including the final result,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pi"}]},{"block_type":"text","content":") did not trigger the execution."}]},{"block_type":"element","block":"k68ocox5","search_text":"We can now move on to a more interesting application to demonstrate more RDD methods. We will learn how to count the number of visits each user of a website performs in a day. In a real-world scenario, the data would have been collected in a database and/or stored in a distributed filesystem, such as HDFS. However, in our example, we will generate some data that we will then analyze.","text_count":386,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now move on to a more interesting application to demonstrate more RDD methods. We will learn how to count the number of visits each user of a website performs in a day. In a real-world scenario, the data would have been collected in a database and/or stored in a distributed filesystem, such as HDFS. However, in our example, we will generate some data that we will then analyze."}]},{"block_type":"element","block":"k68ocox6","search_text":"In the following code, we generate a list of dictionaries, each containing a user (selected among twenty users) and a timestamp . The steps to produce the dataset are as follows:","text_count":178,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following code, we generate a list of dictionaries, each containing a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"user"}]},{"block_type":"text","content":"&nbsp;(selected among twenty&nbsp;users) and a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"timestamp"}]},{"block_type":"text","content":". The steps to produce the dataset are as follows:"}]},{"block_type":"element","block":"k68ocox7","search_text":"Create a pool of 20 users (the users variable). Define a function that returns a random time between two dates. For 10,000 times, we choose a random user from our users pool and a random timestamp between the dates January 1, 2017 and January 7, 2017. ","text_count":252,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Create a pool of 20 users (the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"users"}]},{"block_type":"text","content":"variable)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Define a function that returns a random time between two dates."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"For 10,000 times, we choose a random user from our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"users"}]},{"block_type":"text","content":"pool and a random timestamp between the dates January 1, 2017 and January 7, 2017."}]}]},{"block_type":"element","block":"k68ocox8","search_text":"import datetime from uuid import uuid4 from random import randrange, choice # We generate 20 users n_users = 20 users = [uuid4() for i in range(n_users)] def random_time(start, end): '''Return a random timestamp between start date and end date''' # We select a number of seconds total_seconds = (end - start).total_seconds() return start + datetime.timedelta(seconds=randrange(total_seconds)) start = datetime.datetime(2017, 1, 1) end = datetime.datetime(2017, 1, 7) entries = [] N = 10000 for i in range(N): entries.append({ 'user': choice(users), 'timestamp': random_time(start, end) }) ","text_count":589,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"import datetime\n\n      from uuid import uuid4\n      from random import randrange, choice\n\n      # We generate 20 users\n      n_users = 20 \n      users = [uuid4() for i in range(n_users)]\n\n      def random_time(start, end):\n          '''Return a random timestamp between start date and end \n          date'''\n          # We select a number of seconds\n          total_seconds = (end - start).total_seconds()\n          return start + \n          datetime.timedelta(seconds=randrange(total_seconds))\n\n      start = datetime.datetime(2017, 1, 1)\n      end = datetime.datetime(2017, 1, 7)\n\n      entries = []\n      N = 10000\n      for i in range(N):\n          entries.append({\n           'user': choice(users),\n           'timestamp': random_time(start, end)\n          })"}]}]},{"block_type":"element","block":"k68ocox9","search_text":"With the dataset at hand, we can start asking questions and use PySpark to find the answers. One common question is \" How many times has a given user visited the website?. \" A naive way to compute this result can be achieved by grouping the entries RDD by user (using the groupBy operator) and counting how many items are present for each user. In PySpark, groupBy takes a function as argument to extract the grouping key for each element and returns a new RDD that contain tuples of the (key, group) form. In the following example, we use the user ID as the key for our groupBy , and we inspect the first element using first :","text_count":627,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With the dataset at hand, we can start asking questions and use PySpark to find&nbsp;the answers. One common question is \""},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"How many times has a given user visited the website?."}]},{"block_type":"text","content":"\" A naive way to compute this result can be achieved by grouping the entries&nbsp;RDD by user (using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"groupBy"}]},{"block_type":"text","content":"&nbsp;operator) and counting how many items are present for each user.&nbsp;In PySpark,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"groupBy"}]},{"block_type":"text","content":"&nbsp;takes&nbsp;a function as argument to extract the grouping key for each element and returns a new RDD&nbsp;that contain tuples of the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(key, group)"}]},{"block_type":"text","content":"form.&nbsp;In the following example, we use the user ID as the key for our"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"groupBy"}]},{"block_type":"text","content":", and we inspect the first element using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"first"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocoxa","search_text":"entries_rdd = sc.parallelize(entries) entries_rdd.groupBy(lambda x: x['user']).first() # Result: # (UUID('0604aab5-c7ba-4d5b-b1e0-16091052fb11'), # <pyspark.resultiterable.ResultIterable at 0x7faced4cd0b8>) ","text_count":207,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"entries_rdd = sc.parallelize(entries)\n    entries_rdd.groupBy(lambda x: x['user']).first()\n    # Result:\n    # (UUID('0604aab5-c7ba-4d5b-b1e0-16091052fb11'),\n    #  &lt;pyspark.resultiterable.ResultIterable at 0x7faced4cd0b8&gt;)"}]}]},{"block_type":"element","block":"k68ocoxb","search_text":"The return value of groupBy contains a ResultIterable (which is basically a list) for each user ID. To count the number of visits per user, it's sufficient to calculate the length of each ResultIterable :","text_count":204,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The return value of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"groupBy"}]},{"block_type":"text","content":"contains a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ResultIterable"}]},{"block_type":"text","content":"&nbsp;(which is basically a list) for each user ID. To count the number of visits per user, it's sufficient to calculate the length of each"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ResultIterable"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocoxc","search_text":"(entries_rdd .groupBy(lambda x: x['user']) .map(lambda kv: (kv[0], len(kv[1]))) .take(5)) # Result: # [(UUID('0604aab5-c7ba-4d5b-b1e0-16091052fb11'), 536), # (UUID('d72c81c1-83f9-4b3c-a21a-788736c9b2ea'), 504), # (UUID('e2e125fa-8984-4a9a-9ca1-b0620b113cdb'), 498), # (UUID('b90acaf9-f279-430d-854f-5df74432dd52'), 561), # (UUID('00d7be53-22c3-43cf-ace7-974689e9d54b'), 466)] ","text_count":376,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"(entries_rdd\n     .groupBy(lambda x: x['user'])\n     .map(lambda kv: (kv[0], len(kv[1])))\n     .take(5))\n    # Result:\n    # [(UUID('0604aab5-c7ba-4d5b-b1e0-16091052fb11'), 536),\n    #  (UUID('d72c81c1-83f9-4b3c-a21a-788736c9b2ea'), 504),\n    #  (UUID('e2e125fa-8984-4a9a-9ca1-b0620b113cdb'), 498),\n    #  (UUID('b90acaf9-f279-430d-854f-5df74432dd52'), 561),\n    #  (UUID('00d7be53-22c3-43cf-ace7-974689e9d54b'), 466)]"}]}]},{"block_type":"element","block":"k68ocoxd","search_text":"Even though this algorithm may work well in small datasets, groupBy requires us to collect and store the whole set of entries for each user in memory, and this can exceed the memory capacity of an individual node. Since we don't need the list but only the count, there's a better way to calculate this number without having to hold the list of visits for each user in memory.","text_count":375,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even though this algorithm may work well in small datasets,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"groupBy"}]},{"block_type":"text","content":"requires us to collect and store the whole set of entries for each user in memory, and this can exceed the memory capacity of an individual node. Since we don't need the list but only the count, there's a better way to calculate this number without having to hold the list of visits for each user in memory."}]},{"block_type":"element","block":"k68ocoxe","search_text":"Tip When dealing with an RDD of (key, value) pairs, it is possible to use mapValues to apply a function only to the values. In the preceding code, we can replace the map(lambda kv: (kv[0], len(kv[1]))) call with mapValues(len) for better readability. ","text_count":251,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When dealing with an RDD of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"(key, value)"}]},{"block_type":"text","content":"pairs, it is possible to use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mapValues"}]},{"block_type":"text","content":"to apply a function only to the values. In the preceding code, we can replace the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"map(lambda kv: (kv[0], len(kv[1])))"}]},{"block_type":"text","content":"call with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mapValues(len)"}]},{"block_type":"text","content":"for better readability."}]}]},{"block_type":"element","block":"k68ocoxf","search_text":"For a more efficient calculation, we can leverage the reduceByKey function, which will perform a step similar to the Reduce step that we saw in the An introduction to MapReduce section. The reduceByKey function can be called from an RDD of tuples that contain a key as their first element and a value as their second element, and accepts a function as its first argument that will calculate the reduction. A simple example of the reduceByKey function is illustrated in the following snippet. We have a few string keys associated with integer numbers, and we want to get the sum of the values for each key; the reduction, expressed as a lambda, corresponds to the sum of the elements:","text_count":683,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For a more efficient calculation, we can leverage the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"reduceByKey"}]},{"block_type":"text","content":"function, which will perform a step similar to the Reduce step that&nbsp;we saw in the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"An introduction to MapReduce"}]},{"block_type":"text","content":"section. The&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"reduceByKey"}]},{"block_type":"text","content":"&nbsp;function can be called from an RDD of tuples that contain a key as their first element and a value as their second element, and accepts a function as its first argument that will calculate the reduction. &nbsp;A simple example of the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"reduceByKey"}]},{"block_type":"text","content":"&nbsp;function is illustrated in the following snippet. We have a few string keys associated with integer numbers, and we want to get the sum of the values for each key; the reduction, expressed as a lambda, corresponds to the sum of the elements:"}]},{"block_type":"element","block":"k68ocoxg","search_text":"rdd = sc.parallelize([(\"a\", 1), (\"b\", 2), (\"a\", 3), (\"b\", 4), (\"c\", 5)]) rdd.reduceByKey(lambda a, b: a + b).collect() # Result: # [('c', 5), ('b', 6), ('a', 4)] ","text_count":162,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"rdd = sc.parallelize([(\"a\", 1), (\"b\", 2), (\"a\", 3), (\"b\", 4), (\"c\", 5)])\n    rdd.reduceByKey(lambda a, b: a + b).collect()\n    # Result:\n    # [('c', 5), ('b', 6), ('a', 4)]"}]}]},{"block_type":"element","block":"k68ocoxh","search_text":"The reduceByKey function is much more efficient than groupBy because the reduction is parallelizable and doesn't require the in-memory storage of the groups; also, it limits the data shuffled between Executors (it performs similar operations to Dask's foldby , which was explained earlier). At this point, we can rewrite our visit count calculation using reduceByKey :","text_count":368,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"reduceByKey"}]},{"block_type":"text","content":"&nbsp;function is much more efficient than"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"groupBy"}]},{"block_type":"text","content":"because the reduction is parallelizable and doesn't require the in-memory storage of the groups; also, it&nbsp;limits the data shuffled between Executors (it performs similar operations&nbsp;to Dask's&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"foldby"}]},{"block_type":"text","content":", which was explained earlier). At this point, we can rewrite our visit count calculation using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"reduceByKey"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocoxi","search_text":"(entries_rdd .map(lambda x: (x['user'], 1)) .reduceByKey(lambda a, b: a + b) .take(3)) # Result: # [(UUID('0604aab5-c7ba-4d5b-b1e0-16091052fb11'), 536), # (UUID('d72c81c1-83f9-4b3c-a21a-788736c9b2ea'), 504), # (UUID('e2e125fa-8984-4a9a-9ca1-b0620b113cdb'), 498)] ","text_count":263,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"(entries_rdd\n     .map(lambda x: (x['user'], 1))\n     .reduceByKey(lambda a, b: a + b)\n     .take(3))\n    # Result:\n    # [(UUID('0604aab5-c7ba-4d5b-b1e0-16091052fb11'), 536),\n    #  (UUID('d72c81c1-83f9-4b3c-a21a-788736c9b2ea'), 504),\n    #  (UUID('e2e125fa-8984-4a9a-9ca1-b0620b113cdb'), 498)]"}]}]},{"block_type":"element","block":"k68ocoxj","search_text":"With Spark's RDD API, it is also easy to answer questions such as \" How many visits did the website receive each day?. \" This can be computed using reduceByKey with the appropriate key (which is the date extracted from the timestamp). In the following example, we demonstrate the calculation. Also, note the usage of the sortByKey operator to return the counts sorted by date:","text_count":376,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With Spark's RDD API, it is also easy to answer questions such as \""},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"How many visits did the website receive each day?."}]},{"block_type":"text","content":"\" This can be computed using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"reduceByKey"}]},{"block_type":"text","content":"with the appropriate key (which is the date extracted from the timestamp). In the following example, we demonstrate the calculation. Also, note the usage of the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sortByKey"}]},{"block_type":"text","content":"operator to return the counts sorted by date:"}]},{"block_type":"element","block":"k68ocoxk","search_text":"(entries_rdd .map(lambda x: (x['timestamp'].date(), 1)) .reduceByKey(lambda a, b: a + b) .sortByKey() .collect()) # Result: # [(datetime.date(2017, 1, 1), 1685), # (datetime.date(2017, 1, 2), 1625), # (datetime.date(2017, 1, 3), 1663), # (datetime.date(2017, 1, 4), 1643), # (datetime.date(2017, 1, 5), 1731), # (datetime.date(2017, 1, 6), 1653)] ","text_count":347,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"(entries_rdd\n     .map(lambda x: (x['timestamp'].date(), 1))\n     .reduceByKey(lambda a, b: a + b)\n     .sortByKey()\n     .collect())\n    # Result:\n    # [(datetime.date(2017, 1, 1), 1685),\n    #  (datetime.date(2017, 1, 2), 1625),\n    #  (datetime.date(2017, 1, 3), 1663),\n    #  (datetime.date(2017, 1, 4), 1643),\n    #  (datetime.date(2017, 1, 5), 1731),\n    #  (datetime.date(2017, 1, 6), 1653)]"}]}]},{"block_type":"element","block":"k68ocoxl","search_text":"Spark DataFrame","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Spark DataFrame"}]},{"block_type":"element","block":"k68ocoxm","search_text":"For numerical and analytical tasks, Spark provides a convenient interface available through the pyspark.sql module (also called SparkSQL). The module includes a spark.sql.DataFrame class that can be used for efficient SQL-style queries similar to those of Pandas. Access to the SQL interface is provided through the SparkSession class:","text_count":335,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For numerical and analytical tasks, Spark provides a convenient interface available through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyspark.sql"}]},{"block_type":"text","content":"&nbsp;module (also called SparkSQL). The module includes a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"spark.sql.DataFrame"}]},{"block_type":"text","content":"class that can be used for efficient SQL-style queries similar to those of Pandas. Access to the SQL interface is provided&nbsp;through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"SparkSession"}]},{"block_type":"text","content":"class:"}]},{"block_type":"element","block":"k68ocoxn","search_text":"from pyspark.sql import SparkSession spark = SparkSession.builder.getOrCreate() ","text_count":80,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from pyspark.sql import SparkSession\n    spark = SparkSession.builder.getOrCreate()"}]}]},{"block_type":"element","block":"k68ocoxo","search_text":"SparkSession can then be used to create a DataFrame through the function createDataFrame . The function createDataFrame accepts either a RDD, a list, or a pandas.DataFrame .","text_count":173,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"SparkSession"}]},{"block_type":"text","content":"can then be used to create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":"through the function"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"createDataFrame"}]},{"block_type":"text","content":". The function"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"createDataFrame"}]},{"block_type":"text","content":"accepts either a RDD, a list, or a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pandas.DataFrame"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocoxp","search_text":"In the following example, we will create a spark.sql.DataFrame by converting an RDD, rows , which contains a collection of Row instances. The Row instances represent an association between a set of column names and a set of values, just like a row in a pd.DataFrame . In this example, we have two columns-- x and y --to which we will associate random numbers:","text_count":359,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the following example, we will create a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"spark.sql.DataFrame"}]},{"block_type":"text","content":"&nbsp;by converting an RDD,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"rows"}]},{"block_type":"text","content":", which contains a collection of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Row"}]},{"block_type":"text","content":"&nbsp;instances. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Row"}]},{"block_type":"text","content":"instances represent an association between a set of column names and a set of values, just like a row in a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pd.DataFrame"}]},{"block_type":"text","content":". In this example, we have two columns--"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"--to which we will associate random numbers:"}]},{"block_type":"element","block":"k68ocoxq","search_text":"# We will use the x_rdd and y_rdd defined previously. rows = rdd_x.zip(rdd_y).map(lambda xy: Row(x=float(xy[0]), y=float(xy[1]))) rows.first() # Inspect the first element # Result: # Row(x=0.18432163061239137, y=0.632310101419016) ","text_count":231,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"# We will use the x_rdd and y_rdd defined previously.\n    rows = rdd_x.zip(rdd_y).map(lambda xy: Row(x=float(xy[0]), y=float(xy[1])))\n\n    rows.first() # Inspect the first element\n    # Result:\n    # Row(x=0.18432163061239137, y=0.632310101419016)"}]}]},{"block_type":"element","block":"k68ocoxr","search_text":"After obtaining our collection of Row instances, we can combine them in a DataFrame , as follows. We can also inspect the DataFrame content using the show method:","text_count":162,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"After&nbsp;obtaining our collection of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Row"}]},{"block_type":"text","content":"instances, we can combine them in a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":", as follows. We can also inspect the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":"content using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"show"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k68ocoxs","search_text":"df = spark.createDataFrame(rows) df.show(5) # Output: # +-------------------+--------------------+ # | x| y| # +-------------------+--------------------+ # |0.18432163061239137| 0.632310101419016| # | 0.8159145525577987| -0.9578448778029829| # |-0.6565050226033042| 0.4644773453129496| # |-0.1566191476553318|-0.11542211978216432| # | 0.7536730082381564| 0.26953055476074717| # +-------------------+--------------------+ # only showing top 5 rows ","text_count":447,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"df = spark.createDataFrame(rows)\n    df.show(5)\n    # Output:\n    # +-------------------+--------------------+\n    # |                  x|                   y|\n    # +-------------------+--------------------+\n    # |0.18432163061239137|   0.632310101419016|\n    # | 0.8159145525577987| -0.9578448778029829|\n    # |-0.6565050226033042|  0.4644773453129496|\n    # |-0.1566191476553318|-0.11542211978216432|\n    # | 0.7536730082381564| 0.26953055476074717|\n    # +-------------------+--------------------+\n    # only showing top 5 rows"}]}]},{"block_type":"element","block":"k68ocoxt","search_text":"spark.sql.DataFrame supports performing transformations on the distributed dataset using a convenient SQL syntax. For example, you can use the selectExpr method to calculate a value using a SQL expression. In the following code, we compute the hit test using the x and y columns and the pow SQL function:","text_count":304,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"spark.sql.DataFrame"}]},{"block_type":"text","content":"supports&nbsp;performing transformations on the distributed dataset using a convenient SQL syntax. For example, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"selectExpr"}]},{"block_type":"text","content":"method to calculate a value using a SQL expression. In the following code, we compute the hit test using&nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"&nbsp;columns&nbsp;and the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pow"}]},{"block_type":"text","content":"SQL function:"}]},{"block_type":"element","block":"k68ocoxu","search_text":"hits_df = df.selectExpr(\"pow(x, 2) + pow(y, 2) < 1 as hits\") hits_df.show(5) # Output: # +-----+ # | hits| # +-----+ # | true| # |false| # | true| # | true| # | true| # +-----+ # only showing top 5 rows ","text_count":203,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"hits_df = df.selectExpr(\"pow(x, 2) + pow(y, 2) &lt; 1 as hits\")\n    hits_df.show(5)\n    # Output:\n    # +-----+\n    # | hits|\n    # +-----+\n    # | true|\n    # |false|\n    # | true|\n    # | true|\n    # | true|\n    # +-----+\n    # only showing top 5 rows"}]}]},{"block_type":"element","block":"k68ocoxv","search_text":"To demonstrate the expressivity of SQL, we can also calculate the estimation of pi using a single expression. The expression involves using SQL functions such as sum , pow , cast , and count :","text_count":192,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate the expressivity of SQL, we can also calculate the estimation of pi using&nbsp;a single expression. The expression involves using SQL functions such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sum"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pow"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cast"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"count"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k68ocoxw","search_text":"result = df.selectExpr('4 * sum(cast(pow(x, 2) + pow(y, 2) < 1 as int))/count(x) as pi') result.first() # Result: # Row(pi=3.13976) ","text_count":132,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"result = df.selectExpr('4 * sum(cast(pow(x, 2) + \n                           pow(y, 2) &lt; 1 as int))/count(x) as pi')\n    result.first()\n    # Result:\n    # Row(pi=3.13976)"}]}]},{"block_type":"element","block":"k68ocoxx","search_text":"Spark SQL follows the same syntax as Hive, a SQL engine for distributed datasets built on Hadoop. Refer to https://cwiki.apache.org/confluence/display/Hive/LanguageManual for a complete syntax reference.","text_count":203,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Spark SQL follows the same syntax as Hive, a SQL engine for distributed datasets built on Hadoop. Refer to"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://cwiki.apache.org/confluence/display/Hive/LanguageManual"},"children":[{"block_type":"text","content":"https://cwiki.apache.org/confluence/display/Hive/LanguageManual"}]},{"block_type":"text","content":"for a complete syntax reference."}]},{"block_type":"element","block":"k68ocoxy","search_text":"DataFrames are a great way to leverage the power and optimization of Scala while using the Python interface. The main reason is that queries are interpreted symbolically by SparkSQL and the execution happens directly in Scala without having to pass intermediate results through Python. This greatly reduces the serialization overhead and takes advantage of the query optimizations performed by SparkSQL. Optimizations and query planning allows the use of SQL operators, such as GROUP BY , without incurring in performance penalties, such as the one we experienced using groupBy directly on an RDD.","text_count":597,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"DataFrames are a great way to leverage the power and optimization of Scala while using the Python interface. The main reason is that queries are interpreted symbolically by SparkSQL and the execution happens&nbsp;directly in Scala without having to pass intermediate results through Python. This greatly reduces the serialization overhead and takes advantage of the query optimizations performed by SparkSQL. Optimizations and query planning allows the use of SQL operators, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"GROUP BY"}]},{"block_type":"text","content":", without incurring in performance penalties, such as the one we experienced using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"groupBy"}]},{"block_type":"text","content":"directly on an RDD."}]},{"block_type":"element","block":"k68ocoxz","search_text":"Scientific computing with mpi4py","text_count":32,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Scientific computing with mpi4py"}]},{"block_type":"element","block":"k68ocoy0","search_text":"Even though Dask and Spark are great technologies widely used in the IT industry, they have not been widely adopted in academic research. High-performance supercomputers with thousands of processors have been used in academia for decades to run intense numerical applications. For this reason, supercomputers are generally configured using a very different software stack that focuses on a computationally-intensive algorithm implemented in a low-level language, such as C, Fortran, or even assembly.","text_count":500,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even though Dask and Spark are great technologies widely used in the IT industry, they have not been widely adopted in academic research. High-performance supercomputers with thousands of processors have been used in academia for decades to run intense numerical applications. For this reason, supercomputers are generally configured using a very different software stack&nbsp;that focuses on a computationally-intensive algorithm implemented in a low-level language, such as C, Fortran, or even assembly."}]},{"block_type":"element","block":"k68ocoy1","search_text":"The principal library used for parallel execution on these kinds of systems is Message Passing Interface ( MPI ), which, while less convenient or sophisticated than Dask or Spark, is perfectly capable of expressing parallel algorithms and achieving excellent performance. Note that, contrary to Dask and Spark, MPI does not follow the MapReduce model and is best used for running thousands of processes with very little data sent between them.","text_count":443,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The principal library used for parallel execution on these kinds of systems is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Message Passing Interface"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"MPI"}]},{"block_type":"text","content":"), which, while less convenient or sophisticated than Dask or Spark, is perfectly capable of expressing parallel algorithms and achieving excellent performance. Note that, contrary to Dask and Spark, MPI does not follow the MapReduce model and is best used for running thousands of processes with very little data sent between them."}]},{"block_type":"element","block":"k68ocoy2","search_text":"MPI works quite differently compared to what we've seen so far. Parallelism in MPI is achieved by running the same script in multiple processes (which possibly exist on different nodes); communication and synchronization between processes is handled by a designated process, which is commonly called root and is usually identified by a 0 ID. ","text_count":342,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"MPI works quite differently compared to what we've seen so far. Parallelism in MPI is achieved by running"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"the same script"}]},{"block_type":"text","content":"&nbsp;in multiple processes (which possibly exist on different nodes); communication and synchronization between processes is handled by a designated process, which is commonly called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"root"}]},{"block_type":"text","content":"and&nbsp;is usually identified by a&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"0"}]},{"block_type":"text","content":"ID.&nbsp;"}]},{"block_type":"element","block":"k68ocoy3","search_text":"In this section, we will briefly demonstrate the main concepts of MPI using its mpi4py Python interface. In the following example, we demonstrate the simplest possible parallel code with MPI. The code imports the MPI module and retrieves COMM_WORLD , which is an interface that can be used to interact with other MPI processes. The Get_rank function will return an integer identifier for the current process:","text_count":408,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will briefly demonstrate the main concepts of MPI using its"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mpi4py"}]},{"block_type":"text","content":"Python interface. In the following example, we demonstrate the simplest possible parallel code with MPI. The code imports the MPI module and retrieves"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"COMM_WORLD"}]},{"block_type":"text","content":", which is an interface that can be used to interact with other MPI processes. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Get_rank"}]},{"block_type":"text","content":"function will return an integer identifier for the current process:"}]},{"block_type":"element","block":"k68ocoy4","search_text":"from mpi4py import MPI comm = MPI.COMM_WORLD rank = comm.Get_rank() print(\"This is process\", rank) ","text_count":99,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from mpi4py import MPI\n\n    comm = MPI.COMM_WORLD\n    rank = comm.Get_rank()\n    print(\"This is process\", rank)"}]}]},{"block_type":"element","block":"k68ocoy5","search_text":"We can place the preceding code in a file, mpi_example.py , and execute it. Running this script normally won't do anything special as it involves the execution of a single process:","text_count":180,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can place the&nbsp;preceding code in a file,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mpi_example.py"}]},{"block_type":"text","content":", and execute it.&nbsp;Running this script normally won't do anything special as it involves the execution of a single process:"}]},{"block_type":"element","block":"k68ocoy6","search_text":"$ python mpi_example.py This is process 0 ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ python mpi_example.py\n    This is process 0"}]}]},{"block_type":"element","block":"k68ocoy7","search_text":"MPI jobs are meant to be executed using the mpiexec command, which takes a -n option to indicate the number of parallel processes. Running the script using the following command will generate four independent executions of the same script, each with a different ID:","text_count":265,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"MPI jobs are meant to be executed using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mpiexec"}]},{"block_type":"text","content":"&nbsp;command, which takes a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-n"}]},{"block_type":"text","content":"option to indicate the number of parallel processes. Running the script using the following command will generate&nbsp;four independent executions of the same script, each with a different ID:"}]},{"block_type":"element","block":"k68ocoy8","search_text":"$ mpiexec -n 4 python mpi_example.py This is process 0 This is process 2 This is process 1 This is process 3 ","text_count":109,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ mpiexec -n 4 python mpi_example.py\n    This is process 0\n    This is process 2\n    This is process 1\n    This is process 3"}]}]},{"block_type":"element","block":"k68ocoy9","search_text":"Distributing processes among the network is performed automatically through a resource manager (such as TORQUE). Generally, supercomputers are configured by the system administrator, which will also provide instructions on how to run MPI software.","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Distributing processes among the network is performed automatically through a resource manager (such as TORQUE). Generally, supercomputers are configured by the system administrator, which will also provide instructions on how to run MPI software."}]},{"block_type":"element","block":"k68ocoya","search_text":"To get a feel as to what an MPI program looks like, we will reimplement the approximation of pi . The complete code is shown here. The program will do the following:","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To get a feel as to what an MPI program looks like, we will reimplement the approximation of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pi"}]},{"block_type":"text","content":". The complete code is shown here. The program&nbsp;will do the following:"}]},{"block_type":"element","block":"k68ocoyb","search_text":"Create a random array of N / n_procs size for each process so that each process will test the same amount of samples ( n_procs is obtained through the Get_size function) In each separate process, calculate the sum of the hit tests and store it in hits_counts , which will represent the partial counts for each process Use the reduce function to calculate the total sum of the partial counts. When using reduce, we need to specify the root argument to specify which process will receive the result Print the final result only on the process corresponding to the root process: ","text_count":575,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Create a random array of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"N / n_procs"}]},{"block_type":"text","content":"&nbsp;size for each process so that each process will test the same amount of samples ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"n_procs"}]},{"block_type":"text","content":"is obtained through the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Get_size"}]},{"block_type":"text","content":"function)"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In each separate process, calculate the sum of the hit tests and store it in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"hits_counts"}]},{"block_type":"text","content":",&nbsp;which will represent the partial counts for each process"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"reduce"}]},{"block_type":"text","content":"function to calculate the total sum of the partial counts. When using reduce, we need to specify the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"root"}]},{"block_type":"text","content":"argument to specify&nbsp;which process will receive the result"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Print the final result only on the process corresponding to the root process:"}]}]},{"block_type":"element","block":"k68ocoyc","search_text":"from mpi4py import MPI comm = MPI.COMM_WORLD rank = comm.Get_rank() import numpy as np N = 10000 n_procs = comm.Get_size() print(\"This is process\", rank) # Create an array x_part = np.random.uniform(-1, 1, int(N/n_procs)) y_part = np.random.uniform(-1, 1, int(N/n_procs)) hits_part = x_part**2 + y_part**2 < 1 hits_count = hits_part.sum() print(\"partial counts\", hits_count) total_counts = comm.reduce(hits_count, root=0) if rank == 0: print(\"Total hits:\", total_counts) print(\"Final result:\", 4 * total_counts/N) ","text_count":514,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"from mpi4py import MPI\n\n      comm = MPI.COMM_WORLD\n      rank = comm.Get_rank()\n\n      import numpy as np\n\n      N = 10000\n\n      n_procs = comm.Get_size()\n\n      print(\"This is process\", rank)\n\n      # Create an array\n      x_part = np.random.uniform(-1, 1, int(N/n_procs))\n      y_part = np.random.uniform(-1, 1, int(N/n_procs))\n\n      hits_part = x_part**2 + y_part**2 &lt; 1\n      hits_count = hits_part.sum()\n\n      print(\"partial counts\", hits_count)\n\n      total_counts = comm.reduce(hits_count, root=0)\n\n      if rank == 0:\n         print(\"Total hits:\", total_counts)\n         print(\"Final result:\", 4 * total_counts/N)"}]}]},{"block_type":"element","block":"k68ocoyd","search_text":"We can now place the preceding code in a file named mpi_pi.py and execute it using mpiexec . The output shows how the four process executions are intertwined until we get to the reduce call:","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now place the preceding code in a file named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mpi_pi.py"}]},{"block_type":"text","content":"and execute it using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mpiexec"}]},{"block_type":"text","content":". The output shows how the four process executions are intertwined until we get to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"reduce"}]},{"block_type":"text","content":"call:"}]},{"block_type":"element","block":"k68ocoye","search_text":"$ mpiexec -n 4 python mpi_pi.py This is process 3 partial counts 1966 This is process 1 partial counts 1944 This is process 2 partial counts 1998 This is process 0 partial counts 1950 Total hits: 7858 Final result: 3.1432 ","text_count":222,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ mpiexec -n 4 python mpi_pi.py\nThis is process 3\npartial counts 1966\nThis is process 1\npartial counts 1944\nThis is process 2\npartial counts 1998\nThis is process 0\npartial counts 1950\nTotal hits: 7858\nFinal result: 3.1432"}]}]},{"block_type":"element","block":"k68ocoyf","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k68ocoyg","search_text":"Distributed processing can be used to implement algorithms capable of handling massive datasets by distributing smaller tasks across a cluster of computers. Over the years, many software packages, such as Apache Hadoop, have been developed to implement performant and reliable execution of distributed software.","text_count":311,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Distributed processing can be used to implement algorithms capable of handling massive datasets by distributing smaller tasks across a cluster of computers. Over the years, many software packages, such as Apache Hadoop, have been developed to implement performant and reliable execution of distributed software."}]},{"block_type":"element","block":"k68ocoyh","search_text":"In this chapter, we learned about the architecture and usage of Python packages, such as Dask and PySpark, which provide powerful APIs to design and execute programs capable of scaling to hundreds of machines. We also briefly looked at MPI, a library that has been used for decades to distribute work on supercomputers designed for academic research.","text_count":350,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we learned about the architecture and usage of Python packages, such as&nbsp;Dask and PySpark, which provide powerful APIs to design and execute programs capable of scaling to hundreds of machines. We also briefly looked at MPI, a library that has been used for decades to distribute work on supercomputers designed for academic research."}]},{"block_type":"element","block":"k68ocoyi","search_text":"Throughout this book, we explored several techniques to improve the performance of our program, and to increase the speed of our programs and the size of the datasets we are able to process. In the next chapter, we will describe the strategies and best practices to write and maintain high-performance code. ","text_count":308,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Throughout this book, we explored several techniques to improve the performance&nbsp;of our program, and&nbsp;to increase the speed of our programs and the size of the datasets we are able to process. In the next chapter, we will describe the strategies and best practices to write and maintain high-performance code. &nbsp;"}]}]},{"title":"Designing for High Performance","author":"Gabriele Lanaro","block":"k68ocgxx","number":9,"contents":[{"block_type":"element","block":"k68ocoyj","search_text":"In the earlier chapters, we learned how to use the vast array of tools available in Python's standard library and third-party packages to assess and improve the performance of Python applications. In this chapter, we will provide some general guidelines on how to approach different kinds of applications as well as illustrate some good practices that are commonly adopted by several Python projects.","text_count":400,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the&nbsp;earlier chapters, we learned how to use the vast array of tools available in Python's standard library and third-party packages to assess and improve the performance of Python applications. In this chapter, we will provide some general guidelines on how to approach different kinds of applications as well as illustrate some good practices that are commonly adopted by several Python projects."}]},{"block_type":"element","block":"k68ocoyk","search_text":"In this chapter, we will learn the following:","text_count":45,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will learn the following:"}]},{"block_type":"element","block":"k68ocoyl","search_text":"Picking the right performance technique for generic, number crunching, and big data applications Structuring a Python project Isolating Python installations with virtual environments and containerization Setting up continuous integration with Travis CI ","text_count":253,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Picking the right performance technique for generic, number crunching, and big data applications"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Structuring a Python project"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Isolating Python installations with virtual environments and containerization"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Setting up continuous integration with Travis CI"}]}]},{"block_type":"element","block":"k68ocoym","search_text":"Choosing a suitable strategy","text_count":28,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Choosing a suitable strategy"}]},{"block_type":"element","block":"k68ocoyn","search_text":"Many packages are available for improving the performance of programs, but how do we determine the best optimization strategy for our program? A variety of factors dictate the decision on which method to use. In this section, we will try to answer this question as comprehensively as possible, based on broad application categories. ","text_count":333,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Many packages are available for improving the performance of programs, but how do we determine the best optimization strategy for our program? A variety of factors dictate the decision on which method to use. In this section, we will try to answer this question as comprehensively as possible, based on broad application categories.&nbsp;"}]},{"block_type":"element","block":"k68ocoyo","search_text":"The first aspect to take into consideration is the type of application. Python is a language that serves multiple and very diverse communities that span web services, system scripting, games, machine learning, and much more. Those different applications will require optimization efforts for different parts of the program.","text_count":323,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first aspect to take into consideration is the type of application. Python is a language that serves multiple and very diverse communities that span web services, system scripting, games, machine learning, and much more. Those different applications will require optimization efforts&nbsp;for different parts of the program."}]},{"block_type":"element","block":"k68ocoyp","search_text":"For example, a web service can be optimized to have a very short response time. Also, it has to be able to answer as many requests as possible using as little resources as possible (that is, it will try to achieve lower latency), while numerical code may require weeks to run. It's important to improve the amount of data the system may process, even if there's a significant start up overhead (in this case, we are interested in throughput). ","text_count":443,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For example, a web service can be optimized to have a very short response time. Also, it has to be able to answer as many requests as possible using as little resources as possible (that is, it&nbsp;will try to achieve lower latency), while numerical code may require weeks to run. It's important to improve the amount of data the system may process, even if there's a significant start up overhead (in this case, we are interested in throughput).&nbsp;"}]},{"block_type":"element","block":"k68ocoyq","search_text":"Another aspect is the platform and architecture we are developing for. While Python has support for a lot of platforms and architectures, many of the third-party libraries may have limited support for certain platforms, especially when dealing with packages that bind into C extensions. For this reason, it's necessary to check the availability of libraries for the target platforms and architectures.","text_count":401,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another aspect is the platform and architecture we are developing for. While Python has support for a lot of platforms and architectures, many of the third-party libraries may have limited support for certain platforms, especially when dealing with packages that bind into C extensions. For this reason, it's necessary to check the availability of libraries for the target platforms and architectures."}]},{"block_type":"element","block":"k68ocoyr","search_text":"Also, some architectures, such as embedded systems and small devices, may have severe CPU and memory restrictions. This is an important factor to take into consideration as, for instance, some techniques (such as multiprocessing) may consume too much memory or require the execution of additional software.","text_count":306,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, some architectures, such as embedded systems and small devices, may have severe CPU and memory restrictions. This is an important factor to take into consideration as, for instance, some techniques (such as multiprocessing) may consume&nbsp;too much memory or require the execution of additional software."}]},{"block_type":"element","block":"k68ocoys","search_text":"Finally, the business requirements are equally important. Many times, software products require fast iterations and the ability to change the code quickly. Generally speaking, you want to keep your software stack as minimal as possible so that modification, testing, deployment, and introducing additional platform support becomes easy and feasible in a short period of time. This also applies to the team--installing the software stack and starting the development should be as smooth as possible. For this reason, one should generally prefer pure Python libraries over extensions, with the possible exception of solid, battle-tested libraries, such as NumPy. Additionally, various business aspects will help determine which operations need to be optimized first (always remember that premature optimization is the root of all evil ).","text_count":835,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, the business requirements are equally important. Many times, software products require fast iterations and the ability to change the code quickly. Generally speaking, you want to keep your software stack as minimal as possible so that modification, testing, deployment, and introducing additional platform support becomes easy and feasible in a short period&nbsp;of time. This also applies to the team--installing the software stack and starting the development should be as smooth as possible. For this reason, one should generally prefer pure Python libraries over extensions, with the possible exception of solid, battle-tested libraries, such as NumPy.&nbsp;Additionally, various business aspects will help determine which operations need to be optimized first (always remember that"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"premature optimization is the root of all evil"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k68ocoyt","search_text":"Generic applications","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Generic applications"}]},{"block_type":"element","block":"k68ocoyu","search_text":"Generic applications, such as web apps or mobile app backends, usually involve calls to remote services and databases. For such cases, it can be useful to take advantage of asynchronous frameworks, such as the ones presented in Chapter 6, Implementing Concurrency ; this will improve application logic, system design, responsiveness and, also, it will simplify the handling of network failures.","text_count":394,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Generic applications, such as web apps or mobile app backends, usually involve calls to remote services and databases. For such cases, it can be useful to take advantage of asynchronous frameworks, such as the ones presented in Chapter 6,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Implementing Concurrency"}]},{"block_type":"text","content":"; this will improve application logic, system design, responsiveness and, also, it will simplify the handling of network failures."}]},{"block_type":"element","block":"k68ocoyv","search_text":"Use of asynchronous programming also makes it easier to implement and use microservices. A microservice , although there is no standard definition, can be thought of as a remote service that focuses on a specific aspect of the application (for example, authentication).","text_count":269,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Use of asynchronous programming also makes it easier to implement and use microservices. A"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"microservice"}]},{"block_type":"text","content":", although there is no standard definition, can be thought of as a remote service&nbsp;that focuses on a specific aspect of the application (for example,&nbsp;authentication)."}]},{"block_type":"element","block":"k68ocoyw","search_text":"The idea behind microservices is that you can build an application by composing different microservices that communicate through a simple protocol (such as gRPC, REST calls, or through a dedicated message queue). This architecture is in contrast with a monolithic application where all the services are handled by the same Python process.","text_count":338,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The idea behind microservices is that you can build an application by composing different microservices that communicate through a simple protocol (such as gRPC, REST calls, or through a dedicated message queue). This architecture is in contrast with a monolithic application where all the services are handled by the same Python process."}]},{"block_type":"element","block":"k68ocoyx","search_text":"Advantages of microservices include strong decoupling of different parts of the application. Small, simple services can be implemented and maintained by different teams as well as be updated and deployed at different times. This also allows microservices to be easily replicated so that they can handle more users. Additionally, since the communication is done through a simple protocol, microservices can be implemented in a different language that can be more appropriate than Python for the specific application.","text_count":515,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Advantages of microservices include strong decoupling of different parts of the application. Small, simple services can be implemented and maintained by different teams as well as be updated and deployed at different times. This also allows microservices to be easily replicated so that they can handle more users. Additionally, since the communication is done through a simple protocol, microservices can be implemented in a different language&nbsp;that can be more appropriate than Python for the specific application."}]},{"block_type":"element","block":"k68ocoyy","search_text":"If the performance of a service is not satisfactory, the application can often be executed on a different Python interpreter, such as PyPy (provided that all the third-party extensions are compatible) to achieve sufficient speed gains. Otherwise, algorithmic strategies as well as porting bottlenecks to Cython is generally sufficient to achieve satisfactory performance.","text_count":371,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If the performance of a service is not satisfactory, the application can often be executed on a different Python interpreter, such as PyPy (provided that all the third-party extensions are compatible) to achieve sufficient&nbsp;speed gains. Otherwise, algorithmic strategies as well as porting&nbsp;bottlenecks to Cython is generally sufficient to achieve satisfactory performance."}]},{"block_type":"element","block":"k68ocoyz","search_text":"Numerical code","text_count":14,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Numerical code"}]},{"block_type":"element","block":"k68ocoz0","search_text":"If your goal is to write numerical code, an excellent strategy is to start directly with a NumPy implementation. Using NumPy is a safe bet because it is available and tested on many platforms and, as we have seen in the earlier chapters, many other packages treat NumPy arrays as first-class citizens.","text_count":301,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If your goal is to write numerical code, an excellent strategy is to start directly with a NumPy implementation. Using NumPy is a safe bet because it is available and tested on many platforms and, as we have seen in the&nbsp;earlier chapters, many other packages treat NumPy arrays as first-class citizens."}]},{"block_type":"element","block":"k68ocoz1","search_text":"When properly written (such as by taking advantage of broadcasting and other techniques we learned in Chapter 2, Pure Python Optimizations ), NumPy performance is already quite close to the native performance achievable by C code, and won't require further optimization. That said, certain algorithms are hard to express efficiently using NumPy's data structures and methods. When this happens, two very good options can be, for example, Numba or Cython.","text_count":454,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When properly written (such as by taking advantage of broadcasting and other techniques we learned in Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Pure Python Optimizations"}]},{"block_type":"text","content":"), NumPy performance is already quite close to the native performance achievable by C code, and won't require further optimization. That said, certain algorithms are hard to express efficiently using NumPy's data structures and methods. When this happens, two very good options can be, for example, Numba or Cython."}]},{"block_type":"element","block":"k68ocoz2","search_text":"Cython is a very mature tool used intensely by many important projects, such as scipy and scikit-learn . Cython code, with its explicit, static type declarations, makes it very understandable, and most Python programmers will have no problem picking up its familiar syntax. Additionally, the absence of \"magic\" and good inspection tools make it easy for the programmer to predict its performance and have educated guesses as to what to change to achieve maximum performance.","text_count":474,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Cython is a very mature tool used intensely&nbsp;by many important projects, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"scipy"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"scikit-learn"}]},{"block_type":"text","content":". Cython code, with its explicit, static type declarations, makes it very understandable, and most Python programmers will have no problem picking up its familiar syntax. Additionally, the absence of \"magic\" and good inspection tools make it easy for the programmer to predict its performance and have educated guesses&nbsp;as to&nbsp;what to change to achieve maximum performance."}]},{"block_type":"element","block":"k68ocoz3","search_text":"Cython, however, has some drawbacks. Cython code needs to be compiled before it can be executed, thus breaking the convenience of the Python edit-run cycle. This also requires the availability of a compatible C compiler for the target platform. This also complicates distribution and deployment, as multiple platforms, architectures, configurations, and compilers need to be tested for every target.","text_count":399,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Cython, however, has some drawbacks. Cython code needs to be compiled before it can be executed, thus breaking the convenience of the Python edit-run cycle. This also requires the availability of a compatible C compiler for the target platform.&nbsp; This also complicates distribution and deployment, as multiple platforms, architectures, configurations, and compilers need to be tested for every target."}]},{"block_type":"element","block":"k68ocoz4","search_text":"On the other hand, Numba API requires only the definition of pure-Python functions, which get compiled on the fly, maintaining the fast Python edit-run cycle. In general, Numba requires a LLVM toolchain installation to be available on the target platform. Note that, as of version 0.30, there is some limited support for Ahead-Of-Time ( AOT ) compilation of Numba functions so that Numba-compiled functions can be packaged and deployed without requiring a Numba and LLVM installation.","text_count":484,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other hand,&nbsp;Numba API requires only the definition of pure-Python functions, which get compiled on the fly, maintaining the fast Python edit-run cycle. In general, Numba requires a LLVM&nbsp;toolchain installation to be available on the target platform. Note that, as of version 0.30, there is some limited support for"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Ahead-Of-Time"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"AOT"}]},{"block_type":"text","content":") compilation of Numba functions so that Numba-compiled functions can be packaged and deployed without requiring a Numba and LLVM installation."}]},{"block_type":"element","block":"k68ocoz5","search_text":"Note that both Numba and Cython are usually available pre-packaged with all of their dependencies (including compilers) on the default channels of the conda package manager. Therefore, deployment of Cython can be greatly simplified on the platforms where the conda package manager is available.","text_count":294,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that both Numba and Cython are usually available pre-packaged with all of their dependencies (including compilers) on the default channels of the conda package manager. Therefore, deployment of Cython can be greatly simplified on the platforms where the conda package manager is available."}]},{"block_type":"element","block":"k68ocoz6","search_text":"Note What if Cython and Numba are still not enough? While this is generally not required, an additional strategy would be to implement a pure C module (which can be further optimized using compiler flags or hand-tuning) and use it from a Python module using either the cffi package ( https://cffi.readthedocs.io/en/latest/ ) or Cython. ","text_count":336,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What if Cython and Numba are still not enough? While this is generally not required, an additional strategy would be to implement a pure C module (which can be further optimized using compiler flags or hand-tuning) and use it from a Python module using either the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cffi"}]},{"block_type":"text","content":"package ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://cffi.readthedocs.io/en/latest/"},"children":[{"block_type":"text","content":"https://cffi.readthedocs.io/en/latest/"}]},{"block_type":"text","content":") or Cython.&nbsp;"}]}]},{"block_type":"element","block":"k68ocoz7","search_text":"Using NumPy, Numba, and Cython is a very effective strategy to obtain near-optimal performance on serial codes. For many applications, serial codes are certainly enough and, even if the ultimate plan is to have a parallel algorithm, it’s still very worthy working on a serial reference implementation for debugging purposes and because a serial implementation is likely to be faster on small datasets.","text_count":401,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using NumPy, Numba, and Cython is a very effective strategy to obtain near-optimal performance on serial codes. For many applications, serial codes are certainly enough and, even if the ultimate plan is to have a parallel algorithm, it&rsquo;s still very worthy working on a serial&nbsp;reference implementation for debugging purposes and because a serial implementation is likely to be faster on small datasets."}]},{"block_type":"element","block":"k68ocoz8","search_text":"Parallel implementations vary considerably in complexity depending on the particular application. In many cases, the program can be easily expressed as a series of independent calculations followed by some sort of aggregation and is parallelizable using simple process-based interfaces, such as multiprocessing.Pool or ProcessPoolExecutor , which have the advantage of being able to execute generic Python code in parallel without much trouble.","text_count":444,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Parallel implementations vary considerably in complexity depending on the particular application. In many cases, the program can be easily expressed as a series of independent calculations followed by some sort of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"aggregation"}]},{"block_type":"text","content":"and is parallelizable using simple process-based interfaces,&nbsp;such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"multiprocessing.Pool"}]},{"block_type":"text","content":"&nbsp;or"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ProcessPoolExecutor"}]},{"block_type":"text","content":", which have the advantage of being able to execute generic Python code in parallel without much trouble."}]},{"block_type":"element","block":"k68ocoz9","search_text":"To avoid the time and memory overhead of starting multiple processes, one can use threads. NumPy functions typically release the GIL and are good candidates for thread-base parallelization. Additionally, Cython and Numba provide special nogil statements as well as automatic parallelization, which makes them suitable for simple, lightweight parallelization.","text_count":358,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To avoid the time and memory overhead of starting multiple processes, one can use threads. NumPy functions typically release the GIL and are good candidates for thread-base parallelization. Additionally, Cython and Numba provide special&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"nogil"}]},{"block_type":"text","content":"&nbsp;statements as well as automatic parallelization, which makes them suitable for simple, lightweight parallelization."}]},{"block_type":"element","block":"k68ocoza","search_text":"For more complex use cases, you may have to change the algorithm significantly. In those cases, Dask arrays are a decent option, which provide an almost-drop-in replacement for standard NumPy. Dask has the further advantage of operating very transparently and is easy to tweak.","text_count":277,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For more complex use cases, you may have to change the algorithm significantly. In those cases, Dask arrays are a decent option, which provide an almost-drop-in replacement for standard NumPy. Dask has the further advantage of operating very transparently and is easy to tweak."}]},{"block_type":"element","block":"k68ocozb","search_text":"Specialized applications that make intensive use of linear algebra routines (such as deep learning and computer graphics) may benefit from packages such as Theano and Tensorflow, which are capable of highly performant and automatic parallelization with built-in GPU support.","text_count":274,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Specialized applications&nbsp;that make intensive use of linear algebra routines (such as deep learning and computer graphics) may benefit from packages such as Theano and Tensorflow, which are capable of highly performant and automatic parallelization with built-in GPU support."}]},{"block_type":"element","block":"k68ocozc","search_text":"Finally, mpi4py usage can be used for deploying parallel python scripts on a MPI-based supercomputer (commonly available for researchers in universities).","text_count":154,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"mpi4py"}]},{"block_type":"text","content":"usage can be used for deploying parallel python scripts on a MPI-based supercomputer (commonly available for researchers in universities)."}]},{"block_type":"element","block":"k68ocozd","search_text":"Big data","text_count":8,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Big data"}]},{"block_type":"element","block":"k68ocoze","search_text":"Large datasets (typically larger than 1 TB) are becoming increasingly common and a lot of resources have been invested in developing technologies capable of collecting, storing, and analyzing them. Typically, the choice of which framework to use is bound to how the data is stored in the first place.","text_count":300,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Large datasets (typically larger than 1 TB) are becoming increasingly common and a lot of resources have been invested in developing technologies capable of collecting, storing, and analyzing them. Typically, the choice of which framework to use is bound to how the data is stored in the first place."}]},{"block_type":"element","block":"k68ocozf","search_text":"Many times, even if the complete dataset doesn't fit in a single machine, it is still possible to devise strategies to extract the answers without having to probe the whole dataset. For example, it is quite often possible to answer questions by extracting a small, interesting subset of data that can be easily loaded in memory and analyzed with highly convenient and performant libraries, such as Pandas. By filtering or randomly sampling data points, one can often find a good enough answer to a business question without having to resort to big data tools.","text_count":559,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Many times, even if the complete dataset doesn't fit in a single machine, it is still possible to devise strategies to extract the answers without having to probe the whole dataset. For example, it is quite often possible to answer questions by extracting a small, interesting subset of data&nbsp;that can be easily loaded in memory and analyzed with highly convenient and performant libraries, such as Pandas. By filtering or randomly sampling data points, one can often find a good enough answer to a business question without having to resort to big data tools."}]},{"block_type":"element","block":"k68ocozg","search_text":"If the bulk of the company's software is written in Python, and you have the freedom to decide your software stack, it would make sense to use Dask distributed. The software package has a very simple setup and is tightly integrated with the Python ecosystem. Using something such as Dask array and DataFrame , it's very easy to scale your already-existing Python algorithms by adapting NumPy and Pandas code.","text_count":408,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If the bulk of the company's software is written in Python, and you have the freedom to decide your software stack, it would make sense to use&nbsp;Dask distributed. The software package has a very simple setup and is tightly integrated with the Python ecosystem. Using something such as Dask"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"array"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"DataFrame"}]},{"block_type":"text","content":", it's very easy to scale your already-existing Python algorithms by adapting NumPy and Pandas code."}]},{"block_type":"element","block":"k68ocozh","search_text":"Quite often, some companies may have already set up a Spark cluster. In this case, PySpark is the optimal choice, and the use of SparkSQL is encouraged for higher performance. One of the Spark advantages is that it allows the use of other languages, such as Scala and Java.","text_count":273,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Quite often, some companies may have already set up a Spark cluster. In this case, PySpark is the optimal choice, and the use of SparkSQL is encouraged for higher performance. One of the Spark advantages is that it allows the use of other languages, such as Scala and Java."}]},{"block_type":"element","block":"k68ocozi","search_text":"Organizing your source code","text_count":27,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Organizing your source code"}]},{"block_type":"element","block":"k68ocozj","search_text":"The repository structure of a typical Python project consists, at a minimum, of a directory containing a README.md file, a Python module or package containing the source code for the application or library, and a setup.py file. Projects may also adopt different conventions to comply with company policies or specific frameworks in use. In this section, we will illustrate some common practices that are commonly found in community-driven Python projects which can include some of the tools we illustrated in the earlier chapters.","text_count":530,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The repository structure of a typical Python project consists, at a minimum, of a directory containing a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"README.md"}]},{"block_type":"text","content":"file, a Python module or package containing the source code for the application or library, and a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup.py"}]},{"block_type":"text","content":"file. Projects may also adopt different conventions to comply with company policies or specific frameworks in use. In this section, we will illustrate some common practices that are commonly found in community-driven Python projects which can include some of the tools we illustrated in the earlier chapters."}]},{"block_type":"element","block":"k68ocozk","search_text":"A typical directory structure for a Python project named myapp can look like this. Now, we will elucidate the role of each file and directory:","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A typical directory structure&nbsp;for a Python project named&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"myapp"}]},{"block_type":"text","content":"can look like this.&nbsp;Now, we will elucidate the role of each file and directory:"}]},{"block_type":"element","block":"k68ocozl","search_text":"myapp/ README.md LICENSE setup.py myapp/ __init__.py module1.py cmodule1.pyx module2/ __init__.py src/ module.c module.h tests/ __init__.py test_module1.py test_module2.py benchmarks/ __init__.py test_module1.py test_module2.py docs/ tools/ ","text_count":241,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"myapp/ \n      README.md\n      LICENSE\n      setup.py\n      myapp/\n        __init__.py\n        module1.py\n        cmodule1.pyx\n        module2/\n           __init__.py\n      src/\n        module.c\n        module.h\n      tests/\n        __init__.py\n        test_module1.py\n        test_module2.py\n      benchmarks/\n        __init__.py\n        test_module1.py\n        test_module2.py\n      docs/\n      tools/"}]}]},{"block_type":"element","block":"k68ocozm","search_text":"README.md is a text file that contains general information about the software, such as project scope, installation, a quick start, and useful links. If the software is released to the public, a LICENSE file is used to specify terms and conditions for its usage.","text_count":261,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"README.md"}]},{"block_type":"text","content":"&nbsp;is a text file that contains general information about the software, such as project scope, installation, a quick start, and useful links. If the software is released to the public, a&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"LICENSE"}]},{"block_type":"text","content":"&nbsp;file is used to specify terms and conditions for its usage."}]},{"block_type":"element","block":"k68ocozn","search_text":"Python software is commonly packaged using the setuptools library in a setup.py file. As we have seen in the earlier chapters, setup.py is also an effective way to compile and distribute Cython code.","text_count":199,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Python software is commonly packaged using the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setuptools"}]},{"block_type":"text","content":"&nbsp;library in a&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup.py"}]},{"block_type":"text","content":"file. As we have seen in the&nbsp;earlier chapters,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup.py"}]},{"block_type":"text","content":"is also an effective way to compile and distribute Cython code."}]},{"block_type":"element","block":"k68ocozo","search_text":"The myapp package contains the source code for the application, including Cython modules. Sometimes, it's convenient to maintain pure-Python implementations besides their Cython-optimized counterparts. Commonly, the Cython version of a module is named with a c prefix (such as cmodule1.pyx in the preceding example).","text_count":316,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"myapp"}]},{"block_type":"text","content":"package contains the source code for the application, including Cython modules. Sometimes, it's convenient to maintain pure-Python implementations besides their Cython-optimized counterparts. Commonly, the Cython version of a module is named with a c prefix (such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"cmodule1.pyx"}]},{"block_type":"text","content":"in the preceding example)."}]},{"block_type":"element","block":"k68ocozp","search_text":"If the external .c and .h files are needed, those are usually stored under an additional src/ directory placed in the top-level ( myapp ) project directory.","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If the external"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".c"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".h"}]},{"block_type":"text","content":"files are needed, those are usually stored under an additional&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"src/"}]},{"block_type":"text","content":"directory placed in the top-level ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"myapp"}]},{"block_type":"text","content":") project directory."}]},{"block_type":"element","block":"k68ocozq","search_text":"The tests/ directory contains testing code for application (usually in the form of unit tests), which can be run using a test runner, such as unittest or pytest . However, some projects prefer to place the tests/ directory inside the myapp package. Since high-performance code is tweaked and rewritten continuously, having a solid test suite is crucial to spot bugs as early as possible and to improve the developer experience by shortening the test-edit-run cycle. ","text_count":466,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tests/"}]},{"block_type":"text","content":"directory contains testing code for application (usually in the form of unit tests), which can be run using a test runner, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"unittest"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pytest"}]},{"block_type":"text","content":". However, some projects prefer to place the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tests/"}]},{"block_type":"text","content":"directory inside the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"myapp"}]},{"block_type":"text","content":"package.&nbsp;Since high-performance code is tweaked and rewritten continuously, having a solid test suite is crucial to spot bugs as early as possible and to improve the developer experience by shortening the test-edit-run cycle.&nbsp;"}]},{"block_type":"element","block":"k68ocozr","search_text":"Benchmarks can be placed in the benchmarks directory; the advantage of having benchmarks separated from tests is that benchmarks can potentially take more time to execute. Benchmarks can also be run on a build server (see the Continuous integration section) as a simple mean to compare the performance of versions. While benchmarks usually take longer to run than unit tests, it's best to keep their execution as short as possible to avoid waste of resources.","text_count":459,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Benchmarks can be placed in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"benchmarks"}]},{"block_type":"text","content":"directory; the advantage of having benchmarks separated from tests is that benchmarks can potentially take more time to execute. Benchmarks can also be run on a build server (see the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Continuous integration"}]},{"block_type":"text","content":"section) as a simple mean to compare&nbsp;the performance&nbsp;of versions. While benchmarks usually take longer to run than unit tests, it's best to keep their execution as short as possible to avoid waste of resources."}]},{"block_type":"element","block":"k68ocozs","search_text":"Finally, the docs/ directory contains user and developer documentation and API references. This usually also includes configuration files for documentation tools, such as sphinx . Other tools and scripts can be placed in the tools/ directory.","text_count":242,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"docs/"}]},{"block_type":"text","content":"directory contains user and&nbsp;developer documentation and API references. This usually also includes configuration files&nbsp;for documentation tools, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"sphinx"}]},{"block_type":"text","content":". Other tools and scripts can be placed in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"tools/"}]},{"block_type":"text","content":"directory."}]},{"block_type":"element","block":"k68ocozt","search_text":"Isolation, virtual environments, and containers","text_count":47,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Isolation, virtual environments, and containers"}]},{"block_type":"element","block":"k68ocozu","search_text":"The importance of having isolated environments for code testing and execution becomes quite apparent by noticing what happens when you ask a friend to run one of your Python scripts. What happens is that you provide instructions to install Python version X and dependent packages Y , X , and ask them to copy and execute the script on their machine.","text_count":349,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The importance of having isolated environments for code testing and execution becomes quite apparent by noticing what happens when you ask a friend to run one of your Python scripts. What happens is that&nbsp;you provide instructions to install Python version X and dependent packages"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"Y"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"X"}]},{"block_type":"text","content":", and ask&nbsp;them to copy and execute the script on&nbsp;their machine."}]},{"block_type":"element","block":"k68ocozv","search_text":"In many cases, your friend will proceed and download Python for its platform as well as the dependent libraries and try to execute the script. However, it can happen (more often than not) that the script will fail because either their computer has a different operating system than yours, or the installed libraries are not the same version as the one you installed on your machine. At other times, there can be previous installations that are improperly removed and will cause hard-to-debug conflicts and a lot of frustration.","text_count":527,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In many cases, your friend will proceed and download Python for its platform as well as the dependent libraries and try to execute the script. However, it can happen (more often than not) that&nbsp;the script will fail because either&nbsp;their computer has a different operating system than yours, or the installed libraries are not the same version as the one you installed&nbsp;on your machine. At other times, there&nbsp;can be previous installations&nbsp;that are improperly removed and will cause hard-to-debug conflicts and a lot of frustration."}]},{"block_type":"element","block":"k68ocozw","search_text":"A very easy way to avoid this scenario is to use virtual environments. Virtual environments are used to create and manage several Python installations by isolating Python, related executables, and third-party packages. Since Python's 3.3 version, the standard library includes the venv module (previously known as virtualenv ), which is a tool designed to create and manage simple isolated environments. Python packages in venv -based virtual environments can be installed using setup.py files or through pip .","text_count":510,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A very easy way to avoid this scenario is to use virtual environments. Virtual environments are used to create and manage several Python installations by isolating Python, related executables, and third-party packages. Since Python's 3.3 version, the standard library includes the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"venv"}]},{"block_type":"text","content":"&nbsp;module (previously known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"virtualenv"}]},{"block_type":"text","content":"), which is a tool designed&nbsp;to create and manage simple isolated environments. Python packages in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"venv"}]},{"block_type":"text","content":"-based virtual environments can be installed using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"setup.py"}]},{"block_type":"text","content":"files or through"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocozx","search_text":"Providing exact and specific library versions is crucial when dealing with high-performance code. Libraries evolve all the time between releases and changes in the algorithms may dramatically affect the performance. For instance, popular libraries, such as scipy and scikit-learn , often port some of their codes and data structures to Cython, so it's really important that the user installs the correct version for optimal performance.","text_count":436,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Providing exact and specific library versions is crucial&nbsp;when dealing with high-performance code. Libraries evolve all the time between releases and changes in the algorithms may dramatically affect the performance. For instance, popular libraries, such as"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"scipy"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"scikit-learn"}]},{"block_type":"text","content":", often port some of their codes and data structures to Cython, so it's really important that the user installs the correct version for optimal performance."}]},{"block_type":"element","block":"k68ocozy","search_text":"Using conda environments","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Using conda environments"}]},{"block_type":"element","block":"k68ocozz","search_text":"Most of the time, using venv is a fine choice. However, when writing high-performance code, it often happens that some high-performance libraries also require non-Python software to be installed. This typically involves additional setting up of compilers and high-performance native libraries (in C, C++, or Fortran) to which Python packages link. As venv and pip are designed to deal with Python packages only, this scenario is poorly supported by these tools.","text_count":461,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Most of the time, using"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"venv"}]},{"block_type":"text","content":"is a fine choice.&nbsp;However, when writing high-performance code, it often happens that some high-performance libraries also require non-Python software to be installed. This typically involves additional setting up of compilers and high-performance native libraries (in C, C++, or Fortran) to which Python packages link. As"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"venv"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip"}]},{"block_type":"text","content":"are designed to deal with Python packages only, this scenario is poorly supported by these tools."}]},{"block_type":"element","block":"k68ocp00","search_text":"The conda package manager was created specifically to handle such cases. Creating a virtual environment with conda can be done using the conda create command. The command takes a -n argument ( -n stands for --name ) that specifies an identifier for the newly created environment and the packages we intend to install. If we wish to create an environment that uses python version 3.5 and the latest version of NumPy, we use the following command:","text_count":445,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"conda"}]},{"block_type":"text","content":"package manager was created specifically to handle such cases. Creating a virtual environment with conda can be done using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"conda create"}]},{"block_type":"text","content":"command. The command takes a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-n"}]},{"block_type":"text","content":"argument ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-n"}]},{"block_type":"text","content":"stands for"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"--name"}]},{"block_type":"text","content":")&nbsp;that specifies an identifier for the newly created environment and the packages we intend to install. If we wish to create an environment that uses python version"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"3.5"}]},{"block_type":"text","content":"and the latest version of NumPy, we use the following command:"}]},{"block_type":"element","block":"k68ocp01","search_text":"$ conda create -n myenv Python=3.5 numpy ","text_count":41,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ conda create -n myenv Python=3.5 numpy"}]}]},{"block_type":"element","block":"k68ocp02","search_text":"Conda will take care of fetching the relative packages from their repositories and placing them in an isolated Python installation. To enable the virtual environment, you can use the source activate command:","text_count":207,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Conda will take care of fetching the relative packages from their repositories and placing them in an isolated Python installation. To enable the virtual environment, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"source activate"}]},{"block_type":"text","content":"command:"}]},{"block_type":"element","block":"k68ocp03","search_text":"$ source activate myenv ","text_count":24,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ source activate myenv"}]}]},{"block_type":"element","block":"k68ocp04","search_text":"After executing this command, the default Python interpreter will be switched to the version we specified earlier. You can easily verify the location of your Python executable using the which command, which returns the full path of the executable:","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"After executing this command, the default Python interpreter will be switched to the version we specified earlier. You can easily verify the location of your Python executable&nbsp;using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"which"}]},{"block_type":"text","content":"command, which returns the full path of the executable:"}]},{"block_type":"element","block":"k68ocp05","search_text":"(myenv) $ which python /home/gabriele/anaconda/envs/myenv/bin/python ","text_count":69,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"(myenv) $ which python\n/home/gabriele/anaconda/envs/myenv/bin/python"}]}]},{"block_type":"element","block":"k68ocp06","search_text":"At this point, you are free to add, remove, and modify packages in the virtual environment without affecting the global Python installation. Further packages can be installed using the conda install <package name> command or through pip .","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, you are free to add, remove, and modify packages in the virtual environment without affecting the global Python installation. Further packages can be installed using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"conda install &lt;package name&gt;"}]},{"block_type":"text","content":"command or through"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k68ocp07","search_text":"The beauty of virtual environments is that you can install or compile any software you want in a well-isolated fashion. This means that if, for some reason, your environment gets corrupted, you can scratch it and start from zero.","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The beauty of virtual environments is that you can install or compile any software you want in a well-isolated fashion. This means that if, for some reason, your environment gets corrupted, you can scratch it and start from zero."}]},{"block_type":"element","block":"k68ocp08","search_text":"To remove the myenv environment, you first need to deactivate it, and then use the conda env remove command, as follows:","text_count":120,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To remove the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"myenv"}]},{"block_type":"text","content":"environment,&nbsp;you first need to deactivate it, and then use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"conda env remove"}]},{"block_type":"text","content":"&nbsp;command, as follows:"}]},{"block_type":"element","block":"k68ocp09","search_text":"(myenv) $ source deactivate $ conda env remove -n myenv ","text_count":56,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"(myenv) $ source deactivate\n$ conda env remove -n myenv"}]}]},{"block_type":"element","block":"k68ocp0a","search_text":"What if a package is not available on the standard conda repositories? One option is to look whether it is available in the conda-forge community channel. To search for a package in conda-forge , you can add the -c option (which stands for --channel ) to the conda search command:","text_count":280,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What if a package is not available on the standard&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"conda"}]},{"block_type":"text","content":"repositories?&nbsp;One option is to look&nbsp;whether it is available in the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"conda-forge"}]},{"block_type":"text","content":"community channel. To search for a package in"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"conda-forge"}]},{"block_type":"text","content":", you can add&nbsp;the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-c"}]},{"block_type":"text","content":"option (which stands for"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"--channel"}]},{"block_type":"text","content":") to the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"conda search"}]},{"block_type":"text","content":"command:"}]},{"block_type":"element","block":"k68ocp0b","search_text":"$ conda search -c conda-forge scipy ","text_count":36,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ conda search -c conda-forge scipy"}]}]},{"block_type":"element","block":"k68ocp0c","search_text":"The command will list a series of packages and versions available that match the scipy query string. Another option is to search for the package in the public channels hosted on Anaconda Cloud . The command-line client for Anaconda Cloud can be downloaded by installing the anaconda-client package:","text_count":298,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The command will list a series of packages and versions available that match the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"scipy"}]},{"block_type":"text","content":"query string.&nbsp;Another option is to search for the package in the public channels hosted on"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Anaconda Cloud"}]},{"block_type":"text","content":". The command-line client for Anaconda Cloud can be downloaded by installing the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"anaconda-client"}]},{"block_type":"text","content":"package:"}]},{"block_type":"element","block":"k68ocp0d","search_text":"$ conda install anaconda-client ","text_count":32,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ conda install anaconda-client"}]}]},{"block_type":"element","block":"k68ocp0e","search_text":"Once the client is installed, you can use the anaconda command-line client to search for packages. In the following example, we demonstrate how to look for the chemview package:","text_count":177,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once the client is installed, you can use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"anaconda"}]},{"block_type":"text","content":"command-line client to search for packages. In the following example, we demonstrate&nbsp;how to look for the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"chemview"}]},{"block_type":"text","content":"package:"}]},{"block_type":"element","block":"k68ocp0f","search_text":"$ anaconda search chemview Using Anaconda API: https://api.anaconda.org Run 'anaconda show <USER/PACKAGE>' to get more details: Packages: Name | Version | Package Types | Platforms ------------------------- | ------ | --------------- | --------------- cjs14/chemview | 0.3 | conda | linux-64, win-64, osx-64 : WebGL Molecular Viewer for IPython notebook. gabrielelanaro/chemview | 0.7 | conda | linux-64, osx-64 : WebGL Molecular Viewer for IPython notebook. ","text_count":459,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ anaconda search chemview \nUsing Anaconda API: https://api.anaconda.org\nRun 'anaconda show &lt;USER/PACKAGE&gt;' to get more details:\nPackages:\n Name                      | Version | Package Types   | Platforms \n ------------------------- | ------  | --------------- | ---------------\n cjs14/chemview            | 0.3     | conda           | linux-64, win-64, osx-64\n                                     : WebGL Molecular Viewer for IPython notebook.\n gabrielelanaro/chemview   | 0.7     | conda           | linux-64, osx-64\n                                     : WebGL Molecular Viewer for IPython notebook."}]}]},{"block_type":"element","block":"k68ocp0g","search_text":"Installation can then be easily performed by specifying the appropriate channel with the -c option:","text_count":99,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Installation can then be easily performed by specifying the appropriate channel with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-c"}]},{"block_type":"text","content":"option:"}]},{"block_type":"element","block":"k68ocp0h","search_text":"$ conda install -c gabrielelanaro chemlab ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ conda install -c gabrielelanaro chemlab"}]}]},{"block_type":"element","block":"k68ocp0i","search_text":"Virtualization and Containers","text_count":29,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Virtualization and Containers"}]},{"block_type":"element","block":"k68ocp0j","search_text":"Virtualization has been around for a long time as a way to run multiple operating systems on the same machine in order to better utilize physical resources.","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Virtualization has been around for a long time as a way to run multiple operating systems on the same machine in order to better utilize physical resources."}]},{"block_type":"element","block":"k68ocp0k","search_text":"One way to achieve virtualization is to employ a virtual machine . Virtual machines work by creating virtual hardware resources, such as CPU, memory, and devices, and use those to install and run multiple operating systems on the same machine. Virtualization can be accomplished by installing a hypervisor application on top of an operating system (called host ). The hypervisor is capable of creating, managing, and monitoring virtual machines and their respective operating systems (called guests ).","text_count":501,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One way to achieve virtualization is to employ a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"virtual machine"}]},{"block_type":"text","content":". Virtual machines work by creating virtual hardware resources, such as CPU, memory, and devices, and use those to install and run multiple operating systems on the same machine. Virtualization can be accomplished by installing a hypervisor application on top of an operating system (called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"host"}]},{"block_type":"text","content":"). The hypervisor is capable of creating, managing, and monitoring virtual machines and their respective operating systems (called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"guests"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k68ocp0l","search_text":"Note It's important to note that virtual environments, despite their name, have nothing to do with virtual machines. A virtual environment is Python-specific and works by setting up different Python interpreters through shell scripts. ","text_count":235,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to note that virtual environments, despite their name, have nothing to do with virtual machines. A virtual environment is Python-specific and works by setting up different Python interpreters through shell scripts."}]}]},{"block_type":"element","block":"k68ocp0m","search_text":"Containers are a way to isolate an application by creating an environment separated from the host operating system and contain only the necessary dependencies. Containers are an operating system feature that allows you to share the hardware resources (provided by the operating system kernel) for multiple instances. A container is different from a virtual machine because it does not abstract hardware resources, but merely shares the operating system's kernel.","text_count":462,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Containers are a way to isolate an application by creating an environment separated from the host operating system and contain only the necessary dependencies. Containers are an operating system feature that allows you to share the hardware resources (provided by the operating system kernel) for multiple instances. A container is different from a virtual machine because it does not abstract hardware&nbsp;resources, but merely shares the&nbsp;operating system's kernel."}]},{"block_type":"element","block":"k68ocp0n","search_text":"Containers are very efficient at utilizing hardware resources as those are accessed natively through the kernel. For this reason, they are an excellent solution for high-performance applications. They are also fast to create and destroy and can be used to quickly test an application in isolation. Containers are also used to simplify deployments (especially microservices) and to develop build servers, such as the ones we mentioned in the preceding section.","text_count":459,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Containers are very efficient at utilizing hardware resources as those are accessed natively through the kernel. For this reason, they are an excellent solution for high-performance applications. They are also&nbsp;fast to create and destroy and can be used to quickly test an application in isolation. Containers are also used to simplify deployments (especially microservices) and to develop build servers, such as the ones we mentioned in the&nbsp;preceding section."}]},{"block_type":"element","block":"k68ocp0o","search_text":"In Chapter 8, Distributed Processing , we used docker to easily set up a PySpark installation. Docker is one of the most popular containerization solutions available today. The best way to install docker is by following the instructions on the official website ( https://www.docker.com/ ). After installation, it is possible to easily create and manage containers using the docker command-line interface.","text_count":404,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Chapter 8,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Distributed Processing"}]},{"block_type":"text","content":", we used"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"docker"}]},{"block_type":"text","content":"to easily set up a PySpark installation. Docker is one of the most popular containerization solutions available today. The best way to install docker is by following the instructions on the&nbsp;official website ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.docker.com/"},"children":[{"block_type":"text","content":"https://www.docker.com/"}]},{"block_type":"text","content":"). After installation, it is possible to easily create and manage containers using the docker command-line interface."}]},{"block_type":"element","block":"k68ocp0p","search_text":"You can start a new container by using the docker run command. In the following example, we will demonstrate how to use docker run to execute a shell session in an Ubuntu 16.04 container. To do this, we will need to specify the following arguments:","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can start a&nbsp;new container by using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"docker run"}]},{"block_type":"text","content":"command. In the following example, we will demonstrate how to use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"docker run"}]},{"block_type":"text","content":"to execute a shell session in an Ubuntu 16.04 container. To do this, we will need to specify the following arguments:"}]},{"block_type":"element","block":"k68ocp0q","search_text":"-i specifies that we are trying to start an interactive session. It is also possible to execute individual docker commands without interactivity (for example, when starting a web server). -t <image name> specifies which system image to use. In the following example, we use the ubuntu:16.04 image. /bin/bash , which is the command to run inside the container, demonstrated as follows: ","text_count":385,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-i"}]},{"block_type":"text","content":"specifies that we are trying to start an interactive session. It is also possible to execute individual docker commands without interactivity (for example, when starting a web server)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-t &lt;image name&gt;"}]},{"block_type":"text","content":"specifies which system image to use. In the following example, we use the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ubuntu:16.04"}]},{"block_type":"text","content":"image."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"&nbsp;/bin/bash"}]},{"block_type":"text","content":", which is the command to run inside the container, demonstrated as follows:"}]}]},{"block_type":"element","block":"k68ocp0r","search_text":"$ docker run -i -t ubuntu:16.04 /bin/bash root@585f53e77ce9:/# ","text_count":63,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ docker run -i -t ubuntu:16.04 /bin/bash\n      root@585f53e77ce9:/#"}]}]},{"block_type":"element","block":"k68ocp0s","search_text":"This command will immediately take us into a separate, isolated shell where we can play around with the system and install software without touching the host operating system. Using a container is a very good way to test installations and deployments on different Linux flavors. After we are done with the interactive shell, we can type the exit command to return to the host system.","text_count":383,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This command will immediately take us into a separate, isolated shell&nbsp;where we can play around with the system and install software without touching the host operating system. Using a container is a very good way to test installations and deployments on different Linux flavors. After we are done with the interactive shell, we can type the&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"exit"}]},{"block_type":"text","content":"&nbsp;command to return to the host system."}]},{"block_type":"element","block":"k68ocp0t","search_text":"In the last chapter, we also made use of the port and detach options, -p and -d , to run the executable pyspark . The -d option simply asks Docker to run the command in the background. The -p <host_port>:<guest_port> option was, instead, necessary to map a network port of the host operating system to the guest system; without this option, the Jupyter Notebook would not have been reachable from a browser running in the host system.","text_count":434,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the last chapter, we also made use of the port and detach options,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-p"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-d"}]},{"block_type":"text","content":", to run the executable"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyspark"}]},{"block_type":"text","content":". The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-d"}]},{"block_type":"text","content":"option simply asks Docker to run the command in the background. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-p &lt;host_port&gt;:&lt;guest_port&gt;"}]},{"block_type":"text","content":"&nbsp;option was, instead, necessary to map a network port of the host operating system to the guest system; without this option, the Jupyter Notebook would not have been reachable from a browser running in the host system."}]},{"block_type":"element","block":"k68ocp0u","search_text":"We can monitor the status of the containers with docker ps , as shown in the following snippet. The -a option (which stands for all ) serves to output information about all the containers, whether they are currently running or not:","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can monitor&nbsp;the status of the containers with"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"docker ps"}]},{"block_type":"text","content":", as shown in the following snippet.&nbsp;The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-a"}]},{"block_type":"text","content":"option (which stands for"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"all"}]},{"block_type":"text","content":") serves to output information about&nbsp;all the containers, whether they are currently running or not:"}]},{"block_type":"element","block":"k68ocp0v","search_text":"$ docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 585f53e77ce9 ubuntu:16.04 \"/bin/bash\" 2 minutes ago Exited (0) 2 minutes ago pensive_hamilton ","text_count":163,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ docker ps -a\nCONTAINER ID IMAGE        COMMAND     CREATED       STATUS     PORTS NAMES\n585f53e77ce9 ubuntu:16.04 \"/bin/bash\" 2 minutes ago Exited (0)       2 minutes ago pensive_hamilton"}]}]},{"block_type":"element","block":"k68ocp0w","search_text":"The information provided by docker ps includes a hexadecimal identifier, 585f53e77ce9 , as well as a human readable name, pensive_hamilton , both of which can be used to specify the container in other docker commands. It also includes additional information about the command executed, creation time, and the execution's current status.","text_count":336,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The information provided by"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"docker ps"}]},{"block_type":"text","content":"includes a hexadecimal identifier,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"585f53e77ce9"}]},{"block_type":"text","content":", as well as a human readable&nbsp;name,"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pensive_hamilton"}]},{"block_type":"text","content":", both of which can be used to specify the container in other docker commands. It also includes additional information about the command executed, creation time, and the execution's current status."}]},{"block_type":"element","block":"k68ocp0x","search_text":"You can resume the execution of an exited container using the docker start command. To gain shell access to the container, you can use docker attach . Both these commands can be followed by either the container ID or its human readable name:","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can resume the execution of an exited container using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"docker start"}]},{"block_type":"text","content":"command. To gain shell access to the container, you can use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"docker attach"}]},{"block_type":"text","content":". Both these commands can be followed by either the container&nbsp;ID or its human readable name:"}]},{"block_type":"element","block":"k68ocp0y","search_text":"$ docker start pensive_hamilton pensive_hamilton $ docker attach pensive_hamilton root@585f53e77ce9:/# ","text_count":103,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ docker start pensive_hamilton \npensive_hamilton\n$ docker attach pensive_hamilton \nroot@585f53e77ce9:/#"}]}]},{"block_type":"element","block":"k68ocp0z","search_text":"A container can be easily removed using the docker run command followed by a container identifier:","text_count":98,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A container can be easily removed using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"docker run"}]},{"block_type":"text","content":"command followed by a container identifier:"}]},{"block_type":"element","block":"k68ocp10","search_text":"$ docker rm pensive_hamilton ","text_count":29,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ docker rm pensive_hamilton"}]}]},{"block_type":"element","block":"k68ocp11","search_text":"As you can see, you are free to execute commands, run, stop, and resume containers as needed, in less than a second. Using docker containers interactively is a great way to test things out and play with new packages without disturbing the host operating system. Since you can run many containers at the same time, docker can also be used to simulate a distributed system (for testing and learning purposes) without having to own an expensive computing cluster.","text_count":460,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, you are free to execute commands, run, stop, and resume containers as needed, in less than a second. Using docker containers interactively is a great way to test things out and play with new packages without disturbing the host operating system. Since you can run many containers at the same time, docker can also be used to simulate a distributed system (for testing and learning purposes) without having to own an expensive computing cluster."}]},{"block_type":"element","block":"k68ocp12","search_text":"Docker also allows you to create your own system images, which is useful for distribution, testing, deployment, and documentation purposes. This will be the topic of the next subsection.","text_count":186,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Docker also allows you to create your own system images, which is useful for distribution, testing, deployment, and documentation purposes. This will be the topic of the next subsection."}]},{"block_type":"element","block":"k68ocp13","search_text":"Creating docker images","text_count":22,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Creating docker images"}]},{"block_type":"element","block":"k68ocp14","search_text":"Docker images are ready-to-use, pre-configured systems. The docker run command can be used to access and install the docker images available on the DockerHub ( https://hub.docker.com/ ), a web service where package maintainers upload ready-to-use images to test and deploy various applications.","text_count":294,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Docker images are ready-to-use, pre-configured systems. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"docker run"}]},{"block_type":"text","content":"&nbsp;command can be used to access and install the docker images available on the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"DockerHub"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://hub.docker.com/"},"children":[{"block_type":"text","content":"https://hub.docker.com/"}]},{"block_type":"text","content":"), a web service where package maintainers upload ready-to-use images to test and deploy various applications."}]},{"block_type":"element","block":"k68ocp15","search_text":"One way to create a docker image is by using the docker commit command on an existing container. The docker commit command takes a container reference and the output image names as arguments:","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One way to create a docker image is by using the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"docker commit"}]},{"block_type":"text","content":"command on an existing container. The docker commit command takes a container reference and the output image names as arguments:"}]},{"block_type":"element","block":"k68ocp16","search_text":"$ docker commit <container_id> <new_image_name> ","text_count":48,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ docker commit &lt;container_id&gt; &lt;new_image_name&gt;"}]}]},{"block_type":"element","block":"k68ocp17","search_text":"Using this method is useful to save snapshots of a certain container but, if the image is removed from the system, the steps to recreate the image are lost as well.","text_count":164,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using this method is useful to save snapshots of a certain container but, if the image is removed from the system, the steps to recreate the image are lost as well."}]},{"block_type":"element","block":"k68ocp18","search_text":"A better way to create an image is to build it using a Dockerfile . A Dockerfile is a text file that provides instructions on how to build an image starting from another image. As an example, we will illustrate the contents of the Dockerfile we used in the last chapter to set up PySpark with Jupyter notebook support. The complete file is reported here.","text_count":354,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A better way to create an image is to build it using a&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Dockerfile"}]},{"block_type":"text","content":". A Dockerfile is a text file that provides instructions on how to build an image starting from another image. As an example, we will illustrate the contents of the Dockerfile we used in the&nbsp;last chapter to set up PySpark with Jupyter notebook support. The complete file is reported here."}]},{"block_type":"element","block":"k68ocp19","search_text":"Each Dockerfile needs a starting image, which can be declared with the FROM command. In our case, the starting image is jupyter/scipy-notebook , which is available through DockerHub ( https://hub.docker.com/r/jupyter/scipy-notebook/ ).","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Each Dockerfile needs a starting image, which can be declared with the"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"FROM"}]},{"block_type":"text","content":"command. In our case, the starting image is"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"jupyter/scipy-notebook"}]},{"block_type":"text","content":", which is available through DockerHub ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://hub.docker.com/r/jupyter/scipy-notebook/"},"children":[{"block_type":"text","content":"https://hub.docker.com/r/jupyter/scipy-notebook/"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k68ocp1a","search_text":"Once we have defined our starting image, we can start issuing shell commands to install packages and perform other configurations using a series of RUN and ENV commands. In the following example, you can recognize installation of Java Runtime Environment ( openjdk-7-jre-headless ) as well as downloading Spark and setting up relevant environment variables. The USER instructions can be used to specify which user executes the subsequent commands:","text_count":447,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once we have defined our starting image, we can start issuing shell commands to install packages and perform other configurations using a series of"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"RUN"}]},{"block_type":"text","content":"&nbsp;and"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"ENV"}]},{"block_type":"text","content":"commands. In the following example, you can recognize installation of Java Runtime Environment ("},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"openjdk-7-jre-headless"}]},{"block_type":"text","content":") as well as downloading Spark and setting up relevant environment variables. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"USER"}]},{"block_type":"text","content":"instructions&nbsp;can be used&nbsp;to specify which user executes the subsequent commands:"}]},{"block_type":"element","block":"k68ocp1b","search_text":"FROM jupyter/scipy-notebook MAINTAINER Jupyter Project <jupyter@googlegroups.com> USER root # Spark dependencies ENV APACHE_SPARK_VERSION 2.0.2 RUN apt-get -y update && apt-get install -y --no-install-recommends openjdk-7-jre-headless && apt-get clean && rm -rf /var/lib/apt/lists/* RUN cd /tmp && wget -q http://d3kbcqa49mib13.cloudfront.net/spark- ${APACHE_SPARK_VERSION}-bin-hadoop2.6.tgz && echo \"ca39ac3edd216a4d568b316c3af00199 b77a52d05ecf4f9698da2bae37be998a *spark-${APACHE_SPARK_VERSION}-bin-hadoop2.6.tgz\" | sha256sum -c - && tar xzf spark-${APACHE_SPARK_VERSION} -bin-hadoop2.6.tgz -C /usr/local && rm spark-${APACHE_SPARK_VERSION}-bin-hadoop2.6.tgz RUN cd /usr/local && ln -s spark-${APACHE_SPARK_VERSION} -bin-hadoop2.6 spark # Spark and Mesos config ENV SPARK_HOME /usr/local/spark ENV PYTHONPATH $SPARK_HOME/python:$SPARK_HOME/python/lib/ py4j-0.10.3-src.zip ENV SPARK_OPTS --driver-java-options=-Xms1024M --driver-java-options=- Xmx4096M --driver-java-options=-Dlog4j.logLevel=info USER $NB_USER ","text_count":1013,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"FROM jupyter/scipy-notebook\n    MAINTAINER Jupyter Project &lt;jupyter@googlegroups.com&gt;\n    USER root\n\n    # Spark dependencies\n    ENV APACHE_SPARK_VERSION 2.0.2\n    RUN apt-get -y update &amp;&amp; \n        apt-get install -y --no-install-recommends \n        openjdk-7-jre-headless &amp;&amp; \n        apt-get clean &amp;&amp; \n        rm -rf /var/lib/apt/lists/*\n    RUN cd /tmp &amp;&amp; \n        wget -q http://d3kbcqa49mib13.cloudfront.net/spark-\n        ${APACHE_SPARK_VERSION}-bin-hadoop2.6.tgz    &amp;&amp; \n        echo \"ca39ac3edd216a4d568b316c3af00199\n              b77a52d05ecf4f9698da2bae37be998a \n              *spark-${APACHE_SPARK_VERSION}-bin-hadoop2.6.tgz\" | \n        sha256sum -c - &amp;&amp; \n        tar xzf spark-${APACHE_SPARK_VERSION}\n        -bin-hadoop2.6.tgz -C /usr/local &amp;&amp; \n        rm spark-${APACHE_SPARK_VERSION}-bin-hadoop2.6.tgz\n    RUN cd /usr/local &amp;&amp; ln -s spark-${APACHE_SPARK_VERSION}\n        -bin-hadoop2.6 spark\n\n    # Spark and Mesos config\n    ENV SPARK_HOME /usr/local/spark\n    ENV PYTHONPATH $SPARK_HOME/python:$SPARK_HOME/python/lib/\n        py4j-0.10.3-src.zip\n    ENV SPARK_OPTS --driver-java-options=-Xms1024M \n        --driver-java-options=-\n        Xmx4096M --driver-java-options=-Dlog4j.logLevel=info\n\n    USER $NB_USER"}]}]},{"block_type":"element","block":"k68ocp1c","search_text":"Dockerfiles can be used to create images using the following command from the directory where the Dockerfile is located. The -t option can be used to specify the tag that will be used to store the image. With the following line, we can create the image named pyspark from the preceding Dockerfile:","text_count":297,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dockerfiles can be used to create images using the following command from the directory where the Dockerfile is located. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"-t"}]},{"block_type":"text","content":"option can be used to specify the tag that will be used to store the image. With the following line, we can create the image named&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyspark"}]},{"block_type":"text","content":"from the preceding Dockerfile:"}]},{"block_type":"element","block":"k68ocp1d","search_text":"$ docker build -t pyspark . ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"$ docker build -t pyspark ."}]}]},{"block_type":"element","block":"k68ocp1e","search_text":"The command will automatically retrieve the starting image, jupyter/scipy-notebook , and produce a new image, named pyspark . ","text_count":126,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The command will automatically retrieve&nbsp;the starting image,&nbsp;"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"jupyter/scipy-notebook"}]},{"block_type":"text","content":", and produce a new image, named"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pyspark"}]},{"block_type":"text","content":".&nbsp;"}]},{"block_type":"element","block":"k68ocp1f","search_text":"Continuous integration","text_count":22,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Continuous integration"}]},{"block_type":"element","block":"k68ocp1g","search_text":"Continuous integration is a great way to ensure that the application stays bug-free at every development iteration. The main idea behind continuous integration is to run the test suite for the project very frequently, usually on a separate build server that pulls the code directly from the main project repository.","text_count":315,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Continuous integration is a great way to ensure that the application stays bug-free at every development iteration. The main idea behind continuous integration is to run the test suite for the project very frequently, usually on a separate build server that pulls the code directly from the main project repository."}]},{"block_type":"element","block":"k68ocp1h","search_text":"Setting up a build server can be accomplished by manually setting up software such as Jenkins ( https://jenkins.io/ ), Buildbot ( http://buildbot.net/ ), and Drone ( https://github.com/drone/drone ) on a machine. This a convenient and cheap solution, especially for small teams and private projects.","text_count":299,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Setting up a build server can be accomplished by manually setting up software&nbsp;such as Jenkins ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://jenkins.io/"},"children":[{"block_type":"text","content":"https://jenkins.io/"}]},{"block_type":"text","content":"), Buildbot ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://buildbot.net/"},"children":[{"block_type":"text","content":"http://buildbot.net/"}]},{"block_type":"text","content":"), and Drone ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/drone/drone"},"children":[{"block_type":"text","content":"https://github.com/drone/drone"}]},{"block_type":"text","content":") on a machine. This a convenient and cheap solution, especially for small teams and private projects."}]},{"block_type":"element","block":"k68ocp1i","search_text":"Most open source projects take advantage of Travis CI ( https://travis-ci.org/ ), a service capable of building and testing your code automatically from your repository because it's tightly integrated with GitHub. As of today, Travis CI provides a free plan for open source projects. Many open source Python projects take advantage of Travis CI to ensure that the programs run correctly on multiple Python versions and platforms.","text_count":429,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Most open source projects take advantage of Travis CI ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://travis-ci.org/"},"children":[{"block_type":"text","content":"https://travis-ci.org/"}]},{"block_type":"text","content":"), a service capable of building and testing your code automatically from your repository because it's tightly integrated with GitHub. As of today, Travis CI provides a free plan for open source projects. Many open source Python projects take advantage of Travis CI to ensure that the programs run correctly on multiple Python versions and platforms."}]},{"block_type":"element","block":"k68ocp1j","search_text":"Travis CI can be set up easily from a GitHub repository by including a .travis.yml file containing the build instruction for the project and activating the builds on the Travis CI website ( https://travis-ci.org/ ) after registering an account.","text_count":244,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Travis CI can be set up easily from a GitHub repository by including a"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".travis.yml"}]},{"block_type":"text","content":"file containing the build instruction for the project and activating the builds on the Travis CI website ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://travis-ci.org/"},"children":[{"block_type":"text","content":"https://travis-ci.org/"}]},{"block_type":"text","content":") after registering an account."}]},{"block_type":"element","block":"k68ocp1k","search_text":"An example .travis.yml for a high performance application is illustrated here. The file contains instructions to build and run the software that are specified using a few sections written in YAML syntax.","text_count":203,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An example"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".travis.yml"}]},{"block_type":"text","content":"&nbsp;for a high performance application is illustrated&nbsp;here. The file contains&nbsp;instructions to build and run the software&nbsp;that are specified using a few sections written in YAML syntax."}]},{"block_type":"element","block":"k68ocp1l","search_text":"The python section specifies which Python versions to use. The install section will download and set up conda for testing, installing dependencies, and setting up the project. While this step is not necessary (one can use pip instead), conda is a great package manager for high-performance applications as it contains useful native packages.","text_count":341,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"python"}]},{"block_type":"text","content":"section specifies which Python versions to use. The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"install"}]},{"block_type":"text","content":"section will download and set up conda for testing, installing dependencies, and setting up the project. While this step is not necessary (one can use"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"pip"}]},{"block_type":"text","content":"instead), conda is a great package manager for high-performance applications as it contains useful native packages."}]},{"block_type":"element","block":"k68ocp1m","search_text":"The script section contains the code needed to test the code. In this example, we limit ourselves to run our tests and benchmarks:","text_count":130,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":"script"}]},{"block_type":"text","content":"section contains the code needed to test the code. In this example, we limit ourselves to run our tests and benchmarks:"}]},{"block_type":"element","block":"k68ocp1n","search_text":"language: python python: - \"2.7\" - \"3.5\" install: # Setup miniconda - sudo apt-get update - if [[ \"$TRAVIS_PYTHON_VERSION\" == \"2.7\" ]]; then wget https://repo.continuum.io/miniconda/ Miniconda2-latest-Linux-x86_64.sh -O miniconda.sh; else wget https://repo.continuum.io/miniconda/ Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh; fi - bash miniconda.sh -b -p $HOME/miniconda - export PATH=\"$HOME/miniconda/bin:$PATH\" - hash -r - conda config --set always_yes yes --set changeps1 no - conda update -q conda # Installing conda dependencies - conda create -q -n test-environment python= $TRAVIS_PYTHON_VERSION numpy pandas cython pytest - source activate test-environment # Installing pip dependencies - pip install pytest-benchmark - python setup.py install script: pytest tests/ pytest benchmarks/ ","text_count":799,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"language: python\n    python:\n      - \"2.7\"\n      - \"3.5\"\n    install:\n      # Setup miniconda\n      - sudo apt-get update\n      - if [[ \"$TRAVIS_PYTHON_VERSION\" == \"2.7\" ]]; then\n          wget https://repo.continuum.io/miniconda/\n          Miniconda2-latest-Linux-x86_64.sh -O miniconda.sh;\n        else\n          wget https://repo.continuum.io/miniconda/\n          Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;\n        fi\n      - bash miniconda.sh -b -p $HOME/miniconda\n      - export PATH=\"$HOME/miniconda/bin:$PATH\"\n      - hash -r\n      - conda config --set always_yes yes --set changeps1 no\n      - conda update -q conda\n      # Installing conda dependencies\n      - conda create -q -n test-environment python=\n        $TRAVIS_PYTHON_VERSION numpy pandas cython pytest\n      - source activate test-environment\n      # Installing pip dependencies\n      - pip install pytest-benchmark\n      - python setup.py install\n\n    script:\n      pytest tests/\n      pytest benchmarks/"}]}]},{"block_type":"element","block":"k68ocp1o","search_text":"Every time new code is pushed (as well as other configurable events) to the GitHub repository, Travis CI will spin up a container, install dependencies, and run the test suite. Using Travis CI in open source projects is a great practice as it is a form of constant feedback about the status of the project and also provides up-to-date installation instructions through a continuously tested .travis.yml file.","text_count":408,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Every time new code is pushed (as well as other configurable events) to the GitHub repository, Travis CI will spin up a container, install dependencies, and run&nbsp;the test suite. Using Travis CI in open source projects is a great practice as it is a form of constant feedback about the status of the project and also provides up-to-date installation instructions through a continuously tested"},{"block_type":"element","tag_name":"kbd","attributes":{},"children":[{"block_type":"text","content":".travis.yml"}]},{"block_type":"text","content":"file."}]},{"block_type":"element","block":"k68ocp1p","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k68ocp1q","search_text":"Deciding on a strategy to optimize your software is a complex and delicate task that depends on the application type, target platforms, and business requirements. In this chapter, we provided some guidelines to help you think and choose an appropriate software stack for your own applications.","text_count":293,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Deciding on a strategy to optimize your software is a complex and delicate task&nbsp;that depends on the application type, target platforms, and business requirements. In this chapter, we provided some guidelines to help you think and choose an appropriate software stack for your own applications."}]},{"block_type":"element","block":"k68ocp1r","search_text":"High-performance numerical applications sometimes require managing installation and deployment of third-party packages that may require handling of external tools and native extensions. In this chapter, we saw how to structure your Python project, including tests, benchmarks, documentation, Cython modules, and C extensions. Also, we introduced the continuous integration service Travis CI, which can be used to enable continuous testing for your projects hosted on GitHub.","text_count":474,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"High-performance numerical applications sometimes require managing installation and deployment of third-party packages&nbsp;that may require handling of external tools and native extensions. In this chapter, we saw how to structure your Python project, including tests, benchmarks, documentation, Cython modules, and C extensions. Also, we introduced the continuous integration service Travis CI, which can be used to enable continuous testing for your projects hosted on GitHub."}]},{"block_type":"element","block":"k68ocp1s","search_text":"Finally, we also learned about virtual environments and docker containers that can be used to test applications in isolation and to greatly simplify deployments and ensure that multiple developers have access to the same platform.","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we also learned about&nbsp;virtual environments and docker containers&nbsp;that can be used to test applications in isolation and to greatly simplify deployments and ensure that multiple developers have access to the same platform."}]}]}]}