{"title":"Node.js","authors":["Mario Casciaro & Luciano Mammino"],"publisher":"packt","version":1,"chapters":[{"title":"Preface","author":"","block":"k5zy4mc5","number":0,"contents":[{"block_type":"element","block":"k5zy5a9v","search_text":"Node.js Design Patterns - Second Edition","text_count":40,"tag_name":"h1","attributes":{"id":"maintitle"},"children":[{"block_type":"text","content":"Node.js Design Patterns - Second Edition"}]},{"block_type":"element","block":"k5zy5a9w","search_text":"Copyright © 2016 Packt Publishing","text_count":33,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Copyright &copy; 2016 Packt Publishing"}]},{"block_type":"element","block":"k5zy5a9x","search_text":"All rights reserved. No part of this book may be reproduced, stored in a retrieval system, or transmitted in any form or by any means, without the prior written permission of the publisher, except in the case of brief quotations embedded in critical articles or reviews.","text_count":270,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All rights reserved. No part of this book may be reproduced, stored in a retrieval system, or transmitted in any form or by any means, without the prior written permission of the publisher, except in the case of brief quotations embedded in critical articles or reviews."}]},{"block_type":"element","block":"k5zy5a9y","search_text":"Every effort has been made in the preparation of this book to ensure the accuracy of the information presented. However, the information contained in this book is sold without warranty, either express or implied. Neither the authors, nor Packt Publishing, and its dealers and distributors will be held liable for any damages caused or alleged to be caused directly or indirectly by this book.","text_count":392,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Every effort has been made in the preparation of this book to ensure the accuracy of the information presented. However, the information contained in this book is sold without warranty, either express or implied. Neither the authors, nor Packt Publishing, and its dealers and distributors will be held liable for any damages caused or alleged to be caused directly or indirectly by this book."}]},{"block_type":"element","block":"k5zy5a9z","search_text":"Packt Publishing has endeavored to provide trademark information about all of the companies and products mentioned in this book by the appropriate use of capitals. However, Packt Publishing cannot guarantee the accuracy of this information.","text_count":240,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Packt Publishing has endeavored to provide trademark information about all of the companies and products mentioned in this book by the appropriate use of capitals. However, Packt Publishing cannot guarantee the accuracy of this information."}]},{"block_type":"element","block":"k5zy5aa0","search_text":"First published: December 2014","text_count":30,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First published: December 2014"}]},{"block_type":"element","block":"k5zy5aa1","search_text":"Second edition: July 2016","text_count":25,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Second edition: July 2016"}]},{"block_type":"element","block":"k5zy5aa2","search_text":"Production reference: 1110716","text_count":29,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Production reference: 1110716"}]},{"block_type":"element","block":"k5zy5aa3","search_text":"Published by Packt Publishing Ltd.","text_count":34,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Published by Packt Publishing Ltd."}]},{"block_type":"element","block":"k5zy5aa4","search_text":"Livery Place","text_count":12,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Livery Place"}]},{"block_type":"element","block":"k5zy5aa5","search_text":"35 Livery Street","text_count":16,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"35 Livery Street"}]},{"block_type":"element","block":"k5zy5aa6","search_text":"Birmingham B32PB, UK.","text_count":21,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Birmingham B32PB, UK."}]},{"block_type":"element","block":"k5zy5aa7","search_text":"ISBN 978-1-78588-558-7","text_count":22,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"ISBN&nbsp;978-1-78588-558-7"}]},{"block_type":"element","block":"k5zy5aa8","search_text":"www.packtpub.com","text_count":16,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com"},"children":[{"block_type":"text","content":"www.packtpub.com"}]}]},{"block_type":"element","block":"k5zy5aa9","search_text":"Credits","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Credits"}]},{"block_type":"element","block":"k5zy5aaa","search_text":"Authors Mario Casciaro Luciano Mammino Copy Editor Safis Editing Reviewers Tane Piper Joel Purra Project Coordinator Ulhas Kambali Commissioning Editor Amarabha Banerjee Proofreader Safis Editing Acquisition Editor Reshma Raman Indexer Mariammal Chettiyar Content Development Editor Onkar Wani Graphics Kirk D'Penha Technical Editor Prajakta Mhatre Production Coordinator Nilesh Mohite ","text_count":386,"tag_name":"table","attributes":{"border":"1"},"children":[{"block_type":"element","tag_name":"colgroup","attributes":{},"children":[{"block_type":"element","tag_name":"col","attributes":{},"children":[]},{"block_type":"element","tag_name":"col","attributes":{},"children":[]}]},{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Authors"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Mario Casciaro"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Luciano Mammino&nbsp;"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Copy Editor"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Safis Editing"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Reviewers"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Tane Piper"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Joel Purra&nbsp;"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Project Coordinator"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Ulhas Kambali"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Commissioning Editor"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Amarabha Banerjee&nbsp;"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Proofreader"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Safis Editing&nbsp;"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Acquisition Editor"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Reshma Raman&nbsp;"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Indexer"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Mariammal Chettiyar&nbsp;"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Content Development Editor"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Onkar Wani&nbsp;"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Graphics"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Kirk D'Penha&nbsp;"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Technical Editor"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Prajakta Mhatre"}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Production Coordinator"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Nilesh Mohite&nbsp;"}]}]}]}]}]},{"block_type":"element","block":"k5zy5aab","search_text":"About the Authors","text_count":17,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"About the Authors"}]},{"block_type":"element","block":"k5zy5aac","search_text":"Mario Casciaro is a software engineer and entrepreneur, passionate about technology, science and open source knowledge. Mario graduated with a master's degree in software engineering and started his professional career at IBM where he worked for several years on different enterprise products such as Tivoli Endpoint Manager, Cognos Insight, and SalesConnect. Next, he moved to D4H Technologies, a growing SaaS company, to lead the development of a new bleeding-edge product for managing emergency operations in real time. Currently, Mario is the co-founder and CEO of Sponsorama.com , a platform to help online projects raise funds through corporate sponsorship.","text_count":663,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Mario Casciaro"}]},{"block_type":"text","content":"is a software engineer and entrepreneur, passionate about technology, science and open source knowledge. Mario graduated with a master's degree in software engineering and started his professional career at IBM where he worked for several years on different enterprise products such as Tivoli Endpoint Manager, Cognos Insight, and SalesConnect. Next, he moved to D4H Technologies, a growing SaaS company, to lead the development of a new bleeding-edge product for managing emergency operations in real time. Currently, Mario is the co-founder and CEO of"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://sponsorama.com/"},"children":[{"block_type":"text","content":"Sponsorama.com"}]},{"block_type":"text","content":", a platform to help online projects raise funds through corporate sponsorship."}]},{"block_type":"element","block":"k5zy5aad","search_text":"Mario is also the author of the first edition of Node.js Design Patterns .","text_count":74,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Mario is also the author of the first edition of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Design Patterns"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aae","search_text":"Acknowledgments","text_count":15,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Acknowledgments"}]},{"block_type":"element","block":"k5zy5aaf","search_text":"When I was working on the first edition of this book I would never have thought it would become such a success. My biggest thanks go to all the readers of the first edition of this book, to those who bought it, to those who left a review, and to those who recommended it to their friend s on Twitter or on other online forums. And of course, my gratitude also goes to the readers of this second edition; to you who are reading these words, you make all our efforts worthwhile. I also want you to join me in congratulating my friend Luciano, the co-author of this second edition, who did a tremendous job updating and adding new invaluable content to this book. All the merit goes to him as I only had the role of adviser in this second edition. Working on a book is not an easy task, but Luciano impressed me and all the staff at Packt for his dedication, professionalism, and technical skills, demonstrating he can achieve any goal he sets his mind to. It was a pleasure and a honor working with Luciano and I'm looking forward to other great collaborations. I also want to thank all the people who worked on the book, the folks of Packt, the technical reviewers (Tane and Joel) and all the friends who provided valuable suggestions and insights: Anton Whalley ( @dhigit9 ), Alessandro Cinelli ( @cirpo ), Andrea Giuliano ( @bit_shark ), and Andrea Mangano ( @ManganoAndrea ). Thanks to all the friends who give me unconditional love, to my family, and most importantly to my girlfriend Miriam, the partner of all my adventures, who brings love and joy in every day of my life. There are still a hundred thousand adventures awaiting us.","text_count":1637,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When I was working on the first edition of this book I would never have thought it would become such a success. My biggest thanks go to all the readers of the first edition of this book, to those who bought it, to those who left a review, and to those who recommended it to their friend"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"s"}]},{"block_type":"text","content":"on Twitter or on other online forums. And of course, my gratitude also goes to the readers of this second edition; to you who are reading these words, you make all our efforts worthwhile. I also want you to join me in congratulating my friend Luciano, the co-author of this second edition, who did a tremendous job updating and adding new invaluable content to this book. All the merit goes to him as I only had the role of adviser in this second edition. Working on a book is not an easy task, but Luciano impressed me and all the staff at Packt for his dedication, professionalism, and technical skills, demonstrating he can achieve any goal he sets his mind to. It was a pleasure and a honor working with Luciano and I'm looking forward to other great collaborations. I also want to thank all the people who worked on the book, the folks of Packt, the technical reviewers (Tane and Joel) and all the friends who provided valuable suggestions and insights:&nbsp; Anton Whalley ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"@dhigit9"}]},{"block_type":"text","content":"), Alessandro Cinelli ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"@cirpo"}]},{"block_type":"text","content":"), Andrea Giuliano ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"@bit_shark"}]},{"block_type":"text","content":"), and Andrea Mangano ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"@ManganoAndrea"}]},{"block_type":"text","content":"). Thanks to all the friends who give me unconditional love, to my family, and most importantly to my girlfriend Miriam, the partner of all my adventures, who brings love and joy in every day of my life. There are still a hundred thousand adventures awaiting us."}]},{"block_type":"element","block":"k5zy5aag","search_text":"About the Author","text_count":16,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"About the Author"}]},{"block_type":"element","block":"k5zy5aah","search_text":"Luciano Mammino is a software engineer born in 1987, the same year that the Nintendo released Super Mario Bros in Europe, which by chance is his favorite video-game. He started coding at the age of 12 using his father's old Intel 386, provided only with the DOS operating system and the qBasic interpreter.","text_count":306,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Luciano Mammino"}]},{"block_type":"text","content":"is a software engineer born in 1987, the same year that the Nintendo released Super Mario Bros in Europe, which by chance is his favorite video-game. He started coding at the age of 12 using his father's old Intel 386, provided only with the DOS operating system and the qBasic interpreter."}]},{"block_type":"element","block":"k5zy5aai","search_text":"After a master's degree in computer science he developed his programming skills mostly as a web developer working mainly as freelancer for companies and startups all around Italy. After a start-up parenthesis of 3 years as CTO and co-founder of Sbaam.com in Italy and in Ireland, he decided to relocate in Dublin to work as senior PHP engineer at Smartbox.","text_count":356,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"After a master's degree in computer science he developed his programming skills mostly as a web developer working mainly as freelancer for companies and startups all around Italy. After a start-up parenthesis of 3 years as CTO and co-founder of"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://Sbaam.com"},"children":[{"block_type":"text","content":"Sbaam.com"}]},{"block_type":"text","content":"in Italy and in Ireland, he decided to relocate in Dublin to work as senior PHP engineer at Smartbox."}]},{"block_type":"element","block":"k5zy5aaj","search_text":"He loves developing open source libraries and working with frameworks such as Symfony and Express. He is convinced that the JavaScript fame is still at the very beginning and that this technology will have a huge impact in the future of most of the web-and mobile-related technologies. For this reason, he spends most of his free time improving his knowledge of JavaScript and playing with Node.js.","text_count":398,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"He loves developing open source libraries and working with frameworks such as Symfony and Express. He is convinced that the JavaScript fame is still at the very beginning and that this technology will have a huge impact in the future of most of the web-and mobile-related technologies. For this reason, he spends most of his free time improving his knowledge of JavaScript and playing with Node.js."}]},{"block_type":"element","block":"k5zy5aak","search_text":"Acknowledgments","text_count":15,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Acknowledgments"}]},{"block_type":"element","block":"k5zy5aal","search_text":"The first huge thanks go to Mario for giving me the opportunity and the trust to work alongside him on the new edition of this book. It was an amazing experience and hopefully just the beginning of a long series of collaborations.","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first huge thanks go to Mario for giving me the opportunity and the trust to work alongside him on the new edition of this book. It was an amazing experience and hopefully just the beginning of a long series of collaborations."}]},{"block_type":"element","block":"k5zy5aam","search_text":"This book was only possible thanks to the incredible and efficient work of the Packt team, especially thanks to the relentless efforts and the patience of Onkar, Reshma, and Prajakta. Also thanks to the reviewers Tane Piper and Joel Purra, their experience with Node.js was crucial to raise the quality of the content provided in this book.","text_count":340,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This book was only possible thanks to the incredible and efficient work of the Packt team, especially thanks to the relentless efforts and the patience of Onkar, Reshma, and Prajakta. Also thanks to the reviewers Tane Piper and Joel Purra, their experience with Node.js was crucial to raise the quality of the content provided in this book."}]},{"block_type":"element","block":"k5zy5aan","search_text":"A great hug (and many beers) go to my friends Anton Whalley ( @dhigit9 ), Alessandro Cinelli ( @cirpo ), Andrea Giuliano ( @bit_shark ), and Andrea Mangano ( @ManganoAndrea ) for encouraging me all along the way, for sharing with me their experience as developers and for providing meaningful insights on the contents of this book.","text_count":331,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A great hug (and many beers) go to my friends Anton Whalley ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"@dhigit9"}]},{"block_type":"text","content":"), Alessandro Cinelli ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"@cirpo"}]},{"block_type":"text","content":"), Andrea Giuliano ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"@bit_shark"}]},{"block_type":"text","content":"), and Andrea Mangano ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"@ManganoAndrea"}]},{"block_type":"text","content":") for encouraging me all along the way, for sharing with me their experience as developers and for providing meaningful insights on the contents of this book."}]},{"block_type":"element","block":"k5zy5aao","search_text":"Another great thank you goes to Ricardo, Jose, Alberto, Marcin, Nacho, David, Arthur, and all my colleagues at Smartbox for making me love my days at work and for inspiring and motivating me to get better every day as a software engineer. I couldn't ask for a better team.","text_count":272,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another great thank you goes to Ricardo, Jose, Alberto, Marcin, Nacho, David, Arthur, and all my colleagues at Smartbox for making me love my days at work and for inspiring and motivating me to get better every day as a software engineer. I couldn't ask for a better team."}]},{"block_type":"element","block":"k5zy5aap","search_text":"My deepest gratitude goes to my family, who raised and sustained me in every possible way along my journey. Thanks, mom, for being a constant source of inspiration and strength in my life. Thanks, dad, for all the lessons, the encouragement and the advice, I really miss talking with you, I really miss you. Thanks to my brother Davide and my sister Alessia for being present in the painful and the joyful moments and making me feel part of a great family.","text_count":456,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"My deepest gratitude goes to my family, who raised and sustained me in every possible way along my journey. Thanks, mom, for being a constant source of inspiration and strength in my life. Thanks, dad, for all the lessons, the encouragement and the advice, I really miss talking with you, I really miss you. Thanks to my brother Davide and my sister Alessia for being present in the painful and the joyful moments and making me feel part of a great family."}]},{"block_type":"element","block":"k5zy5aaq","search_text":"Thanks to Franco and his family for supporting many of my initiatives and for sharing their wisdom and life experience with me.","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Thanks to Franco and his family for supporting many of my initiatives and for sharing their wisdom and life experience with me."}]},{"block_type":"element","block":"k5zy5aar","search_text":"Kudos to my \"nerd\" friends Gianluca, Flavio, Antonio, Valerio, and Luca for the great time together and for constantly encouraging me to keep working on this book.","text_count":163,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Kudos to my \"nerd\" friends Gianluca, Flavio, Antonio, Valerio, and Luca for the great time together and for constantly encouraging me to keep working on this book."}]},{"block_type":"element","block":"k5zy5aas","search_text":"Also kudos to my \"less nerdy\" friends Damiano, Pietro, and Sebastiano for their friendship and all the laughs and the fun we have when we hang out together in Dublin.","text_count":166,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also kudos to my \"less nerdy\" friends Damiano, Pietro, and Sebastiano for their friendship and all the laughs and the fun we have when we hang out together in Dublin."}]},{"block_type":"element","block":"k5zy5aat","search_text":"Last, but definitely not least, thanks to my girlfriend Francesca. Thank you for the unconditioned love and for supporting me on every adventure, even the craziest ones. I really look forward to writing the next pages in the book of our life with you.","text_count":251,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Last, but definitely not least, thanks to my girlfriend Francesca. Thank you for the unconditioned love and for supporting me on every adventure, even the craziest ones. I really look forward to writing the next pages in the book of our life with you."}]},{"block_type":"element","block":"k5zy5aau","search_text":"About the Reviewers","text_count":19,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"About the Reviewers"}]},{"block_type":"element","block":"k5zy5aav","search_text":"Tane Piper is a full stack developer based in London, UK. For over 10 years He has worked for several agencies and companies delivering software in a variety of languages such as Python, PHP, and JavaScript. He has been working with Node.js since 2010 and was one of the first people talking about server-side JavaScript in the UK and Ireland with several talks in 2011/2012. He was also an early contributor to, and advocate for the jQuery project. Currently he works at a consultancy in London delivering innovative solutions and is mostly writing React and Node applications. Outside of his professional work he is a keen scuba diver and amateur photographer.","text_count":662,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Tane Piper"}]},{"block_type":"text","content":"is a full stack developer based in London, UK. For over 10 years He has worked for several agencies and companies delivering software in a variety of languages such as Python, PHP, and JavaScript. He has been working with Node.js since 2010 and was one of the first people talking about server-side JavaScript in the UK and Ireland with several talks in 2011/2012. He was also an early contributor to, and advocate for the jQuery project. Currently he works at a consultancy in London delivering innovative solutions and is mostly writing React and Node applications. Outside of his professional work he is a keen scuba diver and amateur photographer."}]},{"block_type":"element","block":"k5zy5aaw","search_text":"I would personally like to thank my girlfriend Elina who has turned my life around in the last two years and encouraged me to take up the task of reviewing this book. ","text_count":167,"tag_name":"blockquote","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"I would personally like to thank my girlfriend Elina who has turned my life around in the last two years and encouraged me to take up the task of reviewing this book."}]}]}]},{"block_type":"element","block":"k5zy5aax","search_text":"Joel Purra started toying around with computers even before he was in his teens, seeing them as another kind of a video game device. It was not long before he took apart (sometimes broke and subsequently fixed) any computer he came across while playing the latest games on them. It was gaming that led him to discover programming in his early teens when modifying a Lunar Lander game triggered an interest in creating digital tools. Soon after getting an Internet connection at home, he developed his first e-commerce website, and thus his business started; it launched his career at an early age. At the age of 17, Joel started studying computer programming and an energy science program at a nuclear power plant's school. After graduation, he studied to become a second lieutenant telecommunications specialist in the Swedish Army before moving on to study for his master's of science degree in information technology and engineering at Linköping University. He has been involved in start-ups and other companies—both successful and unsuccessful—since 1998, and he has been a consultant since 2007. Born, raised, and educated in Sweden, Joel also enjoys the flexible lifestyle of a freelance developer, having traveled through five continents with his backpack and lived abroad for several years. A learner constantly looking for challenges, one of his goals is to build and evolve software for broad public use. You can visit his website at http://joelpurra.com/ .","text_count":1467,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Joel Purra"}]},{"block_type":"text","content":"started toying around with computers even before he was in his teens, seeing them as another kind of a video game device. It was not long before he took apart (sometimes broke and subsequently fixed) any computer he came across while playing the latest games on them. It was gaming that led him to discover programming in his early teens when modifying a Lunar Lander game triggered an interest in creating digital tools. Soon after getting an Internet connection at home, he developed his first e-commerce website, and thus his business started; it launched his career at an early age. At the age of 17, Joel started studying computer programming and an energy science program at a nuclear power plant's school. After graduation, he studied to become a second lieutenant telecommunications specialist in the Swedish Army before moving on to study for his master's of science degree in information technology and engineering at Link&ouml;ping University. He has been involved in start-ups and other companies&mdash;both successful and unsuccessful&mdash;since 1998, and he has been a consultant since 2007. Born, raised, and educated in Sweden, Joel also enjoys the flexible lifestyle of a freelance developer, having traveled through five continents with his backpack and lived abroad for several years. A learner constantly looking for challenges, one of his goals is to build and evolve software for broad public use. You can visit his website at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://joelpurra.com/"},"children":[{"block_type":"text","content":"http://joelpurra.com/"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aay","search_text":"I'd like to thank the open source community for providing the building blocks necessary to compose both small and large software systems even as a freelance consultant. Nanos gigantum humeris insidentes. Remember to commit early, commit often! ","text_count":244,"tag_name":"blockquote","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"I'd like to thank the open source community for providing the building blocks necessary to compose both small and large software systems even as a freelance consultant. Nanos gigantum humeris insidentes. Remember to commit early, commit often!"}]}]}]},{"block_type":"element","block":"k5zy5aaz","search_text":"Preface","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Preface"}]},{"block_type":"element","block":"k5zy5ab0","search_text":"Node.js is considered by many as a game-changer—the biggest shift of the decade in web development. It is loved not just for its technical capabilities, but also for the paradigm shift that it introduced in web development.","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Node.js is considered by many as a game-changer&mdash;the biggest shift of the decade in web development. It is loved not just for its technical capabilities, but also for the paradigm shift that it introduced in web development."}]},{"block_type":"element","block":"k5zy5ab1","search_text":"First, Node.js applications are written in JavaScript, the language of the web, the only programming language supported natively by a majority of web browsers. This aspect enables scenarios such as single-language application stacks and sharing of code between the server and the client. Node.js itself is contributing to the rise and evolution of the JavaScript language. People realize that using JavaScript on the server is not as bad as it is in the browser, and they will soon start to love it for its pragmatism and for its hybrid nature, halfway between object-oriented and functional programming.","text_count":604,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First, Node.js applications are written in JavaScript, the language of the web, the&nbsp;only programming language supported natively by a majority of web browsers.&nbsp;This aspect enables scenarios such as single-language application stacks and sharing of code between the server and the client. Node.js itself is contributing to the rise and evolution of the JavaScript language. People realize that using JavaScript on the server is not as bad as it is in the browser, and they will soon start to love it for its pragmatism and for its hybrid nature, halfway between object-oriented and functional programming."}]},{"block_type":"element","block":"k5zy5ab2","search_text":"The second revolutionizing factor is its single-threaded, asynchronous architecture. Besides obvious advantages from a performance and scalability point of view, this characteristic changed the way developers approach concurrency and parallelism. Mutexes are replaced by queues, threads by callbacks and events, and synchronization by causality.","text_count":345,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The second revolutionizing factor is its single-threaded, asynchronous architecture. Besides obvious advantages from a performance and scalability point of view, this characteristic changed the way developers approach concurrency and parallelism. Mutexes are replaced by queues, threads by callbacks and events, and synchronization by causality."}]},{"block_type":"element","block":"k5zy5ab3","search_text":"The last and most important aspect of Node.js lies in its ecosystem: the npm package manager, its constantly growing database of modules, its enthusiastic and helpful community, and most importantly, its very own culture based on simplicity, pragmatism, and extreme modularity.","text_count":277,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The last and most important aspect of Node.js lies in its ecosystem: the npm package manager, its constantly growing database of modules, its enthusiastic and helpful community, and most importantly, its very own culture based on simplicity, pragmatism, and extreme modularity."}]},{"block_type":"element","block":"k5zy5ab4","search_text":"However, because of these peculiarities, Node.js development gives you a very different feel compared to the other server-side platforms, and any developer new to this paradigm will often feel unsure about how to tackle even the most common design and coding problem effectively. Common questions include: \"How do I organize my code?\", \"What's the best way to design this?\", \"How can I make my application more modular?\", \"How do I handle a set of asynchronous calls effectively?\", \"How can I make sure that my application will not collapse while it grows?\", or more simply \"What's the right way of doing this?\" Fortunately, Node.js has become a mature enough platform and most of these questions can now be easily answered with a design pattern, a proven coding technique, or a recommended practice. The aim of this book is to guide you through this emerging world of patterns, techniques, and practices, showing you what the proven solutions to the common problems are and teaching you how to use them as the starting point to building the solution to your particular problem.","text_count":1078,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, because of these peculiarities, Node.js development gives you a very different feel compared to the other server-side platforms, and any developer&nbsp;new to this paradigm will often feel unsure about how to tackle even the most common design and coding problem effectively. Common questions include: \"How do I organize my code?\", \"What's the best way to design this?\", \"How can I make my application more modular?\", \"How do I handle a set of asynchronous calls effectively?\", \"How can I make sure that my application will not collapse while it grows?\", or more simply \"What's the right way of doing this?\" Fortunately, Node.js has become a mature enough platform and most of these questions can now be easily answered with a design pattern, a proven coding technique, or a recommended practice. The aim of this book is to guide you through this emerging world of patterns, techniques, and practices, showing you what the proven solutions to the common problems are and teaching you how to use them as the starting point to building the solution to your particular problem."}]},{"block_type":"element","block":"k5zy5ab5","search_text":"By reading this book, you will learn the following:","text_count":51,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By reading this book, you will learn the following:"}]},{"block_type":"element","block":"k5zy5ab6","search_text":"The \"Node way\": How to use the right point of view when approaching a Node.js design problem. You will learn, for example, how different traditional design patterns look in Node.js, or how to design modules that do only one thing. A set of patterns to solve common Node.js design and coding problems: You will be presented with a \"Swiss army knife\" of patterns, ready-to-use in order to efficiently solve your everyday development and design problems. How to write modular and efficient Node.js applications: You will gain an understanding of the basic building blocks and principles of writing large and well-organized Node.js applications and you will be able to apply these principles to novel problems that don't fall within the scope of existing patterns. ","text_count":761,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The \"Node way\":"},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"How to use the right point of view when approaching a Node.js design problem. You will learn, for example, how different traditional design patterns look in Node.js, or how to design modules that do only one thing."}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A set of patterns to solve common Node.js design and coding problems:"},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You will be presented with a \"Swiss army knife\" of patterns, ready-to-use in order to efficiently solve your everyday development and design problems."}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"How to write modular and efficient Node.js applications:"},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You will gain an understanding of the basic building blocks and principles of writing large and well-organized Node.js applications and you will be able to apply these principles to novel problems that don't fall within the scope of existing patterns."}]}]}]},{"block_type":"element","block":"k5zy5ab7","search_text":"Throughout the book, you will be presented with several real-life libraries and technologies, such as LevelDb, Redis, RabbitMQ, ZMQ, Express, and many others. They will be used to demonstrate a pattern or technique, and besides making the example more useful, these will also give you great exposure to the Node.js ecosystem and its set of solutions.","text_count":350,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Throughout the book, you will be presented with several real-life libraries and technologies, such as LevelDb, Redis, RabbitMQ, ZMQ, Express, and many others. They will be used to demonstrate a pattern or technique, and besides making the example more useful, these will also give you great exposure to the Node.js ecosystem and its set of solutions."}]},{"block_type":"element","block":"k5zy5ab8","search_text":"Whether you use or plan to use Node.js for your work, your side project, or for an open source project, recognizing and using well-known patterns and techniques will allow you to use a common language when sharing your code and design, and on top of that, it will help you get a better understanding of the future of Node.js and how to make your own contributions a part of it.","text_count":377,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Whether you use or plan to use Node.js for your work, your side project, or for an open source project, recognizing and using well-known patterns and techniques will allow you to use a common language when sharing your code and design, and on top of that, it will help you get a better understanding of the future of Node.js and how to make your own contributions a part of it."}]},{"block_type":"element","block":"k5zy5ab9","search_text":"What this book covers","text_count":21,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"What this book covers"}]},{"block_type":"element","block":"k5zy5aba","search_text":"Chapter 1, Welcome to the Node.js Platform , serves as an introduction to the world of Node.js application design by showing the patterns at the core of the platform itself. It covers the Node.js ecosystem and its philosophy, a short introduction to Node.js version 6, ES2015, and the reactor pattern.","text_count":301,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 1,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Welcome to the Node.js Platform"}]},{"block_type":"text","content":", serves as an introduction to the world&nbsp;of Node.js application design by showing the patterns at the core of the platform itself. It covers the Node.js ecosystem and its philosophy, a short introduction to Node.js version 6, ES2015, and the reactor pattern."}]},{"block_type":"element","block":"k5zy5abb","search_text":"Chapter 2, Node.js Essential Patterns , introduces the first steps towards asynchronous coding and design patterns with Node.js discussing and comparing callbacks and the event emitter (observer pattern). This chapter also introduces the Node.js module system and the related module pattern.","text_count":291,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Essential Patterns"}]},{"block_type":"text","content":", introduces the first steps towards asynchronous coding and design patterns with Node.js discussing and comparing callbacks and the event emitter (observer pattern). This chapter also introduces the Node.js module system and the related module pattern."}]},{"block_type":"element","block":"k5zy5abc","search_text":"Chapter 3, Asynchronous Control Flow Patterns with Callbacks , introduces a set of patterns and techniques for efficiently handling asynchronous control flow in Node.js. This chapter teaches you how to mitigate the \"callback hell\" problem using plain JavaScript and the async library.","text_count":284,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 3,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with Callbacks"}]},{"block_type":"text","content":", introduces a set of patterns and techniques for efficiently handling asynchronous control flow in Node.js. This chapter teaches you how to mitigate the \"callback hell\" problem using plain JavaScript and the async library."}]},{"block_type":"element","block":"k5zy5abd","search_text":"Chapter 4, Asynchronous Control Flow Patterns with ES2015 and Beyond , progresses with the exploration of asynchronous control flows introducing Promises, Generators, and Async-Await.","text_count":183,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 4,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with ES2015 and Beyond"}]},{"block_type":"text","content":", progresses with the exploration of asynchronous control flows introducing Promises, Generators, and Async-Await."}]},{"block_type":"element","block":"k5zy5abe","search_text":"Chapter 5, Coding with Streams , dives deep into one of the most important patterns in Node.js: streams. It shows you how to process data with transform streams and how to combine them into different layouts.","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 5,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Coding with Streams"}]},{"block_type":"text","content":", dives deep into one of the most important patterns in Node.js: streams. It shows you how to process data with transform streams and how to combine them into different layouts."}]},{"block_type":"element","block":"k5zy5abf","search_text":"Chapter 6, Design Patterns , deals with a controversial topic: traditional design patterns in Node.js. It covers the most popular conventional design patterns and shows you how unconventional they might look in Node.js. It also introduces the reader to some emerging design patterns that are specific only to JavaScript and Node.js.","text_count":332,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 6,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Design Patterns"}]},{"block_type":"text","content":", deals with a controversial topic: traditional design patterns in Node.js. It covers the most popular conventional design patterns and shows you how unconventional they might look in Node.js. It also introduces the reader to some emerging design patterns that are specific only to JavaScript and Node.js."}]},{"block_type":"element","block":"k5zy5abg","search_text":"Chapter 7, Wiring Modules , analyzes the different solutions for linking the modules of an application together. In this chapter, you will learn design patterns such as Dependency Injection and service locator.","text_count":210,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 7,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Wiring Modules"}]},{"block_type":"text","content":", analyzes the different solutions for linking the modules of an application together. In this chapter, you will learn design patterns such as Dependency Injection and service locator."}]},{"block_type":"element","block":"k5zy5abh","search_text":"Chapter 8, Universal JavaScript for Web Applications , explores one of the most interesting capabilities of modern JavaScript web applications: being able to share application code between the frontend and the backend. Across this chapter we learn the basic principles of Universal JavaScript by building a simple web application with React, Webpack, and Babel.","text_count":361,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 8,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Universal JavaScript for Web Applications"}]},{"block_type":"text","content":", explores one of the most interesting capabilities of modern JavaScript web applications: being able to share application code between the frontend and the backend. Across this chapter we learn the basic principles of Universal JavaScript by building a simple web application with React, Webpack, and Babel."}]},{"block_type":"element","block":"k5zy5abi","search_text":"Chapter 9, Advanced Asynchronous Recipes , takes a problem-solution approach to show you how some common coding and design challenges can be solved with ready-to-use solutions.","text_count":176,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 9,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Advanced Asynchronous Recipes"}]},{"block_type":"text","content":", takes a problem-solution approach to show you how some common coding and design challenges can be solved with ready-to-use solutions."}]},{"block_type":"element","block":"k5zy5abj","search_text":"Chapter 10, Scalability and Architectural Patterns , teaches you the basic techniques and patterns for scaling a Node.js application.","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 10,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Scalability and Architectural Patterns"}]},{"block_type":"text","content":", teaches you the basic techniques and patterns for scaling a Node.js application."}]},{"block_type":"element","block":"k5zy5abk","search_text":"Chapter 11, Messaging and Integration Patterns , presents the most important messaging patterns, teaching you how to build and integrate complex distributed systems using ZMQ and AMQP.","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Chapter 11,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Messaging and Integration Patterns"}]},{"block_type":"text","content":", presents the most important messaging patterns, teaching you how to build and integrate complex distributed systems using ZMQ and AMQP."}]},{"block_type":"element","block":"k5zy5abl","search_text":"What you need for this book","text_count":27,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"What you need for this book"}]},{"block_type":"element","block":"k5zy5abm","search_text":"To experiment with the code, you will need a working installation of Node.js version 6 (or greater) and npm 3 (or greater). Some examples will require you to use a transpiler such as Babel. You will also need to be familiar with the command prompt, know how to install an npm package, and know how to run Node.js applications. You will also need a text editor to work with the code and a modern web browser.","text_count":407,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To experiment with the code, you will need a working installation of Node.js version 6 (or greater) and npm 3 (or greater). Some examples will require you to use a transpiler such as Babel. You will also need to be familiar with the command prompt, know how to install an npm package, and know how to run Node.js applications. You will also need a text editor to work with the code and a modern web browser."}]},{"block_type":"element","block":"k5zy5abn","search_text":"Who this book is for","text_count":20,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Who this book is for"}]},{"block_type":"element","block":"k5zy5abo","search_text":"This book is for developers who have already had initial contact with Node.js and now want to get the most out of it in terms of productivity, design quality, and scalability. You are only required to have some prior exposure to the technology through some basic examples, since this book will cover some basic concepts as well. Developers with intermediate experience in Node.js will also find the techniques presented in this book beneficial.","text_count":444,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This book is for developers who have already had initial contact with Node.js and now want to get the most out of it in terms of productivity, design quality, and scalability. You are only required to have some prior exposure to the technology through some basic examples, since this book will cover some basic concepts as well. Developers with intermediate experience in Node.js will also find the techniques presented in this book beneficial."}]},{"block_type":"element","block":"k5zy5abp","search_text":"Some background in software design theory is also an advantage to understand some of the concepts presented.","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Some background in software design theory is also an advantage to understand some of the concepts presented."}]},{"block_type":"element","block":"k5zy5abq","search_text":"This book assumes that you have a working knowledge of web application development, JavaScript, web services, databases, and data structures.","text_count":141,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This book assumes that you have a working knowledge of web application development, JavaScript, web services, databases, and data structures."}]},{"block_type":"element","block":"k5zy5abr","search_text":"Conventions","text_count":11,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Conventions"}]},{"block_type":"element","block":"k5zy5abs","search_text":"In this book, you will find a number of text styles that distinguish between different kinds of information. Here are some examples of these styles and an explanation of their meaning.","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this book, you will find a number of text styles that distinguish between different kinds of information. Here are some examples of these styles and an explanation of their meaning."}]},{"block_type":"element","block":"k5zy5abt","search_text":"Code words in text, database table names, folder names, filenames, file extensions, pathnames, dummy URLs, user input, and Twitter handles are shown as follows: \"ES2015 introduces the let keyword to declare variables that respect the block scope.\"","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Code words in text, database table names, folder names, filenames, file extensions, pathnames, dummy URLs, user input, and Twitter handles are shown as follows: \"ES2015 introduces the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"let"}]},{"block_type":"text","content":"keyword to declare variables that respect the block scope.\""}]},{"block_type":"element","block":"k5zy5abu","search_text":"A block of code is set as follows:","text_count":34,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A block of code is set as follows:"}]},{"block_type":"element","block":"k5zy5abv","search_text":"const zmq = require('zmq') const sink = zmq.socket('pull'); sink.bindSync(\"tcp://*:5001\"); sink.on('message', buffer => { console.log(`Message from worker: ${buffer.toString()}`); });","text_count":183,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const zmq = require('zmq')\nconst sink = zmq.socket('pull');\nsink.bindSync(\"tcp://*:5001\");\n\nsink.on('message', buffer =&gt; {\n  console.log(`Message from worker: ${buffer.toString()}`);\n});"}]}]},{"block_type":"element","block":"k5zy5abw","search_text":"When we wish to draw your attention to a particular part of a code block, the relevant lines or items are set in bold:","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When we wish to draw your attention to a particular part of a code block, the relevant lines or items are set in bold:"}]},{"block_type":"element","block":"k5zy5abx","search_text":"function produce() { //... variationsStream(alphabet, maxLength) .on('data', combination => { //... const msg = {searchHash: searchHash, variations: batch}; channel.sendToQueue('jobs_queue', new Buffer(JSON.stringify(msg))); //... }) //... }","text_count":241,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function produce() {\n   //...\n   variationsStream(alphabet, maxLength)\n     .on('data', combination =&gt; {\n       //...\n       const msg = {searchHash: searchHash, variations: batch};\n       channel.sendToQueue('jobs_queue', \nnew Buffer(JSON.stringify(msg)));\n       //...\n     })\n   //...\n }"}]}]},{"block_type":"element","block":"k5zy5aby","search_text":"Any command-line input or output is written as follows:","text_count":55,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Any command-line input or output is written as follows:"}]},{"block_type":"element","block":"k5zy5abz","search_text":"node replier node requestor ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node replier\nnode requestor"}]}]},{"block_type":"element","block":"k5zy5ac0","search_text":"New terms and important words are shown in bold. Words that you see on the screen, for example, in menus or dialog boxes, appear in the text like this: \"To explain the problem, we will create a little web spider , a command-line application that takes in a web URL as the input and downloads its contents locally into a file.\"","text_count":326,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"New terms"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"important words"}]},{"block_type":"text","content":"are shown in bold. Words that you see on the screen, for example, in menus or dialog boxes, appear in the text like this: \"To explain the problem, we will create a little"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"web spider"}]},{"block_type":"text","content":", a command-line application that takes in a web URL as the input and downloads its contents locally into a file.\""}]},{"block_type":"element","block":"k5zy5ac1","search_text":"Note Warnings or important notes appear in a box like this. ","text_count":60,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Warnings or important notes appear in a box like this."}]}]},{"block_type":"element","block":"k5zy5ac2","search_text":"Tip Tips and tricks appear like this. ","text_count":38,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Tips and tricks appear like this."}]}]},{"block_type":"element","block":"k5zy5ac3","search_text":"Reader feedback","text_count":15,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Reader feedback"}]},{"block_type":"element","block":"k5zy5ac4","search_text":"Feedback from our readers is always welcome. Let us know what you think about this book-what you liked or disliked. Reader feedback is important for us as it helps us develop titles that you will really get the most out of. To send us general feedback, simply e-mail feedback@packtpub.com, and mention the book's title in the subject of your message. If there is a topic that you have expertise in and you are interested in either writing or contributing to a book, see our author guide at www.packtpub.com/authors .","text_count":516,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Feedback from our readers is always welcome. Let us know what you think about this book-what you liked or disliked. Reader feedback is important for us as it helps us develop titles that you will really get the most out of. To send us general feedback, simply e-mail&nbsp;feedback@packtpub.com, and mention the book's title in the subject of your message. If there is a topic that you have expertise in and you are interested in either writing or contributing to a book, see our author guide at&nbsp;"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com/authors"},"children":[{"block_type":"text","content":"www.packtpub.com/authors"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5ac5","search_text":"Customer support","text_count":16,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Customer support"}]},{"block_type":"element","block":"k5zy5ac6","search_text":"Now that you are the proud owner of a Packt book, we have a number of things to help you to get the most from your purchase.","text_count":124,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that you are the proud owner of a Packt book, we have a number of things to help you to get the most from your purchase."}]},{"block_type":"element","block":"k5zy5ac7","search_text":"Downloading the example code","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Downloading the example code"}]},{"block_type":"element","block":"k5zy5ac8","search_text":"You can download the example code files for this book from your account at http://www.packtpub.com . If you purchased this book elsewhere, you can visit http://www.packtpub.com/support and register to have the files e-mailed directly to you.","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can download the example code files for this book from your account at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com"},"children":[{"block_type":"text","content":"http://www.packtpub.com"}]},{"block_type":"text","content":". If you purchased this book elsewhere, you can visit"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com/support"},"children":[{"block_type":"text","content":"http://www.packtpub.com/support"}]},{"block_type":"text","content":"and register to have the files e-mailed directly to you."}]},{"block_type":"element","block":"k5zy5ac9","search_text":"You can download the code files by following these steps:","text_count":57,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can download the code files by following these steps:"}]},{"block_type":"element","block":"k5zy5aca","search_text":"Log in or register to our website using your e-mail address and password. Hover the mouse pointer on the SUPPORT tab at the top. Click on Code Downloads & Errata . Enter the name of the book in the Search box. Select the book for which you're looking to download the code files. Choose from the drop-down menu where you purchased this book from. Click on Code Download . ","text_count":371,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Log in or register to our website using your e-mail address and password."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Hover the mouse pointer on the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"SUPPORT"}]},{"block_type":"text","content":"tab at the top."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Click on"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Code Downloads & Errata"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Enter the name of the book in the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Search"}]},{"block_type":"text","content":"box."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Select the book for which you're looking to download the code files."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Choose from the drop-down menu where you purchased this book from."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Click on"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Code Download"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5acb","search_text":"You can also download the code files by clicking on the Code Files button on the book's webpage at the Packt Publishing website. This page can be accessed by entering the book's name in the Search box. Please note that you need to be logged into your Packt account. Once the file is downloaded, please make sure that you unzip or extract the folder using the latest version of:","text_count":377,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can also download the code files by clicking on the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Code Files"}]},{"block_type":"text","content":"button on the book's webpage at the Packt Publishing website. This page can be accessed by entering the book's name in the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Search"}]},{"block_type":"text","content":"box. Please note that you need to be logged into your Packt account. Once the file is downloaded, please make sure that you unzip or extract the folder using the latest version of:"}]},{"block_type":"element","block":"k5zy5acc","search_text":"WinRAR / 7-Zip for Windows Zipeg / iZip / UnRarX for Mac 7-Zip / PeaZip for Linux ","text_count":82,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"WinRAR / 7-Zip for Windows"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Zipeg / iZip / UnRarX for Mac"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"7-Zip / PeaZip for Linux"}]}]},{"block_type":"element","block":"k5zy5acd","search_text":"The code bundle for the book is also hosted on GitHub at http://bit.ly/node_book_code . We also have other code bundles from our rich catalog of books and videos available at https://github.com/PacktPublishing/ . Check them out!","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code bundle for the book is also hosted on GitHub at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://bit.ly/node_book_code"},"children":[{"block_type":"text","content":"http://bit.ly/node_book_code"}]},{"block_type":"text","content":". We also have other code bundles from our rich catalog of books and videos available at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/PacktPublishing/"},"children":[{"block_type":"text","content":"https://github.com/PacktPublishing/"}]},{"block_type":"text","content":". Check them out!"}]},{"block_type":"element","block":"k5zy5ace","search_text":"Errata","text_count":6,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Errata"}]},{"block_type":"element","block":"k5zy5acf","search_text":"Although we have taken every care to ensure the accuracy of our content, mistakes do happen. If you find a mistake in one of our books-maybe a mistake in the text or the code-we would be grateful if you could report this to us. By doing so, you can save other readers from frustration and help us improve subsequent versions of this book. If you find any errata, please report them by visiting http://www.packtpub.com/submit-errata , selecting your book, clicking on the Errata Submission Form link, and entering the details of your errata. Once your errata are verified, your submission will be accepted and the errata will be uploaded to our website or added to any list of existing errata under the Errata section of that title.","text_count":731,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Although we have taken every care to ensure the accuracy of our content, mistakes do happen. If you find a mistake in one of our books-maybe a mistake in the text or the code-we would be grateful if you could report this to us. By doing so, you can save other readers from frustration and help us improve subsequent versions of this book. If you find any errata, please report them by visiting"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com/submit-errata"},"children":[{"block_type":"text","content":"http://www.packtpub.com/submit-errata"}]},{"block_type":"text","content":", selecting your book, clicking on the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Errata Submission Form"}]},{"block_type":"text","content":"link, and entering the details of your errata. Once your errata are verified, your submission will be accepted and the errata will be uploaded to our website or added to any list of existing errata under the Errata section of that title."}]},{"block_type":"element","block":"k5zy5acg","search_text":"To view the previously submitted errata, go to https://www.packtpub.com/books/content/support and enter the name of the book in the search field. The required information will appear under the Errata section.","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To view the previously submitted errata, go to"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.packtpub.com/books/content/support"},"children":[{"block_type":"text","content":"https://www.packtpub.com/books/content/support"}]},{"block_type":"text","content":"and enter the name of the book in the search field. The required information will appear under the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Errata"}]},{"block_type":"text","content":"section."}]},{"block_type":"element","block":"k5zy5ach","search_text":"Piracy","text_count":6,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Piracy"}]},{"block_type":"element","block":"k5zy5aci","search_text":"Piracy of copyrighted material on the Internet is an ongoing problem across all media. At Packt, we take the protection of our copyright and licenses very seriously. If you come across any illegal copies of our works in any form on the Internet, please provide us with the location address or website name immediately so that we can pursue a remedy.","text_count":349,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Piracy of copyrighted material on the Internet is an ongoing problem across all media. At Packt, we take the protection of our copyright and licenses very seriously. If you come across any illegal copies of our works in any form on the Internet, please provide us with the location address or website name immediately so that we can pursue a remedy."}]},{"block_type":"element","block":"k5zy5acj","search_text":"Please contact us at copyright@packtpub.com with a link to the suspected pirated material.","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Please contact us at&nbsp;copyright@packtpub.com&nbsp;with a link to the suspected pirated material."}]},{"block_type":"element","block":"k5zy5ack","search_text":"We appreciate your help in protecting our authors and our ability to bring you valuable content.","text_count":96,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We appreciate your help in protecting our authors and our ability to bring you valuable content."}]},{"block_type":"element","block":"k5zy5acl","search_text":"Questions","text_count":9,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Questions"}]},{"block_type":"element","block":"k5zy5acm","search_text":"If you have a problem with any aspect of this book, you can contact us at questions@packtpub.com, and we will do our best to address the problem.","text_count":145,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you have a problem with any aspect of this book, you can contact us at&nbsp;questions@packtpub.com, and we will do our best to address the problem."}]}]},{"title":"Welcome to the Node.js Platform","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4me1","number":1,"contents":[{"block_type":"element","block":"k5zy5acn","search_text":"Some principles and design patterns literally define developer experience with the Node.js platform and its ecosystem; the most peculiar ones are probably its asynchronous nature and its programming style that, in its simplest incarnation, make heavy use of callbacks. It's important that we first dive into these fundamental principles and patterns, not only for writing correct code, but also to be able to take effective design decisions when it comes to solving bigger and more complex problems.","text_count":499,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Some principles and design patterns literally define developer experience with the Node.js platform and its ecosystem; the most peculiar ones are probably its asynchronous nature and its programming style that, in its simplest incarnation, make heavy use of callbacks. It's important that we first dive into these fundamental principles and patterns, not only for writing correct code, but also to be able to take effective design decisions when it comes to solving bigger and more complex problems."}]},{"block_type":"element","block":"k5zy5aco","search_text":"Another aspect that characterizes Node.js is its philosophy. Approaching Node.js is in fact way more than simply learning a new technology; it's also embracing a culture and a community. We will see how this greatly influences the way we design our applications and components, and the way they interact with those created by the community.","text_count":340,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another aspect that characterizes Node.js is its philosophy. Approaching Node.js is in fact way more than simply learning a new technology; it's also embracing a culture and a community. We will see how this greatly influences the way we design our applications and components, and the way they interact with those created by the community."}]},{"block_type":"element","block":"k5zy5acp","search_text":"In addition to these aspects, it's worth knowing that the latest versions of Node.js introduced support for many of the features described by ES2015 (formerly ES6), which makes the language even more expressive and enjoyable to use. It is important to embrace these new syntactic and functional additions to the language in order to be able to produce more concise and readable code and come up with alternative ways to implement the design patterns that we are going to see throughout this book.","text_count":496,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In addition to these aspects, it's worth knowing that the latest versions of Node.js introduced support for many of the features described by ES2015 (formerly ES6), which makes the language even more expressive and enjoyable to use. It is important to embrace these new syntactic and functional additions to the language in order to be able to produce more concise and readable code and come up with alternative ways to implement the design patterns that we are going to see throughout this book."}]},{"block_type":"element","block":"k5zy5acq","search_text":"In this chapter, we will learn the following topics:","text_count":52,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will learn the following topics:"}]},{"block_type":"element","block":"k5zy5acr","search_text":"The Node.js philosophy, the \"Node way\" Node.js version 6 and ES2015 The reactor pattern—the mechanism at the heart of the Node.js asynchronous architecture ","text_count":156,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The Node.js philosophy, the \"Node way\""}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Node.js version 6 and ES2015"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The reactor pattern&mdash;the mechanism at the heart of the Node.js asynchronous architecture"}]}]},{"block_type":"element","block":"k5zy5acs","search_text":"The Node.js philosophy","text_count":22,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"The Node.js philosophy"}]},{"block_type":"element","block":"k5zy5act","search_text":"Every platform has its own philosophy—a set of principles and guidelines that are generally accepted by the community, an ideology of doing things that influences the evolution of a platform, and how applications are developed and designed. Some of these principles arise from the technology itself, some of them are enabled by its ecosystem, some are just trends in the community, and others are evolutions of different ideologies. In Node.js, some of these principles come directly from its creator, Ryan Dahl; from all the people who contributed to the core; from charismatic figures in the community; and some of the principles are inherited from the JavaScript culture or are influenced by the Unix philosophy.","text_count":715,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Every platform has its own philosophy&mdash;a set of principles and guidelines that are generally accepted by the community, an ideology of doing things that influences the evolution of a platform, and how applications are developed and designed. Some of these principles arise from the technology itself, some of them are enabled by its ecosystem, some are just trends in the community, and others are evolutions of different ideologies. In Node.js, some of these principles come directly from its creator, Ryan Dahl; from all the people who contributed to the core; from charismatic figures in the community; and some of the principles are inherited from the JavaScript culture or are influenced by the Unix philosophy."}]},{"block_type":"element","block":"k5zy5acu","search_text":"None of these rules are imposed and they should always be applied with common sense; however, they can prove to be tremendously useful when we are looking for a source of inspiration while designing our programs.","text_count":212,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"None of these rules are imposed and they should always be applied with common sense; however, they can prove to be tremendously useful when we are looking for a source of inspiration while designing our programs."}]},{"block_type":"element","block":"k5zy5acv","search_text":"Note You can find an extensive list of software development philosophies on Wikipedia at http://en.wikipedia.org/wiki/List_of_software_development_philosophies ","text_count":160,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can find an extensive list of software development philosophies on Wikipedia at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://en.wikipedia.org/wiki/List_of_software_development_philosophies"},"children":[{"block_type":"text","content":"http://en.wikipedia.org/wiki/List_of_software_development_philosophies"}]}]}]},{"block_type":"element","block":"k5zy5acw","search_text":"Small core","text_count":10,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Small core"}]},{"block_type":"element","block":"k5zy5acx","search_text":"The Node.js core itself has its foundations built on a few principles; one of these is having the smallest set of functionalities, leaving the rest to the so-called userland (or userspace ), the ecosystem of modules living outside the core. This principle has an enormous impact on the Node.js culture, as it gives freedom to the community to experiment and iterate quickly on a broader set of solutions within the scope of the userland modules, instead of being imposed with one slowly evolving solution that is built into the more tightly controlled and stable core. Keeping the core set of functionalities to the bare minimum, then, not only becomes convenient in terms of maintainability, but also in terms of the positive cultural impact that it brings on the evolution of the entire ecosystem.","text_count":799,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Node.js core itself has its foundations built on a few principles; one of these is having the smallest set of functionalities, leaving the rest to the so-called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"userland"}]},{"block_type":"text","content":"&nbsp;(or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"userspace"}]},{"block_type":"text","content":"), the ecosystem of modules living outside the core. This principle has an enormous impact on the Node.js culture, as it gives freedom to the community to experiment and iterate quickly on a broader set of solutions within the scope of the userland modules, instead of being imposed with one slowly evolving solution that is built into the more tightly controlled and stable core. Keeping the core set of functionalities to the bare minimum, then, not only becomes convenient in terms of maintainability, but also in terms of the positive cultural impact that it brings on the evolution of the entire ecosystem."}]},{"block_type":"element","block":"k5zy5acy","search_text":"Small modules","text_count":13,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Small modules"}]},{"block_type":"element","block":"k5zy5acz","search_text":"Node.js uses the concept of a module as a fundamental means to structure the code of a program. It is the building block for creating applications and reusable libraries called packages (a package is also frequently referred to as a module since, usually, it has one single module as an entry point). In Node.js, one of the most evangelized principles is to design small modules, not only in terms of code size, but most importantly in terms of scope.","text_count":451,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Node.js uses the concept of a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"module"}]},{"block_type":"text","content":"as a fundamental means to structure the code of a program. It is the building block for creating applications and reusable libraries called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"packages"}]},{"block_type":"text","content":"&nbsp;(a package is also frequently referred to as a module since, usually, it has one single module as an entry point). In Node.js, one of the most evangelized principles is to design small modules, not only in terms of code size, but most importantly in terms of scope."}]},{"block_type":"element","block":"k5zy5ad0","search_text":"This principle has its roots in the Unix philosophy, particularly in two of its precepts, which are as follows:","text_count":111,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This principle has its roots in the Unix philosophy, particularly in two of its precepts, which are as follows:"}]},{"block_type":"element","block":"k5zy5ad1","search_text":"\"Small is beautiful.\" \"Make each program do one thing well.\" ","text_count":61,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"\"Small is beautiful.\""}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"\"Make each program do one thing well.\""}]}]},{"block_type":"element","block":"k5zy5ad2","search_text":"Node.js brought these concepts to a whole new level. Along with the help of npm, the official package manager, Node.js helps solve the dependency hell problem by making sure that each installed package will have its own separate set of dependencies, thus enabling a program to depend on a lot of packages without incurring conflicts. The Node way, in fact, involves extreme levels of reusability, whereby applications are composed of a high number of small, well-focused dependencies. While this can be considered unpractical or even totally unfeasible in other platforms, in Node.js this practice is encouraged. As a consequence, it is not rare to find npm packages containing less than 100 lines of code or exposing only one single function.","text_count":743,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Node.js brought these concepts to a whole new level. Along with the help of npm, the official package manager, Node.js helps solve the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"dependency hell"}]},{"block_type":"text","content":"problem by making sure that each installed package will have its own separate set of dependencies, thus enabling a program to depend on a lot of packages without incurring conflicts. The Node way, in fact, involves extreme levels of reusability, whereby applications are composed of a high number of small, well-focused dependencies. While this can be considered unpractical or even totally unfeasible in other platforms, in Node.js this practice is encouraged. As a consequence, it is not rare to find npm packages containing less than 100 lines of code or exposing only one single function."}]},{"block_type":"element","block":"k5zy5ad3","search_text":"Besides the clear advantage in terms of reusability, a small module is also considered to be the following:","text_count":107,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Besides the clear advantage in terms of reusability, a small module is also considered to be the following:"}]},{"block_type":"element","block":"k5zy5ad4","search_text":"Easier to understand and use Simpler to test and maintain Perfect to share with the browser ","text_count":92,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Easier to understand and use"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Simpler to test and maintain"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Perfect to share with the browser"}]}]},{"block_type":"element","block":"k5zy5ad5","search_text":"Having smaller and more focused modules empowers everyone to share or reuse even the smallest piece of code; it's the Don't Repeat Yourself ( DRY ) principle applied to a whole new level.","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Having smaller and more focused modules empowers everyone to share or reuse even the smallest piece of code; it's the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Don't Repeat Yourself"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"DRY"}]},{"block_type":"text","content":") principle applied to a whole new level."}]},{"block_type":"element","block":"k5zy5ad6","search_text":"Small surface area","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Small surface area"}]},{"block_type":"element","block":"k5zy5ad7","search_text":"In addition to being small in size and scope, Node.js modules usually also have the characteristic of exposing a minimal set of functionalities. The main advantage here is increased usability of the API, which means that the API becomes clearer to use and is less exposed to erroneous usage. Most of the time, in fact, the user of a component is only interested in a very limited and focused set of features, without the need to extend its functionality or tap into more advanced aspects.","text_count":488,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In addition to being small in size and scope, Node.js modules usually also have the characteristic of exposing a minimal set of functionalities. The main advantage here is increased usability of the API, which means that the API becomes clearer to use and is less exposed to erroneous usage. Most of the time, in fact, the user of a component is only interested in a very limited and focused set of features, without the need to extend its functionality or tap into more advanced aspects."}]},{"block_type":"element","block":"k5zy5ad8","search_text":"In Node.js, a very common pattern for defining modules is to expose only one piece of functionality, such as a function or a constructor, while letting more advanced aspects or secondary features become properties of the exported function or constructor. This helps the user to identify what is important and what is secondary. It is not rare to find modules that expose only one function and nothing else, for the simple fact that it provides a single, unmistakably clear entry point.","text_count":485,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Node.js, a very common pattern for defining modules is to expose only one piece of functionality, such as a function or a constructor, while letting more advanced aspects or secondary features become properties of the exported function or constructor. This helps the user to identify what is important and what is secondary. It is not rare to find modules that expose only one function and nothing else, for the simple fact that it provides a single, unmistakably clear entry point."}]},{"block_type":"element","block":"k5zy5ad9","search_text":"Another characteristic of many Node.js modules is the fact that they are created to be used rather than extended. Locking down the internals of a module by forbidding any possibility of an extension might sound inflexible, but it actually has the advantage of reducing the use cases, simplifying its implementation, facilitating its maintenance, and increasing its usability.","text_count":375,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another characteristic of many Node.js modules is the fact that they are created to be used rather than extended. Locking down the internals of a module by forbidding any possibility of an extension might sound inflexible, but it actually has the advantage of reducing the use cases, simplifying its implementation, facilitating its maintenance, and increasing its usability."}]},{"block_type":"element","block":"k5zy5ada","search_text":"Simplicity and pragmatism","text_count":25,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Simplicity and pragmatism"}]},{"block_type":"element","block":"k5zy5adb","search_text":"Have you ever heard of the Keep It Simple, Stupid ( KISS ) principle or the famous quote:","text_count":89,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Have you ever heard of the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Keep It Simple, Stupid"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"KISS"}]},{"block_type":"text","content":") principle or the famous quote:"}]},{"block_type":"element","block":"k5zy5adc","search_text":"\"Simplicity is the ultimate sophistication.\" -- Leonardo da Vinci ","text_count":66,"tag_name":"blockquote","attributes":{},"children":[{"block_type":"element","tag_name":"table","attributes":{"border":"0","width":"100%","cellspacing":"0","cellpadding":"0","summary":"Block quote"},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"&nbsp;"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"\"Simplicity is the ultimate sophistication.\""}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"&nbsp;"}]},{"block_type":"element","tag_name":"td","attributes":{"colspan":"2"},"children":[{"block_type":"text","content":"--"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Leonardo da Vinci"}]}]}]}]}]}]},{"block_type":"element","block":"k5zy5add","search_text":"Richard P. Gabriel, a prominent computer scientist, coined the term \"worse is better\" to describe the model, whereby less and simpler functionality is a good design choice for software. In his essay, The Rise of \"Worse is Better\" , he says:","text_count":240,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Richard P. Gabriel, a prominent computer scientist, coined the term \"worse is better\" to describe the model, whereby less and simpler functionality is a good design choice for software. In his essay,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"The Rise of \"Worse is Better\""}]},{"block_type":"text","content":", he says:"}]},{"block_type":"element","block":"k5zy5ade","search_text":"\"The design must be simple, both in implementation and interface. It is more important for the implementation to be simple than the interface. Simplicity is the most important consideration in a design.\" ","text_count":204,"tag_name":"blockquote","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"\"The design must be simple, both in implementation and interface. It is more important for the implementation to be simple than the interface. Simplicity is the most important consideration in a design.\""}]}]}]},{"block_type":"element","block":"k5zy5adf","search_text":"Designing simple, as opposed to perfect, fully-featured software, is a good practice for several reasons: it takes less effort to implement, allows faster shipping with fewer resources, is easier to adapt, and is easier to maintain and understand. These factors foster community contributions and allow the software itself to grow and improve.","text_count":343,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Designing simple, as opposed to perfect, fully-featured&nbsp;software, is a good practice for several reasons: it takes less effort to implement, allows faster shipping with fewer resources, is easier to adapt, and is easier to maintain and understand. These factors foster community contributions and allow the software itself to grow and improve."}]},{"block_type":"element","block":"k5zy5adg","search_text":"In Node.js, this principle is also enabled by JavaScript, which is a very pragmatic language. It's not rare, in fact, to see simple functions, closures, and object literals replacing complex class hierarchies. Pure object-oriented designs often try to replicate the real world using the mathematical terms of a computer system without considering the imperfection and the complexity of the real world itself. The truth is that; our software is always an approximation of reality, and we would probably have more success in trying to get something working sooner and with reasonable complexity, instead of trying to create near-perfect software with huge effort and tons of code to maintain.","text_count":690,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Node.js, this principle is also enabled by JavaScript, which is a very pragmatic language. It's not rare, in fact, to see simple functions, closures, and object literals replacing complex class hierarchies. Pure object-oriented designs often try to replicate the real world using the mathematical terms of a computer system without considering the imperfection and the complexity of the real world itself. The truth is that; our software is always an approximation of reality, and we would probably have more success in trying to get something working sooner and with reasonable complexity, instead of trying to create near-perfect software with huge effort and tons of code to maintain."}]},{"block_type":"element","block":"k5zy5adh","search_text":"Throughout this book, we will see this principle in action many times. For example, a considerable number of traditional design patterns, such as singleton or decorator, can have a trivial, even if sometimes not foolproof, implementation and we will see how an uncomplicated, practical approach (most of the time) is preferred to a pure, flawless design.","text_count":354,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Throughout this book, we will see this principle in action many times. For example, a considerable number of traditional design patterns, such as singleton or decorator, can have a trivial, even if sometimes not foolproof, implementation and we will see how an uncomplicated, practical approach (most of the time) is preferred to a pure, flawless design."}]},{"block_type":"element","block":"k5zy5adi","search_text":"Introduction to Node.js 6 and ES2015","text_count":36,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Introduction to Node.js 6 and ES2015"}]},{"block_type":"element","block":"k5zy5adj","search_text":"At the time of writing, the latest major releases of Node.js (versions 4, 5, and 6) come with the great addition of increased language support for the new features introduced in the ECMAScript 2015 specification (in short, ES2015, and formerly known also as ES6), which aims to make the JavaScript language even more flexible and enjoyable.","text_count":340,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At the time of writing, the latest major releases of Node.js (versions 4, 5, and 6) come with the great addition of increased language&nbsp;support for the new features introduced in the ECMAScript 2015 specification (in short, ES2015, and formerly known also as ES6), which aims to make the JavaScript language even more flexible and enjoyable."}]},{"block_type":"element","block":"k5zy5adk","search_text":"Throughout this book, we will widely adopt some of these new features in the code examples. These concepts are still fresh within the Node.js community so it's worth having a quick look at the most important ES2015-specific features currently supported in Node.js. Our version of reference is Node.js version 6.","text_count":311,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Throughout this book, we will widely adopt some of these new features in the code examples. These concepts are still fresh within the Node.js community so it's worth having a quick look at the most important ES2015-specific features currently supported in Node.js. Our version of reference is Node.js version 6."}]},{"block_type":"element","block":"k5zy5adl","search_text":"Depending on your Node.js version, some of these features will work correctly only when strict mode is enabled. Strict mode can be easily enabled by adding a \"use strict\" statement at the very beginning of your script. Notice that the \"use strict\" statement is a plain string and that you can either use single or double quotes to declare it. For the sake of brevity, we will not write this line in our code examples, but you should remember to add it to be able to run them correctly.","text_count":485,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Depending on your Node.js version, some of these features will work correctly only when"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"strict mode"}]},{"block_type":"text","content":"is enabled. Strict mode can be easily enabled by adding a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"\"use strict\""}]},{"block_type":"text","content":"statement at the very beginning of your script. Notice that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"\"use strict\""}]},{"block_type":"text","content":"statement is a plain string and that you can either use single or double quotes to declare it. For the sake of brevity, we will not write this line in our code examples, but you should remember to add it to be able to run them correctly."}]},{"block_type":"element","block":"k5zy5adm","search_text":"The following list is not meant to be exhaustive but just an introduction to some of the ES2015 features supported in Node.js, so that you can easily understand all the code examples in the rest of the book.","text_count":207,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following list is not meant to be exhaustive but just an introduction to some of the ES2015 features supported in Node.js, so that you can easily understand all the code examples in the rest of the book."}]},{"block_type":"element","block":"k5zy5adn","search_text":"The let and const keywords","text_count":26,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The let and const keywords"}]},{"block_type":"element","block":"k5zy5ado","search_text":"Historically, JavaScript only offered function scope and global scope to control the lifetime and the visibility of a variable. For instance, if you declare a variable inside the body of an if statement, the variable will be accessible even outside the statement, whether or not the body of the statement has been executed. Let's see it more clearly with an example:","text_count":366,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Historically, JavaScript only offered function scope and global scope to control the lifetime and the visibility of a variable. For instance, if you declare a variable inside the body of an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if"}]},{"block_type":"text","content":"statement, the variable will be accessible even outside the statement, whether or not the body of the statement has been executed. Let's see it more clearly with an example:"}]},{"block_type":"element","block":"k5zy5adp","search_text":"if (false) { var x = \"hello\"; } console.log(x); ","text_count":48,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if (false) { \n   var x = \"hello\"; \n} \nconsole.log(x);"}]}]},{"block_type":"element","block":"k5zy5adq","search_text":"This code will not fail as we might expect and it will just print undefined in the console. This behavior has been the cause of many bugs and a lot of frustration, and that is the reason why ES2015 introduces the let keyword to declare variables that respect the block scope. Let's replace var with let in our previous example:","text_count":327,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This code will not fail as we might expect and it will just print"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"undefined"}]},{"block_type":"text","content":"in the console. This behavior has been the cause of many bugs and a lot of frustration, and that is the reason why ES2015 introduces the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"let"}]},{"block_type":"text","content":"keyword to declare variables that respect the block scope. Let's replace"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"var"}]},{"block_type":"text","content":"with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"let"}]},{"block_type":"text","content":"in our previous example:"}]},{"block_type":"element","block":"k5zy5adr","search_text":"if (false) { let x = \"hello\"; } console.log(x); ","text_count":48,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if (false) { \n   let x = \"hello\"; \n} \nconsole.log(x);"}]}]},{"block_type":"element","block":"k5zy5ads","search_text":"This code will raise a ReferenceError: x is not defined because we are trying to print a variable that has been defined inside another block.","text_count":141,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This code will raise a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ReferenceError: x is not defined"}]},{"block_type":"text","content":"because we are trying to print a variable that has been defined inside another block."}]},{"block_type":"element","block":"k5zy5adt","search_text":"To give a more meaningful example we can use the let keyword to define a temporary variable to be used as an index for a loop:","text_count":126,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To give a more meaningful example we can use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"let"}]},{"block_type":"text","content":"keyword to define a temporary variable to be used as an index for a loop:"}]},{"block_type":"element","block":"k5zy5adu","search_text":"for (let i=0; i < 10; i++) { // do something here } console.log(i); ","text_count":68,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"for (let i=0; i &lt; 10; i++) { \n  // do something here \n} \nconsole.log(i);"}]}]},{"block_type":"element","block":"k5zy5adv","search_text":"As in the previous example, this code will raise a ReferenceError: i is not defined error.","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As in the previous example, this code will raise a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ReferenceError: i is not defined"}]},{"block_type":"text","content":"error."}]},{"block_type":"element","block":"k5zy5adw","search_text":"This protective behavior introduced with let allows us to write safer code, because if we accidentally access variables that belong to another scope, we will get an error that will allow us to easily spot the bug and avoid potentially dangerous side effects.","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This protective behavior introduced with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"let"}]},{"block_type":"text","content":"allows us to write safer code, because if we accidentally access variables that belong to another scope, we will get an error that will allow us to easily spot the bug and avoid potentially dangerous side effects."}]},{"block_type":"element","block":"k5zy5adx","search_text":"ES2015 introduces also the const keyword. This keyword allows us to declare constant variables. Let's see a quick example:","text_count":122,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"ES2015 introduces also the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"const"}]},{"block_type":"text","content":"keyword. This keyword allows us to declare constant variables. Let's see a quick example:"}]},{"block_type":"element","block":"k5zy5ady","search_text":"const x = 'This will never change'; x = '...'; ","text_count":47,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const x = 'This will never change'; \nx = '...';"}]}]},{"block_type":"element","block":"k5zy5adz","search_text":"This code will raise a TypeError: Assignment to constant variable error because we are trying to change the value of a constant.","text_count":128,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This code will raise a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TypeError: Assignment to constant variable"}]},{"block_type":"text","content":"error because we are trying to change the value of a constant."}]},{"block_type":"element","block":"k5zy5ae0","search_text":"Anyway, it's important to underline that const does not behave in the same way as constant values in many other languages where this keyword allows us to define read-only variables. In fact, in ES2015, const does not indicate that the assigned value will be constant, but that the binding with the value is constant. To clarify this concept, we can see that with const in ES2015 it is still possible to do something like this:","text_count":426,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Anyway, it's important to underline that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"const"}]},{"block_type":"text","content":"does not behave in the same way as constant values in many other languages where this keyword allows us to define read-only variables. In fact, in ES2015,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"const"}]},{"block_type":"text","content":"does not indicate that the assigned value will be constant, but that the binding with the value is constant. To clarify this concept, we can see that with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"const"}]},{"block_type":"text","content":"in ES2015 it is still possible to do something like this:"}]},{"block_type":"element","block":"k5zy5ae1","search_text":"const x = {}; x.name = 'John'; ","text_count":31,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const x = {}; \nx.name = 'John';"}]}]},{"block_type":"element","block":"k5zy5ae2","search_text":"When we change a property inside the object we are actually altering the value (the object), but the binding between the variable and the object will not change, so this code will not raise an error. Conversely, if we reassign the full variable, this will change the binding between the variable and its value and raise an error:","text_count":329,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When we change a property inside the object we are actually altering the value (the object), but the binding between the variable and the object will not change, so this code will not raise an error. Conversely, if we reassign the full variable, this will change the binding between the variable and its value and raise an error:"}]},{"block_type":"element","block":"k5zy5ae3","search_text":"x = null; // This will fail ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"x = null; // This will fail"}]}]},{"block_type":"element","block":"k5zy5ae4","search_text":"Constants are extremely useful when you want to protect a scalar value from being accidentally changed in your code or, more generically, when you want to protect an assigned variable to be accidentally reassigned to another value somewhere else in your code.","text_count":259,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Constants are extremely useful when you want to protect a scalar value from being accidentally changed in your code or, more generically, when you want to protect an assigned variable to be accidentally reassigned to another value somewhere else in your code."}]},{"block_type":"element","block":"k5zy5ae5","search_text":"It is becoming best practice to use const when requiring a module in a script, so that the variable holding the module cannot be accidentally reassigned:","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is becoming best practice to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"const"}]},{"block_type":"text","content":"when requiring a module in a script, so that the variable holding the module cannot be accidentally reassigned:"}]},{"block_type":"element","block":"k5zy5ae6","search_text":"const path = require('path'); // .. do stuff with the path module let path = './some/path'; // this will fail ","text_count":110,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const path = require('path'); \n// .. do stuff with the path module \nlet path = './some/path'; // this will fail"}]}]},{"block_type":"element","block":"k5zy5ae7","search_text":"Note If you want to create an immutable object, const is not enough, so you should use ES5's method Object.freeze() ( https://developer.mozilla.org/it/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze ) or the deep-freeze module ( https://www.npmjs.com/package/deep-freeze ). ","text_count":285,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you want to create an immutable object,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"const"}]},{"block_type":"text","content":"is not enough, so you should use ES5's method"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Object.freeze()"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://developer.mozilla.org/it/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze"},"children":[{"block_type":"text","content":"https://developer.mozilla.org/it/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze"}]},{"block_type":"text","content":") or the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"deep-freeze"}]},{"block_type":"text","content":"module ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.npmjs.com/package/deep-freeze"},"children":[{"block_type":"text","content":"https://www.npmjs.com/package/deep-freeze"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5ae8","search_text":"The arrow function","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The arrow function"}]},{"block_type":"element","block":"k5zy5ae9","search_text":"One of the most appreciated features introduced by ES2015 is the support for arrow functions. The arrow function is a more concise syntax for defining functions, especially useful when defining a callback. To better understand the advantages of this syntax, let's first see an example of classic filtering on an array:","text_count":318,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the most appreciated features introduced by ES2015 is the support for arrow functions. The arrow function is a more concise syntax for defining functions, especially useful when defining a callback. To better understand the advantages of this syntax, let's first see an example of classic filtering on an array:"}]},{"block_type":"element","block":"k5zy5aea","search_text":"const numbers = [2, 6, 7, 8, 1]; const even = numbers.filter(function(x) { return x%2 === 0; }); ","text_count":97,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const numbers = [2, 6, 7, 8, 1]; \nconst even = numbers.filter(function(x) { \n  return x%2 === 0; \n});"}]}]},{"block_type":"element","block":"k5zy5aeb","search_text":"The preceding code can be rewritten as follows using the arrow function syntax:","text_count":79,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code can be rewritten as follows using the arrow function syntax:"}]},{"block_type":"element","block":"k5zy5aec","search_text":"const numbers = [2, 6, 7, 8, 1]; const even = numbers.filter(x => x%2 === 0); ","text_count":78,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const numbers = [2, 6, 7, 8, 1]; \nconst even = numbers.filter(x =&gt; x%2 === 0);"}]}]},{"block_type":"element","block":"k5zy5aed","search_text":"The filter function can be defined inline, and the keyword function is removed, leaving only the list of parameters, which is followed by => (the arrow), which in turn is followed by the body of the function. When the list of arguments contains more than one argument, you must surround them with parentheses and separate the argument with commas. Also, when there is no argument you must provide a set of empty parentheses before the arrow: () => {...} . When the body of the function is just one line, there's no need to write the return keyword as it is applied implicitly. If we need to add more lines of code to the body of the function, we can wrap them in curly brackets, but beware that in this case return is not automatically implied, so it needs to be stated explicitly, as in the following example:","text_count":810,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"filter"}]},{"block_type":"text","content":"function can be defined inline, and the keyword"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"function"}]},{"block_type":"text","content":"is removed, leaving only the list of parameters, which is followed by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"=&gt;"}]},{"block_type":"text","content":"(the arrow), which in turn is followed by the body of the function. When the list of arguments contains more than one argument, you must surround them with parentheses and separate the argument with commas. Also, when there is no argument you must provide a set of empty parentheses before the arrow:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"() =&gt; {...}"}]},{"block_type":"text","content":". When the body of the function is just one line, there's no need to write the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"return"}]},{"block_type":"text","content":"keyword as it is applied implicitly. If we need to add more lines of code to the body of the function, we can wrap them in curly brackets, but beware that in this case"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"return"}]},{"block_type":"text","content":"is not automatically implied, so it needs to be stated explicitly, as in the following example:"}]},{"block_type":"element","block":"k5zy5aee","search_text":"const numbers = [2, 6, 7, 8, 1]; const even = numbers.filter(x => { if (x%2 === 0) { console.log(x + ' is even!'); return true; } }); ","text_count":134,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const numbers = [2, 6, 7, 8, 1]; \nconst even = numbers.filter(x =&gt; { \n  if (x%2 === 0) { \n    console.log(x + ' is even!'); \n    return true; \n  } \n});"}]}]},{"block_type":"element","block":"k5zy5aef","search_text":"But there is another important feature to know about arrow functions: arrow functions are bound to their lexical scope. This means that inside an arrow function the value of this is the same as in the parent block. Let's clarify this concept with an example:","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But there is another important feature to know about arrow functions: arrow functions are bound to their lexical scope. This means that inside an arrow function the value of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this"}]},{"block_type":"text","content":"is the same as in the parent block. Let's clarify this concept with an example:"}]},{"block_type":"element","block":"k5zy5aeg","search_text":"function DelayedGreeter(name) { this.name = name; } DelayedGreeter.prototype.greet = function() { setTimeout( function cb() { console.log('Hello ' + this.name); }, 500); }; const greeter = new DelayedGreeter('World'); greeter.greet(); // will print \"Hello undefined\" ","text_count":267,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function DelayedGreeter(name) { \n  this.name = name; \n} \n \nDelayedGreeter.prototype.greet = function() { \n  setTimeout( function cb() { \n    console.log('Hello ' + this.name); \n  }, 500); \n}; \n \nconst greeter = new DelayedGreeter('World'); \ngreeter.greet(); // will print \"Hello undefined\""}]}]},{"block_type":"element","block":"k5zy5aeh","search_text":"In this code, we are defining a simple greeter prototype that accepts a name as an argument. Then we are adding the greet method to the prototype. This function is supposed to print Hello and the name defined in the current instance 500 milliseconds after it has been called. But this function is broken, because inside the timeout callback function (cb) , the scope of the function is different from the scope of greet method and the value of this is undefined Before Node.js introduced support for arrow functions, to fix this we needed to change the greet function using bind , as follows:","text_count":592,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this code, we are defining a simple"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"greeter"}]},{"block_type":"text","content":"prototype that accepts a name as an argument. Then we are adding the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"greet"}]},{"block_type":"text","content":"method to the prototype. This function is supposed to print"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Hello"}]},{"block_type":"text","content":"and the name defined in the current instance"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"500"}]},{"block_type":"text","content":"milliseconds after it has been called. But this function is broken, because inside the timeout callback function"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"(cb)"}]},{"block_type":"text","content":", the scope of the function is different from the scope of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"greet"}]},{"block_type":"text","content":"method and the value of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this"}]},{"block_type":"text","content":"is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"undefined"}]},{"block_type":"text","content":"Before Node.js introduced support for arrow functions, to fix this we needed to change the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"greet"}]},{"block_type":"text","content":"function using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"bind"}]},{"block_type":"text","content":", as follows:"}]},{"block_type":"element","block":"k5zy5aei","search_text":"DelayedGreeter.prototype.greet = function() { setTimeout( (function cb() { console.log('Hello' + this.name); }).bind(this), 500); }; ","text_count":133,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"DelayedGreeter.prototype.greet = function() { \n  setTimeout( (function cb() { \n    console.log('Hello' + this.name); \n  }).bind(this), 500); \n};"}]}]},{"block_type":"element","block":"k5zy5aej","search_text":"But since we have now arrow functions and since they are bound to their lexical scope, we can just use an arrow function as a callback to solve the issue:","text_count":154,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But since we have now arrow functions and since they are bound to their lexical scope, we can just use an arrow function as a callback to solve the issue:"}]},{"block_type":"element","block":"k5zy5aek","search_text":"DelayedGreeter.prototype.greet = function() { setTimeout( () => console.log('Hello' + this.name), 500); }; ","text_count":107,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"DelayedGreeter.prototype.greet = function() { \n  setTimeout( () =&gt; console.log('Hello' + this.name), 500); \n};"}]}]},{"block_type":"element","block":"k5zy5ael","search_text":"This is a very handy feature; most of the time it makes our code more concise and straightforward.","text_count":98,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is a very handy feature; most of the time it makes our code more concise and straightforward."}]},{"block_type":"element","block":"k5zy5aem","search_text":"Class syntax","text_count":12,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Class syntax"}]},{"block_type":"element","block":"k5zy5aen","search_text":"ES2015 introduces a new syntax to leverage prototypical inheritance in a way that should sound more familiar to all the developers that come from classic object-oriented languages such as Java or C#. It's important to underline that this new syntax does not change the way objects are managed internally by the JavaScript runtime; they still inherit properties and functions through prototypes and not through classes. While this new alternative syntax can be very handy and readable, as a developer, it is important to understand that it is just syntactic sugar.","text_count":563,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"ES2015 introduces a new syntax to leverage prototypical inheritance in a way that should sound more familiar to all the developers that come from classic object-oriented languages such as Java or C#. It's important to underline that this new syntax does not change the way objects are managed internally by the JavaScript runtime; they still inherit properties and functions through prototypes and not through classes. While this new alternative syntax can be very handy and readable, as a developer, it is important to understand that it is just syntactic sugar."}]},{"block_type":"element","block":"k5zy5aeo","search_text":"Let's see how it works with a trivial example. First of all, let's describe a Person function using the classic prototype-based approach:","text_count":137,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see how it works with a trivial example. First of all, let's describe a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Person"}]},{"block_type":"text","content":"function using the classic prototype-based approach:"}]},{"block_type":"element","block":"k5zy5aep","search_text":"function Person(name, surname, age) { this.name = name; this.surname = surname; this.age = age; } Person.prototype.getFullName = function() { return this.name + '' + this.surname; }; Person.older = function(person1, person2) { return (person1.age >= person2.age) ? person1 : person2; }; ","text_count":287,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function Person(name, surname, age) { \n  this.name = name; \n  this.surname = surname; \n  this.age = age; \n} \n \nPerson.prototype.getFullName = function() { \n  return this.name + '' + this.surname; \n}; \n \nPerson.older = function(person1, person2) { \n  return (person1.age &gt;= person2.age) ? person1 : person2; \n};"}]}]},{"block_type":"element","block":"k5zy5aeq","search_text":"As you can see, a person has name , surname , and age . We are providing our prototype with a helper function that allows us to easily get the full name of a person object and a generic helper function accessible directly from the Person prototype that returns the older person between two Person instances given as input. Let's see now how we can implement the same example using the new handy ES2015 class syntax:","text_count":415,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, a person has"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"name"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"surname"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"age"}]},{"block_type":"text","content":". We are providing our prototype with a helper function that allows us to easily get the full name of a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"person"}]},{"block_type":"text","content":"object and a generic helper function accessible directly from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Person"}]},{"block_type":"text","content":"prototype that returns the older person between two"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Person"}]},{"block_type":"text","content":"instances given as input. Let's see now how we can implement the same example using the new handy ES2015 class syntax:"}]},{"block_type":"element","block":"k5zy5aer","search_text":"class Person { constructor (name, surname, age) { this.name = name; this.surname = surname; this.age = age; } getFullName () { return this.name + ' ' + this.surname; } static older (person1, person2) { return (person1.age >= person2.age) ? person1 : person2; } } ","text_count":263,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class Person {\n  constructor (name, surname, age) {\n    this.name = name;\n    this.surname = surname;\n    this.age = age;\n  }\n\n  getFullName () {\n    return this.name + ' ' + this.surname;\n  }\n\n  static older (person1, person2) {\n    return (person1.age &gt;= person2.age) ? person1 : person2;\n  }\n}"}]}]},{"block_type":"element","block":"k5zy5aes","search_text":"This syntax is more readable and straightforward to understand. We are explicitly stating what the constructor is for the class and declaring the function older as a static method.","text_count":180,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This syntax is more readable and straightforward to understand. We are explicitly stating what the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"constructor"}]},{"block_type":"text","content":"is for the class and declaring the function"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"older"}]},{"block_type":"text","content":"as a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"static"}]},{"block_type":"text","content":"method."}]},{"block_type":"element","block":"k5zy5aet","search_text":"The two implementations are completely interchangeable, but the real killer feature of the new syntax is the possibility of extending the Person prototype using the extend and super keywords. Let's assume we want to create a PersonWithMiddlename class:","text_count":252,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The two implementations are completely interchangeable, but the real killer feature of the new syntax is the possibility of extending the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Person"}]},{"block_type":"text","content":"prototype using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"extend"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"super"}]},{"block_type":"text","content":"keywords. Let's assume we want to create a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PersonWithMiddlename"}]},{"block_type":"text","content":"class:"}]},{"block_type":"element","block":"k5zy5aeu","search_text":"class PersonWithMiddlename extends Person { constructor (name, middlename, surname, age) { super(name, surname, age); this.middlename = middlename; } getFullName () { return this.name + '' + this.middlename + '' + this.surname; } } ","text_count":232,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class PersonWithMiddlename extends Person { \n  constructor (name, middlename, surname, age) { \n    super(name, surname, age); \n    this.middlename = middlename; \n  } \n \n  getFullName () { \n    return this.name + '' + this.middlename + '' + this.surname; \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5aev","search_text":"What is worth noticing in this third example is that the syntax really resembles what is common in other object-oriented languages. We are declaring the class from which we want to extend, we define a new constructor that can call the parent one using the keyword super , and we override the getFullName method to add support for our middle name.","text_count":346,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What is worth noticing in this third example is that the syntax really resembles what is common in other object-oriented languages. We are declaring the class from which we want to extend, we define a new constructor that can call the parent one using the keyword"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"super"}]},{"block_type":"text","content":", and we override the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"getFullName"}]},{"block_type":"text","content":"method to add support for our middle name."}]},{"block_type":"element","block":"k5zy5aew","search_text":"Enhanced object literals","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Enhanced object literals"}]},{"block_type":"element","block":"k5zy5aex","search_text":"Along with the new class syntax, ES2015 introduced an enhanced object literals syntax. This syntax offers a shorthand to assign variables and functions as members of the object, allows us to define computed member names at creation time, and also handy setter and getter methods.","text_count":279,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Along with the new class syntax, ES2015 introduced an enhanced object literals syntax. This syntax offers a shorthand to assign variables and functions as members of the object, allows us to define computed member names at creation time, and also handy setter and getter methods."}]},{"block_type":"element","block":"k5zy5aey","search_text":"Let's make all of this clear with some examples:","text_count":48,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's make all of this clear with some examples:"}]},{"block_type":"element","block":"k5zy5aez","search_text":"const x = 22; const y = 17; const obj = { x, y }; ","text_count":50,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const x = 22; \nconst y = 17; \nconst obj = { x, y };"}]}]},{"block_type":"element","block":"k5zy5af0","search_text":"obj will be an object containing the keys x and y with the values 22 and 17 , respectively. We can do the same thing with functions:","text_count":132,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"obj"}]},{"block_type":"text","content":"will be an object containing the keys"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"with the values"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"22"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"17"}]},{"block_type":"text","content":", respectively. We can do the same thing with functions:"}]},{"block_type":"element","block":"k5zy5af1","search_text":"module.exports = { square (x) { return x * x; }, cube (x) { return x * x * x; } }; ","text_count":83,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = { \n  square (x) { \n    return x * x; \n  }, \n  cube (x) { \n    return x * x * x; \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5af2","search_text":"In this case, we are writing a module that exports the functions square and cube mapped to properties with the same name. Notice that we don't need to specify the keyword function .","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this case, we are writing a module that exports the functions"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"square"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cube"}]},{"block_type":"text","content":"mapped to properties with the same name. Notice that we don't need to specify the keyword"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"function"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5af3","search_text":"Let's see in another example how we can use computed property names:","text_count":68,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see in another example how we can use computed property names:"}]},{"block_type":"element","block":"k5zy5af4","search_text":"const namespace = '-webkit-'; const style = { [namespace + 'box-sizing'] : 'border-box', [namespace + 'box-shadow'] : '10px10px5px #888888' }; ","text_count":143,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const namespace = '-webkit-'; \nconst style = { \n  [namespace + 'box-sizing'] : 'border-box', \n  [namespace + 'box-shadow'] : '10px10px5px #888888' \n};"}]}]},{"block_type":"element","block":"k5zy5af5","search_text":"In this case, the resulting object will contain the properties -webkit-box-sizing and -webkit-box-shadow .","text_count":106,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this case, the resulting object will contain the properties"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"-webkit-box-sizing"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"-webkit-box-shadow"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5af6","search_text":"Let's see now how we can use the new setter and getter syntax by jumping directly to an example:","text_count":96,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see now how we can use the new setter and getter syntax by jumping directly to an example:"}]},{"block_type":"element","block":"k5zy5af7","search_text":"const person = { name : 'George', surname : 'Boole', get fullname () { return this.name + '' + this.surname; }, set fullname (fullname) { let parts = fullname.split(''); this.name = parts[0]; this.surname = parts[1]; } }; console.log(person.fullname); // \"George Boole\" console.log(person.fullname = 'Alan Turing'); // \"Alan Turing\" console.log(person.name); // \"Alan\" ","text_count":369,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const person = { \n  name : 'George', \n  surname : 'Boole', \n \n  get fullname () { \n    return this.name + '' + this.surname; \n  }, \n \n  set fullname (fullname) { \n    let parts = fullname.split(''); \n    this.name = parts[0]; \n    this.surname = parts[1]; \n  } \n}; \n \nconsole.log(person.fullname); // \"George Boole\" \nconsole.log(person.fullname = 'Alan Turing'); // \"Alan Turing\" \nconsole.log(person.name); // \"Alan\""}]}]},{"block_type":"element","block":"k5zy5af8","search_text":"In this example we are defining three properties, two normal ones, name and surname , and a computed fullname property through the set and get syntax. As you can see from the result of the console.log calls, we can access the computed property as if it was a regular property inside the object for both reading and writing the value. It's worth noticing that the second call to console.log prints Alan Turing . This happens because by default every set function returns the value that is returned by the get function for the same property, in this case get fullname .","text_count":567,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this example we are defining three properties, two normal ones,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"name"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"surname"}]},{"block_type":"text","content":", and a computed"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fullname"}]},{"block_type":"text","content":"property through the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"set"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get"}]},{"block_type":"text","content":"syntax. As you can see from the result of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"console.log"}]},{"block_type":"text","content":"calls, we can access the computed property as if it was a regular property inside the object for both reading and writing the value. It's worth noticing that the second call to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"console.log"}]},{"block_type":"text","content":"prints"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Alan Turing"}]},{"block_type":"text","content":". This happens because by default every"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"set"}]},{"block_type":"text","content":"function returns the value that is returned by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get"}]},{"block_type":"text","content":"function for the same property, in this case"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get fullname"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5af9","search_text":"Map and Set collections","text_count":23,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Map and Set collections"}]},{"block_type":"element","block":"k5zy5afa","search_text":"As JavaScript developers, we are used to creating hash maps using plain objects. ES2015 introduces a new prototype called Map that is specifically designed to leverage hash map collections in a more secure, flexible, and intuitive way. Let's see a quick example:","text_count":262,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As JavaScript developers, we are used to creating hash maps using plain objects. ES2015 introduces a new prototype called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Map"}]},{"block_type":"text","content":"that is specifically designed to leverage hash map collections in a more secure, flexible, and intuitive way. Let's see a quick example:"}]},{"block_type":"element","block":"k5zy5afb","search_text":"const profiles = new Map(); profiles.set('twitter', '@adalovelace'); profiles.set('facebook', 'adalovelace'); profiles.set('googleplus', 'ada'); profiles.size; // 3 profiles.has('twitter'); // true profiles.get('twitter'); // \"@adalovelace\" profiles.has('youtube'); // false profiles.delete('facebook'); profiles.has('facebook'); // false profiles.get('facebook'); // undefined for (const entry of profiles) { console.log(entry); } ","text_count":432,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const profiles = new Map(); \nprofiles.set('twitter', '@adalovelace'); \nprofiles.set('facebook', 'adalovelace'); \nprofiles.set('googleplus', 'ada'); \n \nprofiles.size; // 3 \nprofiles.has('twitter'); // true \nprofiles.get('twitter'); // \"@adalovelace\" \nprofiles.has('youtube'); // false \nprofiles.delete('facebook'); \nprofiles.has('facebook'); // false \nprofiles.get('facebook'); // undefined \nfor (const entry of profiles) { \n  console.log(entry); \n}"}]}]},{"block_type":"element","block":"k5zy5afc","search_text":"As you can see, the Map prototype offers several handy methods, such as set , get , has , and delete , and the size attribute (notice how the latter differs from arrays where we use the attribute length ). We can also iterate through all the entries using the for...of syntax. Every entry in the loop will be an array containing the key as first element and the value as second element. This interface is very intuitive and self-explanatory.","text_count":441,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Map"}]},{"block_type":"text","content":"prototype offers several handy methods, such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"set"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"has"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"delete"}]},{"block_type":"text","content":", and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"size"}]},{"block_type":"text","content":"attribute (notice how the latter differs from arrays where we use the attribute"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"length"}]},{"block_type":"text","content":"). We can also iterate through all the entries using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"for...of"}]},{"block_type":"text","content":"syntax. Every entry in the loop will be an array containing the key as first element and the value as second element. This interface is very intuitive and self-explanatory."}]},{"block_type":"element","block":"k5zy5afd","search_text":"But what makes maps really interesting is the possibility of using functions and objects as keys of the map, and this is something that is not entirely possible using plain objects, because with objects all the keys are automatically cast to strings. This opens new opportunities; for example, we can build a micro testing framework leveraging this feature:","text_count":357,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But what makes maps really interesting is the possibility of using functions and objects as keys of the map, and this is something that is not entirely possible using plain objects, because with objects all the keys are automatically cast to strings. This opens new opportunities; for example, we can build a micro testing framework leveraging this feature:"}]},{"block_type":"element","block":"k5zy5afe","search_text":"const tests = new Map(); tests.set(() => 2+2, 4); tests.set(() => 2*2, 4); tests.set(() => 2/2, 1); for (const entry of tests) { console.log((entry[0]() === entry[1]) ? 'PASS' : 'FAIL'); } ","text_count":189,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const tests = new Map(); \ntests.set(() =&gt; 2+2, 4); \ntests.set(() =&gt; 2*2, 4); \ntests.set(() =&gt; 2/2, 1); \n \nfor (const entry of tests) { \n  console.log((entry[0]() === entry[1]) ? 'PASS' : 'FAIL'); \n}"}]}]},{"block_type":"element","block":"k5zy5aff","search_text":"As you can see in this last example, we are storing functions as keys and expected results as values. Then we can iterate through our hash map and execute all the functions. It's also worth noticing that when we iterate through the map, all the entries respect the order in which they have been inserted; this is also something that was not always guaranteed with plain objects.","text_count":378,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see in this last example, we are storing functions as keys and expected results as values. Then we can iterate through our hash map and execute all the functions. It's also worth noticing that when we iterate through the map, all the entries respect the order in which they have been inserted; this is also something that was not always guaranteed with plain objects."}]},{"block_type":"element","block":"k5zy5afg","search_text":"Along with Map , ES2015 also introduces the Set prototype. This prototype allows us to easily construct sets, which means lists with unique values:","text_count":147,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Along with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Map"}]},{"block_type":"text","content":", ES2015 also introduces the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Set"}]},{"block_type":"text","content":"prototype. This prototype allows us to easily construct sets, which means lists with unique values:"}]},{"block_type":"element","block":"k5zy5afh","search_text":"const s = new Set([0, 1, 2, 3]); s.add(3); // will not be added s.size; // 4 s.delete(0); s.has(0); // false for (const entry of s) { console.log(entry); } ","text_count":156,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const s = new Set([0, 1, 2, 3]); \ns.add(3); // will not be added \ns.size; // 4 \ns.delete(0); \ns.has(0); // false \n \nfor (const entry of s) { \n  console.log(entry); \n}"}]}]},{"block_type":"element","block":"k5zy5afi","search_text":"As you can see, in this example the interface is quite similar to the one we have just seen for Map . We have the methods add (instead of set ), has , and delete and the property size . We can also iterate through the set and in this case every entry is a value, in our example it will be one of the numbers in the set. Finally, sets can also contain objects and functions as values.","text_count":383,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, in this example the interface is quite similar to the one we have just seen for"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Map"}]},{"block_type":"text","content":". We have the methods"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"add"}]},{"block_type":"text","content":"(instead of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"set"}]},{"block_type":"text","content":"),"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"has"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"delete"}]},{"block_type":"text","content":"and the property"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"size"}]},{"block_type":"text","content":". We can also iterate through the set and in this case every entry is a value, in our example it will be one of the numbers in the set. Finally, sets can also contain objects and functions as values."}]},{"block_type":"element","block":"k5zy5afj","search_text":"WeakMap and WeakSet collections","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"WeakMap and WeakSet collections"}]},{"block_type":"element","block":"k5zy5afk","search_text":"ES2015 also defines a \"weak\" version of the Map and the Set prototypes called WeakMap and WeakSet .","text_count":99,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"ES2015 also defines a \"weak\" version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Map"}]},{"block_type":"text","content":"and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Set"}]},{"block_type":"text","content":"prototypes called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakMap"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakSet"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5afl","search_text":"WeakMap is quite similar to Map in terms of interface; however, there are two main differences you should be aware of: there is no way to iterate all over the entries, and it only allows having objects as keys. While this might seem like a limitation, there is a good reason behind it. In fact, the distinctive feature of WeakMap is that it allows objects used as keys to be garbage collected when the only reference left is inside WeakMap . This is extremely useful when we are storing some metadata associated with an object that might get deleted during the regular lifetime of the application. Let's see an example:","text_count":619,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakMap"}]},{"block_type":"text","content":"is quite similar to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Map"}]},{"block_type":"text","content":"in terms of interface; however, there are two main differences you should be aware of: there is no way to iterate all over the entries, and it only allows having objects as keys. While this might seem like a limitation, there is a good reason behind it. In fact, the distinctive feature of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakMap"}]},{"block_type":"text","content":"is that it allows objects used as keys to be garbage collected when the only reference left is inside"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakMap"}]},{"block_type":"text","content":". This is extremely useful when we are storing some metadata associated with an object that might get deleted during the regular lifetime of the application. Let's see an example:"}]},{"block_type":"element","block":"k5zy5afm","search_text":"let obj = {}; const map = new WeakMap(); map.set(obj, {key: \"some_value\"}); console.log(map.get(obj)); // {key: \"some_value\"} obj = undefined; // now obj and the associated data in the map // will be cleaned up in the next gc cycle ","text_count":232,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"let obj = {}; \nconst map = new WeakMap(); \nmap.set(obj, {key: \"some_value\"}); \nconsole.log(map.get(obj)); // {key: \"some_value\"} \nobj = undefined; // now obj and the associated data in the map  \n                 // will be cleaned up in the next gc cycle"}]}]},{"block_type":"element","block":"k5zy5afn","search_text":"In this code, we are creating a plain object called obj . Then we store some metadata for this object in a new WeakMap called map . We can access this metadata with the map.get method. Later, when we cleanup the object by assigning its variable to undefined , the object will be correctly garbage collected and its metadata removed from the map.","text_count":345,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this code, we are creating a plain object called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"obj"}]},{"block_type":"text","content":". Then we store some metadata for this object in a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakMap"}]},{"block_type":"text","content":"called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":". We can access this metadata with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"map.get"}]},{"block_type":"text","content":"method. Later, when we cleanup the object by assigning its variable to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"undefined"}]},{"block_type":"text","content":", the object will be correctly garbage collected and its metadata removed from the map."}]},{"block_type":"element","block":"k5zy5afo","search_text":"Similar to WeakMap , WeakSet is the weak version of Set : it exposes the same interface of Set but it only allows storing objects and cannot be iterated. Again, the difference with Set is that WeakSet allows objects to be garbage collected when their only reference left is in the weak set:","text_count":290,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Similar to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakMap"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakSet"}]},{"block_type":"text","content":"is the weak version of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Set"}]},{"block_type":"text","content":": it exposes the same interface of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Set"}]},{"block_type":"text","content":"but it only allows storing objects and cannot be iterated. Again, the difference with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Set"}]},{"block_type":"text","content":"is that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakSet"}]},{"block_type":"text","content":"allows objects to be garbage collected when their only reference left is in the weak set:"}]},{"block_type":"element","block":"k5zy5afp","search_text":"let obj1= {key: \"val1\"}; let obj2= {key: \"val2\"}; const set= new WeakSet([obj1, obj2]); console.log(set.has(obj1)); // true obj1= undefined; // now obj1 will be removed from the set console.log(set.has(obj1)); // false ","text_count":219,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"let obj1= {key: \"val1\"}; \nlet obj2= {key: \"val2\"}; \nconst set= new WeakSet([obj1, obj2]); \nconsole.log(set.has(obj1)); // true \nobj1= undefined; // now obj1 will be removed from the set \nconsole.log(set.has(obj1)); // false"}]}]},{"block_type":"element","block":"k5zy5afq","search_text":"It's important to understand that WeakMap and WeakSet are not better or worse than Map and Set , they are simply more suitable for different use cases.","text_count":151,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to understand that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakMap"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WeakSet"}]},{"block_type":"text","content":"are not better or worse than"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Map"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Set"}]},{"block_type":"text","content":", they are simply more suitable for different use cases."}]},{"block_type":"element","block":"k5zy5afr","search_text":"Template literals","text_count":17,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Template literals"}]},{"block_type":"element","block":"k5zy5afs","search_text":"ES2015 offers a new alternative and more powerful syntax to define strings: the template literals. This syntax uses back ticks ( ` ) as delimiters and offers several benefits compared to regular quoted ( ' ) or double-quoted ( \" ) delimited strings. The main benefits are that template literal syntax can interpolate variables or expressions using ${expression} inside the string (this is the reason why this syntax is called \"template\") and that a single string can finally be easily written in multiple lines. Let's see a quick example:","text_count":538,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"ES2015 offers a new alternative and more powerful syntax to define strings: the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"template"}]},{"block_type":"text","content":"literals. This syntax uses back ticks ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"`"}]},{"block_type":"text","content":") as delimiters and offers several benefits compared to regular quoted ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"'"}]},{"block_type":"text","content":") or double-quoted ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"\""}]},{"block_type":"text","content":") delimited strings. The main benefits are that template literal syntax can interpolate variables or expressions using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"${expression}"}]},{"block_type":"text","content":"inside the string (this is the reason why this syntax is called \"template\") and that a single string can finally be easily written in multiple lines. Let's see a quick example:"}]},{"block_type":"element","block":"k5zy5aft","search_text":"const name = \"Leonardo\"; const interests = [\"arts\", \"architecture\", \"science\", \"music\", \"mathematics\"]; const birth = { year : 1452, place : 'Florence' }; const text = `${name} was an Italian polymath interested in many topics such as ${interests.join(', ')}.He was born in ${birth.year} in ${birth.place}.`; console.log(text); ","text_count":328,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const name = \"Leonardo\"; \nconst interests = [\"arts\", \"architecture\", \"science\", \"music\",  \n                   \"mathematics\"]; \nconst birth = { year : 1452, place : 'Florence' }; \nconst text = `${name} was an Italian polymath\n interested in many topics such as\n ${interests.join(', ')}.He was born\n in ${birth.year} in ${birth.place}.`; \nconsole.log(text);"}]}]},{"block_type":"element","block":"k5zy5afu","search_text":"This code will print the following:","text_count":35,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This code will print the following:"}]},{"block_type":"element","block":"k5zy5afv","search_text":"Leonardo was an Italian polymath interested in many topics such as arts, architecture, science, music, mathematics. He was born in 1452 in Florence. ","text_count":149,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Leonardo was an Italian polymath interested in many topics \n    such\nas arts, architecture, science, music, mathematics.\nHe was born in 1452 in Florence."}]}]},{"block_type":"element","block":"k5zy5afw","search_text":"Tip Downloading the example code Detailed steps to download the code bundle are mentioned in the Preface of this book. Have a look. The code bundle for the book is also hosted on GitHub at: http://bit.ly/node_book_code . We also have other code bundles from our rich catalog of books and videos available at: https://github.com/PacktPublishing/ . ","text_count":347,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Downloading the example code"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Detailed steps to download the code bundle are mentioned in the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Preface"}]},{"block_type":"text","content":"of this book. Have a look. The code bundle for the book is also hosted on GitHub at:"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"http://bit.ly/node_book_code"},"children":[{"block_type":"text","content":"http://bit.ly/node_book_code"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We also have other code bundles from our rich catalog of books and videos available at:"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/PacktPublishing/"},"children":[{"block_type":"text","content":"https://github.com/PacktPublishing/"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5afx","search_text":"Other ES2015 features","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Other ES2015 features"}]},{"block_type":"element","block":"k5zy5afy","search_text":"Another extremely interesting feature added in ES2015 and available since Node.js version 4 is Promise . We will discuss Promise in detail in Chapter 4, Asynchronous Control Flow Patterns with ES2015 and Beyond .","text_count":212,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another extremely interesting feature added in ES2015 and available since Node.js version 4 is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":". We will discuss Promise in detail in Chapter 4,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with ES2015 and Beyond"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5afz","search_text":"Other interesting ES2015 features introduced in Node.js version 6 are as follows:","text_count":81,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Other interesting ES2015 features introduced in Node.js version 6 are as follows:"}]},{"block_type":"element","block":"k5zy5ag0","search_text":"Default function parameters Rest parameters Spread operator Destructuring new.target (we will talk about this in Chapter 2, Node.js Essential Patterns ) Proxy (we will talk about this in Chapter 6, Design Patterns ) Reflect Symbols ","text_count":232,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Default function parameters"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Rest parameters"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Spread operator"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Destructuring"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new.target"}]},{"block_type":"text","content":"&nbsp;(we will talk about this in Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Essential Patterns"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Proxy (we will talk about this in Chapter 6,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Design Patterns"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Reflect"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Symbols"}]}]},{"block_type":"element","block":"k5zy5ag1","search_text":"Note A more extended and up-to-date list of all the supported ES2015 features is available in the official Node.js documentation: https://nodejs.org/en/docs/es6/ . ","text_count":164,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A more extended and up-to-date list of all the supported ES2015 features is available in the official Node.js documentation:"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"https://nodejs.org/en/docs/es6/"},"children":[{"block_type":"text","content":"https://nodejs.org/en/docs/es6/"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5ag2","search_text":"The reactor pattern","text_count":19,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"The reactor pattern"}]},{"block_type":"element","block":"k5zy5ag3","search_text":"In this section, we will analyze the reactor pattern, which is the heart of the asynchronous nature of Node.js. We will go through the main concepts behind the pattern, such as the single-threaded architecture and the non-blocking I/O, and we will see how this creates the foundation for the entire Node.js platform.","text_count":316,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will analyze the reactor pattern, which is the heart of the asynchronous nature of Node.js. We will go through the main concepts behind the pattern, such as the single-threaded architecture and the non-blocking I/O, and we will see how this creates the foundation for the entire Node.js platform."}]},{"block_type":"element","block":"k5zy5ag4","search_text":"I/O is slow","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"I/O is slow"}]},{"block_type":"element","block":"k5zy5ag5","search_text":"I/O is definitely the slowest among the fundamental operations of a computer. Accessing the RAM is in the order of nanoseconds (10E-9 seconds), while accessing data on the disk or the network is in the order of milliseconds (10E-3 seconds). For the bandwidth, it is the same story; RAM has a transfer rate consistently in the order of GB/s, while disk and network varies from MB/s to, optimistically, GB/s. I/O is usually not expensive in terms of CPU, but it adds a delay between the moment the request is sent and the moment the operation completes. On top of that, we also have to consider the human factor; often, the input of an application comes from a real person, for example, the click of a button or a message sent in a real-time chat application, so the speed and frequency of I/O doesn't only depend on technical aspects and it can be many orders of magnitude slower than the disk or network.","text_count":904,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"I/O is definitely the slowest among the fundamental operations of a computer. Accessing the RAM is in the order of nanoseconds (10E-9 seconds), while accessing data on the disk or the network is in the order of milliseconds (10E-3 seconds). For the bandwidth, it is the same story; RAM has a transfer rate consistently in the order of GB/s, while disk and network varies from MB/s to, optimistically, GB/s. I/O is usually not expensive in terms of CPU, but it adds a delay between the moment the request is sent and the moment the operation completes. On top of that, we also have to consider the human factor; often, the input of an application comes from a real person, for example, the click of a button or a message sent in a real-time chat application, so the speed and frequency of I/O doesn't only depend on technical aspects and it can be many orders of magnitude slower than the disk or network."}]},{"block_type":"element","block":"k5zy5ag6","search_text":"Blocking I/O","text_count":12,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Blocking I/O"}]},{"block_type":"element","block":"k5zy5ag7","search_text":"In traditional blocking I/O programming, the function call corresponding to an I/O request will block the execution of the thread until the operation completes. This can go from a few milliseconds, in the case of disk access, to minutes or even more, in case the data is generated from user actions, such as pressing a key. The following pseudocode shows a typical blocking thread performed against a socket:","text_count":408,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In traditional blocking I/O programming, the function call corresponding to an I/O request will block the execution of the thread until the operation completes. This can go from a few milliseconds, in the case of disk access, to minutes or even more, in case the data is generated from user actions, such as pressing a key. The following pseudocode shows a typical blocking thread performed against a socket:"}]},{"block_type":"element","block":"k5zy5ag8","search_text":"//blocks the thread until the data is available data = socket.read(); //data is available print(data); ","text_count":103,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//blocks the thread until the data is available \ndata = socket.read(); \n//data is available \nprint(data);"}]}]},{"block_type":"element","block":"k5zy5ag9","search_text":"It is trivial to notice that a web server that is implemented using blocking I/O will not be able to handle multiple connections in the same thread; each I/O operation on a socket will block the processing of any other connection. For this reason, the traditional approach to handling concurrency in web servers is to kick off a thread or a process (or to reuse one taken from a pool) for each concurrent connection that needs to be handled. This way, when a thread gets blocked for an I/O operation it will not impact the availability of the other requests, because they are handled in separate threads.","text_count":604,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is trivial to notice that a web server that is implemented using blocking I/O will not be able to handle multiple connections in the same thread; each I/O operation on a socket will block the processing of any other connection. For this reason, the traditional approach to handling concurrency in web servers is to kick off a thread or a process (or to reuse one taken from a pool) for each concurrent connection that needs to be handled. This way, when a thread gets blocked for an I/O operation it will not impact the availability of the other requests, because they are handled in separate threads."}]},{"block_type":"element","block":"k5zy5aga","search_text":"The following image illustrates this scenario:","text_count":46,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following image illustrates this scenario:"}]},{"block_type":"element","block":"k5zy5agb","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000051.jpg","alt":"Blocking I/O","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5agc","search_text":"The preceding image lays emphasis on the amount of time each thread is idle, waiting for new data to be received from the associated connection. Now, if we also consider that any type of I/O can possibly block a request, for example, while interacting with databases or with the filesystem, we soon realize how many times a thread has to block in order to wait for the result of an I/O operation. Unfortunately, a thread is not cheap in terms of system resources; it consumes memory and causes context switches, so having a long-running thread for each connection and not using it for most of the time is not the best compromise in terms of efficiency.","text_count":652,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding image lays emphasis on the amount of time each thread is idle, waiting for new data to be received from the associated connection. Now, if we also consider that any type of I/O can possibly block a request, for example, while interacting with databases or with the filesystem, we soon realize how many times a thread has to block in order to wait for the result of an I/O operation. Unfortunately, a thread is not cheap in terms of system resources; it consumes memory and causes context switches, so having a long-running thread for each connection and not using it for most of the time is not the best compromise in terms of efficiency."}]},{"block_type":"element","block":"k5zy5agd","search_text":"Non-blocking I/O","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Non-blocking I/O"}]},{"block_type":"element","block":"k5zy5age","search_text":"In addition to blocking I/O, most modern operating systems support another mechanism to access resources called non-blocking I/O. In this operating mode, the system call always returns immediately without waiting for the data to be read or written. If no results are available at the moment of the call, the function will simply return a predefined constant, indicating that there is no data available to return at that moment.","text_count":427,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In addition to blocking I/O, most modern operating systems support another mechanism to access resources called non-blocking I/O. In this operating mode, the system call always returns immediately without waiting for the data to be read or written. If no results are available at the moment of the call, the function will simply return a predefined constant, indicating that there is no data available to return at that moment."}]},{"block_type":"element","block":"k5zy5agf","search_text":"For example, in Unix operating systems, the fcntl() function is used to manipulate an existing file descriptor to change its operating mode to non-blocking (with the O_NONBLOCK flag). Once the resource is in non-blocking mode, any read operation will fail with the return code EAGAIN , in case the resource doesn't have any data ready to be read.","text_count":346,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For example, in Unix operating systems, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fcntl()"}]},{"block_type":"text","content":"function is used to manipulate an existing file descriptor to change its operating mode to non-blocking (with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"O_NONBLOCK"}]},{"block_type":"text","content":"flag). Once the resource is in non-blocking mode, any read operation will fail with the return code"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EAGAIN"}]},{"block_type":"text","content":", in case the resource doesn't have any data ready to be read."}]},{"block_type":"element","block":"k5zy5agg","search_text":"The most basic pattern for accessing this kind of non-blocking I/O is to actively poll the resource within a loop until some actual data is returned; this is called busy-waiting . The following pseudocode shows you how it's possible to read from multiple resources using non-blocking I/O and a polling loop:","text_count":307,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most basic pattern for accessing this kind of non-blocking I/O is to actively poll the resource within a loop until some actual data is returned; this is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"busy-waiting"}]},{"block_type":"text","content":". The following pseudocode shows you how it's possible to read from multiple resources using non-blocking I/O and a polling loop:"}]},{"block_type":"element","block":"k5zy5agh","search_text":"resources = [socketA, socketB, pipeA]; while(!resources.isEmpty()) { for(i = 0; i < resources.length; i++) { resource = resources[i]; //try to read let data = resource.read(); if(data === NO_DATA_AVAILABLE) //there is no data to read at the moment continue; if(data === RESOURCE_CLOSED) //the resource was closed, remove it from the list resources.remove(i); else //some data was received, process it consumeData(data); } } ","text_count":424,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"resources = [socketA, socketB, pipeA]; \nwhile(!resources.isEmpty()) { \n  for(i = 0; i &lt; resources.length; i++) { \n    resource = resources[i]; \n    //try to read \n    let data = resource.read(); \n    if(data === NO_DATA_AVAILABLE) \n      //there is no data to read at the moment \n      continue; \n    if(data === RESOURCE_CLOSED) \n      //the resource was closed, remove it from the list \n      resources.remove(i); \n    else \n      //some data was received, process it \n      consumeData(data); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5agi","search_text":"You can see that, with this simple technique, it is already possible to handle different resources in the same thread, but it's still not efficient. In fact, in the preceding example, the loop will only consume precious CPU for iterating over resources that are unavailable most of the time. Polling algorithms usually result in a huge amount of wasted CPU time.","text_count":362,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can see that, with this simple technique, it is already possible to handle different resources in the same thread, but it's still not efficient. In fact, in the preceding example, the loop will only consume precious CPU for iterating over resources that are unavailable most of the time. Polling algorithms usually result in a huge amount of wasted CPU time."}]},{"block_type":"element","block":"k5zy5agj","search_text":"Event demultiplexing","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Event demultiplexing"}]},{"block_type":"element","block":"k5zy5agk","search_text":"Busy-waiting is definitely not an ideal technique for processing non-blocking resources, but luckily, most modern operating systems provide a native mechanism to handle concurrent, non-blocking resources in an efficient way; this mechanism is called synchronous event demultiplexer or event notification interface . This component collects and queues I/O events that come from a set of watched resources, and block until new events are available to process. The following is the pseudocode of an algorithm that uses a generic synchronous event demultiplexer to read from two different resources:","text_count":595,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Busy-waiting is definitely not an ideal technique for processing non-blocking resources, but luckily, most modern operating systems provide a native mechanism to handle concurrent, non-blocking resources in an efficient way; this mechanism is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"synchronous event demultiplexer"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"event notification interface"}]},{"block_type":"text","content":". This component collects and queues I/O events that come from a set of watched resources, and block until new events are available to process. The following is the pseudocode of an algorithm that uses a generic synchronous event demultiplexer to read from two different resources:"}]},{"block_type":"element","block":"k5zy5agl","search_text":"socketA, pipeB; watchedList.add(socketA, FOR_READ); //[1] watchedList.add(pipeB, FOR_READ); while(events = demultiplexer.watch(watchedList)) { //[2] //event loop foreach(event in events) { //[3] //This read will never block and will always return data data = event.resource.read(); if(data === RESOURCE_CLOSED) //the resource was closed, remove it from the watched list demultiplexer.unwatch(event.resource); else //some actual data was received, process it consumeData(data); } } ","text_count":481,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"socketA, pipeB; \nwatchedList.add(socketA, FOR_READ);                     //[1] \nwatchedList.add(pipeB, FOR_READ); \nwhile(events = demultiplexer.watch(watchedList)) {      //[2] \n  //event loop \n  foreach(event in events) {                            //[3] \n    //This read will never block and will always return data \n    data = event.resource.read(); \n    if(data === RESOURCE_CLOSED) \n      //the resource was closed, remove it from the watched list \n      demultiplexer.unwatch(event.resource); \n    else \n      //some actual data was received, process it \n      consumeData(data); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5agm","search_text":"These are the important steps of the preceding pseudocode:","text_count":58,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"These are the important steps of the preceding pseudocode:"}]},{"block_type":"element","block":"k5zy5agn","search_text":"The resources are added to a data structure, associating each one of them with a specific operation, in our example, read . The event notifier is set up with the group of resources to be watched. This call is synchronous and blocks until any of the watched resources are ready for read . When this occurs, the event demultiplexer returns from the call and a new set of events is available to be processed. Each event returned by the event demultiplexer is processed. At this point, the resource associated with each event is guaranteed to be ready to read and to not block during the operation. When all the events are processed, the flow will block again on the event demultiplexer until new events are again available to be processed. This is called the event loop . ","text_count":769,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The resources are added to a data structure, associating each one of them with a specific operation, in our example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The event notifier is set up with the group of resources to be watched. This call is synchronous and blocks until any of the watched resources are ready for"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read"}]},{"block_type":"text","content":". When this occurs, the event demultiplexer returns from the call and a new set of events is available to be processed."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Each event returned by the event demultiplexer is processed. At this point, the resource associated with each event is guaranteed to be ready to read and to not block during the operation. When all the events are processed, the flow will block again on the event demultiplexer until new events are again available to be processed. This is called the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"event loop"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5ago","search_text":"It's interesting to see that with this pattern, we can now handle several I/O operations inside a single thread, without using a busy-waiting technique. The following image shows us how a web server would be able to handle multiple connections using a synchronous event demultiplexer and a single thread:","text_count":304,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's interesting to see that with this pattern, we can now handle several I/O operations inside a single thread, without using a busy-waiting technique. The following image shows us how a web server would be able to handle multiple connections using a synchronous event demultiplexer and a single thread:"}]},{"block_type":"element","block":"k5zy5agp","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000054.jpg","alt":"Event demultiplexing","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5agq","search_text":"The previous image helps us understand how concurrency works in a single-threaded application using a synchronous event demultiplexer and non-blocking I/O. We can see that using only one thread does not impair our ability to run multiple I/O bound tasks concurrently. The tasks are spread over time, instead of being spread across multiple threads. This has the clear advantage of minimizing the total idle time of the thread, as clearly shown in the image. This is not the only reason for choosing this model. To have only a single thread, in fact, also has a beneficial impact on the way programmers approach concurrency in general. Throughout the book, we will see how the absence of in-process race conditions and multiple threads to synchronize allows us to use much simpler concurrency strategies.","text_count":803,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The previous image helps us understand how concurrency works in a single-threaded application using a synchronous event demultiplexer and non-blocking I/O. We can see that using only one thread does not impair our ability to run multiple I/O bound tasks concurrently. The tasks are spread over time, instead of being spread across multiple threads. This has the clear advantage of minimizing the total idle time of the thread, as clearly shown in the image. This is not the only reason for choosing this model. To have only a single thread, in fact, also has a beneficial impact on the way programmers approach concurrency in general. Throughout the book, we will see how the absence of in-process race conditions and multiple threads to synchronize allows us to use much simpler concurrency strategies."}]},{"block_type":"element","block":"k5zy5agr","search_text":"In the next chapter, we will have the opportunity to talk more about the concurrency model of Node.js.","text_count":102,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter, we will have the opportunity to talk more about the concurrency model of Node.js."}]},{"block_type":"element","block":"k5zy5ags","search_text":"Introducing the reactor pattern","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Introducing the reactor pattern"}]},{"block_type":"element","block":"k5zy5agt","search_text":"We can now introduce the reactor pattern, which is a specialization of the algorithms presented in the previous section. The main idea behind it is to have a handler (which in Node.js is represented by a callback function) associated with each I/O operation, which will be invoked as soon as an event is produced and processed by the event loop. The structure of the reactor pattern is shown in the following image:","text_count":415,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now introduce the reactor pattern, which is a specialization of the algorithms presented in the previous section. The main idea behind it is to have a handler (which in Node.js is represented by a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function) associated with each I/O operation, which will be invoked as soon as an event is produced and processed by the event loop. The structure of the reactor pattern is shown in the following image:"}]},{"block_type":"element","block":"k5zy5agu","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000031.jpg","alt":"Introducing the reactor pattern","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5agv","search_text":"This is what happens in an application using the reactor pattern:","text_count":65,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is what happens in an application using the reactor pattern:"}]},{"block_type":"element","block":"k5zy5agw","search_text":"The application generates a new I/O operation by submitting a request to the Event Demultiplexer . The application also specifies a handler, which will be invoked when the operation completes. Submitting a new request to the Event Demultiplexer is a non-blocking call and it immediately returns control to the application. When a set of I/O operations completes, the Event Demultiplexer pushes the new events into the Event Queue . At this point, the Event Loop iterates over the items of the Event Queue . For each event, the associated handler is invoked. The handler, which is part of the application code, will give back control to the Event Loop when its execution completes ( 5a ). However, new asynchronous operations might be requested during the execution of the handler ( 5b ), causing new operations to be inserted in the Event Demultiplexer ( 1 ), before control is given back to the Event Loop . When all the items in the Event Queue are processed, the loop will block again on the Event Demultiplexer which will then trigger another cycle when a new event is available. ","text_count":1084,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The application generates a new I/O operation by submitting a request to the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Demultiplexer"}]},{"block_type":"text","content":". The application also specifies a handler, which will be invoked when the operation completes. Submitting a new request to the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Demultiplexer"}]},{"block_type":"text","content":"is a non-blocking call and it immediately returns control to the application."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When a set of I/O operations completes, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Demultiplexer"}]},{"block_type":"text","content":"pushes the new events into the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Queue"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At this point, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Loop"}]},{"block_type":"text","content":"iterates over the items of the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Queue"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"For each event, the associated handler is invoked."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The handler, which is part of the application code, will give back control to the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Loop"}]},{"block_type":"text","content":"when its execution completes ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"5a"}]},{"block_type":"text","content":"). However, new asynchronous operations might be requested during the execution of the handler ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"5b"}]},{"block_type":"text","content":"), causing new operations to be inserted in the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Demultiplexer"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"1"}]},{"block_type":"text","content":"), before control is given back to the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Loop"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When all the items in the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Queue"}]},{"block_type":"text","content":"are processed, the loop will block again on the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Demultiplexer"}]},{"block_type":"text","content":"which will then trigger another cycle when a new event is available."}]}]},{"block_type":"element","block":"k5zy5agx","search_text":"The asynchronous behavior is now clear: the application expresses the interest to access a resource at one point in time (without blocking) and provides a handler, which will then be invoked at another point in time when the operation completes.","text_count":245,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The asynchronous behavior is now clear: the application expresses the interest to access a resource at one point in time (without blocking) and provides a handler, which will then be invoked at another point in time when the operation completes."}]},{"block_type":"element","block":"k5zy5agy","search_text":"Note A Node.js application will exit automatically when there are no more pending operations in the Event Demultiplexer, and no more events to be processed inside the Event Queue . ","text_count":181,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A Node.js application will exit automatically when there are no more pending operations in the Event Demultiplexer, and no more events to be processed inside the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Queue"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5agz","search_text":"We can now define the pattern at the heart of Node.js:","text_count":54,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now define the pattern at the heart of Node.js:"}]},{"block_type":"element","block":"k5zy5ah0","search_text":"Pattern (reactor) handles I/O by blocking until new events are available from a set of observed resources, and then reacts by dispatching each event to an associated handler.","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern (reactor)"}]},{"block_type":"text","content":"handles I/O by blocking until new events are available from a set of observed resources, and then reacts by dispatching each event to an associated handler."}]},{"block_type":"element","block":"k5zy5ah1","search_text":"The non-blocking I/O engine of Node.js-libuv","text_count":44,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The non-blocking I/O engine of Node.js-libuv"}]},{"block_type":"element","block":"k5zy5ah2","search_text":"Each operating system has its own interface for the Event Demultiplexer: epoll on Linux, kqueue on Mac OS X, and the I/O Completion Port ( IOCP ) API on Windows. Besides that, each I/O operation can behave quite differently depending on the type of the resource, even within the same OS. For example, in Unix, regular filesystem files do not support non-blocking operations, so, in order to simulate non-blocking behavior, it is necessary to use a separate thread outside the Event Loop. All these inconsistencies across and within the different operating systems required a higher-level abstraction to be built for the Event Demultiplexer. This is exactly why the Node.js core team created a C library called libuv , with the objective to make Node.js compatible with all the major platforms and normalize the non-blocking behavior of the different types of resource; libuv today represents the low-level I/O engine of Node.js.","text_count":928,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Each operating system has its own interface for the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Demultiplexer:"}]},{"block_type":"text","content":"epoll on Linux, kqueue on Mac OS X, and the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"I/O Completion Port"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"IOCP"}]},{"block_type":"text","content":") API on Windows. Besides that, each I/O operation can behave quite differently depending on the type of the resource, even within the same OS. For example, in Unix, regular filesystem files do not support non-blocking operations, so, in order to simulate non-blocking behavior, it is necessary to use a separate thread outside the Event Loop. All these inconsistencies across and within the different operating systems required a higher-level abstraction to be built for the Event Demultiplexer. This is exactly why the Node.js core team created a C library called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"libuv"}]},{"block_type":"text","content":", with the objective to make Node.js compatible with all the major platforms and normalize the non-blocking behavior of the different types of resource; libuv today represents the low-level I/O engine of Node.js."}]},{"block_type":"element","block":"k5zy5ah3","search_text":"Besides abstracting the underlying system calls, libuv also implements the reactor pattern, thus providing an API for creating event loops, managing the event queue, running asynchronous I/O operations, and queuing other types of task.","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Besides abstracting the underlying system calls, libuv also implements the reactor pattern, thus providing an API for creating event loops, managing the event queue, running asynchronous I/O operations, and queuing other types of task."}]},{"block_type":"element","block":"k5zy5ah4","search_text":"Note A great resource to learn more about libuv is the free online book created by Nikhil Marathe, which is available at: http://nikhilm.github.io/uvbook/ ","text_count":155,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A great resource to learn more about libuv is the free online book created by Nikhil Marathe, which is available at:"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nikhilm.github.io/uvbook/"},"children":[{"block_type":"text","content":"http://nikhilm.github.io/uvbook/"}]}]}]},{"block_type":"element","block":"k5zy5ah5","search_text":"The recipe for Node.js","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The recipe for Node.js"}]},{"block_type":"element","block":"k5zy5ah6","search_text":"The reactor pattern and libuv are the basic building blocks of Node.js, but we need the following three other components to build the full platform:","text_count":148,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The reactor pattern and libuv are the basic building blocks of Node.js, but we need the following three other components to build the full platform:"}]},{"block_type":"element","block":"k5zy5ah7","search_text":"A set of bindings responsible for wrapping and exposing libuv and other low-level functionality to JavaScript. V8 , the JavaScript engine originally developed by Google for the Chrome browser. This is one of the reasons why Node.js is so fast and efficient. V8 is acclaimed for its revolutionary design, its speed, and for its efficient memory management. A core JavaScript library (called node-core ) that implements the high-level Node.js API. ","text_count":446,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A set of bindings responsible for wrapping and exposing libuv and other low-level functionality to JavaScript."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"V8"}]},{"block_type":"text","content":", the JavaScript engine originally developed by Google for the Chrome browser. This is one of the reasons why Node.js is so fast and efficient. V8 is acclaimed for its revolutionary design, its speed, and for its efficient memory management."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A core JavaScript library (called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"node-core"}]},{"block_type":"text","content":") that implements the high-level Node.js API."}]}]},{"block_type":"element","block":"k5zy5ah8","search_text":"Finally, this is the recipe of Node.js, and the following image represents its final architecture:","text_count":98,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, this is the recipe of Node.js, and the following image represents its final architecture:"}]},{"block_type":"element","block":"k5zy5ah9","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000068.jpg","alt":"The recipe for Node.js","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5aha","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5ahb","search_text":"In this chapter, we have seen how the Node.js platform is based on a few important principles that provide the foundation to build efficient and reusable code. The philosophy and the design choices behind the platform have, in fact, a strong influence on the structure and behavior of every application and module we create. Often, for a developer moving from another technology, these principles might seem unfamiliar and the usual instinctive reaction is to fight the change by trying to find more familiar patterns inside a world which, in reality, requires a real shift in the mindset.","text_count":589,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we have seen how the Node.js platform is based on a few important principles that provide the foundation to build efficient and reusable code. The philosophy and the design choices behind the platform have, in fact, a strong influence on the structure and behavior of every application and module we create. Often, for a developer moving from another technology, these principles might seem unfamiliar and the usual instinctive reaction is to fight the change by trying to find more familiar patterns inside a world which, in reality, requires a real shift in the mindset."}]},{"block_type":"element","block":"k5zy5ahc","search_text":"On one hand, the asynchronous nature of the reactor pattern requires a different programming style made of callbacks and things that happen at a later time, without worrying too much about threads and race conditions. On the other hand, the module pattern and its principles of simplicity and minimalism create interesting new scenarios in terms of reusability, maintenance, and usability.","text_count":389,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On one hand, the asynchronous nature of the reactor pattern requires a different programming style made of callbacks and things that happen at a later time, without worrying too much about threads and race conditions. On the other hand, the module pattern and its principles of simplicity and minimalism create interesting new scenarios in terms of reusability, maintenance, and usability."}]},{"block_type":"element","block":"k5zy5ahd","search_text":"Finally, besides the obvious technical advantages of being fast, efficient, and based on JavaScript, Node.js is attracting so much interest because of the principles we have just discovered. For many, grasping the essence of this world feels like returning to the origins, to a more humane way of programming in both size and complexity, and that's why developers end up falling in love with Node.js. The introduction of ES2015 makes things even more interesting and opens new scenarios in which we can embrace all these advantages with an even more expressive syntax.","text_count":568,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, besides the obvious technical advantages of being fast, efficient, and based on JavaScript, Node.js is attracting so much interest because of the principles we have just discovered. For many, grasping the essence of this world feels like returning to the origins, to a more humane way of programming in both size and complexity, and that's why developers end up falling in love with Node.js. The introduction of ES2015 makes things even more interesting and opens new scenarios in which we can embrace all these advantages with an even more expressive syntax."}]},{"block_type":"element","block":"k5zy5ahe","search_text":"In the next chapter, we will get deep into the two basic asynchronous patterns used in Node.js: the callback pattern and the event emitter. We will also understand the difference between synchronous and asynchronous code and how to avoid writing unpredictable functions.","text_count":270,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter, we will get deep into the two basic asynchronous patterns used in Node.js: the callback pattern and the event emitter. We will also understand the difference between synchronous and asynchronous code and how to avoid writing unpredictable functions."}]}]},{"title":"Node.js Essential Patterns","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4mfh","number":2,"contents":[{"block_type":"element","block":"k5zy5ahf","search_text":"Embracing the asynchronous nature of Node.js is not trivial at all, especially if coming from a language such as PHP where it is not usual to deal with asynchronous code.","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Embracing the asynchronous nature of Node.js is not trivial at all, especially if coming from a language such as PHP where it is not usual to deal with asynchronous code."}]},{"block_type":"element","block":"k5zy5ahg","search_text":"In synchronous programming, we are used to the concept of imagining code as a series of consecutive computing steps defined to solve a specific problem. Every operation is blocking, which means that only when an operation is completed is it possible to execute the next one. This approach makes the code easy to understand and debug.","text_count":333,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In synchronous programming, we are used to the concept of imagining code as a series of consecutive computing steps defined to solve a specific problem. Every operation is blocking, which means that only when an operation is completed is it possible to execute the next one. This approach makes the code easy to understand and debug."}]},{"block_type":"element","block":"k5zy5ahh","search_text":"Instead, in asynchronous programming, some operations, such as reading a file or performing a network request, can be executed as an operation in the background. When an asynchronous operation is invoked, the next one is executed immediately, even if the previous operation has not finished yet. The operations pending in the background can complete at any time, and the whole application should be programmed to react in the proper way when an asynchronous call finishes.","text_count":472,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Instead, in asynchronous programming, some operations, such as reading a file or performing a network request, can be executed as an operation in the background. When an asynchronous operation is invoked, the next one is executed immediately, even if the previous operation has not finished yet. The operations pending in the background can complete at any time, and the whole application should be programmed to react in the proper way when an asynchronous call finishes."}]},{"block_type":"element","block":"k5zy5ahi","search_text":"While this non-blocking approach could almost always guarantee superior performance compared to an always-blocking scenario, it provides a paradigm that could be hard to reason about and that can get really cumbersome when dealing with more advanced applications that require complex control flows.","text_count":298,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"While this non-blocking approach could almost always guarantee superior performance compared to an always-blocking scenario, it provides a paradigm that could be hard to reason about and that can get really cumbersome when dealing with more advanced applications that require complex control flows."}]},{"block_type":"element","block":"k5zy5ahj","search_text":"Node.js offers a series of tools and design patterns to deal optimally with asynchronous code. It's important to learn how to use them to gain confidence and write applications that are both performant and easy to understand and debug.","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Node.js offers a series of tools and design patterns to deal optimally with asynchronous code. It's important to learn how to use them to gain confidence and write applications that are both performant and easy to understand and debug."}]},{"block_type":"element","block":"k5zy5ahk","search_text":"In this chapter, we will see two of the most important asynchronous patterns: callback and event emitter.","text_count":105,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will see two of the most important asynchronous patterns: callback and event emitter."}]},{"block_type":"element","block":"k5zy5ahl","search_text":"The callback pattern","text_count":20,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"The callback pattern"}]},{"block_type":"element","block":"k5zy5ahm","search_text":"Callbacks are the materialization of the handlers of the reactor pattern, which we introduced in the previous chapter. They are one of those imprints that give Node.js its distinctive programming style. Callbacks are functions that are invoked to propagate the result of an operation and this is exactly what we need when dealing with asynchronous operations. They do replace the use of the return instruction that always executes synchronously. JavaScript is a great language to represent callbacks, because as we have seen, functions are first class objects and can be easily assigned to variables, passed as arguments, returned from another function invocation or stored into data structures. Another ideal construct for implementing callbacks is closures . With closures, we can in fact reference the environment in which a function was created; we can always maintain the context in which the asynchronous operation was requested, no matter when or where its callback is invoked.","text_count":984,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Callbacks are the materialization of the handlers of the reactor pattern, which we introduced in the previous chapter. They are one of those imprints that give Node.js its distinctive programming style. Callbacks are functions that are invoked to propagate the result of an operation and this is exactly what we need when dealing with asynchronous operations. They do replace the use of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"return"}]},{"block_type":"text","content":"instruction that always executes synchronously. JavaScript is a great language to represent callbacks, because as we have seen, functions are first class objects and can be easily assigned to variables, passed as arguments, returned from another function invocation or stored into data structures. Another ideal construct for implementing callbacks is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"closures"}]},{"block_type":"text","content":". With closures, we can in fact reference the environment in which a function was created; we can always maintain the context in which the asynchronous operation was requested, no matter when or where its callback is invoked."}]},{"block_type":"element","block":"k5zy5ahn","search_text":"If you need to refresh your knowledge about closures, you can refer to the article on the Mozilla Developer Network at https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Closures .","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you need to refresh your knowledge about closures, you can refer to the article on the Mozilla Developer Network at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Closures"},"children":[{"block_type":"text","content":"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Closures"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aho","search_text":"In this section, we will analyze this particular style of programming that's made of callbacks instead of x return instructions.","text_count":128,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will analyze this particular style of programming that's made of callbacks instead of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"return instructions."}]},{"block_type":"element","block":"k5zy5ahp","search_text":"The continuation-passing style","text_count":30,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The continuation-passing style"}]},{"block_type":"element","block":"k5zy5ahq","search_text":"In JavaScript, a callback is a function that is passed as an argument to another function and is invoked with the result when the operation completes. In functional programming, this way of propagating the result is called continuation-passing style ( CPS ). It is a general concept, and it is not always associated with asynchronous operations. In fact, it simply indicates that a result is propagated by passing it to another function (the callback), instead of directly returning it to the caller.","text_count":500,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In JavaScript, a callback is a function that is passed as an argument to another function and is invoked with the result when the operation completes. In functional programming, this way of propagating the result is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"continuation-passing style"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"CPS"}]},{"block_type":"text","content":"). It is a general concept, and it is not always associated with asynchronous operations. In fact, it simply indicates that a result is propagated by passing it to another function (the callback), instead of directly returning it to the caller."}]},{"block_type":"element","block":"k5zy5ahr","search_text":"Synchronous continuation-passing style","text_count":38,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Synchronous continuation-passing style"}]},{"block_type":"element","block":"k5zy5ahs","search_text":"To clarify the concept, let's take a look at a simple synchronous function:","text_count":75,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To clarify the concept, let's take a look at a simple synchronous function:"}]},{"block_type":"element","block":"k5zy5aht","search_text":"function add(a, b) { return a + b; } ","text_count":37,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function add(a, b) { \n  return a + b; \n}"}]}]},{"block_type":"element","block":"k5zy5ahu","search_text":"There is nothing special here; the result is passed back to the caller using the return instruction; this is also called direct style , and it represents the most common way of returning a result in synchronous programming. The equivalent continuation-passing style of the preceding function would be as follows:","text_count":312,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There is nothing special here; the result is passed back to the caller using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"return"}]},{"block_type":"text","content":"instruction; this is also called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"direct style"}]},{"block_type":"text","content":", and it represents the most common way of returning a result in synchronous programming. The equivalent continuation-passing style of the preceding function would be as follows:"}]},{"block_type":"element","block":"k5zy5ahv","search_text":"function add(a, b, callback) { callback(a + b); } ","text_count":50,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function add(a, b, callback) { \n  callback(a + b); \n}"}]}]},{"block_type":"element","block":"k5zy5ahw","search_text":"The add() function is a synchronous CPS function, which means that it will return a value only when the callback completes its execution. The following code demonstrates this statement:","text_count":185,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"add()"}]},{"block_type":"text","content":"function is a synchronous CPS function, which means that it will return a value only when the callback completes its execution. The following code demonstrates this statement:"}]},{"block_type":"element","block":"k5zy5ahx","search_text":"console.log('before'); add(1, 2, result => console.log('Result: ' + result)); console.log('after'); ","text_count":100,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"console.log('before'); \nadd(1, 2, result =&gt; console.log('Result: ' + result)); \nconsole.log('after');"}]}]},{"block_type":"element","block":"k5zy5ahy","search_text":"Since add() is synchronous, the previous code will trivially print the following:","text_count":81,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Since"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"add()"}]},{"block_type":"text","content":"is synchronous, the previous code will trivially print the following:"}]},{"block_type":"element","block":"k5zy5ahz","search_text":"before Result: 3 after ","text_count":23,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"before\nResult: 3\nafter"}]}]},{"block_type":"element","block":"k5zy5ai0","search_text":"Asynchronous continuation-passing style","text_count":39,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Asynchronous continuation-passing style"}]},{"block_type":"element","block":"k5zy5ai1","search_text":"Now, let's consider a case where the add() function is asynchronous, as follows:","text_count":80,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's consider a case where the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"add()"}]},{"block_type":"text","content":"function is asynchronous, as follows:"}]},{"block_type":"element","block":"k5zy5ai2","search_text":"function additionAsync(a, b, callback) { setTimeout(() => callback(a + b), 100); } ","text_count":83,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function additionAsync(a, b, callback) { \n  setTimeout(() =&gt; callback(a + b), 100); \n}"}]}]},{"block_type":"element","block":"k5zy5ai3","search_text":"In the previous code, we used setTimeout() to simulate an asynchronous invocation of the callback. Now, let's try to use additionAsync and see how the order of the operations changes:","text_count":183,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous code, we used"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setTimeout()"}]},{"block_type":"text","content":"to simulate an asynchronous invocation of the callback. Now, let's try to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"additionAsync"}]},{"block_type":"text","content":"and see how the order of the operations changes:"}]},{"block_type":"element","block":"k5zy5ai4","search_text":"console.log('before'); additionAsync(1, 2, result => console.log('Result: ' + result)); console.log('after'); ","text_count":110,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"console.log('before'); \nadditionAsync(1, 2, result =&gt; console.log('Result: ' + result)); \nconsole.log('after');"}]}]},{"block_type":"element","block":"k5zy5ai5","search_text":"The preceding code will print the following output:","text_count":51,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code will print the following output:"}]},{"block_type":"element","block":"k5zy5ai6","search_text":"before after Result: 3 ","text_count":23,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"before\nafter\nResult: 3"}]}]},{"block_type":"element","block":"k5zy5ai7","search_text":"Since setTimeout() triggers an asynchronous operation, it will not wait for the callback to be executed, but instead, it returns immediately, giving the control back to additionAsync() , and then back to its caller. This property in Node.js is crucial, as it gives control back to the event loop as soon as an asynchronous request is sent, thus allowing a new event from the queue to be processed.","text_count":397,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Since"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setTimeout()"}]},{"block_type":"text","content":"triggers an asynchronous operation, it will not wait for the callback to be executed, but instead, it returns immediately, giving the control back to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"additionAsync()"}]},{"block_type":"text","content":", and then back to its caller. This property in Node.js is crucial, as it gives control back to the event loop as soon as an asynchronous request is sent, thus allowing a new event from the queue to be processed."}]},{"block_type":"element","block":"k5zy5ai8","search_text":"The following image shows how this works:","text_count":41,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following image shows how this works:"}]},{"block_type":"element","block":"k5zy5ai9","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000038.jpg","alt":"Asynchronous continuation-passing style","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5aia","search_text":"When the asynchronous operation completes, the execution is then resumed starting from the callback provided to the asynchronous function that caused the unwinding. The execution will start from the Event Loop , so it will have a fresh stack. This is where JavaScript comes in really handy. Thanks to closures, it is trivial to maintain the context of the caller of the asynchronous function, even if the callback is invoked at a different point in time and from a different location.","text_count":484,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When the asynchronous operation completes, the execution is then resumed starting from the callback provided to the asynchronous function that caused the unwinding. The execution will start from the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Loop"}]},{"block_type":"text","content":", so it will have a fresh stack. This is where JavaScript comes in really handy. Thanks to closures, it is trivial to maintain the context of the caller of the asynchronous function, even if the callback is invoked at a different point in time and from a different location."}]},{"block_type":"element","block":"k5zy5aib","search_text":"A synchronous function blocks until it completes its operations. An asynchronous function returns immediately and the result is passed to a handler (in our case, a callback) at a later cycle of the event loop.","text_count":209,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A synchronous function blocks until it completes its operations. An asynchronous function returns immediately and the result is passed to a handler (in our case, a callback) at a later cycle of the event loop."}]},{"block_type":"element","block":"k5zy5aic","search_text":"Non-continuation-passing style callbacks","text_count":40,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Non-continuation-passing style callbacks"}]},{"block_type":"element","block":"k5zy5aid","search_text":"There are several circumstances in which the presence of a callback argument might make us think that a function is asynchronous or is using a continuation-passing style; that's not always true. Let's take, for example, the map() method of an Array object:","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are several circumstances in which the presence of a callback argument might make us think that a function is asynchronous or is using a continuation-passing style; that's not always true. Let's take, for example, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"map()"}]},{"block_type":"text","content":"method of an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Array"}]},{"block_type":"text","content":"object:"}]},{"block_type":"element","block":"k5zy5aie","search_text":"const result = [1, 5, 7].map(element => element - 1); console.log(result); // [0, 4, 6] ","text_count":88,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const result = [1, 5, 7].map(element =&gt; element - 1); \nconsole.log(result); // [0, 4, 6]"}]}]},{"block_type":"element","block":"k5zy5aif","search_text":"Clearly, the callback is used just to iterate over the elements of the array, and not to pass the result of the operation. In fact, the result is returned synchronously using a direct style. The intent of a callback is usually clearly stated in the documentation of the API.","text_count":274,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Clearly, the callback is used just to iterate over the elements of the array, and not to pass the result of the operation. In fact, the result is returned synchronously using a direct style. The intent of a callback is usually clearly stated in the documentation of the API."}]},{"block_type":"element","block":"k5zy5aig","search_text":"Synchronous or asynchronous?","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Synchronous or asynchronous?"}]},{"block_type":"element","block":"k5zy5aih","search_text":"We have seen how the order of the instructions changes radically depending on the nature of a function-synchronous or asynchronous. This has strong repercussions on the flow of the entire application, both in correctness and efficiency. The following is an analysis of these two paradigms and their pitfalls. In general, what must be avoided is creating inconsistency and confusion around the nature of an API, as doing so can lead to a set of problems which might be very hard to detect and reproduce. To drive our analysis, we will take as an example the case of an inconsistently asynchronous function.","text_count":605,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We have seen how the order of the instructions changes radically depending on the nature of a function-synchronous or asynchronous. This has strong repercussions on the flow of the entire application, both in correctness and efficiency. The following is an analysis of these two paradigms and their pitfalls. In general, what must be avoided is creating inconsistency and confusion around the nature of an API, as doing so can lead to a set of problems which might be very hard to detect and reproduce. To drive our analysis, we will take as an example the case of an inconsistently asynchronous function."}]},{"block_type":"element","block":"k5zy5aii","search_text":"An unpredictable function","text_count":25,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"An unpredictable function"}]},{"block_type":"element","block":"k5zy5aij","search_text":"One of the most dangerous situations is to have an API that behaves synchronously under certain conditions and asynchronously under others. Let's take the following code as an example:","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the most dangerous situations is to have an API that behaves synchronously under certain conditions and asynchronously under others. Let's take the following code as an example:"}]},{"block_type":"element","block":"k5zy5aik","search_text":"const fs = require('fs'); const cache = {}; function inconsistentRead(filename, callback) { if(cache[filename]) { //invoked synchronously callback(cache[filename]); } else { //asynchronous function fs.readFile(filename, 'utf8', (err, data) => { cache[filename] = data; callback(data); }); } } ","text_count":293,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nconst cache = {}; \nfunction inconsistentRead(filename, callback) { \n  if(cache[filename]) { \n    //invoked synchronously \n    callback(cache[filename]);   \n  } else { \n    //asynchronous function \n    fs.readFile(filename, 'utf8', (err, data) =&gt; { \n      cache[filename] = data; \n      callback(data); \n    }); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5ail","search_text":"The preceding function uses the cache variable to store the results of different file read operations. Bear in mind that this is just an example, it does not have error management, and the caching logic itself is suboptimal. Besides this, the preceding function is dangerous because it behaves asynchronously if the cache is not set-which is not until the fs.readFile() function returns its results-but it will also be synchronous for all the subsequent requests for a file already in the cache-triggering an immediate invocation of the callback.","text_count":546,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding function uses the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cache"}]},{"block_type":"text","content":"variable to store the results of different file read operations. Bear in mind that this is just an example, it does not have error management, and the caching logic itself is suboptimal. Besides this, the preceding function is dangerous because it behaves asynchronously if the cache is not set-which is not until the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs.readFile()"}]},{"block_type":"text","content":"function returns its results-but it will also be synchronous for all the subsequent requests for a file already in the cache-triggering an immediate invocation of the callback."}]},{"block_type":"element","block":"k5zy5aim","search_text":"Unleashing Zalgo","text_count":16,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Unleashing Zalgo"}]},{"block_type":"element","block":"k5zy5ain","search_text":"Now, let's see how the use of an unpredictable function, such as the one that we defined previously, can easily break an application. Consider the following code:","text_count":162,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's see how the use of an unpredictable function, such as the one that we defined previously, can easily break an application. Consider the following code:"}]},{"block_type":"element","block":"k5zy5aio","search_text":"function createFileReader(filename) { const listeners = []; inconsistentRead(filename, value => { listeners.forEach(listener => listener(value)); }); return { onDataReady: listener => listeners.push(listener) }; } ","text_count":214,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function createFileReader(filename) {\n  const listeners = [];\n  inconsistentRead(filename, value =&gt; {\n    listeners.forEach(listener =&gt; listener(value));\n  });\n\n  return {\n    onDataReady: listener =&gt; listeners.push(listener)\n  };\n}"}]}]},{"block_type":"element","block":"k5zy5aip","search_text":"When the preceding function is invoked, it creates a new object that acts as a notifier, allowing us to set multiple listeners for a file read operation. All the listeners will be invoked at once when the read operation completes and the data is available. The preceding function uses our inconsistentRead() function to implement this functionality. Let's now try to use the createFileReader() function:","text_count":403,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When the preceding function is invoked, it creates a new object that acts as a notifier, allowing us to set multiple listeners for a file read operation. All the listeners will be invoked at once when the read operation completes and the data is available. The preceding function uses our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inconsistentRead()"}]},{"block_type":"text","content":"function to implement this functionality. Let's now try to use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"createFileReader()"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k5zy5aiq","search_text":"const reader1 = createFileReader('data.txt'); reader1.onDataReady(data => { console.log('First call data: ' + data); //...sometime later we try to read again from //the same file const reader2 = createFileReader('data.txt'); reader2.onDataReady( data => { console.log('Second call data: ' + data); }); }); ","text_count":306,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const reader1 = createFileReader('data.txt'); \nreader1.onDataReady(data =&gt; { \n  console.log('First call data: ' + data); \n \n  //...sometime later we try to read again from \n  //the same file \n  const reader2 = createFileReader('data.txt'); \n  reader2.onDataReady( data =&gt; { \n    console.log('Second call data: ' + data); \n  }); \n});"}]}]},{"block_type":"element","block":"k5zy5air","search_text":"The preceding code will print the following output:","text_count":51,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code will print the following output:"}]},{"block_type":"element","block":"k5zy5ais","search_text":"First call data: some data ","text_count":27,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"First call data: some data"}]}]},{"block_type":"element","block":"k5zy5ait","search_text":"As you can see, the callback of the second operation is never invoked. Let's see why:","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, the callback of the second operation is never invoked. Let's see why:"}]},{"block_type":"element","block":"k5zy5aiu","search_text":"During the creation of reader1 , our inconsistentRead() function behaves asynchronously, because there is no cached result available. Therefore, we have all the time in the world to register our listener, as it will be invoked later in another cycle of the event loop, when the read operation completes. Then, reader2 is created in a cycle of the event loop in which the cache for the requested file already exists. In this case, the inner call to inconsistentRead() will be synchronous. So, its callback will be invoked immediately, which means that all the listeners of reader2 will be invoked synchronously as well. However, we are registering the listeners after the creation of reader2 , so they will never be invoked. ","text_count":724,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"During the creation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reader1"}]},{"block_type":"text","content":", our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inconsistentRead()"}]},{"block_type":"text","content":"function behaves asynchronously, because there is no cached result available. Therefore, we have all the time in the world to register our listener, as it will be invoked later in another cycle of the event loop, when the read operation completes."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Then,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reader2"}]},{"block_type":"text","content":"is created in a cycle of the event loop in which the cache for the requested file already exists. In this case, the inner call to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inconsistentRead()"}]},{"block_type":"text","content":"will be synchronous. So, its callback will be invoked immediately, which means that all the listeners of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reader2"}]},{"block_type":"text","content":"will be invoked synchronously as well. However, we are registering the listeners after the creation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reader2"}]},{"block_type":"text","content":", so they will never be invoked."}]}]},{"block_type":"element","block":"k5zy5aiv","search_text":"The callback behavior of our inconsistentRead() function is really unpredictable, as it depends on many factors, such as the frequency of its invocation, the filename passed as argument, and the amount of time taken to load the file.","text_count":233,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The callback behavior of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inconsistentRead()"}]},{"block_type":"text","content":"function is really unpredictable, as it depends on many factors, such as the frequency of its invocation, the filename passed as argument, and the amount of time taken to load the file."}]},{"block_type":"element","block":"k5zy5aiw","search_text":"The bug that we've just seen might be extremely complicated to identify and reproduce in a real application. Imagine using a similar function in a web server, where there can be multiple concurrent requests; imagine seeing some of those requests hanging, without any apparent reason and without any error being logged. This definitely falls under the category of nasty defects .","text_count":378,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The bug that we've just seen might be extremely complicated to identify and reproduce in a real application. Imagine using a similar function in a web server, where there can be multiple concurrent requests; imagine seeing some of those requests hanging, without any apparent reason and without any error being logged. This definitely falls under the category of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"nasty defects"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aix","search_text":"Isaac Z. Schlueter, creator of npm and former Node.js project lead, in one of his blog posts compared the use of this type of unpredictable functions to unleashing Zalgo .","text_count":171,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Isaac Z. Schlueter, creator of npm and former Node.js project lead, in one of his blog posts compared the use of this type of unpredictable functions to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"unleashing Zalgo"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aiy","search_text":"Zalgo is an Internet legend about an ominous entity believed to cause insanity, death, and destruction of the world. If you're not familiar with Zalgo, you are invited to find out what it is.","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Zalgo is an Internet legend about an ominous entity believed to cause insanity, death, and destruction of the world. If you're not familiar with Zalgo, you are invited to find out what it is."}]},{"block_type":"element","block":"k5zy5aiz","search_text":"You can find Isaac Z. Schlueter's original post at http://blog.izs.me/post/59142742143/designing-apis-for-asynchrony .","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can find Isaac Z. Schlueter's original post at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://blog.izs.me/post/59142742143/designing-apis-for-asynchrony"},"children":[{"block_type":"text","content":"http://blog.izs.me/post/59142742143/designing-apis-for-asynchrony"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aj0","search_text":"Using synchronous APIs","text_count":22,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Using synchronous APIs"}]},{"block_type":"element","block":"k5zy5aj1","search_text":"The lesson to learn from the unleashing Zalgo example is that it is imperative for an API to clearly define its nature: either synchronous or asynchronous.","text_count":155,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The lesson to learn from the unleashing Zalgo example is that it is imperative for an API to clearly define its nature: either synchronous or asynchronous."}]},{"block_type":"element","block":"k5zy5aj2","search_text":"One suitable fix for our inconsistentRead() function is to make it totally synchronous. This is possible because Node.js provides a set of synchronous direct style APIs for most basic I/O operations. For example, we can use the fs.readFileSync() function in place of its asynchronous counterpart. The code would now be as follows:","text_count":330,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One suitable fix for our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inconsistentRead()"}]},{"block_type":"text","content":"function is to make it totally synchronous. This is possible because Node.js provides a set of synchronous direct style APIs for most basic I/O operations. For example, we can use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs.readFileSync()"}]},{"block_type":"text","content":"function in place of its asynchronous counterpart. The code would now be as follows:"}]},{"block_type":"element","block":"k5zy5aj3","search_text":"const fs = require('fs'); const cache = {}; function consistentReadSync(filename) { if(cache[filename]) { return cache[filename]; } else { cache[filename] = fs.readFileSync(filename, 'utf8'); return cache[filename]; } } ","text_count":220,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nconst cache = {}; \nfunction consistentReadSync(filename) { \n  if(cache[filename]) { \n    return cache[filename];   \n  } else { \n    cache[filename] = fs.readFileSync(filename, 'utf8'); \n    return cache[filename]; \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5aj4","search_text":"We can see that the entire function was also converted to a direct style. There is no reason for a function to have a continuation-passing style if it is synchronous. In fact, we can state that it is always best practice to implement a synchronous API using a direct style; this will eliminate any confusion around its nature and will also be more efficient from a performance perspective.","text_count":389,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can see that the entire function was also converted to a direct style. There is no reason for a function to have a continuation-passing style if it is synchronous. In fact, we can state that it is always best practice to implement a synchronous API using a direct style; this will eliminate any confusion around its nature and will also be more efficient from a performance perspective."}]},{"block_type":"element","block":"k5zy5aj5","search_text":"Note Pattern Prefer the direct style for purely synchronous functions. ","text_count":71,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Prefer the direct style for purely synchronous functions."}]}]},{"block_type":"element","block":"k5zy5aj6","search_text":"Bear in mind that changing an API from CPS to a direct style, or from asynchronous to synchronous or vice versa might also require a change to the style of all the code using it. For example, in our case, we will have to totally change the interface of our createFileReader() API and adapt it to always work synchronously.","text_count":322,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Bear in mind that changing an API from CPS to a direct style, or from asynchronous to synchronous or vice versa might also require a change to the style of all the code using it. For example, in our case, we will have to totally change the interface of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"createFileReader()"}]},{"block_type":"text","content":"API and adapt it to always work synchronously."}]},{"block_type":"element","block":"k5zy5aj7","search_text":"Also, using a synchronous API instead of an asynchronous one has some caveats:","text_count":78,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, using a synchronous API instead of an asynchronous one has some caveats:"}]},{"block_type":"element","block":"k5zy5aj8","search_text":"A synchronous API for a specific functionality might not always be available. A synchronous API will block the event loop and put the concurrent requests on hold. It does break the JavaScript concurrency model, slowing down the whole application. We will see later in the book what this really means for our applications. ","text_count":322,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A synchronous API for a specific functionality might not always be available."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A synchronous API will block the event loop and put the concurrent requests on hold. It does break the JavaScript concurrency model, slowing down the whole application. We will see later in the book what this really means for our applications."}]}]},{"block_type":"element","block":"k5zy5aj9","search_text":"In our consistentReadSync() function, the risk of blocking the event loop is partially mitigated because the synchronous I/O API is invoked only once per filename, while the cached value will be used for all the subsequent invocations. If we have a limited number of static files, then using consistentReadSync() won't have a big effect on our event loop. Things can change quickly if we have to read many files and only once. Using synchronous I/O in Node.js is strongly discouraged in many circumstances; however, in some situations, this might be the easiest and most efficient solution. Always evaluate your specific use case in order to choose the right alternative. Just to make a real use case example: it makes perfect sense to use a synchronous blocking API to load a configuration file while bootstrapping an application.","text_count":831,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consistentReadSync()"}]},{"block_type":"text","content":"function, the risk of blocking the event loop is partially mitigated because the synchronous I/O API is invoked only once per filename, while the cached value will be used for all the subsequent invocations. If we have a limited number of static files, then using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consistentReadSync()"}]},{"block_type":"text","content":"won't have a big effect on our event loop. Things can change quickly if we have to read many files and only once. Using synchronous I/O in Node.js is strongly discouraged in many circumstances; however, in some situations, this might be the easiest and most efficient solution. Always evaluate your specific use case in order to choose the right alternative. Just to make a real use case example: it makes perfect sense to use a synchronous blocking API to load a configuration file while bootstrapping an application."}]},{"block_type":"element","block":"k5zy5aja","search_text":"Use blocking API only when they don't affect the ability of the application to serve concurrent requests.","text_count":105,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Use blocking API only when they don't affect the ability of the application to serve concurrent requests."}]},{"block_type":"element","block":"k5zy5ajb","search_text":"Deferred execution","text_count":18,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Deferred execution"}]},{"block_type":"element","block":"k5zy5ajc","search_text":"Another alternative for fixing our inconsistentRead() function is to make it purely asynchronous. The trick here is to schedule the synchronous callback invocation to be executed \"in the future\" instead of being run immediately in the same event loop cycle. In Node.js, this is possible using process.nextTick() , which defers the execution of a function until the next pass of the event loop. Its functioning is very simple; it takes a callback as an argument and pushes it to the top of the event queue, in front of any pending I/O event, and returns immediately. The callback will then be invoked as soon as the event loop runs again.","text_count":637,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another alternative for fixing our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inconsistentRead()"}]},{"block_type":"text","content":"function is to make it purely asynchronous. The trick here is to schedule the synchronous callback invocation to be executed \"in the future\" instead of being run immediately in the same event loop cycle. In Node.js, this is possible using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.nextTick()"}]},{"block_type":"text","content":", which defers the execution of a function until the next pass of the event loop. Its functioning is very simple; it takes a callback as an argument and pushes it to the top of the event queue, in front of any pending I/O event, and returns immediately. The callback will then be invoked as soon as the event loop runs again."}]},{"block_type":"element","block":"k5zy5ajd","search_text":"Let's apply this technique to fix our inconsistentRead() function as follows:","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's apply this technique to fix our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inconsistentRead()"}]},{"block_type":"text","content":"function as follows:"}]},{"block_type":"element","block":"k5zy5aje","search_text":"const fs = require('fs'); const cache = {}; function consistentReadAsync(filename, callback) { if(cache[filename]) { process.nextTick(() => callback(cache[filename])); } else { //asynchronous function fs.readFile(filename, 'utf8', (err, data) => { cache[filename] = data; callback(data); }); } } ","text_count":296,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nconst cache = {}; \nfunction consistentReadAsync(filename, callback) { \n  if(cache[filename]) { \n    process.nextTick(() =&gt; callback(cache[filename])); \n  } else { \n    //asynchronous function \n    fs.readFile(filename, 'utf8', (err, data) =&gt; { \n      cache[filename] = data; \n      callback(data); \n    }); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5ajf","search_text":"Now, our function is guaranteed to invoke its callback asynchronously, under any circumstances.","text_count":95,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, our function is guaranteed to invoke its callback asynchronously, under any circumstances."}]},{"block_type":"element","block":"k5zy5ajg","search_text":"Another API for deferring the execution of code is setImmediate() . While their purposes are very similar, their semantics are quite different. Callbacks deferred with process.nextTick() run before any other I/O event is fired, while with setImmediate() , the execution is queued behind any I/O event that is already in the queue. Since process.nextTick() runs before any already scheduled I/O, it might cause I/O starvation under certain circumstances, for example, a recursive invocation; this can never happen with setImmediate() . We will learn to appreciate the difference between these two APIs when we analyze the use of deferred invocation for running synchronous CPU-bound tasks later in the book.","text_count":706,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another API for deferring the execution of code is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":". While their purposes are very similar, their semantics are quite different. Callbacks deferred with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.nextTick()"}]},{"block_type":"text","content":"run before any other I/O event is fired, while with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":", the execution is queued behind any I/O event that is already in the queue. Since"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.nextTick()"}]},{"block_type":"text","content":"runs before any already scheduled I/O, it might cause I/O starvation under certain circumstances, for example, a recursive invocation; this can never happen with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":". We will learn to appreciate the difference between these two APIs when we analyze the use of deferred invocation for running synchronous CPU-bound tasks later in the book."}]},{"block_type":"element","block":"k5zy5ajh","search_text":"Note Pattern We guarantee that a callback is invoked asynchronously by deferring its execution using process.nextTick() . ","text_count":122,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We guarantee that a callback is invoked asynchronously by deferring its execution using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.nextTick()"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5aji","search_text":"Node.js callback conventions","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Node.js callback conventions"}]},{"block_type":"element","block":"k5zy5ajj","search_text":"In Node.js, continuation-passing style APIs and callbacks follow a set of specific conventions. These conventions apply to the Node.js core API but they are also followed by the vast majority of the userland modules and applications. So, it's very important that we understand them and make sure that we comply whenever we need to design an asynchronous API.","text_count":358,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Node.js, continuation-passing style APIs and callbacks follow a set of specific conventions. These conventions apply to the Node.js core API but they are also followed by the vast majority of the userland modules and applications. So, it's very important that we understand them and make sure that we comply whenever we need to design an asynchronous API."}]},{"block_type":"element","block":"k5zy5ajk","search_text":"Callbacks come last","text_count":19,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Callbacks come last"}]},{"block_type":"element","block":"k5zy5ajl","search_text":"In all core Node.js methods, the standard convention is that when a function accepts a callback in input, this has to be passed as the last argument. Let's take the following Node.js core API as an example:","text_count":206,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In all core Node.js methods, the standard convention is that when a function accepts a callback in input, this has to be passed as the last argument. Let's take the following Node.js core API as an example:"}]},{"block_type":"element","block":"k5zy5ajm","search_text":"fs.readFile(filename, [options], callback) ","text_count":43,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fs.readFile(filename, [options], callback)"}]}]},{"block_type":"element","block":"k5zy5ajn","search_text":"As we can see from the signature of the preceding function, the callback is always put in the last position, even in the presence of optional arguments. The reason for this convention is that the function call is more readable in case the callback is defined in place.","text_count":268,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see from the signature of the preceding function, the callback is always put in the last position, even in the presence of optional arguments. The reason for this convention is that the function call is more readable in case the callback is defined in place."}]},{"block_type":"element","block":"k5zy5ajo","search_text":"Error comes first","text_count":17,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Error comes first"}]},{"block_type":"element","block":"k5zy5ajp","search_text":"In CPS, errors are propagated as any other type of result, which means using callbacks. In Node.js, any error produced by a CPS function is always passed as the first argument of the callback, and any actual result is passed starting from the second argument. If the operation succeeds without errors, the first argument will be null or undefined. The following code shows you how to define a callback complying with this convention:","text_count":433,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In CPS, errors are propagated as any other type of result, which means using callbacks. In Node.js, any error produced by a CPS function is always passed as the first argument of the callback, and any actual result is passed starting from the second argument. If the operation succeeds without errors, the first argument will be null or undefined. The following code shows you how to define a callback complying with this convention:"}]},{"block_type":"element","block":"k5zy5ajq","search_text":"fs.readFile('foo.txt', 'utf8', (err, data) => { if(err) handleError(err); else processData(data); }); ","text_count":102,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fs.readFile('foo.txt', 'utf8', (err, data) =&gt; { \n  if(err) \n    handleError(err); \n  else \n    processData(data); \n});"}]}]},{"block_type":"element","block":"k5zy5ajr","search_text":"It is best practice to always check for the presence of an error, as not doing so will make it harder for us to debug our code and discover the possible points of failure. Another important convention to take into account is that the error must always be of type Error . This means that simple strings or numbers should never be passed as error objects.","text_count":353,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is best practice to always check for the presence of an error, as not doing so will make it harder for us to debug our code and discover the possible points of failure. Another important convention to take into account is that the error must always be of type"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Error"}]},{"block_type":"text","content":". This means that simple strings or numbers should never be passed as error objects."}]},{"block_type":"element","block":"k5zy5ajs","search_text":"Propagating errors","text_count":18,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Propagating errors"}]},{"block_type":"element","block":"k5zy5ajt","search_text":"Propagating errors in synchronous, direct style functions is done with the well-known throw statement, which causes the error to jump up in the call stack until it is caught.","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Propagating errors in synchronous, direct style functions is done with the well-known"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"throw"}]},{"block_type":"text","content":"statement, which causes the error to jump up in the call stack until it is caught."}]},{"block_type":"element","block":"k5zy5aju","search_text":"In asynchronous CPS however, proper error propagation is done by simply passing the error to the next callback in the chain. The typical pattern looks as follows:","text_count":162,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In asynchronous CPS however, proper error propagation is done by simply passing the error to the next callback in the chain. The typical pattern looks as follows:"}]},{"block_type":"element","block":"k5zy5ajv","search_text":"const fs = require('fs'); function readJSON(filename, callback) { fs.readFile(filename, 'utf8', (err, data) => { let parsed; if(err) //propagate the error and exit the current function return callback(err); try { //parse the file contents parsed = JSON.parse(data); } catch(err) { //catch parsing errors return callback(err); } //no errors, propagate just the data callback(null, parsed); }); }; ","text_count":396,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nfunction readJSON(filename, callback) { \n  fs.readFile(filename, 'utf8', (err, data) =&gt; { \n    let parsed; \n    if(err) \n      //propagate the error and exit the current function \n      return callback(err); \n\n    try { \n      //parse the file contents \n      parsed = JSON.parse(data); \n    } catch(err) { \n      //catch parsing errors \n      return callback(err); \n    } \n    //no errors, propagate just the data \n    callback(null, parsed); \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5ajw","search_text":"The detail you should notice in the previous code is how the callback is invoked when we want to pass a valid result and when we want to propagate an error. Also notice that when we are propagating an error we use the return statement. We do so to exit from the function as soon as the callback function is invoked and to avoid executing the next lines in readJSON .","text_count":366,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The detail you should notice in the previous code is how the callback is invoked when we want to pass a valid result and when we want to propagate an error. Also notice that when we are propagating an error we use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"return"}]},{"block_type":"text","content":"statement. We do so to exit from the function as soon as the callback function is invoked and to avoid executing the next lines in"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readJSON"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5ajx","search_text":"Uncaught exceptions","text_count":19,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Uncaught exceptions"}]},{"block_type":"element","block":"k5zy5ajy","search_text":"You might have seen in the readJSON() function, that was used in order to avoid any exception being thrown into the fs.readFile() callback, we put a try...catch block around JSON.parse() . Throwing inside an asynchronous callback will cause the exception to jump up to the event loop and never be propagated to the next callbacIn Node.js, this is an unrecoverable state and the application will simply shut down printing the error to the stderr interface. To demonstrate this, let's try to remove the try...catch block from the readJSON() function defined previously:","text_count":567,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You might have seen in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readJSON()"}]},{"block_type":"text","content":"function, that was used in order to avoid any exception being thrown into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs.readFile()"}]},{"block_type":"text","content":"callback, we put a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"try...catch"}]},{"block_type":"text","content":"block around"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"JSON.parse()"}]},{"block_type":"text","content":". Throwing inside an asynchronous callback will cause the exception to jump up to the event loop and never be propagated to the next callbacIn Node.js, this is an unrecoverable state and the application will simply shut down printing the error to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stderr"}]},{"block_type":"text","content":"interface. To demonstrate this, let's try to remove the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"try...catch"}]},{"block_type":"text","content":"block from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readJSON()"}]},{"block_type":"text","content":"function defined previously:"}]},{"block_type":"element","block":"k5zy5ajz","search_text":"const fs = require('fs'); function readJSONThrows(filename, callback) { fs.readFile(filename, 'utf8', (err, data) => { if(err) { return callback(err); } //no errors, propagate just the data callback(null, JSON.parse(data)); }); }; ","text_count":231,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nfunction readJSONThrows(filename, callback) { \n  fs.readFile(filename, 'utf8', (err, data) =&gt; { \n    if(err) { \n      return callback(err); \n    } \n    //no errors, propagate just the data \n    callback(null, JSON.parse(data)); \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5ak0","search_text":"Now, in the function we just defined, there is no way of catching an eventual exception coming from JSON.parse() . If we try to parse an invalid JSON file with the following code:","text_count":179,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, in the function we just defined, there is no way of catching an eventual exception coming from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"JSON.parse()"}]},{"block_type":"text","content":". If we try to parse an invalid JSON file with the following code:"}]},{"block_type":"element","block":"k5zy5ak1","search_text":"readJSONThrows('nonJSON.txt', err => console.log(err)); ","text_count":56,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"readJSONThrows('nonJSON.txt', err =&gt; console.log(err));"}]}]},{"block_type":"element","block":"k5zy5ak2","search_text":"This would result in the application being abruptly terminated with the following exception being printed on the console:","text_count":121,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This would result in the application being abruptly terminated with the following exception being printed on the console:"}]},{"block_type":"element","block":"k5zy5ak3","search_text":"SyntaxError: Unexpected token d at Object.parse (native) at [...] at fs.js:266:14 at Object.oncomplete (fs.js:107:15) ","text_count":118,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"SyntaxError: Unexpected token d\n    at Object.parse (native)\n    at [...]\n    at fs.js:266:14\n    at Object.oncomplete (fs.js:107:15)"}]}]},{"block_type":"element","block":"k5zy5ak4","search_text":"Now, if we look at the preceding stack trace, we will see that it starts somewhere from the fs.js module, exactly from the point at which the native API has completed reading and returned its result back to the fs.readFile() function, via the event loop. This clearly shows us that the exception traveled from our callback into the stack and then straight into the event loop, where it's finally caught and thrown in the console.","text_count":429,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, if we look at the preceding stack trace, we will see that it starts somewhere from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs.js"}]},{"block_type":"text","content":"module, exactly from the point at which the native API has completed reading and returned its result back to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs.readFile()"}]},{"block_type":"text","content":"function, via the event loop. This clearly shows us that the exception traveled from our callback into the stack and then straight into the event loop, where it's finally caught and thrown in the console."}]},{"block_type":"element","block":"k5zy5ak5","search_text":"This also means that wrapping the invocation of readJSONThrows() with a try...catch block will not work, because the stack in which the block operates is different from the one in which our callback is invoked. The following code shows the anti-pattern that we just described:","text_count":276,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This also means that wrapping the invocation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readJSONThrows()"}]},{"block_type":"text","content":"with a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"try...catch"}]},{"block_type":"text","content":"block will not work, because the stack in which the block operates is different from the one in which our callback is invoked. The following code shows the anti-pattern that we just described:"}]},{"block_type":"element","block":"k5zy5ak6","search_text":"try { readJSONThrows('nonJSON.txt', function(err, result) { //... }); } catch(err) { console.log('This will not catch the JSON parsing exception'); } ","text_count":150,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"try { \n  readJSONThrows('nonJSON.txt', function(err, result) { \n    //... \n  }); \n} catch(err) { \n  console.log('This will not catch the JSON parsing exception'); \n}"}]}]},{"block_type":"element","block":"k5zy5ak7","search_text":"The preceding catch statement will never receive the JSON parsing exception, as it will travel back to the stack in which the exception was thrown. We just saw that the stack ends up in the event loop and not with the function that triggers the asynchronous operation.","text_count":268,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"catch"}]},{"block_type":"text","content":"statement will never receive the JSON parsing exception, as it will travel back to the stack in which the exception was thrown. We just saw that the stack ends up in the event loop and not with the function that triggers the asynchronous operation."}]},{"block_type":"element","block":"k5zy5ak8","search_text":"As said before, the application aborts the moment an exception reaches the event loop; however, we still have a chance to perform some cleanup or logging before the application terminates. In fact, when this happens, Node.js emits a special event called uncaughtException just before exiting the process. The following code shows a sample use case:","text_count":348,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As said before, the application aborts the moment an exception reaches the event loop; however, we still have a chance to perform some cleanup or logging before the application terminates. In fact, when this happens, Node.js emits a special event called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"uncaughtException"}]},{"block_type":"text","content":"just before exiting the process. The following code shows a sample use case:"}]},{"block_type":"element","block":"k5zy5ak9","search_text":"process.on('uncaughtException', (err) => { console.error('This will catch at last the ' + 'JSON parsing exception: ' + err.message); // Terminates the application with 1 (error) as exit code: // without the following line, the application would continue process.exit(1); }); ","text_count":275,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"process.on('uncaughtException', (err) =&gt; { \n  console.error('This will catch at last the ' + \n    'JSON parsing exception: ' + err.message); \n  // Terminates the application with 1 (error) as exit code: \n  // without the following line, the application would continue \n  process.exit(1); \n});"}]}]},{"block_type":"element","block":"k5zy5aka","search_text":"It's important to understand that an uncaught exception leaves the application in a state that is not guaranteed to be consistent, which can lead to unforeseeable problems. For example, there might still be incomplete I/O requests running or closures might have become inconsistent. That's why it is always advised, especially in production, to exit from the application after an uncaught exception is received anyway.","text_count":418,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to understand that an uncaught exception leaves the application in a state that is not guaranteed to be consistent, which can lead to unforeseeable problems. For example, there might still be incomplete I/O requests running or closures might have become inconsistent. That's why it is always advised, especially in production, to exit from the application after an uncaught exception is received anyway."}]},{"block_type":"element","block":"k5zy5akb","search_text":"The module system and its patterns","text_count":34,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"The module system and its patterns"}]},{"block_type":"element","block":"k5zy5akc","search_text":"Modules are the bricks for structuring non-trivial applications, but also the main mechanism to enforce information hiding by keeping private all the functions and variables that are not explicitly marked to be exported. In this section, we will introduce the Node.js module system and its most common usage patterns.","text_count":317,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Modules are the bricks for structuring non-trivial applications, but also the main mechanism to enforce information hiding by keeping private all the functions and variables that are not explicitly marked to be exported. In this section, we will introduce the Node.js module system and its most common usage patterns."}]},{"block_type":"element","block":"k5zy5akd","search_text":"The revealing module pattern","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The revealing module pattern"}]},{"block_type":"element","block":"k5zy5ake","search_text":"One of the major problems with JavaScript is the absence of namespacing. Programs that run in the global scope polluting it with data that comes from both internal application code and dependencies. A popular technique to solve this problem is called the revealing module pattern, and it looks like the following:","text_count":313,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the major problems with JavaScript is the absence of namespacing. Programs that run in the global scope polluting it with data that comes from both internal application code and dependencies. A popular technique to solve this problem is called the revealing module pattern, and it looks like the following:"}]},{"block_type":"element","block":"k5zy5akf","search_text":"const module = (() => { const privateFoo = () => {...}; const privateBar = []; const exported = { publicFoo: () => {...}, publicBar: () => {...} }; return exported; })(); console.log(module); ","text_count":192,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const module = (() =&gt; { \n  const privateFoo = () =&gt; {...}; \n  const privateBar = []; \n \n  const exported = { \n    publicFoo: () =&gt; {...}, \n    publicBar: () =&gt; {...} \n  }; \n \n  return exported; \n})(); \nconsole.log(module);"}]}]},{"block_type":"element","block":"k5zy5akg","search_text":"This pattern leverages a self-invoking function to create a private scope, exporting only the parts that are meant to be public. In the preceding code, the module variable contains only the exported API, while the rest of the module content is practically inaccessible from outside. As we will see in a moment, the idea behind this pattern is used as a base for the Node.js module system.","text_count":388,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This pattern leverages a self-invoking function to create a private scope, exporting only the parts that are meant to be public. In the preceding code, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module"}]},{"block_type":"text","content":"variable contains only the exported API, while the rest of the module content is practically inaccessible from outside. As we will see in a moment, the idea behind this pattern is used as a base for the Node.js module system."}]},{"block_type":"element","block":"k5zy5akh","search_text":"Node.js modules explained","text_count":25,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Node.js modules explained"}]},{"block_type":"element","block":"k5zy5aki","search_text":"CommonJS is a group with the aim to standardize the JavaScript ecosystem, and one of their most popular proposals is called CommonJS modules . Node.js built its module system on top of this specification, with the addition of some custom extensions. To describe how it works, we can make an analogy with the revealing module pattern, where each module runs in a private scope, so that every variable that is defined locally does not pollute the global namespace.","text_count":462,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"CommonJS is a group with the aim to standardize the JavaScript ecosystem, and one of their most popular proposals is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"CommonJS modules"}]},{"block_type":"text","content":". Node.js built its module system on top of this specification, with the addition of some custom extensions. To describe how it works, we can make an analogy with the revealing module pattern, where each module runs in a private scope, so that every variable that is defined locally does not pollute the global namespace."}]},{"block_type":"element","block":"k5zy5akj","search_text":"A homemade module loader","text_count":24,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"A homemade module loader"}]},{"block_type":"element","block":"k5zy5akk","search_text":"To explain how this works, let's build a similar system from scratch. The code that follows creates a function that mimics a subset of the functionality of the original require() function of Node.js.","text_count":199,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To explain how this works, let's build a similar system from scratch. The code that follows creates a function that mimics a subset of the functionality of the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function of Node.js."}]},{"block_type":"element","block":"k5zy5akl","search_text":"Let's start by creating a function that loads the content of a module, wraps it into a private scope, and evaluates it:","text_count":119,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start by creating a function that loads the content of a module, wraps it into a private scope, and evaluates it:"}]},{"block_type":"element","block":"k5zy5akm","search_text":"function loadModule(filename, module, require) { const wrappedSrc=`(function(module, exports, require) { ${fs.readFileSync(filename, 'utf8')} })(module, module.exports, require);`; eval(wrappedSrc); } ","text_count":201,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function loadModule(filename, module, require) { \n  const wrappedSrc=`(function(module, exports, require) { \n      ${fs.readFileSync(filename, 'utf8')} \n    })(module, module.exports, require);`; \n  eval(wrappedSrc); \n}"}]}]},{"block_type":"element","block":"k5zy5akn","search_text":"The source code of a module is essentially wrapped into a function, as it was for the revealing module pattern. The difference here is that we pass a list of variables to the module, in particular, module , exports , and require . Make a note of how the exports argument of the wrapping function is initialized with the content of module.exports , as we will talk about this later.","text_count":381,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The source code of a module is essentially wrapped into a function, as it was for the revealing module pattern. The difference here is that we pass a list of variables to the module, in particular,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"exports"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require"}]},{"block_type":"text","content":". Make a note of how the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"exports"}]},{"block_type":"text","content":"argument of the wrapping function is initialized with the content of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":", as we will talk about this later."}]},{"block_type":"element","block":"k5zy5ako","search_text":"Note Bear in mind that this is only an example, and you will rarely need to evaluate some source code in a real application. Features such as eval() or the functions of the vm module ( http://nodejs.org/api/vm.html ) can be easily used in the wrong way or with the wrong input, thus opening a system to code injection attacks. They should always be used with extreme care or avoided altogether. ","text_count":395,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Bear in mind that this is only an example, and you will rarely need to evaluate some source code in a real application. Features such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"eval()"}]},{"block_type":"text","content":"or the functions of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"vm"}]},{"block_type":"text","content":"module ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nodejs.org/api/vm.html"},"children":[{"block_type":"text","content":"http://nodejs.org/api/vm.html"}]},{"block_type":"text","content":") can be easily used in the wrong way or with the wrong input, thus opening a system to code injection attacks. They should always be used with extreme care or avoided altogether."}]}]},{"block_type":"element","block":"k5zy5akp","search_text":"Let's now see what these variables contain by implementing our require() function:","text_count":82,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now see what these variables contain by implementing our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k5zy5akq","search_text":"const require = (moduleName) => { console.log(`Require invoked for module: ${moduleName}`); const id = require.resolve(moduleName); //[1] if(require.cache[id]) { //[2] return require.cache[id].exports; } //module metadata const module = { //[3] exports: {}, id: id }; //Update the cache require.cache[id] = module; //[4] //load the module loadModule(id, module, require); //[5] //return exported variables return module.exports; //[6] }; require.cache = {}; require.resolve = (moduleName) => { /* resolve a full module id from the moduleName */ }; ","text_count":548,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const require = (moduleName) =&gt; { \n  console.log(`Require invoked for module: ${moduleName}`); \n  const id = require.resolve(moduleName);      //[1] \n  if(require.cache[id]) {                      //[2] \n    return require.cache[id].exports; \n  } \n \n  //module metadata \n  const module = {                             //[3] \n    exports: {}, \n    id: id \n  }; \n  //Update the cache \n  require.cache[id] = module;                  //[4] \n \n  //load the module \n  loadModule(id, module, require);             //[5] \n \n  //return exported variables \n  return module.exports;                       //[6] \n}; \nrequire.cache = {}; \nrequire.resolve = (moduleName) =&gt; { \n  /* resolve a full module id from the moduleName */ \n};"}]}]},{"block_type":"element","block":"k5zy5akr","search_text":"The previous function simulates the behavior of the original require() function of Node.js, which is used to load a module. Of course, this is just for educative purposes and it does not accurately or completely reflect the internal behavior of the real require() function, but it's great to understand the internals of the Node.js module system, how a module is defined, and loaded. What our homemade module system does is explained as follows:","text_count":445,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The previous function simulates the behavior of the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function of Node.js, which is used to load a module. Of course, this is just for educative purposes and it does not accurately or completely reflect the internal behavior of the real"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function, but it's great to understand the internals of the Node.js module system, how a module is defined, and loaded. What our homemade module system does is explained as follows:"}]},{"block_type":"element","block":"k5zy5aks","search_text":"A module name is accepted as input, and the very first thing that we do is resolve the full path of the module, which we call id . This task is delegated to require.resolve() , which implements a specific resolving algorithm (we will talk about it later). If the module has already been loaded in the past, it should be available in the cache. In this case, we just return it immediately. If the module was not loaded yet, we set up the environment for the first load. In particular, we create a module object that contains an exports property initialized with an empty object literal. This property will be used by the code of the module to export any public API. The module object is cached. The module source code is read from its file and the code is evaluated, as we have seen before. We provide the module with the module object that we just created, and a reference to the require() function. The module exports its public API by manipulating or replacing the module.exports object. Finally, the content of module.exports , which represents the public API of the module, is returned to the caller. ","text_count":1105,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A module name is accepted as input, and the very first thing that we do is resolve the full path of the module, which we call"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"id"}]},{"block_type":"text","content":". This task is delegated to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require.resolve()"}]},{"block_type":"text","content":", which implements a specific resolving algorithm (we will talk about it later)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If the module has already been loaded in the past, it should be available in the cache. In this case, we just return it immediately."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If the module was not loaded yet, we set up the environment for the first load. In particular, we create a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module"}]},{"block_type":"text","content":"object that contains an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"exports"}]},{"block_type":"text","content":"property initialized with an empty object literal. This property will be used by the code of the module to export any public API."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module"}]},{"block_type":"text","content":"object is cached."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The module source code is read from its file and the code is evaluated, as we have seen before. We provide the module with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module"}]},{"block_type":"text","content":"object that we just created, and a reference to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function. The module exports its public API by manipulating or replacing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"object."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, the content of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":", which represents the public API of the module, is returned to the caller."}]}]},{"block_type":"element","block":"k5zy5akt","search_text":"As we see, there is nothing magical behind the workings of the Node.js module system; the trick is all in the wrapper we create around a module's source code and the artificial environment in which we run it.","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we see, there is nothing magical behind the workings of the Node.js module system; the trick is all in the wrapper we create around a module's source code and the artificial environment in which we run it."}]},{"block_type":"element","block":"k5zy5aku","search_text":"Defining a module","text_count":17,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Defining a module"}]},{"block_type":"element","block":"k5zy5akv","search_text":"By looking at how our custom require() function works, we should now know how to define a module. The following code gives us an example:","text_count":137,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By looking at how our custom"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function works, we should now know how to define a module. The following code gives us an example:"}]},{"block_type":"element","block":"k5zy5akw","search_text":"//load another dependency const dependency = require('./anotherModule'); //a private function function log() { console.log(`Well done ${dependency.username}`); } //the API to be exported for public use module.exports.run = () => { log(); }; ","text_count":241,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//load another dependency \nconst dependency = require('./anotherModule'); \n \n//a private function \nfunction log() { \n  console.log(`Well done ${dependency.username}`); \n} \n \n//the API to be exported for public use \nmodule.exports.run = () =&gt; { \n  log(); \n};"}]}]},{"block_type":"element","block":"k5zy5akx","search_text":"The essential concept to remember is that everything inside a module is private unless it's assigned to the module.exports variable. The content of this variable is then cached and returned when the module is loaded using require() .","text_count":233,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The essential concept to remember is that everything inside a module is private unless it's assigned to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"variable. The content of this variable is then cached and returned when the module is loaded using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aky","search_text":"Defining globals","text_count":16,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Defining globals"}]},{"block_type":"element","block":"k5zy5akz","search_text":"Even if all the variables and functions that are declared in a module are defined in its local scope, it is still possible to define a global variable. In fact, the module system exposes a special variable called global , which can be used for this purpose. Everything that is assigned to this variable will end up automatically in the global scope.","text_count":349,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even if all the variables and functions that are declared in a module are defined in its local scope, it is still possible to define a global variable. In fact, the module system exposes a special variable called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"global"}]},{"block_type":"text","content":", which can be used for this purpose. Everything that is assigned to this variable will end up automatically in the global scope."}]},{"block_type":"element","block":"k5zy5al0","search_text":"Note Polluting the global scope is considered bad practice and nullifies the advantage of having a module system. So, use it only if you really know what you are doing. ","text_count":169,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Polluting the global scope is considered bad practice and nullifies the advantage of having a module system. So, use it only if you really know what you are doing."}]}]},{"block_type":"element","block":"k5zy5al1","search_text":"module.exports versus exports","text_count":29,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"module.exports versus exports"}]},{"block_type":"element","block":"k5zy5al2","search_text":"For many developers who are not yet familiar with Node.js, a common source of confusion is the difference between using exports and module.exports to expose a public API. The code of our custom require function should again clear any doubt. The variable exports is just a reference to the initial value of module.exports ; we have seen that such a value is essentially a simple object literal created before the module is loadeThis means that we can only attach new properties to the object referenced by the exports variable, as shown in the following code:","text_count":558,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For many developers who are not yet familiar with Node.js, a common source of confusion is the difference between using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"exports"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"to expose a public API. The code of our custom"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require"}]},{"block_type":"text","content":"function should again clear any doubt. The variable"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"exports"}]},{"block_type":"text","content":"is just a reference to the initial value of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"; we have seen that such a value is essentially a simple object literal created before the module is loadeThis means that we can only attach new properties to the object referenced by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"exports"}]},{"block_type":"text","content":"variable, as shown in the following code:"}]},{"block_type":"element","block":"k5zy5al3","search_text":"exports.hello = () => { console.log('Hello'); } ","text_count":48,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"exports.hello = () =&gt; { \n  console.log('Hello'); \n}"}]}]},{"block_type":"element","block":"k5zy5al4","search_text":"Reassigning the exports variable doesn't have any effect, because it doesn't change the content of module.exports ; it will only reassign the variable itself. The following code is therefore wrong:","text_count":197,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Reassigning the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"exports"}]},{"block_type":"text","content":"variable doesn't have any effect, because it doesn't change the content of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"; it will only reassign the variable itself. The following code is therefore wrong:"}]},{"block_type":"element","block":"k5zy5al5","search_text":"exports = () => { console.log('Hello'); } ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"exports = () =&gt; { \n  console.log('Hello'); \n}"}]}]},{"block_type":"element","block":"k5zy5al6","search_text":"If we want to export something other than an object literal, such as a function, an instance, or even a string, we have to reassign module.exports as follows:","text_count":158,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we want to export something other than an object literal, such as a function, an instance, or even a string, we have to reassign"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"as follows:"}]},{"block_type":"element","block":"k5zy5al7","search_text":"module.exports = () => { console.log('Hello'); } ","text_count":49,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = () =&gt; { \n  console.log('Hello'); \n}"}]}]},{"block_type":"element","block":"k5zy5al8","search_text":"The require function is synchronous","text_count":35,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The require function is synchronous"}]},{"block_type":"element","block":"k5zy5al9","search_text":"Another important detail that we should take into account is that our homemade require function is synchronous. In fact, it returns the module contents using a simple direct style, and no callback is required. This is true for the original Node.js require() function too. As a consequence, any assignment to module.exports must be synchronous as well. For example, the following code is incorrect:","text_count":397,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another important detail that we should take into account is that our homemade"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require"}]},{"block_type":"text","content":"function is synchronous. In fact, it returns the module contents using a simple direct style, and no callback is required. This is true for the original Node.js"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function too. As a consequence, any assignment to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"must be synchronous as well. For example, the following code is incorrect:"}]},{"block_type":"element","block":"k5zy5ala","search_text":"setTimeout(() => { module.exports = function() {...}; }, 100); ","text_count":63,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"setTimeout(() =&gt; { \n  module.exports = function() {...}; \n}, 100);"}]}]},{"block_type":"element","block":"k5zy5alb","search_text":"This property has important repercussions in the way we define modules, as it limits us to mostly using synchronous code during the definition of a module. This is actually one of the most important reasons why the core Node.js libraries offer synchronous APIs as an alternative to most of the asynchronous ones.","text_count":312,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This property has important repercussions in the way we define modules, as it limits us to mostly using synchronous code during the definition of a module. This is actually one of the most important reasons why the core Node.js libraries offer synchronous APIs as an alternative to most of the asynchronous ones."}]},{"block_type":"element","block":"k5zy5alc","search_text":"If we need some asynchronous initialization steps for a module, we can always define and export an uninitialized module that is initialized asynchronously at a later time. The problem with this approach, though, is that loading such a module using require does not guarantee that it's ready to be used. In Chapter 9, Advanced Asynchronous Recipes , we will analyze this problem in detail and present some patterns to solve this issue elegantly.","text_count":444,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we need some asynchronous initialization steps for a module, we can always define and export an uninitialized module that is initialized asynchronously at a later time. The problem with this approach, though, is that loading such a module using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require"}]},{"block_type":"text","content":"does not guarantee that it's ready to be used. In Chapter 9,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Advanced Asynchronous Recipes"}]},{"block_type":"text","content":", we will analyze this problem in detail and present some patterns to solve this issue elegantly."}]},{"block_type":"element","block":"k5zy5ald","search_text":"For the sake of curiosity, you might want to know that in its early days, Node.js used to have an asynchronous version of require() , but it was soon removed because it was overcomplicating a functionality that was actually meant to be used only at initialization time and where asynchronous I/O brings more complexities than advantages.","text_count":337,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For the sake of curiosity, you might want to know that in its early days, Node.js used to have an asynchronous version of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":", but it was soon removed because it was overcomplicating a functionality that was actually meant to be used only at initialization time and where asynchronous I/O brings more complexities than advantages."}]},{"block_type":"element","block":"k5zy5ale","search_text":"The resolving algorithm","text_count":23,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The resolving algorithm"}]},{"block_type":"element","block":"k5zy5alf","search_text":"The term dependency hell describes a situation whereby the dependencies of software in turn depend on a shared dependency, but require different incompatible versions. Node.js solves this problem elegantly by loading a different version of a module depending on where the module is loaded from. All the merits of this feature go to npm, and also to the resolving algorithm used in the require function.","text_count":402,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The term"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"dependency hell"}]},{"block_type":"text","content":"describes a situation whereby the dependencies of software in turn depend on a shared dependency, but require different incompatible versions. Node.js solves this problem elegantly by loading a different version of a module depending on where the module is loaded from. All the merits of this feature go to npm, and also to the resolving algorithm used in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","block":"k5zy5alg","search_text":"Let's now give a quick overview of this algorithm. As we saw, the resolve() function takes a module name (which we will call here, moduleName ) as input and it returns the full path of the module. This path is then used to load its code and also to identify the module uniquely. The resolving algorithm can be divided into the following three major branches:","text_count":358,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now give a quick overview of this algorithm. As we saw, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"resolve()"}]},{"block_type":"text","content":"function takes a module name (which we will call here,&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"moduleName"}]},{"block_type":"text","content":") as input and it returns the full path of the module. This path is then used to load its code and also to identify the module uniquely. The resolving algorithm can be divided into the following three major branches:"}]},{"block_type":"element","block":"k5zy5alh","search_text":"File modules : If moduleName starts with / , it is already considered an absolute path to the module and it's returned as it is. If it starts with ./ , then moduleName is considered a relative path, which is calculated starting from the requiring module. Core modules : If moduleName is not prefixed with / or ./ , the algorithm will first try to search within the core Node.js modules. Package modules : If no core module is found matching moduleName , then the search continues by looking for a matching module in the first node_modules directory that is found navigating up in the directory structure starting from the requiring module. The algorithm continues to search for a match by looking into the next node_modules directory up in the directory tree, until it reaches the root of the filesystem. ","text_count":805,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"File modules"}]},{"block_type":"text","content":": If"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"moduleName"}]},{"block_type":"text","content":"starts with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/"}]},{"block_type":"text","content":"&nbsp;, it is already considered an absolute path to the module and it's returned as it is. If it starts with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"./"}]},{"block_type":"text","content":", then"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"moduleName"}]},{"block_type":"text","content":"is considered a relative path, which is calculated starting from the requiring module."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Core modules"}]},{"block_type":"text","content":": If"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"moduleName"}]},{"block_type":"text","content":"is not prefixed with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"./"}]},{"block_type":"text","content":", the algorithm will first try to search within the core Node.js modules."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Package modules"}]},{"block_type":"text","content":": If no core module is found matching"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"moduleName"}]},{"block_type":"text","content":", then the search continues by looking for a matching module in the first"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules"}]},{"block_type":"text","content":"directory that is found navigating up in the directory structure starting from the requiring module. The algorithm continues to search for a match by looking into the next"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules"}]},{"block_type":"text","content":"directory up in the directory tree, until it reaches the root of the filesystem."}]}]},{"block_type":"element","block":"k5zy5ali","search_text":"For file and package modules, both the individual files and directories can match moduleName . In particular, the algorithm will try to match the following:","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For file and package modules, both the individual files and directories can match"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"moduleName"}]},{"block_type":"text","content":". In particular, the algorithm will try to match the following:"}]},{"block_type":"element","block":"k5zy5alj","search_text":"<moduleName>.js <moduleName>/index.js The directory/file specified in the main property of <moduleName>/package.json ","text_count":117,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"&lt;moduleName&gt;.js"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"&lt;moduleName&gt;/index.js"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The directory/file specified in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main"}]},{"block_type":"text","content":"property of&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"&lt;moduleName&gt;/package.json"}]}]}]},{"block_type":"element","block":"k5zy5alk","search_text":"The complete, formal documentation of the resolving algorithm can be found at http://nodejs.org/api/modules.html#modules_all_together .","text_count":135,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The complete, formal documentation of the resolving algorithm can be found at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nodejs.org/api/modules.html#modules_all_together"},"children":[{"block_type":"text","content":"http://nodejs.org/api/modules.html#modules_all_together"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5all","search_text":"The node_modules directory is actually where npm installs the dependencies of each package. This means that, based on the algorithm we just described, each package can have its own private dependencies. For example, consider the following directory structure:","text_count":259,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules"}]},{"block_type":"text","content":"directory is actually where npm installs the dependencies of each package. This means that, based on the algorithm we just described, each package can have its own private dependencies. For example, consider the following directory structure:"}]},{"block_type":"element","block":"k5zy5alm","search_text":"myApp ├── foo.js └── node_modules ├── depA │ └── index.js ├── depB │ ├── bar.js │ └── node_modules │ └── depA │ └── index.js └── depC ├── foobar.js └── node_modules └── depA └── index.js ","text_count":187,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"myApp \n├── foo.js \n└── node_modules \n    ├── depA \n    │   └── index.js \n    ├── depB \n    │   ├── bar.js \n    │   └── node_modules \n    │       └── depA \n    │           └── index.js \n    └── depC \n        ├── foobar.js \n        └── node_modules \n            └── depA \n                └── index.js"}]}]},{"block_type":"element","block":"k5zy5aln","search_text":"In the previous example, myApp , depB , and depC all depend on depA ; however, they all have their own private version of the dependency! Following the rules of the resolving algorithm, using require('depA') will load a different file depending on the module that requires it, for example:","text_count":289,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"myApp"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"depB"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"depC"}]},{"block_type":"text","content":"all depend on"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"depA"}]},{"block_type":"text","content":"; however, they all have their own private version of the dependency! Following the rules of the resolving algorithm, using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require('depA')"}]},{"block_type":"text","content":"will load a different file depending on the module that requires it, for example:"}]},{"block_type":"element","block":"k5zy5alo","search_text":"Calling require('depA') from /myApp/foo.js will load /myApp/node_modules/depA/index.js Calling require('depA') from /myApp/node_modules/depB/bar.js will load /myApp/node_modules/depB/node_modules/depA/index.js Calling require('depA') from /myApp/node_modules/depC/foobar.js will load /myApp/node_modules/depC/node_modules/depA/index.js ","text_count":336,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Calling"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require('depA')"}]},{"block_type":"text","content":"from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/myApp/foo.js"}]},{"block_type":"text","content":"will load"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/myApp/node_modules/depA/index.js"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Calling"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require('depA')"}]},{"block_type":"text","content":"from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/myApp/node_modules/depB/bar.js"}]},{"block_type":"text","content":"will load"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/myApp/node_modules/depB/node_modules/depA/index.js"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Calling"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require('depA')"}]},{"block_type":"text","content":"from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/myApp/node_modules/depC/foobar.js"}]},{"block_type":"text","content":"will load"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/myApp/node_modules/depC/node_modules/depA/index.js"}]}]}]},{"block_type":"element","block":"k5zy5alp","search_text":"The resolving algorithm is the core part behind the robustness of the Node.js dependency management, and is what makes it possible to have hundreds or even thousands of packages in an application without having collisions or problems of version compatibility. The resolving algorithm is applied transparently for us when we invoke require() ; however, if needed, it can still be used directly by any module by simply invoking require.resolve() .","text_count":445,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The resolving algorithm is the core part behind the robustness of the Node.js dependency management, and is what makes it possible to have hundreds or even thousands of packages in an application without having collisions or problems of version compatibility. The resolving algorithm is applied transparently for us when we invoke"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"; however, if needed, it can still be used directly by any module by simply invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require.resolve()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5alq","search_text":"The module cache","text_count":16,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The module cache"}]},{"block_type":"element","block":"k5zy5alr","search_text":"Each module is only loaded and evaluated the first time it is required, since any subsequent call of require() will simply return the cached version. This should be clear by looking at the code of our homemade require function. Caching is crucial for performance, but it also has some important functional implications:","text_count":319,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Each module is only loaded and evaluated the first time it is required, since any subsequent call of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"will simply return the cached version. This should be clear by looking at the code of our homemade"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require"}]},{"block_type":"text","content":"function. Caching is crucial for performance, but it also has some important functional implications:"}]},{"block_type":"element","block":"k5zy5als","search_text":"It makes it possible to have cycles within module dependencies It guarantees, to some extent, that the same instance is always returned when requiring the same module from within a given package ","text_count":195,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"It makes it possible to have cycles within module dependencies"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"It guarantees, to some extent, that the same instance is always returned when requiring the same module from within a given package"}]}]},{"block_type":"element","block":"k5zy5alt","search_text":"The module cache is exposed via the require.cache variable, so it is possible to directly access it if needed. A common use case is to invalidate any cached module by deleting the relative key in the require.cache variable, a practice very useful during testing but very dangerous if applied in normal circumstances.","text_count":316,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The module cache is exposed via the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require.cache"}]},{"block_type":"text","content":"variable, so it is possible to directly access it if needed. A common use case is to invalidate any cached module by deleting the relative key in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require.cache"}]},{"block_type":"text","content":"variable, a practice very useful during testing but very dangerous if applied in normal circumstances."}]},{"block_type":"element","block":"k5zy5alu","search_text":"Circular dependencies","text_count":21,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Circular dependencies"}]},{"block_type":"element","block":"k5zy5alv","search_text":"Many consider circular dependencies an intrinsic design issue, but it is something which might actually happen in a real project, so it's useful for us to know at least how this works in Node.js. If we look again at our homemade require() function, we immediately get a glimpse of how this might work and what its caveats are.","text_count":326,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Many consider circular dependencies an intrinsic design issue, but it is something which might actually happen in a real project, so it's useful for us to know at least how this works in Node.js. If we look again at our homemade"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function, we immediately get a glimpse of how this might work and what its caveats are."}]},{"block_type":"element","block":"k5zy5alw","search_text":"Suppose we have two modules defined as follows:","text_count":47,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Suppose we have two modules defined as follows:"}]},{"block_type":"element","block":"k5zy5alx","search_text":"Module a.js : ","text_count":14,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"a.js"}]},{"block_type":"text","content":":"}]}]},{"block_type":"element","block":"k5zy5aly","search_text":"exports.loaded = false; const b = require('./b'); module.exports = { bWasLoaded: b.loaded, loaded: true }; ","text_count":107,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"exports.loaded = false; \n       const b = require('./b'); \n       module.exports = { \n         bWasLoaded: b.loaded, \n         loaded: true \n       };"}]}]},{"block_type":"element","block":"k5zy5alz","search_text":"Module b.js : ","text_count":14,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"b.js"}]},{"block_type":"text","content":":"}]}]},{"block_type":"element","block":"k5zy5am0","search_text":"exports.loaded = false; const a = require('./a'); module.exports = { aWasLoaded: a.loaded, loaded: true }; ","text_count":107,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"exports.loaded = false; \n       const a = require('./a'); \n       module.exports = { \n         aWasLoaded: a.loaded, \n         loaded: true \n       };"}]}]},{"block_type":"element","block":"k5zy5am1","search_text":"Now, let's try to load these from another module, main.js , as follows: ","text_count":72,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's try to load these from another module,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main.js"}]},{"block_type":"text","content":", as follows:"}]},{"block_type":"element","block":"k5zy5am2","search_text":"const a = require('./a'); const b = require('./b'); console.log(a); console.log(b); ","text_count":84,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const a = require('./a'); \nconst b = require('./b'); \nconsole.log(a); \nconsole.log(b);"}]}]},{"block_type":"element","block":"k5zy5am3","search_text":"The preceding code will print the following output:","text_count":51,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code will print the following output:"}]},{"block_type":"element","block":"k5zy5am4","search_text":"{ bWasLoaded: true, loaded: true } { aWasLoaded: false, loaded: true } ","text_count":71,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"{ bWasLoaded: true, loaded: true }\n{ aWasLoaded: false, loaded: true }"}]}]},{"block_type":"element","block":"k5zy5am5","search_text":"This result reveals the caveats of circular dependencies. While both the modules are completely initialized the moment they are required from the main module, the a.js module will be incomplete when it is loaded from b.js . In particular, its state will be the one that it reached the moment it required b.js . This behavior should ring another bell, which will be confirmed if we swap the order in which the two modules are required in main.js .","text_count":446,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This result reveals the caveats of circular dependencies. While both the modules are completely initialized the moment they are required from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main"}]},{"block_type":"text","content":"module, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"a.js"}]},{"block_type":"text","content":"module will be incomplete when it is loaded from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"b.js"}]},{"block_type":"text","content":". In particular, its state will be the one that it reached the moment it required"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"b.js"}]},{"block_type":"text","content":". This behavior should ring another bell, which will be confirmed if we swap the order in which the two modules are required in"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main.js"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5am6","search_text":"If you try it, you will see that this time it will be the module a.js that will receive an incomplete version of b.js . We understand now that this can become quite a fuzzy business if we lose control of which module is loaded first, which can happen quite easily if the project is big enough.","text_count":293,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you try it, you will see that this time it will be the module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"a.js"}]},{"block_type":"text","content":"that will receive an incomplete version of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"b.js"}]},{"block_type":"text","content":". We understand now that this can become quite a fuzzy business if we lose control of which module is loaded first, which can happen quite easily if the project is big enough."}]},{"block_type":"element","block":"k5zy5am7","search_text":"Module definition patterns","text_count":26,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Module definition patterns"}]},{"block_type":"element","block":"k5zy5am8","search_text":"The module system, besides being a mechanism for loading dependencies, is also a tool for defining APIs. As for any other problem related to API design, the main factor to consider is the balance between private and public functionality. The aim is to maximize information hiding and API usability, while balancing these with other software qualities such as extensibility and code reuse .","text_count":389,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The module system, besides being a mechanism for loading dependencies, is also a tool for defining APIs. As for any other problem related to API design, the main factor to consider is the balance between private and public functionality. The aim is to maximize information hiding and API usability, while balancing these with other software qualities such as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"extensibility"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"code reuse"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5am9","search_text":"In this section, we will analyze some of the most popular patterns for defining modules in Node.js; each one has its own balance of information hiding, extensibility, and code reuse.","text_count":182,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will analyze some of the most popular patterns for defining modules in Node.js; each one has its own balance of information hiding, extensibility, and code reuse."}]},{"block_type":"element","block":"k5zy5ama","search_text":"Named exports","text_count":13,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Named exports"}]},{"block_type":"element","block":"k5zy5amb","search_text":"The most basic method for exposing a public API is using named exports , which consists of assigning all the values we want to make public to properties of the object referenced by exports (or module.exports ). In this way, the resulting exported object becomes a container or namespace for a set of related functionality.","text_count":322,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most basic method for exposing a public API is using"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"named exports"}]},{"block_type":"text","content":", which consists of assigning all the values we want to make public to properties of the object referenced by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"exports"}]},{"block_type":"text","content":"(or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"). In this way, the resulting exported object becomes a container or namespace for a set of related functionality."}]},{"block_type":"element","block":"k5zy5amc","search_text":"The following code shows a module implementing this pattern:","text_count":60,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following code shows a module implementing this pattern:"}]},{"block_type":"element","block":"k5zy5amd","search_text":"//file logger.js exports.info = (message) => { console.log('info: ' + message); }; exports.verbose = (message) => { console.log('verbose: ' + message); }; ","text_count":155,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file logger.js \nexports.info = (message) =&gt; { \n  console.log('info: ' + message); \n}; \n \nexports.verbose = (message) =&gt; { \n  console.log('verbose: ' + message); \n};"}]}]},{"block_type":"element","block":"k5zy5ame","search_text":"The exported functions are then available as properties of the loaded module, as shown in the following code:","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The exported functions are then available as properties of the loaded module, as shown in the following code:"}]},{"block_type":"element","block":"k5zy5amf","search_text":"//file main.js const logger = require('./logger'); logger.info('This is an informational message'); logger.verbose('This is a verbose message'); ","text_count":145,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file main.js \nconst logger = require('./logger'); \nlogger.info('This is an informational message'); \nlogger.verbose('This is a verbose message');"}]}]},{"block_type":"element","block":"k5zy5amg","search_text":"Most of the Node.js core modules use this pattern.","text_count":50,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Most of the Node.js core modules use this pattern."}]},{"block_type":"element","block":"k5zy5amh","search_text":"The CommonJS specification only allows the use of the exports variable to expose public members. Therefore, the named exports pattern is the only one that is really compatible with the CommonJS specification. The use of module.exports is an extension provided by Node.js to support a broader range of module definition patterns, as those we are going to see next.","text_count":363,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The CommonJS specification only allows the use of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"exports"}]},{"block_type":"text","content":"variable to expose public members. Therefore, the named exports pattern is the only one that is really compatible with the CommonJS specification. The use of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"is an extension provided by Node.js to support a broader range of module definition patterns, as those we are going to see next."}]},{"block_type":"element","block":"k5zy5ami","search_text":"Exporting a function","text_count":20,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Exporting a function"}]},{"block_type":"element","block":"k5zy5amj","search_text":"One of the most popular module definition patterns consists of reassigning the whole module.exports variable to a function. Its main strength is the fact that it exposes only a single functionality, which provides a clear entry point for the module, making it simpler to understand and use; it also honors the principle of small surface area very well. This way of defining modules is also known in the community as the substack pattern , after one of its most prolific adopters, James Halliday (nickname substack). Have a look at this pattern in the following example:","text_count":569,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the most popular module definition patterns consists of reassigning the whole"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"variable to a function. Its main strength is the fact that it exposes only a single functionality, which provides a clear entry point for the module, making it simpler to understand and use; it also honors the principle of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"small surface"}]},{"block_type":"text","content":"area very well. This way of defining modules is also known in the community as the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"substack pattern"}]},{"block_type":"text","content":", after one of its most prolific adopters, James Halliday (nickname substack). Have a look at this pattern in the following example:"}]},{"block_type":"element","block":"k5zy5amk","search_text":"//file logger.js module.exports = (message) => { console.log(`info: ${message}`); }; ","text_count":85,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file logger.js \nmodule.exports = (message) =&gt; { \n  console.log(`info: ${message}`); \n};"}]}]},{"block_type":"element","block":"k5zy5aml","search_text":"A possible extension of this pattern is using the exported function as namespace for other public APIs. This is a very powerful combination, because it still gives the module the clarity of a single entry point (the main exported function). This approach also allows us to expose other functionalities that have secondary or more advanced use cases. The following code shows you how to extend the module we defined previously by using the exported function as a namespace:","text_count":472,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A possible extension of this pattern is using the exported function as namespace for other public APIs. This is a very powerful combination, because it still gives the module the clarity of a single entry point (the main exported function). This approach also allows us to expose other functionalities that have secondary or more advanced use cases. The following code shows you how to extend the module we defined previously by using the exported function as a namespace:"}]},{"block_type":"element","block":"k5zy5amm","search_text":"module.exports.verbose = (message) => { console.log(`verbose: ${message}`); }; ","text_count":79,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports.verbose = (message) =&gt; { \n  console.log(`verbose: ${message}`); \n};"}]}]},{"block_type":"element","block":"k5zy5amn","search_text":"This code demonstrates how to use the module that we just defined:","text_count":66,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This code demonstrates how to use the module that we just defined:"}]},{"block_type":"element","block":"k5zy5amo","search_text":"//file main.js const logger = require('./logger'); logger('This is an informational message'); logger.verbose('This is a verbose message'); ","text_count":140,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file main.js \nconst logger = require('./logger'); \nlogger('This is an informational message'); \nlogger.verbose('This is a verbose message');"}]}]},{"block_type":"element","block":"k5zy5amp","search_text":"Even though just exporting a function might seem like a limitation, in reality it's a perfect way to put the emphasis on a single functionality, the most important one for the module, while giving less visibility to secondary or internal aspects, which are instead exposed as properties of the exported function itself. The modularity of Node.js heavily encourages the adoption of the Single Responsibility Principle ( SRP ): every module should have responsibility over a single functionality and that responsibility should be entirely encapsulated by the module.","text_count":564,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even though just exporting a function might seem like a limitation, in reality it's a perfect way to put the emphasis on a single functionality, the most important one for the module, while giving less visibility to secondary or internal aspects, which are instead exposed as properties of the exported function itself. The modularity of Node.js heavily encourages the adoption of the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Single Responsibility Principle"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"SRP"}]},{"block_type":"text","content":"): every module should have responsibility over a single functionality and that responsibility should be entirely encapsulated by the module."}]},{"block_type":"element","block":"k5zy5amq","search_text":"Note Pattern (substack) Expose the main functionality of a module by exporting only one function. Use the exported function as namespace to expose any auxiliary functionality. ","text_count":176,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern (substack)"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Expose the main functionality of a module by exporting only one function. Use the exported function as namespace to expose any auxiliary functionality."}]}]},{"block_type":"element","block":"k5zy5amr","search_text":"Exporting a constructor","text_count":23,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Exporting a constructor"}]},{"block_type":"element","block":"k5zy5ams","search_text":"A module that exports a constructor is a specialization of a module that exports a function. The difference is that with this new pattern we allow the user to create new instances using the constructor, but we also give them the ability to extend its prototype and forge new classes. The following is an example of this pattern:","text_count":328,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A module that exports a constructor is a specialization of a module that exports a function. The difference is that with this new pattern we allow the user to create new instances using the constructor, but we also give them the ability to extend its prototype and forge new classes. The following is an example of this pattern:"}]},{"block_type":"element","block":"k5zy5amt","search_text":"//file logger.js function Logger(name) { this.name = name; } Logger.prototype.log = function(message) { console.log(`[${this.name}] ${message}`); }; Logger.prototype.info = function(message) { this.log(`info: ${message}`); }; Logger.prototype.verbose = function(message) { this.log(`verbose: ${message}`); }; module.exports = Logger; ","text_count":334,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file logger.js \nfunction Logger(name) { \n  this.name = name; \n} \n \nLogger.prototype.log = function(message) { \n  console.log(`[${this.name}] ${message}`); \n}; \n \nLogger.prototype.info = function(message) { \n  this.log(`info: ${message}`); \n}; \n \nLogger.prototype.verbose = function(message) { \n  this.log(`verbose: ${message}`); \n}; \n \nmodule.exports = Logger;"}]}]},{"block_type":"element","block":"k5zy5amu","search_text":"And, we can use the preceding module as follows:","text_count":48,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"And, we can use the preceding module as follows:"}]},{"block_type":"element","block":"k5zy5amv","search_text":"//file main.js const Logger = require('./logger'); const dbLogger = new Logger('DB'); dbLogger.info('This is an informational message'); const accessLogger = new Logger('ACCESS'); accessLogger.verbose('This is a verbose message'); ","text_count":231,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file main.js \nconst Logger = require('./logger'); \nconst dbLogger = new Logger('DB'); \ndbLogger.info('This is an informational message'); \nconst accessLogger = new Logger('ACCESS'); \naccessLogger.verbose('This is a verbose message');"}]}]},{"block_type":"element","block":"k5zy5amw","search_text":"In the same fashion we can easily export an ES2015 class:","text_count":57,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the same fashion we can easily export an ES2015 class:"}]},{"block_type":"element","block":"k5zy5amx","search_text":"class Logger { constructor(name) { this.name = name; } log(message) { console.log(`[${this.name}] ${message}`); } info(message) { this.log(`info: ${message}`); } verbose(message) { this.log(`verbose: ${message}`); } } module.exports = Logger; ","text_count":243,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class Logger { \n  constructor(name) { \n    this.name = name; \n  } \n \n  log(message) { \n    console.log(`[${this.name}] ${message}`); \n  } \n \n  info(message) { \n    this.log(`info: ${message}`); \n  } \n \n  verbose(message) { \n    this.log(`verbose: ${message}`); \n  } \n} \n \nmodule.exports = Logger;"}]}]},{"block_type":"element","block":"k5zy5amy","search_text":"Given that ES2015 classes are just syntactic sugar for prototypes, the usage of this module will be exactly the same as its prototype-based alternative.","text_count":152,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Given that ES2015 classes are just syntactic sugar for prototypes, the usage of this module will be exactly the same as its prototype-based alternative."}]},{"block_type":"element","block":"k5zy5amz","search_text":"Exporting a constructor or a class still provides a single entry point for the module, but compared to the substack pattern, it exposes a lot more of the module internals; however, on the other hand it allows much more power when it comes to extending its functionality.","text_count":270,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Exporting a constructor or a class still provides a single entry point for the module, but compared to the substack pattern, it exposes a lot more of the module internals; however, on the other hand it allows much more power when it comes to extending its functionality."}]},{"block_type":"element","block":"k5zy5an0","search_text":"A variation of this pattern consists of applying a guard against invocations that doesn't use the new instruction. This little trick allows us to use our module as a factory . Let's see how this works:","text_count":201,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A variation of this pattern consists of applying a guard against invocations that doesn't use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":"instruction. This little trick allows us to use our module as a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"factory"}]},{"block_type":"text","content":". Let's see how this works:"}]},{"block_type":"element","block":"k5zy5an1","search_text":"function Logger(name) { if(!(this instanceof Logger)) { return new Logger(name); } this.name = name; }; ","text_count":104,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function Logger(name) { \n  if(!(this instanceof Logger)) { \n    return new Logger(name); \n  } \n  this.name = name; \n};"}]}]},{"block_type":"element","block":"k5zy5an2","search_text":"The trick is simple: we check whether this exists and is an instance of Logger . If any of these conditions is false, it means that the Logger() function was invoked without using new , we then proceed with creating the new instance properly and returning it to the caller. This technique allows us to use the module also as a factory:","text_count":335,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The trick is simple: we check whether"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this"}]},{"block_type":"text","content":"exists and is an instance of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Logger"}]},{"block_type":"text","content":". If any of these conditions is false, it means that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Logger()"}]},{"block_type":"text","content":"function was invoked without using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":", we then proceed with creating the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":"instance properly and returning it to the caller. This technique allows us to use the module also as a factory:"}]},{"block_type":"element","block":"k5zy5an3","search_text":"//file logger.js const Logger = require('./logger'); const dbLogger = Logger('DB'); accessLogger.verbose('This is a verbose message'); ","text_count":135,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file logger.js \nconst Logger = require('./logger'); \nconst dbLogger = Logger('DB'); \naccessLogger.verbose('This is a verbose message');"}]}]},{"block_type":"element","block":"k5zy5an4","search_text":"A much cleaner approach to implement the guard is offered by the ES2015 new.target syntax which is available starting from Node.js version 6. This syntax exposes the new.target property which is a \"meta property\" made available inside all the functions and that evaluates to true at runtime if the function was called using the new keyword.","text_count":340,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A much cleaner approach to implement the guard is offered by the ES2015"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new.target"}]},{"block_type":"text","content":"syntax which is available starting from Node.js version 6. This syntax exposes the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new.target"}]},{"block_type":"text","content":"property which is a \"meta property\" made available inside all the functions and that evaluates to true at runtime if the function was called using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":"keyword."}]},{"block_type":"element","block":"k5zy5an5","search_text":"We can use this syntax to rewrite our logger factory:","text_count":53,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can use this syntax to rewrite our logger factory:"}]},{"block_type":"element","block":"k5zy5an6","search_text":"function Logger(name) { if(!new.target) { return new LoggerConstructor(name); } this.name = name; } ","text_count":100,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function Logger(name) { \n  if(!new.target) { \n    return new LoggerConstructor(name); \n  } \n  this.name = name; \n}"}]}]},{"block_type":"element","block":"k5zy5an7","search_text":"This code is totally equivalent to the previous one, so we can say that this new.target syntax is more helpful ES2015 syntactic sugar that makes our code much more readable and natural.","text_count":185,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This code is totally equivalent to the previous one, so we can say that this"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new.target"}]},{"block_type":"text","content":"syntax is more helpful ES2015 syntactic sugar that makes our code much more readable and natural."}]},{"block_type":"element","block":"k5zy5an8","search_text":"Exporting an instance","text_count":21,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Exporting an instance"}]},{"block_type":"element","block":"k5zy5an9","search_text":"We can leverage the caching mechanism of require() to easily define stateful instances with a state created from a constructor or a factory, which can be shared across different modules. The following code shows an example of this pattern:","text_count":239,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can leverage the caching mechanism of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"to easily define stateful instances&nbsp;with a state created from a constructor or a factory, which can be shared across different modules. The following code shows an example of this pattern:"}]},{"block_type":"element","block":"k5zy5ana","search_text":"//file logger.js function Logger(name) { this.count = 0; this.name = name; } Logger.prototype.log = function(message) { this.count++; console.log('[' + this.name + '] ' + message); }; module.exports = new Logger('DEFAULT'); ","text_count":224,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file logger.js \nfunction Logger(name) { \n  this.count = 0; \n  this.name = name; \n} \nLogger.prototype.log = function(message) { \n  this.count++; \n  console.log('[' + this.name + '] ' + message); \n}; \nmodule.exports = new Logger('DEFAULT');"}]}]},{"block_type":"element","block":"k5zy5anb","search_text":"This newly defined module can then be used as follows:","text_count":54,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This newly defined module can then be used as follows:"}]},{"block_type":"element","block":"k5zy5anc","search_text":"//file main.js const logger = require('./logger'); logger.log('This is an informational message'); ","text_count":99,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file main.js \nconst logger = require('./logger'); \nlogger.log('This is an informational message');"}]}]},{"block_type":"element","block":"k5zy5and","search_text":"Because the module is cached, every module that requires the logger module will actually always retrieve the same instance of the object, thus sharing its state. This pattern is very much like creating a singleton ; however, it does not guarantee the uniqueness of the instance across the entire application, as it happens in the traditional singleton pattern. When analyzing the resolving algorithm, we have seen in fact, that a module might be installed multiple times inside the dependency tree of an application. This results in multiple instances of the same logical module, all running in the context of the same Node.js application. In Chapter 7, Wiring Modules , we will analyze the consequences of exporting stateful instances and some alternative patterns.","text_count":766,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Because the module is cached, every module that requires the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"logger"}]},{"block_type":"text","content":"module will actually always retrieve the same instance of the object, thus sharing its state. This pattern is very much like creating a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"singleton"}]},{"block_type":"text","content":"; however, it does not guarantee the uniqueness of the instance across the entire application, as it happens in the traditional singleton pattern. When analyzing the resolving algorithm, we have seen in fact, that a module might be installed multiple times inside the dependency tree of an application. This results in multiple instances of the same logical module, all running in the context of the same Node.js application. In Chapter 7,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Wiring Modules"}]},{"block_type":"text","content":", we will analyze the consequences of exporting stateful instances and some alternative patterns."}]},{"block_type":"element","block":"k5zy5ane","search_text":"An extension to the pattern we just described, consists of exposing the constructor used to create the instance, in addition to the instance itself. This allows the user to create new instances of the same object, or even to extend it if necessary. To enable this, we just need to assign a new property to the instance, as shown in the following line of code:","text_count":359,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An extension to the pattern we just described, consists of exposing the constructor used to create the instance, in addition to the instance itself. This allows the user to create new instances of the same object, or even to extend it if necessary. To enable this, we just need to assign a new property to the instance, as shown in the following line of code:"}]},{"block_type":"element","block":"k5zy5anf","search_text":"module.exports.Logger = Logger; ","text_count":32,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports.Logger = Logger;"}]}]},{"block_type":"element","block":"k5zy5ang","search_text":"Then, we can use the exported constructor to create other instances of the class:","text_count":81,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can use the exported constructor to create other instances of the class:"}]},{"block_type":"element","block":"k5zy5anh","search_text":"const customLogger = new logger.Logger('CUSTOM'); customLogger.log('This is an informational message'); ","text_count":104,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const customLogger = new logger.Logger('CUSTOM'); \ncustomLogger.log('This is an informational message');"}]}]},{"block_type":"element","block":"k5zy5ani","search_text":"From the usability perspective, this is similar to using an exported function as a namespace; the module exports the default instance of an object—the piece of functionality we might want to use most of the time, while more advanced features, such as the ability to create new instances or extend the object, are still available through less exposed properties.","text_count":361,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From the usability perspective, this is similar to using an exported function as a namespace; the module exports the default instance of an object&mdash;the piece of functionality we might want to use most of the time, while more advanced features, such as the ability to create new instances or extend the object, are still available through less exposed properties."}]},{"block_type":"element","block":"k5zy5anj","search_text":"Modifying other modules or the global scope","text_count":43,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Modifying other modules or the global scope"}]},{"block_type":"element","block":"k5zy5ank","search_text":"A module can even export nothing. This can look a bit out of place; however, we should not forget that a module can modify the global scope and any object in it, including other modules in the cache. Please note that these are in general considered bad practices, but since this pattern can be useful and safe under some circumstances (for example, for testing) and is sometimes used in the wild, it is worth knowing and understanding it. We said a module can modify other modules or objects in the global scope; well, this is called monkey patching . It generally refers to the practice of modifying the existing objects at runtime to change or extend their behavior or to apply temporary fixes.","text_count":696,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A module can even export nothing. This can look a bit out of place; however, we should not forget that a module can modify the global scope and any object in it, including other modules in the cache. Please note that these are in general considered bad practices, but since this pattern can be useful and safe under some circumstances (for example, for testing) and is sometimes used in the wild, it is worth knowing and understanding it. We said a module can modify other modules or objects in the global scope; well, this is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"monkey patching"}]},{"block_type":"text","content":". It generally refers to the practice of modifying the existing objects at runtime to change or extend their behavior or to apply temporary fixes."}]},{"block_type":"element","block":"k5zy5anl","search_text":"The following example shows you how we can add a new function to another module:","text_count":80,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following example shows you how we can add a new function to another module:"}]},{"block_type":"element","block":"k5zy5anm","search_text":"//file patcher.js // ./logger is another module require('./logger').customMessage = () => console.log('This is a new functionality'); ","text_count":134,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file patcher.js \n \n// ./logger is another module \nrequire('./logger').customMessage = () =&gt; console.log('This is a new \n  functionality');"}]}]},{"block_type":"element","block":"k5zy5ann","search_text":"Using our new patcher module would be as easy as writing the following code:","text_count":76,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using our new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"patcher"}]},{"block_type":"text","content":"module would be as easy as writing the following code:"}]},{"block_type":"element","block":"k5zy5ano","search_text":"//file main.js require('./patcher'); const logger = require('./logger'); logger.customMessage(); ","text_count":97,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//file main.js \n \nrequire('./patcher'); \nconst logger = require('./logger'); \nlogger.customMessage();"}]}]},{"block_type":"element","block":"k5zy5anp","search_text":"In the preceding code, patcher must be required before using the logger module for the first time in order to allow the patch to be applied.","text_count":140,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"patcher"}]},{"block_type":"text","content":"must be required before using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"logger"}]},{"block_type":"text","content":"module for the first time in order to allow the patch to be applied."}]},{"block_type":"element","block":"k5zy5anq","search_text":"The techniques described here are all dangerous ones to apply. The main concern is that having a module that modifies the global namespace or other modules is an operation with side effects. In other words, it affects the state of entities outside their scope, which can have consequences that aren't predictable, especially when multiple modules interact with the same entities. Imagine having two different modules trying to set the same global variable, or modifying the same property of the same module; the effects might be unpredictable (which module wins?), but most importantly it would have repercussions in the entire application.","text_count":640,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The techniques described here are all dangerous ones to apply. The main concern is that having a module that modifies the global namespace or other modules is an operation with side effects. In other words, it affects the state of entities outside their scope, which can have consequences that aren't predictable, especially when multiple modules interact with the same entities. Imagine having two different modules trying to set the same global variable, or modifying the same property of the same module; the effects might be unpredictable (which module wins?), but most importantly it would have repercussions in the entire application."}]},{"block_type":"element","block":"k5zy5anr","search_text":"The observer pattern","text_count":20,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"The observer pattern"}]},{"block_type":"element","block":"k5zy5ans","search_text":"Another important and fundamental pattern used in Node.js is the observer pattern. Together with the reactor, callbacks, and modules, the observer pattern is one of the pillars of the platform and an absolute prerequisite for using many node-core and userland modules.","text_count":268,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another important and fundamental pattern used in Node.js is the observer pattern. Together with the reactor, callbacks, and modules, the observer pattern is one of the pillars of the platform and an absolute prerequisite for using many node-core and userland modules."}]},{"block_type":"element","block":"k5zy5ant","search_text":"Observer is an ideal solution for modeling the reactive nature of Node.js and a perfect complement for callbacks. Let's give a formal definition as follows:","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Observer is an ideal solution for modeling the reactive nature of Node.js and a perfect complement for callbacks. Let's give a formal definition as follows:"}]},{"block_type":"element","block":"k5zy5anu","search_text":"Pattern (observer) defines an object (called subject), which can notify a set of observers (or listeners), when a change in its state happens.","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern (observer)"}]},{"block_type":"text","content":"defines an object (called subject), which can notify a set of observers (or listeners), when a change in its state happens."}]},{"block_type":"element","block":"k5zy5anv","search_text":"The main difference from the callback pattern is that the subject can actually notify multiple observers, while a traditional continuation-passing style callback will usually propagate its result to only one listener, the callback.","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The main difference from the callback pattern is that the subject can actually notify multiple observers, while a traditional continuation-passing style callback will usually propagate its result to only one listener, the callback."}]},{"block_type":"element","block":"k5zy5anw","search_text":"The EventEmitter class","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The EventEmitter class"}]},{"block_type":"element","block":"k5zy5anx","search_text":"In traditional object-oriented programming, the observer pattern requires interfaces, concrete classes, and a hierarchy; in Node.js, all becomes much simpler. The observer pattern is already built into the core and is available through the EventEmitter class. The EventEmitter class allows us to register one or more functions as listeners, which will be invoked when a particular event type is fired. The following image visually explains the concept:","text_count":452,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In traditional object-oriented programming, the observer pattern requires interfaces, concrete classes, and a hierarchy; in Node.js, all becomes much simpler. The observer pattern is already built into the core and is available through the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"class. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"class allows us to register one or more functions as listeners, which will be invoked when a particular event type is fired. The following image visually explains the concept:"}]},{"block_type":"element","block":"k5zy5any","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000015.jpg","alt":"The EventEmitter class","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5anz","search_text":"The EventEmitter is a prototype and it is exported from the events core module. The following code shows how we can obtain a reference to it:","text_count":141,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"is a prototype and it is exported from the events core module. The following code shows how we can obtain a reference to it:"}]},{"block_type":"element","block":"k5zy5ao0","search_text":"const EventEmitter = require('events').EventEmitter; const eeInstance = new EventEmitter(); ","text_count":92,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const EventEmitter = require('events').EventEmitter; \nconst eeInstance = new EventEmitter();"}]}]},{"block_type":"element","block":"k5zy5ao1","search_text":"The essential methods of the EventEmitter are given as follows:","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The essential methods of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"are given as follows:"}]},{"block_type":"element","block":"k5zy5ao2","search_text":"on(event, listener) : This method allows you to register a new listener (a function) for the given event type (a string) once(event, listener) : This method registers a new listener, which is then removed after the event is emitted for the first time emit(event, [arg1], [...]) : This method produces a new event and provides additional arguments to be passed to the listeners removeListener(event, listener) : This method removes a listener for the specified event type ","text_count":471,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"on(event, listener)"}]},{"block_type":"text","content":": This method allows you to register a new listener (a function) for the given event type (a string)"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"once(event, listener)"}]},{"block_type":"text","content":": This method registers a new listener, which is then removed after the event is emitted for the first time"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit(event, [arg1], [...])"}]},{"block_type":"text","content":": This method produces a new event and provides additional arguments to be passed to the listeners"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"removeListener(event, listener)"}]},{"block_type":"text","content":": This method removes a listener for the specified event type"}]}]},{"block_type":"element","block":"k5zy5ao3","search_text":"All the preceding methods will return the EventEmitter instance to allow chaining. The listener function has the signature function([arg1], [...]) , so it simply accepts the arguments provided the moment the event is emitted. Inside the listener, this refers to the instance of the EventEmitter that produces the event.","text_count":319,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All the preceding methods will return the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"instance to allow chaining. The listener function has the signature"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"function([arg1], [...])"}]},{"block_type":"text","content":", so it simply accepts the arguments provided the moment the event is emitted. Inside the listener, this refers to the instance of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"that produces the event."}]},{"block_type":"element","block":"k5zy5ao4","search_text":"We can already see that there is a big difference between a listener and a traditional Node.js callback; in particular, the first argument is not an error, but it can be any data passed to emit() at the moment of its invocation.","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can already see that there is a big difference between a listener and a traditional Node.js callback; in particular, the first argument is not an error, but it can be any data passed to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit()"}]},{"block_type":"text","content":"at the moment of its invocation."}]},{"block_type":"element","block":"k5zy5ao5","search_text":"Creating and using EventEmitter","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Creating and using EventEmitter"}]},{"block_type":"element","block":"k5zy5ao6","search_text":"Let's see how we can use an EventEmitter in practice. The simplest way is to create a new instance and use it immediately. The following code shows a function that uses an EventEmitter to notify its subscribers in real time when a particular pattern is found in a list of files:","text_count":278,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see how we can use an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"in practice. The simplest way is to create a new instance and use it immediately. The following code shows a function that uses an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"to notify its subscribers in real time when a particular pattern is found in a list of files:"}]},{"block_type":"element","block":"k5zy5ao7","search_text":"const EventEmitter = require('events').EventEmitter; const fs = require('fs'); function findPattern(files, regex) { const emitter = new EventEmitter(); files.forEach(function(file) { fs.readFile(file, 'utf8', (err, content) => { if(err) return emitter.emit('error', err); emitter.emit('fileread', file); let match; if(match = content.match(regex)) match.forEach(elem => emitter.emit('found', file, elem)); }); }); return emitter; } ","text_count":432,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const EventEmitter = require('events').EventEmitter; \nconst fs = require('fs'); \n \nfunction findPattern(files, regex) { \n  const emitter = new EventEmitter(); \n  files.forEach(function(file) { \n    fs.readFile(file, 'utf8', (err, content) =&gt; { \n      if(err) \n        return emitter.emit('error', err); \n \n      emitter.emit('fileread', file); \n      let match; \n      if(match = content.match(regex)) \n        match.forEach(elem =&gt; emitter.emit('found', file, elem)); \n    }); \n  }); \n  return emitter; \n}"}]}]},{"block_type":"element","block":"k5zy5ao8","search_text":"The EventEmitter created by the preceding function will produce three events:","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"created by the preceding function will produce three events:"}]},{"block_type":"element","block":"k5zy5ao9","search_text":"fileread : This event occurs when a file is read found : This event occurs when a match has been found error : This event occurs when an error has occurred during the reading of the file ","text_count":187,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fileread"}]},{"block_type":"text","content":": This event occurs when a file is read"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"found"}]},{"block_type":"text","content":": This event occurs when a match has been found"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":": This event occurs when an error has occurred during the reading of the file"}]}]},{"block_type":"element","block":"k5zy5aoa","search_text":"Let's see now how our findPattern() function can be used:","text_count":57,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see now how our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"findPattern()"}]},{"block_type":"text","content":"function can be used:"}]},{"block_type":"element","block":"k5zy5aob","search_text":"findPattern( ['fileA.txt', 'fileB.json'], /hello \\w+/g ) .on('fileread', file => console.log(file + ' was read')) .on('found', (file, match) => console.log('Matched \"' + match + '\" in file ' + file)) .on('error', err => console.log('Error emitted: ' + err.message)); ","text_count":267,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"findPattern( \n    ['fileA.txt', 'fileB.json'], \n    /hello \\w+/g \n  ) \n  .on('fileread', file =&gt; console.log(file + ' was read')) \n  .on('found', (file, match) =&gt; console.log('Matched \"' + match + \n    '\" in file ' + file)) \n  .on('error', err =&gt; console.log('Error emitted: ' + err.message));"}]}]},{"block_type":"element","block":"k5zy5aoc","search_text":"In the preceding example, we registered a listener for each of the three event types produced by the EventEmitter which was created by our findPattern() function.","text_count":162,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding example, we registered a listener for each of the three event types produced by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"which was created by our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"findPattern()"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","block":"k5zy5aod","search_text":"Propagating errors","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Propagating errors"}]},{"block_type":"element","block":"k5zy5aoe","search_text":"The EventEmitter , as it happens for callbacks, cannot just throw exceptions when an error condition occurs, as they would be lost in the event loop if the event is emitted asynchronously. Instead, the convention is to emit a special event, called error , and to pass an Error object as an argument. That's exactly what we are doing in the findPattern() function that we defined earlier.","text_count":387,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":", as it happens for callbacks, cannot just throw exceptions when an error condition occurs, as they would be lost in the event loop if the event is emitted asynchronously. Instead, the convention is to emit a special event, called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":", and to pass an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Error"}]},{"block_type":"text","content":"object as an argument. That's exactly what we are doing in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"findPattern()"}]},{"block_type":"text","content":"function that we defined earlier."}]},{"block_type":"element","block":"k5zy5aof","search_text":"It is always best practice to register a listener for the error event, as Node.js will treat it in a special way and will automatically throw an exception and exit from the program if no associated listener is found.","text_count":216,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is always best practice to register a listener for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":"event, as Node.js will treat it in a special way and will automatically throw an exception and exit from the program if no associated listener is found."}]},{"block_type":"element","block":"k5zy5aog","search_text":"Making any object observable","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Making any object observable"}]},{"block_type":"element","block":"k5zy5aoh","search_text":"Sometimes, creating a new observable object directly from the EventEmitter class is not enough, as this makes it impractical to provide functionality that goes beyond the mere production of new events. It is more common, in fact, to have the need to make a generic object observable; this is possible by extending the EventEmitter class.","text_count":337,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sometimes, creating a new observable object directly from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"class is not enough, as this makes it impractical to provide functionality that goes beyond the mere production of new events. It is more common, in fact, to have the need to make a generic object observable; this is possible by extending the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"class."}]},{"block_type":"element","block":"k5zy5aoi","search_text":"To demonstrate this pattern, let's try to implement the functionality of the findPattern() function in an object as follows:","text_count":124,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate this pattern, let's try to implement the functionality of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"findPattern()"}]},{"block_type":"text","content":"function in an object as follows:"}]},{"block_type":"element","block":"k5zy5aoj","search_text":"const EventEmitter = require('events').EventEmitter; const fs = require('fs'); class FindPattern extends EventEmitter { constructor (regex) { super(); this.regex = regex; this.files = []; } addFile (file) { this.files.push(file); return this; } find () { this.files.forEach( file => { fs.readFile(file, 'utf8', (err, content) => { if (err) { return this.emit('error', err); } this.emit('fileread', file); let match = null; if (match = content.match(this.regex)) { match.forEach(elem => this.emit('found', file, elem)); } }); }); return this; } } ","text_count":546,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const EventEmitter = require('events').EventEmitter; \nconst fs = require('fs'); \n \nclass FindPattern extends EventEmitter { \n  constructor (regex) { \n    super(); \n    this.regex = regex; \n    this.files = []; \n  } \n \n  addFile (file) { \n    this.files.push(file); \n    return this; \n  } \n \n  find () { \n    this.files.forEach( file =&gt; { \n      fs.readFile(file, 'utf8', (err, content) =&gt; { \n        if (err) { \n          return this.emit('error', err); \n        } \n \n        this.emit('fileread', file); \n \n        let match = null;\n        if (match = content.match(this.regex)) {\n          match.forEach(elem =&gt; this.emit('found', file, elem));\n        }\n      }); \n    }); \n    return this; \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5aok","search_text":"The FindPattern prototype that we defined extends EventEmitter using the inherits() function provided by the core module util . In this way it becomes a fully-fledged observable class. The following is an example of its usage:","text_count":226,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"FindPattern"}]},{"block_type":"text","content":"prototype that we defined extends"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inherits()"}]},{"block_type":"text","content":"function provided by the core module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"util"}]},{"block_type":"text","content":". In this way it becomes a fully-fledged observable class. The following is an example of its usage:"}]},{"block_type":"element","block":"k5zy5aol","search_text":"const findPatternObject = new FindPattern(/hello \\w+/); findPatternObject .addFile('fileA.txt') .addFile('fileB.json') .find() .on('found', (file, match) => console.log(`Matched \"${match}\" in file ${file}`)) .on('error', err => console.log(`Error emitted ${err.message}`)); ","text_count":274,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const findPatternObject = new FindPattern(/hello \\w+/); \nfindPatternObject \n  .addFile('fileA.txt') \n  .addFile('fileB.json') \n  .find() \n  .on('found', (file, match) =&gt; console.log(`Matched \"${match}\" \n    in file ${file}`)) \n  .on('error', err =&gt; console.log(`Error emitted ${err.message}`));"}]}]},{"block_type":"element","block":"k5zy5aom","search_text":"We can now see how the FindPattern object has a full set of methods, in addition to being observable, by inheriting the functionality of EventEmitter This is a pretty common pattern in the Node.js ecosystem, for example, the Server object of the core HTTP module defines methods such as listen() , close() , setTimeout() , and internally it also inherits from the EventEmitter function, thus allowing it to produce events, such as request , when a new request is received; or connection , when a new connection is established; or closed , when the server is closed.","text_count":565,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now see how the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"FindPattern"}]},{"block_type":"text","content":"object has a full set of methods, in addition to being observable, by inheriting the functionality of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"This is a pretty common pattern in the Node.js ecosystem, for example, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Server"}]},{"block_type":"text","content":"object of the core HTTP module defines methods such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"listen()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"close()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setTimeout()"}]},{"block_type":"text","content":", and internally it also inherits from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"function, thus allowing it to produce events, such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request"}]},{"block_type":"text","content":", when a new request is received; or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"connection"}]},{"block_type":"text","content":", when a new connection is established; or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"closed"}]},{"block_type":"text","content":", when the server is closed."}]},{"block_type":"element","block":"k5zy5aon","search_text":"Other notable examples of objects extending EventEmitter are Node.js streams. We will analyze streams in more detail in Chapter 5, Coding with Streams .","text_count":152,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Other notable examples of objects extending"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"are Node.js streams. We will analyze streams in more detail in Chapter 5,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Coding with Streams"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aoo","search_text":"Synchronous and asynchronous events","text_count":35,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Synchronous and asynchronous events"}]},{"block_type":"element","block":"k5zy5aop","search_text":"As with callbacks, events can be emitted synchronously or asynchronously. It is crucial that we never mix the two approaches in the same EventEmitter , but even more important, when emitting the same event type, to avoid producing the same problems that we described in the Unleashing Zalgo sectio The main difference between emitting synchronous and asynchronous events lies in the way listeners can be registered. When the events are emitted asynchronously, the program has all the time to register new listeners even after EventEmitter is initialized, because the events are guaranteed not to be fired until the next cycle of the event loop. That's exactly what is happening in the findPattern() function. We defined this function previously and it represents a common approach that is used in most Node.js module On the contrary, emitting events synchronously requires that all the listeners are registered before the EventEmitter function starts to emit any event. Let's look at an example:","text_count":995,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As with callbacks, events can be emitted synchronously or asynchronously. It is crucial that we never mix the two approaches in the same"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":", but even more important, when emitting the same event type, to avoid producing the same problems that we described in the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Unleashing Zalgo"}]},{"block_type":"text","content":"sectio The main difference between emitting synchronous and asynchronous events lies in the way listeners can be registered. When the events are emitted asynchronously, the program has all the time to register new listeners even after"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"is initialized, because the events are guaranteed not to be fired until the next cycle of the event loop. That's exactly what is happening in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"findPattern()"}]},{"block_type":"text","content":"function. We defined this function previously and it represents a common approach that is used in most Node.js module On the contrary, emitting events synchronously requires that all the listeners are registered before the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"function starts to emit any event. Let's look at an example:"}]},{"block_type":"element","block":"k5zy5aoq","search_text":"const EventEmitter = require('events').EventEmitter; class SyncEmit extends EventEmitter { constructor() { super(); this.emit('ready'); } } const syncEmit = new SyncEmit(); syncEmit.on('ready', () => console.log('Object is ready to be used')); ","text_count":244,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const EventEmitter = require('events').EventEmitter; \n \nclass SyncEmit extends EventEmitter { \n  constructor() { \n    super(); \n    this.emit('ready'); \n  } \n} \n \nconst syncEmit = new SyncEmit(); \nsyncEmit.on('ready', () =&gt; console.log('Object is ready to be  used'));"}]}]},{"block_type":"element","block":"k5zy5aor","search_text":"If the ready event was emitted asynchronously, then the previous code would have worked perfectly; however, the event is produced synchronously and the listener is registered after the event was already sent, so the result is that the listener is never invoked; the code will print nothing to the console.","text_count":305,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ready"}]},{"block_type":"text","content":"event was emitted asynchronously, then the previous code would have worked perfectly; however, the event is produced synchronously and the listener is registered after the event was already sent, so the result is that the listener is never invoked; the code will print nothing to the console."}]},{"block_type":"element","block":"k5zy5aos","search_text":"There are situations where using an EventEmitter function in a synchronous fashion makes sense, given its different purpose. For this reason, it's very important to clearly highlight the behavior of our EventEmitter in its documentation to avoid confusion, and potentially incorrect usage.","text_count":289,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are situations where using an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"function in a synchronous fashion makes sense, given its different purpose. For this reason, it's very important to clearly highlight the behavior of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"in its documentation to avoid confusion, and potentially incorrect usage."}]},{"block_type":"element","block":"k5zy5aot","search_text":"EventEmitter versus callbacks","text_count":29,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"EventEmitter versus callbacks"}]},{"block_type":"element","block":"k5zy5aou","search_text":"A common dilemma when defining an asynchronous API is to check whether to use an EventEmitter or simply accept a callback. The general differentiating rule is semantic: callbacks should be used when a result must be returned in an asynchronous way; events should instead be used when there is a need to communicate that something has just happened.","text_count":348,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A common dilemma when defining an asynchronous API is to check whether to use an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"or simply accept a callback. The general differentiating rule is semantic: callbacks should be used when a result must be returned in an asynchronous way; events should instead be used when there is a need to communicate that something has just happened."}]},{"block_type":"element","block":"k5zy5aov","search_text":"But besides this simple principle, a lot of confusion is generated from the fact that the two paradigms are, most of the time, equivalent and allow you to achieve the same results. Consider the following code as an example:","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But besides this simple principle, a lot of confusion is generated from the fact that the two paradigms are, most of the time, equivalent and allow you to achieve the same results. Consider the following code as an example:"}]},{"block_type":"element","block":"k5zy5aow","search_text":"function helloEvents() { const eventEmitter= new EventEmitter(); setTimeout(() => eventEmitter.emit('hello', 'hello world'), 100); return eventEmitter; } function helloCallback(callback) { setTimeout(() => callback('hello world'), 100); } ","text_count":239,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function helloEvents() { \n  const eventEmitter= new EventEmitter(); \n  setTimeout(() =&gt; eventEmitter.emit('hello', 'hello world'), 100); \n  return eventEmitter; \n} \n \nfunction helloCallback(callback) { \n  setTimeout(() =&gt; callback('hello world'), 100); \n}"}]}]},{"block_type":"element","block":"k5zy5aox","search_text":"The two functions helloEvents() and helloCallback() can be considered equivalent in terms of functionality; the first communicates the completion of the timeout using an event, the second uses a callback to notify the caller instead, passing the event type as an argument. But what really differentiates them is the readability, the semantics, and the amount of code that is required to be implemented or used. While we cannot give a deterministic set of rules to choose between one style or the other, we can certainly provide some hints to help you take a decision.","text_count":567,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The two functions"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"helloEvents()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"helloCallback()"}]},{"block_type":"text","content":"can be considered equivalent in terms of functionality; the first communicates the completion of the timeout using an event, the second uses a callback to notify the caller instead, passing the event type as an argument. But what really differentiates them is the readability, the semantics, and the amount of code that is required to be implemented or used. While we cannot give a deterministic set of rules to choose between one style or the other, we can certainly provide some hints to help you take a decision."}]},{"block_type":"element","block":"k5zy5aoy","search_text":"As a first observation, we can say that callbacks have some limitations when it comes to supporting different types of events. In fact, we can still differentiate between multiple events by passing the type as an argument of the callback, or by accepting several callbacks, one for each supported event. However, this cannot exactly be considered an elegant API. In this situation, EventEmitter can give a better interface and leaner code.","text_count":439,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a first observation, we can say that callbacks have some limitations when it comes to supporting different types of events. In fact, we can still differentiate between multiple events by passing the type as an argument of the callback, or by accepting several callbacks, one for each supported event. However, this cannot exactly be considered an elegant API. In this situation,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"can give a better interface and leaner code."}]},{"block_type":"element","block":"k5zy5aoz","search_text":"Another case where EventEmitter might be preferable is when the same event can occur multiple times, or not occur at all. A callback, in fact, is expected to be invoked exactly once, whether the operation is successful or not. The fact that we have a possibly repeating circumstance should let us think again about the semantic nature of the occurrence, which is more similar to an event that has to be communicated rather than a result; in this case EventEmitter is the preferred choice.","text_count":488,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another case where"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"might be preferable is when the same event can occur multiple times, or not occur at all. A callback, in fact, is expected to be invoked exactly once, whether the operation is successful or not. The fact that we have a possibly repeating circumstance should let us think again about the semantic nature of the occurrence, which is more similar to an event that has to be communicated rather than a result; in this case"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"is the preferred choice."}]},{"block_type":"element","block":"k5zy5ap0","search_text":"Lastly, an API using callbacks can notify only a particular callback, while using an EventEmitter function is possible for multiple listeners to receive the same notification.","text_count":175,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Lastly, an API using callbacks can notify only a particular callback, while using an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"function is possible for multiple listeners to receive the same notification."}]},{"block_type":"element","block":"k5zy5ap1","search_text":"Combining callbacks and EventEmitter","text_count":36,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Combining callbacks and EventEmitter"}]},{"block_type":"element","block":"k5zy5ap2","search_text":"There are also some circumstances where EventEmitter can be used in conjunction with a callback. This pattern is extremely useful when we want to implement the principle of small surface area by exporting a traditional asynchronous function as the main functionality, while still providing richer features and more control by returning EventEmitter . One example of this pattern is offered by the node-glob module ( https://npmjs.org/package/glob ), a library that performs glob-style file searches. The main entry point of the module is the function it exports, which has the following signature:","text_count":597,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are also some circumstances where"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"can be used in conjunction with a callback. This pattern is extremely useful when we want to implement the principle of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"small surface area"}]},{"block_type":"text","content":"by exporting a traditional asynchronous function as the main functionality, while still providing richer features and more control by returning"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":". One example of this pattern is offered by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node-glob"}]},{"block_type":"text","content":"module ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/glob"},"children":[{"block_type":"text","content":"https://npmjs.org/package/glob"}]},{"block_type":"text","content":"), a library that performs glob-style file searches. The main entry point of the module is the function it exports, which has the following signature:"}]},{"block_type":"element","block":"k5zy5ap3","search_text":"glob(pattern, [options], callback) ","text_count":35,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"glob(pattern, [options], callback)"}]}]},{"block_type":"element","block":"k5zy5ap4","search_text":"The function takes pattern as the first argument, a set of options, and a callback function that is invoked with the list of all the files matching the provided pattern. At the same time, the function returns EventEmitter that provides a more fine-grained report over the state of the process. For example, it is possible to be notified in real-time when a match occurs by listening to the match event, to obtain the list of all the matched files with the end event, or to know whether the process was manually aborted by listening to the abort event. The following code shows how this looks:","text_count":592,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The function takes"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pattern"}]},{"block_type":"text","content":"as the first argument, a set of options, and a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function that is invoked with the list of all the files matching the provided pattern. At the same time, the function returns"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"that provides a more fine-grained report over the state of the process. For example, it is possible to be notified in real-time when a match occurs by listening to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"match"}]},{"block_type":"text","content":"event, to obtain the list of all the matched files with the end event, or to know whether the process was manually aborted by listening to the abort event. The following code shows how this looks:"}]},{"block_type":"element","block":"k5zy5ap5","search_text":"const glob = require('glob'); glob('data/*.txt', (error, files) => console.log(`All files found: ${JSON.stringify(files)}`)) .on('match', match => console.log(`Match found: ${match}`)); ","text_count":186,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const glob = require('glob'); \nglob('data/*.txt', (error, files) =&gt; console.log(`All files found: \n  ${JSON.stringify(files)}`)) \n  .on('match', match =&gt; console.log(`Match found: ${match}`));"}]}]},{"block_type":"element","block":"k5zy5ap6","search_text":"As we can see, the practice of exposing a simple, clean, and minimal entry point while still providing more advanced or less important features with secondary means is quite common in Node.js, and combining EventEmitter with traditional callbacks is one of the ways to achieve that.","text_count":282,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, the practice of exposing a simple, clean, and minimal entry point while still providing more advanced or less important features with secondary means is quite common in Node.js, and combining"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"with traditional callbacks is one of the ways to achieve that."}]},{"block_type":"element","block":"k5zy5ap7","search_text":"Note Pattern Create a function that accepts a callback and returns EventEmitter , thus providing a simple and clear entry point for the main functionality, while emitting more fine-grained events using EventEmitter . ","text_count":217,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Create a function that accepts a callback and returns"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":", thus providing a simple and clear entry point for the main functionality, while emitting more fine-grained events using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5ap8","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5ap9","search_text":"In this chapter, we first learnt the difference between synchronous and asynchronous code. Then we explored how to use the callback and the event emitter patterns to deal with some basic asynchronous scenarios. We also learned the main differences between the two patterns and when one is more suitable than the other to address a specific problem. We just made the first steps toward more advanced asynchronous patterns.","text_count":421,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we first learnt the difference between synchronous and asynchronous code. Then we explored how to use the callback and the event emitter patterns to deal with some basic asynchronous scenarios. We also learned the main differences between the two patterns and when one is more suitable than the other to address a specific problem. We just made the first steps toward more advanced asynchronous patterns."}]},{"block_type":"element","block":"k5zy5apa","search_text":"In the next chapter we will have a look at more complex scenarios, learning how to leverage the callback and the event emitter patterns to deal with advanced asynchronous control flows.","text_count":185,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter we will have a look at more complex scenarios, learning how to leverage the callback and the event emitter patterns to deal with advanced asynchronous control flows."}]}]},{"title":"Asynchronous Control Flow Patterns with Callbacks","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4mkq","number":3,"contents":[{"block_type":"element","block":"k5zy5apb","search_text":"Moving from a synchronous programming style to a platform such as Node.js, where continuation-passing style and asynchronous APIs are the norm, can be frustrating. Writing asynchronous code can be a different experience, especially when it comes to control flow. Asynchronous code might make it hard to predict the order in which statements are executed within Node.js applications, so simple problems such as iterating over a set of files, executing tasks in sequence, or waiting for a set of operations to complete require the developer to take new approaches and techniques to avoid ending up writing inefficient and unreadable code. One common mistake is to fall into the trap of the callback hell problem and see the code growing horizontally rather than vertically, with a nesting that makes even simple routines hard to read and maintain.","text_count":845,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Moving from a synchronous programming style to a platform such as Node.js, where continuation-passing style and asynchronous APIs are the norm, can be frustrating. Writing asynchronous code can be a different experience, especially when it comes to control flow. Asynchronous code might make it hard to predict the order in which statements are executed within Node.js applications, so simple problems such as iterating over a set of files, executing tasks in sequence, or waiting for a set of operations to complete require the developer to take new approaches and techniques to avoid ending up writing inefficient and unreadable code. One common mistake is to fall into the trap of the callback hell problem and see the code growing horizontally rather than vertically, with a nesting that makes even simple routines hard to read and maintain."}]},{"block_type":"element","block":"k5zy5apc","search_text":"In this chapter, we will see how it's actually possible to tame callbacks and write clean, manageable asynchronous code by using some discipline and with the aid of some patterns. We will see how control flow libraries, such as async , can significantly simplify our problems making our code much more readable and maintainable.","text_count":328,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will see how it's actually possible to tame callbacks and write clean, manageable asynchronous code by using some discipline and with the aid of some patterns. We will see how control flow libraries, such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":", can significantly simplify our problems making our code much more readable and maintainable."}]},{"block_type":"element","block":"k5zy5apd","search_text":"The difficulties of asynchronous programming","text_count":44,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"The difficulties of asynchronous programming"}]},{"block_type":"element","block":"k5zy5ape","search_text":"Losing control of asynchronous code in JavaScript is undoubtedly easy. Closures and in-place definitions of anonymous functions allow a smooth programming experience that doesn't require the developer to jump to other points in the code base. This is perfectly in line with the KISS principle; it's simple, it keeps the code flowing, and we get it working in less time. Unfortunately, sacrificing qualities such as modularity, reusability, and maintainability will sooner or later lead to the uncontrolled proliferation of callback nesting, the growth in the size of functions, and will lead to poor code organization. Most of the time, creating closures is not functionally needed, so it's more a matter of discipline than a problem related to asynchronous programming. Recognizing that our code is becoming unwieldy, or even better, knowing in advance that it might become unwieldy and then acting accordingly with the most adequate solution is what differentiates a novice from an expert.","text_count":991,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Losing control of asynchronous code in JavaScript is undoubtedly easy. Closures and in-place definitions of anonymous functions allow a smooth programming experience that doesn't require the developer to jump to other points in the code base. This is perfectly in line with the KISS principle; it's simple, it keeps the code flowing, and we get it working in less time. Unfortunately, sacrificing qualities such as modularity, reusability, and maintainability will sooner or later lead to the uncontrolled proliferation of callback nesting, the growth in the size of functions, and will lead to poor code organization. Most of the time, creating closures is not functionally needed, so it's more a matter of discipline than a problem related to asynchronous programming. Recognizing that our code is becoming unwieldy, or even better, knowing in advance that it might become unwieldy&nbsp;and then acting accordingly with the most adequate solution is what differentiates a novice from an expert."}]},{"block_type":"element","block":"k5zy5apf","search_text":"Creating a simple web spider","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Creating a simple web spider"}]},{"block_type":"element","block":"k5zy5apg","search_text":"To explain the problem, we will create a little web spider, a command-line application that takes in a web URL as input and downloads its contents locally into a file. In the code presented in this chapter, we are going to use a few npm dependencies:","text_count":250,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To explain the problem, we will create a little web spider, a command-line application that takes in a web URL as input and downloads its contents locally into a file. In the code presented in this chapter, we are going to use a few npm dependencies:"}]},{"block_type":"element","block":"k5zy5aph","search_text":"request : A library to streamline HTTP calls mkdirp : A small utility to create directories recursively ","text_count":104,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request"}]},{"block_type":"text","content":": A library to streamline HTTP calls"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mkdirp"}]},{"block_type":"text","content":": A small utility to create directories recursively"}]}]},{"block_type":"element","block":"k5zy5api","search_text":"Also, we will often refer to a local module named ./utilities which contains some helpers which we will be using in our application. We omit the contents of this file for brevity, but you can find the full implementation, along with a package.json file containing the full list of dependencies, in the download pack for this book available at: http://www.packtpub.com .","text_count":369,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, we will often refer to a local module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"./utilities"}]},{"block_type":"text","content":"which contains some helpers which we will be using in our application. We omit the contents of this file for brevity, but you can find the full implementation, along with a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"package.json"}]},{"block_type":"text","content":"file containing the full list of dependencies, in the download pack for this book available at: &nbsp;"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.packtpub.com"},"children":[{"block_type":"text","content":"http://www.packtpub.com"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5apj","search_text":"The core functionality of our application is contained inside a module named spider.js . Let's see how it looks. To start with, let's load all the dependencies that we are going to use:","text_count":185,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The core functionality of our application is contained inside a module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider.js"}]},{"block_type":"text","content":". Let's see how it looks. To start with, let's load all the dependencies that we are going to use:"}]},{"block_type":"element","block":"k5zy5apk","search_text":"const request = require('request'); const fs = require('fs'); const mkdirp = require('mkdirp'); const path = require('path'); const utilities = require('./utilities'); ","text_count":168,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const request = require('request'); \nconst fs = require('fs'); \nconst mkdirp = require('mkdirp'); \nconst path = require('path'); \nconst utilities = require('./utilities');"}]}]},{"block_type":"element","block":"k5zy5apl","search_text":"Next, we create a new function named spider() , which takes in the URL to download and a callback function that will be invoked when the download process completes:","text_count":164,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, we create a new function named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":", which takes in the URL to download and a callback function that will be invoked when the download process completes:"}]},{"block_type":"element","block":"k5zy5apm","search_text":"function spider(url, callback) { const filename = utilities.urlToFilename(url); fs.exists(filename, exists => { //[1] if(!exists) { console.log(`Downloading ${url}`); request(url, (err, response, body) => { //[2] if(err) { callback(err); } else { mkdirp(path.dirname(filename), err => { //[3] if(err) { callback(err); } else { fs.writeFile(filename, body, err => { //[4] if(err) { callback(err); } else { callback(null, filename, true); } }); } }); } }); } else { callback(null, filename, false); } }); } ","text_count":505,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spider(url, callback) { \n  const filename = utilities.urlToFilename(url); \n  fs.exists(filename, exists =&gt; {                    //[1] \n    if(!exists) { \n      console.log(`Downloading ${url}`); \n      request(url, (err, response, body) =&gt; {        //[2] \n        if(err) { \n          callback(err); \n        } else { \n          mkdirp(path.dirname(filename), err =&gt; {    //[3] \n            if(err) { \n              callback(err); \n            } else { \n              fs.writeFile(filename, body, err =&gt; {  //[4] \n                if(err) { \n                  callback(err); \n                } else { \n                  callback(null, filename, true); \n                } \n              }); \n            } \n          }); \n        } \n      }); \n    } else { \n      callback(null, filename, false); \n    } \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5apn","search_text":"The preceding function executes the following tasks:","text_count":52,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding function executes the following tasks:"}]},{"block_type":"element","block":"k5zy5apo","search_text":"Checks if the URL was already downloaded by verifying that the corresponding file was not already created: fs.exists(filename, exists => ... If the file is not found, the URL is downloaded using the following line of code: request(url, (err, response, body) => ... Then, we make sure whether the directory that will contain the file exists or not: mkdirp(path.dirname(filename), err => ... Finally, we write the body of the HTTP response to the filesystem: fs.writeFile(filename, body, err => ... ","text_count":497,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Checks if the URL was already downloaded by verifying that the corresponding file was not already created:"},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fs.exists(filename, exists =&gt; ..."}]}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If the file is not found, the URL is downloaded using the following line of code:"},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"request(url, (err, response, body) =&gt; ..."}]}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Then, we make sure whether the directory that will contain the file exists or not:"},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"mkdirp(path.dirname(filename), err =&gt; ..."}]}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, we write the body of the HTTP response to the filesystem:"},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fs.writeFile(filename, body, err =&gt; ..."}]}]}]}]},{"block_type":"element","block":"k5zy5app","search_text":"To complete our web spider application, we just need to invoke the spider() function by providing a URL as an input (in our case, we read it from the command-line arguments):","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To complete our web spider application, we just need to invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function by providing a URL as an input (in our case, we read it from the command-line arguments):"}]},{"block_type":"element","block":"k5zy5apq","search_text":"spider(process.argv[2], (err, filename, downloaded) => { if(err) { console.log(err); } else if(downloaded){ console.log(`Completed the download of \"${filename}\"`); } else { console.log(`\"${filename}\" was already downloaded`); } }); ","text_count":232,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"spider(process.argv[2], (err, filename, downloaded) =&gt; { \n  if(err) { \n    console.log(err); \n  } else if(downloaded){ \n    console.log(`Completed the download of \"${filename}\"`); \n  } else { \n    console.log(`\"${filename}\" was already downloaded`); \n  } \n});"}]}]},{"block_type":"element","block":"k5zy5apr","search_text":"Now we are ready to try our web spider application, but first, make sure you have the utilities.js module and the package.json containing the full list of dependencies in your project directory. Then, install all the dependencies by running the following command:","text_count":263,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to try our web spider application, but first, make sure you have the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"utilities.js"}]},{"block_type":"text","content":"module and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"package.json"}]},{"block_type":"text","content":"containing the full list of dependencies in your"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"project"}]},{"block_type":"text","content":"directory. Then, install all the dependencies by running the following command:"}]},{"block_type":"element","block":"k5zy5aps","search_text":"npm install ","text_count":12,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install"}]}]},{"block_type":"element","block":"k5zy5apt","search_text":"Next, we can execute the spider module to download the contents of a web page, with a command like this:","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, we can execute the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider"}]},{"block_type":"text","content":"module to download the contents of a web page, with a command like this:"}]},{"block_type":"element","block":"k5zy5apu","search_text":"node spider http://www.example.com ","text_count":35,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node spider http://www.example.com"}]}]},{"block_type":"element","block":"k5zy5apv","search_text":"Note Our web spider application requires that we always include the protocol (for example, http:// ) in the URL we provide. Also, do not expect HTML links to be rewritten or resources such as images to be downloaded as this is just a simple example to demonstrate how asynchronous programming works. ","text_count":300,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our web spider application requires that we always include the protocol (for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://"}]},{"block_type":"text","content":") in the URL we provide. Also, do not expect HTML links to be rewritten or resources such as images to be downloaded as this is just a simple example to demonstrate how asynchronous programming works."}]}]},{"block_type":"element","block":"k5zy5apw","search_text":"The callback hell","text_count":17,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The callback hell"}]},{"block_type":"element","block":"k5zy5apx","search_text":"Looking at the spider() function we defined earlier, we can surely notice that even though the algorithm we implemented is really straightforward, the resulting code has several levels of indentation and is very hard to read. Implementing a similar function with a direct style blocking API would be straightforward, and there would be very few chances to make it look so wrong. However, using asynchronous CPS is another story, and making bad use of closures can lead to incredibly bad code.","text_count":492,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Looking at the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function we defined earlier, we can surely notice that even though the algorithm we implemented is really straightforward, the resulting code has several levels of indentation and is very hard to read. Implementing a similar function with a direct style blocking API would be straightforward, and there would be very few chances to make it look so wrong. However, using asynchronous CPS is another story, and making bad use of closures can lead to incredibly bad code."}]},{"block_type":"element","block":"k5zy5apy","search_text":"The situation where the abundance of closures and in-place callback definitions transform the code into an unreadable and unmanageable blob is known as callback hell . It's one of the most well recognized and severe anti-patterns in Node.js and JavaScript in general. The typical structure of a code affected by this problem looks like the following:","text_count":350,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The situation where the abundance of closures and in-place callback definitions transform the code into an unreadable and unmanageable blob is known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"callback hell"}]},{"block_type":"text","content":". It's one of the most well recognized and severe anti-patterns in Node.js and JavaScript in general. The typical structure of a code affected by this problem looks like the following:"}]},{"block_type":"element","block":"k5zy5apz","search_text":"asyncFoo( err => { asyncBar( err => { asyncFooBar( err => { //... }); }); }); ","text_count":78,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"asyncFoo( err =&gt; { \n  asyncBar( err =&gt; { \n    asyncFooBar( err =&gt; { \n      //... \n    }); \n  }); \n});"}]}]},{"block_type":"element","block":"k5zy5aq0","search_text":"We can see how code written in this way assumes the shape of a pyramid due to the deep nesting and that's why it is also colloquially known as the pyramid of doom .","text_count":164,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can see how code written in this way assumes the shape of a pyramid due to the deep nesting and that's why it is also colloquially known as the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"pyramid of doom"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aq1","search_text":"The most evident problem with code such as the preceding snippet, is the poor readability. Due to the nesting being too deep, it's almost impossible to keep track of where a function ends and where another one begins.","text_count":217,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most evident problem with code such as the preceding snippet, is the poor readability. Due to the nesting being too deep, it's almost impossible to keep track of where a function ends and where another one begins."}]},{"block_type":"element","block":"k5zy5aq2","search_text":"Another issue is caused by the overlapping of the variable names used in each scope. Often, we have to use similar or even identical names to describe the content of a variable. The best example is the error argument received by each callback. Some people often try to use variations of the same name to differentiate the object in each scope, for example, err , error , err1 , err2 , and so on; others prefer to just hide the variable defined in the scope by always using the same name; for example, err . Both alternatives are far from perfect, and cause confusion and increase the probability of introducing defects.","text_count":619,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another issue is caused by the overlapping of the variable names used in each scope. Often, we have to use similar or even identical names to describe the content of a variable. The best example is the error argument received by each callback. Some people often try to use variations of the same name to differentiate the object in each scope, for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"err"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"err1"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"err2"}]},{"block_type":"text","content":", and so on; others prefer to just hide the variable defined in the scope by always using the same name; for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"err"}]},{"block_type":"text","content":". Both alternatives are far from perfect, and cause confusion and increase the probability of introducing defects."}]},{"block_type":"element","block":"k5zy5aq3","search_text":"Also, we have to keep in mind that closures come at a small price in terms of performance and memory consumption. In addition, they can create memory leaks that are not so easy to identify because we shouldn't forget that any context referenced by an active closure is retained from garbage collection.","text_count":302,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, we have to keep in mind that closures come at a small price in terms of performance and memory consumption. In addition, they can create memory leaks that are not so easy to identify because we shouldn't forget that any context referenced by an active closure is retained from garbage collection."}]},{"block_type":"element","block":"k5zy5aq4","search_text":"Note For a great introduction to how closures work in V8 you can refer to the blog post by Vyacheslav Egorov, a software engineer at Google working on V8, at http://mrale.ph/blog/2012/09/23/grokking-v8-closures-for-fun.html . ","text_count":226,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For a great introduction to how closures work in V8 you can refer to the blog post by Vyacheslav Egorov, a software engineer at Google working on V8, at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://mrale.ph/blog/2012/09/23/grokking-v8-closures-for-fun.html"},"children":[{"block_type":"text","content":"http://mrale.ph/blog/2012/09/23/grokking-v8-closures-for-fun.html"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5aq5","search_text":"If we look at our spider() function, we will notice that it clearly represents a callback hell situation and has all the problems we just described. That's exactly what we are going to fix with the patterns and techniques we will learn in this chapter.","text_count":252,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we look at our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function, we will notice that it clearly represents a callback hell situation and has all the problems we just described. That's exactly what we are going to fix with the patterns and techniques we will learn in this chapter."}]},{"block_type":"element","block":"k5zy5aq6","search_text":"Using plain JavaScript","text_count":22,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Using plain JavaScript"}]},{"block_type":"element","block":"k5zy5aq7","search_text":"Now that we have met our first example of callback hell, we know what we should definitely avoid; however, that's not the only concern when writing asynchronous code. In fact, there are several situations where controlling the flow of a set of asynchronous tasks requires the use of specific patterns and techniques, especially if we are only using plain JavaScript without the aid of any external library. For example, iterating over a collection by applying an asynchronous operation in sequence is not as easy as invoking forEach() over an array, but it actually requires a technique similar to a recursion.","text_count":610,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have met our first example of callback hell, we know what we should definitely avoid; however, that's not the only concern when writing asynchronous code. In fact, there are several situations where controlling the flow of a set of asynchronous tasks requires the use of specific patterns and techniques, especially if we are only using plain JavaScript without the aid of any external library. For example, iterating over a collection by applying an asynchronous operation in sequence is not as easy as invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"forEach()"}]},{"block_type":"text","content":"over an array, but it actually requires a technique similar to a recursion."}]},{"block_type":"element","block":"k5zy5aq8","search_text":"In this section, we will learn not only about how to avoid callback hell but also how to implement some of the most common control flow patterns using only simple and plain JavaScript.","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will learn not only about how to avoid callback hell but also how to implement some of the most common control flow patterns using only simple and plain JavaScript."}]},{"block_type":"element","block":"k5zy5aq9","search_text":"Callback discipline","text_count":19,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Callback discipline"}]},{"block_type":"element","block":"k5zy5aqa","search_text":"When writing asynchronous code, the first rule to keep in mind is to not abuse closures when defining callbacks. It can be tempting to do so, because it does not require any additional thinking for problems such as modularization and reusability; however, we have seen how this can have more disadvantages than advantages. Most of the time, fixing the callback hell problem does not require any libraries, fancy techniques, or change of paradigm, but just some common sense.","text_count":474,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When writing asynchronous code, the first rule to keep in mind is to not abuse closures when defining callbacks. It can be tempting to do so, because it does not require any additional thinking for problems such as modularization and reusability; however, we have seen how this can have more disadvantages than advantages. Most of the time, fixing the callback hell problem does not require any libraries, fancy techniques, or change of paradigm, but just some common sense."}]},{"block_type":"element","block":"k5zy5aqb","search_text":"These are some basic principles that can help us keep the nesting level low and improve the organization of our code in general:","text_count":128,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"These are some basic principles that can help us keep the nesting level low and improve the organization of our code in general:"}]},{"block_type":"element","block":"k5zy5aqc","search_text":"You must exit as soon as possible. Use return , continue , or break , depending on the context, to immediately exit the current statement instead of writing (and nesting) complete if...else statements. This will help keep our code shallow. You need to create named functions for callbacks, keeping them out of closures and passing intermediate results as arguments. Naming our functions will also make them look better in stack traces. You need to modularize the code. Split the code into smaller, reusable functions whenever it's possible. ","text_count":541,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"You must exit as soon as possible. Use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"return"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"continue"}]},{"block_type":"text","content":", or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"break"}]},{"block_type":"text","content":", depending on the context, to immediately exit the current statement instead of writing (and nesting) complete"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if...else"}]},{"block_type":"text","content":"statements. This will help keep our code shallow."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"You need to create named functions for callbacks, keeping them out of closures and passing intermediate results as arguments. Naming our functions will also make them look better in stack traces."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"You need to modularize the code. Split the code into smaller, reusable functions whenever it's possible."}]}]},{"block_type":"element","block":"k5zy5aqd","search_text":"Applying the callback discipline","text_count":32,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Applying the callback discipline"}]},{"block_type":"element","block":"k5zy5aqe","search_text":"To demonstrate the power of the earlier mentioned principles, let's apply them to fix the callback hell problem in our web spider application.","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate the power of the earlier mentioned principles, let's apply them to fix the callback hell problem in our web spider application."}]},{"block_type":"element","block":"k5zy5aqf","search_text":"For the first step, we can refactor our error-checking pattern by removing the else statement. This is made possible by returning from the function immediately after we receive an error. So, instead of having code such as the following:","text_count":236,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For the first step, we can refactor our error-checking pattern by removing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"else"}]},{"block_type":"text","content":"statement. This is made possible by returning from the function immediately after we receive an error. So, instead of having code such as the following:"}]},{"block_type":"element","block":"k5zy5aqg","search_text":"if(err) { callback(err); } else { //code to execute when there are no errors } ","text_count":79,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if(err) { \n  callback(err); \n} else { \n  //code to execute when there are no errors \n}"}]}]},{"block_type":"element","block":"k5zy5aqh","search_text":"We can improve the organization of our code by writing the following one instead:","text_count":81,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can improve the organization of our code by writing the following one instead:"}]},{"block_type":"element","block":"k5zy5aqi","search_text":"if(err) { return callback(err); } //code to execute when there are no errors ","text_count":77,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if(err) { \n  return callback(err); \n} \n//code to execute when there are no errors"}]}]},{"block_type":"element","block":"k5zy5aqj","search_text":"With this simple trick, we immediately have a reduction of the nesting level of our functions; it is easy and doesn't require any complex refactoring.","text_count":150,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this simple trick, we immediately have a reduction of the nesting level of our functions; it is easy and doesn't require any complex refactoring."}]},{"block_type":"element","block":"k5zy5aqk","search_text":"Note A common mistake when executing the optimization we just described is forgetting to terminate the function after the callback is invoked. For the error-handling scenario, the following code is a typical source of defects: if(err) { callback(err); } //code to execute when there are no errors. We should never forget that the execution of our function will continue even after we invoke the callback. It is then important to insert a return instruction to block the execution of the rest of the function. Also note that it doesn't really matter what output is returned by the function; the real result (or error) is produced asynchronously and passed to the callback. The return value of the asynchronous function is usually ignored. This property allows us to write shortcuts such as the following: return callback(...) Otherwise we'd have to write slightly more verbose ones such as the following: callback(...) return; ","text_count":926,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A common mistake when executing the optimization we just described is forgetting to terminate the function after the callback is invoked. For the error-handling scenario, the following code is a typical source of defects:"}]},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if(err) { \n&nbsp; callback(err);\n} //code to execute when there are no errors."}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We should never forget that the execution of our function will continue even after we invoke the callback. It is then important to insert a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"return"}]},{"block_type":"text","content":"instruction to block the execution of the rest of the function. Also note that it doesn't really matter what output is returned by the function; the real result (or error) is produced asynchronously and passed to the callback. The return value of the asynchronous function is usually ignored. This property allows us to write shortcuts such as the following:"}]},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"return callback(...)"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Otherwise we'd have to write slightly more verbose ones such as the following:"}]},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"callback(...)\nreturn;"}]}]}]},{"block_type":"element","block":"k5zy5aql","search_text":"As a second optimization for our spider() function, we can try to identify reusable pieces of code. For example, the functionality that writes a given string to a file can be easily factored out into a separate function as follows:","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a second optimization for our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function, we can try to identify reusable pieces of code. For example, the functionality that writes a given string to a file can be easily factored out into a separate function as follows:"}]},{"block_type":"element","block":"k5zy5aqm","search_text":"function saveFile(filename, contents, callback) { mkdirp(path.dirname(filename), err => { if(err) { return callback(err); } fs.writeFile(filename, contents, callback); }); } ","text_count":174,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function saveFile(filename, contents, callback) { \n  mkdirp(path.dirname(filename), err =&gt; { \n    if(err) { \n      return callback(err); \n    } \n    fs.writeFile(filename, contents, callback); \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5aqn","search_text":"Following the same principle, we can create a generic function named download() which takes a URL and a filename as input, and downloads the URL into the given file. Internally, we can use the saveFile() function we created earlier.","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Following the same principle, we can create a generic function named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"download()"}]},{"block_type":"text","content":"which takes a URL and a filename as input, and downloads the URL into the given file. Internally, we can use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"saveFile()"}]},{"block_type":"text","content":"function we created earlier."}]},{"block_type":"element","block":"k5zy5aqo","search_text":"function download(url, filename, callback) { console.log(`Downloading ${url}`); request(url, (err, response, body) => { if(err) { return callback(err); } saveFile(filename, body, err => { if(err) { return callback(err); } console.log(`Downloaded and saved: ${url}`); callback(null, body); }); }); } ","text_count":299,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function download(url, filename, callback) { \n  console.log(`Downloading ${url}`); \n  request(url, (err, response, body) =&gt; { \n    if(err) { \n      return callback(err); \n    } \n    saveFile(filename, body, err =&gt; { \n      if(err) { \n        return callback(err); \n      } \n      console.log(`Downloaded and saved: ${url}`); \n      callback(null, body); \n    }); \n  });   \n}"}]}]},{"block_type":"element","block":"k5zy5aqp","search_text":"For the last step, we modify the spider() function, which, thanks to our changes, will now look like the following:","text_count":115,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For the last step, we modify the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function, which, thanks to our changes, will now look like the following:"}]},{"block_type":"element","block":"k5zy5aqq","search_text":"function spider(url, callback) { const filename = utilities.urlToFilename(url); fs.exists(filename, exists => { if(exists) { return callback(null, filename, false); } download(url, filename, err => { if(err) { return callback(err); } callback(null, filename, true); }) }); } ","text_count":275,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spider(url, callback) { \n  const filename = utilities.urlToFilename(url); \n  fs.exists(filename, exists =&gt; { \n    if(exists) { \n      return callback(null, filename, false); \n    } \n    download(url, filename, err =&gt; { \n      if(err) { \n        return callback(err); \n      } \n      callback(null, filename, true); \n    }) \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5aqr","search_text":"The functionality and the interface of the spider() function remain exactly the same; what changed is only the way the code was organized. By applying the basic principles that we discussed, we were able to drastically reduce the nesting of our code and at the same time increase its reusability and testability. In fact, we could think of exporting both saveFile() and download() , so that we can reuse them in other modules. This also allows us to test their functionality more easily.","text_count":487,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The functionality and the interface of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function remain exactly the same; what changed is only the way the code was organized. By applying the basic principles that we discussed, we were able to drastically reduce the nesting of our code and at the same time increase its reusability and testability. In fact, we could think of exporting both"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"saveFile()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"download()"}]},{"block_type":"text","content":", so that we can reuse them in other modules. This also allows us to test their functionality more easily."}]},{"block_type":"element","block":"k5zy5aqs","search_text":"The refactoring we carried out in this section clearly demonstrates that most of the time, all we need is just some discipline to make sure we do not abuse closures and anonymous functions. It works brilliantly, requires minimal effort, and just uses plain JavaScript.","text_count":268,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The refactoring we carried out in this section clearly demonstrates that most of the time, all we need is just some discipline to make sure we do not abuse closures and anonymous functions. It works brilliantly, requires minimal effort, and just uses plain JavaScript."}]},{"block_type":"element","block":"k5zy5aqt","search_text":"Sequential execution","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sequential execution"}]},{"block_type":"element","block":"k5zy5aqu","search_text":"We now begin our exploration of the asynchronous control flow patterns. We will start by analyzing the sequential execution flow.","text_count":129,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We now begin our exploration of the asynchronous control flow patterns. We will start by analyzing the sequential execution flow."}]},{"block_type":"element","block":"k5zy5aqv","search_text":"Executing a set of tasks in sequence means running them one at a time, one after the other. The order of execution matters and must be preserved, because the result of a task in the list may affect the execution of the next. The following image illustrates this concept:","text_count":270,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Executing a set of tasks in sequence means running them one at a time, one after the other. The order of execution matters and must be preserved, because the result of a task in the list may affect the execution of the next. The following image illustrates this concept:"}]},{"block_type":"element","block":"k5zy5aqw","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000027.jpg","alt":"Sequential execution","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5aqx","search_text":"There are different variations of this flow:","text_count":44,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are different variations of this flow:"}]},{"block_type":"element","block":"k5zy5aqy","search_text":"Executing a set of known tasks in sequence, without chaining or propagating results Using the output of a task as the input for the next (also known as chain , pipeline , or waterfall ) Iterating over a collection while running an asynchronous task on each element, one after the other ","text_count":286,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Executing a set of known tasks in sequence, without chaining or propagating results"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using the output of a task as the input for the next (also known as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"chain"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pipeline"}]},{"block_type":"text","content":", or"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"waterfall"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Iterating over a collection while running an asynchronous task on each element, one after the other"}]}]},{"block_type":"element","block":"k5zy5aqz","search_text":"Sequential execution, despite being trivial when implemented using the direct style blocking API, is usually the main cause of the callback hell problem when using asynchronous CPS.","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sequential execution, despite being trivial when implemented using the direct style blocking API, is usually the main cause of the callback hell problem when using asynchronous CPS."}]},{"block_type":"element","block":"k5zy5ar0","search_text":"Executing a known set of tasks in sequence","text_count":42,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Executing a known set of tasks in sequence"}]},{"block_type":"element","block":"k5zy5ar1","search_text":"We already met a sequential execution while implementing the spider() function in the previous section. By applying the simple rules that we studied, we were able to organize a set of known tasks in a sequential execution flow. Taking that code as a guideline, we can then generalize the solution with the following pattern:","text_count":324,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We already met a sequential execution while implementing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function in the previous section. By applying the simple rules that we studied, we were able to organize a set of known tasks in a sequential execution flow. Taking that code as a guideline, we can then generalize the solution with the following pattern:"}]},{"block_type":"element","block":"k5zy5ar2","search_text":"function task1(callback) { asyncOperation(() => { task2(callback); }); } function task2(callback) { asyncOperation(result () => { task3(callback); }); } function task3(callback) { asyncOperation(() => { callback(); //finally executes the callback }); } task1(() => { //executed when task1, task2 and task3 are completed console.log('tasks 1, 2 and 3 executed'); }); ","text_count":366,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function task1(callback) { \n  asyncOperation(() =&gt; { \n    task2(callback); \n  }); \n} \n \nfunction task2(callback) { \n  asyncOperation(result () =&gt; { \n    task3(callback); \n  }); \n} \n \nfunction task3(callback) { \n  asyncOperation(() =&gt; { \n    callback(); //finally executes the callback \n  }); \n} \n \ntask1(() =&gt; { \n  //executed when task1, task2 and task3 are completed \n  console.log('tasks 1, 2 and 3 executed');\n});"}]}]},{"block_type":"element","block":"k5zy5ar3","search_text":"The preceding pattern shows how each task invokes the next upon the completion of a generic asynchronous operation. The pattern puts the emphasis on the modularization of tasks, showing how closures are not always necessary to handle asynchronous code.","text_count":252,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding pattern shows how each task invokes the next upon the completion of a generic asynchronous operation. The pattern puts the emphasis on the modularization of tasks, showing how closures are not always necessary to handle asynchronous code."}]},{"block_type":"element","block":"k5zy5ar4","search_text":"Sequential iteration","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sequential iteration"}]},{"block_type":"element","block":"k5zy5ar5","search_text":"The pattern we described earlier works perfectly if we know in advance what and how many tasks are to be executed. This allows us to hardcode the invocation of the next task in the sequence; but what happens if we want to execute an asynchronous operation for each item in a collection? In cases such as this, we cannot hardcode the task sequence anymore; instead, we have to build it dynamically.","text_count":397,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The pattern we described earlier works perfectly if we know in advance what and how many tasks are to be executed. This allows us to hardcode the invocation of the next task in the sequence; but what happens if we want to execute an asynchronous operation for each item in a collection? In cases such as this, we cannot hardcode the task sequence anymore; instead, we have to build it dynamically."}]},{"block_type":"element","block":"k5zy5ar6","search_text":"Web spider version 2","text_count":20,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Web spider version 2"}]},{"block_type":"element","block":"k5zy5ar7","search_text":"To show an example of sequential iteration, let's introduce a new feature to the web spider application. We now want to download all the links contained in a web page recursively. To do that, we are going to extract all the links from the page and then trigger our web spider on each one of them recursively and in sequence.","text_count":324,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To show an example of sequential iteration, let's introduce a new feature to the web spider application. We now want to download all the links contained in a web page recursively. To do that, we are going to extract all the links from the page and then trigger our web spider on each one of them recursively and in sequence."}]},{"block_type":"element","block":"k5zy5ar8","search_text":"The first step is modifying our spider() function so that it triggers a recursive download of all the links of a page by using a function named spiderLinks() , which we are going to create shortly.","text_count":197,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first step is modifying our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function so that it triggers a recursive download of all the links of a page by using a function named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":", which we are going to create shortly."}]},{"block_type":"element","block":"k5zy5ar9","search_text":"Also, instead of checking if the file already exists, we now try to read it, and start spidering its links; this way, we are able to resume interrupted downloads. As a final change, we make sure we propagate a new parameter, nesting , which helps us limit the recursion depth. The resultant code is as follows:","text_count":310,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, instead of checking if the file already exists, we now try to read it, and start spidering its links; this way, we are able to resume interrupted downloads. As a final change, we make sure we propagate a new parameter,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"nesting"}]},{"block_type":"text","content":", which helps us limit the recursion depth. The resultant code is as follows:"}]},{"block_type":"element","block":"k5zy5ara","search_text":"function spider(url, nesting, callback) { const filename = utilities.urlToFilename(url); fs.readFile(filename, 'utf8', (err, body) => { if(err) { if(err.code ! == 'ENOENT') { return callback(err); } return download(url, filename, (err, body) => { if(err) { return callback(err); } spiderLinks(url, body, nesting, callback); }); } spiderLinks(url, body, nesting, callback); }); } ","text_count":379,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spider(url, nesting, callback) { \n  const filename = utilities.urlToFilename(url); \n  fs.readFile(filename, 'utf8', (err, body) =&gt; { \n    if(err) { \n      if(err.code ! == 'ENOENT') { \n        return callback(err); \n      } \n \n      return download(url, filename, (err, body) =&gt; { \n        if(err) { \n          return callback(err); \n        } \n        spiderLinks(url, body, nesting, callback); \n      }); \n    } \n \n    spiderLinks(url, body, nesting, callback); \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5arb","search_text":"Sequential crawling of links","text_count":28,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Sequential crawling of links"}]},{"block_type":"element","block":"k5zy5arc","search_text":"Now we can create the core of this new version of our web spider application, the spiderLinks() function, which downloads all the links of an HTML page using a sequential asynchronous iteration algorithm. Pay attention to the way we are going to define that in the following code block:","text_count":286,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we can create the core of this new version of our web spider application, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function, which downloads all the links of an HTML page using a sequential asynchronous iteration algorithm. Pay attention to the way we are going to define that in the following code block:"}]},{"block_type":"element","block":"k5zy5ard","search_text":"function spiderLinks(currentUrl, body, nesting, callback) { if(nesting === 0) { return process.nextTick(callback); } const links = utilities.getPageLinks(currentUrl, body); //[1] function iterate(index) { //[2] if(index === links.length) { return callback(); } spider(links[index], nesting - 1, err => { //[3] if(err) { return callback(err); } iterate(index + 1); }); } iterate(0); //[4] } ","text_count":390,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting, callback) { \n  if(nesting === 0) { \n    return process.nextTick(callback); \n  } \n  const links = utilities.getPageLinks(currentUrl, body);  //[1] \n  function iterate(index) {                                //[2] \n    if(index === links.length) { \n      return callback(); \n    } \n \n    spider(links[index], nesting - 1, err =&gt; {             //[3] \n      if(err) { \n        return callback(err); \n      } \n      iterate(index + 1); \n    }); \n  } \n  iterate(0);                                              //[4] \n}"}]}]},{"block_type":"element","block":"k5zy5are","search_text":"The important steps to understand from this new function are as follows:","text_count":72,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The important steps to understand from this new function are as follows:"}]},{"block_type":"element","block":"k5zy5arf","search_text":"We obtain the list of all the links contained in the page using the utilities.getPageLinks() function. This function returns only the links pointing to an internal destination (same hostname). We iterate over the links using a local function called iterate() , which takes the index of the next link to analyze. In this function, the first thing we do is check if the index is equal to the length of the links array, in which case we immediately invoke the callback() function, as it means we processed all the items. At this point, everything should be ready for processing the link. We invoke the spider() function by decreasing the nesting level and invoking the next step of the iteration when the operation completes. As the last step in the spiderLinks() function, we bootstrap the iteration by invoking iterate(0) . ","text_count":823,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We obtain the list of all the links contained in the page using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"utilities.getPageLinks()"}]},{"block_type":"text","content":"function. This function returns only the links pointing to an internal destination (same hostname)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We iterate over the links using a local function called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"iterate()"}]},{"block_type":"text","content":", which takes the index of the next link to analyze. In this function, the first thing we do is check if the index is equal to the length of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"links"}]},{"block_type":"text","content":"array, in which case we immediately invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback()"}]},{"block_type":"text","content":"function, as it means we processed all the items."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At this point, everything should be ready for processing the link. We invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function by decreasing the nesting level and invoking the next step of the iteration when the operation completes."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"As the last step in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function, we bootstrap the iteration by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"iterate(0)"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5arg","search_text":"The algorithm we just presented allows us to iterate over an array by executing an asynchronous operation in sequence, which in our case is the spider() function.","text_count":162,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The algorithm we just presented allows us to iterate over an array by executing an asynchronous operation in sequence, which in our case is the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","block":"k5zy5arh","search_text":"We can now try this new version of the spider application and watch it download all the links of a web page recursively, one after the other. To interrupt the process, which can take a while if there are many links, remember that we can always use Ctrl + C . If we then decide to resume it, we can do so by launching the spider application and providing the same URL we used for the first run.","text_count":393,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now try this new version of the spider application and watch it download all the links of a web page recursively, one after the other. To interrupt the process, which can take a while if there are many links, remember that we can always use"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Ctrl"}]},{"block_type":"text","content":"+"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"C"}]},{"block_type":"text","content":". If we then decide to resume it, we can do so by launching the spider application and providing the same URL we used for the first run."}]},{"block_type":"element","block":"k5zy5ari","search_text":"Note Now that our web spider application might potentially trigger the download of an entire website, please consider using it carefully. For example, do not set a high nesting level or leave the spider running for more than a few seconds. It is not polite to overload a server with thousands of requests. In some circumstances this can also be considered illegal. Spider responsibly! ","text_count":385,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that our web spider application might potentially trigger the download of an entire website, please consider using it carefully. For example, do not set a high nesting level or leave the spider running for more than a few seconds. It is not polite to overload a server with thousands of requests. In some circumstances this can also be considered illegal. Spider responsibly!"}]}]},{"block_type":"element","block":"k5zy5arj","search_text":"The pattern","text_count":11,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The pattern"}]},{"block_type":"element","block":"k5zy5ark","search_text":"The code of the spiderLinks() function that we showed previously is a clear example of how it's possible to iterate over a collection while applying an asynchronous operation. We can also notice that it's a pattern that can be adapted to any other situation where we have the need to iterate asynchronously in sequence over the elements of a collection or in general over a list of tasks. This pattern can be generalized as follows:","text_count":432,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code of the&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function that we showed previously is a clear example of how it's possible to iterate over a collection while applying an asynchronous operation. We can also notice that it's a pattern that can be adapted to any other situation where we have the need to iterate asynchronously in sequence over the elements of a collection or in general over a list of tasks. This pattern can be generalized as follows:"}]},{"block_type":"element","block":"k5zy5arl","search_text":"function iterate(index) { if(index === tasks.length) { return finish(); } const task = tasks[index]; task(function() { iterate(index + 1); }); } function finish() { //iteration completed } iterate(0); ","text_count":201,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function iterate(index) { \n  if(index === tasks.length)  { \n    return finish(); \n  } \n  const task = tasks[index]; \n  task(function() { \n    iterate(index + 1); \n  }); \n} \n \nfunction finish() { \n  //iteration completed \n} \n \niterate(0);"}]}]},{"block_type":"element","block":"k5zy5arm","search_text":"Note It's important to notice that these types of algorithm become really recursive if task() is a synchronous operation. In such a case, the stack will not unwind at every cycle and there might be a risk of hitting the maximum call stack size limit. ","text_count":251,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to notice that these types of algorithm become really recursive if"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"task()"}]},{"block_type":"text","content":"is a synchronous operation. In such a case, the stack will not unwind at every cycle and there might be a risk of hitting the maximum call stack size limit."}]}]},{"block_type":"element","block":"k5zy5arn","search_text":"The pattern we just presented is very powerful as it can adapt to several situations; for example, we can map the values of an array or we can pass the results of an operation to the next one in the iteration to implement a reduce algorithm, we can quit the loop prematurely if a particular condition is met, or we can even iterate over an infinite number of elements.","text_count":368,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The pattern we just presented is very powerful as it can adapt to several situations; for example, we can map the values of an array or we can pass the results of an operation to the next one in the iteration to implement a reduce algorithm, we can quit the loop prematurely if a particular condition is met, or we can even iterate over an infinite number of elements."}]},{"block_type":"element","block":"k5zy5aro","search_text":"We could also choose to generalize the solution even further by wrapping it into a function having a signature such as the following:","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We could also choose to generalize the solution even further by wrapping it into a function having a signature such as the following:"}]},{"block_type":"element","block":"k5zy5arp","search_text":"iterateSeries(collection, iteratorCallback, finalCallback) ","text_count":59,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"iterateSeries(collection, iteratorCallback, finalCallback)"}]}]},{"block_type":"element","block":"k5zy5arq","search_text":"We leave this to you as an exercise.","text_count":36,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We leave this to you as an exercise."}]},{"block_type":"element","block":"k5zy5arr","search_text":"Note Pattern (sequential iterator) Execute a list of tasks in sequence by creating a function named iterator , which invokes the next available task in the collection and makes sure to invoke the next step of the iteration when the current task completes. ","text_count":256,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern (sequential iterator)"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Execute a list of tasks in sequence by creating a function named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"iterator"}]},{"block_type":"text","content":", which invokes the next available task in the collection and makes sure to invoke the next step of the iteration when the current task completes."}]}]},{"block_type":"element","block":"k5zy5ars","search_text":"Parallel execution","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Parallel execution"}]},{"block_type":"element","block":"k5zy5art","search_text":"There are some situations where the order of execution of a set of asynchronous tasks is not important and all we want is just to be notified when all those running tasks are completed. Such situations are better handled using a parallel execution flow, as shown in the following diagram:","text_count":288,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are some situations where the order of execution of a set of asynchronous tasks is not important and all we want is just to be notified when all those running tasks are completed. Such situations are better handled using a parallel execution flow, as shown in the following diagram:"}]},{"block_type":"element","block":"k5zy5aru","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000048.jpg","alt":"Parallel execution","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5arv","search_text":"This may sound strange if we consider that Node.js is single threaded, but if we remember what we discussed in Chapter 1, Welcome to the Node.js Platform , we realize that even though we have just one thread, we can still achieve concurrency, thanks to the non-blocking nature of Node.js. In fact, the word parallel is used improperly in this case, as it does not mean that the tasks run simultaneously, but rather that their execution is carried out by an underlying non-blocking API and interleaved by the event loop.","text_count":519,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This may sound strange if we consider that Node.js is single threaded, but if we remember what we discussed in Chapter 1,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Welcome to the Node.js Platform"}]},{"block_type":"text","content":", we realize that even though we have just one thread, we can still achieve concurrency, thanks to the non-blocking nature of Node.js. In fact, the word"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"parallel"}]},{"block_type":"text","content":"is used improperly in this case, as it does not mean that the tasks run simultaneously, but rather that their execution is carried out by an underlying non-blocking API and interleaved by the event loop."}]},{"block_type":"element","block":"k5zy5arw","search_text":"As we know, a task gives control back to the event loop when it requests a new asynchronous operation allowing the event loop to execute another task. The proper word to use for this kind of flow is concurrency , but we will still use parallel for simplicity.","text_count":259,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we know, a task gives control back to the event loop when it requests a new asynchronous operation allowing the event loop to execute another task. The proper word to use for this kind of flow is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"concurrency"}]},{"block_type":"text","content":", but we will still use parallel for simplicity."}]},{"block_type":"element","block":"k5zy5arx","search_text":"The following diagram shows how two asynchronous tasks can run in parallel in a Node.js program:","text_count":96,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following diagram shows how two asynchronous tasks can run in parallel in a Node.js program:"}]},{"block_type":"element","block":"k5zy5ary","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000065.jpg","alt":"Parallel execution","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5arz","search_text":"In the previous image, we have a Main function that executes two asynchronous tasks:","text_count":84,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous image, we have a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Main"}]},{"block_type":"text","content":"function that executes two asynchronous tasks:"}]},{"block_type":"element","block":"k5zy5as0","search_text":"The Main function triggers the execution of Task 1 and Task 2 . As these trigger an asynchronous operation, they immediately return the control back to the Main function, which then returns it to the event loop. When the asynchronous operation of Task 1 is completed, the event loop gives control to it. When Task 1 completes its internal synchronous processing as well, it notifies the Main function. When the asynchronous operation triggered by Task 2 is completed, the event loop invokes its callback, giving the control back to Task 2 . At the end of Task 2 , the Main function is again notified. At this point, the Main function knows that both Task 1 and Task 2 are complete, so it can continue its execution or return the results of the operations to another callback. ","text_count":776,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Main"}]},{"block_type":"text","content":"function triggers the execution of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 1"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 2"}]},{"block_type":"text","content":". As these trigger an asynchronous operation, they immediately return the control back to the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Main"}]},{"block_type":"text","content":"function, which then returns it to the event loop."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the asynchronous operation of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 1"}]},{"block_type":"text","content":"is completed, the event loop gives control to it. When"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 1"}]},{"block_type":"text","content":"completes its internal synchronous processing as well, it notifies the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Main"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the asynchronous operation triggered by"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 2"}]},{"block_type":"text","content":"is completed, the event loop invokes its callback, giving the control back to"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 2"}]},{"block_type":"text","content":". At the end of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 2"}]},{"block_type":"text","content":", the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Main"}]},{"block_type":"text","content":"function is again notified. At this point, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Main"}]},{"block_type":"text","content":"function knows that both"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 1"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 2"}]},{"block_type":"text","content":"are complete, so it can continue its execution or return the results of the operations to another callback."}]}]},{"block_type":"element","block":"k5zy5as1","search_text":"In short, this means that in Node.js, we can only execute in parallel asynchronous operations, because their concurrency is handled internally by the non-blocking APIs. In Node.js, synchronous (blocking) operations cannot run concurrently unless their execution is interleaved with an asynchronous operation, or deferred with setTimeout() or setImmediate() . We will see this in more detail in Chapter 9, Advanced Asynchronous Recipes .","text_count":436,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In short, this means that in Node.js, we can only execute in parallel asynchronous operations, because their concurrency is handled internally by the non-blocking APIs. In Node.js, synchronous (blocking) operations cannot run concurrently unless their execution is interleaved with an asynchronous operation, or deferred with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setTimeout()"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":". We will see this in more detail in Chapter 9,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Advanced Asynchronous Recipes"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5as2","search_text":"Web spider version 3","text_count":20,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Web spider version 3"}]},{"block_type":"element","block":"k5zy5as3","search_text":"Our web spider application seems like a perfect candidate to apply the concept of parallel execution. So far, our application is executing the recursive download of the linked pages in a sequential fashion. We can easily improve the performance of this process by downloading all the linked pages in parallel.","text_count":309,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our web spider application seems like a perfect candidate to apply the concept of parallel execution. So far, our application is executing the recursive download of the linked pages in a sequential fashion. We can easily improve the performance of this process by downloading all the linked pages in parallel."}]},{"block_type":"element","block":"k5zy5as4","search_text":"To do that, we just need to modify the spiderLinks() function to make sure to spawn all the spider() tasks at once, and then invoke the final callback only when all of them have completed their execution. So let's modify our spiderLinks() function as follows:","text_count":259,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To do that, we just need to modify the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function to make sure to spawn all the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"tasks at once, and then invoke the final callback only when all of them have completed their execution. So let's modify our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function as follows:"}]},{"block_type":"element","block":"k5zy5as5","search_text":"function spiderLinks(currentUrl, body, nesting, callback) { if(nesting === 0) { return process.nextTick(callback); } const links = utilities.getPageLinks(currentUrl, body); if(links.length === 0) { return process.nextTick(callback); } let completed = 0, hasErrors = false; function done(err) { if(err) { hasErrors = true; return callback(err); } if(++completed === links.length && !hasErrors) { return callback(); } } links.forEach(link => { spider(link, nesting - 1, done); }); } ","text_count":481,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting, callback) { \n  if(nesting === 0) { \n    return process.nextTick(callback); \n  } \n  const links = utilities.getPageLinks(currentUrl, body); \n  if(links.length === 0) { \n    return process.nextTick(callback); \n  } \n \n  let completed = 0, hasErrors = false; \n \n  function done(err) { \n    if(err) { \n      hasErrors = true; \n      return callback(err); \n    } \n    if(++completed === links.length && !hasErrors) { \n      return callback(); \n    } \n  } \n \n  links.forEach(link =&gt; { \n    spider(link, nesting - 1, done); \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5as6","search_text":"Let's explain what we changed. As we mentioned earlier, the spider() tasks are now started all at once. This is possible by simply iterating over the links array and starting each task without waiting for the previous one to finish:","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's explain what we changed. As we mentioned earlier, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"tasks are now started all at once. This is possible by simply iterating over the links array and starting each task without waiting for the previous one to finish:"}]},{"block_type":"element","block":"k5zy5as7","search_text":"links.forEach(link => { spider(link, nesting - 1, done); }); ","text_count":61,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"links.forEach(link =&gt; { \n    spider(link, nesting - 1, done); \n  });"}]}]},{"block_type":"element","block":"k5zy5as8","search_text":"Then, the trick to make our application wait for all the tasks to complete is to provide the spider() function with a special callback, which we call done() . The done() function increases a counter when a spider task completes. When the number of completed downloads reaches the size of the links array, the final callback is invoked:","text_count":335,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, the trick to make our application wait for all the tasks to complete is to provide the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function with a special callback, which we call"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done()"}]},{"block_type":"text","content":". The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done()"}]},{"block_type":"text","content":"function increases a counter when a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider"}]},{"block_type":"text","content":"task completes. When the number of completed downloads reaches the size of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"links"}]},{"block_type":"text","content":"array, the final callback is invoked:"}]},{"block_type":"element","block":"k5zy5as9","search_text":"function done(err) { if(err) { hasErrors = true; return callback(err); } if(++completed === links.length && !hasErrors) { callback(); } } ","text_count":138,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function done(err) { \n  if(err) { \n    hasErrors = true; \n    return callback(err); \n  } \n  if(++completed === links.length && !hasErrors) { \n    callback(); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5asa","search_text":"With these changes in place, if we now try to run our spider against a web page, we will notice a huge improvement in the speed of the overall process, as every download is carried out in parallel without waiting for the previous link to be processed.","text_count":251,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With these changes in place, if we now try to run our spider against a web page, we will notice a huge improvement in the speed of the overall process, as every download is carried out in parallel without waiting for the previous link to be processed."}]},{"block_type":"element","block":"k5zy5asb","search_text":"The pattern","text_count":11,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The pattern"}]},{"block_type":"element","block":"k5zy5asc","search_text":"Also, for the parallel execution flow, we can extract our nice little pattern, which we can adapt and reuse for different situations. We can represent a generic version of the pattern with the following code:","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, for the parallel execution flow, we can extract our nice little pattern, which we can adapt and reuse for different situations. We can represent a generic version of the pattern with the following code:"}]},{"block_type":"element","block":"k5zy5asd","search_text":"const tasks = [ /* ... */ ]; let completed = 0; tasks.forEach(task => { task(() => { if(++completed === tasks.length) { finish(); } }); }); function finish() { //all the tasks completed } ","text_count":188,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const tasks = [ /* ... */ ]; \nlet completed = 0; \ntasks.forEach(task =&gt; { \n  task(() =&gt; { \n    if(++completed === tasks.length) { \n      finish(); \n    } \n  }); \n}); \n \nfunction finish() { \n  //all the tasks completed \n}"}]}]},{"block_type":"element","block":"k5zy5ase","search_text":"With small modifications, we can adapt the pattern to accumulate the results of each task into a collection, to filter or map the elements of an array, or to invoke the finish() callback as soon as one or a given number of tasks complete (this last situation in particular is called competitive race ).","text_count":302,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With small modifications, we can adapt the pattern to accumulate the results of each task into a collection, to filter or map the elements of an array, or to invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"finish()"}]},{"block_type":"text","content":"callback as soon as one or a given number of tasks complete (this last situation in particular is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"competitive race"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5asf","search_text":"Note Pattern (unlimited parallel execution) Run a set of asynchronous tasks in parallel by spawning them all at once, and then wait for all of them to complete by counting the number of times their callbacks are invoked. ","text_count":221,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern (unlimited parallel execution)"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Run a set of asynchronous tasks in parallel by spawning them all at once, and then wait for all of them to complete by counting the number of times their callbacks are invoked."}]}]},{"block_type":"element","block":"k5zy5asg","search_text":"Fixing race conditions with concurrent tasks","text_count":44,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Fixing race conditions with concurrent tasks"}]},{"block_type":"element","block":"k5zy5ash","search_text":"Running a set of tasks in parallel can cause issues when using blocking I/O in combination with multiple threads. However, we have just seen that in Node.js this is a totally different story; running multiple asynchronous tasks in parallel is in fact straightforward and cheap in terms of resources. This is one of the most important strengths for Node.js, because it makes parallelization a common practice rather than a complex technique to only use when strictly necessary.","text_count":476,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Running a set of tasks in parallel can cause issues when using blocking I/O in combination with multiple threads. However, we have just seen that in Node.js this is a totally different story; running multiple asynchronous tasks in parallel is in fact straightforward and cheap in terms of resources. This is one of the most important strengths for Node.js, because it makes parallelization a common practice rather than a complex technique to only use when strictly necessary."}]},{"block_type":"element","block":"k5zy5asi","search_text":"Another important characteristic of the concurrency model of Node.js is the way we deal with task synchronization and race conditions. In multithreaded programming, this is usually done using constructs such as locks, mutexes, semaphores, and monitors, and it can be one of the most complex aspects of parallelization, which has considerable impact on performances as well. In Node.js, we usually don't need a fancy synchronization mechanism, as everything runs on a single thread! However, this doesn't mean that we can't have race conditions; on the contrary, they can be quite common. The root of the problem is the delay between the invocation of an asynchronous operation and the notification of its result. To make a concrete example, we can refer again to our web spider application, in particular, the last version we created, which actually contains a race condition (can you spot it?).","text_count":895,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another important characteristic of the concurrency model of Node.js is the way we deal with task synchronization and race conditions. In multithreaded programming, this is usually done using constructs such as locks, mutexes, semaphores, and monitors, and it can be one of the most complex aspects of parallelization, which has considerable impact on performances as well. In Node.js, we usually don't need a fancy synchronization mechanism, as everything runs on a single thread! However, this doesn't mean that we can't have race conditions; on the contrary, they can be quite common. The root of the problem is the delay between the invocation of an asynchronous operation and the notification of its result. To make a concrete example, we can refer again to our web spider application, in particular, the last version we created, which actually contains a race condition (can you spot it?)."}]},{"block_type":"element","block":"k5zy5asj","search_text":"The problem we are talking about lies in the spider() function, where we check if a file already exists, before starting to download the corresponding URL:","text_count":155,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The problem we are talking about lies in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function, where we check if a file already exists, before starting to download the corresponding URL:"}]},{"block_type":"element","block":"k5zy5ask","search_text":"function spider(url, nesting, callback) { const filename = utilities.urlToFilename(url); fs.readFile(filename, 'utf8', (err, body) => { if(err) { if(err.code !== 'ENOENT') { return callback(err); } return download(url, filename, function(err, body) { //... ","text_count":257,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spider(url, nesting, callback) { \n  const filename = utilities.urlToFilename(url); \n  fs.readFile(filename, 'utf8', (err, body) =&gt; { \n    if(err) { \n      if(err.code !== 'ENOENT') { \n        return callback(err); \n      } \n \n      return download(url, filename, function(err, body) { \n//..."}]}]},{"block_type":"element","block":"k5zy5asl","search_text":"The problem is that, two spider tasks operating on the same URL might invoke fs.readFile() on the same file before one of the two tasks completes the download and creates a file, causing both tasks to start a download. This situation is shown in the following diagram:","text_count":268,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The problem is that, two"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider"}]},{"block_type":"text","content":"tasks operating on the same URL might invoke"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs.readFile()"}]},{"block_type":"text","content":"on the same file before one of the two tasks completes the download and creates a file, causing both tasks to start a download. This situation is shown in the following diagram:"}]},{"block_type":"element","block":"k5zy5asm","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000052.jpg","alt":"Fixing race conditions with concurrent tasks","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5asn","search_text":"The preceding diagram shows how Task 1 and Task 2 are interleaved in the single thread of Node.js and how an asynchronous operation can actually introduce a race condition. In our case, the two spider tasks end up downloading the same file.","text_count":240,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding diagram shows how"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 1"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Task 2"}]},{"block_type":"text","content":"are interleaved in the single thread of Node.js and how an asynchronous operation can actually introduce a race condition. In our case, the two"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider"}]},{"block_type":"text","content":"tasks end up downloading the same file."}]},{"block_type":"element","block":"k5zy5aso","search_text":"How can we fix that? The answer is much simpler than we might think. In fact, all we need is a variable to mutually exclude multiple spider() tasks running on the same URL. This can be achieved with some code such as the following:","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"How can we fix that? The answer is much simpler than we might think. In fact, all we need is a variable to mutually exclude multiple"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"tasks running on the same URL. This can be achieved with some code such as the following:"}]},{"block_type":"element","block":"k5zy5asp","search_text":"const spidering = new Map(); function spider(url, nesting, callback) { if(spidering.has(url)) { return process.nextTick(callback); } spidering.set(url, true); //... ","text_count":165,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const spidering = new Map(); \nfunction spider(url, nesting, callback) { \n  if(spidering.has(url)) { \n    return process.nextTick(callback); \n  } \n  spidering.set(url, true); \n \n//..."}]}]},{"block_type":"element","block":"k5zy5asq","search_text":"The fix does not require many comments. We simply exit the function immediately if the flag for the given url is set in the spidering map; otherwise, we set the flag and continue with the download. For our case, we don't need to release the lock, as we are not interested in downloading a URL twice, even if the spider tasks are executed at two completely different points in time.","text_count":381,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The fix does not require many comments. We simply exit the function immediately if the flag for the given"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"url"}]},{"block_type":"text","content":"is set in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spidering"}]},{"block_type":"text","content":"map; otherwise, we set the flag and continue with the download. For our case, we don't need to release the lock, as we are not interested in downloading a URL twice, even if the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider"}]},{"block_type":"text","content":"tasks are executed at two completely different points in time."}]},{"block_type":"element","block":"k5zy5asr","search_text":"Race conditions can cause many problems, even if we are in a single-threaded environment. In some circumstances, they can lead to data corruption and are usually very hard to debug because of their ephemeral nature. So, it's always good practice to double check for this type of situation when running tasks in parallel.","text_count":320,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Race conditions can cause many problems, even if we are in a single-threaded environment. In some circumstances, they can lead to data corruption and are usually very hard to debug because of their ephemeral nature. So, it's always good practice to double check for this type of situation when running tasks in parallel."}]},{"block_type":"element","block":"k5zy5ass","search_text":"Limited parallel execution","text_count":26,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Limited parallel execution"}]},{"block_type":"element","block":"k5zy5ast","search_text":"Often, spawning parallel tasks without control can lead to an excessive load. Imagine having thousands of files to read, URLs to access, or database queries to run in parallel. A common problem in such situations is running out of resources, for example, by utilizing all the file descriptors available for an application when trying to open too many files at once. In a web application, it may also create a vulnerability that is exploitable with Denial of Service ( DoS ) attacks. In all such situations, it is a good idea to limit the number of tasks that can run at the same time. This way, we can add some predictability to the load of our server and also make sure that our application will not run out of resources. The following diagram describes a situation where we have five tasks that run in parallel with a concurrency limit of 2:","text_count":843,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Often, spawning parallel tasks without control can lead to an excessive load. Imagine having thousands of files to read, URLs to access, or database queries to run in parallel. A common problem in such situations is running out of resources, for example, by utilizing all the file descriptors available for an application when trying to open too many files at once. In a web application, it may also create a vulnerability that is exploitable with"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Denial of Service"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"DoS"}]},{"block_type":"text","content":") attacks. In all such situations, it is a good idea to limit the number of tasks that can run at the same time. This way, we can add some predictability to the load of our server and also make sure that our application will not run out of resources. The following diagram describes a situation where we have five tasks that run in parallel with a concurrency limit of 2:"}]},{"block_type":"element","block":"k5zy5asu","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000022.jpg","alt":"Limited parallel execution","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5asv","search_text":"From the preceding figure, it should be clear how our algorithm will work:","text_count":74,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From the preceding figure, it should be clear how our algorithm will work:"}]},{"block_type":"element","block":"k5zy5asw","search_text":"Initially, we spawn as many tasks as we can without exceeding the concurrency limit. Then, every time a task is completed, we spawn one or more tasks until we don't reach the limit again. ","text_count":188,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Initially, we spawn as many tasks as we can without exceeding the concurrency limit."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Then, every time a task is completed, we spawn one or more tasks until we don't reach the limit again."}]}]},{"block_type":"element","block":"k5zy5asx","search_text":"Limiting the concurrency","text_count":24,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Limiting the concurrency"}]},{"block_type":"element","block":"k5zy5asy","search_text":"We now present a pattern to execute a set of given tasks in parallel with limited concurrency:","text_count":94,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We now present a pattern to execute a set of given tasks in parallel with limited concurrency:"}]},{"block_type":"element","block":"k5zy5asz","search_text":"const tasks = ... let concurrency = 2, running = 0, completed = 0, index = 0; function next() { //[1] while(running < concurrency && index < tasks.length) { task = tasks[index++]; task(() => { //[2] if(completed === tasks.length) { return finish(); } completed++, running--; next(); }); running++; } } next(); function finish() { //all tasks finished } ","text_count":353,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const tasks = ... \nlet concurrency = 2, running = 0, completed = 0, index = 0; \nfunction next() {                                             //[1] \n  while(running &lt; concurrency && index &lt; tasks.length) { \n    task = tasks[index++]; \n    task(() =&gt; {                                              //[2] \n      if(completed === tasks.length) { \n        return finish(); \n      } \n      completed++, running--; \n      next(); \n    }); \n    running++; \n  } \n} \nnext(); \n \nfunction finish() { \n  //all tasks finished \n}"}]}]},{"block_type":"element","block":"k5zy5at0","search_text":"This algorithm can be considered a mix between a sequential execution and a parallel execution. In fact, we might notice similarities with both the patterns we presented earlier in the chapter:","text_count":193,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This algorithm can be considered a mix between a sequential execution and a parallel execution. In fact, we might notice similarities with both the patterns we presented earlier in the chapter:"}]},{"block_type":"element","block":"k5zy5at1","search_text":"We have an iterator function, which we called next() , and then an inner loop that spawns in parallel as many tasks as possible while staying within the concurrency limit. The next important part is the callback we pass to each task, which checks if we completed all the tasks in the list. If there are still tasks to run, it invokes next() to spawn another bunch of tasks. ","text_count":374,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We have an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"iterator"}]},{"block_type":"text","content":"function, which we called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"next()"}]},{"block_type":"text","content":", and then an inner loop that spawns in parallel as many tasks as possible while staying within the concurrency limit."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The next important part is the callback we pass to each task, which checks if we completed all the tasks in the list. If there are still tasks to run, it invokes"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"next()"}]},{"block_type":"text","content":"to spawn another bunch of tasks."}]}]},{"block_type":"element","block":"k5zy5at2","search_text":"Pretty simple, isn't it?","text_count":24,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Pretty simple, isn't it?"}]},{"block_type":"element","block":"k5zy5at3","search_text":"Globally limiting the concurrency","text_count":33,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Globally limiting the concurrency"}]},{"block_type":"element","block":"k5zy5at4","search_text":"Our web spider application is perfect for applying what we learned about limiting the concurrency of a set of tasks. In fact, to avoid the situation in which we have thousands of links crawled at the same time, we can enforce a limit on the concurrency of this process by adding some predictability on the number of concurrent downloads.","text_count":337,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our web spider application is perfect for applying what we learned about limiting the concurrency of a set of tasks. In fact, to avoid the situation in which we have thousands of links crawled at the same time, we can enforce a limit on the concurrency of this process by adding some predictability on the number of concurrent downloads."}]},{"block_type":"element","block":"k5zy5at5","search_text":"Note Node.js versions before 0.11 already limit the number of concurrent HTTP connections per host to 5. This can, however, be changed to accommodate our needs. Find out more in the official docs at http://nodejs.org/docs/v0.10.0/api/http.html#http_agent_maxsockets . Starting from Node.js 0.11, there is no default limit on the number of concurrent connections. ","text_count":363,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Node.js versions before 0.11 already limit the number of concurrent HTTP connections per host to 5. This can, however, be changed to accommodate our needs. Find out more in the official docs at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nodejs.org/docs/v0.10.0/api/http.html#http_agent_maxsockets"},"children":[{"block_type":"text","content":"http://nodejs.org/docs/v0.10.0/api/http.html#http_agent_maxsockets"}]},{"block_type":"text","content":". Starting from Node.js 0.11, there is no default limit on the number of concurrent connections."}]}]},{"block_type":"element","block":"k5zy5at6","search_text":"We could apply the pattern we just learned to our spiderLinks() function, but what we would obtain is only limiting the concurrency of a set of links found within one single page. If we chose, for example, a concurrency of 2, we would have at most two links downloaded in parallel for each page. However, as we can download multiple links at once, each page would then spawn another two downloads, causing the grand total of download operations to grow exponentially anyway.","text_count":474,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We could apply the pattern we just learned to our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function, but what we would obtain is only limiting the concurrency of a set of links found within one single page. If we chose, for example, a concurrency of 2, we would have at most two links downloaded in parallel for each page. However, as we can download multiple links at once, each page would then spawn another two downloads, causing the grand total of download operations to grow exponentially anyway."}]},{"block_type":"element","block":"k5zy5at7","search_text":"Queues to the rescue","text_count":20,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Queues to the rescue"}]},{"block_type":"element","block":"k5zy5at8","search_text":"What we really want then, is to limit the global number of download operations we can have running in parallel. We could slightly modify the pattern showed before, but we prefer to leave this as an exercise for you, as we want to take this opportunity to introduce another mechanism, which makes use of queues to limit the concurrency of multiple tasks. Let's see how this works.","text_count":379,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What we really want then, is to limit the global number of download operations we can have running in parallel. We could slightly modify the pattern showed before, but we prefer to leave this as an exercise for you, as we want to take this opportunity to introduce another mechanism, which makes use of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"queues"}]},{"block_type":"text","content":"to limit the concurrency of multiple tasks. Let's see how this works."}]},{"block_type":"element","block":"k5zy5at9","search_text":"We are now going to implement a simple class named TaskQueue , which will combine a queue with the algorithm we presented before. Let's create a new module named taskQueue.js :","text_count":176,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are now going to implement a simple class named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":", which will combine a queue with the algorithm we presented before. Let's create a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"taskQueue.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5ata","search_text":"class TaskQueue { constructor(concurrency) { this.concurrency = concurrency; this.running = 0; this.queue = []; } pushTask(task) { this.queue.push(task); this.next(); } next() { while(this.running < this.concurrency && this.queue.length) { const task = this.queue.shift(); task(() => { this.running--; this.next(); }); this.running++; } } }; ","text_count":342,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class TaskQueue { \n  constructor(concurrency) { \n    this.concurrency = concurrency; \n    this.running = 0; \n    this.queue = []; \n  } \n \n  pushTask(task) { \n    this.queue.push(task); \n    this.next(); \n  } \n \n  next() { \n    while(this.running &lt; this.concurrency && this.queue.length) { \n      const task = this.queue.shift(); \n      task(() =&gt; { \n        this.running--; \n        this.next(); \n      }); \n      this.running++; \n    } \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5atb","search_text":"The constructor of this class takes as input only the concurrency limit, but besides that, it initializes the variables running and queue . The former variable is a counter used to keep track of all the running tasks, while the latter is the array that will be used as a queue to store the pending tasks.","text_count":304,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The constructor of this class takes as input only the concurrency limit, but besides that, it initializes the variables"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"running"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"queue"}]},{"block_type":"text","content":". The former variable is a counter used to keep track of all the running tasks, while the latter is the array that will be used as a queue to store the pending tasks."}]},{"block_type":"element","block":"k5zy5atc","search_text":"The pushTask() method simply adds a new task to the queue and then bootstraps the execution of the worker by invoking this.next() .","text_count":131,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pushTask()"}]},{"block_type":"text","content":"method simply adds a new task to the queue and then bootstraps the execution of the worker by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this.next()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5atd","search_text":"The next() method spawns a set of tasks from the queue, ensuring that it does not exceed the concurrency limit.","text_count":111,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"next()"}]},{"block_type":"text","content":"method spawns a set of tasks from the queue, ensuring that it does not exceed the concurrency limit."}]},{"block_type":"element","block":"k5zy5ate","search_text":"We might notice that this method has some similarities with the pattern that limits the concurrency we presented earlier. It essentially starts as many tasks from the queue as possible, without exceeding the concurrency limit. When each task is complete, it updates the count of running tasks and then starts another round of tasks by invoking next() again. The interesting property of the TaskQueue class is that it allows us to dynamically add new items to the queue. The other advantage is that now we have a central entity responsible for the limitation of the concurrency of our tasks, which can be shared across all the instances of a function's execution. In our case, it's the spider() function, as we will see in a moment.","text_count":731,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We might notice that this method has some similarities with the pattern that limits the concurrency we presented earlier. It essentially starts as many tasks from the queue as possible, without exceeding the concurrency limit. When each task is complete, it updates the count of running tasks and then starts another round of tasks by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"next()"}]},{"block_type":"text","content":"again. The interesting property of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"class is that it allows us to dynamically add new items to the queue. The other advantage is that now we have a central entity responsible for the limitation of the concurrency of our tasks, which can be shared across all the instances of a function's execution. In our case, it's the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function, as we will see in a moment."}]},{"block_type":"element","block":"k5zy5atf","search_text":"Web spider version 4","text_count":20,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Web spider version 4"}]},{"block_type":"element","block":"k5zy5atg","search_text":"Now that we have our generic queue to execute tasks in a limited parallel flow, let's use it straightaway in our web spider application. Let's first load the new dependency and create a new instance of the TaskQueue class by setting the concurrency limit to 2 :","text_count":261,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have our generic queue to execute tasks in a limited parallel flow, let's use it straightaway in our web spider application. Let's first load the new dependency and create a new instance of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"class by setting the concurrency limit to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"2"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5ath","search_text":"const TaskQueue = require('./taskQueue'); const downloadQueue = new TaskQueue(2); ","text_count":82,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const TaskQueue = require('./taskQueue'); \nconst downloadQueue = new TaskQueue(2);"}]}]},{"block_type":"element","block":"k5zy5ati","search_text":"Next, we need to update the spiderLinks() function so that it can use the newly created downloadQueue :","text_count":103,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, we need to update the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function so that it can use the newly created"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"downloadQueue"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5atj","search_text":"function spiderLinks(currentUrl, body, nesting, callback) { if(nesting === 0) { return process.nextTick(callback); } const links = utilities.getPageLinks(currentUrl, body); if(links.length === 0) { return process.nextTick(callback); } let completed = 0, hasErrors = false; links.forEach(link => { downloadQueue.pushTask(done => { spider(link, nesting - 1, err => { if(err) { hasErrors= true; return callback(err); } if(++completed === links.length && !hasErrors) { callback(); } done(); }); }); }); } ","text_count":501,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting, callback) { \n  if(nesting === 0) { \n    return process.nextTick(callback); \n  } \n \n  const links = utilities.getPageLinks(currentUrl, body); \n  if(links.length === 0) { \n    return process.nextTick(callback); \n  } \n \n  let completed = 0, hasErrors = false; \n  links.forEach(link =&gt; { \n    downloadQueue.pushTask(done =&gt; { \n      spider(link, nesting - 1, err =&gt; { \n        if(err) { \n          hasErrors= true; \n          return callback(err); \n        } \n        if(++completed === links.length && !hasErrors) { \n          callback(); \n        } \n        done(); \n      }); \n    }); \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5atk","search_text":"This new implementation of the function is extremely easy, and it's very similar to the algorithm for unlimited parallel execution, which we presented earlier in the chapter. This is because we are delegating the concurrency control to the TaskQueue object, and the only thing we have to do is to check when all our tasks are complete. The only interesting part in the preceding code is how we defined our tasks:","text_count":412,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This new implementation of the function is extremely easy, and it's very similar to the algorithm for unlimited parallel execution, which we presented earlier in the chapter. This is because we are delegating the concurrency control to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"object, and the only thing we have to do is to check when all our tasks are complete. The only interesting part in the preceding code is how we defined our tasks:"}]},{"block_type":"element","block":"k5zy5atl","search_text":"We run the spider() function by providing a custom callback. In the callback, we check if all the tasks relative to this execution of the spiderLinks() function are completed. When this condition is true , we invoke the final callback of the spiderLinks() function. At the end of our task, we invoke the done() callback so that the queue can continue its execution. ","text_count":366,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We run the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function by providing a custom callback."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In the callback, we check if all the tasks relative to this execution of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function are completed. When this condition is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true"}]},{"block_type":"text","content":", we invoke the final callback of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At the end of our task, we invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done()"}]},{"block_type":"text","content":"callback so that the queue can continue its execution."}]}]},{"block_type":"element","block":"k5zy5atm","search_text":"After we have applied these small changes, we can now try to run the spider module again. This time, we should notice that no more than two downloads will be active at the same time.","text_count":182,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"After we have applied these small changes, we can now try to run the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider"}]},{"block_type":"text","content":"module again. This time, we should notice that no more than two downloads will be active at the same time."}]},{"block_type":"element","block":"k5zy5atn","search_text":"The async library","text_count":17,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"The async library"}]},{"block_type":"element","block":"k5zy5ato","search_text":"If we take a look for a moment at every control flow pattern we have analyzed so far, we can see that they could be used as a base to build reusable and more generic solutions. For example, we could wrap the unlimited parallel execution algorithm into a function which accepts a list of tasks, runs them in parallel, and invokes the given callback when all of them are complete. This way of wrapping control flow algorithms into reusable functions can lead to a more declarative and expressive way to define asynchronous control flows, and that's exactly what async ( https://npmjs.org/package/async ) does. The async library is a very popular solution, in Node.js and JavaScript in general, to deal with asynchronous code. It offers a set of functions that greatly simplify the execution of a set of tasks in different configurations and it also provides useful helpers for dealing with collections asynchronously. Even though there are several other libraries with a similar goal, async is a de facto standard in Node.js due to its popularity.","text_count":1045,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we take a look for a moment at every control flow pattern we have analyzed so far, we can see that they could be used as a base to build reusable and more generic solutions. For example, we could wrap the unlimited parallel execution algorithm into a function which accepts a list of tasks, runs them in parallel, and invokes the given callback when all of them are complete. This way of wrapping control flow algorithms into reusable functions can lead to a more declarative and expressive way to define asynchronous control flows, and that's exactly what"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/async"},"children":[{"block_type":"text","content":"https://npmjs.org/package/async"}]},{"block_type":"text","content":") does. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"library is a very popular solution, in Node.js and JavaScript in general, to deal with asynchronous code. It offers a set of functions that greatly simplify the execution of a set of tasks in different configurations and it also provides useful helpers for dealing with collections asynchronously. Even though there are several other libraries with a similar goal,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"is a de facto standard in Node.js due to its popularity."}]},{"block_type":"element","block":"k5zy5atp","search_text":"Let's try it straightaway to demonstrate its capabilities.","text_count":58,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's try it straightaway to demonstrate its capabilities."}]},{"block_type":"element","block":"k5zy5atq","search_text":"Sequential execution","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sequential execution"}]},{"block_type":"element","block":"k5zy5atr","search_text":"The async library can help us immensely when implementing complex asynchronous control flows, but one difficulty with it is choosing the right helper for the problem at hand. For example, for the case of the sequential execution flow, there are around 20 different functions to choose from, including eachSeries() , mapSeries() , filterSeries() , rejectSeries() , reduce() , reduceRight() , detectSeries() , concatSeries() , series() , whilst() , doWhilst() , until() , doUntil() , forever() , waterfall() , compose() , seq() , applyEachSeries() , iterator() , and timesSeries() .","text_count":580,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"library can help us immensely when implementing complex asynchronous control flows, but one difficulty with it is choosing the right helper for the problem at hand. For example, for the case of the sequential execution flow, there are around 20 different functions to choose from, including"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"eachSeries()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mapSeries()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"filterSeries()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"rejectSeries()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reduce()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reduceRight()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"detectSeries()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"concatSeries()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"series()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"whilst()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"doWhilst()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"until()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"doUntil()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"forever()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"waterfall()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"compose()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"seq()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"applyEachSeries()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"iterator()"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"timesSeries()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5ats","search_text":"Choosing the right function is an important step in writing more compact and readable code, but this also requires some experience and practice. In our examples, we are going to cover just a few of these situations, but they will still provide a solid base to understand and efficiently use the rest of the library.","text_count":315,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Choosing the right function is an important step in writing more compact and readable code, but this also requires some experience and practice. In our examples, we are going to cover just a few of these situations, but they will still provide a solid base to understand and efficiently use the rest of the library."}]},{"block_type":"element","block":"k5zy5att","search_text":"Now, to show in practice how async works, we are going to adapt our web spider application. Let's start directly with version 2, the one that downloads all the links recursively in sequence.","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, to show in practice how"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"works, we are going to adapt our web spider application. Let's start directly with version 2, the one that downloads all the links recursively in sequence."}]},{"block_type":"element","block":"k5zy5atu","search_text":"However, first let's make sure we install the async library into our current project:","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, first let's make sure we install the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"library into our current project:"}]},{"block_type":"element","block":"k5zy5atv","search_text":"npm install async","text_count":17,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install async"}]}]},{"block_type":"element","block":"k5zy5atw","search_text":"Then we need to load the new dependency from the spider.js module:","text_count":66,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then we need to load the new dependency from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider.js"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5atx","search_text":"const async = require('async'); ","text_count":32,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const async = require('async');"}]}]},{"block_type":"element","block":"k5zy5aty","search_text":"Sequential execution of a known set of tasks","text_count":44,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sequential execution of a known set of tasks"}]},{"block_type":"element","block":"k5zy5atz","search_text":"Let's modify the download() function first. As we have already seen, it executes the following three tasks in sequence:","text_count":119,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's modify the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"download()"}]},{"block_type":"text","content":"function first. As we have already seen, it executes the following three tasks in sequence:"}]},{"block_type":"element","block":"k5zy5au0","search_text":"Download the contents of a URL. Create a new directory if it doesn't exist yet. Save the contents of the URL into a file. ","text_count":122,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Download the contents of a URL."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Create a new directory if it doesn't exist yet."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Save the contents of the URL into a file."}]}]},{"block_type":"element","block":"k5zy5au1","search_text":"The ideal function to use with this flow is definitely async.series() , which has the following signature:","text_count":106,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The ideal function to use with this flow is definitely"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.series()"}]},{"block_type":"text","content":", which has the following signature:"}]},{"block_type":"element","block":"k5zy5au2","search_text":"async.series(tasks, [callback]) ","text_count":32,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"async.series(tasks, [callback])"}]}]},{"block_type":"element","block":"k5zy5au3","search_text":"It takes a list of tasks and a callback function that is invoked when all the tasks have been completed. Each task is just a function that accepts a callback function, which must be invoked when the task completes its execution:","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It takes a list of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tasks"}]},{"block_type":"text","content":"and a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function that is invoked when all the tasks have been completed. Each task is just a function that accepts a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function, which must be invoked when the task completes its execution:"}]},{"block_type":"element","block":"k5zy5au4","search_text":"function task(callback) {} ","text_count":27,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function task(callback) {}"}]}]},{"block_type":"element","block":"k5zy5au5","search_text":"The nice thing about async is that it uses the same callback conventions of Node.js, and it automatically handles error propagation. So, if any of the tasks invoke its callback with an error, async will skip the remaining tasks in the list and jump directly to the final callback.","text_count":280,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The nice thing about"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"is that it uses the same callback conventions of Node.js, and it automatically handles error propagation. So, if any of the tasks invoke its callback with an error,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"will skip the remaining tasks in the list and jump directly to the final callback."}]},{"block_type":"element","block":"k5zy5au6","search_text":"With this in mind, let's see how the download() function would change by using async :","text_count":86,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this in mind, let's see how the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"download()"}]},{"block_type":"text","content":"function would change by using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5au7","search_text":"function download(url, filename, callback) { console.log(`Downloading ${url}`); let body; async.series([ callback => { //[1] request(url, (err, response, resBody) => { if(err) { return callback(err); } body = resBody; callback(); }); }, mkdirp.bind(null, path.dirname(filename)), //[2] callback => { //[3] fs.writeFile(filename, body, callback); } ], err => { //[4] if(err) { return callback(err); } console.log(`Downloaded and saved: ${url}`); callback(null, body); }); } ","text_count":473,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function download(url, filename, callback) { \n  console.log(`Downloading ${url}`); \n  let body; \n \n  async.series([ \n    callback =&gt; {                                    //[1] \n      request(url, (err, response, resBody) =&gt; { \n        if(err) { \n          return callback(err); \n        } \n        body = resBody; \n        callback(); \n      }); \n    }, \n \n    mkdirp.bind(null, path.dirname(filename)),       //[2] \n \n    callback =&gt; {                                    //[3] \n      fs.writeFile(filename, body, callback); \n    } \n  ], err =&gt; {                                        //[4] \n    if(err) { \n      return callback(err); \n    } \n    console.log(`Downloaded and saved: ${url}`); \n    callback(null, body); \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5au8","search_text":"If we remember the callback hell version of this code, we will surely appreciate the way async allows us to organize our tasks. There is no need to nest callbacks anymore, as we just have to provide a flat list of tasks, usually one for each asynchronous operation, which async will then execute in sequence. This is how we define each task:","text_count":341,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we remember the callback hell version of this code, we will surely appreciate the way"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"allows us to organize our tasks. There is no need to nest callbacks anymore, as we just have to provide a flat list of tasks, usually one for each asynchronous operation, which"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"will then execute in sequence. This is how we define each task:"}]},{"block_type":"element","block":"k5zy5au9","search_text":"The first task involves the download of the URL. Also, we save the response body into a closure variable ( body ) so that it can be shared with the other tasks. In the second task, we want to create the directory that will hold the downloaded page. We do this by performing a partial application of the mkdirp() function, binding the path of the directory to be created. This way, we can save a few lines of code and increase its readability. At last, we write the contents of the downloaded URL to a file. In this case, we could not perform a partial application (as we did for the second task), because the variable, body , is only available after the first task in the series completes. However, we can still save some lines of code by exploiting the automatic error management of async by simply passing the callback of the task directly to the fs.writeFile() function. After all the tasks are complete, the final callback of async.series() is invoked. In our case, we are simply doing some error management and then returning the body variable to callback of the download() function. ","text_count":1089,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The first task involves the download of the URL. Also, we save the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"response"}]},{"block_type":"text","content":"body into a closure variable ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"body"}]},{"block_type":"text","content":") so that it can be shared with the other tasks."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In the second task, we want to create the directory that will hold the downloaded page. We do this by performing a partial application of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mkdirp()"}]},{"block_type":"text","content":"function, binding the path of the directory to be created. This way, we can save a few lines of code and increase its readability."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At last, we write the contents of the downloaded URL to a file. In this case, we could not perform a partial application (as we did for the second task), because the variable,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"body"}]},{"block_type":"text","content":", is only available after the first task in the series completes. However, we can still save some lines of code by exploiting the automatic error management of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"by simply passing the callback of the task directly to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs.writeFile()"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"After all the tasks are complete, the final callback of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.series()"}]},{"block_type":"text","content":"is invoked. In our case, we are simply doing some error management and then returning the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"body"}]},{"block_type":"text","content":"variable to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"download()"}]},{"block_type":"text","content":"function."}]}]},{"block_type":"element","block":"k5zy5aua","search_text":"For this specific situation, a possible alternative to async.series() would be async.waterfall() , which still executes the tasks in sequence but in addition, it also provides the output of each task as input to the next. In our situation, we could use this feature to propagate the body variable until the end of our sequence. As an exercise, you can try to implement the same function using the waterfall flow and then take a look at the differences.","text_count":452,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For this specific situation, a possible alternative to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.series()"}]},{"block_type":"text","content":"would be"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.waterfall()"}]},{"block_type":"text","content":", which still executes the tasks in sequence but in addition, it also provides the output of each task as input to the next. In our situation, we could use this feature to propagate the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"body"}]},{"block_type":"text","content":"variable until the end of our sequence. As an exercise, you can try to implement the same function using the waterfall flow and then take a look at the differences."}]},{"block_type":"element","block":"k5zy5aub","search_text":"Sequential iteration","text_count":20,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Sequential iteration"}]},{"block_type":"element","block":"k5zy5auc","search_text":"We saw in the previous paragraph how we can execute a set of known tasks in sequence; we used async.series() to do that. We could use the same functionality to implement the spiderLinks() function of our web spider version 2; however, async offers a more appropriate helper for the specific situation in which we have to iterate over a collection; this helper is async.eachSeries() . Let's use it then to reimplement our spiderLinks() function (version 2, download in series) as follows:","text_count":487,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We saw in the previous paragraph how we can execute a set of known tasks in sequence; we used"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.series()"}]},{"block_type":"text","content":"to do that. We could use the same functionality to implement the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function of our web spider version 2; however,&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"offers a more appropriate helper for the specific situation in which we have to iterate over a collection; this helper is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.eachSeries()"}]},{"block_type":"text","content":". Let's use it then to reimplement our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function (version 2, download in series) as follows:"}]},{"block_type":"element","block":"k5zy5aud","search_text":"function spiderLinks(currentUrl, body, nesting, callback) { if(nesting === 0) { return process.nextTick(callback); } const links = utilities.getPageLinks(currentUrl, body); if(links.length === 0) { return process.nextTick(callback); } async.eachSeries(links, (link, callback) => { spider(link, nesting - 1, callback); }, callback); } ","text_count":334,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting, callback) { \n  if(nesting === 0) { \n    return process.nextTick(callback); \n  } \n \n  const links = utilities.getPageLinks(currentUrl, body); \n  if(links.length === 0) { \n    return process.nextTick(callback); \n  } \n \n  async.eachSeries(links, (link, callback) =&gt; { \n    spider(link, nesting - 1, callback); \n  }, callback); \n}"}]}]},{"block_type":"element","block":"k5zy5aue","search_text":"If we compare the preceding code, which uses async , with the code of the same function implemented with plain JavaScript patterns, we will notice the big advantage that async gives us in terms of code organization and readability.","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we compare the preceding code, which uses"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":", with the code of the same function implemented with plain JavaScript patterns, we will notice the big advantage that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"gives us in terms of code organization and readability."}]},{"block_type":"element","block":"k5zy5auf","search_text":"Parallel execution","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Parallel execution"}]},{"block_type":"element","block":"k5zy5aug","search_text":"The async library doesn't lack functions to handle parallel flows; among them we can find each() , map() , filter() , reject() , detect() , some() , every() , concat() , parallel() , applyEach() , and times() . They follow the same logic as the functions we have already seen for sequential execution, with the difference being that the tasks provided are executed in parallel.","text_count":377,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"library doesn't lack functions to handle parallel flows; among them we can find"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"each()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"map()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"filter()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reject()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"detect()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"some()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"every()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"concat()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"parallel()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"applyEach()"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"times()"}]},{"block_type":"text","content":". They follow the same logic as the functions we have already seen for sequential execution, with the difference being that the tasks provided are executed in parallel."}]},{"block_type":"element","block":"k5zy5auh","search_text":"To demonstrate that, we can try to apply one of these functions to implement version 3 of our web spider application, the one performing the downloads using an unlimited parallel flow.","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate that, we can try to apply one of these functions to implement version 3 of our web spider application, the one performing the downloads using an unlimited parallel flow."}]},{"block_type":"element","block":"k5zy5aui","search_text":"If we remember the code we used earlier to implement the sequential version of the spiderLinks() function, adapting it to make it work in parallel is a trivial task:","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we remember the code we used earlier to implement the sequential version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function, adapting it to make it work in parallel is a trivial task:"}]},{"block_type":"element","block":"k5zy5auj","search_text":"function spiderLinks(currentUrl, body, nesting, callback) { // ... async.each(links, (link, callback) => { spider(link, nesting - 1, callback); }, callback); } ","text_count":160,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting, callback) { \n  // ... \n  async.each(links, (link, callback) =&gt; { \n    spider(link, nesting - 1, callback); \n  }, callback); \n}"}]}]},{"block_type":"element","block":"k5zy5auk","search_text":"The function is exactly the same one that we used for the sequential download, but this time we used async.each() instead of async.eachSeries() . This clearly demonstrates the power of abstracting the asynchronous flow with a library such as async . The code is not bound to a particular execution flow anymore; there is no code specifically written for that. Most of it is just application logic.","text_count":397,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The function is exactly the same one that we used for the sequential download, but this time we used"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.each()"}]},{"block_type":"text","content":"instead of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.eachSeries()"}]},{"block_type":"text","content":". This clearly demonstrates the power of abstracting the asynchronous flow with a library such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":". The code is not bound to a particular execution flow anymore; there is no code specifically written for that. Most of it is just application logic."}]},{"block_type":"element","block":"k5zy5aul","search_text":"Limited parallel execution","text_count":26,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Limited parallel execution"}]},{"block_type":"element","block":"k5zy5aum","search_text":"If you are wondering if async can also be used to limit the concurrency of parallel tasks, the answer is yes, it can! We have a few functions we can use for that, namely, eachLimit() , mapLimit() , parallelLimit() , queue() , and cargo() .","text_count":239,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you are wondering if"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"can also be used to limit the concurrency of parallel tasks, the answer is yes, it can! We have a few functions we can use for that, namely,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"eachLimit()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mapLimit()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"parallelLimit()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"queue()"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cargo()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aun","search_text":"Let's try to exploit one of them to implement version 4 of the web spider application, the one executing the download of the links in parallel with limited concurrency. Fortunately, async has async.queue() , which works in a similar way to the TaskQueue class we created earlier in the chapter. The async.queue() function creates a new queue, which uses a worker() function to execute a set of tasks with a specified concurrency limit:","text_count":435,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's try to exploit one of them to implement version 4 of the web spider application, the one executing the download of the links in parallel with limited concurrency. Fortunately,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"has"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.queue()"}]},{"block_type":"text","content":", which works in a similar way to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"class we created earlier in the chapter. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.queue()"}]},{"block_type":"text","content":"function creates a new queue, which uses a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"worker()"}]},{"block_type":"text","content":"function to execute a set of tasks with a specified"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"concurrency"}]},{"block_type":"text","content":"limit:"}]},{"block_type":"element","block":"k5zy5auo","search_text":"const q = async.queue(worker, concurrency); ","text_count":44,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const q = async.queue(worker, concurrency);"}]}]},{"block_type":"element","block":"k5zy5aup","search_text":"The worker() function receives, as input, task to run and a callback function to invoke, when the task completes:","text_count":113,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"worker()"}]},{"block_type":"text","content":"function receives, as input,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"task"}]},{"block_type":"text","content":"to run and a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function to invoke, when the task completes:"}]},{"block_type":"element","block":"k5zy5auq","search_text":"function worker(task, callback) ","text_count":32,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function worker(task, callback)"}]}]},{"block_type":"element","block":"k5zy5aur","search_text":"We should notice that task in this case can be anything, not just a function. In fact, it's the responsibility of the worker to handle a task in the most appropriate way. New tasks can be added to the queue by using q.push(task, callback) . The callback associated to a task has to be invoked by the worker after the task has been processed.","text_count":341,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We should notice that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"task"}]},{"block_type":"text","content":"in this case can be anything, not just a function. In fact, it's the responsibility of the worker to handle a task in the most appropriate way. New tasks can be added to the queue by using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"q.push(task, callback)"}]},{"block_type":"text","content":". The callback associated to a task has to be invoked by the worker after the task has been processed."}]},{"block_type":"element","block":"k5zy5aus","search_text":"Now, let's modify our code again to implement a parallel globally limited execution flow, using async.queue() . First of all, we need to create a new queue:","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's modify our code again to implement a parallel globally limited execution flow, using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.queue()"}]},{"block_type":"text","content":". First of all, we need to create a new queue:"}]},{"block_type":"element","block":"k5zy5aut","search_text":"const downloadQueue = async.queue((taskData, callback) => { spider(taskData.link, taskData.nesting - 1, callback); }, 2); ","text_count":122,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const downloadQueue = async.queue((taskData, callback) =&gt; { \n  spider(taskData.link, taskData.nesting - 1, callback); \n}, 2);"}]}]},{"block_type":"element","block":"k5zy5auu","search_text":"The code is really straightforward. We are just creating a new queue with a concurrency limit of 2 , having a worker that simply invokes our spider() function with the data associated with a task. Next, we implement the spiderLinks() function:","text_count":243,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code is really straightforward. We are just creating a new queue with a concurrency limit of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"2"}]},{"block_type":"text","content":", having a worker that simply invokes our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function with the data associated with a task. Next, we implement the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k5zy5auv","search_text":"function spiderLinks(currentUrl, body, nesting, callback) { if(nesting === 0) { return process.nextTick(callback); } const links = utilities.getPageLinks(currentUrl, body); if(links.length === 0) { return process.nextTick(callback); } const completed = 0, hasErrors = false; links.forEach(function(link) { const taskData = {link: link, nesting: nesting}; downloadQueue.push(taskData, err => { if(err) { hasErrors = true; return callback(err); } if(++completed === links.length&& !hasErrors) { callback(); } }); }); } ","text_count":517,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting, callback) { \n  if(nesting === 0) { \n    return process.nextTick(callback); \n  } \n  const links = utilities.getPageLinks(currentUrl, body); \n  if(links.length === 0) { \n    return process.nextTick(callback); \n  } \n  const completed = 0, hasErrors = false; \n  links.forEach(function(link) { \n    const taskData = {link: link, nesting: nesting}; \n    downloadQueue.push(taskData, err =&gt; { \n      if(err) { \n        hasErrors = true; \n        return callback(err); \n      } \n      if(++completed === links.length&& !hasErrors) { \n        callback(); \n      } \n    }); \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5auw","search_text":"The preceding code should look very familiar, as it's almost the same as the one we used to implement the same flow using the TaskQueue object. Also, in this case, the important part to analyze is where we push a new task into the queue. At that point, we ensure that we pass a callback that enables us to check if all the download tasks for the current page are completed, and eventually invoke the final callback.","text_count":415,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code should look very familiar, as it's almost the same as the one we used to implement the same flow using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"object. Also, in this case, the important part to analyze is where we push a new task into the queue. At that point, we ensure that we pass a callback that enables us to check if all the download tasks for the current page are completed, and eventually invoke the final callback."}]},{"block_type":"element","block":"k5zy5aux","search_text":"Thanks to async.queue() , we could easily replicate the functionality of our TaskQueue object, again demonstrating that with async , we can really avoid writing asynchronous control flow patterns from scratch, reducing our efforts and saving precious lines of code.","text_count":265,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Thanks to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async.queue()"}]},{"block_type":"text","content":", we could easily replicate the functionality of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"object, again demonstrating that with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":", we can really avoid writing asynchronous control flow patterns from scratch, reducing our efforts and saving precious lines of code."}]},{"block_type":"element","block":"k5zy5auy","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5auz","search_text":"At the beginning of this chapter, we said that Node.js programming can be tough because of its asynchronous nature, especially for people used to developing on other platforms. However, throughout this chapter we showed how asynchronous APIs can be bent to our will, starting with plain JavaScript, which provided us the foundation for the analysis of more sophisticated techniques. We then saw that the tools at our disposal are indeed variegated and provide good solutions to most of our problems, in addition to offering a programming style for every taste; for example, we may choose async to simplify the most common flows.","text_count":628,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At the beginning of this chapter, we said that Node.js programming can be tough because of its asynchronous nature, especially for people used to developing on other platforms. However, throughout this chapter we showed how asynchronous APIs can be bent to our will, starting with plain JavaScript, which provided us the foundation for the analysis of more sophisticated techniques. We then saw that the tools at our disposal are indeed variegated and provide good solutions to most of our problems, in addition to offering a programming style for every taste; for example, we may choose"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"to simplify the most common flows."}]},{"block_type":"element","block":"k5zy5av0","search_text":"This chapter served as an introduction to more advanced techniques, such as promises and generators, that will be the main focus of the next chapter. When you know all these techniques, you will be able to choose the best solution for your needs or use many of them together in the same project.","text_count":295,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This chapter served as an introduction to more advanced techniques, such as promises and generators, that will be the main focus of the next chapter. When you know all these techniques, you will be able to choose the best solution for your needs or use many of them together in the same project."}]}]},{"title":"Asynchronous Control Flow Patterns with ES2015 and Beyond","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4mlu","number":4,"contents":[{"block_type":"element","block":"k5zy5av1","search_text":"In the previous chapter, we learned how to deal with asynchronous code using callbacks and how they can have a bad impact on our code, generating issues such as callback hell . Callbacks are the building blocks of asynchronous programming in JavaScript and in Node.js, but over the years, other alternatives have emerged. Those alternatives are more sophisticated in order to be able to deal with asynchronous code in ways that are more convenient.","text_count":448,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous chapter, we learned how to deal with asynchronous code using callbacks and how they can have a bad impact on our code, generating issues such as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"callback hell"}]},{"block_type":"text","content":". Callbacks are the building blocks of asynchronous programming in JavaScript and in Node.js, but over the years, other alternatives have emerged. Those alternatives are more sophisticated in order to be able to deal with asynchronous code in ways that are more convenient."}]},{"block_type":"element","block":"k5zy5av2","search_text":"In this chapter, we are going to explore some of the most famous alternatives, promises and generators . We will also explore async await , an innovative syntax that will be available in JavaScript as part of the release of ECMAScript 2017.","text_count":240,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we are going to explore some of the most famous alternatives,&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"promises"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"generators"}]},{"block_type":"text","content":". We will also explore"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"async await"}]},{"block_type":"text","content":", an innovative syntax that will be available in JavaScript as part of the release of ECMAScript 2017."}]},{"block_type":"element","block":"k5zy5av3","search_text":"We will see how these alternatives can simplify the way we deal with asynchronous control flows. Finally, we will compare all these approaches in order to understand all the pros and cons of each of them and be able to wisely choose the approach that best suits the requirements of our next Node.js project.","text_count":307,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will see how these alternatives can simplify the way we deal with asynchronous control flows. Finally, we will compare all these approaches in order to understand all the pros and cons of each of them and be able to wisely choose the approach that best suits the requirements of our next Node.js project."}]},{"block_type":"element","block":"k5zy5av4","search_text":"Promise","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"element","block":"k5zy5av5","search_text":"We mentioned in the previous chapters that Continuation Passing Style ( CPS ) is not the only way to write asynchronous code. In fact, the JavaScript ecosystem provides interesting alternatives to the traditional callback pattern. One of the most famous alternatives is promise, which is getting more and more attention, especially now that it is part of ECMAScript 2015 and has been natively available in Node.js since version 4.","text_count":430,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We mentioned in the previous chapters that"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Continuation Passing Style"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"CPS"}]},{"block_type":"text","content":") is not the only way to write asynchronous code. In fact, the JavaScript ecosystem provides interesting alternatives to the traditional callback pattern. One of the most famous alternatives is promise, which is getting more and more attention, especially now that it is part of ECMAScript 2015 and has been natively available in Node.js since version 4."}]},{"block_type":"element","block":"k5zy5av6","search_text":"What is a promise?","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"What is a promise?"}]},{"block_type":"element","block":"k5zy5av7","search_text":"In very simple terms, promise is an abstraction that allows a function to return an object called promise , which represents the eventual result of an asynchronous operation. In the promises jargon, we say that a promise is pending when the asynchronous operation is not yet complete, it's fulfilled when the operation successfully completes, and rejected when the operation terminates with an error. Once a promise is either fulfilled or rejected, it's considered settled .","text_count":474,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In very simple terms, promise is an abstraction that allows a function to return an object called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promise"}]},{"block_type":"text","content":", which represents the eventual result of an asynchronous operation. In the promises jargon, we say that a promise is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"pending"}]},{"block_type":"text","content":"when the asynchronous operation is not yet complete, it's"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"fulfilled"}]},{"block_type":"text","content":"when the operation successfully completes, and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"rejected"}]},{"block_type":"text","content":"when the operation terminates with an error. Once a promise is either fulfilled or rejected, it's considered"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"settled"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5av8","search_text":"To receive the fulfillment value or the error ( reason ) associated with the rejection, we can use the then() method of the promise. The following is its signature:","text_count":164,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To receive the fulfillment value or the error ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"reason"}]},{"block_type":"text","content":") associated with the rejection, we can use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"method of the promise. The following is its signature:"}]},{"block_type":"element","block":"k5zy5av9","search_text":"promise.then([onFulfilled], [onRejected]) ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"promise.then([onFulfilled], [onRejected])"}]}]},{"block_type":"element","block":"k5zy5ava","search_text":"In the preceding code, onFulfilled() is a function that will eventually receive the fulfillment value of the promise, and onRejected() is another function that will receive the reason for the rejection (if any). Both functions are optional.","text_count":240,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onFulfilled()"}]},{"block_type":"text","content":"is a function that will eventually receive the fulfillment value of the promise, and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onRejected()"}]},{"block_type":"text","content":"is another function that will receive the reason for the rejection (if any). Both functions are optional."}]},{"block_type":"element","block":"k5zy5avb","search_text":"To have an idea of how promises can transform our code, let's consider the following:","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To have an idea of how promises can transform our code, let's consider the following:"}]},{"block_type":"element","block":"k5zy5avc","search_text":"asyncOperation(arg, (err, result) => { if(err) { //handle error } //do stuff with result }); ","text_count":93,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"asyncOperation(arg, (err, result) =&gt; { \n  if(err) { \n    //handle error \n  } \n  //do stuff with result \n});"}]}]},{"block_type":"element","block":"k5zy5avd","search_text":"Promises allow us to transform this typical CPS code into a better structured and more elegant code, such as the following:","text_count":123,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Promises allow us to transform this typical CPS code into a better structured and more elegant code, such as the following:"}]},{"block_type":"element","block":"k5zy5ave","search_text":"asyncOperation(arg) .then(result => { //do stuff with result }, err => { //handle error });","text_count":91,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"asyncOperation(arg) \n  .then(result =&gt; { \n    //do stuff with result \n  }, err =&gt; { \n    //handle error \n  });"}]}]},{"block_type":"element","block":"k5zy5avf","search_text":"One crucial property of the then() method is that it synchronously returns another promise. If any of the onFulfilled() or onRejected() functions return a value x , the promise returned by the then() method will be as follows:","text_count":226,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One crucial property of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"method is that it synchronously returns another promise. If any of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onFulfilled()"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onRejected()"}]},{"block_type":"text","content":"functions return a value"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":", the promise returned by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"method will be as follows:"}]},{"block_type":"element","block":"k5zy5avg","search_text":"Fulfill with x if x is a value Fulfill with the fulfillment value of x if x is a promise or a thenable Reject with the eventual rejection reason of x if x is a promise or a thenable ","text_count":182,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Fulfill with"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"if"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"is a value"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Fulfill with the fulfillment value of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"if"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"is a promise or a thenable"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Reject with the eventual rejection reason of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"if"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"is a promise or a thenable"}]}]},{"block_type":"element","block":"k5zy5avh","search_text":"Note A thenable is a promise-like object with a then() method. This term is used to indicate a promise that is foreign to the particular promise implementation in use. ","text_count":168,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"thenable"}]},{"block_type":"text","content":"is a promise-like object with a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"method. This term is used to indicate a promise that is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"foreign"}]},{"block_type":"text","content":"to the particular promise implementation in use."}]}]},{"block_type":"element","block":"k5zy5avi","search_text":"This feature allows us to build chains of promises, allowing easy aggregation and arrangement of asynchronous operations in several configurations. Also, if we don't specify an onFulfilled() or onRejected() handler, the fulfillment value or rejection reasons are automatically forwarded to the next promise in the chain. This allows us, for example, to automatically propagate errors across the whole chain until caught by an onRejected() handler. With a promise chain, sequential execution of tasks suddenly becomes a trivial operation:","text_count":537,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This feature allows us to build chains of promises, allowing easy aggregation and arrangement of asynchronous operations in several configurations. Also, if we don't specify an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onFulfilled()"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onRejected()"}]},{"block_type":"text","content":"handler, the fulfillment value or rejection reasons are automatically forwarded to the next promise in the chain. This allows us, for example, to automatically propagate errors across the whole chain until caught by an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onRejected()"}]},{"block_type":"text","content":"handler. With a promise chain, sequential execution of tasks suddenly becomes a trivial operation:"}]},{"block_type":"element","block":"k5zy5avj","search_text":"asyncOperation(arg) .then(result1 => { //returns another promise return asyncOperation(arg2); }) .then(result2 => { //returns a value return 'done'; }) .then(undefined, err => { //any error in the chain is caught here }); ","text_count":222,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"asyncOperation(arg) \n  .then(result1 =&gt; { \n    //returns another promise \n    return asyncOperation(arg2); \n  }) \n  .then(result2 =&gt; { \n    //returns a value \n    return 'done'; \n  }) \n  .then(undefined, err =&gt; { \n    //any error in the chain is caught here \n  });"}]}]},{"block_type":"element","block":"k5zy5avk","search_text":"The following diagram provides another perspective on how a promise chain works:","text_count":80,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following diagram provides another perspective on how a promise chain works:"}]},{"block_type":"element","block":"k5zy5avl","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000024.jpg","alt":"What is a promise?","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5avm","search_text":"Another important property of promises is that the onFulfilled() and onRejected() functions are guaranteed to be invoked asynchronously, even if we resolve the promise synchronously with a value, as we did in the preceding example, where we returned the string done in the last then() function of the chain. This behavior shields our code against all those situations where we could unintentionally release Zalgo (see Chapter 2, Node.js Essential Patterns ), making our asynchronous code more consistent and robust with no effort.","text_count":530,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another important property of promises is that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onFulfilled()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onRejected()"}]},{"block_type":"text","content":"functions are guaranteed to be invoked asynchronously, even if we resolve the promise synchronously with a value, as we did in the preceding example, where we returned the string"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done"}]},{"block_type":"text","content":"in the last"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"function of the chain. This behavior shields our code against all those situations where we could unintentionally release Zalgo (see Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Essential Patterns"}]},{"block_type":"text","content":"), making our asynchronous code more consistent and robust with no effort."}]},{"block_type":"element","block":"k5zy5avn","search_text":"Now comes the best part. If an exception is thrown (using the throw statement) in the onFulfilled() or onRejected() handler, the promise returned by the then() method will automatically reject, with the exception thrown as the rejection reason. This is a tremendous advantage over CPS, as it means that with promises, exceptions will propagate automatically across the chain, and that the throw statement is finally usable.","text_count":423,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now comes the best part. If an exception is thrown (using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"throw"}]},{"block_type":"text","content":"statement) in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onFulfilled()"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onRejected()"}]},{"block_type":"text","content":"handler, the promise returned by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"method will automatically reject, with the exception thrown as the rejection reason. This is a tremendous advantage over CPS, as it means that with promises, exceptions will propagate automatically across the chain, and that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"throw"}]},{"block_type":"text","content":"statement is finally usable."}]},{"block_type":"element","block":"k5zy5avo","search_text":"Historically, there have been many different implementations of promise libraries, and most of the time they were not compatible between each other, meaning that it was not possible to create thenable chains between promise objects coming from libraries that were using different promise implementations.","text_count":304,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Historically, there have been many different implementations of promise libraries, and most of the time they were not compatible between each other, meaning that it was not possible to create thenable chains between promise objects coming from libraries that were using different promise implementations."}]},{"block_type":"element","block":"k5zy5avp","search_text":"The JavaScript community worked very hard to sort out this limitation and these efforts lead to the creation of the Promises/A+ specification. This specification details the behavior of the then method, providing an interoperable base, which makes promise objects from different libraries able to work with each other out of the box.","text_count":333,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The JavaScript community worked very hard to sort out this limitation and these efforts lead to the creation of the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Promises/A+"}]},{"block_type":"text","content":"specification. This specification details the behavior of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then"}]},{"block_type":"text","content":"method, providing an interoperable base, which makes promise objects from different libraries able to work with each other out of the box."}]},{"block_type":"element","block":"k5zy5avq","search_text":"Note For a detailed description of the Promises/A+ specification, you can refer to the official website, https://promisesaplus.com . ","text_count":133,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For a detailed description of the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Promises/A+"}]},{"block_type":"text","content":"specification, you can refer to the official website,"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://promisesaplus.com"},"children":[{"block_type":"text","content":"https://promisesaplus.com"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5avr","search_text":"Promises/A+ implementations","text_count":27,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Promises/A+ implementations"}]},{"block_type":"element","block":"k5zy5avs","search_text":"In JavaScript, and also in Node.js, there are several libraries implementing the Promises/A+ specification. The following are the most popular:","text_count":143,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In JavaScript, and also in Node.js, there are several libraries implementing the Promises/A+ specification. The following are the most popular:"}]},{"block_type":"element","block":"k5zy5avt","search_text":"Bluebird ( https://npmjs.org/package/bluebird ) Q ( https://npmjs.org/package/q ) RSVP ( https://npmjs.org/package/rsvp ) Vow ( https://npmjs.org/package/vow ) When.js ( https://npmjs.org/package/when ) ES2015 promises ","text_count":219,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Bluebird ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/bluebird"},"children":[{"block_type":"text","content":"https://npmjs.org/package/bluebird"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Q ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/q"},"children":[{"block_type":"text","content":"https://npmjs.org/package/q"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"RSVP ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/rsvp"},"children":[{"block_type":"text","content":"https://npmjs.org/package/rsvp"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Vow ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/vow"},"children":[{"block_type":"text","content":"https://npmjs.org/package/vow"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When.js ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/when"},"children":[{"block_type":"text","content":"https://npmjs.org/package/when"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"ES2015 promises"}]}]},{"block_type":"element","block":"k5zy5avu","search_text":"What really differentiates them is the additional set of features they provide on top of the Promises/A+ standard. As we said, the standard defines the behavior of the then() method and the promise resolution procedure, but it does not specify other functionalities, for example, how a promise is created from a callback-based asynchronous function.","text_count":349,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What really differentiates them is the additional set of features they provide on top of the Promises/A+ standard. As we said, the standard defines the behavior of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"method and the promise resolution procedure, but it does not specify other functionalities, for example, how a promise is created from a callback-based asynchronous function."}]},{"block_type":"element","block":"k5zy5avv","search_text":"In our examples, we will use the set of APIs implemented by the ES2015 promises, as they have been natively available in Node.js since version 4 without the support of any external libraries.","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In our examples, we will use the set of APIs implemented by the ES2015 promises, as they have been natively available in Node.js since version 4 without the support of any external libraries."}]},{"block_type":"element","block":"k5zy5avw","search_text":"For reference, here is the list of the APIs provided by ES2015 promises:","text_count":72,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For reference, here is the list of the APIs provided by ES2015 promises:"}]},{"block_type":"element","block":"k5zy5avx","search_text":"Constructor (new Promise(function(resolve, reject) {})) : This creates a new promise that fulfills or rejects based on the behavior of the function passed as an argument. The arguments of the constructor are explained as follows:","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Constructor (new Promise(function(resolve, reject) {}))"}]},{"block_type":"text","content":": This creates a new promise that fulfills or rejects based on the behavior of the function passed as an argument. The arguments of the constructor are explained as follows:"}]},{"block_type":"element","block":"k5zy5avy","search_text":"resolve(obj) : This will resolve the promise with a fulfillment value, which will be obj if obj is a value. It will be the fulfillment value of obj if obj is a promise or a thenable. reject(err) : This rejects the promise with the reason err . It is a convention for err to be an instance of Error . ","text_count":300,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"resolve(obj)"}]},{"block_type":"text","content":": This will resolve the promise with a fulfillment value, which will be"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"obj"}]},{"block_type":"text","content":"if"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"obj"}]},{"block_type":"text","content":"is a value. It will be the fulfillment value of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"obj"}]},{"block_type":"text","content":"if"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"obj"}]},{"block_type":"text","content":"is a promise or a thenable."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reject(err)"}]},{"block_type":"text","content":": This rejects the promise with the reason"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"err"}]},{"block_type":"text","content":". It is a convention for"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"err"}]},{"block_type":"text","content":"to be an instance of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Error"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5avz","search_text":"Static methods of the Promise object :","text_count":38,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Static methods of the Promise object"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5aw0","search_text":"Promise.resolve(obj) : This creates a new promise from a thenable or a value. Promise.reject(err) : This creates a promise that rejects with err as the reason. Promise.all(iterable) : This creates a promise that fulfills with an iterable of fulfillment values when every item in the iterable object fulfills, and rejects with the first rejection reason if any item rejects. Each item in the iterable object can be a promise, a generic thenable, or a value. Promise.race(iterable) : This returns a promise that resolves or rejects as soon as one of the promises in the iterable resolves or rejects, with the value or reason from that promise. ","text_count":642,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise.resolve(obj)"}]},{"block_type":"text","content":": This creates a new promise from a thenable or a value."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise.reject(err)"}]},{"block_type":"text","content":": This creates a promise that rejects with err as the reason."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise.all(iterable)"}]},{"block_type":"text","content":": This creates a promise that fulfills with an iterable of fulfillment values when every item in the iterable object fulfills, and rejects with the first rejection reason if any item rejects. Each item in the iterable object can be a promise, a generic thenable, or a value."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise.race(iterable)"}]},{"block_type":"text","content":": This returns a promise that resolves or rejects as soon as one of the promises in the iterable resolves or rejects, with the value or reason from that promise."}]}]},{"block_type":"element","block":"k5zy5aw1","search_text":"Methods of a promise instance :","text_count":31,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Methods of a promise instance"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5aw2","search_text":"promise.then(onFulfilled, onRejected) : This is the essential method of a promise. Its behavior is compatible with the Promises/A+ standard we described before. promise.catch(onRejected) : This is just syntactic sugar for promise.then(undefined, onRejected) . ","text_count":260,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promise.then(onFulfilled, onRejected)"}]},{"block_type":"text","content":": This is the essential method of a promise. Its behavior is compatible with the Promises/A+ standard we described before."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promise.catch(onRejected)"}]},{"block_type":"text","content":": This is just syntactic sugar for"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promise.then(undefined, onRejected)"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5aw3","search_text":"Note It is worth mentioning that some promise implementations offer another mechanism to create new promises, called deferreds . We are not going to describe it here, because it's not part of the ES2015 standard, but if you want to know more, you can read the documentation for Q ( https://github.com/kriskowal/q#using-deferreds ) or When.js ( https://github.com/cujojs/when/wiki/Deferred ). ","text_count":392,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is worth mentioning that some promise implementations offer another mechanism to create new promises, called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"deferreds"}]},{"block_type":"text","content":". We are not going to describe it here, because it's not part of the ES2015 standard, but if you want to know more, you can read the documentation for Q ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/kriskowal/q#using-deferreds"},"children":[{"block_type":"text","content":"https://github.com/kriskowal/q#using-deferreds"}]},{"block_type":"text","content":") or When.js ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/cujojs/when/wiki/Deferred"},"children":[{"block_type":"text","content":"https://github.com/cujojs/when/wiki/Deferred"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5aw4","search_text":"Promisifying a Node.js style function","text_count":37,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Promisifying a Node.js style function"}]},{"block_type":"element","block":"k5zy5aw5","search_text":"In JavaScript, not all the asynchronous functions and libraries support promises out-of-the-box. Most of the time, we have to convert a typical callback-based function into one that returns a promise; this process is also known as promisification .","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In JavaScript, not all the asynchronous functions and libraries support promises out-of-the-box. Most of the time, we have to convert a typical callback-based function into one that returns a promise; this process is also known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"promisification"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5aw6","search_text":"Fortunately, the callback conventions used in Node.js allow us to create a reusable function that we can utilize to promisify any Node.js style API. We can do this easily by using the constructor of the Promise object. Let's then create a new function called promisify() and include it into the utilities.js module (so we can use it later in our web spider application):","text_count":370,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Fortunately, the callback conventions used in Node.js allow us to create a reusable function that we can utilize to promisify any Node.js style API. We can do this easily by using the constructor of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"object. Let's then create a new function called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promisify()"}]},{"block_type":"text","content":"and include it into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"utilities.js"}]},{"block_type":"text","content":"module (so we can use it later in our web spider application):"}]},{"block_type":"element","block":"k5zy5aw7","search_text":"module.exports.promisify = function(callbackBasedApi) { return function promisified() { const args = [].slice.call(arguments); return new Promise((resolve, reject) => { //[1] args.push((err, result) => { //[2] if(err) { return reject(err); //[3] } if(arguments.length <= 2) { //[4] resolve(result); } else { resolve([].slice.call(arguments, 1)); } }); callbackBasedApi.apply(null, args); //[5] }); } }; ","text_count":403,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports.promisify = function(callbackBasedApi) { \n  return function promisified() { \n    const args = [].slice.call(arguments); \n    return new Promise((resolve, reject) =&gt; {        //[1] \n      args.push((err, result) =&gt; {                   //[2] \n        if(err) { \n          return reject(err);                        //[3] \n        } \n        if(arguments.length &lt;= 2) {                  //[4] \n          resolve(result); \n        } else { \n          resolve([].slice.call(arguments, 1)); \n        } \n      }); \n      callbackBasedApi.apply(null, args);            //[5] \n    }); \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5aw8","search_text":"The preceding function returns another function called promisified() , which represents the promisified version of the callbackBasedApi given in the input. This is how it works:","text_count":177,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding function returns another function called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promisified()"}]},{"block_type":"text","content":", which represents the promisified version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callbackBasedApi"}]},{"block_type":"text","content":"given in the input. This is how it works:"}]},{"block_type":"element","block":"k5zy5aw9","search_text":"The promisified() function creates a new promise using the Promise constructor and immediately returns it to the caller. In the function passed to the Promise constructor, we make sure to pass to callbackBasedApi , a special callback. As we know that the callback always comes last, we simply append it to the argument list ( args ) provided to the promisified() function. In the special callback, if we receive an error, we immediately reject the promise. If no error is received, we resolve the promise with a value or an array of values, depending on how many results are passed to the callback. Finally, we simply invoke the callbackBasedApi with the list of arguments we have built. ","text_count":688,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promisified()"}]},{"block_type":"text","content":"function creates a new promise using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"constructor and immediately returns it to the caller."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In the function passed to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"constructor, we make sure to pass to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callbackBasedApi"}]},{"block_type":"text","content":", a special callback. As we know that the callback always comes last, we simply append it to the argument list ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"args"}]},{"block_type":"text","content":") provided to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promisified()"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In the special callback, if we receive an error, we immediately reject the promise."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If no error is received, we resolve the promise with a value or an array of values, depending on how many results are passed to the callback."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, we simply invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callbackBasedApi"}]},{"block_type":"text","content":"with the list of arguments we have built."}]}]},{"block_type":"element","block":"k5zy5awa","search_text":"Note Most of the promise implementations already provide, out-of-the-box, some sort of helper to convert a Node.js style API to one returning a promise. For example, Q has Q.denodeify() and Q.nbind() , Bluebird has Promise.promisify() , and When.js has node.lift() . ","text_count":267,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Most of the promise implementations already provide, out-of-the-box, some sort of helper to convert a Node.js style API to one returning a promise. For example, Q has"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Q.denodeify()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Q.nbind()"}]},{"block_type":"text","content":", Bluebird has"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise.promisify()"}]},{"block_type":"text","content":", and When.js has"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node.lift()"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5awb","search_text":"Sequential execution","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sequential execution"}]},{"block_type":"element","block":"k5zy5awc","search_text":"After a little bit of necessary theory, we are now ready to convert our web spider application to use promises. Let's start directly from version 2, the one downloading the links of a web page in sequence.","text_count":205,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"After a little bit of necessary theory, we are now ready to convert our web spider application to use promises. Let's start directly from version 2, the one downloading the links of a web page in sequence."}]},{"block_type":"element","block":"k5zy5awd","search_text":"In the spider.js module, the very first step required is to load our promises implementation (we will use it later) and promisify the callback-based functions that we plan to use:","text_count":179,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider.js"}]},{"block_type":"text","content":"module, the very first step required is to load our promises implementation (we will use it later) and promisify the callback-based functions that we plan to use:"}]},{"block_type":"element","block":"k5zy5awe","search_text":"const utilities = require('./utilities'); const request = utilities.promisify(require('request')); const mkdirp = utilities.promisify(require('mkdirp')); const fs = require('fs'); const readFile = utilities.promisify(fs.readFile); const writeFile = utilities.promisify(fs.writeFile); ","text_count":284,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const utilities = require('./utilities'); \n \nconst request = utilities.promisify(require('request')); \nconst mkdirp = utilities.promisify(require('mkdirp')); \nconst fs = require('fs'); \nconst readFile = utilities.promisify(fs.readFile); \nconst writeFile = utilities.promisify(fs.writeFile);"}]}]},{"block_type":"element","block":"k5zy5awf","search_text":"Now, we can start converting the download() function:","text_count":53,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, we can start converting the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"download()"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k5zy5awg","search_text":"function download(url, filename) { console.log(`Downloading ${url}`); let body; return request(url) .then(response => { body = response.body; return mkdirp(path.dirname(filename)); }) .then(() => writeFile(filename, body)) .then(() => { console.log(`Downloaded and saved: ${url}`); return body; }); } ","text_count":301,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function download(url, filename) { \n  console.log(`Downloading ${url}`); \n  let body; \n  return request(url) \n    .then(response =&gt; { \n      body = response.body; \n      return mkdirp(path.dirname(filename)); \n    }) \n    .then(() =&gt; writeFile(filename, body)) \n    .then(() =&gt; { \n      console.log(`Downloaded and saved: ${url}`); \n      return body; \n    }); \n}"}]}]},{"block_type":"element","block":"k5zy5awh","search_text":"The important thing to notice here is that we also registered an onRejected() function for the promise returned by readFile() to handle cases where a page has not been downloaded (file does not exist). Also, it's interesting to see how we were able to use throw to propagate the error from within the handler.","text_count":309,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The important thing to notice here is that we also registered an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onRejected()"}]},{"block_type":"text","content":"function for the promise returned by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readFile()"}]},{"block_type":"text","content":"to handle cases where a page has not been downloaded (file does not exist). Also, it's interesting to see how we were able to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"throw"}]},{"block_type":"text","content":"to propagate the error from within the handler."}]},{"block_type":"element","block":"k5zy5awi","search_text":"Now that we have converted our spider() function as well, we can modify its main invocation as follows:","text_count":103,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have converted our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function as well, we can modify its main invocation as follows:"}]},{"block_type":"element","block":"k5zy5awj","search_text":"spider(process.argv[2], 1) .then(() => console.log('Download complete')) .catch(err => console.log(err)); ","text_count":106,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"spider(process.argv[2], 1) \n  .then(() =&gt; console.log('Download complete')) \n  .catch(err =&gt; console.log(err));"}]}]},{"block_type":"element","block":"k5zy5awk","search_text":"Note how we used, for the first time, the syntactic sugar catch to handle any error situations originating from the spider() function. If we look again at all the code we have written so far, we would be pleasantly surprised by the fact that we haven't included any error propagation logic, as we would be forced to do when using callbacks. This is clearly an enormous advantage, as it greatly reduces the boilerplate in our code and the chances of missing any asynchronous errors.","text_count":481,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note how we used, for the first time, the syntactic sugar"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"catch"}]},{"block_type":"text","content":"to handle any error situations originating from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function. If we look again at all the code we have written so far, we would be pleasantly surprised by the fact that we haven't included any error propagation logic, as we would be forced to do when using callbacks. This is clearly an enormous advantage, as it greatly reduces the boilerplate in our code and the chances of missing any asynchronous errors."}]},{"block_type":"element","block":"k5zy5awl","search_text":"Now, the only missing bit to complete version 2 of our web spider application is the spiderLinks() function, which we are going to implement in a moment.","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, the only missing bit to complete version 2 of our web spider application is the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function, which we are going to implement in a moment."}]},{"block_type":"element","block":"k5zy5awm","search_text":"Sequential iteration","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sequential iteration"}]},{"block_type":"element","block":"k5zy5awn","search_text":"So far, the web spider codebase was mainly an overview of what promises are and how they are used, demonstrating how simple and elegant it is to implement a sequential execution flow using promises. However, the code we considered until now only involves the execution of a known set of asynchronous operations. So, the missing piece that will complete our exploration of sequential execution flows is to see how we can implement an iteration using promises. Again, the spiderLinks() function of web spider version 2 is a perfect example to show that.","text_count":551,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So far, the web spider codebase was mainly an overview of what promises are and how they are used, demonstrating how simple and elegant it is to implement a sequential execution flow using promises. However, the code we considered until now only involves the execution of a known set of asynchronous operations. So, the missing piece that will complete our exploration of sequential execution flows is to see how we can implement an iteration using promises. Again, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function of web spider version 2 is a perfect example to show that."}]},{"block_type":"element","block":"k5zy5awo","search_text":"Let's add the missing piece:","text_count":28,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's add the missing piece:"}]},{"block_type":"element","block":"k5zy5awp","search_text":"function spiderLinks(currentUrl, body, nesting) { let promise = Promise.resolve(); if(nesting === 0) { return promise; } const links = utilities.getPageLinks(currentUrl, body); links.forEach(link => { promise = promise.then(() => spider(link, nesting - 1)); }); return promise; } ","text_count":280,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting) { \n  let promise = Promise.resolve(); \n  if(nesting === 0) { \n    return promise; \n  } \n  const links = utilities.getPageLinks(currentUrl, body); \n  links.forEach(link =&gt; { \n    promise = promise.then(() =&gt; spider(link, nesting - 1)); \n  }); \n \n  return promise; \n}"}]}]},{"block_type":"element","block":"k5zy5awq","search_text":"To iterate asynchronously over all the links of a web page, we had to dynamically build a chain of promises:","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To iterate asynchronously over all the links of a web page, we had to dynamically build a chain of promises:"}]},{"block_type":"element","block":"k5zy5awr","search_text":"First, we defined an \"empty\" promise, resolving to undefined . This promise is just used as a starting point to build our chain. Then, in a loop, we updated the promise variable with a new promise obtained by invoking then() on the previous promise in the chain. This is actually our asynchronous iteration pattern using promises. ","text_count":331,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, we defined an \"empty\" promise, resolving to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"undefined"}]},{"block_type":"text","content":". This promise is just used as a starting point to build our chain."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Then, in a loop, we updated the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promise"}]},{"block_type":"text","content":"variable with a new promise obtained by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"on the previous promise in the chain. This is actually our asynchronous iteration pattern using promises."}]}]},{"block_type":"element","block":"k5zy5aws","search_text":"This way, at the end of the loop, the promise variable will contain the promise of the last then() invocation in the loop, so it will resolve only when all the promises in the chain have been resolved.","text_count":201,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This way, at the end of the loop, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promise"}]},{"block_type":"text","content":"variable will contain the promise of the last"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"invocation in the loop, so it will resolve only when all the promises in the chain have been resolved."}]},{"block_type":"element","block":"k5zy5awt","search_text":"With this, we completely converted our web spider version 2 to use promises. We should now be able to try it out again.","text_count":119,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this, we completely converted our web spider version 2 to use promises. We should now be able to try it out again."}]},{"block_type":"element","block":"k5zy5awu","search_text":"Sequential iteration – the pattern","text_count":34,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sequential iteration &ndash; the pattern"}]},{"block_type":"element","block":"k5zy5awv","search_text":"To conclude this section on sequential execution, let's extract the pattern to iterate over a set of promises in sequence:","text_count":122,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To conclude this section on sequential execution, let's extract the pattern to iterate over a set of promises in sequence:"}]},{"block_type":"element","block":"k5zy5aww","search_text":"let tasks = [ /* ... */ ] let promise = Promise.resolve(); tasks.forEach(task => { promise = promise.then(() => { return task(); }); }); promise.then(() => { //All tasks completed }); ","text_count":184,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"let tasks = [ /* ... */ ] \nlet promise = Promise.resolve(); \ntasks.forEach(task =&gt; { \n  promise = promise.then(() =&gt; { \n    return task(); \n  }); \n}); \npromise.then(() =&gt; { \n  //All tasks completed \n});"}]}]},{"block_type":"element","block":"k5zy5awx","search_text":"An alternative to using the forEach() loop is the reduce() function, allowing an even more compact code:","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An alternative to using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"forEach()"}]},{"block_type":"text","content":"loop is the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reduce()"}]},{"block_type":"text","content":"function, allowing an even more compact code:"}]},{"block_type":"element","block":"k5zy5awy","search_text":"let tasks = [ /* ... */ ] let promise = tasks.reduce((prev, task) => { return prev.then(() => { return task(); }); }, Promise.resolve()); promise.then(() => { //All tasks completed }); ","text_count":185,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"let tasks = [ /* ... */ ] \nlet promise = tasks.reduce((prev, task) =&gt; { \n  return prev.then(() =&gt; { \n    return task(); \n  }); \n}, Promise.resolve()); \n \npromise.then(() =&gt; { \n  //All tasks completed \n});"}]}]},{"block_type":"element","block":"k5zy5awz","search_text":"As always, with simple adaptations of this pattern, we could collect all the tasks' results in an array; we could implement a mapping algorithm, or build a filter, and so on.","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As always, with simple adaptations of this pattern, we could collect all the tasks' results in an array; we could implement a mapping algorithm, or build a filter, and so on."}]},{"block_type":"element","block":"k5zy5ax0","search_text":"Note Pattern (sequential iteration with promises) : This pattern dynamically builds a chain of promises using a loop. ","text_count":118,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern (sequential iteration with promises)"}]},{"block_type":"text","content":":"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This pattern dynamically builds a chain of promises using a loop."}]}]},{"block_type":"element","block":"k5zy5ax1","search_text":"Parallel execution","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Parallel execution"}]},{"block_type":"element","block":"k5zy5ax2","search_text":"Another execution flow that becomes trivial with promises is the parallel execution flow. In fact, all that we need to do is use the built-in Promise.all() . This helper function creates another promise, which fulfills only when all the promises received in an input are fulfilled. That's essentially a parallel execution because no order between the various promises' resolutions is enforced.","text_count":393,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another execution flow that becomes trivial with promises is the parallel execution flow. In fact, all that we need to do is use the built-in"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise.all()"}]},{"block_type":"text","content":". This helper function creates another promise, which fulfills only when all the promises received in an input are fulfilled. That's essentially a parallel execution because no order between the various promises' resolutions is enforced."}]},{"block_type":"element","block":"k5zy5ax3","search_text":"To demonstrate this, let's consider version 3 of our web spider application, which downloads all the links in page in parallel. Let's update the spiderLinks() function again to implement a parallel flow, using promises:","text_count":219,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate this, let's consider version 3 of our web spider application, which downloads all the links in page in parallel. Let's update the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function again to implement a parallel flow, using promises:"}]},{"block_type":"element","block":"k5zy5ax4","search_text":"function spiderLinks(currentUrl, body, nesting) { if(nesting === 0) { return Promise.resolve(); } const links = utilities.getPageLinks(currentUrl, body); const promises = links.map(link => spider(link, nesting - 1)); return Promise.all(promises); } ","text_count":249,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting) { \n  if(nesting === 0) { \n    return Promise.resolve(); \n  } \n \n  const links = utilities.getPageLinks(currentUrl, body); \n  const promises = links.map(link =&gt; spider(link, nesting - 1)); \n \n  return Promise.all(promises); \n}"}]}]},{"block_type":"element","block":"k5zy5ax5","search_text":"The pattern here consists of starting the spider() tasks all at once in the elements.map() loop, which also collects all their promises. This time, in the loop, we are not waiting for the previous download to complete before starting a new one: all the download tasks are started in the loop at once, one after the other. Afterwards, we leverage the Promise.all() method, which returns a new promise that will be fulfilled when all the promises in the array are fulfilled. In other words, it fulfills when all the download tasks have completed; this is exactly what we wanted.","text_count":576,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The pattern here consists of starting the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"tasks all at once in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"elements.map()"}]},{"block_type":"text","content":"loop, which also collects all their promises. This time, in the loop, we are not waiting for the previous download to complete before starting a new one: all the download tasks are started in the loop at once, one after the other. Afterwards, we leverage the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise.all()"}]},{"block_type":"text","content":"&nbsp;method, which returns a new promise that will be fulfilled when all the promises in the array are fulfilled. In other words, it fulfills when all the download tasks have completed; this is exactly what we wanted."}]},{"block_type":"element","block":"k5zy5ax6","search_text":"Limited parallel execution","text_count":26,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Limited parallel execution"}]},{"block_type":"element","block":"k5zy5ax7","search_text":"Unfortunately, the ES2015 Promise API does not provide a native way to limit the number of concurrent tasks, but we can always rely on what we learned about limiting the concurrency with plain JavaScript. In fact, the pattern we implemented inside the TaskQueue class can be easily adapted to support tasks that return a promise. This can easily be done by modifying the next() method:","text_count":385,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Unfortunately, the ES2015 Promise API does not provide a native way to limit the number of concurrent tasks, but we can always rely on what we learned about limiting the concurrency with plain JavaScript. In fact, the pattern we implemented inside the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"class can be easily adapted to support tasks that return a promise. This can easily be done by modifying the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"next()"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k5zy5ax8","search_text":"next() { while(this.running < this.concurrency && this.queue.length) { const task = this.queue.shift(); task().then(() => { this.running--; this.next(); }); this.running++; } } ","text_count":177,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"next() { \n  while(this.running &lt; this.concurrency && this.queue.length) { \n    const task = this.queue.shift(); \n    task().then(() =&gt; { \n      this.running--; \n      this.next(); \n    }); \n    this.running++; \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5ax9","search_text":"Instead of handling the task with a callback, we simply invoke then() on the promise it returns. The rest of the code is basically identical to the old version of TaskQueue .","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Instead of handling the task with a callback, we simply invoke"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"on the promise it returns. The rest of the code is basically identical to the old version of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5axa","search_text":"Let's go back to the spider.js module, and modify it to support our new version of the TaskQueue class. First, we make sure to define a new instance of TaskQueue :","text_count":163,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's go back to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider.js"}]},{"block_type":"text","content":"module, and modify it to support our new version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"class. First, we make sure to define a new instance of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5axb","search_text":"const TaskQueue = require('./taskQueue'); const downloadQueue = new TaskQueue(2); ","text_count":82,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const TaskQueue = require('./taskQueue'); \nconst downloadQueue = new TaskQueue(2);"}]}]},{"block_type":"element","block":"k5zy5axc","search_text":"Then, it's the turn of the spiderLinks() function again. The change here is also pretty straightforward:","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, it's the turn of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function again. The change here is also pretty straightforward:"}]},{"block_type":"element","block":"k5zy5axd","search_text":"function spiderLinks(currentUrl, body, nesting) { if(nesting === 0) { return Promise.resolve(); } const links = utilities.getPageLinks(currentUrl, body); //we need the following because the Promise we create next //will never settle if there are no tasks to process if(links.length === 0) { return Promise.resolve(); } return new Promise((resolve, reject) => { let completed = 0; let errored = false; links.forEach(link => { let task = () => { return spider(link, nesting - 1) .then(() => { if(++completed === links.length) { resolve(); } }) .catch(() => { if (!errored) { errored = true; reject(); } }); }; downloadQueue.pushTask(task); }); }); } ","text_count":648,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting) { \n  if(nesting === 0) { \n    return Promise.resolve(); \n  } \n \n  const links = utilities.getPageLinks(currentUrl, body); \n  //we need the following because the Promise we create next \n  //will never settle if there are no tasks to process \n  if(links.length === 0) { \n    return Promise.resolve(); \n  } \n \n  return new Promise((resolve, reject) =&gt; { \n    let completed = 0; \n    let errored = false; \n    links.forEach(link =&gt; { \n      let task = () =&gt; { \n        return spider(link, nesting - 1) \n          .then(() =&gt; { \n            if(++completed === links.length) { \n              resolve(); \n            } \n          }) \n          .catch(() =&gt; { \n            if (!errored) { \n              errored = true; \n              reject(); \n            } \n          }); \n      }; \n      downloadQueue.pushTask(task); \n    });  \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5axe","search_text":"There are a couple of things in the previous code that deserve our attention:","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are a couple of things in the previous code that deserve our attention:"}]},{"block_type":"element","block":"k5zy5axf","search_text":"First, we needed to return a new promise created using the Promise constructor. As we will see, this enables us to resolve the promise manually, when all of the tasks in the queue are completed. Second, we should look at how we defined the task. What we did is attach an onFulfilled() callback to the promise returned by spider() , so we could count the number of completed downloaded tasks. When the amount of completed downloads matches the number of links in the current page, we know that we are done processing, so we can invoke the resolve() function of the outer promise. ","text_count":579,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, we needed to return a new promise created using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"constructor. As we will see, this enables us to resolve the promise manually, when all of the tasks in the queue are completed."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Second, we should look at how we defined the task. What we did is attach an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onFulfilled()"}]},{"block_type":"text","content":"callback to the promise returned by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":", so we could count the number of completed downloaded tasks. When the amount of completed downloads matches the number of links in the current page, we know that we are done processing, so we can invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"resolve()"}]},{"block_type":"text","content":"function of the outer promise."}]}]},{"block_type":"element","block":"k5zy5axg","search_text":"Note The Promises/A+ specification states that the onFulfilled() and onRejected() callbacks of the then() method have to be invoked only once and exclusively (only one or the other is invoked). A compliant promises implementation makes sure that even if we call resolve or reject multiple times, the promise is either fulfilled or rejected only once. ","text_count":351,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Promises/A+ specification states that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onFulfilled()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onRejected()"}]},{"block_type":"text","content":"callbacks of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"method have to be invoked only once and exclusively (only one or the other is invoked). A compliant promises implementation makes sure that even if we call"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"resolve"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reject"}]},{"block_type":"text","content":"multiple times, the promise is either fulfilled or rejected only once."}]}]},{"block_type":"element","block":"k5zy5axh","search_text":"Version 4 of the web spider application using promises should now be ready to try out. We might notice once again how the download tasks now run in parallel, with a concurrency limit of 2.","text_count":188,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Version 4 of the web spider application using promises should now be ready to try out. We might notice once again how the download tasks now run in parallel, with a concurrency limit of 2."}]},{"block_type":"element","block":"k5zy5axi","search_text":"Exposing callbacks and promises in public APIs","text_count":46,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Exposing callbacks and promises in public APIs"}]},{"block_type":"element","block":"k5zy5axj","search_text":"As we have learned in the previous paragraphs, promises can be used as a nice replacement for callbacks. They turn out to be very useful for making our code more readable and easy to reason about. While promises bring many advantages, they also require the developer to understand many non-trivial concepts in order to be used correctly and proficiently. For this and other reasons, in some cases it might be more practical to prefer callbacks to promises.","text_count":456,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we have learned in the previous paragraphs, promises can be used as a nice replacement for callbacks. They turn out to be very useful for making our code more readable and easy to reason about. While promises bring many advantages, they also require the developer to understand many non-trivial concepts in order to be used correctly and proficiently. For this and other reasons, in some cases it might be more practical to prefer callbacks to promises."}]},{"block_type":"element","block":"k5zy5axk","search_text":"Now let's imagine for a moment that we want to build a public library that performs asynchronous operations. What do we do? Do we create a callback-oriented API or a promise-oriented one? Do we need to be opinionated on one side or another or there are ways to support both and make everyone happy?","text_count":298,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now let's imagine for a moment that we want to build a public library that performs asynchronous operations. What do we do? Do we create a callback-oriented API or a promise-oriented one? Do we need to be opinionated on one side or another or there are ways to support both and make everyone happy?"}]},{"block_type":"element","block":"k5zy5axl","search_text":"This is a problem that many well-known libraries face and there are at least two approaches that are worth mentioning that allow us to provide a versatile API.","text_count":159,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is a problem that many well-known libraries face and there are at least two approaches that are worth mentioning that allow us to provide a versatile API."}]},{"block_type":"element","block":"k5zy5axm","search_text":"The first approach, used by libraries such as request , redis , and mysql , consists of offering a simple API that is only based on callbacks and leave the developer the option to promisify the exposed functions if needed. Some of these libraries provide helpers to be able to promisify all the asynchronous functions they offer, but the developer still needs to somehow convert the exposed API to be able to use promises.","text_count":422,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first approach, used by libraries such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"redis"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mysql"}]},{"block_type":"text","content":", consists of offering a simple API that is only based on callbacks and leave the developer the option to promisify the exposed functions if needed. Some of these libraries provide helpers to be able to promisify all the asynchronous functions they offer, but the developer still needs to somehow convert the exposed API to be able to use promises."}]},{"block_type":"element","block":"k5zy5axn","search_text":"The second approach is more transparent. It also offers a callback-oriented API, but it makes the callback argument optional. Whenever the callback is passed as an argument, the function will behave normally, executing the callback on completion or on failure.When the callback is not passed, the function will immediately return a Promise object. This approach effectively combines callbacks and promises in a way that allows the developer to choose at call time what interface to adopt, without any need to promisify the function in advance. Many libraries, such as mongoose and sequelize , support this approach.","text_count":615,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The second approach is more transparent. It also offers a callback-oriented API, but it makes the callback argument optional. Whenever the callback is passed as an argument, the function will behave normally, executing the callback on completion or on failure.When the callback is not passed, the function will immediately return a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"object. This approach effectively combines callbacks and promises in a way that allows the developer to choose at call time what interface to adopt, without any need to promisify the function in advance. Many libraries, such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mongoose"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sequelize"}]},{"block_type":"text","content":", support this approach."}]},{"block_type":"element","block":"k5zy5axo","search_text":"Let's see a simple implementation of this approach with an example. Let's assume we want to implement a dummy module that executes divisions asynchronously:","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see a simple implementation of this approach with an example. Let's assume we want to implement a dummy module that executes divisions asynchronously:"}]},{"block_type":"element","block":"k5zy5axp","search_text":"module.exports = function asyncDivision (dividend, divisor, cb) { return new Promise((resolve, reject) => { // [1] process.nextTick(() => { const result = dividend / divisor; if (isNaN(result) || !Number.isFinite(result)) { const error = new Error('Invalid operands'); if (cb) { cb(error); } // [2] return reject(error); } if (cb) { cb(null, result); } // [3] resolve(result); }); }); }; ","text_count":388,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = function asyncDivision (dividend, divisor, cb) { \n  return new Promise((resolve, reject) =&gt; {               // [1] \n \n    process.nextTick(() =&gt; { \n      const result = dividend / divisor; \n      if (isNaN(result) || !Number.isFinite(result)) { \n        const error = new Error('Invalid operands'); \n        if (cb) { cb(error); }                            // [2] \n        return reject(error); \n      } \n \n      if (cb) { cb(null, result); }                       // [3] \n      resolve(result); \n    }); \n \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5axq","search_text":"The code of the module is very straightforward, but there are some details that are worth underlining:","text_count":102,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code of the module is very straightforward, but there are some details that are worth underlining:"}]},{"block_type":"element","block":"k5zy5axr","search_text":"First, were return a new promise created using the Promise constructor. We define the whole logic inside the function passed as argument to the constructor. In the case of an error, we reject the promise, but if the callback was passed at call time, we also execute the callback to propagate the error. After we calculate the result we resolve the promise, but again, if there's a callback, we propagate the result to the callback as well. ","text_count":440,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, were return a new promise created using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"constructor. We define the whole logic inside the function passed as argument to the constructor."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In the case of an error, we reject the promise, but if the callback was passed at call time, we also execute the callback to propagate the error."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"After we calculate the result we resolve the promise, but again, if there's a callback, we propagate the result to the callback as well."}]}]},{"block_type":"element","block":"k5zy5axs","search_text":"Let's see now how we can use this module with both callbacks and promises:","text_count":74,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see now how we can use this module with both callbacks and promises:"}]},{"block_type":"element","block":"k5zy5axt","search_text":"// callback oriented usage asyncDivision(10, 2, (error, result) => { if (error) { return console.error(error); } console.log(result); }); // promise oriented usage asyncDivision(22, 11) .then(result => console.log(result)) .catch(error => console.error(error)); ","text_count":262,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// callback oriented usage \nasyncDivision(10, 2, (error, result) =&gt; { \n  if (error) { \n    return console.error(error); \n  } \n  console.log(result); \n}); \n \n// promise oriented usage \nasyncDivision(22, 11) \n  .then(result =&gt; console.log(result)) \n  .catch(error =&gt; console.error(error));"}]}]},{"block_type":"element","block":"k5zy5axu","search_text":"It should be clear that with very little effort, the developers who are going to use our new module will be able to easily choose the style that best suits their needs, without having to introduce an external promisification function whenever they want to leverage promises.","text_count":274,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It should be clear that with very little effort, the developers who are going to use our new module will be able to easily choose the style that best suits their needs, without having to introduce an external promisification function whenever they want to leverage promises."}]},{"block_type":"element","block":"k5zy5axv","search_text":"Generators","text_count":10,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Generators"}]},{"block_type":"element","block":"k5zy5axw","search_text":"The ES2015 specification introduces another mechanism that, besides other things, can be used to simplify the asynchronous control flow of our Node.js applications. We are talking about generators , also known as semi-coroutines . They are a generalization of subroutines, where there can be different entry points. In a normal function, in fact, we can have only one entry point, which corresponds to the invocation of the function itself. A generator is similar to a function, but in addition, it can be suspended (using the yield statement) and then resumed at a later time. Generators are particularly useful when implementing iterators, and this should ring a bell, as we already discussed how iterators can be used to implement important asynchronous control flow patterns such as sequential and limited parallel execution.","text_count":829,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The ES2015 specification introduces another mechanism that, besides other things, can be used to simplify the asynchronous control flow of our Node.js applications. We are talking about"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"generators"}]},{"block_type":"text","content":", also known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"semi-coroutines"}]},{"block_type":"text","content":". They are a generalization of subroutines, where there can be different entry points. In a normal function, in fact, we can have only one entry point, which corresponds to the invocation of the function itself. A generator is similar to a function, but in addition, it can be suspended (using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"statement) and then resumed at a later time. Generators are particularly useful when implementing iterators, and this should ring a bell, as we already discussed how iterators can be used to implement important asynchronous control flow patterns such as sequential and limited parallel execution."}]},{"block_type":"element","block":"k5zy5axx","search_text":"The basics of generators","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The basics of generators"}]},{"block_type":"element","block":"k5zy5axy","search_text":"Before we explore the use of generators for asynchronous control flow, it's important we learn some basic concepts. Let's start from the syntax; a generator function can be declared by appending the * (asterisk) operator after the function keyword:","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Before we explore the use of generators for asynchronous control flow, it's important we learn some basic concepts. Let's start from the syntax; a generator function can be declared by appending the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"*"}]},{"block_type":"text","content":"(asterisk) operator after the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"function"}]},{"block_type":"text","content":"keyword:"}]},{"block_type":"element","block":"k5zy5axz","search_text":"function* makeGenerator() { //body } ","text_count":37,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function* makeGenerator() { \n  //body \n}"}]}]},{"block_type":"element","block":"k5zy5ay0","search_text":"Inside the makeGenerator() function, we can pause the execution using the keyword yield and return to the caller the value passed to it:","text_count":136,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Inside the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"makeGenerator()"}]},{"block_type":"text","content":"function, we can pause the execution using the keyword"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"and return to the caller the value passed to it:"}]},{"block_type":"element","block":"k5zy5ay1","search_text":"function* makeGenerator() { yield 'Hello World'; console.log('Re-entered'); } ","text_count":78,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function* makeGenerator() { \n  yield 'Hello World'; \n  console.log('Re-entered'); \n}"}]}]},{"block_type":"element","block":"k5zy5ay2","search_text":"In the preceding code, the generator yields a string, Hello World , by putting the execution of the function on pause. When the generator is resumed, the execution will start from console.log('Re-entered') .","text_count":207,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, the generator yields a string,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Hello World"}]},{"block_type":"text","content":", by putting the execution of the function on pause. When the generator is resumed, the execution will start from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"console.log('Re-entered')"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5ay3","search_text":"The makeGenerator() function is essentially a factory that, when invoked, returns a new generator object:","text_count":105,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"makeGenerator()"}]},{"block_type":"text","content":"function is essentially a factory that, when invoked, returns a new generator object:"}]},{"block_type":"element","block":"k5zy5ay4","search_text":"const gen = makeGenerator(); ","text_count":29,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const gen = makeGenerator();"}]}]},{"block_type":"element","block":"k5zy5ay5","search_text":"The most important method of the generator object is next() , which is used to start/resume the execution of the generator and returns an object in the following form:","text_count":167,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most important method of the generator object is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"next()"}]},{"block_type":"text","content":", which is used to start/resume the execution of the generator and returns an object in the following form:"}]},{"block_type":"element","block":"k5zy5ay6","search_text":"{ value: <yielded value> done: <true if the execution reached the end> } ","text_count":73,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"{ \n  value: &lt;yielded value&gt; \n  done: &lt;true if the execution reached the end&gt; \n}"}]}]},{"block_type":"element","block":"k5zy5ay7","search_text":"This object contains the value yielded by the generator ( value ) and a flag to indicate if the generator has completed its execution ( done ).","text_count":143,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This object contains the value yielded by the generator ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"value"}]},{"block_type":"text","content":") and a flag to indicate if the generator has completed its execution ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5ay8","search_text":"A simple example","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"A simple example"}]},{"block_type":"element","block":"k5zy5ay9","search_text":"To demonstrate generators, let's create a new module called fruitGenerator.js :","text_count":79,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate generators, let's create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fruitGenerator.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5aya","search_text":"function* fruitGenerator() { yield 'apple'; yield 'orange'; return 'watermelon'; } const newFruitGenerator = fruitGenerator(); console.log(newFruitGenerator.next()); //[1] console.log(newFruitGenerator.next()); //[2] console.log(newFruitGenerator.next()); //[3] ","text_count":262,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function* fruitGenerator() { \n    yield 'apple'; \n    yield 'orange'; \n    return 'watermelon'; \n} \n \nconst newFruitGenerator = fruitGenerator(); \nconsole.log(newFruitGenerator.next());    //[1] \nconsole.log(newFruitGenerator.next());    //[2] \nconsole.log(newFruitGenerator.next());    //[3]"}]}]},{"block_type":"element","block":"k5zy5ayb","search_text":"The preceding code will print the following output:","text_count":51,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code will print the following output:"}]},{"block_type":"element","block":"k5zy5ayc","search_text":"{ value: 'apple', done: false } { value: 'orange', done: false } { value: 'watermelon', done: true } ","text_count":101,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"{ value: 'apple', done: false }\n{ value: 'orange', done: false }\n{ value: 'watermelon', done: true }"}]}]},{"block_type":"element","block":"k5zy5ayd","search_text":"This is a short explanation of what happened:","text_count":45,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is a short explanation of what happened:"}]},{"block_type":"element","block":"k5zy5aye","search_text":"The first time newFruitGenerator.next() was invoked, the generator started its execution until it reached the first yield command, which put the generator on pause and returned the value apple to the caller. At the second invocation of newFruitGenerator.next() , the generator resumed, starting from the second yield command, which in turn put the execution on pause again, while returning the value orange to the caller. The last invocation of newFruitGenerator.next() caused the execution of the generator to resume from its last instruction, a return statement, which terminates the generator, returns the value watermelon , and sets the done property to true in the result object. ","text_count":685,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The first time"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"newFruitGenerator.next()"}]},{"block_type":"text","content":"was invoked, the generator started its execution until it reached the first"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"command, which put the generator on pause and returned the value"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"apple"}]},{"block_type":"text","content":"to the caller."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At the second invocation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"newFruitGenerator.next()"}]},{"block_type":"text","content":", the generator resumed, starting from the second"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"command, which in turn put the execution on pause again, while returning the value"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"orange"}]},{"block_type":"text","content":"to the caller."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The last invocation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"newFruitGenerator.next()"}]},{"block_type":"text","content":"caused the execution of the generator to resume from its last instruction, a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"return"}]},{"block_type":"text","content":"statement, which terminates the generator, returns the value&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"watermelon"}]},{"block_type":"text","content":", and sets the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done"}]},{"block_type":"text","content":"property to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true"}]},{"block_type":"text","content":"in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"result"}]},{"block_type":"text","content":"object."}]}]},{"block_type":"element","block":"k5zy5ayf","search_text":"Generators as iterators","text_count":23,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Generators as iterators"}]},{"block_type":"element","block":"k5zy5ayg","search_text":"To better understand why generators are so useful for implementing iterators, let's build one. In a new module, which we will call iteratorGenerator.js , let's write the following code:","text_count":185,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To better understand why generators are so useful for implementing iterators, let's build one. In a new module, which we will call"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"iteratorGenerator.js"}]},{"block_type":"text","content":", let's write the following code:"}]},{"block_type":"element","block":"k5zy5ayh","search_text":"function* iteratorGenerator(arr) { for(let i = 0; i <arr.length; i++) { yield arr[i]; } } const iterator = iteratorGenerator(['apple', 'orange', 'watermelon']); let currentItem = iterator.next(); while(!currentItem.done) { console.log(currentItem.value); currentItem = iterator.next(); } ","text_count":288,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function* iteratorGenerator(arr) { \n  for(let i = 0; i &lt;arr.length; i++) { \n    yield arr[i]; \n  } \n} \n \nconst iterator = iteratorGenerator(['apple', 'orange',  'watermelon']); \nlet currentItem = iterator.next(); \nwhile(!currentItem.done) { \n  console.log(currentItem.value); \n  currentItem = iterator.next(); \n}"}]}]},{"block_type":"element","block":"k5zy5ayi","search_text":"This code should print the list of the items in the array as follows:","text_count":69,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This code should print the list of the items in the array as follows:"}]},{"block_type":"element","block":"k5zy5ayj","search_text":"apple orange watermelon ","text_count":24,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"apple\norange\nwatermelon"}]}]},{"block_type":"element","block":"k5zy5ayk","search_text":"In this example, each time we call iterator.next() , we resume the for loop of the generator, which runs another cycle by yielding the next item in the array. This demonstrates how the state of the generator is maintained across invocations. When resumed, the loop and all the variables are exactly the same as when the execution was put on pause.","text_count":347,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this example, each time we call"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"iterator.next()"}]},{"block_type":"text","content":", we resume the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"for"}]},{"block_type":"text","content":"loop of the generator, which runs another cycle by yielding the next item in the array. This demonstrates how the state of the generator is maintained across invocations. When resumed, the loop and all the variables are exactly the same as when the execution was put on pause."}]},{"block_type":"element","block":"k5zy5ayl","search_text":"Passing values back to a generator","text_count":34,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Passing values back to a generator"}]},{"block_type":"element","block":"k5zy5aym","search_text":"To conclude our exploration of the basic functionality of generators, we will now learn how to pass values back to a generator. This is actually very simple; what we need to do is just provide an argument to the next() method, and that value will be provided as the return value of the yield statement inside the generator.","text_count":323,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To conclude our exploration of the basic functionality of generators, we will now learn how to pass values back to a generator. This is actually very simple; what we need to do is just provide an argument to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"next()"}]},{"block_type":"text","content":"method, and that value will be provided as the return value of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"statement inside the generator."}]},{"block_type":"element","block":"k5zy5ayn","search_text":"To show this, let's create a new simple module:","text_count":47,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To show this, let's create a new simple module:"}]},{"block_type":"element","block":"k5zy5ayo","search_text":"function* twoWayGenerator() { const what = yield null; console.log('Hello ' + what); } const twoWay = twoWayGenerator(); twoWay.next(); twoWay.next('world'); ","text_count":158,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function* twoWayGenerator() { \n  const what = yield null; \n  console.log('Hello ' + what); \n} \n \nconst twoWay = twoWayGenerator(); \ntwoWay.next(); \ntwoWay.next('world');"}]}]},{"block_type":"element","block":"k5zy5ayp","search_text":"When executed, the preceding code will print Hello world . This means that the following has happened:","text_count":102,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When executed, the preceding code will print"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Hello world"}]},{"block_type":"text","content":". This means that the following has happened:"}]},{"block_type":"element","block":"k5zy5ayq","search_text":"The first time the next() method is invoked, the generator reaches the first yield statement and is then put on pause. When next('world') is invoked, the generator resumes from the point where it was put on pause, which is on the yield instruction, but this time we have a value that is passed back to the generator. This value will then be set into the what variable. The generator then executes the console.log() instruction and terminates. ","text_count":443,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The first time the&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"next()"}]},{"block_type":"text","content":"method is invoked, the generator reaches the first"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"&nbsp;statement and is then put on pause."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"next('world')"}]},{"block_type":"text","content":"is invoked, the generator resumes from the point where it was put on pause, which is on the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"instruction, but this time we have a value that is passed back to the generator. This value will then be set into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"what"}]},{"block_type":"text","content":"variable. The generator then executes the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"console.log()"}]},{"block_type":"text","content":"instruction and terminates."}]}]},{"block_type":"element","block":"k5zy5ayr","search_text":"In a similar way, we can force a generator to throw an exception. This is possible by using the throw method of the generator, as shown in the following example:","text_count":161,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a similar way, we can force a generator to throw an exception. This is possible by using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"throw"}]},{"block_type":"text","content":"method of the generator, as shown in the following example:"}]},{"block_type":"element","block":"k5zy5ays","search_text":"const twoWay = twoWayGenerator(); twoWay.next(); twoWay.throw(new Error()); ","text_count":76,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const twoWay = twoWayGenerator(); \ntwoWay.next(); \ntwoWay.throw(new Error());"}]}]},{"block_type":"element","block":"k5zy5ayt","search_text":"Using this last code snippet, the twoWayGenerator() function will throw an exception the moment the yield function returns. This works exactly as if an exception was thrown from inside the generator, and this means that it can be caught and handled like any other exception using a try...catch block.","text_count":300,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using this last code snippet, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"twoWayGenerator()"}]},{"block_type":"text","content":"function will throw an exception the moment the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"function returns. This works exactly as if an exception was thrown from inside the generator, and this means that it can be caught and handled like any other exception using a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"try...catch"}]},{"block_type":"text","content":"block."}]},{"block_type":"element","block":"k5zy5ayu","search_text":"Asynchronous control flow with generators","text_count":41,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Asynchronous control flow with generators"}]},{"block_type":"element","block":"k5zy5ayv","search_text":"You must be wondering how generators can help us with handling asynchronous operations. We can demonstrate this by creating a special function that accepts a generator as an argument and allows us to use asynchronous code inside the generator. This function takes care to resume the execution of the generator when the asynchronous operation completes. We will call this function asyncFlow() :","text_count":393,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You must be wondering how generators can help us with handling asynchronous operations. We can demonstrate this by creating a special function that accepts a generator as an argument and allows us to use asynchronous code inside the generator. This function takes care to resume the execution of the generator when the asynchronous operation completes. We will call this function"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncFlow()"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5ayw","search_text":"function asyncFlow(generatorFunction) { function callback(err) { if(err) { return generator.throw(err); } const results = [].slice.call(arguments, 1); generator.next(results.length> 1 ? results : results[0]); } const generator = generatorFunction(callback); generator.next(); } ","text_count":278,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function asyncFlow(generatorFunction) { \n  function callback(err) { \n    if(err) { \n      return generator.throw(err); \n    } \n    const results = [].slice.call(arguments, 1); \n    generator.next(results.length&gt; 1 ? results : results[0]); \n  } \n  const generator = generatorFunction(callback); \n  generator.next(); \n}"}]}]},{"block_type":"element","block":"k5zy5ayx","search_text":"The preceding function takes a generator as input, instantiates it, and then immediately starts its execution:","text_count":110,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding function takes a generator as input, instantiates it, and then immediately starts its execution:"}]},{"block_type":"element","block":"k5zy5ayy","search_text":"const generator = generatorFunction(callback); generator.next(); ","text_count":65,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const generator = generatorFunction(callback); \ngenerator.next();"}]}]},{"block_type":"element","block":"k5zy5ayz","search_text":"The generatorFunction() receives as input, a special callback function that invokes generator.throw() if an error is received; otherwise, it resumes the execution of the generator by passing back the results received in the callback function:","text_count":242,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"generatorFunction()"}]},{"block_type":"text","content":"receives as input, a special"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function that invokes"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"generator.throw()"}]},{"block_type":"text","content":"if an error is received; otherwise, it resumes the execution of the generator by passing back the results received in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k5zy5az0","search_text":"if(err) { return generator.throw(err); } const results = [].slice.call(arguments, 1); generator.next(results.length> 1 ? results : results[0]); ","text_count":144,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if(err) { \n  return generator.throw(err); \n} \nconst results = [].slice.call(arguments, 1); \ngenerator.next(results.length&gt; 1 ? results : results[0]);"}]}]},{"block_type":"element","block":"k5zy5az1","search_text":"To demonstrate the power of this simple function, let's create a new module called clone.js , which, for no meaningful reason, creates a clone of itself. Paste the asyncFlow() function we just created, followed by the core of the program:","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate the power of this simple function, let's create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"clone.js"}]},{"block_type":"text","content":", which, for no meaningful reason, creates a clone of itself. Paste the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncFlow()"}]},{"block_type":"text","content":"function we just created, followed by the core of the program:"}]},{"block_type":"element","block":"k5zy5az2","search_text":"const fs = require('fs'); const path = require('path'); asyncFlow(function* (callback) { const fileName = path.basename(__filename); const myself = yield fs.readFile(fileName, 'utf8', callback); yield fs.writeFile(`clone_of_${filename}`, myself, callback); console.log('Clone created'); }); ","text_count":291,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nconst path = require('path'); \n \nasyncFlow(function* (callback) { \n  const fileName = path.basename(__filename); \n  const myself = yield fs.readFile(fileName, 'utf8', callback); \n  yield fs.writeFile(`clone_of_${filename}`, myself, callback); \n  console.log('Clone created'); \n});"}]}]},{"block_type":"element","block":"k5zy5az3","search_text":"Remarkably, with the help of the asyncFlow() function, we were able to write asynchronous code using a linear approach, as we were using blocking functions! The magic behind this result should be clear by now. The callback passed to each asynchronous function will in turn resume the generator as soon as the asynchronous operation is complete. Nothing complicated, but the outcome is surely impressive.","text_count":403,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Remarkably, with the help of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncFlow()"}]},{"block_type":"text","content":"function, we were able to write asynchronous code using a linear approach, as we were using blocking functions! The magic behind this result should be clear by now. The callback passed to each asynchronous function will in turn resume the generator as soon as the asynchronous operation is complete. Nothing complicated, but the outcome is surely impressive."}]},{"block_type":"element","block":"k5zy5az4","search_text":"There are two other variations of this technique, one involving the use of promises and the other using thunks.","text_count":111,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are two other variations of this technique, one involving the use of promises and the other using thunks."}]},{"block_type":"element","block":"k5zy5az5","search_text":"Note A thunk used in the generator-based control flow is just a function that partially applies all the arguments of the original function except its callback. The return value is another function that only accepts the callback as an argument. For example, the thunkified version of fs.readFile() would be as follows: function readFileThunk(filename, options) { return function(callback){ fs.readFile(filename, options, callback); } } ","text_count":435,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"thunk"}]},{"block_type":"text","content":"used in the generator-based control flow is just a function that partially applies all the arguments of the original function except its callback. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"return"}]},{"block_type":"text","content":"value is another function that only accepts the callback as an argument. For example, the thunkified version of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs.readFile()"}]},{"block_type":"text","content":"would be as follows:"}]},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function readFileThunk(filename, options) {\n&nbsp; return function(callback){\n&nbsp; &nbsp; fs.readFile(filename, options, callback);\n&nbsp; }\n}"}]}]}]},{"block_type":"element","block":"k5zy5az6","search_text":"Both thunks and promises allow us to create generators that do not need a callback to be passed as an argument; for example, a version of asyncFlow() using thunks might be the following:","text_count":186,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Both thunks and promises allow us to create generators that do not need a callback to be passed as an argument; for example, a version of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncFlow()"}]},{"block_type":"text","content":"using thunks might be the following:"}]},{"block_type":"element","block":"k5zy5az7","search_text":"function asyncFlowWithThunks(generatorFunction) { function callback(err) { if(err) { return generator.throw(err); } const results = [].slice.call(arguments, 1); const thunk = generator.next(results.length> 1 ? results : results[0]).value; thunk && thunk(callback); } const generator = generatorFunction(); const thunk = generator.next().value; thunk && thunk(callback); } ","text_count":372,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function asyncFlowWithThunks(generatorFunction) { \n  function callback(err) { \n    if(err) { \n      return generator.throw(err); \n    } \n    const results = [].slice.call(arguments, 1); \n    const thunk = generator.next(results.length&gt; 1 ? results :  \n                  results[0]).value; \n    thunk && thunk(callback); \n  } \n  const generator = generatorFunction(); \n  const thunk = generator.next().value; \n  thunk && thunk(callback); \n}"}]}]},{"block_type":"element","block":"k5zy5az8","search_text":"The trick is to read the return value of generator.next() , which contains the thunk. The next step is to invoke the thunk itself by injecting our special callback. Simple! This allows us to write the following code:","text_count":216,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The trick is to read the return value of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"generator.next()"}]},{"block_type":"text","content":", which contains the thunk. The next step is to invoke the thunk itself by injecting our special callback. Simple! This allows us to write the following code:"}]},{"block_type":"element","block":"k5zy5az9","search_text":"asyncFlowWithThunks(function* () { const fileName = path.basename(__filename); const myself = yield readFileThunk(__filename, 'utf8'); yield writeFileThunk(`clone_of_${fileName}`, myself); console.log(\"Clone created\"); }); ","text_count":223,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"asyncFlowWithThunks(function* () { \n  const fileName = path.basename(__filename); \n  const myself = yield readFileThunk(__filename, 'utf8'); \n  yield writeFileThunk(`clone_of_${fileName}`, myself); \n  console.log(\"Clone created\"); \n});"}]}]},{"block_type":"element","block":"k5zy5aza","search_text":"In the same way, we could implement a version of asyncFlow() that accepts a promise as yieldable. We leave this as an exercise as its implementation requires only a minimal change to the asyncFlowWithThunks() function. We may also implement an asyncFlow() function that accepts both promises and thunks as yieldables, using the same principles.","text_count":344,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the same way, we could implement a version of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncFlow()"}]},{"block_type":"text","content":"that accepts a promise as yieldable. We leave this as an exercise as its implementation requires only a minimal change to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncFlowWithThunks()"}]},{"block_type":"text","content":"function. We may also implement an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncFlow()"}]},{"block_type":"text","content":"function that accepts both promises and thunks as yieldables, using the same principles."}]},{"block_type":"element","block":"k5zy5azb","search_text":"Generator-based control flow using co","text_count":37,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Generator-based control flow using co"}]},{"block_type":"element","block":"k5zy5azc","search_text":"As you may guess, the Node.js ecosystem provides some solutions to handle asynchronous control flows using generators, for example, suspend ( https://npmjs.org/package/suspend ) is one of the oldest and supports promises, thunks, Node.js-style callbacks, as well as raw callbacks. Also, most of the promise libraries we analyzed earlier in the chapter provide helpers to use promises with generators.","text_count":400,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you may guess, the Node.js ecosystem provides some solutions to handle asynchronous control flows using generators, for example, suspend ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/suspend"},"children":[{"block_type":"text","content":"https://npmjs.org/package/suspend"}]},{"block_type":"text","content":") is one of the oldest and supports promises, thunks, Node.js-style callbacks, as well as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"raw"}]},{"block_type":"text","content":"callbacks. Also, most of the promise libraries we analyzed earlier in the chapter provide helpers to use promises with generators."}]},{"block_type":"element","block":"k5zy5azd","search_text":"All these solutions are based on the same principles we demonstrated with the asyncFlow() function; so, we may want to reuse one of these instead of writing one ourselves.","text_count":171,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All these solutions are based on the same principles we demonstrated with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncFlow()"}]},{"block_type":"text","content":"function; so, we may want to reuse one of these instead of writing one ourselves."}]},{"block_type":"element","block":"k5zy5aze","search_text":"For the examples in this section, we chose to use co ( https://npmjs.org/package/co ). It supports several types of yieldables, some of which are:","text_count":146,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For the examples in this section, we chose to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"co"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/co"},"children":[{"block_type":"text","content":"https://npmjs.org/package/co"}]},{"block_type":"text","content":"). It supports several types of yieldables, some of which are:"}]},{"block_type":"element","block":"k5zy5azf","search_text":"Thunks Promises Arrays (parallel execution) Objects (parallel execution) Generators (delegation) Generator functions (delegation) ","text_count":130,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Thunks"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Promises"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Arrays (parallel execution)"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Objects (parallel execution)"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Generators (delegation)"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Generator functions (delegation)"}]}]},{"block_type":"element","block":"k5zy5azg","search_text":"co also has its own ecosystem of packages including the following:","text_count":66,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"co"}]},{"block_type":"text","content":"also has its own ecosystem of packages including the following:"}]},{"block_type":"element","block":"k5zy5azh","search_text":"Web frameworks, the most popular being koa ( https://npmjs.org/package/koa ) Libraries implementing specific control flow patterns Libraries wrapping popular APIs to support co ","text_count":177,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Web frameworks, the most popular being"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"koa"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/koa"},"children":[{"block_type":"text","content":"https://npmjs.org/package/koa"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Libraries implementing specific control flow patterns"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Libraries wrapping popular APIs to support co"}]}]},{"block_type":"element","block":"k5zy5azi","search_text":"We will use co to re-implement our web spider application using generators.","text_count":75,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will use co to re-implement our web spider application using generators."}]},{"block_type":"element","block":"k5zy5azj","search_text":"While converting Node.js-style functions to thunks, we are going to use a little library called thunkify ( https://npmjs.org/package/thunkify ).","text_count":144,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"While converting Node.js-style functions to thunks, we are going to use a little library called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"thunkify"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/thunkify"},"children":[{"block_type":"text","content":"https://npmjs.org/package/thunkify"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5azk","search_text":"Sequential execution","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sequential execution"}]},{"block_type":"element","block":"k5zy5azl","search_text":"Let's start our practical exploration of generators and co by modifying version 2 of the web spider application. The very first thing we have to do is to load our dependencies and generate a thunkified version of the functions we are going to use. These will go at the top of the spider.js module:","text_count":297,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start our practical exploration of generators and co by modifying version 2 of the web spider application. The very first thing we have to do is to load our dependencies and generate a thunkified version of the functions we are going to use. These will go at the top of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider.js"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5azm","search_text":"const thunkify = require('thunkify'); const co = require('co'); const request = thunkify(require('request')); const fs = require('fs'); const mkdirp = thunkify(require('mkdirp')); const readFile = thunkify(fs.readFile); const writeFile = thunkify(fs.writeFile); const nextTick = thunkify(process.nextTick); ","text_count":307,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const thunkify = require('thunkify'); \nconst co = require('co'); \n \nconst request = thunkify(require('request')); \nconst fs = require('fs'); \nconst mkdirp = thunkify(require('mkdirp')); \nconst readFile = thunkify(fs.readFile); \nconst writeFile = thunkify(fs.writeFile); \nconst nextTick = thunkify(process.nextTick);"}]}]},{"block_type":"element","block":"k5zy5azn","search_text":"Looking at the preceding code, we can surely notice some similarities with the code we used earlier in the chapter to promisify some APIs. In this regard, it is interesting to point out that if we decided to use the promisified version of our functions instead of their thunkified alternative, the code would remain exactly the same, thanks to the fact that co supports both thunks and promises as yieldable objects. In fact, if we want, we could even use both thunks and promises in the same application, even in the same generator. This is a tremendous advantage in terms of flexibility, as it allows us to use a generator-based control flow with whatever solution we already have at our disposal.","text_count":699,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Looking at the preceding code, we can surely notice some similarities with the code we used earlier in the chapter to promisify some APIs. In this regard, it is interesting to point out that if we decided to use the promisified version of our functions instead of their thunkified alternative, the code would remain exactly the same, thanks to the fact that co supports both thunks and promises as yieldable objects. In fact, if we want, we could even use both thunks and promises in the same application, even in the same generator. This is a tremendous advantage in terms of flexibility, as it allows us to use a generator-based control flow with whatever solution we already have at our disposal."}]},{"block_type":"element","block":"k5zy5azo","search_text":"Okay, now let's start transforming the download() function into a generator:","text_count":76,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Okay, now let's start transforming the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"download()"}]},{"block_type":"text","content":"function into a generator:"}]},{"block_type":"element","block":"k5zy5azp","search_text":"function* download(url, filename) { console.log(`Downloading ${url}`); const response = yield request(url); const body = response[1]; yield mkdirp(path.dirname(filename)); yield writeFile(filename, body); console.log(`Downloaded and saved ${url}`); return body; } ","text_count":264,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function* download(url, filename) { \n  console.log(`Downloading ${url}`); \n  const response = yield request(url); \n  const body = response[1]; \n  yield mkdirp(path.dirname(filename)); \n  yield writeFile(filename, body); \n  console.log(`Downloaded and saved ${url}`); \n  return body; \n}"}]}]},{"block_type":"element","block":"k5zy5azq","search_text":"By using generators and co, our download() function suddenly becomes trivial. All we had to do is convert it into a generator function and use yield wherever we had an asynchronous function (as thunk ) to invoke.","text_count":212,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By using generators and co, our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"download()"}]},{"block_type":"text","content":"function suddenly becomes trivial. All we had to do is convert it into a generator function and use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"wherever we had an asynchronous function (as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"thunk"}]},{"block_type":"text","content":") to invoke."}]},{"block_type":"element","block":"k5zy5azr","search_text":"Next, it's the turn of the spider() function:","text_count":45,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, it's the turn of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k5zy5azs","search_text":"function* spider(url, nesting) { const filename = utilities.urlToFilename(url); let body; try { body = yield readFile(filename, 'utf8'); } catch(err) { if(err.code !== 'ENOENT') { throw err; } body = yield download(url, filename); } yield spiderLinks(url, body, nesting); } ","text_count":274,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function* spider(url, nesting) { \n  const filename = utilities.urlToFilename(url); \n  let body; \n  try { \n    body = yield readFile(filename, 'utf8'); \n  } catch(err) { \n    if(err.code !== 'ENOENT') { \n      throw err; \n    } \n    body = yield download(url, filename); \n  } \n  yield spiderLinks(url, body, nesting); \n}"}]}]},{"block_type":"element","block":"k5zy5azt","search_text":"The interesting detail to notice from this last fragment of code is how we were able to use a try...catch block to handle exceptions. Also, we can now use throw to propagate errors! Another remarkable line is where we yield the download() function, which is not a thunk nor a promisified function, but just another generator. This is possible, thanks to co, which also supports other generators as yieldables.","text_count":409,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The interesting detail to notice from this last fragment of code is how we were able to use a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"try...catch"}]},{"block_type":"text","content":"block to handle exceptions. Also, we can now use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"throw"}]},{"block_type":"text","content":"to propagate errors! Another remarkable line is where we yield the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"download()"}]},{"block_type":"text","content":"function, which is not a thunk nor a promisified function, but just another generator. This is possible, thanks to co, which also supports other generators as yieldables."}]},{"block_type":"element","block":"k5zy5azu","search_text":"Finally, we can also convert spiderLinks() , where we implemented an iteration to download the links of a web page in sequence. With generators, this becomes trivial as well:","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we can also convert"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":", where we implemented an iteration to download the links of a web page in sequence. With generators, this becomes trivial as well:"}]},{"block_type":"element","block":"k5zy5azv","search_text":"function* spiderLinks(currentUrl, body, nesting) { if(nesting === 0) { return nextTick(); } const links = utilities.getPageLinks(currentUrl, body); for(let i = 0; i <links.length; i++) { yield spider(links[i], nesting - 1); } } ","text_count":228,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function* spiderLinks(currentUrl, body, nesting) { \n  if(nesting === 0) { \n    return nextTick(); \n  } \n \n  const links = utilities.getPageLinks(currentUrl, body); \n  for(let i = 0; i &lt;links.length; i++) { \n    yield spider(links[i], nesting - 1); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5azw","search_text":"There is little to explain from the previous code. There is no pattern to show for the sequential iteration; generators and co are doing all the dirty work for us, so we were able to write the asynchronous iteration as if we were using blocking, direct style APIs.","text_count":264,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There is little to explain from the previous code. There is no pattern to show for the sequential iteration; generators and co are doing all the dirty work for us, so we were able to write the asynchronous iteration as if we were using blocking, direct style APIs."}]},{"block_type":"element","block":"k5zy5azx","search_text":"Now comes the most important part, the entry point of our program:","text_count":66,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now comes the most important part, the entry point of our program:"}]},{"block_type":"element","block":"k5zy5azy","search_text":"co(function* () { try { yield spider(process.argv[2], 1); console.log('Download complete'); } catch(err) { console.log(err); } }); ","text_count":131,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"co(function* () { \n  try { \n    yield spider(process.argv[2], 1); \n    console.log('Download complete'); \n  } catch(err) { \n    console.log(err); \n  } \n});"}]}]},{"block_type":"element","block":"k5zy5azz","search_text":"This is the only place where we have to invoke co(...) to wrap a generator. In fact, once we do that, co will automatically wrap any generator we pass to a yield statement, and this will happen recursively, so the rest of the program is totally agnostic to the fact we are using co , even though it's under the hood.","text_count":316,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is the only place where we have to invoke"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"co(...)"}]},{"block_type":"text","content":"to wrap a generator. In fact, once we do that,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"co"}]},{"block_type":"text","content":"will automatically wrap any generator we pass to a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":"statement, and this will happen recursively, so the rest of the program is totally agnostic to the fact we are using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"co"}]},{"block_type":"text","content":", even though it's under the hood."}]},{"block_type":"element","block":"k5zy5b00","search_text":"Now it should be possible to run our generator-based web spider application.","text_count":76,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now it should be possible to run our generator-based web spider application."}]},{"block_type":"element","block":"k5zy5b01","search_text":"Parallel execution","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Parallel execution"}]},{"block_type":"element","block":"k5zy5b02","search_text":"The bad news about generators is that they are great for writing sequential algorithms, but they can't be used to parallelize the execution of a set of tasks, at least not just using yield and generators. In fact, the pattern to use in these circumstances is to simply rely on a callback-based or promise-based function, which in turn can easily be yielded and used with generators.","text_count":382,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The bad news about generators is that they are great for writing sequential algorithms, but they can't be used to parallelize the execution of a set of tasks, at least not just using yield and generators. In fact, the pattern to use in these circumstances is to simply rely on a callback-based or promise-based function, which in turn can easily be yielded and used with generators."}]},{"block_type":"element","block":"k5zy5b03","search_text":"Luckily, for the specific case of the unlimited parallel execution, co already allows us to obtain it natively by simply yielding an array of promises, thunks, generators, or generator functions.","text_count":195,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Luckily, for the specific case of the unlimited parallel execution, co already allows us to obtain it natively by simply yielding an array of promises, thunks, generators, or generator functions."}]},{"block_type":"element","block":"k5zy5b04","search_text":"With this in mind, version 3 of our web spider application can be implemented simply by rewriting the spiderLinks() function as follows:","text_count":136,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this in mind, version 3 of our web spider application can be implemented simply by rewriting the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function as follows:"}]},{"block_type":"element","block":"k5zy5b05","search_text":"function* spiderLinks(currentUrl, body, nesting) { if(nesting === 0) { return nextTick(); } const links = utilities.getPageLinks(currentUrl, body); const tasks = links.map(link => spider(link, nesting - 1)); yield tasks; } ","text_count":223,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function* spiderLinks(currentUrl, body, nesting) { \n  if(nesting === 0) { \n    return nextTick(); \n  } \n \n  const links = utilities.getPageLinks(currentUrl, body); \n  const tasks = links.map(link =&gt; spider(link, nesting - 1)); \n  yield tasks; \n}"}]}]},{"block_type":"element","block":"k5zy5b06","search_text":"What we did was just to collect all the download tasks, which are essentially generators, and then yield on the resulting array. All these tasks will be executed by co in parallel and then the execution of our generator ( spiderLinks ) will be resumed when all the tasks finish running.","text_count":286,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What we did was just to collect all the download tasks, which are essentially generators, and then yield on the resulting array. All these tasks will be executed by co in parallel and then the execution of our generator ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks"}]},{"block_type":"text","content":") will be resumed when all the tasks finish running."}]},{"block_type":"element","block":"k5zy5b07","search_text":"If you think we cheated by exploiting the feature of co that allows us to yield on an array, it is possible to demonstrate how the same parallel flow can be achieved using a callback-based solution similar to what we have already used earlier in the chapter. Let's use this technique to rewrite spiderLinks() once again:","text_count":320,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you think we cheated by exploiting the feature of co that allows us to yield on an array, it is possible to demonstrate how the same parallel flow can be achieved using a callback-based solution similar to what we have already used earlier in the chapter. Let's use this technique to rewrite"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"once again:"}]},{"block_type":"element","block":"k5zy5b08","search_text":"function spiderLinks(currentUrl, body, nesting) { if(nesting === 0) { return nextTick(); } //returns a thunk return callback => { let completed = 0, hasErrors = false; const links = utilities.getPageLinks(currentUrl, body); if(links.length === 0) { return process.nextTick(callback); } function done(err, result) { if(err && !hasErrors) { hasErrors = true; return callback(err); } if(++completed === links.length && !hasErrors) { callback(); } } for(let i = 0; i < links.length; i++) { co(spider(links[i], nesting - 1)).then(done); } } } ","text_count":538,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting) { \n  if(nesting === 0) { \n    return nextTick(); \n  } \n \n  //returns a thunk \n  return callback =&gt; { \n    let completed = 0, hasErrors = false; \n    const links = utilities.getPageLinks(currentUrl, body); \n    if(links.length === 0) { \n      return process.nextTick(callback); \n    } \n \n    function done(err, result) { \n      if(err && !hasErrors) { \n        hasErrors = true; \n        return callback(err); \n      } \n      if(++completed === links.length && !hasErrors) { \n        callback(); \n      } \n    } \n \n    for(let i = 0; i &lt; links.length; i++) { \n      co(spider(links[i], nesting - 1)).then(done); \n    } \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5b09","search_text":"To run the spider() function in parallel, we use co , which executes the generator and returns a promise. This way, we are able to wait for the promise to be resolved and call the done() function. Usually, all the libraries for generator-based control flows have similar features, so you can always transform a generator into a callback-based or a promise-based function if needed.","text_count":381,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To run the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spider()"}]},{"block_type":"text","content":"function in parallel, we use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"co"}]},{"block_type":"text","content":", which executes the generator and returns a promise. This way, we are able to wait for the promise to be resolved and call the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done()"}]},{"block_type":"text","content":"function. Usually, all the libraries for generator-based control flows have similar features, so you can always transform a generator into a callback-based or a promise-based function if needed."}]},{"block_type":"element","block":"k5zy5b0a","search_text":"To start multiple download tasks in parallel, we just reused the callback-based pattern for parallel execution defined earlier in the chapter. We should also notice that we transformed the spiderLinks() function to a thunk (it's not even a generator anymore.) This enabled us to have a callback function to invoke when all the parallel tasks are completed.","text_count":356,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To start multiple download tasks in parallel, we just reused the callback-based pattern for parallel execution defined earlier in the chapter. We should also notice that we transformed the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function to a thunk (it's not even a generator anymore.) This enabled us to have a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function to invoke when all the parallel tasks are completed."}]},{"block_type":"element","block":"k5zy5b0b","search_text":"Note Pattern (generator-to-thunk) It converts a generator to a thunk in order to be able to run it in parallel or utilize it for taking advantage of other callback- or promise-based control flow algorithms. ","text_count":207,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern (generator-to-thunk)"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It converts a generator to a thunk in order to be able to run it in parallel or utilize it for taking advantage of other callback- or promise-based control flow algorithms."}]}]},{"block_type":"element","block":"k5zy5b0c","search_text":"Limited parallel execution","text_count":26,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Limited parallel execution"}]},{"block_type":"element","block":"k5zy5b0d","search_text":"Now that we know what to do with nonsequential execution flows, it should be easy to plan the implementation of version 4 of our web spider application, the one imposing a limit on the number of concurrent download tasks. We have several options we can use to do that; some of them are as follows:","text_count":297,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we know what to do with nonsequential execution flows, it should be easy to plan the implementation of version 4 of our web spider application, the one imposing a limit on the number of concurrent download tasks. We have several options we can use to do that; some of them are as follows:"}]},{"block_type":"element","block":"k5zy5b0e","search_text":"Use the callback-based version of the previously implemented TaskQueue class. We would need to just thunkify its functions and any generator we want to use as a task. Use the promises-based version of the TaskQueue class, and just make sure that each generator we want to use as a task is converted into a function returning a promise. Use async , and thunkify any helper we plan to use, in addition to converting any generator to a callback-based function that can be used by the library. Use a library from the co ecosystem, specifically designed for this type of flow, such as, co-limiter ( https://npmjs.org/package/co-limiter ). Implement a custom algorithm based on the producer-consumer pattern, the same that co-limiter uses internally. ","text_count":745,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Use the callback-based version of the previously implemented"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"class. We would need to just thunkify its functions and any generator we want to use as a task."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Use the promises-based version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"class, and just make sure that each generator we want to use as a task is converted into a function returning a promise."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":", and thunkify any helper we plan to use, in addition to converting any generator to a callback-based function that can be used by the library."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Use a library from the co ecosystem, specifically designed for this type of flow, such as,"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"co-limiter"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/co-limiter"},"children":[{"block_type":"text","content":"https://npmjs.org/package/co-limiter"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Implement a custom algorithm based on the producer-consumer pattern, the same that co-limiter uses internally."}]}]},{"block_type":"element","block":"k5zy5b0f","search_text":"For educational purposes, we are going to choose the last option, so we can dive into a pattern that is often associated with coroutines (but also threads and processes).","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For educational purposes, we are going to choose the last option, so we can dive into a pattern that is often associated with coroutines (but also threads and processes)."}]},{"block_type":"element","block":"k5zy5b0g","search_text":"Producer-consumer pattern","text_count":25,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Producer-consumer pattern"}]},{"block_type":"element","block":"k5zy5b0h","search_text":"The goal is to leverage a queue to feed a fixed number of workers, as many as the concurrency level we want to set. To implement this algorithm, we are going to take as a starting point, the TaskQueue class we defined earlier in the chapter:","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The goal is to leverage a queue to feed a fixed number of workers, as many as the concurrency level we want to set. To implement this algorithm, we are going to take as a starting point, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"class we defined earlier in the chapter:"}]},{"block_type":"element","block":"k5zy5b0i","search_text":"class TaskQueue { constructor(concurrency) { this.concurrency = concurrency; this.running = 0; this.taskQueue = []; this.consumerQueue = []; this.spawnWorkers(concurrency); } pushTask(task) { if (this.consumerQueue.length !== 0) { this.consumerQueue.shift()(null, task); } else { this.taskQueue.push(task); } } spawnWorkers(concurrency) { const self = this; for(let i = 0; i < concurrency; i++) { co(function* () { while(true) { const task = yield self.nextTask(); yield task; } }); } } nextTask() { return callback => { if(this.taskQueue.length !== 0) { return callback(null, this.taskQueue.shift()); } this.consumerQueue.push(callback); } } } ","text_count":645,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class TaskQueue { \n  constructor(concurrency) { \n    this.concurrency = concurrency; \n    this.running = 0; \n    this.taskQueue = []; \n    this.consumerQueue = []; \n    this.spawnWorkers(concurrency); \n  } \n \n  pushTask(task) { \n    if (this.consumerQueue.length !== 0) { \n      this.consumerQueue.shift()(null, task); \n    } else { \n      this.taskQueue.push(task); \n    } \n  } \n \n  spawnWorkers(concurrency) { \n    const self = this; \n    for(let i = 0; i &lt; concurrency; i++) { \n      co(function* () { \n        while(true) { \n          const task = yield self.nextTask(); \n          yield task; \n        } \n      }); \n    } \n  } \n \n  nextTask() { \n    return callback =&gt; { \n      if(this.taskQueue.length !== 0) { \n        return callback(null, this.taskQueue.shift()); \n      } \n \n      this.consumerQueue.push(callback); \n    } \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5b0j","search_text":"Let's start to analyze this new implementation of TaskQueue . The first thing to underline is in the constructor. Notice the invocation of this.spawnWorkers() , as this is the method in charge of starting the workers.","text_count":217,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start to analyze this new implementation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":". The first thing to underline is in the constructor. Notice the invocation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this.spawnWorkers()"}]},{"block_type":"text","content":", as this is the method in charge of starting the workers."}]},{"block_type":"element","block":"k5zy5b0k","search_text":"Our workers are very simple; they are just generators wrapped around co() and executed immediately so that each one can run in parallel. Internally, each worker is running an infinite loop that blocks ( yield ) waiting for a new task to be available in the queue ( yield self.nextTask() ), and when this happens, it yields the task (which is any valid yieldable) waiting for its completion. You may be wondering how we can actually wait for the next task to be queued. The answer is in the nextTask() method. Let's see in greater detail what happens within this method:","text_count":569,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our workers are very simple; they are just generators wrapped around"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"co()"}]},{"block_type":"text","content":"and executed immediately so that each one can run in parallel. Internally, each worker is running an infinite loop that blocks ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield"}]},{"block_type":"text","content":") waiting for a new task to be available in the queue ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield self.nextTask()"}]},{"block_type":"text","content":"), and when this happens, it yields the task (which is any valid yieldable) waiting for its completion. You may be wondering how we can actually wait for the next task to be queued. The answer is in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"nextTask()"}]},{"block_type":"text","content":"method. Let's see in greater detail what happens within this method:"}]},{"block_type":"element","block":"k5zy5b0l","search_text":"nextTask() { return callback => { if(this.taskQueue.length !== 0) { return callback(null, this.taskQueue.shift()); } this.consumerQueue.push(callback); } } ","text_count":156,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"nextTask() { \n  return callback =&gt; { \n    if(this.taskQueue.length !== 0) { \n      return callback(null, this.taskQueue.shift()); \n    } \n    this.consumerQueue.push(callback); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5b0m","search_text":"Let's see what happens in this method, which is the core of the pattern:","text_count":72,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see what happens in this method, which is the core of the pattern:"}]},{"block_type":"element","block":"k5zy5b0n","search_text":"The method returns a thunk, which is a valid yieldable for co . The callback of the returned thunk is invoked by providing the next task in the taskQueue function (if there is any available). This will immediately unblock a worker, providing the next task to yield on. If there are no tasks in the queue, the callback itself is pushed into consumerQueue . By doing this, we are basically putting a worker in idle mode. The callbacks in the consumerQueue function will be invoked as soon as we have a new task to process, which will resume the corresponding worker. ","text_count":565,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The method returns a thunk, which is a valid yieldable for"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"co"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The callback of the returned thunk is invoked by providing the next task in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"taskQueue"}]},{"block_type":"text","content":"function (if there is any available). This will immediately unblock a worker, providing the next task to yield on."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If there are no tasks in the queue, the callback itself is pushed into"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consumerQueue"}]},{"block_type":"text","content":". By doing this, we are basically putting a worker in"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"idle"}]},{"block_type":"text","content":"mode. The callbacks in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consumerQueue"}]},{"block_type":"text","content":"function will be invoked as soon as we have a new task to process, which will resume the corresponding worker."}]}]},{"block_type":"element","block":"k5zy5b0o","search_text":"Now, to understand how the idle workers in the consumerQueue function are resumed, we need to analyze the pushTask() method. The pushTask() method invokes the first callback in the consumerQueue function if available, which in turn will unblock a worker. If no callback is available, it means that all the workers are busy, so we simply add a new item to the taskQueue function.","text_count":378,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, to understand how the idle workers in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consumerQueue"}]},{"block_type":"text","content":"function are resumed, we need to analyze the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pushTask()"}]},{"block_type":"text","content":"method. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pushTask()"}]},{"block_type":"text","content":"method invokes the first callback in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consumerQueue"}]},{"block_type":"text","content":"function if available, which in turn will unblock a worker. If no callback is available, it means that all the workers are busy, so we simply add a new item to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"taskQueue"}]},{"block_type":"text","content":"function."}]},{"block_type":"element","block":"k5zy5b0p","search_text":"In the TaskQueue class, the workers have the role of consumers, while whoever uses pushTask() can be considered a producer. This pattern shows us how a generator can be very similar to a thread (or a process). In fact, the producer-consumer interaction is probably the most common problem presented when studying inter-process communication techniques, but as we already mentioned, it is also a common use case for coroutines.","text_count":426,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"class, the workers have the role of consumers, while whoever uses"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pushTask()"}]},{"block_type":"text","content":"can be considered a producer. This pattern shows us how a generator can be very similar to a thread (or a process). In fact, the producer-consumer interaction is probably the most common problem presented when studying inter-process communication techniques, but as we already mentioned, it is also a common use case for coroutines."}]},{"block_type":"element","block":"k5zy5b0q","search_text":"Limiting the download tasks concurrency","text_count":39,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Limiting the download tasks concurrency"}]},{"block_type":"element","block":"k5zy5b0r","search_text":"Now that we have implemented a limited parallel algorithm using generators and the producer-consumer pattern, we can apply it to limit the concurrency of the download tasks of our web spider application (version 4). First, let's load and initialize a TaskQueue object:","text_count":268,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have implemented a limited parallel algorithm using generators and the producer-consumer pattern, we can apply it to limit the concurrency of the download tasks of our web spider application (version 4). First, let's load and initialize a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TaskQueue"}]},{"block_type":"text","content":"object:"}]},{"block_type":"element","block":"k5zy5b0s","search_text":"const TaskQueue = require('./taskQueue'); const downloadQueue = new TaskQueue(2); ","text_count":82,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const TaskQueue = require('./taskQueue'); \nconst downloadQueue = new TaskQueue(2);"}]}]},{"block_type":"element","block":"k5zy5b0t","search_text":"Next, let's modify the spiderLinks() function. Its body is almost identical to the one we just used to implement the unlimited parallel execution flow, so we will only show the changed parts here:","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, let's modify the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"spiderLinks()"}]},{"block_type":"text","content":"function. Its body is almost identical to the one we just used to implement the unlimited parallel execution flow, so we will only show the changed parts here:"}]},{"block_type":"element","block":"k5zy5b0u","search_text":"function spiderLinks(currentUrl, body, nesting) { //... return (callback) => { //... function done(err, result) { //... } links.forEach(function(link) { downloadQueue.pushTask(function *() { yield spider(link, nesting - 1); done(); }); }); } } ","text_count":244,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function spiderLinks(currentUrl, body, nesting) { \n  //... \n  return (callback) =&gt; { \n    //... \n    function done(err, result) { \n      //... \n    } \n    links.forEach(function(link) { \n      downloadQueue.pushTask(function *() { \n        yield spider(link, nesting - 1); \n        done(); \n      }); \n    }); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5b0v","search_text":"In each of the tasks, we invoke the done() function just after a download completes, so we can count how many links were downloaded and then notify the callback of the thunk when all are complete.","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In each of the tasks, we invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done()"}]},{"block_type":"text","content":"function just after a download completes, so we can count how many links were downloaded and then notify the callback of the thunk when all are complete."}]},{"block_type":"element","block":"k5zy5b0w","search_text":"As an exercise, you can try to implement version 4 of the web spider application, using the other four methods we presented at the beginning of this section.","text_count":157,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As an exercise, you can try to implement version 4 of the web spider application, using the other four methods we presented at the beginning of this section."}]},{"block_type":"element","block":"k5zy5b0x","search_text":"Async await using Babel","text_count":23,"tag_name":"h1","attributes":{},"children":[{"block_type":"text","content":"Async await using Babel"}]},{"block_type":"element","block":"k5zy5b0y","search_text":"Callbacks, promises, and generators turn out to be the weapons at our disposal to deal with asynchronous code in JavaScript and in Node.js. As we have seen, generators are very interesting because they offer a way to actually suspend the execution of a function and resume it at a later stage. Now we can adopt this feature to write asynchronous code that allows developers to write functions that \"appear\" to block at each asynchronous operation, waiting for the results before continuing with the following statement.","text_count":519,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Callbacks, promises, and generators turn out to be the weapons at our disposal to deal with asynchronous code in JavaScript and in Node.js. As we have seen, generators are very interesting because they offer a way to actually suspend the execution of a function and resume it at a later stage. Now we can adopt this feature to write asynchronous code that allows developers to write functions that \"appear\" to block at each asynchronous operation, waiting for the results before continuing with the following statement."}]},{"block_type":"element","block":"k5zy5b0z","search_text":"The problem is that generator functions are designed to deal mostly with iterators and their usage with asynchronous code feels a bit cumbersome. It might be hard to understand, leading to code that is hard to read and maintain.","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The problem is that generator functions are designed to deal mostly with iterators and their usage with asynchronous code feels a bit cumbersome. It might be hard to understand, leading to code that is hard to read and maintain."}]},{"block_type":"element","block":"k5zy5b10","search_text":"But there is hope that there will be a cleaner syntax sometime in the near future. In fact, there is an interesting proposal that will be introduced with the ECMAScript 2017 specification that defines the async function's syntax.","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But there is hope that there will be a cleaner syntax sometime in the near future. In fact, there is an interesting proposal that will be introduced with the ECMAScript 2017 specification that defines the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"function's syntax."}]},{"block_type":"element","block":"k5zy5b11","search_text":"Note You can read more about the current status of the async await proposal at https://tc39.github.io/ecmascript-asyncawait/ . ","text_count":127,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can read more about the current status of the async await proposal at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://tc39.github.io/ecmascript-asyncawait/"},"children":[{"block_type":"text","content":"https://tc39.github.io/ecmascript-asyncawait/"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5b12","search_text":"The async function specification aims to dramatically improve the language-level model for writing asynchronous code by introducing two new keywords into the language: async and await .","text_count":185,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"function specification aims to dramatically improve the language-level model for writing asynchronous code by introducing two new keywords into the language:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"await"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5b13","search_text":"To clarify how these keywords are meant to be used and why they are useful, let's see a very quick example:","text_count":107,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To clarify how these keywords are meant to be used and why they are useful, let's see a very quick example:"}]},{"block_type":"element","block":"k5zy5b14","search_text":"const request = require('request'); function getPageHtml(url) { return new Promise(function(resolve, reject) { request(url, function(error, response, body) { resolve(body); }); }); } async function main() { const html = await getPageHtml('http://google.com'); console.log(html); } main(); console.log('Loading...'); ","text_count":316,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const request = require('request'); \n \nfunction getPageHtml(url) { \n  return new Promise(function(resolve, reject) { \n    request(url, function(error, response, body) { \n      resolve(body); \n    }); \n  }); \n} \n \nasync function main() { \n  const html = await getPageHtml('http://google.com'); \n  console.log(html); \n} \n \nmain(); \nconsole.log('Loading...');"}]}]},{"block_type":"element","block":"k5zy5b15","search_text":"In this code,there are two functions: getPageHtml and main . The first one is a very simple function that fetches the HTML code of a remote web page given its URL. It's worth noticing that this function returns a promise.","text_count":221,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this code,there are two functions:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"getPageHtml"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main"}]},{"block_type":"text","content":". The first one is a very simple function that fetches the HTML code of a remote web page given its URL. It's worth noticing that this function returns a promise."}]},{"block_type":"element","block":"k5zy5b16","search_text":"The main function is the most interesting one because it's where the new async and await keywords are used. The first thing to notice is that the function is prefixed with the async keyword. This means that the function executes asynchronous code and allows it to use the await keyword within its body. The await keyword before the call to getPageHtml tells the JavaScript interpreter to \"await\" the resolution of the promise returned by getPageHtml before continuing to the next instruction. This way, the main function is internally suspended until the asynchronous code completes without blocking the normal execution of the rest of the program. In fact, we will see the string Loading... in the console and, after a moment, the HTML code of the Google landing page.","text_count":769,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main"}]},{"block_type":"text","content":"function is the most interesting one because it's where the new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"await"}]},{"block_type":"text","content":"keywords are used. The first thing to notice is that the function is prefixed with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"keyword. This means that the function executes asynchronous code and allows it to use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"await"}]},{"block_type":"text","content":"keyword within its body. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"await"}]},{"block_type":"text","content":"keyword before the call to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"getPageHtml"}]},{"block_type":"text","content":"tells the JavaScript interpreter to \"await\" the resolution of the promise returned by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"getPageHtml"}]},{"block_type":"text","content":"before continuing to the next instruction. This way, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main"}]},{"block_type":"text","content":"function is internally suspended until the asynchronous code completes without blocking the normal execution of the rest of the program. In fact, we will see the string"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Loading..."}]},{"block_type":"text","content":"in the console and, after a moment, the HTML code of the Google landing page."}]},{"block_type":"element","block":"k5zy5b17","search_text":"Isn't this approach much more readable and easy to understand?","text_count":62,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Isn't this approach much more readable and easy to understand?"}]},{"block_type":"element","block":"k5zy5b18","search_text":"Unfortunately, this proposal is not yet final, and even if it will be approved we will need to wait for the next version of the ECMAScript specification to come out and be integrated in Node.js to be able to use this new syntax natively.","text_count":237,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Unfortunately, this proposal is not yet final, and even if it will be approved we will need to wait for the next version of the ECMAScript specification to come out and be integrated in Node.js to be able to use this new syntax natively."}]},{"block_type":"element","block":"k5zy5b19","search_text":"So what do we do today? Just wait? No, of course not! We can already leverage async await in our code thanks to transpilers such as Babel.","text_count":138,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So what do we do today? Just wait? No, of course not! We can already leverage async await in our code thanks to transpilers such as Babel."}]},{"block_type":"element","block":"k5zy5b1a","search_text":"Installing and running Babel","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Installing and running Babel"}]},{"block_type":"element","block":"k5zy5b1b","search_text":"Babel is a JavaScript compiler (or transpiler) that is able to convert JavaScript code into other JavaScript code using syntax transformers. Syntax transformers allows the use of new syntax such as ES2015, ES2016, JSX, and others to produce backward compatible equivalent code that can be executed in modern JavaScript runtimes, such as browsers or Node.js.","text_count":357,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Babel is a JavaScript compiler (or transpiler) that is able to convert JavaScript code into other JavaScript code using syntax transformers. Syntax transformers allows the use of new syntax such as ES2015, ES2016, JSX, and others to produce backward compatible equivalent code that can be executed in modern JavaScript runtimes, such as browsers or Node.js."}]},{"block_type":"element","block":"k5zy5b1c","search_text":"You can install Babel in your project using npm with the following command:","text_count":75,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can install Babel in your project using npm with the following command:"}]},{"block_type":"element","block":"k5zy5b1d","search_text":"npm install --save-dev babel-cli ","text_count":33,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install --save-dev babel-cli"}]}]},{"block_type":"element","block":"k5zy5b1e","search_text":"We also need to install the extensions to support async await parsing and transformation:","text_count":89,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We also need to install the extensions to support async await parsing and transformation:"}]},{"block_type":"element","block":"k5zy5b1f","search_text":"npm install --save-dev babel-plugin-syntax-async-functions babel-plugin-transform-async-to-generator ","text_count":101,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install --save-dev babel-plugin-syntax-async-functions \n    babel-plugin-transform-async-to-generator"}]}]},{"block_type":"element","block":"k5zy5b1g","search_text":"Now let's assume we want to run our previous example (called index.js ). We need to launch the following command:","text_count":113,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now let's assume we want to run our previous example (called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.js"}]},{"block_type":"text","content":"). We need to launch the following command:"}]},{"block_type":"element","block":"k5zy5b1h","search_text":"node_modules/.bin/babel-node --plugins \"syntax-async-functions,transform-async-to-generator\"index.js ","text_count":101,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node_modules/.bin/babel-node --plugins \n    \"syntax-async-functions,transform-async-to-generator\"index.js"}]}]},{"block_type":"element","block":"k5zy5b1i","search_text":"This way, we are transforming the source code in index.js on the fly, applying the transformers to support async await. This new backward compatible code is stored in memory and then executed on the fly on the Node.js runtime.","text_count":226,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This way, we are transforming the source code in"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.js"}]},{"block_type":"text","content":"on the fly, applying the transformers to support async await. This new backward compatible code is stored in memory and then executed on the fly on the Node.js runtime."}]},{"block_type":"element","block":"k5zy5b1j","search_text":"Babel can also be configured to act as a build processor that stores the generated code into files so that you can easily deploy and run the generated code.","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Babel can also be configured to act as a build processor that stores the generated code into files so that you can easily deploy and run the generated code."}]},{"block_type":"element","block":"k5zy5b1k","search_text":"Note You can read more about how to install and configure Babel on the official website at https://babeljs.io . ","text_count":112,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can read more about how to install and configure Babel on the official website at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://babeljs.io"},"children":[{"block_type":"text","content":"https://babeljs.io"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5b1l","search_text":"Comparison","text_count":10,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Comparison"}]},{"block_type":"element","block":"k5zy5b1m","search_text":"At this point, we should have a better understanding of the options we have to tame the asynchronous nature of JavaScript. Each one of the solutions presented has its own pros and cons. Let's summarize them in the following table:","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we should have a better understanding of the options we have to tame the asynchronous nature of JavaScript. Each one of the solutions presented has its own pros and cons. Let's summarize them in the following table:"}]},{"block_type":"element","block":"k5zy5b1n","search_text":"Solutions Pros Cons Plain JavaScript Does not require any additional libraries or technology Offers the best performance Provides the best level of compatibility with third-party libraries Allows the creation of ad hoc and more advanced algorithms Might require extra code and relatively complex algorithms Async (library) Simplifies the most common control flow patterns Is still a callback-based solution Good performance Introduces an external dependency Might still not be enough for advanced flows Promises Greatly simplifies the most common control flow patterns Robust error handling Part of the ES2015 specification Guarantees deferred invocation of onFulfilled and onRejected Requires promisify callback-based APIs Introduces a small performance hit Generators Makes non-blocking API look like a blocking one Simplifies error handling Part of ES2015 specification Requires a complementary control flow library Still requires callbacks or promises to implement non-sequential flows Requires thunkify or promisify nongenerator-based APIs Async await Makes non-blocking API look like blocking Clean and intuitive syntax Not yet available in JavaScript and Node.js natively Requires Babel or other transpilers and some configuration to be used today ","text_count":1255,"tag_name":"table","attributes":{"border":"1"},"children":[{"block_type":"element","tag_name":"colgroup","attributes":{},"children":[{"block_type":"element","tag_name":"col","attributes":{},"children":[]},{"block_type":"element","tag_name":"col","attributes":{},"children":[]},{"block_type":"element","tag_name":"col","attributes":{},"children":[]}]},{"block_type":"element","tag_name":"thead","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"th","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Solutions"}]}]}]},{"block_type":"element","tag_name":"th","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pros"}]}]}]},{"block_type":"element","tag_name":"th","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cons"}]}]}]}]}]},{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Plain JavaScript"}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Does not require any additional libraries or technology"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Offers the best performance"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Provides the best level of compatibility with third-party libraries"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Allows the creation of ad hoc and more advanced algorithms"}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Might require extra code and relatively complex algorithms"}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Async (library)"}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Simplifies the most common control flow patterns"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Is still a callback-based solution"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Good performance"}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Introduces an external dependency"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Might still not be enough for advanced flows"}]}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Promises"}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Greatly simplifies the most common control flow patterns"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Robust error handling"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Part of the ES2015 specification"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Guarantees deferred invocation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onFulfilled"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onRejected"}]}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Requires promisify callback-based APIs"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Introduces a small performance hit"}]}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Generators"}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Makes non-blocking API look like a blocking one"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Simplifies error handling"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Part of ES2015 specification"}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Requires a complementary control flow library"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Still requires callbacks or promises to implement non-sequential flows"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Requires thunkify or promisify nongenerator-based APIs"}]}]}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Async await"}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Makes non-blocking API look like blocking"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Clean and intuitive syntax"}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Not yet available in JavaScript and Node.js natively"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Requires Babel or other transpilers and some configuration to be used today"}]}]}]}]}]}]},{"block_type":"element","block":"k5zy5b1o","search_text":"Note It is worth mentioning that we chose to present in this chapter only the most popular solutions to handle asynchronous control flow, or the ones receiving a lot of momentum, but it's good to know that there are a few more options you might want to look at, for example, Fibers ( https://npmjs.org/package/fibers ) and Streamline ( https://npmjs.org/package/streamline ). ","text_count":376,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is worth mentioning that we chose to present in this chapter only the most popular solutions to handle asynchronous control flow, or the ones receiving a lot of momentum, but it's good to know that there are a few more options you might want to look at, for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Fibers"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/fibers"},"children":[{"block_type":"text","content":"https://npmjs.org/package/fibers"}]},{"block_type":"text","content":") and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Streamline"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/streamline"},"children":[{"block_type":"text","content":"https://npmjs.org/package/streamline"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5b1p","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5b1q","search_text":"Throughout this chapter, we analyzed some alternative approaches of dealing with asynchronous control flows considering promises, generators, and the upcoming async await syntax.","text_count":178,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Throughout this chapter, we analyzed some alternative approaches of dealing with asynchronous control flows considering promises, generators, and the upcoming async await syntax."}]},{"block_type":"element","block":"k5zy5b1r","search_text":"We learned how to use these approaches to write asynchronous code that is more concise, cleaner and easier to reason about. We discussed some of the most important advantages and drawbacks of these approaches and realized that even if they are very useful they need some time to be mastered. That's why they should not be seen as a complete replacement of callbacks which are still very useful in many scenarios. As a developer, you should now be able to decide which solution best suits the problem you are facing. If you are building a public library that performs asynchronous operations, you should provide an interface that is easy to use, even for developers who only want to use callbacks.","text_count":696,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We learned how to use these approaches to write asynchronous code that is more concise, cleaner and easier to reason about. We discussed some of the most important advantages and drawbacks of these approaches and realized that even if they are very useful they need some time to be mastered. That's why they should not be seen as a complete replacement of callbacks which are still very useful in many scenarios. As a developer, you should now be able to decide which solution best suits the problem you are facing. If you are building a public library that performs asynchronous operations, you should provide an interface that is easy to use, even for developers who only want to use callbacks."}]},{"block_type":"element","block":"k5zy5b1s","search_text":"In the next chapter we will explore another fascinating topic relevant to asynchronous code execution and which is another fundamental building block in the whole Node.js ecosystem: streams.","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter we will explore another fascinating topic relevant to asynchronous code execution and which is another fundamental building block in the whole Node.js ecosystem: streams."}]}]},{"title":"Coding with Streams","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4mnb","number":5,"contents":[{"block_type":"element","block":"k5zy5b1t","search_text":"Streams are one of the most important components and patterns of Node.js. There is a motto in the community that says \"stream all the things!\" and this alone should be enough to describe the role of streams in Node.js. Dominic Tarr, a top contributor to the Node.js community, defines streams as node's best and most misunderstood idea. There are different reasons that make Node.js streams so attractive; again, it's not just related to technical properties, such as performance or efficiency, but it's more about their elegance and the way they fit perfectly into the Node.js philosophy.","text_count":589,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Streams are one of the most important components and patterns of Node.js. There is a motto in the community that says \"stream all the things!\" and this alone should be enough to describe the role of streams in Node.js. Dominic Tarr, a top contributor to the Node.js community, defines streams as node's best and most misunderstood idea. There are different reasons that make Node.js streams so attractive; again, it's not just related to technical properties, such as performance or efficiency, but it's more about their elegance and the way they fit perfectly into the Node.js philosophy."}]},{"block_type":"element","block":"k5zy5b1u","search_text":"In this chapter, you will learn about the following topics:","text_count":59,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, you will learn about the following topics:"}]},{"block_type":"element","block":"k5zy5b1v","search_text":"Why streams are so important in Node.js Using and creating streams Streams as a programming paradigm: leveraging their power in many different contexts and not just for I/O Piping patterns and connecting streams together in different configurations ","text_count":249,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Why streams are so important in Node.js"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using and creating streams"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Streams as a programming paradigm: leveraging their power in many different contexts and not just for I/O"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Piping patterns and connecting streams together in different configurations"}]}]},{"block_type":"element","block":"k5zy5b1w","search_text":"Discovering the importance of streams","text_count":37,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Discovering the importance of streams"}]},{"block_type":"element","block":"k5zy5b1x","search_text":"In an event-based platform such as Node.js, the most efficient way to handle I/O is in real time, consuming the input as soon as it is available and sending the output as soon as it is produced by the application.","text_count":213,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In an event-based platform such as Node.js, the most efficient way to handle I/O is in real time, consuming the input as soon as it is available and sending the output as soon as it is produced by the application."}]},{"block_type":"element","block":"k5zy5b1y","search_text":"In this section, we are going to give an initial introduction to Node.js streams and their strengths. Please bear in mind that this is only an overview, as a more detailed analysis on how to use and compose streams will follow later in the chapter.","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we are going to give an initial introduction to Node.js streams and their strengths. Please bear in mind that this is only an overview, as a more detailed analysis on how to use and compose streams will follow later in the chapter."}]},{"block_type":"element","block":"k5zy5b1z","search_text":"Buffering versus streaming","text_count":26,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Buffering versus streaming"}]},{"block_type":"element","block":"k5zy5b20","search_text":"Almost all the asynchronous APIs that we've seen so far in the book work using buffer mode . For an input operation, buffer mode causes all the data coming from a resource to be collected into a buffer; it is then passed to a callback as soon as the entire resource is read. The following diagram shows a visual example of this paradigm:","text_count":337,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Almost all the asynchronous APIs that we've seen so far in the book work using"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"buffer mode"}]},{"block_type":"text","content":". For an input operation, buffer mode causes all the data coming from a resource to be collected into a buffer; it is then passed to a callback as soon as the entire resource is read. The following diagram shows a visual example of this paradigm:"}]},{"block_type":"element","block":"k5zy5b21","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000001.jpg","alt":"Buffering versus streaming","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5b22","search_text":"In the preceding figure, we can see that, at the time t1 , some data is received from the resource and saved into the buffer. At the time t2 , another data chunk is received—the final one—that completes the read operation and causes the entire buffer to be sent to the consumer.","text_count":278,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding figure, we can see that, at the time"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"t1"}]},{"block_type":"text","content":", some data is received from the resource and saved into the buffer. At the time"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"t2"}]},{"block_type":"text","content":", another data chunk is received&mdash;the final one&mdash;that completes the read operation and causes the entire buffer to be sent to the consumer."}]},{"block_type":"element","block":"k5zy5b23","search_text":"On the other side, streams allow you to process the data as soon as it arrives from the resource. This is shown in the following diagram:","text_count":137,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other side, streams allow you to process the data as soon as it arrives from the resource. This is shown in the following diagram:"}]},{"block_type":"element","block":"k5zy5b24","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000033.jpg","alt":"Buffering versus streaming","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5b25","search_text":"This time, the diagram shows you how each new chunk of data is received from the resource and is immediately provided to the consumer, who now has the chance to process it straight away without waiting for all the data to be collected in the buffer.","text_count":249,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This time, the diagram shows you how each new chunk of data is received from the resource and is immediately provided to the consumer, who now has the chance to process it straight away without waiting for all the data to be collected in the buffer."}]},{"block_type":"element","block":"k5zy5b26","search_text":"But what are the differences between the two approaches? We can summarize them in two major categories:","text_count":103,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But what are the differences between the two approaches? We can summarize them in two major categories:"}]},{"block_type":"element","block":"k5zy5b27","search_text":"Spatial efficiency Time efficiency ","text_count":35,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Spatial efficiency"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Time efficiency"}]}]},{"block_type":"element","block":"k5zy5b28","search_text":"However, Node.js streams have another important advantage: composability . Let's now see what impact these properties have in the way we design and write our applications.","text_count":171,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, Node.js streams have another important advantage:"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"composability"}]},{"block_type":"text","content":". Let's now see what impact these properties have in the way we design and write our applications."}]},{"block_type":"element","block":"k5zy5b29","search_text":"Spatial efficiency","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Spatial efficiency"}]},{"block_type":"element","block":"k5zy5b2a","search_text":"First of all, streams allow us to do things that would not be possible, by buffering data and processing it all at once. For example, consider the case in which we have to read a very big file, let's say, in the order of hundreds of megabytes or even gigabytes. Clearly, using an API that returns a big buffer when the file is completely read is not a good idea. Imagine reading a few of these big files concurrently; our application will easily run out of memory. Besides that, buffers in V8 cannot be bigger than 0x3FFFFFFF bytes (a little bit less than 1GB). So, we might hit a wall way before running out of physical memory.","text_count":628,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First of all, streams allow us to do things that would not be possible, by buffering data and processing it all at once. For example, consider the case in which we have to read a very big file, let's say, in the order of hundreds of megabytes or even gigabytes. Clearly, using an API that returns a big buffer when the file is completely read is not a good idea. Imagine reading a few of these big files concurrently; our application will easily run out of memory. Besides that, buffers in V8 cannot be bigger than"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"0x3FFFFFFF"}]},{"block_type":"text","content":"bytes (a little bit less than 1GB). So, we might hit a wall way before running out of physical memory."}]},{"block_type":"element","block":"k5zy5b2b","search_text":"Gzipping using a buffered API","text_count":29,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Gzipping using a buffered API"}]},{"block_type":"element","block":"k5zy5b2c","search_text":"To make a concrete example, let's consider a simple command-line interface ( CLI ) application that compresses a file using the Gzip format. Using a buffered API, such an application will look like the following in Node.js (error handling is omitted for brevity):","text_count":263,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To make a concrete example, let's consider a simple"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"command-line interface"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"CLI"}]},{"block_type":"text","content":") application that compresses a file using the Gzip format. Using a buffered API, such an application will look like the following in Node.js (error handling is omitted for brevity):"}]},{"block_type":"element","block":"k5zy5b2d","search_text":"const fs = require('fs'); const zlib = require('zlib'); const file = process.argv[2]; fs.readFile(file, (err, buffer) => { zlib.gzip(buffer, (err, buffer) => { fs.writeFile(file + '.gz', buffer, err => { console.log('File successfully compressed'); }); }); }); ","text_count":261,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs');\nconst zlib = require('zlib');\n\nconst file = process.argv[2];\n\nfs.readFile(file, (err, buffer) =&gt; {\n  zlib.gzip(buffer, (err, buffer) =&gt; {\n    fs.writeFile(file + '.gz', buffer, err =&gt; {\n      console.log('File successfully compressed');\n    });\n  });\n});"}]}]},{"block_type":"element","block":"k5zy5b2e","search_text":"Now, we can try to put the preceding code in a file named gzip.js and then run it with the following command:","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, we can try to put the preceding code in a file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"gzip.js"}]},{"block_type":"text","content":"and then run it with the following command:"}]},{"block_type":"element","block":"k5zy5b2f","search_text":"node gzip <path to file> ","text_count":25,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node gzip &lt;path to file&gt;"}]}]},{"block_type":"element","block":"k5zy5b2g","search_text":"If we choose a file that is big enough, let's say a little bit bigger than 1GB, we will receive a nice error message saying that the file that we are trying to read is bigger than the maximum allowed buffer size, such as the following:","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we choose a file that is big enough, let's say a little bit bigger than 1GB, we will receive a nice error message saying that the file that we are trying to read is bigger than the maximum allowed buffer size, such as the following:"}]},{"block_type":"element","block":"k5zy5b2h","search_text":"RangeError: File size is greater than possible Buffer: 0x3FFFFFFF bytes ","text_count":72,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"RangeError: File size is greater than possible Buffer: 0x3FFFFFFF bytes"}]}]},{"block_type":"element","block":"k5zy5b2i","search_text":"That's exactly what we expected, and it's a symptom of using the wrong approach.","text_count":80,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's exactly what we expected, and it's a symptom of using the wrong approach."}]},{"block_type":"element","block":"k5zy5b2j","search_text":"Gzipping using streams","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Gzipping using streams"}]},{"block_type":"element","block":"k5zy5b2k","search_text":"The simplest way we have to fix our Gzip application and make it work with big files is to use a streaming API. Let's see how this can be achieved; let's replace the contents of the module we just created with the following code:","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The simplest way we have to fix our Gzip application and make it work with big files is to use a streaming API. Let's see how this can be achieved; let's replace the contents of the module we just created with the following code:"}]},{"block_type":"element","block":"k5zy5b2l","search_text":"const fs = require('fs'); const zlib = require('zlib'); const file = process.argv[2]; fs.createReadStream(file) .pipe(zlib.createGzip()) .pipe(fs.createWriteStream(file + '.gz')) .on('finish', () => console.log('File successfully compressed')); ","text_count":245,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs');\nconst zlib = require('zlib');\nconst file = process.argv[2];\n\nfs.createReadStream(file)\n  .pipe(zlib.createGzip())\n  .pipe(fs.createWriteStream(file + '.gz'))\n  .on('finish', () =&gt; console.log('File successfully compressed'));"}]}]},{"block_type":"element","block":"k5zy5b2m","search_text":"\"Is that it?\" you may ask. Yes; as we said, streams are amazing also because of their interface and composability, thus allowing clean, elegant, and concise code. We will see this in a while in more detail, but for now the important thing to realize is that the program will run smoothly against files of any size, ideally with constant memory utilization. Try it yourself (but consider that compressing a big file might take a while).","text_count":435,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"\"Is that it?\" you may ask. Yes; as we said, streams are amazing also because of their interface and composability, thus allowing clean, elegant, and concise code. We will see this in a while in more detail, but for now the important thing to realize is that the program will run smoothly against files of any size, ideally with constant memory utilization. Try it yourself (but consider that compressing a big file might take a while)."}]},{"block_type":"element","block":"k5zy5b2n","search_text":"Time efficiency","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Time efficiency"}]},{"block_type":"element","block":"k5zy5b2o","search_text":"Let's now consider the case of an application that compresses a file and uploads it to a remote HTTP server, which in turn decompresses it and saves it on the filesystem. If our client was implemented using a buffered API, the upload would start only when the entire file has been read and compressed. On the other hand, the decompression will start on the server only when all the data has been received. A better solution to achieve the same result involves the use of streams. On the client machine, streams allows you to compress and send the data chunks as soon as they are read from the filesystem, whereas on the server, it allows you to decompress every chunk as soon as it is received from the remote peer. Let's demonstrate this by building the application that we mentioned earlier, starting from the server side.","text_count":824,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now consider the case of an application that compresses a file and uploads it to a remote HTTP server, which in turn decompresses it and saves it on the filesystem. If our client was implemented using a buffered API, the upload would start only when the entire file has been read and compressed. On the other hand, the decompression will start on the server only when all the data has been received. A better solution to achieve the same result involves the use of streams. On the client machine, streams allows you to compress and send the data chunks as soon as they are read from the filesystem, whereas on the server, it allows you to decompress every chunk as soon as it is received from the remote peer. Let's demonstrate this by building the application that we mentioned earlier, starting from the server side."}]},{"block_type":"element","block":"k5zy5b2p","search_text":"Let's create a module named gzipReceive.js containing the following code:","text_count":73,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's create a module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"gzipReceive.js"}]},{"block_type":"text","content":"containing the following code:"}]},{"block_type":"element","block":"k5zy5b2q","search_text":"const http = require('http'); const fs = require('fs'); const zlib = require('zlib'); const server = http.createServer((req, res) => { const filename = req.headers.filename; console.log('File request received: ' + filename); req .pipe(zlib.createGunzip()) .pipe(fs.createWriteStream(filename)) .on('finish', () => { res.writeHead(201, {'Content-Type': 'text/plain'}); res.end('That's it\\n'); console.log(`File saved: ${filename}`); }); }); server.listen(3000, () => console.log('Listening')); ","text_count":493,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http');\nconst fs = require('fs');\nconst zlib = require('zlib');\n\nconst server = http.createServer((req, res) =&gt; {\n  const filename = req.headers.filename;\n  console.log('File request received: ' + filename);\n   \n\n  req\n    .pipe(zlib.createGunzip())\n    .pipe(fs.createWriteStream(filename))\n    .on('finish', () =&gt; {\n       res.writeHead(201, {'Content-Type': 'text/plain'});\n       res.end('That's it\\n');\n       console.log(`File saved: ${filename}`);\n    });\n});\n\nserver.listen(3000, () =&gt; console.log('Listening'));"}]}]},{"block_type":"element","block":"k5zy5b2r","search_text":"The server receives the data chunks from the network, decompresses them, and saves them as soon as they are received, thanks to Node.js streams.","text_count":144,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The server receives the data chunks from the network, decompresses them, and saves them as soon as they are received, thanks to Node.js streams."}]},{"block_type":"element","block":"k5zy5b2s","search_text":"The client side of our application will go into a module named gzipSend.js , and it looks like the following:","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The client side of our application will go into a module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"gzipSend.js"}]},{"block_type":"text","content":", and it looks like the following:"}]},{"block_type":"element","block":"k5zy5b2t","search_text":"const fs = require('fs'); const zlib = require('zlib'); const http = require('http'); const path = require('path'); const file = process.argv[2]; const server = process.argv[3]; const options = { hostname: server, port: 3000, path: '/', method: 'PUT', headers: { filename: path.basename(file), 'Content-Type': 'application/octet-stream', 'Content-Encoding': 'gzip' } }; const req = http.request(options, res => { console.log('Server response: ' + res.statusCode); }); fs.createReadStream(file) .pipe(zlib.createGzip()) .pipe(req) .on('finish', () => { console.log('File successfully sent'); }); ","text_count":595,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs');\nconst zlib = require('zlib');\nconst http = require('http');\nconst path = require('path');\nconst file = process.argv[2];\nconst server = process.argv[3];\n\nconst options = {\n  hostname: server,\n  port: 3000,\n  path: '/',\n  method: 'PUT',\n  headers: {\n    filename: path.basename(file),\n    'Content-Type': 'application/octet-stream',\n    'Content-Encoding': 'gzip'\n  }\n};\n\nconst req = http.request(options, res =&gt; {\n  console.log('Server response: ' + res.statusCode);\n});\n\nfs.createReadStream(file)\n  .pipe(zlib.createGzip())\n  .pipe(req)\n  .on('finish', () =&gt; {\n    console.log('File successfully sent');\n});"}]}]},{"block_type":"element","block":"k5zy5b2u","search_text":"In the preceding code, we are again using streams to read the data from the file, and then compressing and sending each chunk as soon as it is read from the filesystem.","text_count":168,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we are again using streams to read the data from the file, and then compressing and sending each chunk as soon as it is read from the filesystem."}]},{"block_type":"element","block":"k5zy5b2v","search_text":"Now, to try out the application, let's first start the server using the following command:","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, to try out the application, let's first start the server using the following command:"}]},{"block_type":"element","block":"k5zy5b2w","search_text":"node gzipReceive ","text_count":17,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node gzipReceive"}]}]},{"block_type":"element","block":"k5zy5b2x","search_text":"Then, we can launch the client by specifying the file to send and the address of the server (for example, localhost ):","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can launch the client by specifying the file to send and the address of the server (for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"localhost"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5b2y","search_text":"node gzipSend <path to file> localhost ","text_count":39,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node gzipSend &lt;path to file&gt; localhost"}]}]},{"block_type":"element","block":"k5zy5b2z","search_text":"If we choose a file big enough, we will see more easily how the data flows from the client to the server, but why exactly is this paradigm, where we have flowing data, more efficient compared to using a buffered API? The following diagram should give us a hint:","text_count":261,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we choose a file big enough, we will see more easily how the data flows from the client to the server, but why exactly is this paradigm, where we have flowing data, more efficient compared to using a buffered API? The following diagram should give us a hint:"}]},{"block_type":"element","block":"k5zy5b30","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000010.jpg","alt":"Time efficiency","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5b31","search_text":"When a file is processed it goes through a set of sequential stages:","text_count":68,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When a file is processed it goes through a set of sequential stages:"}]},{"block_type":"element","block":"k5zy5b32","search_text":"[Client] Read from the filesystem. [Client] Compress the data. [Client] Send it to the server. [Server] Receive from the client. [Server] Decompress the data. [Server] Write the data to disk. ","text_count":192,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"[Client] Read from the filesystem."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"[Client] Compress the data."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"[Client] Send it to the server."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"[Server] Receive from the client."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"[Server] Decompress the data."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"[Server] Write the data to disk."}]}]},{"block_type":"element","block":"k5zy5b33","search_text":"To complete the processing, we have to go through each stage like in an assembly line, in sequence, until the end. In the preceding figure, we can see that, using a buffered API, the process is entirely sequential. To compress the data, we first have to wait for the entire file to be read, then, to send the data, we have to wait for the entire file to be both read and compressed, and so on. When instead we are using streams, the assembly line is kicked off as soon as we receive the first chunk of data, without waiting for the entire file to be read. But more amazingly, when the next chunk of data is available, there is no need to wait for the previous set of tasks to be completed; instead, another assembly line is launched in parallel. This works perfectly because each task that we execute is asynchronous, so it can be parallelized by Node.js; the only constraint is that the order in which the chunks arrive in each stage must be preserved (and Node.js streams take care of this for us).","text_count":1000,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To complete the processing, we have to go through each stage like in an assembly line, in sequence, until the end. In the preceding figure, we can see that, using a buffered API, the process is entirely sequential. To compress the data, we first have to wait for the entire file to be read, then, to send the data, we have to wait for the entire file to be both read and compressed, and so on. When instead we are using streams, the assembly line is kicked off as soon as we receive the first chunk of data, without waiting for the entire file to be read. But more amazingly, when the next chunk of data is available, there is no need to wait for the previous set of tasks to be completed; instead, another assembly line is launched in parallel. This works perfectly because each task that we execute is asynchronous, so it can be parallelized by Node.js; the only constraint is that the order in which the chunks arrive in each stage must be preserved (and Node.js streams take care of this for us)."}]},{"block_type":"element","block":"k5zy5b34","search_text":"As we can see from the previous figure, the result of using streams is that the entire process takes less time, because we waste no time waiting for all the data to be read and processed all at once.","text_count":199,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see from the previous figure, the result of using streams is that the entire process takes less time, because we waste no time waiting for all the data to be read and processed all at once."}]},{"block_type":"element","block":"k5zy5b35","search_text":"Composability","text_count":13,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Composability"}]},{"block_type":"element","block":"k5zy5b36","search_text":"The code we have seen so far has already given us an overview of how streams can be composed thanks to the pipe() method, which allows us to connect the different processing units, each being responsible for one single functionality in perfect Node.js style. This is possible because streams have a uniform interface, and they can understand each other in terms of API. The only prerequisite is that the next stream in the pipeline has to support the data type produced by the previous stream, which can be either binary, text, or even objects, as we will see later in the chapter.","text_count":581,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code we have seen so far has already given us an overview of how streams can be composed thanks to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pipe()"}]},{"block_type":"text","content":"method, which allows us to connect the different processing units, each being responsible for one single functionality in perfect Node.js style. This is possible because streams have a uniform interface, and they can understand each other in terms of API. The only prerequisite is that the next stream in the pipeline has to support the data type produced by the previous stream, which can be either binary, text, or even objects, as we will see later in the chapter."}]},{"block_type":"element","block":"k5zy5b37","search_text":"To take a look at another demonstration of the power of this property, we can try to add an encryption layer to the gzipReceive / gzipSend application that we built previously.","text_count":176,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To take a look at another demonstration of the power of this property, we can try to add an encryption layer to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"gzipReceive"}]},{"block_type":"text","content":"/"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"gzipSend"}]},{"block_type":"text","content":"application that we built previously."}]},{"block_type":"element","block":"k5zy5b38","search_text":"To do this, we only need to update the client by adding another stream to the pipeline; to be precise, the stream returned by crypto.createChipher() . The resulting code should be as follows:","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To do this, we only need to update the client by adding another stream to the pipeline; to be precise, the stream returned by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"crypto.createChipher()"}]},{"block_type":"text","content":". The resulting code should be as follows:"}]},{"block_type":"element","block":"k5zy5b39","search_text":"const crypto = require('crypto'); // ... fs.createReadStream(file) .pipe(zlib.createGzip()) .pipe(crypto.createCipher('aes192', 'a_shared_secret')) .pipe(req) .on('finish', () => console.log('File succesfully sent')); ","text_count":218,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const crypto = require('crypto'); \n// ... \nfs.createReadStream(file) \n  .pipe(zlib.createGzip()) \n  .pipe(crypto.createCipher('aes192', 'a_shared_secret')) \n  .pipe(req) \n  .on('finish', () =&gt; console.log('File succesfully sent'));"}]}]},{"block_type":"element","block":"k5zy5b3a","search_text":"In a similar way, we can update the server so that the data is decrypted before being decompressed:","text_count":99,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a similar way, we can update the server so that the data is decrypted before being decompressed:"}]},{"block_type":"element","block":"k5zy5b3b","search_text":"const crypto = require('crypto'); // ... const server = http.createServer((req, res) => { // ... req .pipe(crypto.createDecipher('aes192', 'a_shared_secret')) .pipe(zlib.createGunzip()) .pipe(fs.createWriteStream(filename)) .on('finish', () => { /* ... */ }); }); ","text_count":264,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const crypto = require('crypto'); \n// ... \nconst server = http.createServer((req, res) =&gt; { \n  // ... \n  req \n    .pipe(crypto.createDecipher('aes192', 'a_shared_secret')) \n    .pipe(zlib.createGunzip()) \n    .pipe(fs.createWriteStream(filename)) \n    .on('finish', () =&gt; { /* ... */ }); \n});"}]}]},{"block_type":"element","block":"k5zy5b3c","search_text":"With very little effort (just a few lines of code), we added an encryption layer to our application; we simply had to reuse an already available transform stream by including it in the pipeline that we already had. In a similar way, we can add and combine other streams, as if we were playing with Lego bricks.","text_count":310,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With very little effort (just a few lines of code), we added an encryption layer to our application; we simply had to reuse an already available transform stream by including it in the pipeline that we already had. In a similar way, we can add and combine other streams, as if we were playing with Lego bricks."}]},{"block_type":"element","block":"k5zy5b3d","search_text":"Clearly, the main advantage of this approach is reusability, but as we can see from the code we presented so far, streams also enable cleaner and more modular code. For these reasons, streams are often used not just to deal with pure I/O, but also as a means to simplify and modularize the code.","text_count":295,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Clearly, the main advantage of this approach is reusability, but as we can see from the code we presented so far, streams also enable cleaner and more modular code. For these reasons, streams are often used not just to deal with pure I/O, but also as a means to simplify and modularize the code."}]},{"block_type":"element","block":"k5zy5b3e","search_text":"Getting started with streams","text_count":28,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Getting started with streams"}]},{"block_type":"element","block":"k5zy5b3f","search_text":"In the previous section, we learned why streams are so powerful, but also that they are everywhere in Node.js, starting from its core modules. For example, we have seen that the fs module has createReadStream() for reading from a file and createWriteStream() for writing to a file, the HTTP request and response objects are essentially streams, and the zlib module allows us to compress and decompress data using a streaming interface.","text_count":435,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous section, we learned why streams are so powerful, but also that they are everywhere in Node.js, starting from its core modules. For example, we have seen that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"module has"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"createReadStream()"}]},{"block_type":"text","content":"for reading from a file and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"createWriteStream()"}]},{"block_type":"text","content":"for writing to a file, the HTTP"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"response"}]},{"block_type":"text","content":"objects are essentially streams, and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"zlib"}]},{"block_type":"text","content":"module allows us to compress and decompress data using a streaming interface."}]},{"block_type":"element","block":"k5zy5b3g","search_text":"Now that we know why streams are so important, let's take a step back and start to explore them in more detail.","text_count":111,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we know why streams are so important, let's take a step back and start to explore them in more detail."}]},{"block_type":"element","block":"k5zy5b3h","search_text":"Anatomy of streams","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Anatomy of streams"}]},{"block_type":"element","block":"k5zy5b3i","search_text":"Every stream in Node.js is an implementation of one of the four base abstract classes available in the stream core module:","text_count":122,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Every stream in Node.js is an implementation of one of the four base abstract classes available in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream"}]},{"block_type":"text","content":"core module:"}]},{"block_type":"element","block":"k5zy5b3j","search_text":"stream.Readable stream.Writable stream.Duplex stream.Transform ","text_count":63,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Readable"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Writable"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Duplex"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Transform"}]}]}]},{"block_type":"element","block":"k5zy5b3k","search_text":"Each stream class is also an instance of EventEmitter . Streams, in fact, can produce several types of event, such as end , when a Readable stream has finished reading, or error , when something goes wrong.","text_count":206,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Each"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream"}]},{"block_type":"text","content":"class is also an instance of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":". Streams, in fact, can produce several types of event, such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end"}]},{"block_type":"text","content":", when a Readable stream has finished reading, or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":", when something goes wrong."}]},{"block_type":"element","block":"k5zy5b3l","search_text":"Note Please note that, for brevity, in the examples presented in this chapter, we will often omit proper error management. However, in production applications it is always advised to register an error event listener for all your streams. ","text_count":238,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Please note that, for brevity, in the examples presented in this chapter, we will often omit proper error management. However, in production applications it is always advised to register an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":"event listener for all your streams."}]}]},{"block_type":"element","block":"k5zy5b3m","search_text":"One of the reasons why streams are so flexible is the fact that they can not only handle binary data, but almost any JavaScript value; in fact, they can support two operating modes:","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the reasons why streams are so flexible is the fact that they can not only handle binary data, but almost any JavaScript value; in fact, they can support two operating modes:"}]},{"block_type":"element","block":"k5zy5b3n","search_text":"Binary mode : This mode is where data is streamed in the form of chunks, such as buffers or strings Object mode : This mode is where the streaming data is treated as a sequence of discrete objects (allowing us to use almost any JavaScript value) ","text_count":246,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Binary mode"}]},{"block_type":"text","content":": This mode is where data is streamed in the form of chunks, such as buffers or strings"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Object mode"}]},{"block_type":"text","content":": This mode is where the streaming data is treated as a sequence of discrete objects (allowing us to use almost any JavaScript value)"}]}]},{"block_type":"element","block":"k5zy5b3o","search_text":"These two operating modes allow us to use streams not only for I/O, but also as a tool to elegantly compose processing units in a functional fashion, as we will see later in the chapter.","text_count":186,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"These two operating modes allow us to use streams not only for I/O, but also as a tool to elegantly compose processing units in a functional fashion, as we will see later in the chapter."}]},{"block_type":"element","block":"k5zy5b3p","search_text":"Note In this chapter, we will mainly use the Node.js stream interface, also known as Version 3 , which was introduced in Node.js 0.11. For further details about the differences with the old interfaces, please refer to this excellent blog post by StrongLoop at https://strongloop.com/strongblog/whats-new-io-js-beta-streams3/ . ","text_count":327,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will mainly use the Node.js stream interface, also known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Version 3"}]},{"block_type":"text","content":", which was introduced in Node.js 0.11. For further details about the differences with the old interfaces, please refer to this excellent blog post by StrongLoop at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://strongloop.com/strongblog/whats-new-io-js-beta-streams3/"},"children":[{"block_type":"text","content":"https://strongloop.com/strongblog/whats-new-io-js-beta-streams3/"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5b3q","search_text":"Readable streams","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Readable streams"}]},{"block_type":"element","block":"k5zy5b3r","search_text":"A Readable stream represents a source of data; in Node.js, it's implemented using the Readable abstract class that is available in the stream module.","text_count":149,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A Readable stream represents a source of data; in Node.js, it's implemented using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Readable"}]},{"block_type":"text","content":"abstract class that is available in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream"}]},{"block_type":"text","content":"module."}]},{"block_type":"element","block":"k5zy5b3s","search_text":"Reading from a stream","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Reading from a stream"}]},{"block_type":"element","block":"k5zy5b3t","search_text":"There are two ways to receive the data from a Readable stream: non-flowing and flowing . Let's analyze these modes in more detail.","text_count":130,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are two ways to receive the data from a Readable stream:"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"non-flowing"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"flowing"}]},{"block_type":"text","content":". Let's analyze these modes in more detail."}]},{"block_type":"element","block":"k5zy5b3u","search_text":"The non-flowing mode","text_count":20,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The non-flowing mode"}]},{"block_type":"element","block":"k5zy5b3v","search_text":"The default pattern for reading from a Readable stream consists of attaching a listener for the readable event that signals the availability of new data to read. Then, in a loop, we read all the data until the internal buffer is emptied. This can be done using the read() method, which synchronously reads from the internal buffer and returns a Buffer or String object representing the chunk of data. The read() method has the following signature:","text_count":447,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The default pattern for reading from a Readable stream consists of attaching a listener for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readable"}]},{"block_type":"text","content":"event that signals the availability of new data to read. Then, in a loop, we read all the data until the internal buffer is emptied. This can be done using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read()"}]},{"block_type":"text","content":"method, which synchronously reads from the internal buffer and returns a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Buffer"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"String"}]},{"block_type":"text","content":"object representing the chunk of data. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read()"}]},{"block_type":"text","content":"method has the following signature:"}]},{"block_type":"element","block":"k5zy5b3w","search_text":"readable.read([size]) ","text_count":22,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"readable.read([size])"}]}]},{"block_type":"element","block":"k5zy5b3x","search_text":"Using this approach, the data is explicitly pulled from the stream on demand.","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using this approach, the data is explicitly pulled from the stream on demand."}]},{"block_type":"element","block":"k5zy5b3y","search_text":"To show how this works, let's create a new module named readStdin.js , which implements a simple program that reads from the standard input (a Readable stream) and echoes everything back to the standard output:","text_count":210,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To show how this works, let's create a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readStdin.js"}]},{"block_type":"text","content":", which implements a simple program that reads from the standard input (a Readable stream) and echoes everything back to the standard output:"}]},{"block_type":"element","block":"k5zy5b3z","search_text":"process.stdin .on('readable', () => { let chunk; console.log('New data available'); while((chunk = process.stdin.read()) !== null) { console.log( `Chunk read: (${chunk.length}) \"${chunk.toString()}\"` ); } }) .on('end', () => process.stdout.write('End of stream')); ","text_count":265,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"process.stdin \n  .on('readable', () =&gt; { \n    let chunk; \n    console.log('New data available'); \n    while((chunk = process.stdin.read()) !== null) { \n      console.log(\n        `Chunk read: (${chunk.length}) \"${chunk.toString()}\"` \n      ); \n    } \n  }) \n  .on('end', () =&gt; process.stdout.write('End of stream'));"}]}]},{"block_type":"element","block":"k5zy5b40","search_text":"The read() method is a synchronous operation that pulls a data chunk from the internal buffers of the Readable stream. The returned chunk is, by default, a Buffer object if the stream is working in binary mode.","text_count":210,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read()"}]},{"block_type":"text","content":"method is a synchronous operation that pulls a data chunk from the internal buffers of the Readable stream. The returned chunk is, by default, a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Buffer"}]},{"block_type":"text","content":"object if the stream is working in binary mode."}]},{"block_type":"element","block":"k5zy5b41","search_text":"Note In a Readable stream working in binary mode, we can read strings instead of buffers by calling setEncoding(encoding) on the stream, and provide a valid encoding format (for example, utf8 ). ","text_count":195,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a Readable stream working in binary mode, we can read strings instead of buffers by calling"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setEncoding(encoding)"}]},{"block_type":"text","content":"on the stream, and provide a valid encoding format (for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"utf8"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5b42","search_text":"The data is read exclusively from within the readable listener, which is invoked as soon as new data is available. The read() method returns null when there is no more data available in the internal buffers; in such a case, we have to wait for another readable event to be fired, telling us that we can read again or wait for the end event that signals the end of the stream. When a stream is working in binary mode, we can also specify that we are interested in reading a specific amount of data by passing a size value to the read() method. This is particularly useful when implementing network protocols or when parsing specific data formats.","text_count":645,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The data is read exclusively from within the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readable"}]},{"block_type":"text","content":"listener, which is invoked as soon as new data is available. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read()"}]},{"block_type":"text","content":"method returns"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"null"}]},{"block_type":"text","content":"when there is no more data available in the internal buffers; in such a case, we have to wait for another"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readable"}]},{"block_type":"text","content":"event to be fired, telling us that we can read again or wait for the end event that signals the end of the stream. When a stream is working in binary mode, we can also specify that we are interested in reading a specific amount of data by passing a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"size"}]},{"block_type":"text","content":"value to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read()"}]},{"block_type":"text","content":"method. This is particularly useful when implementing network protocols or when parsing specific data formats."}]},{"block_type":"element","block":"k5zy5b43","search_text":"Now, we are ready to run the readStdin module and experiment with it. Let's type some characters in the console and then press Enter to see the data echoed back into the standard output. To terminate the stream and hence generate a graceful end event, we need to insert an EOF (end-of-file) character (using Ctrl + Z on Windows or Ctrl + D on Linux).","text_count":350,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, we are ready to run the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readStdin"}]},{"block_type":"text","content":"module and experiment with it. Let's type some characters in the console and then press"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Enter"}]},{"block_type":"text","content":"to see the data echoed back into the standard output. To terminate the stream and hence generate a graceful end event, we need to insert an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EOF"}]},{"block_type":"text","content":"(end-of-file) character (using"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Ctrl"}]},{"block_type":"text","content":"+"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Z"}]},{"block_type":"text","content":"on Windows or"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Ctrl"}]},{"block_type":"text","content":"+"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"D"}]},{"block_type":"text","content":"on Linux)."}]},{"block_type":"element","block":"k5zy5b44","search_text":"We can also try to connect our program with other processes; this is possible using the pipe operator ( | ), which redirects the standard output of a program to the standard input of another. For example, we can run a command such as the following:","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can also try to connect our program with other processes; this is possible using the pipe operator ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"|"}]},{"block_type":"text","content":"), which redirects the standard output of a program to the standard input of another. For example, we can run a command such as the following:"}]},{"block_type":"element","block":"k5zy5b45","search_text":"cat <path to a file> | node readStdin ","text_count":38,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"cat &lt;path to a file&gt; | node readStdin"}]}]},{"block_type":"element","block":"k5zy5b46","search_text":"This is an amazing demonstration of how the streaming paradigm is a universal interface, which enables our programs to communicate, regardless of the language they are written in.","text_count":179,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is an amazing demonstration of how the streaming paradigm is a universal interface, which enables our programs to communicate, regardless of the language they are written in."}]},{"block_type":"element","block":"k5zy5b47","search_text":"Flowing mode","text_count":12,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Flowing mode"}]},{"block_type":"element","block":"k5zy5b48","search_text":"Another way to read from a stream is by attaching a listener to the data event; this will switch the stream into using flowing mode , where the data is not pulled using read() , but instead it's pushed to the data listener as soon as it arrives. For example, the readStdin application that we created earlier will look like this using flowing mode:","text_count":348,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another way to read from a stream is by attaching a listener to the data event; this will switch the stream into using"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"flowing mode"}]},{"block_type":"text","content":", where the data is not pulled using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read()"}]},{"block_type":"text","content":", but instead it's pushed to the data listener as soon as it arrives. For example, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readStdin"}]},{"block_type":"text","content":"application that we created earlier will look like this using flowing mode:"}]},{"block_type":"element","block":"k5zy5b49","search_text":"process.stdin .on('data', chunk => { console.log('New data available'); console.log( `Chunk read: (${chunk.length}) \"${chunk.toString()}\"` ); }) .on('end', () => process.stdout.write('End of stream')); ","text_count":202,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"process.stdin \n  .on('data', chunk =&gt; {  \n    console.log('New data available');  \n    console.log( \n      `Chunk read: (${chunk.length}) \"${chunk.toString()}\"`  \n    );  \n  })  \n  .on('end', () =&gt; process.stdout.write('End of stream'));"}]}]},{"block_type":"element","block":"k5zy5b4a","search_text":"Flowing mode is an inheritance of the old version of the stream interface (also known as Streams1 ), and offers less flexibility to control the flow of data. With the introduction of the Streams2 interface, flowing mode is not the default working mode; to enable it, it's necessary to attach a listener to the data event or explicitly invoke the resume() method. To temporarily stop the stream from emitting data events, we can then invoke the pause() method, causing any incoming data to be cached in the internal buffer.","text_count":522,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Flowing mode is an inheritance of the old version of the stream interface (also known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Streams1"}]},{"block_type":"text","content":"), and offers less flexibility to control the flow of data. With the introduction of the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Streams2"}]},{"block_type":"text","content":"interface, flowing mode is not the default working mode; to enable it, it's necessary to attach a listener to the data event or explicitly invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"resume()"}]},{"block_type":"text","content":"method. To temporarily stop the stream from emitting data events, we can then invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pause()"}]},{"block_type":"text","content":"method, causing any incoming data to be cached in the internal buffer."}]},{"block_type":"element","block":"k5zy5b4b","search_text":"Note Calling pause() does not cause the stream to switch back to non-flowing mode. ","text_count":83,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Calling"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pause()"}]},{"block_type":"text","content":"does not cause the stream to switch back to non-flowing mode."}]}]},{"block_type":"element","block":"k5zy5b4c","search_text":"Implementing Readable streams","text_count":29,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Implementing Readable streams"}]},{"block_type":"element","block":"k5zy5b4d","search_text":"Now that we know how to read from a stream, the next step is to learn how to implement a new Readable stream. To do this, it's necessary to create a new class by inheriting the prototype of stream.Readable . The concrete stream must provide an implementation of the _read() method, which has the following signature:","text_count":316,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we know how to read from a stream, the next step is to learn how to implement a new Readable stream. To do this, it's necessary to create a new class by inheriting the prototype of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Readable"}]},{"block_type":"text","content":". The concrete stream must provide an implementation of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_read()"}]},{"block_type":"text","content":"method, which has the following signature:"}]},{"block_type":"element","block":"k5zy5b4e","search_text":"readable._read(size) ","text_count":21,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"readable._read(size)"}]}]},{"block_type":"element","block":"k5zy5b4f","search_text":"The internals of the Readable class will call the _read() method, which in turn will start to fill the internal buffer using push() :","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The internals of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Readable"}]},{"block_type":"text","content":"class will call the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_read()"}]},{"block_type":"text","content":"method, which in turn will start to fill the internal buffer using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"push()"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5b4g","search_text":"readable.push(chunk) ","text_count":21,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"readable.push(chunk)"}]}]},{"block_type":"element","block":"k5zy5b4h","search_text":"Note Please note that read() is a method called by the stream consumers, while _read() is a method to be implemented by a stream subclass and should never be called directly. The underscore usually indicates that the method is not public and should not be called directly. ","text_count":273,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Please note that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read()"}]},{"block_type":"text","content":"is a method called by the stream consumers, while"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_read()"}]},{"block_type":"text","content":"is a method to be implemented by a stream subclass and should never be called directly. The underscore usually indicates that the method is not public and should not be called directly."}]}]},{"block_type":"element","block":"k5zy5b4i","search_text":"To demonstrate how to implement new Readable streams, we can try to implement a stream that generates random strings. Let's create a new module called randomStream.js that will contain the code of our string generator:","text_count":218,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate how to implement new Readable streams, we can try to implement a stream that generates random strings. Let's create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"randomStream.js"}]},{"block_type":"text","content":"that will contain the code of our string generator:"}]},{"block_type":"element","block":"k5zy5b4j","search_text":"const stream = require('stream'); const Chance = require('chance'); const chance = new Chance(); class RandomStream extends stream.Readable { constructor(options) { super(options); } _read(size) { const chunk = chance.string(); //[1] console.log(`Pushing chunk of size: ${chunk.length}`); this.push(chunk, 'utf8'); //[2] if(chance.bool({likelihood: 5})) { //[3] this.push(null); } } } module.exports = RandomStream; ","text_count":416,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const stream = require('stream'); \nconst Chance = require('chance'); \n \nconst chance = new Chance(); \n \nclass RandomStream extends stream.Readable { \n  constructor(options) { \n    super(options); \n  } \n \n  _read(size) { \n    const chunk = chance.string();                        //[1] \n    console.log(`Pushing chunk of size: ${chunk.length}`); \n    this.push(chunk, 'utf8');                             //[2] \n    if(chance.bool({likelihood: 5})) {                    //[3] \n      this.push(null); \n    } \n  } \n} \n \nmodule.exports = RandomStream;"}]}]},{"block_type":"element","block":"k5zy5b4k","search_text":"At the top of the file, we will load our dependencies. There is nothing special here, except that we are loading a npm module called chance ( https://npmjs.org/package/chance ), which is a library for generating all sorts of random values, from numbers to strings to entire sentences.","text_count":284,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At the top of the file, we will load our dependencies. There is nothing special here, except that we are loading a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"npm"}]},{"block_type":"text","content":"module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chance"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/chance"},"children":[{"block_type":"text","content":"https://npmjs.org/package/chance"}]},{"block_type":"text","content":"), which is a library for generating all sorts of random values, from numbers to strings to entire sentences."}]},{"block_type":"element","block":"k5zy5b4l","search_text":"The next step is to create a new class called RandomStream and that specifies stream.Readable as its parent. In the preceding code, we call the constructor of the parent class to initialize its internal state, and forward the options argument received as input. The possible parameters passed through the options object include the following:","text_count":342,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next step is to create a new class called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"RandomStream"}]},{"block_type":"text","content":"and that specifies"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Readable"}]},{"block_type":"text","content":"as its parent. In the preceding code, we call the constructor of the parent class to initialize its internal state, and forward the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"options"}]},{"block_type":"text","content":"argument received as input. The possible parameters passed through the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"options"}]},{"block_type":"text","content":"object include the following:"}]},{"block_type":"element","block":"k5zy5b4m","search_text":"The encoding argument that is used to convert Buffers to Strings (defaults to null ) A flag to enable object mode ( objectMode defaults to false ) The upper limit of the data stored in the internal buffer, after which no more reading from the source should be done ( highWaterMark defaults to 16KB ) ","text_count":300,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"encoding"}]},{"block_type":"text","content":"argument that is used to convert"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Buffers"}]},{"block_type":"text","content":"to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Strings"}]},{"block_type":"text","content":"(defaults to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"null"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A flag to enable object mode ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"objectMode"}]},{"block_type":"text","content":"defaults to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"false"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The upper limit of the data stored in the internal buffer, after which no more reading from the source should be done ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"highWaterMark"}]},{"block_type":"text","content":"defaults to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"16KB"}]},{"block_type":"text","content":")"}]}]},{"block_type":"element","block":"k5zy5b4n","search_text":"Okay, now let's explain the _read() method:","text_count":43,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Okay, now let's explain the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_read()"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k5zy5b4o","search_text":"The method generates a random string using chance . It pushes the string into the internal reading buffer. Note that since we are pushing String , we also specify the encoding, utf8 (this is not necessary if the chunk is simply a binary Buffer ). It terminates the stream randomly, with a likelihood of 5 percent, by pushing null into the internal buffer to indicate an EOF situation or, in other words, the end of the stream. ","text_count":427,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The method generates a random string using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chance"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"It pushes the string into the internal reading buffer. Note that since we are pushing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"String"}]},{"block_type":"text","content":", we also specify the encoding,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"utf8"}]},{"block_type":"text","content":"(this is not necessary if the chunk is simply a binary"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Buffer"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"It terminates the stream randomly, with a likelihood of 5 percent, by pushing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"null"}]},{"block_type":"text","content":"into the internal buffer to indicate an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EOF"}]},{"block_type":"text","content":"situation or, in other words, the end of the stream."}]}]},{"block_type":"element","block":"k5zy5b4p","search_text":"We can also see that the size argument given in input to the _read() function is ignored, as it is an advisory parameter. We can simply just push all the available data, but if there are multiple pushes inside the same invocation, then we should check whether push() returns false , as this would mean that the internal buffer has reached the highWaterMark limit and we should stop adding more data to it.","text_count":405,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can also see that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"size"}]},{"block_type":"text","content":"argument given in input to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_read()"}]},{"block_type":"text","content":"function is ignored, as it is an advisory parameter. We can simply just push all the available data, but if there are multiple pushes inside the same invocation, then we should check whether"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"push()"}]},{"block_type":"text","content":"returns"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"false"}]},{"block_type":"text","content":", as this would mean that the internal buffer has reached the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"highWaterMark"}]},{"block_type":"text","content":"limit and we should stop adding more data to it."}]},{"block_type":"element","block":"k5zy5b4q","search_text":"That's it for RandomStream ; we are now ready to use it. Let's create a new module named generateRandom.js in which we instantiate a new RandomStream object and pull some data from it:","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's it for"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"RandomStream"}]},{"block_type":"text","content":"; we are now ready to use it. Let's create a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"generateRandom.js"}]},{"block_type":"text","content":"in which we instantiate a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"RandomStream"}]},{"block_type":"text","content":"object and pull some data from it:"}]},{"block_type":"element","block":"k5zy5b4r","search_text":"const RandomStream = require('./randomStream'); const randomStream = new RandomStream(); randomStream.on('readable', () => { let chunk; while((chunk = randomStream.read()) !== null) { console.log(`Chunk received: ${chunk.toString()}`); } }); ","text_count":242,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const RandomStream = require('./randomStream'); \nconst randomStream = new RandomStream(); \n \nrandomStream.on('readable', () =&gt; { \n  let chunk; \n  while((chunk = randomStream.read()) !== null) { \n    console.log(`Chunk received: ${chunk.toString()}`); \n  } \n});"}]}]},{"block_type":"element","block":"k5zy5b4s","search_text":"Now, everything is ready for us to try our new custom stream. Simply execute the generateRandom module as usual and watch a random set of strings flowing on the screen.","text_count":168,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, everything is ready for us to try our new custom stream. Simply execute the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"generateRandom"}]},{"block_type":"text","content":"module as usual and watch a random set of strings flowing on the screen."}]},{"block_type":"element","block":"k5zy5b4t","search_text":"Writable streams","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Writable streams"}]},{"block_type":"element","block":"k5zy5b4u","search_text":"A Writable stream represents a data destination; in Node.js, it's implemented using the Writable abstract class, which is available in the stream module.","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A Writable stream represents a data destination; in Node.js, it's implemented using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Writable"}]},{"block_type":"text","content":"abstract class, which is available in the stream module."}]},{"block_type":"element","block":"k5zy5b4v","search_text":"Writing to a stream","text_count":19,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Writing to a stream"}]},{"block_type":"element","block":"k5zy5b4w","search_text":"Pushing some data down a Writable stream is a straightforward business; all we need to do is to use the write() method, which has the following signature:","text_count":154,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Pushing some data down a Writable stream is a straightforward business; all we need to do is to use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"write()"}]},{"block_type":"text","content":"method, which has the following signature:"}]},{"block_type":"element","block":"k5zy5b4x","search_text":"writable.write(chunk, [encoding], [callback]) ","text_count":46,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"writable.write(chunk, [encoding], [callback])"}]}]},{"block_type":"element","block":"k5zy5b4y","search_text":"The encoding argument is optional and can be specified if chunk is String (it defaults to utf8 , and is ignored if chunk is Buffer ); the callback function instead is called when the chunk is flushed into the underlying resource and is optional as well.","text_count":253,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"encoding"}]},{"block_type":"text","content":"argument is optional and can be specified if"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chunk"}]},{"block_type":"text","content":"is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"String"}]},{"block_type":"text","content":"(it defaults to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"utf8"}]},{"block_type":"text","content":", and is ignored if"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chunk"}]},{"block_type":"text","content":"is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Buffer"}]},{"block_type":"text","content":"); the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function instead is called when the chunk is flushed into the underlying resource and is optional as well."}]},{"block_type":"element","block":"k5zy5b4z","search_text":"To signal that no more data will be written to the stream, we have to use the end() method:","text_count":91,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To signal that no more data will be written to the stream, we have to use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end()"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k5zy5b50","search_text":"writable.end([chunk], [encoding], [callback]) ","text_count":46,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"writable.end([chunk], [encoding], [callback])"}]}]},{"block_type":"element","block":"k5zy5b51","search_text":"We can provide a final chunk of data through the end() method; in this case, the callback function is equivalent to registering a listener to the finish event, which is fired when all the data written in the stream has been flushed into the underlying resource.","text_count":261,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can provide a final chunk of data through the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end()"}]},{"block_type":"text","content":"method; in this case, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function is equivalent to registering a listener to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"finish"}]},{"block_type":"text","content":"event, which is fired when all the data written in the stream has been flushed into the underlying resource."}]},{"block_type":"element","block":"k5zy5b52","search_text":"Now, let's show how this works by creating a small HTTP server that outputs a random sequence of strings:","text_count":105,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's show how this works by creating a small HTTP server that outputs a random sequence of strings:"}]},{"block_type":"element","block":"k5zy5b53","search_text":"const Chance = require('chance'); const chance = new Chance(); require('http').createServer((req, res) => { res.writeHead(200, {'Content-Type': 'text/plain'}); //[1] while(chance.bool({likelihood: 95})) { //[2] res.write(chance.string() + '\\n'); //[3] } res.end('\\nThe end...\\n'); //[4] res.on('finish', () => console.log('All data was sent')); //[5] }).listen(8080, () => console.log('Listening on http://localhost:8080')); ","text_count":425,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const Chance = require('chance'); \nconst chance = new Chance(); \n \nrequire('http').createServer((req, res) =&gt; { \n  res.writeHead(200, {'Content-Type': 'text/plain'});        //[1] \n  while(chance.bool({likelihood: 95})) {                     //[2] \n    res.write(chance.string() + '\\n');                       //[3] \n  } \n  res.end('\\nThe end...\\n');                                 //[4] \n  res.on('finish', () =&gt; console.log('All data was sent'));  //[5] \n}).listen(8080, () =&gt; console.log('Listening on http://localhost:8080'));"}]}]},{"block_type":"element","block":"k5zy5b54","search_text":"The HTTP server that we created writes into the res object, which is an instance of http.ServerResponse and also a Writable stream. What happens is explained as follows:","text_count":169,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The HTTP server that we created writes into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"res"}]},{"block_type":"text","content":"object, which is an instance of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http.ServerResponse"}]},{"block_type":"text","content":"and also a Writable stream. What happens is explained as follows:"}]},{"block_type":"element","block":"k5zy5b55","search_text":"We first write the head of the HTTP response. Note that writeHead() is not a part of the Writable interface; in fact, it's an auxiliary method exposed by the http.ServerResponse class. We start a loop that terminates with a likelihood of 5% (we instruct chance.bool() to return true 95% of the time). Inside the loop, we write a random string into the stream. Once we are out of the loop, we call end() on the stream, indicating that no more data will be written. Also, we provide a final string to be written into the stream before ending it. Finally, we register a listener for the finish event, which will be fired when all the data has been flushed into the underlying socket. ","text_count":681,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We first write the head of the HTTP response. Note that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writeHead()"}]},{"block_type":"text","content":"is not a part of the Writable interface; in fact, it's an auxiliary method exposed by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http.ServerResponse"}]},{"block_type":"text","content":"class."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We start a loop that terminates with a likelihood of 5% (we instruct"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chance.bool()"}]},{"block_type":"text","content":"to return"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true"}]},{"block_type":"text","content":"95% of the time)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Inside the loop, we write a random string into the stream."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Once we are out of the loop, we call"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end()"}]},{"block_type":"text","content":"on the stream, indicating that no more data will be written. Also, we provide a final string to be written into the stream before ending it."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, we register a listener for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"finish"}]},{"block_type":"text","content":"event, which will be fired when all the data has been flushed into the underlying socket."}]}]},{"block_type":"element","block":"k5zy5b56","search_text":"We can call this small module entropyServer.js , and then execute it. To test the server, we can open a browser at the address http://localhost:8080 , or use curl from the terminal as follows:","text_count":192,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can call this small module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"entropyServer.js"}]},{"block_type":"text","content":", and then execute it. To test the server, we can open a browser at the address"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:8080"}]},{"block_type":"text","content":", or use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"curl"}]},{"block_type":"text","content":"from the terminal as follows:"}]},{"block_type":"element","block":"k5zy5b57","search_text":"curl localhost:8080 ","text_count":20,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl localhost:8080"}]}]},{"block_type":"element","block":"k5zy5b58","search_text":"At this point, the server should start sending random strings to the HTTP client that you chose (please bear in mind that some browsers might buffer the data, and the streaming behavior might not be apparent).","text_count":209,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, the server should start sending random strings to the HTTP client that you chose (please bear in mind that some browsers might buffer the data, and the streaming behavior might not be apparent)."}]},{"block_type":"element","block":"k5zy5b59","search_text":"Back-pressure","text_count":13,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Back-pressure"}]},{"block_type":"element","block":"k5zy5b5a","search_text":"Similar to a liquid flowing in a real piping system, Node.js streams can also suffer from bottlenecks, where data is written faster than the stream can consume it. The mechanism to cope with this problem consists of buffering the incoming data; however, if the stream doesn't give any feedback to the writer, we might incur a situation where more and more data is accumulated into the internal buffer, leading to undesired levels of memory usage.","text_count":446,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Similar to a liquid flowing in a real piping system, Node.js streams can also suffer from bottlenecks, where data is written faster than the stream can consume it. The mechanism to cope with this problem consists of buffering the incoming data; however, if the stream doesn't give any feedback to the writer, we might incur a situation where more and more data is accumulated into the internal buffer, leading to undesired levels of memory usage."}]},{"block_type":"element","block":"k5zy5b5b","search_text":"To prevent this from happening, writable.write() will return false when the internal buffer exceeds the highWaterMark limit. Writable streams have a highWaterMark property, which is the limit of the internal buffer size beyond which the write() method starts returning false , indicating that the application should now stop writing. When the buffer is emptied, the drain event is emitted, communicating that it's safe to start writing again. This mechanism is called back-pressure .","text_count":483,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To prevent this from happening,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writable.write()"}]},{"block_type":"text","content":"will return"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"false"}]},{"block_type":"text","content":"when the internal buffer exceeds the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"highWaterMark"}]},{"block_type":"text","content":"limit. Writable streams have a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"highWaterMark"}]},{"block_type":"text","content":"property, which is the limit of the internal buffer size beyond which the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"write()"}]},{"block_type":"text","content":"method starts returning"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"false"}]},{"block_type":"text","content":", indicating that the application should now stop writing. When the buffer is emptied, the drain event is emitted, communicating that it's safe to start writing again. This mechanism is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"back-pressure"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5b5c","search_text":"Note The mechanism described in this section is similarly applicable to Readable streams. In fact, back-pressure exists in Readable streams too, and it's triggered when the push() method, which is invoked inside _read() , returns false . However, it's a problem specific to stream implementers, so we will deal with it less frequently. ","text_count":336,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The mechanism described in this section is similarly applicable to Readable streams. In fact, back-pressure exists in Readable streams too, and it's triggered when the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"push()"}]},{"block_type":"text","content":"method, which is invoked inside"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_read()"}]},{"block_type":"text","content":", returns"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"false"}]},{"block_type":"text","content":". However, it's a problem specific to stream implementers, so we will deal with it less frequently."}]}]},{"block_type":"element","block":"k5zy5b5d","search_text":"We can quickly demonstrate how to take into account the back-pressure of a Writable stream by modifying the entropyServer that we created before:","text_count":145,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can quickly demonstrate how to take into account the back-pressure of a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Writable"}]},{"block_type":"text","content":"stream by modifying the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"entropyServer"}]},{"block_type":"text","content":"that we created before:"}]},{"block_type":"element","block":"k5zy5b5e","search_text":"const Chance = require('chance'); const chance = new Chance(); require('http').createServer((req, res) => { res.writeHead(200, {'Content-Type': 'text/plain'}); function generateMore() { //[1] while(chance.bool({likelihood: 95})) { let shouldContinue = res.write( chance.string({length: (16 * 1024) - 1}) //[2] ); if(!shouldContinue) { //[3] console.log('Backpressure'); return res.once('drain', generateMore); } } res.end('\\nThe end...\\n',() => console.log('All data was sent')); } generateMore(); }).listen(8080, () => console.log('Listening on http://localhost:8080')); ","text_count":572,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const Chance = require('chance'); \nconst chance = new Chance(); \n \nrequire('http').createServer((req, res) =&gt; { \n  res.writeHead(200, {'Content-Type': 'text/plain'}); \n \n  function generateMore() {                           //[1] \n    while(chance.bool({likelihood: 95})) { \n      let shouldContinue = res.write( \n      chance.string({length: (16 * 1024) - 1})        //[2] \n    ); \n      if(!shouldContinue) {                           //[3] \n        console.log('Backpressure'); \n        return res.once('drain', generateMore); \n      } \n    } \n    res.end('\\nThe end...\\n',() =&gt; console.log('All data was sent')); \n  } \n  generateMore(); \n}).listen(8080, () =&gt; console.log('Listening on http://localhost:8080'));"}]}]},{"block_type":"element","block":"k5zy5b5f","search_text":"The most important steps of the previous code can be summarized as follows:","text_count":75,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most important steps of the previous code can be summarized as follows:"}]},{"block_type":"element","block":"k5zy5b5g","search_text":"We wrapped the main logic in a function called generateMore() . To increase the chances of receiving some back-pressure, we increased the size of the data chunk to 16 KB-1 Byte, which is very close to the default highWaterMark limit. After writing a chunk of data, we check the return value of res.write() ; if we receive false , it means that the internal buffer is full and we should stop sending more data. In this case, we exit from the function, and register another cycle of writes for when the drain event is emitted. ","text_count":525,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We wrapped the main logic in a function called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"generateMore()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"To increase the chances of receiving some back-pressure, we increased the size of the data chunk to 16 KB-1 Byte, which is very close to the default"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"highWaterMark"}]},{"block_type":"text","content":"limit."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"After writing a chunk of data, we check the return value of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"res.write()"}]},{"block_type":"text","content":"; if we receive"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"false"}]},{"block_type":"text","content":", it means that the internal buffer is full and we should stop sending more data. In this case, we exit from the function, and register another cycle of writes for when the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"drain"}]},{"block_type":"text","content":"event is emitted."}]}]},{"block_type":"element","block":"k5zy5b5h","search_text":"If we now try to run the server again, and then generate a client request with curl , there is a high probability that there will be some back-pressure, as the server produces data at a very high rate, faster than the underlying socket can handle.","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we now try to run the server again, and then generate a client request with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"curl"}]},{"block_type":"text","content":", there is a high probability that there will be some back-pressure, as the server produces data at a very high rate, faster than the underlying socket can handle."}]},{"block_type":"element","block":"k5zy5b5i","search_text":"Implementing Writable streams","text_count":29,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Implementing Writable streams"}]},{"block_type":"element","block":"k5zy5b5j","search_text":"We can implement a new Writable stream by inheriting the prototype of stream.Writable and providing an implementation for the _write() method. Let's try to do it immediately while discussing the details along the way.","text_count":217,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can implement a new Writable stream by inheriting the prototype of stream.Writable and providing an implementation for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_write()"}]},{"block_type":"text","content":"method. Let's try to do it immediately while discussing the details along the way."}]},{"block_type":"element","block":"k5zy5b5k","search_text":"Let's build a Writable stream that receives objects in the following format:","text_count":76,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's build a Writable stream that receives objects in the following format:"}]},{"block_type":"element","block":"k5zy5b5l","search_text":"{ path: <path to a file> content: <string or buffer> } ","text_count":55,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"{ \n  path: &lt;path to a file&gt; \n  content: &lt;string or buffer&gt; \n}"}]}]},{"block_type":"element","block":"k5zy5b5m","search_text":"For each one of these objects, our stream has to save the content part into a file created at the given path. We can immediately see that the inputs of our stream are objects, and not strings or buffers; this means that our stream has to work in object mode.","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For each one of these objects, our stream has to save the content part into a file created at the given path. We can immediately see that the inputs of our stream are objects, and not strings or buffers; this means that our stream has to work in"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"object"}]},{"block_type":"text","content":"mode."}]},{"block_type":"element","block":"k5zy5b5n","search_text":"Let's call the module toFileStream.js :","text_count":39,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's call the module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"toFileStream.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5b5o","search_text":"const stream = require('stream'); const fs = require('fs'); const path = require('path'); const mkdirp = require('mkdirp'); class ToFileStream extends stream.Writable { constructor() { super({objectMode: true}); } _write (chunk, encoding, callback) { mkdirp(path.dirname(chunk.path), err => { if (err) { return callback(err); } fs.writeFile(chunk.path, chunk.content, callback); }); } } module.exports = ToFileStream; ","text_count":418,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const stream = require('stream'); \nconst fs = require('fs'); \nconst path = require('path'); \nconst mkdirp = require('mkdirp'); \n \nclass ToFileStream extends stream.Writable { \n  constructor() { \n    super({objectMode: true}); \n  } \n \n  _write (chunk, encoding, callback) { \n    mkdirp(path.dirname(chunk.path), err =&gt; { \n      if (err) { \n        return callback(err); \n      } \n      fs.writeFile(chunk.path, chunk.content, callback); \n    }); \n  } \n} \nmodule.exports = ToFileStream;"}]}]},{"block_type":"element","block":"k5zy5b5p","search_text":"As the first step, let's load all the dependencies that we are going to use. Beware that we are requiring the module mkdirp and, as you should know from the previous chapters, it should be installed with NPM.","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As the first step, let's load all the dependencies that we are going to use. Beware that we are requiring the module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mkdirp"}]},{"block_type":"text","content":"and, as you should know from the previous chapters, it should be installed with NPM."}]},{"block_type":"element","block":"k5zy5b5q","search_text":"We created a new class for our new stream, which extends from stream.Writable .","text_count":79,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We created a new class for our new stream, which extends from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Writable"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5b5r","search_text":"We had to invoke the parent constructor to initialize its internal state; we also provide an options object that specifies that the stream works in object mode ( objectMode: true ). Other options accepted by stream.Writable are as follows:","text_count":239,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We had to invoke the parent constructor to initialize its internal state; we also provide an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"options"}]},{"block_type":"text","content":"object that specifies that the stream works in object mode ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"objectMode: true"}]},{"block_type":"text","content":"). Other options accepted by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Writable"}]},{"block_type":"text","content":"are as follows:"}]},{"block_type":"element","block":"k5zy5b5s","search_text":"highWaterMark (the default is 16 KB): This controls the back-pressure limit. decodeStrings (defaults to true ): This enables the automatic decoding of strings into binary buffers before passing them to the _write() method. This option is ignored in object mode. ","text_count":262,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"highWaterMark"}]},{"block_type":"text","content":"(the default is 16 KB): This controls the back-pressure limit."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"decodeStrings"}]},{"block_type":"text","content":"(defaults to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true"}]},{"block_type":"text","content":"): This enables the automatic decoding of strings into binary buffers before passing them to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_write()"}]},{"block_type":"text","content":"method. This option is ignored in object mode."}]}]},{"block_type":"element","block":"k5zy5b5t","search_text":"Finally, we provided an implementation for the _write() method. As you can see, the method accepts a data chunk, an encoding (which makes sense only if we are in binary mode and the stream option decodeStrings is set to false ). Also, the method accepts a callback function, which needs to be invoked when the operation completes; it's not necessary to pass the result of the operation but, if needed, we can still pass an error that will cause the stream to emit an error event.","text_count":479,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we provided an implementation for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_write()"}]},{"block_type":"text","content":"method. As you can see, the method accepts a data chunk, an encoding (which makes sense only if we are in binary mode and the stream option"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"decodeStrings"}]},{"block_type":"text","content":"is set to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"false"}]},{"block_type":"text","content":"). Also, the method accepts a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function, which needs to be invoked when the operation completes; it's not necessary to pass the result of the operation but, if needed, we can still pass an error that will cause the stream to emit an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":"event."}]},{"block_type":"element","block":"k5zy5b5u","search_text":"Now, to try the stream that we just built, we can create a new module called, for example, writeToFile.js , and perform some write operations against the stream:","text_count":161,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, to try the stream that we just built, we can create a new module called, for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writeToFile.js"}]},{"block_type":"text","content":", and perform some write operations against the stream:"}]},{"block_type":"element","block":"k5zy5b5v","search_text":"const ToFileStream = require('./toFileStream.js'); const tfs = new ToFileStream(); tfs.write({path: \"file1.txt\", content: \"Hello\"}); tfs.write({path: \"file2.txt\", content: \"Node.js\"}); tfs.write({path: \"file3.txt\", content: \"Streams\"}); tfs.end(() => console.log(\"All files created\")); ","text_count":286,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const ToFileStream = require('./toFileStream.js'); \nconst tfs = new ToFileStream(); \n \ntfs.write({path: \"file1.txt\", content: \"Hello\"}); \ntfs.write({path: \"file2.txt\", content: \"Node.js\"}); \ntfs.write({path: \"file3.txt\", content: \"Streams\"}); \ntfs.end(() =&gt; console.log(\"All files created\"));"}]}]},{"block_type":"element","block":"k5zy5b5w","search_text":"With this, we created and used our first custom Writable stream. Run the new module as usual to check its output; you will see that after the execution, three new files will be created.","text_count":185,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this, we created and used our first custom Writable stream. Run the new module as usual to check its output; you will see that after the execution, three new files will be created."}]},{"block_type":"element","block":"k5zy5b5x","search_text":"Duplex streams","text_count":14,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Duplex streams"}]},{"block_type":"element","block":"k5zy5b5y","search_text":"A Duplex stream is a stream that is both Readable and Writable. It is useful when we want to describe an entity that is both a data source and a data destination, such as network sockets, for example. Duplex streams inherit the methods of both stream.Readable and stream.Writable , so this is nothing new to us. This means that we can read() or write() data, or listen for both the readable and drain events.","text_count":408,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A Duplex stream is a stream that is both Readable and Writable. It is useful when we want to describe an entity that is both a data source and a data destination, such as network sockets, for example. Duplex streams inherit the methods of both"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Readable"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Writable"}]},{"block_type":"text","content":", so this is nothing new to us. This means that we can"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read()"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"write()"}]},{"block_type":"text","content":"data, or listen for both the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readable"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"drain"}]},{"block_type":"text","content":"events."}]},{"block_type":"element","block":"k5zy5b5z","search_text":"To create a custom Duplex stream, we have to provide an implementation for both _read() and _write() ; the options object passed to the Duplex() constructor is internally forwarded to both the Readable and Writable constructors. The options are the same as those we already discussed in the previous sections, with the addition of a new one called allowHalfOpen (defaults to true) that if set to false will cause both the parts (Readable and Writable) of the stream to end if only one of them does.","text_count":498,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To create a custom Duplex stream, we have to provide an implementation for both"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_read()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_write()"}]},{"block_type":"text","content":"; the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"options"}]},{"block_type":"text","content":"object passed to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Duplex()"}]},{"block_type":"text","content":"constructor is internally forwarded to both the Readable and Writable constructors. The options are the same as those we already discussed in the previous sections, with the addition of a new one called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"allowHalfOpen"}]},{"block_type":"text","content":"(defaults to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true)"}]},{"block_type":"text","content":"that if set to false will cause both the parts (Readable and Writable) of the stream to end if only one of them does."}]},{"block_type":"element","block":"k5zy5b60","search_text":"Note To have a Duplex stream working in object mode on one side and binary mode on the other, we need to manually set the following properties from within the stream constructor: this._writableState.objectMode this._readableState.objectMode ","text_count":241,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To have a Duplex stream working in object mode on one side and binary mode on the other, we need to manually set the following properties from within the stream constructor:"}]},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"this._writableState.objectMode"}]}]},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"this._readableState.objectMode"}]}]}]},{"block_type":"element","block":"k5zy5b61","search_text":"Transform streams","text_count":17,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Transform streams"}]},{"block_type":"element","block":"k5zy5b62","search_text":"The Transform streams are a special kind of Duplex stream that are specifically designed to handle data transformations.","text_count":120,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"streams are a special kind of Duplex stream that are specifically designed to handle data transformations."}]},{"block_type":"element","block":"k5zy5b63","search_text":"In a simple Duplex stream, there is no immediate relationship between the data read from the stream and the data written into it (at least, the stream is agnostic to such a relationship). Think about a TCP socket, which just sends and receives data to and from the remote peer; the socket is not aware of any relationship between the input and output. The following diagram illustrates the data flow in a Duplex stream:","text_count":419,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a simple Duplex stream, there is no immediate relationship between the data read from the stream and the data written into it (at least, the stream is agnostic to such a relationship). Think about a TCP socket, which just sends and receives data to and from the remote peer; the socket is not aware of any relationship between the input and output. The following diagram illustrates the data flow in a Duplex stream:"}]},{"block_type":"element","block":"k5zy5b64","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000070.jpg","alt":"Transform streams","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5b65","search_text":"On the other side, Transform streams apply some kind of transformation to each chunk of data that they receive from their Writable side and then make the transformed data available on their Readable side. The following diagram shows how the data flows in a Transform stream:","text_count":274,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other side,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"streams apply some kind of transformation to each chunk of data that they receive from their Writable side and then make the transformed data available on their Readable side. The following diagram shows how the data flows in a Transform stream:"}]},{"block_type":"element","block":"k5zy5b66","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000063.jpg","alt":"Transform streams","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5b67","search_text":"From the outside, the interface of a Transform stream is exactly like that of a Duplex stream. However, when we want to build a new Duplex stream, we have to provide the _read() and _write() methods while, for implementing a new Transform stream, we have to fill in another pair of methods: _transform() and _flush() .","text_count":318,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From the outside, the interface of a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream is exactly like that of a Duplex stream. However, when we want to build a new Duplex stream, we have to provide the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_read()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_write()"}]},{"block_type":"text","content":"methods while, for implementing a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream, we have to fill in another pair of methods:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_flush()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5b68","search_text":"Let's show how to create a new Transform stream with an example.","text_count":64,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's show how to create a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream with an example."}]},{"block_type":"element","block":"k5zy5b69","search_text":"Implementing Transform streams","text_count":30,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing Transform streams"}]},{"block_type":"element","block":"k5zy5b6a","search_text":"Let's implement a Transform stream that replaces all the occurrences of a given string. To do this, we have to create a new module named replaceStream.js . Let's jump directly to the implementation:","text_count":198,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's implement a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream that replaces all the occurrences of a given string. To do this, we have to create a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"replaceStream.js"}]},{"block_type":"text","content":". Let's jump directly to the implementation:"}]},{"block_type":"element","block":"k5zy5b6b","search_text":"const stream = require('stream'); const util = require('util'); class ReplaceStream extends stream.Transform { constructor(searchString, replaceString) { super(); this.searchString = searchString; this.replaceString = replaceString; this.tailPiece = ''; } _transform(chunk, encoding, callback) { const pieces = (this.tailPiece + chunk) //[1] .split(this.searchString); const lastPiece = pieces[pieces.length - 1]; const tailPieceLen = this.searchString.length - 1; this.tailPiece = lastPiece.slice(-tailPieceLen); //[2] pieces[pieces.length - 1] = lastPiece.slice(0,-tailPieceLen); this.push(pieces.join(this.replaceString)); //[3] callback(); } _flush(callback) { this.push(this.tailPiece); callback(); } } module.exports = ReplaceStream; ","text_count":740,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const stream = require('stream'); \nconst util = require('util'); \n \nclass ReplaceStream extends stream.Transform { \n  constructor(searchString, replaceString) { \n    super(); \n    this.searchString = searchString; \n    this.replaceString = replaceString; \n    this.tailPiece = ''; \n  } \n \n  _transform(chunk, encoding, callback) { \n    const pieces = (this.tailPiece + chunk)                   //[1] \n      .split(this.searchString); \n    const lastPiece = pieces[pieces.length - 1]; \n    const tailPieceLen = this.searchString.length - 1; \n \n    this.tailPiece = lastPiece.slice(-tailPieceLen);          //[2] \n    pieces[pieces.length - 1] = lastPiece.slice(0,-tailPieceLen); \n \n    this.push(pieces.join(this.replaceString));               //[3] \n    callback(); \n  } \n \n  _flush(callback) { \n    this.push(this.tailPiece); \n    callback(); \n  } \n} \n \nmodule.exports = ReplaceStream;"}]}]},{"block_type":"element","block":"k5zy5b6c","search_text":"As always, we will start building the module from its dependencies. This time we are not using third-party modules.","text_count":115,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As always, we will start building the module from its dependencies. This time we are not using third-party modules."}]},{"block_type":"element","block":"k5zy5b6d","search_text":"Then we created a new class extending from the stream.Transform base class. The constructor of the class accepts two arguments: searchString and replaceString . As you can imagine, they allow us to define the text to match and the string to use as a replacement. We also initialize an internal tailPiece variable that will be used by the _transform() method.","text_count":358,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then we created a new class extending from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.Transform"}]},{"block_type":"text","content":"base class. The constructor of the class accepts two arguments:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"searchString"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"replaceString"}]},{"block_type":"text","content":". As you can imagine, they allow us to define the text to match and the string to use as a replacement. We also initialize an internal"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tailPiece"}]},{"block_type":"text","content":"variable that will be used by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform()"}]},{"block_type":"text","content":"method."}]},{"block_type":"element","block":"k5zy5b6e","search_text":"Now, let's analyze the _transform() method, which is the core of our new class. The _transform() method has practically the same signature as that of the _write() method of the Writable stream but, instead of writing data into an underlying resource, it pushes it into the internal buffer using this.push() , exactly as we would do in the _read() method of a Readable stream. This confirms how the two sides of a Transform stream are actually connected.","text_count":453,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's analyze the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform()"}]},{"block_type":"text","content":"method, which is the core of our new class. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform()"}]},{"block_type":"text","content":"method has practically the same signature as that of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_write()"}]},{"block_type":"text","content":"method of the Writable stream but, instead of writing data into an underlying resource, it pushes it into the internal buffer using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this.push()"}]},{"block_type":"text","content":", exactly as we would do in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_read()"}]},{"block_type":"text","content":"method of a Readable stream. This confirms how the two sides of a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream are actually connected."}]},{"block_type":"element","block":"k5zy5b6f","search_text":"The _transform() method of ReplaceStream implements the core of our algorithm. To search and replace a string in a buffer is an easy task; however, it's a totally different story when the data is streaming, and possible matches might be distributed across multiple chunks. The procedure followed by the code can be explained as follows:","text_count":336,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform()"}]},{"block_type":"text","content":"method of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ReplaceStream"}]},{"block_type":"text","content":"implements the core of our algorithm. To search and replace a string in a buffer is an easy task; however, it's a totally different story when the data is streaming, and possible matches might be distributed across multiple chunks. The procedure followed by the code can be explained as follows:"}]},{"block_type":"element","block":"k5zy5b6g","search_text":"Our algorithm splits the chunk using the searchString function as a separator. Then, it takes the last item of the array generated by the operation and extracts the last searchString.length - 1 characters. The result is saved into the tailPiece variable and it will be prepended to the next chunk of data. Finally, all the pieces resulting from split() are joined together using replaceString as a separator and pushed into the internal buffer. ","text_count":445,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Our algorithm splits the chunk using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"searchString"}]},{"block_type":"text","content":"function as a separator."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Then, it takes the last item of the array generated by the operation and extracts the last"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"searchString.length - 1"}]},{"block_type":"text","content":"characters. The result is saved into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tailPiece"}]},{"block_type":"text","content":"variable and it will be prepended to the next chunk of data."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, all the pieces resulting from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"split()"}]},{"block_type":"text","content":"are joined together using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"replaceString"}]},{"block_type":"text","content":"as a separator and pushed into the internal buffer."}]}]},{"block_type":"element","block":"k5zy5b6h","search_text":"When the stream ends, we might still have a last tailPiece variable not pushed into the internal buffer. That's exactly what the _flush() method is for; it is invoked just before the stream is ended, and this is where we have one final chance to finalize the stream or push any remaining data before completely ending the stream.","text_count":329,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When the stream ends, we might still have a last"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tailPiece"}]},{"block_type":"text","content":"variable not pushed into the internal buffer. That's exactly what the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_flush()"}]},{"block_type":"text","content":"method is for; it is invoked just before the stream is ended, and this is where we have one final chance to finalize the stream or push any remaining data before completely ending the stream."}]},{"block_type":"element","block":"k5zy5b6i","search_text":"The _flush() method only takes in a callback that we have to make sure to invoke when all the operations are complete, causing the stream to be terminated. With this, we have completed our ReplaceStream class.","text_count":209,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_flush()"}]},{"block_type":"text","content":"method only takes in a callback that we have to make sure to invoke when all the operations are complete, causing the stream to be terminated. With this, we have completed our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ReplaceStream"}]},{"block_type":"text","content":"class."}]},{"block_type":"element","block":"k5zy5b6j","search_text":"Now, it's time to try the new stream. We can create another module called replaceStreamTest.js that writes some data and then reads the transformed result:","text_count":155,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, it's time to try the new stream. We can create another module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"replaceStreamTest.js"}]},{"block_type":"text","content":"that writes some data and then reads the transformed result:"}]},{"block_type":"element","block":"k5zy5b6k","search_text":"const ReplaceStream = require('./replaceStream'); const rs = new ReplaceStream('World', 'Node.js'); rs.on('data', chunk => console.log(chunk.toString())); rs.write('Hello W'); rs.write('orld!'); rs.end(); ","text_count":205,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const ReplaceStream = require('./replaceStream'); \n \nconst rs = new ReplaceStream('World', 'Node.js'); \nrs.on('data', chunk =&gt; console.log(chunk.toString())); \n \nrs.write('Hello W'); \nrs.write('orld!'); \nrs.end();"}]}]},{"block_type":"element","block":"k5zy5b6l","search_text":"To make life a little bit harder for our stream, we spread the search term (which is World ) across two different chunks; then, using flowing mode, we read from the same stream, logging each transformed chunk. Running the preceding program should produce the following output:","text_count":276,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To make life a little bit harder for our stream, we spread the search term (which is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"World"}]},{"block_type":"text","content":") across two different chunks; then, using flowing mode, we read from the same stream, logging each transformed chunk. Running the preceding program should produce the following output:"}]},{"block_type":"element","block":"k5zy5b6m","search_text":"Hel lo Node.js ! ","text_count":17,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Hel\nlo Node.js\n!"}]}]},{"block_type":"element","block":"k5zy5b6n","search_text":"Note There is a fifth type of stream that is worth mentioning: stream.PassThrough . Unlike the other stream classes that we presented, PassThrough is not abstract and can be instantiated straightaway without the need to implement any method. It is, in fact, a Transform stream that outputs every data chunk without applying any transformation. ","text_count":344,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There is a fifth type of stream that is worth mentioning:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream.PassThrough"}]},{"block_type":"text","content":". Unlike the other stream classes that we presented,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PassThrough"}]},{"block_type":"text","content":"is not abstract and can be instantiated straightaway without the need to implement any method. It is, in fact, a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream that outputs every data chunk without applying any transformation."}]}]},{"block_type":"element","block":"k5zy5b6o","search_text":"Connecting streams using pipes","text_count":30,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Connecting streams using pipes"}]},{"block_type":"element","block":"k5zy5b6p","search_text":"The concept of Unix pipes was invented by Douglas Mcllroy; this enabled the output of a program to be connected to the input of the next. Take a look at the following command:","text_count":175,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The concept of Unix pipes was invented by Douglas Mcllroy; this enabled the output of a program to be connected to the input of the next. Take a look at the following command:"}]},{"block_type":"element","block":"k5zy5b6q","search_text":"echo Hello World! | sed s/World/Node.js/g ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"echo Hello World! | sed s/World/Node.js/g"}]}]},{"block_type":"element","block":"k5zy5b6r","search_text":"In the preceding command, echo will write Hello World! to its standard output, which is then redirected to the standard input of the sed command (thanks to the pipe | operator); then sed replaces any occurrence of World with Node.js and prints the result to its standard output (which, this time, is the console).","text_count":313,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding command,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"echo"}]},{"block_type":"text","content":"will write"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Hello World!"}]},{"block_type":"text","content":"to its standard output, which is then redirected to the standard input of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sed"}]},{"block_type":"text","content":"command (thanks to the pipe"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"|"}]},{"block_type":"text","content":"operator); then"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sed"}]},{"block_type":"text","content":"replaces any occurrence of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"World"}]},{"block_type":"text","content":"with Node.js and prints the result to its standard output (which, this time, is the console)."}]},{"block_type":"element","block":"k5zy5b6s","search_text":"In a similar way, Node.js streams can be connected together using the pipe() method of the Readable stream, which has the following interface:","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a similar way, Node.js streams can be connected together using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pipe()"}]},{"block_type":"text","content":"method of the Readable stream, which has the following interface:"}]},{"block_type":"element","block":"k5zy5b6t","search_text":"readable.pipe(writable, [options]) ","text_count":35,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"readable.pipe(writable, [options])"}]}]},{"block_type":"element","block":"k5zy5b6u","search_text":"Very intuitively, the pipe() method takes the data that is emitted from the readable stream and pumps it into the provided writable stream. Also, the writable stream is ended automatically when the readable stream emits an end event (unless we specify {end: false} as options ). The pipe() method returns the writable stream passed as an argument, allowing us to create chained invocations if such a stream is also Readable (such as a Duplex or Transform stream).","text_count":463,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Very intuitively, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pipe()"}]},{"block_type":"text","content":"method takes the data that is emitted from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readable"}]},{"block_type":"text","content":"stream and pumps it into the provided"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writable"}]},{"block_type":"text","content":"stream. Also, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writable"}]},{"block_type":"text","content":"stream is ended automatically when the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readable"}]},{"block_type":"text","content":"stream emits an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end"}]},{"block_type":"text","content":"event (unless we specify"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{end: false}"}]},{"block_type":"text","content":"as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"options"}]},{"block_type":"text","content":"). The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pipe()"}]},{"block_type":"text","content":"method returns the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writable"}]},{"block_type":"text","content":"stream passed as an argument, allowing us to create chained invocations if such a stream is also Readable (such as a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Duplex"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream)."}]},{"block_type":"element","block":"k5zy5b6v","search_text":"Piping two streams together will create a suction which allows the data to flow automatically to the writable stream, so there is no need to call read() or write() ; but most importantly there is no need to control the back-pressure anymore, because it's automatically taken care of.","text_count":283,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Piping two streams together will create a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"suction"}]},{"block_type":"text","content":"which allows the data to flow automatically to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writable"}]},{"block_type":"text","content":"stream, so there is no need to call"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"read()"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"write()"}]},{"block_type":"text","content":"; but most importantly there is no need to control the back-pressure anymore, because it's automatically taken care of."}]},{"block_type":"element","block":"k5zy5b6w","search_text":"To make a quick example (there will be tons of them coming), we can create a new module called replace.js that takes a text stream from the standard input, applies the replace transformation, and then pushes the data back to the standard output:","text_count":245,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To make a quick example (there will be tons of them coming), we can create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"replace.js"}]},{"block_type":"text","content":"that takes a text stream from the standard input, applies the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"replace"}]},{"block_type":"text","content":"transformation, and then pushes the data back to the standard output:"}]},{"block_type":"element","block":"k5zy5b6x","search_text":"const ReplaceStream = require('./replaceStream'); process.stdin .pipe(new ReplaceStream(process.argv[2], process.argv[3])) .pipe(process.stdout); ","text_count":146,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const ReplaceStream = require('./replaceStream'); \nprocess.stdin \n  .pipe(new ReplaceStream(process.argv[2], process.argv[3])) \n  .pipe(process.stdout);"}]}]},{"block_type":"element","block":"k5zy5b6y","search_text":"The preceding program pipes the data that comes from the standard input into a ReplaceStream and then back to the standard output. Now, to try this small application, we can leverage a Unix pipe to redirect some data into its standard input, as shown in the following example:","text_count":276,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding program pipes the data that comes from the standard input into a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ReplaceStream"}]},{"block_type":"text","content":"and then back to the standard output. Now, to try this small application, we can leverage a Unix pipe to redirect some data into its standard input, as shown in the following example:"}]},{"block_type":"element","block":"k5zy5b6z","search_text":"echo Hello World! | node replace World Node.js ","text_count":47,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"echo Hello World! | node replace World Node.js"}]}]},{"block_type":"element","block":"k5zy5b70","search_text":"This should produce the following output:","text_count":41,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This should produce the following output:"}]},{"block_type":"element","block":"k5zy5b71","search_text":"Hello Node.js ","text_count":14,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Hello Node.js"}]}]},{"block_type":"element","block":"k5zy5b72","search_text":"This simple example demonstrates that streams (and in particular text streams) are a universal interface, and pipes are the way to compose and interconnect almost magically all these interfaces.","text_count":194,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This simple example demonstrates that streams (and in particular text streams) are a universal interface, and pipes are the way to compose and interconnect almost magically all these interfaces."}]},{"block_type":"element","block":"k5zy5b73","search_text":"Note The error events are not propagated automatically through the pipeline. Take, for example, this code fragment: stream1 .pipe(stream2) .on('error', function() {}); In the preceding pipeline, we will catch only the errors coming from stream2 , which is the stream that we attached the listener to. This means that, if we want to catch any error generated from stream1 , we have to attach another error listener directly to it. We will later see a pattern that mitigates this inconvenience (combining streams). Also, we should notice that if the destination stream emits an error it gets automatically unpiped from the source stream, causing the pipeline to break. ","text_count":667,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":"events are not propagated automatically through the pipeline. Take, for example, this code fragment:"}]},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"stream1\n&nbsp; .pipe(stream2)\n&nbsp; .on('error', function() {});"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding pipeline, we will catch only the errors coming from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream2"}]},{"block_type":"text","content":", which is the stream that we attached the listener to. This means that, if we want to catch any error generated from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stream1"}]},{"block_type":"text","content":", we have to attach another error listener directly to it. We will later see a pattern that mitigates this inconvenience (combining streams). Also, we should notice that if the destination stream emits an error it gets automatically unpiped from the source stream, causing the pipeline to break."}]}]},{"block_type":"element","block":"k5zy5b74","search_text":"Through and from for working with streams","text_count":41,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Through and from for working with streams"}]},{"block_type":"element","block":"k5zy5b75","search_text":"The way we created custom streams so far does not exactly follow the Node way; in fact, inheriting from a base stream class violates the small surface area principle and requires some boilerplate code. This does not mean that the streams were badly designed; in fact, we should not forget that since they are a part of the Node.js core they must be as flexible as possible in order to enable userland modules to extend them for a broad range of purposes.","text_count":454,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The way we created custom streams so far does not exactly follow the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node"}]},{"block_type":"text","content":"way; in fact, inheriting from a base stream class violates the small surface area principle and requires some boilerplate code. This does not mean that the streams were badly designed; in fact, we should not forget that since they are a part of the Node.js core they must be as flexible as possible in order to enable userland modules to extend them for a broad range of purposes."}]},{"block_type":"element","block":"k5zy5b76","search_text":"However, most of the time we don't need all the power and extensibility that prototypal inheritance can give, but usually what we want is just a quick and an expressive way to define new streams. The Node.js community, of course, created a solution also for this. A perfect example is through2 ( https://npmjs.org/package/through2 ), a small library which simplifies the creation of Transform streams. With through2 , we can create a new Transform stream by invoking a simple function:","text_count":485,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, most of the time we don't need all the power and extensibility that prototypal inheritance can give, but usually what we want is just a quick and an expressive way to define new streams. The Node.js community, of course, created a solution also for this. A perfect example is through2 ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/through2"},"children":[{"block_type":"text","content":"https://npmjs.org/package/through2"}]},{"block_type":"text","content":"), a small library which simplifies the creation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"streams. With"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through2"}]},{"block_type":"text","content":", we can create a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream by invoking a simple function:"}]},{"block_type":"element","block":"k5zy5b77","search_text":"const transform = through2([options], [_transform], [_flush]) ","text_count":62,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const transform = through2([options], [_transform], [_flush])"}]}]},{"block_type":"element","block":"k5zy5b78","search_text":"In a similar way, from2 ( https://npmjs.org/package/from2 ) allows us to easily and succinctly create Readable streams with code such as the following:","text_count":151,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a similar way,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"from2"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/from2"},"children":[{"block_type":"text","content":"https://npmjs.org/package/from2"}]},{"block_type":"text","content":") allows us to easily and succinctly create Readable streams with code such as the following:"}]},{"block_type":"element","block":"k5zy5b79","search_text":"const readable = from2([options], _read) ","text_count":41,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const readable = from2([options], _read)"}]}]},{"block_type":"element","block":"k5zy5b7a","search_text":"The advantages of using these little libraries will be immediately clear as soon as we start showing their usage in the rest of the chapter.","text_count":140,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The advantages of using these little libraries will be immediately clear as soon as we start showing their usage in the rest of the chapter."}]},{"block_type":"element","block":"k5zy5b7b","search_text":"Note The packages through ( https://npmjs.org/package/through ) and from ( https://npmjs.org/package/from ) are the original libraries built on top of Streams1. ","text_count":161,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The packages"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/through"},"children":[{"block_type":"text","content":"https://npmjs.org/package/through"}]},{"block_type":"text","content":") and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"from"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/from"},"children":[{"block_type":"text","content":"https://npmjs.org/package/from"}]},{"block_type":"text","content":") are the original libraries built on top of Streams1."}]}]},{"block_type":"element","block":"k5zy5b7c","search_text":"Asynchronous control flow with streams","text_count":38,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Asynchronous control flow with streams"}]},{"block_type":"element","block":"k5zy5b7d","search_text":"Going through the examples that we have presented so far, it should be clear that streams can be useful not only to handle I/O, but also as an elegant programming pattern that can be used to process any kind of data. But the advantages do not end at the simple appearance; streams can also be leveraged to turn the asynchronous control flow into flow control, as we will see in this section.","text_count":391,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Going through the examples that we have presented so far, it should be clear that streams can be useful not only to handle I/O, but also as an elegant programming pattern that can be used to process any kind of data. But the advantages do not end at the simple appearance; streams can also be leveraged to turn the asynchronous control flow into flow control, as we will see in this section."}]},{"block_type":"element","block":"k5zy5b7e","search_text":"Sequential execution","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sequential execution"}]},{"block_type":"element","block":"k5zy5b7f","search_text":"By default, streams will handle data in a sequence; for example, a _transform() function of a Transform stream will never be invoked again with the next chunk of data, until the previous invocation completes by executing callback() . This is an important property of streams, crucial for processing each chunk in the right order, but it can also be exploited to turn streams into an elegant alternative to the traditional control flow patterns.","text_count":444,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By default, streams will handle data in a sequence; for example, a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform()"}]},{"block_type":"text","content":"function of a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream will never be invoked again with the next chunk of data, until the previous invocation completes by executing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback()"}]},{"block_type":"text","content":". This is an important property of streams, crucial for processing each chunk in the right order, but it can also be exploited to turn streams into an elegant alternative to the traditional control flow patterns."}]},{"block_type":"element","block":"k5zy5b7g","search_text":"Some code is always better than too much explanation, so let's work on an example to demonstrate how we can use streams to execute asynchronous tasks in a sequence. Let's create a function that concatenates a set of files received as input, making sure to honor the order in which they are provided. Let's create a new module called concatFiles.js and define its contents starting from its dependencies:","text_count":403,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Some code is always better than too much explanation, so let's work on an example to demonstrate how we can use streams to execute asynchronous tasks in a sequence. Let's create a function that concatenates a set of files received as input, making sure to honor the order in which they are provided. Let's create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"concatFiles.js"}]},{"block_type":"text","content":"and define its contents starting from its dependencies:"}]},{"block_type":"element","block":"k5zy5b7h","search_text":"const fromArray = require('from2-array'); const through = require('through2'); const fs = require('fs'); ","text_count":105,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fromArray = require('from2-array'); \nconst through = require('through2'); \nconst fs = require('fs');"}]}]},{"block_type":"element","block":"k5zy5b7i","search_text":"We will be using through2 to simplify the creation of Transform streams and from2-array in order to create a Readable stream from an array of objects.","text_count":150,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will be using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through2"}]},{"block_type":"text","content":"to simplify the creation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"streams and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"from2-array"}]},{"block_type":"text","content":"in order to create a Readable stream from an array of objects."}]},{"block_type":"element","block":"k5zy5b7j","search_text":"Next, we can define the concatFiles() function:","text_count":47,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, we can define the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"concatFiles()"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k5zy5b7k","search_text":"function concatFiles(destination, files, callback) { const destStream = fs.createWriteStream(destination); fromArray.obj(files) //[1] .pipe(through.obj((file, enc, done) => { //[2] const src = fs.createReadStream(file); src.pipe(destStream, {end: false}); src.on('end', done) //[3] })) .on('finish', () => { //[4] destStream.end(); callback(); }); } module.exports = concatFiles; ","text_count":380,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function concatFiles(destination, files, callback) { \n  const destStream = fs.createWriteStream(destination); \n  fromArray.obj(files)                         //[1] \n    .pipe(through.obj((file, enc, done) =&gt; {   //[2] \n      const src = fs.createReadStream(file); \n      src.pipe(destStream, {end: false}); \n      src.on('end', done)                      //[3] \n    })) \n    .on('finish', () =&gt; {                      //[4] \n      destStream.end();  \n      callback(); \n    }); \n} \nmodule.exports = concatFiles;"}]}]},{"block_type":"element","block":"k5zy5b7l","search_text":"The preceding function implements a sequential iteration over the files array by transforming it into a stream. The procedure followed by the function is explained as follows:","text_count":175,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding function implements a sequential iteration over the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"files"}]},{"block_type":"text","content":"array by transforming it into a stream. The procedure followed by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"function"}]},{"block_type":"text","content":"is explained as follows:"}]},{"block_type":"element","block":"k5zy5b7m","search_text":"First, we use from2-array to create a Readable stream from the files array. Next, we create a through ( Transform ) stream to handle each file in the sequence. For each file, we create a Readable stream and we pipe it into destStream , which represents the output file. We make sure not to close destStream after the source file finishes reading, by specifying {end: false} into the pipe() options. When all the contents of the source file have been piped into destStream , we invoke the done function, which is exposed by through.obj to communicate the completion of the current processing, which in our case is necessary to trigger the processing of the next file. When all the files have been processed, the finish event is fired; we can finally end destStream and invoke the callback() function of concatFiles() , which signals the completion of the whole operation. ","text_count":871,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, we use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"from2-array"}]},{"block_type":"text","content":"to create a Readable stream from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"files"}]},{"block_type":"text","content":"array."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Next, we create a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":") stream to handle each file in the sequence. For each file, we create a Readable stream and we pipe it into"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"destStream"}]},{"block_type":"text","content":", which represents the output file. We make sure not to close"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"destStream"}]},{"block_type":"text","content":"after the source file finishes reading, by specifying"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{end: false}"}]},{"block_type":"text","content":"into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pipe()"}]},{"block_type":"text","content":"options."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When all the contents of the source file have been piped into"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"destStream"}]},{"block_type":"text","content":", we invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done"}]},{"block_type":"text","content":"function, which is exposed by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through.obj"}]},{"block_type":"text","content":"to communicate the completion of the current processing, which in our case is necessary to trigger the processing of the next file."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When all the files have been processed, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"finish"}]},{"block_type":"text","content":"event is fired; we can finally end"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"destStream"}]},{"block_type":"text","content":"and invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback()"}]},{"block_type":"text","content":"function of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"concatFiles()"}]},{"block_type":"text","content":", which signals the completion of the whole operation."}]}]},{"block_type":"element","block":"k5zy5b7n","search_text":"We can now try to use the little module we just created. Let's do that in a new file, called concat.js :","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now try to use the little module we just created. Let's do that in a new file, called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"concat.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5b7o","search_text":"const concatFiles = require('./concatFiles'); concatFiles(process.argv[2], process.argv.slice(3), () => { console.log('Files concatenated successfully'); }); ","text_count":158,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const concatFiles = require('./concatFiles'); \nconcatFiles(process.argv[2], process.argv.slice(3), () =&gt; { \n  console.log('Files concatenated successfully'); \n});"}]}]},{"block_type":"element","block":"k5zy5b7p","search_text":"We can now run the preceding program by passing the destination file as the first command-line argument followed by a list of files to concatenate, for example:","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now run the preceding program by passing the destination file as the first command-line argument followed by a list of files to concatenate, for example:"}]},{"block_type":"element","block":"k5zy5b7q","search_text":"node concatallTogether.txtfile1.txtfile2.txt ","text_count":45,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node concatallTogether.txtfile1.txtfile2.txt"}]}]},{"block_type":"element","block":"k5zy5b7r","search_text":"This should create a new file called allTogether.txt containing, in order, the contents of file1.txt and file2.txt .","text_count":116,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This should create a new file called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"allTogether.txt"}]},{"block_type":"text","content":"containing, in order, the contents of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"file1.txt"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"file2.txt"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5b7s","search_text":"With the concatFiles() function, we were able to obtain an asynchronous sequential iteration using only streams. As we saw in Chapter 3, Asynchronous Control Flow Patterns with Callbacks , this would have required the use of an iterator, if implemented with pure JavaScript, or an external library such as async . We have now provided another option for achieving the same result, which as we see is also very compact and elegant.","text_count":430,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"concatFiles()"}]},{"block_type":"text","content":"function, we were able to obtain an asynchronous sequential iteration using only streams. As we saw in Chapter 3,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with Callbacks"}]},{"block_type":"text","content":", this would have required the use of an iterator, if implemented with pure JavaScript, or an external library such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":". We have now provided another option for achieving the same result, which as we see is also very compact and elegant."}]},{"block_type":"element","block":"k5zy5b7t","search_text":"Note Pattern Use a stream, or combination of streams, to easily iterate over a set of asynchronous tasks in sequence. ","text_count":118,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Use a stream, or combination of streams, to easily iterate over a set of asynchronous tasks in sequence."}]}]},{"block_type":"element","block":"k5zy5b7u","search_text":"Unordered parallel execution","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Unordered parallel execution"}]},{"block_type":"element","block":"k5zy5b7v","search_text":"We just saw that streams process each data chunk in a sequence, but sometimes this can be a bottleneck as we would not make the most of the Node.js concurrency. If we have to execute a slow asynchronous operation for every data chunk, it can be advantageous to parallelize the execution and speed up the overall process. Of course, this pattern can only be applied if there is no relationship between each chunk of data, which might happen frequently for object streams, but very rarely for binary streams.","text_count":506,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We just saw that streams process each data chunk in a sequence, but sometimes this can be a bottleneck as we would not make the most of the Node.js concurrency. If we have to execute a slow asynchronous operation for every data chunk, it can be advantageous to parallelize the execution and speed up the overall process. Of course, this pattern can only be applied if there is no relationship between each chunk of data, which might happen frequently for object streams, but very rarely for binary streams."}]},{"block_type":"element","block":"k5zy5b7w","search_text":"Note Caution Parallel streams cannot be used when the order in which the data is processed is important. ","text_count":105,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Caution"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Parallel streams cannot be used when the order in which the data is processed is important."}]}]},{"block_type":"element","block":"k5zy5b7x","search_text":"To parallelize the execution of a Transform stream, we can apply the same patterns that we learned in Chapter 3, Asynchronous Control Flow Patterns with Callbacks , but with some adaptations to get them working with streams. Let's see how this works.","text_count":250,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To parallelize the execution of a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream, we can apply the same patterns that we learned in Chapter 3,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with Callbacks"}]},{"block_type":"text","content":", but with some adaptations to get them working with streams. Let's see how this works."}]},{"block_type":"element","block":"k5zy5b7y","search_text":"Implementing an unordered parallel stream","text_count":41,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing an unordered parallel stream"}]},{"block_type":"element","block":"k5zy5b7z","search_text":"Let's demonstrate this immediately with an example; let's create a module called parallelStream.js and define a generic Transform stream that executes a given transform function in parallel:","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's demonstrate this immediately with an example; let's create a module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"parallelStream.js"}]},{"block_type":"text","content":"and define a generic"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream that executes a given transform function in parallel:"}]},{"block_type":"element","block":"k5zy5b80","search_text":"const stream = require('stream'); class ParallelStream extends stream.Transform { constructor(userTransform) { super({objectMode: true}); this.userTransform = userTransform; this.running = 0; this.terminateCallback = null; } _transform(chunk, enc, done) { this.running++; this.userTransform(chunk, enc, this.push.bind(this), this._onComplete.bind(this)); done(); } _flush(done) { if(this.running> 0) { this.terminateCallback = done; } else { done(); } } _onComplete(err) { this.running--; if(err) { return this.emit('error', err); } if(this.running === 0) { this.terminateCallback && this.terminateCallback(); } } } module.exports = ParallelStream; ","text_count":649,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const stream = require('stream'); \n \nclass ParallelStream extends stream.Transform { \n  constructor(userTransform) { \n    super({objectMode: true}); \n    this.userTransform = userTransform; \n    this.running = 0; \n    this.terminateCallback = null; \n  } \n \n  _transform(chunk, enc, done) { \n    this.running++; \n    this.userTransform(chunk, enc, this.push.bind(this), \n    this._onComplete.bind(this)); \n    done(); \n  } \n \n  _flush(done) { \n    if(this.running&gt; 0) { \n      this.terminateCallback = done; \n    } else { \n      done(); \n    } \n  } \n \n  _onComplete(err) { \n    this.running--; \n    if(err) { \n      return this.emit('error', err); \n    } \n    if(this.running === 0) { \n      this.terminateCallback && this.terminateCallback(); \n    } \n  } \n \n} \n \nmodule.exports = ParallelStream;"}]}]},{"block_type":"element","block":"k5zy5b81","search_text":"Let's analyze this new class. As you can see, the constructor accepts a userTransform() function, which is then saved as an instance variable; we also invoke the parent constructor and for convenience we enable the object mode by default.","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's analyze this new class. As you can see, the constructor accepts a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"userTransform()"}]},{"block_type":"text","content":"function, which is then saved as an instance variable; we also invoke the parent constructor and for convenience we enable the object mode by default."}]},{"block_type":"element","block":"k5zy5b82","search_text":"Next, it is the turn of the _transform() method. In this method, we execute the userTransform() function, then we increment the count of running tasks; finally, we notify that the current transformation step is complete by invoking done() . The trick for triggering the processing of another item in parallel is exactly this; we are not waiting for the userTransform() function to complete before invoking done() ; instead, we do it immediately. On the other hand, we provide a special callback to userTransform() , which is the this._onComplete() method; this allows us to get notified when the userTransform() completes.","text_count":622,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, it is the turn of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform()"}]},{"block_type":"text","content":"method. In this method, we execute the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"userTransform()"}]},{"block_type":"text","content":"function, then we increment the count of running tasks; finally, we notify that the current transformation step is complete by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done()"}]},{"block_type":"text","content":". The trick for triggering the processing of another item in parallel is exactly this; we are not waiting for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"userTransform()"}]},{"block_type":"text","content":"function to complete before invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done()"}]},{"block_type":"text","content":"; instead, we do it immediately. On the other hand, we provide a special callback to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"userTransform()"}]},{"block_type":"text","content":", which is the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this._onComplete()"}]},{"block_type":"text","content":"method; this allows us to get notified when the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"userTransform()"}]},{"block_type":"text","content":"completes."}]},{"block_type":"element","block":"k5zy5b83","search_text":"The _flush() method is invoked just before the stream terminates, so if there are still tasks running we can put on hold the release of the finish event by not invoking the done() callback immediately; instead, we assign it to the this.terminateCallback variable. To understand how the stream is then properly terminated, we have to look into the _onComplete() method. This last method is invoked every time an asynchronous task completes. It checks whether there are any more tasks running and, if there are none, it invokes the this.terminateCallback() function, which will cause the stream to end, releasing the finish event that was put on hold in the _flush() method.","text_count":672,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_flush()"}]},{"block_type":"text","content":"method is invoked just before the stream terminates, so if there are still tasks running we can put on hold the release of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"finish"}]},{"block_type":"text","content":"event by not invoking the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done()"}]},{"block_type":"text","content":"callback immediately; instead, we assign it to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this.terminateCallback"}]},{"block_type":"text","content":"variable. To understand how the stream is then properly terminated, we have to look into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_onComplete()"}]},{"block_type":"text","content":"method. This last method is invoked every time an asynchronous task completes. It checks whether there are any more tasks running and, if there are none, it invokes the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this.terminateCallback()"}]},{"block_type":"text","content":"function, which will cause the stream to end, releasing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"finish"}]},{"block_type":"text","content":"event that was put on hold in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_flush()"}]},{"block_type":"text","content":"method."}]},{"block_type":"element","block":"k5zy5b84","search_text":"The ParallelStream class we just built allows us to easily create a Transform stream that executes its tasks in parallel, but there is a caveat: it does not preserve the order of the items as they are received. In fact, asynchronous operations can complete and push data at any time, regardless of when they are started. We immediately understand that this property does not play well with binary streams where the order of data usually matters, but it can surely be useful with some types of object streams.","text_count":508,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ParallelStream"}]},{"block_type":"text","content":"class we just built allows us to easily create a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream that executes its tasks in parallel, but there is a caveat: it does not preserve the order of the items as they are received. In fact, asynchronous operations can complete and push data at any time, regardless of when they are started. We immediately understand that this property does not play well with binary streams where the order of data usually matters, but it can surely be useful with some types of object streams."}]},{"block_type":"element","block":"k5zy5b85","search_text":"Implementing a URL status monitoring application","text_count":48,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing a URL status monitoring application"}]},{"block_type":"element","block":"k5zy5b86","search_text":"Now, let's apply our ParallelStream to a concrete example. Let's imagine that we wanted to build a simple service to monitor the status of a big list of URLs. Let's imagine all these URLs are contained in a single file and are newline separated.","text_count":245,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's apply our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ParallelStream"}]},{"block_type":"text","content":"to a concrete example. Let's imagine that we wanted to build a simple service to monitor the status of a big list of URLs. Let's imagine all these URLs are contained in a single file and are newline separated."}]},{"block_type":"element","block":"k5zy5b87","search_text":"Streams can offer a very efficient and elegant solution to this problem, especially if we use our ParallelStream class to parallelize the checking of the URLs.","text_count":159,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Streams can offer a very efficient and elegant solution to this problem, especially if we use our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ParallelStream"}]},{"block_type":"text","content":"class to parallelize the checking of the URLs."}]},{"block_type":"element","block":"k5zy5b88","search_text":"Let's build this simple application immediately in a new module called checkUrls.js :","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's build this simple application immediately in a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkUrls.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5b89","search_text":"const fs = require('fs'); const split = require('split'); const request = require('request'); const ParallelStream = require('./parallelStream'); fs.createReadStream(process.argv[2]) //[1] .pipe(split()) //[2] .pipe(new ParallelStream((url, enc, push, done) => { //[3] if(!url) return done(); request.head(url, (err, response) => { push(url + ' is ' + (err ? 'down' : 'up') + '\\n'); done(); }); })) .pipe(fs.createWriteStream('results.txt')) //[4] .on('finish', () => console.log('All urls were checked')); ","text_count":507,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nconst split = require('split'); \nconst request = require('request'); \nconst ParallelStream = require('./parallelStream'); \n \nfs.createReadStream(process.argv[2])                       //[1] \n  .pipe(split())                                           //[2] \n  .pipe(new ParallelStream((url, enc, push, done) =&gt; {     //[3] \n    if(!url) return done(); \n    request.head(url, (err, response) =&gt; { \n      push(url + ' is ' + (err ? 'down' : 'up') + '\\n'); \n      done(); \n    }); \n  })) \n  .pipe(fs.createWriteStream('results.txt'))   //[4] \n  .on('finish', () =&gt; console.log('All urls were checked'));"}]}]},{"block_type":"element","block":"k5zy5b8a","search_text":"As we can see, with streams our code looks very elegant and straightforward; let's see how it works:","text_count":100,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, with streams our code looks very elegant and straightforward; let's see how it works:"}]},{"block_type":"element","block":"k5zy5b8b","search_text":"First, we create a Readable stream from the file given as input. We pipe the contents of the input file through split ( https://npmjs.org/package/split ), a Transform stream that ensures outputting each line on a different chunk. Then, it's the time to use our ParallelStream to check the URL. We do this by sending a head request and waiting for a response. When the callback is invoked, we push the result of the operation down the stream. Finally, all the results are piped into a file, results.txt . ","text_count":504,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, we create a Readable stream from the file given as input."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We pipe the contents of the input file through"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"split"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/split"},"children":[{"block_type":"text","content":"https://npmjs.org/package/split"}]},{"block_type":"text","content":"), a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Transform"}]},{"block_type":"text","content":"stream that ensures outputting each line on a different chunk."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Then, it's the time to use our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ParallelStream"}]},{"block_type":"text","content":"to check the URL. We do this by sending a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"head"}]},{"block_type":"text","content":"request and waiting for a response. When the callback is invoked, we push the result of the operation down the stream."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, all the results are piped into a file,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"results.txt"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5b8c","search_text":"Now, we can run the checkUrls module with a command such as this:","text_count":65,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, we can run the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkUrls"}]},{"block_type":"text","content":"module with a command such as this:"}]},{"block_type":"element","block":"k5zy5b8d","search_text":"node checkUrlsurlList.txt ","text_count":26,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node checkUrlsurlList.txt"}]}]},{"block_type":"element","block":"k5zy5b8e","search_text":"Here the file urlList.txt contains a list of URLs, for example:","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Here the file"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"urlList.txt"}]},{"block_type":"text","content":"contains a list of URLs, for example:"}]},{"block_type":"element","block":"k5zy5b8f","search_text":"http://www.mariocasciaro.me http://loige.co http://thiswillbedownforsure.com ","text_count":77,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.mariocasciaro.me"},"children":[{"block_type":"text","content":"http://www.mariocasciaro.me"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"http://loige.co"},"children":[{"block_type":"text","content":"http://loige.co"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"http://thiswillbedownforsure.com/"},"children":[{"block_type":"text","content":"http://thiswillbedownforsure.com"}]}]}]},{"block_type":"element","block":"k5zy5b8g","search_text":"When the command finishes running, we will see that a file, results.txt , was created. This contains the results of the operation, for example:","text_count":143,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When the command finishes running, we will see that a file,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"results.txt"}]},{"block_type":"text","content":", was created. This contains the results of the operation, for example:"}]},{"block_type":"element","block":"k5zy5b8h","search_text":"http://thiswillbedownforsure.com is down http://loige.co is up http://www.mariocasciaro.me is up ","text_count":97,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"http://thiswillbedownforsure.com is down \n    http://loige.co is up \n    http://www.mariocasciaro.me is up"}]}]},{"block_type":"element","block":"k5zy5b8i","search_text":"There is a good probability that the order in which the results are written is different from the order in which the URLs were specified in the input file. This is clear evidence that our stream executes its tasks in parallel, and it does not enforce any order between the various data chunks in the stream.","text_count":307,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There is a good probability that the order in which the results are written is different from the order in which the URLs were specified in the input file. This is clear evidence that our stream executes its tasks in parallel, and it does not enforce any order between the various data chunks in the stream."}]},{"block_type":"element","block":"k5zy5b8j","search_text":"Note For the sake of curiosity, we might want to try replacing ParallelStream with a normal through2 stream, and compare the behavior and performances of the two (you might want to do this as an exercise). We will see that using through2 is way slower, because each URL would be checked in a sequence, but also that the order of the results in the file results.txt would be preserved. ","text_count":385,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For the sake of curiosity, we might want to try replacing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ParallelStream"}]},{"block_type":"text","content":"with a normal"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through2"}]},{"block_type":"text","content":"stream, and compare the behavior and performances of the two (you might want to do this as an exercise). We will see that using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through2"}]},{"block_type":"text","content":"is way slower, because each URL would be checked in a sequence, but also that the order of the results in the file"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"results.txt"}]},{"block_type":"text","content":"would be preserved."}]}]},{"block_type":"element","block":"k5zy5b8k","search_text":"Unordered limited parallel execution","text_count":36,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Unordered limited parallel execution"}]},{"block_type":"element","block":"k5zy5b8l","search_text":"If we try to run the checkUrls application against a file that contains thousands or millions of URLs, we will surely run into trouble. Our application will create an uncontrolled number of connections all at once, sending a considerable amount of data in parallel and potentially undermining the stability of the application and the availability of the entire system. As we already know, the solution to keep the load and resource usage under control is to limit the concurrency of the parallel tasks.","text_count":502,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we try to run the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkUrls"}]},{"block_type":"text","content":"application against a file that contains thousands or millions of URLs, we will surely run into trouble. Our application will create an uncontrolled number of connections all at once, sending a considerable amount of data in parallel and potentially undermining the stability of the application and the availability of the entire system. As we already know, the solution to keep the load and resource usage under control is to limit the concurrency of the parallel tasks."}]},{"block_type":"element","block":"k5zy5b8m","search_text":"Let's see how this works with streams by creating a limitedParallelStream.js module, which is an adaptation of parallelStream.js that we created in the previous section.","text_count":169,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see how this works with streams by creating a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"limitedParallelStream.js"}]},{"block_type":"text","content":"module, which is an adaptation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"parallelStream.js"}]},{"block_type":"text","content":"that we created in the previous section."}]},{"block_type":"element","block":"k5zy5b8n","search_text":"Let's see what it looks like, starting from its constructor (we will highlight the changed parts):","text_count":98,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see what it looks like, starting from its constructor (we will highlight the changed parts):"}]},{"block_type":"element","block":"k5zy5b8o","search_text":"class LimitedParallelStream extends stream.Transform { constructor(concurrency, userTransform) { super({objectMode: true}); this.concurrency = concurrency; this.userTransform = userTransform; this.running = 0; this.terminateCallback = null; this.continueCallback = null; } //... ","text_count":279,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class LimitedParallelStream extends stream.Transform { \n  constructor(concurrency, userTransform) { \n    super({objectMode: true}); \n    this.concurrency = concurrency; \n    this.userTransform = userTransform; \n    this.running = 0; \n    this.terminateCallback = null; \n    this.continueCallback = null; \n  } \n//..."}]}]},{"block_type":"element","block":"k5zy5b8p","search_text":"We need a concurrency limit to be taken as the input, and this time we are going to save two callbacks, one for any pending _transform method ( continueCallback ) and another one for the callback of the _flush method ( terminateCallback ).","text_count":239,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We need a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"concurrency"}]},{"block_type":"text","content":"limit to be taken as the input, and this time we are going to save two callbacks, one for any pending"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform"}]},{"block_type":"text","content":"method ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"continueCallback"}]},{"block_type":"text","content":") and another one for the callback of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_flush"}]},{"block_type":"text","content":"method ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"terminateCallback"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5b8q","search_text":"Next is the _transform() method:","text_count":32,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next is the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform()"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k5zy5b8r","search_text":"_transform(chunk, enc, done) { this.running++; this.userTransform(chunk, enc, this._onComplete.bind(this)); if(this.running < this.concurrency) { done(); } else { this.continueCallback = done; } } ","text_count":197,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"_transform(chunk, enc, done) { \n    this.running++; \n    this.userTransform(chunk, enc, this._onComplete.bind(this)); \n    if(this.running &lt; this.concurrency) { \n      done(); \n    } else { \n      this.continueCallback = done; \n    } \n  }"}]}]},{"block_type":"element","block":"k5zy5b8s","search_text":"This time in the _transform() method, we have to check whether we have any free execution slots before we invoke done() and trigger the processing of the next item. If we have already reached the maximum number of concurrent running streams, we can simply save the done() callback into the continueCallback variable, so that it can be invoked as soon as a task finishes.","text_count":370,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This time in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform()"}]},{"block_type":"text","content":"method, we have to check whether we have any free execution slots before we invoke"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done()"}]},{"block_type":"text","content":"and trigger the processing of the next item. If we have already reached the maximum number of concurrent running streams, we can simply save the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"done()"}]},{"block_type":"text","content":"callback into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"continueCallback"}]},{"block_type":"text","content":"variable, so that it can be invoked as soon as a task finishes."}]},{"block_type":"element","block":"k5zy5b8t","search_text":"The _flush() method remains exactly the same as in the ParallelStream class, so let's move directly to implementing the _onComplete() method:","text_count":141,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_flush()"}]},{"block_type":"text","content":"method remains exactly the same as in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ParallelStream"}]},{"block_type":"text","content":"class, so let's move directly to implementing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_onComplete()"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k5zy5b8u","search_text":"_onComplete(err) { this.running--; if(err) { return this.emit('error', err); } const tmpCallback = this.continueCallback; this.continueCallback = null; tmpCallback && tmpCallback(); if(this.running === 0) { this.terminateCallback && this.terminateCallback(); } } ","text_count":263,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"_onComplete(err) { \n  this.running--; \n  if(err) { \n    return this.emit('error', err); \n  } \n  const tmpCallback = this.continueCallback; \n  this.continueCallback = null; \n  tmpCallback && tmpCallback(); \n  if(this.running === 0) { \n    this.terminateCallback && this.terminateCallback(); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5b8v","search_text":"Every time a task completes we invoke any saved continueCallback() that will cause the stream to unblock, triggering the processing of the next item.","text_count":149,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Every time a task completes we invoke any saved"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"continueCallback()"}]},{"block_type":"text","content":"that will cause the stream to unblock, triggering the processing of the next item."}]},{"block_type":"element","block":"k5zy5b8w","search_text":"That's it for the limitedParallelStream module; we can now use it in the checkUrls module in place of parallelStream and have the concurrency of our tasks limited to the value that we set.","text_count":188,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's it for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"limitedParallelStream"}]},{"block_type":"text","content":"module; we can now use it in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkUrls"}]},{"block_type":"text","content":"module in place of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"parallelStream"}]},{"block_type":"text","content":"and have the concurrency of our tasks limited to the value that we set."}]},{"block_type":"element","block":"k5zy5b8x","search_text":"Ordered parallel execution","text_count":26,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Ordered parallel execution"}]},{"block_type":"element","block":"k5zy5b8y","search_text":"The parallel streams that we created previously might shuffle the order of the emitted data, but there are situations where this is not acceptable; sometimes, in fact, it is necessary to have each chunk emitted in the same order in which it was received. However, not all hopes is lost, we can still run the transform function in parallel; all we have to do is to sort the data emitted by each task so that it follows the same order in which the data was received.","text_count":464,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The parallel streams that we created previously might shuffle the order of the emitted data, but there are situations where this is not acceptable; sometimes, in fact, it is necessary to have each chunk emitted in the same order in which it was received. However, not all hopes is lost, we can still run the transform function in parallel; all we have to do is to sort the data emitted by each task so that it follows the same order in which the data was received."}]},{"block_type":"element","block":"k5zy5b8z","search_text":"This technique involves the use of a buffer to reorder the chunks while they are emitted by each running task. For brevity, we are not going to provide an implementation of such a stream, as it's quite verbose for the scope of this book; what we are going to do instead is reuse one of the available packages on NPM built for this specific purpose, for example, through2-parallel ( https://npmjs.org/package/through2-parallel ).","text_count":428,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This technique involves the use of a buffer to reorder the chunks while they are emitted by each running task. For brevity, we are not going to provide an implementation of such a stream, as it's quite verbose for the scope of this book; what we are going to do instead is reuse one of the available packages on NPM built for this specific purpose, for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through2-parallel"}]},{"block_type":"text","content":"&nbsp;("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/through2-parallel"},"children":[{"block_type":"text","content":"https://npmjs.org/package/through2-parallel"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5b90","search_text":"We can quickly check the behavior of an ordered parallel execution by modifying our existing checkUrls module. Let's say that we want our results to be written in the same order as the URLs in the input file, while executing our checks in parallel. We can do this using through2-parallel :","text_count":289,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can quickly check the behavior of an ordered parallel execution by modifying our existing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkUrls"}]},{"block_type":"text","content":"module. Let's say that we want our results to be written in the same order as the URLs in the input file, while executing our checks in parallel. We can do this using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through2-parallel"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5b91","search_text":"//... const throughParallel = require('through2-parallel'); fs.createReadStream(process.argv[2]) .pipe(split()) .pipe(throughParallel.obj({concurrency: 2},(url, enc, done) => { //... }) ) .pipe(fs.createWriteStream('results.txt')) .on('finish', () => console.log('All urls were checked')); ","text_count":290,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//... \nconst throughParallel = require('through2-parallel'); \n \nfs.createReadStream(process.argv[2]) \n  .pipe(split()) \n  .pipe(throughParallel.obj({concurrency: 2},(url, enc, done) =&gt; { \n      //... \n    }) \n  ) \n  .pipe(fs.createWriteStream('results.txt')) \n  .on('finish', () =&gt; console.log('All urls were checked'));"}]}]},{"block_type":"element","block":"k5zy5b92","search_text":"As we can see, the interface of through2-parallel is very similar to that of through2 ; the only difference is that we can also specify a concurrency limit for the transform function that we provide. If we try to run this new version of checkUrls , we will now see that the results.txt file lists the results in the same order as the URLs appear in the input file.","text_count":364,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, the interface of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through2-parallel"}]},{"block_type":"text","content":"is very similar to that of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through2"}]},{"block_type":"text","content":"; the only difference is that we can also specify a concurrency limit for the transform function that we provide. If we try to run this new version of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkUrls"}]},{"block_type":"text","content":", we will now see that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"results.txt"}]},{"block_type":"text","content":"file lists the results in the same order as the URLs appear in the input file."}]},{"block_type":"element","block":"k5zy5b93","search_text":"Note It is important to see that, even though the order of the output is the same as the input, the asynchronous tasks still run in parallel and can possibly complete in any order. ","text_count":181,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is important to see that, even though the order of the output is the same as the input, the asynchronous tasks still run in parallel and can possibly complete in any order."}]}]},{"block_type":"element","block":"k5zy5b94","search_text":"With this, we conclude our analysis of the asynchronous control flow with streams; next, we are going to focus on some piping patterns.","text_count":135,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this, we conclude our analysis of the asynchronous control flow with streams; next, we are going to focus on some piping patterns."}]},{"block_type":"element","block":"k5zy5b95","search_text":"Piping patterns","text_count":15,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Piping patterns"}]},{"block_type":"element","block":"k5zy5b96","search_text":"As in real-life plumbing, Node.js streams also can be piped together following different patterns; we can, in fact, merge the flow of two different streams into one, split the flow of one stream into two or more pipes, or redirect the flow based on a condition. In this section, we are going to explore the most important plumbing techniques that can be applied to Node.js streams.","text_count":381,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As in real-life plumbing, Node.js streams also can be piped together following different patterns; we can, in fact, merge the flow of two different streams into one, split the flow of one stream into two or more pipes, or redirect the flow based on a condition. In this section, we are going to explore the most important plumbing techniques that can be applied to Node.js streams."}]},{"block_type":"element","block":"k5zy5b97","search_text":"Combining streams","text_count":17,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Combining streams"}]},{"block_type":"element","block":"k5zy5b98","search_text":"In this chapter, we have stressed a lot on the fact that streams provide a simple infrastructure to modularize and reuse our code, but there is one last piece missing in this puzzle: what if we want to modularize and reuse an entire pipeline? What if we want to combine multiple streams so that they look like one from the outside? The following figure shows what this means:","text_count":375,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we have stressed a lot on the fact that streams provide a simple infrastructure to modularize and reuse our code, but there is one last piece missing in this puzzle: what if we want to modularize and reuse an entire pipeline? What if we want to combine multiple streams so that they look like one from the outside? The following figure shows what this means:"}]},{"block_type":"element","block":"k5zy5b99","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000041.jpg","alt":"Combining streams","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5b9a","search_text":"From the preceding diagram, we should already get a hint of how this works:","text_count":75,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From the preceding diagram, we should already get a hint of how this works:"}]},{"block_type":"element","block":"k5zy5b9b","search_text":"When we write into the combined stream, we are actually writing into the first stream of the pipeline When we read from the combined stream, we are actually reading from the last stream of the pipeline ","text_count":202,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When we write into the combined stream, we are actually writing into the first stream of the pipeline"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When we read from the combined stream, we are actually reading from the last stream of the pipeline"}]}]},{"block_type":"element","block":"k5zy5b9c","search_text":"A combined stream is usually a Duplex stream, which is built by connecting the first stream to its Writable side and the last stream to its Readable side.","text_count":154,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A combined stream is usually a Duplex stream, which is built by connecting the first stream to its Writable side and the last stream to its Readable side."}]},{"block_type":"element","block":"k5zy5b9d","search_text":"Tip To create a Duplex stream out of two different streams, one Writable and one Readable, we can use an npm module such as duplexer2 ( https://npmjs.org/package/duplexer2 ). ","text_count":175,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To create a Duplex stream out of two different streams, one Writable and one Readable, we can use an npm module such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"duplexer2"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/duplexer2"},"children":[{"block_type":"text","content":"https://npmjs.org/package/duplexer2"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5b9e","search_text":"But that's not enough; in fact, another important characteristic of a combined stream is that it has to capture all the errors that are emitted from any stream inside the pipeline. As we already mentioned, any error event is not automatically propagated down the pipeline; so, if we want to have proper error management (and we should), we will have to explicitly attach an error listener to each stream. However, if the combined stream is really a black box, which means that we don't have access to any of the streams in the middle of the pipeline, so it's crucial for the combined stream to also act as an aggregator for all the errors coming from any stream in the pipeline.","text_count":678,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But that's not enough; in fact, another important characteristic of a combined stream is that it has to capture all the errors that are emitted from any stream inside the pipeline. As we already mentioned, any error event is not automatically propagated down the pipeline; so, if we want to have proper error management (and we should), we will have to explicitly attach an error listener to each stream. However, if the combined stream is really a black box, which means that we don't have access to any of the streams in the middle of the pipeline, so it's crucial for the combined stream to also act as an"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"aggregator"}]},{"block_type":"text","content":"for all the errors coming from any stream in the pipeline."}]},{"block_type":"element","block":"k5zy5b9f","search_text":"To recap, a combined stream has two major advantages:","text_count":53,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To recap, a combined stream has two major advantages:"}]},{"block_type":"element","block":"k5zy5b9g","search_text":"We can redistribute it as a black box by hiding its internal pipeline We have simplified error management, as we don't have to attach an error listener to each stream in the pipeline, but just to the combined stream itself ","text_count":223,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We can redistribute it as a black box by hiding its internal pipeline"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We have simplified error management, as we don't have to attach an error listener to each stream in the pipeline, but just to the combined stream itself"}]}]},{"block_type":"element","block":"k5zy5b9h","search_text":"Combining streams is a pretty generic and common practice, so if we don't have any particular need we might just want to reuse an existing solution such as multipipe ( https://www.npmjs.org/package/multipipe ) or combine-stream ( https://www.npmjs.org/package/combine-stream ), just to name two.","text_count":295,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Combining streams is a pretty generic and common practice, so if we don't have any particular need we might just want to reuse an existing solution such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"multipipe"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.npmjs.org/package/multipipe"},"children":[{"block_type":"text","content":"https://www.npmjs.org/package/multipipe"}]},{"block_type":"text","content":") or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"combine-stream"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.npmjs.org/package/combine-stream"},"children":[{"block_type":"text","content":"https://www.npmjs.org/package/combine-stream"}]},{"block_type":"text","content":"), just to name two."}]},{"block_type":"element","block":"k5zy5b9i","search_text":"Implementing a combined stream","text_count":30,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing a combined stream"}]},{"block_type":"element","block":"k5zy5b9j","search_text":"To illustrate a simple example, let's consider the case of the following two transform streams:","text_count":95,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To illustrate a simple example, let's consider the case of the following two transform streams:"}]},{"block_type":"element","block":"k5zy5b9k","search_text":"One that both compresses and encrypts the data One that both decrypts and decompresses the data ","text_count":96,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"One that both compresses and encrypts the data"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"One that both decrypts and decompresses the data"}]}]},{"block_type":"element","block":"k5zy5b9l","search_text":"Using a library such as multipipe , we can easily build these streams by combining some of the streams that we already have available from the core libraries (file combinedStreams.js ):","text_count":185,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using a library such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"multipipe"}]},{"block_type":"text","content":", we can easily build these streams by combining some of the streams that we already have available from the core libraries (file"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"combinedStreams.js"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5b9m","search_text":"const zlib = require('zlib'); const crypto = require('crypto'); const combine = require('multipipe'); module.exports.compressAndEncrypt = password => { return combine( zlib.createGzip(), crypto.createCipher('aes192', password) ); }; module.exports.decryptAndDecompress = password => { return combine( crypto.createDecipher('aes192', password), zlib.createGunzip() ); }; ","text_count":370,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const zlib = require('zlib'); \nconst crypto = require('crypto'); \nconst combine = require('multipipe'); \n \nmodule.exports.compressAndEncrypt = password =&gt; { \n  return combine( \n    zlib.createGzip(), \n    crypto.createCipher('aes192', password) \n  ); \n}; \n \nmodule.exports.decryptAndDecompress = password =&gt; { \n  return combine( \n    crypto.createDecipher('aes192', password), \n    zlib.createGunzip() \n  ); \n};"}]}]},{"block_type":"element","block":"k5zy5b9n","search_text":"We can now use these combined streams as if they were black boxes, for example, to create a small application that archives a file by compressing and encrypting it. Let's do that in a new module named archive.js :","text_count":213,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now use these combined streams as if they were black boxes, for example, to create a small application that archives a file by compressing and encrypting it. Let's do that in a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"archive.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5b9o","search_text":"const fs = require('fs'); const compressAndEncryptStream = require('./combinedStreams').compressAndEncrypt; fs.createReadStream(process.argv[3]) .pipe(compressAndEncryptStream(process.argv[2])) .pipe(fs.createWriteStream(process.argv[3] + \".gz.enc\")); ","text_count":252,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nconst compressAndEncryptStream = \n  require('./combinedStreams').compressAndEncrypt; \n \nfs.createReadStream(process.argv[3]) \n  .pipe(compressAndEncryptStream(process.argv[2])) \n  .pipe(fs.createWriteStream(process.argv[3] + \".gz.enc\"));"}]}]},{"block_type":"element","block":"k5zy5b9p","search_text":"We can further improve the preceding code by building a combined stream out of the pipeline that we created, this time not to obtain a reusable black box but only to take advantage of its aggregated error management. In fact, as we have already mentioned many times, writing something such as the following will only catch the errors that are emitted by the last stream:","text_count":370,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can further improve the preceding code by building a combined stream out of the pipeline that we created, this time not to obtain a reusable black box but only to take advantage of its aggregated error management. In fact, as we have already mentioned many times, writing something such as the following will only catch the errors that are emitted by the last stream:"}]},{"block_type":"element","block":"k5zy5b9q","search_text":"fs.createReadStream(process.argv[3]) .pipe(compressAndEncryptStream(process.argv[2])) .pipe(fs.createWriteStream(process.argv[3] + \".gz.enc\")) .on('error', err => { //Only errors from the last stream console.log(err); }); ","text_count":222,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fs.createReadStream(process.argv[3]) \n  .pipe(compressAndEncryptStream(process.argv[2])) \n  .pipe(fs.createWriteStream(process.argv[3] + \".gz.enc\")) \n  .on('error', err =&gt; { \n    //Only errors from the last stream \n    console.log(err); \n  });"}]}]},{"block_type":"element","block":"k5zy5b9r","search_text":"However, by combining all the streams together, we can fix the problem elegantly. Let's then rewrite the archive.js file as follows:","text_count":132,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, by combining all the streams together, we can fix the problem elegantly. Let's then rewrite the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"archive.js"}]},{"block_type":"text","content":"file as follows:"}]},{"block_type":"element","block":"k5zy5b9s","search_text":"const combine = require('multipipe'); const fs = require('fs'); const compressAndEncryptStream = require('./combinedStreams').compressAndEncrypt; combine( fs.createReadStream(process.argv[3]) .pipe(compressAndEncryptStream(process.argv[2])) .pipe(fs.createWriteStream(process.argv[3] + \".gz.enc\")) ).on('error', err => { //this error may come from any stream in the pipeline console.log(err); }); ","text_count":397,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const combine = require('multipipe'); \nconst fs = require('fs'); \nconst compressAndEncryptStream = \n  require('./combinedStreams').compressAndEncrypt; \n \ncombine( \n  fs.createReadStream(process.argv[3]) \n  .pipe(compressAndEncryptStream(process.argv[2]))\n  .pipe(fs.createWriteStream(process.argv[3] + \".gz.enc\")) \n).on('error', err =&gt; { \n  //this error may come from any stream in the pipeline \n  console.log(err); \n});"}]}]},{"block_type":"element","block":"k5zy5b9t","search_text":"As we can see, we can now attach an error listener directly to the combined stream and it will receive any error event that is emitted by any of its internal streams.","text_count":166,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, we can now attach an error listener directly to the combined stream and it will receive any"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":"event that is emitted by any of its internal streams."}]},{"block_type":"element","block":"k5zy5b9u","search_text":"Now, to run the archive module, simply specify a password and a file in the command-line argument:","text_count":98,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, to run the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"archive"}]},{"block_type":"text","content":"module, simply specify a password and a file in the command-line argument:"}]},{"block_type":"element","block":"k5zy5b9v","search_text":"node archive mypassword /path/to/a/file.txt ","text_count":44,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node archive mypassword /path/to/a/file.txt"}]}]},{"block_type":"element","block":"k5zy5b9w","search_text":"With this example, we have clearly demonstrated how important it is to combine streams; from one aspect, it allows us to create reusable compositions of streams, and from another, it simplifies the error management of a pipeline.","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this example, we have clearly demonstrated how important it is to combine streams; from one aspect, it allows us to create reusable compositions of streams, and from another, it simplifies the error management of a pipeline."}]},{"block_type":"element","block":"k5zy5b9x","search_text":"Forking streams","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Forking streams"}]},{"block_type":"element","block":"k5zy5b9y","search_text":"We can perform a fork of a stream by piping a single Readable stream into multiple Writable streams. This is useful when we want to send the same data to different destinations, for example, two different sockets or two different files. It can also be used when we want to perform different transformations on the same data, or when we want to split the data based on some criteria. The following figure gives us a graphical representation of this pattern:","text_count":456,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can perform a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"fork"}]},{"block_type":"text","content":"of a stream by piping a single Readable stream into multiple Writable streams. This is useful when we want to send the same data to different destinations, for example, two different sockets or two different files. It can also be used when we want to perform different transformations on the same data, or when we want to split the data based on some criteria. The following figure gives us a graphical representation of this pattern:"}]},{"block_type":"element","block":"k5zy5b9z","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000002.jpg","alt":"Forking streams","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5ba0","search_text":"Forking a stream in Node.js is a trivial matter; let's see why by working on an example.","text_count":88,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Forking a stream in Node.js is a trivial matter; let's see why by working on an example."}]},{"block_type":"element","block":"k5zy5ba1","search_text":"Implementing a multiple checksum generator","text_count":42,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing a multiple checksum generator"}]},{"block_type":"element","block":"k5zy5ba2","search_text":"Let's create a small utility that outputs both the sha1 and md5 hashes of a given file. Let's call this new module generateHashes.js and let's start by initializing our checksum streams:","text_count":186,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's create a small utility that outputs both the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sha1"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"md5"}]},{"block_type":"text","content":"hashes of a given file. Let's call this new module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"generateHashes.js"}]},{"block_type":"text","content":"and let's start by initializing our checksum streams:"}]},{"block_type":"element","block":"k5zy5ba3","search_text":"const fs = require('fs'); const crypto = require('crypto'); const sha1Stream = crypto.createHash('sha1'); sha1Stream.setEncoding('base64'); const md5Stream = crypto.createHash('md5'); md5Stream.setEncoding('base64'); ","text_count":217,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nconst crypto = require('crypto'); \n \nconst sha1Stream = crypto.createHash('sha1'); \nsha1Stream.setEncoding('base64'); \n \nconst md5Stream = crypto.createHash('md5'); \nmd5Stream.setEncoding('base64');"}]}]},{"block_type":"element","block":"k5zy5ba4","search_text":"Nothing special so far; the next part of the module is actually where we will create a Readable stream from a file and fork it to two different streams in order to obtain two other files, one containing the sha1 hash and the other containing the md5 checksum:","text_count":259,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Nothing special so far; the next part of the module is actually where we will create a Readable stream from a file and fork it to two different streams in order to obtain two other files, one containing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sha1"}]},{"block_type":"text","content":"hash and the other containing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"md5"}]},{"block_type":"text","content":"checksum:"}]},{"block_type":"element","block":"k5zy5ba5","search_text":"const inputFile = process.argv[2]; const inputStream = fs.createReadStream(inputFile); inputStream .pipe(sha1Stream) .pipe(fs.createWriteStream(inputFile + '.sha1')); inputStream .pipe(md5Stream) .pipe(fs.createWriteStream(inputFile + '.md5')); ","text_count":245,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const inputFile = process.argv[2]; \nconst inputStream = fs.createReadStream(inputFile); \ninputStream \n  .pipe(sha1Stream) \n  .pipe(fs.createWriteStream(inputFile + '.sha1')); \n \ninputStream \n  .pipe(md5Stream) \n  .pipe(fs.createWriteStream(inputFile + '.md5'));"}]}]},{"block_type":"element","block":"k5zy5ba6","search_text":"Very simple, right? The inputStream variable is piped into sha1Stream on one side and md5Stream on the other. There are a couple of things to note, though, that happen behind the scenes:","text_count":186,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Very simple, right? The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inputStream"}]},{"block_type":"text","content":"variable is piped into"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sha1Stream"}]},{"block_type":"text","content":"on one side and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"md5Stream"}]},{"block_type":"text","content":"on the other. There are a couple of things to note, though, that happen behind the scenes:"}]},{"block_type":"element","block":"k5zy5ba7","search_text":"Both md5Stream and sha1Stream will be ended automatically when inputStream ends, unless we specify {end: false} as an option when invoking pipe() The two forks of the stream will receive the same data chunks, so we must be very careful when performing side-effect operations on the data, as that would affect every stream that we are forking to Back-pressure will work out-of-the-box; the flow coming from inputStream will go as fast as the slowest branch of the fork! ","text_count":469,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Both"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"md5Stream"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sha1Stream"}]},{"block_type":"text","content":"will be ended automatically when"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inputStream"}]},{"block_type":"text","content":"ends, unless we specify"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{end: false}"}]},{"block_type":"text","content":"as an option when invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pipe()"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The two forks of the stream will receive the same data chunks, so we must be very careful when performing side-effect operations on the data, as that would affect every stream that we are forking to"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Back-pressure will work out-of-the-box; the flow coming from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inputStream"}]},{"block_type":"text","content":"will go as fast as the slowest branch of the fork!"}]}]},{"block_type":"element","block":"k5zy5ba8","search_text":"Merging streams","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Merging streams"}]},{"block_type":"element","block":"k5zy5ba9","search_text":"Merging is the opposite operation to forking and consists of piping a set of Readable streams into a single Writable stream, as shown in the following figure:","text_count":158,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Merging is the opposite operation to forking and consists of piping a set of Readable streams into a single Writable stream, as shown in the following figure:"}]},{"block_type":"element","block":"k5zy5baa","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000003.jpg","alt":"Merging streams","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bab","search_text":"Merging multiple streams into one is in general a simple operation; however, we have to pay attention to the way we handle the end event, as piping using the auto end option will cause the destination stream to be ended as soon as one of the sources ends. This can often lead to an error situation, as the other active sources will still continue to write to an already terminated stream. The solution to this problem is to use the option {end: false} when piping multiple sources to a single destination and then invoke end() on the destination only when all the sources have completed reading.","text_count":595,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Merging multiple streams into one is in general a simple operation; however, we have to pay attention to the way we handle the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end"}]},{"block_type":"text","content":"event, as piping using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"auto end"}]},{"block_type":"text","content":"option will cause the destination stream to be ended as soon as one of the sources ends. This can often lead to an error situation, as the other active sources will still continue to write to an already terminated stream. The solution to this problem is to use the option"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{end: false}"}]},{"block_type":"text","content":"when piping multiple sources to a single destination and then invoke"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end()"}]},{"block_type":"text","content":"on the destination only when all the sources have completed reading."}]},{"block_type":"element","block":"k5zy5bac","search_text":"Creating a tarball from multiple directories","text_count":44,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Creating a tarball from multiple directories"}]},{"block_type":"element","block":"k5zy5bad","search_text":"To make a simple example, let's implement a small program that creates a tarball from the contents of two different directories. For this purpose, we are going to introduce two new NPM packages:","text_count":194,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To make a simple example, let's implement a small program that creates a tarball from the contents of two different directories. For this purpose, we are going to introduce two new NPM packages:"}]},{"block_type":"element","block":"k5zy5bae","search_text":"tar ( https://npmjs.org/package/tar ): a streaming library to create tarballs fstream ( https://npmjs.org/package/fstream ): a library to create object streams from filesystem files ","text_count":182,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tar"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/tar"},"children":[{"block_type":"text","content":"https://npmjs.org/package/tar"}]},{"block_type":"text","content":"): a streaming library to create tarballs"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fstream"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/fstream"},"children":[{"block_type":"text","content":"https://npmjs.org/package/fstream"}]},{"block_type":"text","content":"): a library to create object streams from filesystem files"}]}]},{"block_type":"element","block":"k5zy5baf","search_text":"Our new module is going to be called mergeTar.js ; let's define its contents starting from some initialization steps:","text_count":117,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our new module is going to be called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mergeTar.js"}]},{"block_type":"text","content":"; let's define its contents starting from some initialization steps:"}]},{"block_type":"element","block":"k5zy5bag","search_text":"const tar = require('tar'); const fstream = require('fstream'); const path = require('path'); const destination = path.resolve(process.argv[2]); const sourceA = path.resolve(process.argv[3]); const sourceB = path.resolve(process.argv[4]); ","text_count":239,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const tar = require('tar'); \nconst fstream = require('fstream'); \nconst path = require('path'); \n \nconst destination = path.resolve(process.argv[2]); \nconst sourceA = path.resolve(process.argv[3]); \nconst sourceB = path.resolve(process.argv[4]);"}]}]},{"block_type":"element","block":"k5zy5bah","search_text":"In the preceding code, we are just loading all the dependencies and initializing the variables that contain the name of the destination file and the two source directories ( sourceA and sourceB ).","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we are just loading all the dependencies and initializing the variables that contain the name of the destination file and the two source directories ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sourceA"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sourceB"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5bai","search_text":"Next, we will create the tar stream and pipe it into its destination:","text_count":69,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, we will create the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tar"}]},{"block_type":"text","content":"stream and pipe it into its destination:"}]},{"block_type":"element","block":"k5zy5baj","search_text":"const pack = tar.Pack(); pack.pipe(fstream.Writer(destination)); ","text_count":65,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const pack = tar.Pack(); \npack.pipe(fstream.Writer(destination));"}]}]},{"block_type":"element","block":"k5zy5bak","search_text":"Now it's time to initialize the source streams:","text_count":47,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now it's time to initialize the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"source"}]},{"block_type":"text","content":"streams:"}]},{"block_type":"element","block":"k5zy5bal","search_text":"let endCount = 0; function onEnd() { if(++endCount === 2) { pack.end(); } } const sourceStreamA = fstream.Reader({type: \"Directory\", path: sourceA}) .on('end', onEnd); const sourceStreamB = fstream.Reader({type: \"Directory\", path: sourceB}) .on('end', onEnd); ","text_count":260,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"let endCount = 0; \nfunction onEnd() { \n  if(++endCount === 2) { \n    pack.end(); \n  } \n} \n \nconst sourceStreamA = fstream.Reader({type: \"Directory\", path: sourceA}) \n  .on('end', onEnd); \n \nconst sourceStreamB = fstream.Reader({type: \"Directory\", path: sourceB}) \n  .on('end', onEnd);"}]}]},{"block_type":"element","block":"k5zy5bam","search_text":"In the preceding code, we created the streams that read from both the two source directories ( sourceStreamA and sourceStreamB ); then for each source stream we attach an end listener, which will terminate the pack stream only when both the directories are read completely.","text_count":273,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we created the streams that read from both the two source directories ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sourceStreamA"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sourceStreamB"}]},{"block_type":"text","content":"); then for each source stream we attach an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end"}]},{"block_type":"text","content":"listener, which will terminate the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pack"}]},{"block_type":"text","content":"stream only when both the directories are read completely."}]},{"block_type":"element","block":"k5zy5ban","search_text":"Finally, it is time to perform the real merge:","text_count":46,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, it is time to perform the real merge:"}]},{"block_type":"element","block":"k5zy5bao","search_text":"sourceStreamA.pipe(pack, {end: false}); sourceStreamB.pipe(pack, {end: false}); ","text_count":80,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"sourceStreamA.pipe(pack, {end: false}); \nsourceStreamB.pipe(pack, {end: false});"}]}]},{"block_type":"element","block":"k5zy5bap","search_text":"We pipe both the sources into the pack stream and take care to disable the auto ending of the destination stream by providing the option {end: false} to the two pipe() invocations.","text_count":180,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We pipe both the sources into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pack"}]},{"block_type":"text","content":"stream and take care to disable the auto ending of the destination stream by providing the option"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{end: false}"}]},{"block_type":"text","content":"to the two"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pipe()"}]},{"block_type":"text","content":"invocations."}]},{"block_type":"element","block":"k5zy5baq","search_text":"With this, we have completed our simple TAR utility. We can try this utility by providing the destination file as the first command-line argument, followed by the two source directories:","text_count":186,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this, we have completed our simple TAR utility. We can try this utility by providing the destination file as the first command-line argument, followed by the two source directories:"}]},{"block_type":"element","block":"k5zy5bar","search_text":"node mergeTar dest.tar /path/to/sourceA /path/to/sourceB ","text_count":57,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node mergeTar dest.tar /path/to/sourceA /path/to/sourceB"}]}]},{"block_type":"element","block":"k5zy5bas","search_text":"To conclude this section, it's worth mentioning that, on npm, we can find a few modules that can simplify the merging of streams, for example:","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To conclude this section, it's worth mentioning that, on npm, we can find a few modules that can simplify the merging of streams, for example:"}]},{"block_type":"element","block":"k5zy5bat","search_text":"merge-stream ( https://npmjs.org/package/merge-stream ) multistream-merge ( https://npmjs.org/package/multistream-merge ) ","text_count":122,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"merge-stream"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/merge-stream"},"children":[{"block_type":"text","content":"https://npmjs.org/package/merge-stream"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"multistream-merge"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/multistream-merge"},"children":[{"block_type":"text","content":"https://npmjs.org/package/multistream-merge"}]},{"block_type":"text","content":")"}]}]},{"block_type":"element","block":"k5zy5bau","search_text":"As for the last comment on the stream merge pattern, it's worth reminding that the data piped into the destination stream is randomly intermingled; this is a property that can be acceptable in some types of object streams (as we saw in the last example) but it is often an undesired effect when dealing with binary streams.","text_count":323,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As for the last comment on the stream merge pattern, it's worth reminding that the data piped into the destination stream is randomly intermingled; this is a property that can be acceptable in some types of object streams (as we saw in the last example) but it is often an undesired effect when dealing with binary streams."}]},{"block_type":"element","block":"k5zy5bav","search_text":"However, there is one variation of the pattern that allows us to merge streams in order; it consists of consuming the source streams one after the other, when the previous one ends, the next one starts emitting chunks (it is like concatenating the output of all the sources). As always, on NPM we can find some packages that also deal with this situation. One of them is multistream ( https://npmjs.org/package/multistream ).","text_count":425,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, there is one variation of the pattern that allows us to merge streams in order; it consists of consuming the source streams one after the other, when the previous one ends, the next one starts emitting chunks (it is like"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"concatenating"}]},{"block_type":"text","content":"the output of all the sources). As always, on NPM we can find some packages that also deal with this situation. One of them is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"multistream"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/multistream"},"children":[{"block_type":"text","content":"https://npmjs.org/package/multistream"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5baw","search_text":"Multiplexing and demultiplexing","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Multiplexing and demultiplexing"}]},{"block_type":"element","block":"k5zy5bax","search_text":"There is a particular variation of the merge stream pattern in which we don't really want to just join multiple streams together but, instead, use a shared channel to deliver the data of a set of streams. This is a conceptually different operation because the source streams remain logically separated inside the shared channel, which allows us to split the stream again once the data reaches the other end of the shared channel. The following figure clarifies the situation:","text_count":475,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There is a particular variation of the merge stream pattern in which we don't really want to just join multiple streams together but, instead, use a shared channel to deliver the data of a set of streams. This is a conceptually different operation because the source streams remain logically separated inside the shared channel, which allows us to split the stream again once the data reaches the other end of the shared channel. The following figure clarifies the situation:"}]},{"block_type":"element","block":"k5zy5bay","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000044.jpg","alt":"Multiplexing and demultiplexing","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5baz","search_text":"The operation of combining multiple streams together (in this case, also known as channels ) to allow transmission over a single stream is called multiplexing , while the opposite operation, namely reconstructing the original streams from the data received from a shared stream, is called demultiplexing . The devices that perform these operations are called multiplexer (or mux ) and demultiplexer (or demux ) respectively. This is a widely studied area in computer science and telecommunications in general, as it is one of the foundations of almost any type of communication media such as telephony, radio, TV, and of course the Internet itself. For the scope of this book, we will not go too far with the explanations, as this is a vast topic.","text_count":747,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The operation of combining multiple streams together (in this case, also known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"channels"}]},{"block_type":"text","content":") to allow transmission over a single stream is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"multiplexing"}]},{"block_type":"text","content":", while the opposite operation, namely reconstructing the original streams from the data received from a shared stream, is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"demultiplexing"}]},{"block_type":"text","content":". The"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"devices"}]},{"block_type":"text","content":"that perform these operations are called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"multiplexer"}]},{"block_type":"text","content":"(or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"mux"}]},{"block_type":"text","content":") and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"demultiplexer"}]},{"block_type":"text","content":"(or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"demux"}]},{"block_type":"text","content":") respectively. This is a widely studied area in computer science and telecommunications in general, as it is one of the foundations of almost any type of communication media such as telephony, radio, TV, and of course the Internet itself. For the scope of this book, we will not go too far with the explanations, as this is a vast topic."}]},{"block_type":"element","block":"k5zy5bb0","search_text":"What we want to demonstrate in this section, instead, is how it's possible to use a shared Node.js stream in order to convey multiple logically separated streams that are then split again at the other end of the shared stream.","text_count":226,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What we want to demonstrate in this section, instead, is how it's possible to use a shared Node.js stream in order to convey multiple logically separated streams that are then split again at the other end of the shared stream."}]},{"block_type":"element","block":"k5zy5bb1","search_text":"Building a remote logger","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Building a remote logger"}]},{"block_type":"element","block":"k5zy5bb2","search_text":"Let's use an example to drive our discussion. We want to have a small program that starts a child process and redirects both its standard output and standard error to a remote server, which in turn saves the two streams into two separate files. So, in this case, the shared medium is a TCP connection, while the two channels to be multiplexed are the stdout and stderr of a child process. We will leverage a technique called packet switching , the same technique that is used by protocols such as IP, TCP, or UDP and that consists of wrapping the data into packets allowing us to specify various meta information, useful for multiplexing, routing, controlling the flow, checking for corrupted data, and so on. The protocol that we are going to implement for our example is very minimalist; in fact, we will simply wrap our data into packets with the following structure:","text_count":870,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's use an example to drive our discussion. We want to have a small program that starts a child process and redirects both its standard output and standard error to a remote server, which in turn saves the two streams into two separate files. So, in this case, the shared medium is a TCP connection, while the two channels to be multiplexed are the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stdout"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stderr"}]},{"block_type":"text","content":"of a child process. We will leverage a technique called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"packet switching"}]},{"block_type":"text","content":", the same technique that is used by protocols such as IP, TCP, or UDP and that consists of wrapping the data into"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"packets"}]},{"block_type":"text","content":"allowing us to specify various meta information, useful for multiplexing, routing, controlling the flow, checking for corrupted data, and so on. The protocol that we are going to implement for our example is very minimalist; in fact, we will simply wrap our data into packets with the following structure:"}]},{"block_type":"element","block":"k5zy5bb3","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000008.jpg","alt":"Building a remote logger","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bb4","search_text":"As shown in the preceding figure, the packet contains the actual data, but also a header ( Channel ID + Data length ), which will make it possible to differentiate the data of each stream and enable the demultiplexer to route the packet to the right channel.","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As shown in the preceding figure, the packet contains the actual data, but also a header ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Channel ID + Data length"}]},{"block_type":"text","content":"), which will make it possible to differentiate the data of each stream and enable the demultiplexer to route the packet to the right channel."}]},{"block_type":"element","block":"k5zy5bb5","search_text":"Client side – multiplexing","text_count":26,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Client side &ndash; multiplexing"}]},{"block_type":"element","block":"k5zy5bb6","search_text":"Let's start to build our application from the client side. With a lot of creativity, we will call the module client.js ; this represents the part of the application that is responsible for starting a child process and multiplexing its streams.","text_count":243,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start to build our application from the client side. With a lot of creativity, we will call the module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"client.js"}]},{"block_type":"text","content":"; this represents the part of the application that is responsible for starting a child process and multiplexing its streams."}]},{"block_type":"element","block":"k5zy5bb7","search_text":"So, let's start by defining the module. First, we need some dependencies:","text_count":73,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So, let's start by defining the module. First, we need some dependencies:"}]},{"block_type":"element","block":"k5zy5bb8","search_text":"const child_process = require('child_process'); const net = require('net'); ","text_count":76,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const child_process = require('child_process'); \nconst net = require('net');"}]}]},{"block_type":"element","block":"k5zy5bb9","search_text":"Then, let's implement a function that performs the multiplexing of a list of sources:","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, let's implement a function that performs the multiplexing of a list of sources:"}]},{"block_type":"element","block":"k5zy5bba","search_text":"function multiplexChannels(sources, destination) { let totalChannels = sources.length; for(let i = 0; i <sources.length; i++) { sources[i] .on('readable', function() { //[1] let chunk; while((chunk = this.read()) !== null) { const outBuff = new Buffer(1 + 4 + chunk.length); //[2] outBuff.writeUInt8(i, 0); outBuff.writeUInt32BE(chunk.length, 1); chunk.copy(outBuff, 5); console.log('Sending packet to channel: ' + i); destination.write(outBuff); //[3] } } .on('end', () => { //[4] if(--totalChannels === 0) { destination.end(); } }); } } ","text_count":539,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function multiplexChannels(sources, destination) { \n  let totalChannels = sources.length; \n  for(let i = 0; i &lt;sources.length; i++) { \n    sources[i] \n      .on('readable', function() {                           //[1] \n        let chunk; \n        while((chunk = this.read()) !== null) { \n          const outBuff = new Buffer(1 + 4 + chunk.length);  //[2] \n          outBuff.writeUInt8(i, 0);        \n          outBuff.writeUInt32BE(chunk.length, 1); \n          chunk.copy(outBuff, 5); \n          console.log('Sending packet to channel: ' + i); \n          destination.write(outBuff);                        //[3] \n        } \n      } \n      .on('end', () =&gt; {                                     //[4] \n        if(--totalChannels === 0) { \n           destination.end(); \n        } \n      }); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5bbb","search_text":"The multiplexChannels() function takes in as input the source streams to be multiplexed and the destination channel, and then it performs the following steps:","text_count":158,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"multiplexChannels()"}]},{"block_type":"text","content":"function takes in as input the source streams to be multiplexed and the destination channel, and then it performs the following steps:"}]},{"block_type":"element","block":"k5zy5bbc","search_text":"For each source stream, it registers a listener for the readable event where we read the data from the stream using the non-flowing mode. When a chunk is read, we wrap it into a packet that contains in order: 1 byte (UInt8) for the channel ID, 4 bytes (UInt32BE) for the packet size, and then the actual data. When the packet is ready, we write it into the destination stream. Finally, we register a listener for the end event so that we can terminate the destination stream when all the source streams are ended. ","text_count":514,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"For each source stream, it registers a listener for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readable"}]},{"block_type":"text","content":"event where we read the data from the stream using the non-flowing mode."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When a chunk is read, we wrap it into a packet that contains in order: 1 byte (UInt8) for the channel ID, 4 bytes (UInt32BE) for the packet size, and then the actual data."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the packet is ready, we write it into the destination stream."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, we register a listener for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end"}]},{"block_type":"text","content":"event so that we can terminate the destination stream when all the source streams are ended."}]}]},{"block_type":"element","block":"k5zy5bbd","search_text":"Tip Our protocol is to be able to multiplex up to 256 different source streams because we only have 1 byte to identify the channel. ","text_count":132,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our protocol is to be able to multiplex up to 256 different source streams because we only have 1 byte to identify the channel."}]}]},{"block_type":"element","block":"k5zy5bbe","search_text":"Now the last part of our client becomes very easy:","text_count":50,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now the last part of our client becomes very easy:"}]},{"block_type":"element","block":"k5zy5bbf","search_text":"const socket = net.connect(3000, () => { //[1] const child = child_process.fork( //[2] process.argv[2], process.argv.slice(3), {silent: true} ); multiplexChannels([child.stdout, child.stderr], socket); //[3] }); ","text_count":212,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const socket = net.connect(3000, () =&gt; {                    //[1] \n  const child = child_process.fork(                         //[2] \n  process.argv[2], \n  process.argv.slice(3), \n    {silent: true} \n  ); \n  multiplexChannels([child.stdout, child.stderr], socket);  //[3] \n});"}]}]},{"block_type":"element","block":"k5zy5bbg","search_text":"In this last code fragment, we perform the following operations:","text_count":64,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this last code fragment, we perform the following operations:"}]},{"block_type":"element","block":"k5zy5bbh","search_text":"We create a new TCP client connection to the address localhost:3000 . We start the child process by using the first command-line argument as the path, while we provide the rest of the process.argv array as arguments for the child process. We specify the option {silent: true} , so that the child process does not inherit stdout and stderr of the parent. Finally, we take stdout and stderr of the child process and we multiplex them into socket using the mutiplexChannels() function. ","text_count":483,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We create a new TCP client connection to the address"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"localhost:3000"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We start the child process by using the first command-line argument as the path, while we provide the rest of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.argv"}]},{"block_type":"text","content":"array as arguments for the child process. We specify the option"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{silent: true}"}]},{"block_type":"text","content":", so that the child process does not inherit"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stdout"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stderr"}]},{"block_type":"text","content":"of the parent."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, we take"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stdout"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stderr"}]},{"block_type":"text","content":"of the child process and we multiplex them into socket using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mutiplexChannels()"}]},{"block_type":"text","content":"function."}]}]},{"block_type":"element","block":"k5zy5bbi","search_text":"Server side – demultiplexing","text_count":28,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Server side &ndash; demultiplexing"}]},{"block_type":"element","block":"k5zy5bbj","search_text":"Now we can take care of creating the server side of the application ( server.js ), where we demultiplex the streams from the remote connection and pipe them into two different files. Let's start by creating a function called demultiplexChannel() :","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we can take care of creating the server side of the application ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"server.js"}]},{"block_type":"text","content":"), where we demultiplex the streams from the remote connection and pipe them into two different files. Let's start by creating a function called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"demultiplexChannel()"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bbk","search_text":"const net = require('net'); const fs = require('fs'); function demultiplexChannel(source, destinations) { let currentChannel = null; let currentLength = null; source .on('readable', () => { //[1] let chunk; if(currentChannel === null) { //[2] chunk = source.read(1); currentChannel = chunk && chunk.readUInt8(0); } if(currentLength === null) { //[3] chunk = source.read(4); currentLength = chunk && chunk.readUInt32BE(0); if(currentLength === null) { return; } } chunk = source.read(currentLength); //[4] if(chunk === null) { return; } console.log('Received packet from: ' + currentChannel); destinations[currentChannel].write(chunk); //[5] currentChannel = null; currentLength = null; }) .on('end', ()=> { //[6] destinations.forEach(destination => destination.end()); console.log('Source channel closed'); }); } ","text_count":813,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const net = require('net'); \nconst fs = require('fs'); \n \nfunction demultiplexChannel(source, destinations) { \n  let currentChannel = null; \n  let currentLength = null; \n \n  source \n    .on('readable', () =&gt; {                                      //[1] \n      let chunk; \n      if(currentChannel === null) {                              //[2] \n        chunk = source.read(1); \n        currentChannel = chunk && chunk.readUInt8(0); \n      } \n \n      if(currentLength === null) {                               //[3] \n        chunk = source.read(4); \n        currentLength = chunk && chunk.readUInt32BE(0); \n        if(currentLength === null) { \n          return; \n        } \n      } \n \n      chunk = source.read(currentLength);                         //[4] \n      if(chunk === null) { \n        return; \n      } \n      console.log('Received packet from: ' + currentChannel); \n      destinations[currentChannel].write(chunk);                  //[5] \n      currentChannel = null; \n      currentLength = null; \n    }) \n    .on('end', ()=&gt; {                                             //[6] \n      destinations.forEach(destination =&gt; destination.end()); \n      console.log('Source channel closed'); \n    }); \n}"}]}]},{"block_type":"element","block":"k5zy5bbl","search_text":"The preceding code might look complicated but it is not; thanks to the pull nature of Node.js Readable streams, we can easily implement the demultiplexing of our little protocol as follows:","text_count":189,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code might look complicated but it is not; thanks to the pull nature of Node.js Readable streams, we can easily implement the demultiplexing of our little protocol as follows:"}]},{"block_type":"element","block":"k5zy5bbm","search_text":"We start reading from the stream using the non-flowing mode. First, if we have not read the channel ID yet, we try to read 1 byte from the stream and then transform it into a number. The next step is to read the length of the data. We need 4 bytes for that, so it's possible (even if unlikely) that we don't have enough data in the internal buffer, which will cause the this.read() invocation to return null. In such a case, we simply interrupt the parsing and retry at the next readable event. When we finally can also read the data size, we know how much data to pull from the internal buffer, so we try to read it all. When we read all the data, we can write it to the right destination channel, making sure that we reset the currentChannel and currentLength variables (these will be used to parse the next packet). Lastly, we make sure to end all the destination channels when the source channel ends. ","text_count":906,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We start reading from the stream using the non-flowing mode."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, if we have not read the channel ID yet, we try to read 1 byte from the stream and then transform it into a number."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The next step is to read the length of the data. We need 4 bytes for that, so it's possible (even if unlikely) that we don't have enough data in the internal buffer, which will cause the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this.read()"}]},{"block_type":"text","content":"invocation to return null. In such a case, we simply interrupt the parsing and retry at the next"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readable"}]},{"block_type":"text","content":"event."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When we finally can also read the data size, we know how much data to pull from the internal buffer, so we try to read it all."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When we read all the data, we can write it to the right destination channel, making sure that we reset the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"currentChannel"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"currentLength"}]},{"block_type":"text","content":"variables (these will be used to parse the next packet)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Lastly, we make sure to end all the destination channels when the source channel ends."}]}]},{"block_type":"element","block":"k5zy5bbn","search_text":"Now that we can demultiplex the source stream, let's put our new function to work:","text_count":82,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we can demultiplex the source stream, let's put our new function to work:"}]},{"block_type":"element","block":"k5zy5bbo","search_text":"net.createServer(socket => { const stdoutStream = fs.createWriteStream('stdout.log'); const stderrStream = fs.createWriteStream('stderr.log'); demultiplexChannel(socket, [stdoutStream, stderrStream]); }).listen(3000, () => console.log('Server started')); ","text_count":255,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"net.createServer(socket =&gt; { \n  const stdoutStream = fs.createWriteStream('stdout.log'); \n  const stderrStream = fs.createWriteStream('stderr.log');  \n  demultiplexChannel(socket, [stdoutStream, stderrStream]); \n}).listen(3000, () =&gt; console.log('Server started'));"}]}]},{"block_type":"element","block":"k5zy5bbp","search_text":"In the preceding code, we first start a TCP server on the port 3000 , then for each connection that we receive, we will create two Writable streams pointing to two different files, one for the standard output and another for the standard error; these are our destination channels. Finally, we use demultiplexChannel() to demultiplex the socket stream into stdoutStream and stderrStream .","text_count":387,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we first start a TCP server on the port"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"3000"}]},{"block_type":"text","content":", then for each connection that we receive, we will create two Writable streams pointing to two different files, one for the standard output and another for the standard error; these are our destination channels. Finally, we use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"demultiplexChannel()"}]},{"block_type":"text","content":"to demultiplex the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"socket"}]},{"block_type":"text","content":"stream into"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stdoutStream"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stderrStream"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bbq","search_text":"Running the mux/demux application","text_count":33,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Running the mux/demux application"}]},{"block_type":"element","block":"k5zy5bbr","search_text":"Now, we are ready to try our new mux/demux application, but first let's create a small Node.js program to produce some sample output; let's call it generateData.js :","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, we are ready to try our new mux/demux application, but first let's create a small Node.js program to produce some sample output; let's call it"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"generateData.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bbs","search_text":"console.log(\"out1\"); console.log(\"out2\"); console.error(\"err1\"); console.log(\"out3\"); console.error(\"err2\"); ","text_count":109,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"console.log(\"out1\"); \nconsole.log(\"out2\"); \nconsole.error(\"err1\"); \nconsole.log(\"out3\"); \nconsole.error(\"err2\");"}]}]},{"block_type":"element","block":"k5zy5bbt","search_text":"Okay, now we are ready to try our remote logging application. First, let's start the server:","text_count":92,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Okay, now we are ready to try our remote logging application. First, let's start the server:"}]},{"block_type":"element","block":"k5zy5bbu","search_text":"node server ","text_count":12,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node server"}]}]},{"block_type":"element","block":"k5zy5bbv","search_text":"Then the client, by providing the file that we want to start as child process:","text_count":78,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then the client, by providing the file that we want to start as child process:"}]},{"block_type":"element","block":"k5zy5bbw","search_text":"node client generateData.js ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node client generateData.js"}]}]},{"block_type":"element","block":"k5zy5bbx","search_text":"The client will run almost immediately, but at the end of the process the standard input and standard output of the generateData application have traveled through one single TCP connection and then, on the server, have been demultiplexed into two separate files.","text_count":262,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The client will run almost immediately, but at the end of the process the standard input and standard output of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"generateData"}]},{"block_type":"text","content":"application have traveled through one single TCP connection and then, on the server, have been demultiplexed into two separate files."}]},{"block_type":"element","block":"k5zy5bby","search_text":"Note Please make a note that, as we are using child_process.fork() ( http://nodejs.org/api/child_process.html#child_process_child_process_fork_modulepath_args_options ), our client will be able to launch only other Node.js modules. ","text_count":232,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Please make a note that, as we are using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nodejs.org/api/child_process.html#child_process_child_process_fork_modulepath_args_options"},"children":[{"block_type":"text","content":"http://nodejs.org/api/child_process.html#child_process_child_process_fork_modulepath_args_options"}]},{"block_type":"text","content":"), our client will be able to launch only other Node.js modules."}]}]},{"block_type":"element","block":"k5zy5bbz","search_text":"Multiplexing and demultiplexing object streams","text_count":46,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Multiplexing and demultiplexing object streams"}]},{"block_type":"element","block":"k5zy5bc0","search_text":"The example that we have just shown demonstrated how to multiplex and demultiplex a binary/text stream, but it's worth mentioning that the same rules apply also to object streams. The greatest difference is that, using objects, we already have a way to transmit the data using atomic messages (the objects), so multiplexing would be as easy as setting a property channelID into each object, while demultiplexing would simply involve reading the channelID property and routing each object towards the right destination stream.","text_count":525,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The example that we have just shown demonstrated how to multiplex and demultiplex a binary/text stream, but it's worth mentioning that the same rules apply also to object streams. The greatest difference is that, using objects, we already have a way to transmit the data using atomic messages (the objects), so multiplexing would be as easy as setting a property"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"channelID"}]},{"block_type":"text","content":"into each object, while demultiplexing would simply involve reading the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"channelID"}]},{"block_type":"text","content":"property and routing each object towards the right destination stream."}]},{"block_type":"element","block":"k5zy5bc1","search_text":"Another pattern involving only demultiplexing consists of routing the data coming from a source depending on some condition. With this pattern, we can implement complex flows, such as the one shown in the following diagram:","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another pattern involving only demultiplexing consists of routing the data coming from a source depending on some condition. With this pattern, we can implement complex flows, such as the one shown in the following diagram:"}]},{"block_type":"element","block":"k5zy5bc2","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000046.jpg","alt":"Multiplexing and demultiplexing object streams","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bc3","search_text":"The demultiplexer used in the system described by the preceding diagram, takes a stream of objects representing animals and distributes each of them to the right destination stream based on the class of the animal: reptiles , amphibians , and mammals .","text_count":252,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The demultiplexer used in the system described by the preceding diagram, takes a stream of objects representing"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"animals"}]},{"block_type":"text","content":"and distributes each of them to the right destination stream based on the class of the animal:"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"reptiles"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"amphibians"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"mammals"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bc4","search_text":"Using the same principle, we can also implement an if...else statement for streams; for some inspiration, take a look at the ternary-stream package ( https://npmjs.org/package/ternary-stream ) that allows us to do exactly that.","text_count":227,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using the same principle, we can also implement an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if...else"}]},{"block_type":"text","content":"statement for streams; for some inspiration, take a look at the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ternary-stream"}]},{"block_type":"text","content":"package ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/ternary-stream"},"children":[{"block_type":"text","content":"https://npmjs.org/package/ternary-stream"}]},{"block_type":"text","content":") that allows us to do exactly that."}]},{"block_type":"element","block":"k5zy5bc5","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5bc6","search_text":"In this chapter, we have shed some light on Node.js streams and their use case, but at the same time this should have thrown open a door to a programming paradigm with virtually unlimited possibilities. We learned why streams are so acclaimed by the Node.js community and we mastered their basic functionality, enabling us to discover more and navigate comfortably in this new world. We analyzed some advanced patterns and started to understand how to connect streams together in different configurations, grasping the importance of interoperability which is what makes streams so versatile and powerful.","text_count":604,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we have shed some light on Node.js streams and their use case, but at the same time this should have thrown open a door to a programming paradigm with virtually unlimited possibilities. We learned why streams are so acclaimed by the Node.js community and we mastered their basic functionality, enabling us to discover more and navigate comfortably in this new world. We analyzed some advanced patterns and started to understand how to connect streams together in different configurations, grasping the importance of interoperability which is what makes streams so versatile and powerful."}]},{"block_type":"element","block":"k5zy5bc7","search_text":"If we can't do something with one stream, we probably can do it by connecting other streams together, and this works great with the one thing per module philosophy. At this point, it should be clear that streams are not just a good to know feature of Node.js; they are, instead, an essential part of this, a crucial pattern to handle binary data, strings, and objects. It's not by chance that an entire chapter was dedicated to them.","text_count":433,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we can't do something with one stream, we probably can do it by connecting other streams together, and this works great with the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"one thing per module"}]},{"block_type":"text","content":"philosophy. At this point, it should be clear that streams are not just a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"good to know"}]},{"block_type":"text","content":"feature of Node.js; they are, instead, an essential part of this, a crucial pattern to handle binary data, strings, and objects. It's not by chance that an entire chapter was dedicated to them."}]},{"block_type":"element","block":"k5zy5bc8","search_text":"In the next chapter, we will focus on the traditional object-oriented design patterns. But don't be fooled; even though JavaScript is to some extent an object-oriented language, in Node.js the functional or hybrid approach is often preferred. Get rid of every prejudice before reading the next chapter.","text_count":302,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter, we will focus on the traditional object-oriented design patterns. But don't be fooled; even though JavaScript is to some extent an object-oriented language, in Node.js the functional or hybrid approach is often preferred. Get rid of every prejudice before reading the next chapter."}]}]},{"title":"Design Patterns","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4moz","number":6,"contents":[{"block_type":"element","block":"k5zy5bc9","search_text":"A design pattern is a reusable solution to a recurring problem; the term is really broad in its definition and can span multiple domains of an application. However, the term is often associated with a well-known set of object-oriented patterns that were popularized in the 90s by the book, Design Patterns: Elements of Reusable Object-Oriented Software , Pearson Education , by the almost legendary Gang of Four ( GoF ): Erich Gamma, Richard Helm, Ralph Johnson, and John Vlissides. We will often refer to these specific sets of patterns as traditional design patterns, or GoF design patterns.","text_count":593,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A design pattern is a reusable solution to a recurring problem; the term is really broad in its definition and can span multiple domains of an application. However, the term is often associated with a well-known set of object-oriented patterns that were popularized in the 90s by the book,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Design Patterns: Elements of Reusable Object-Oriented Software"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Pearson Education"}]},{"block_type":"text","content":", by the almost legendary"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Gang of Four"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"GoF"}]},{"block_type":"text","content":"): Erich Gamma, Richard Helm, Ralph Johnson, and John Vlissides. We will often refer to these specific sets of patterns as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"traditional"}]},{"block_type":"text","content":"design patterns, or GoF design patterns."}]},{"block_type":"element","block":"k5zy5bca","search_text":"Applying this set of object-oriented design patterns in JavaScript is not as linear and formal as it would be in a classical object-oriented language. As we know, JavaScript is multi-paradigm, object-oriented, and prototype-based, and has dynamic typing; it treats functions as first-class citizens, and allows functional programming styles. These characteristics make JavaScript a very versatile language, which gives tremendous power to the developer but at the same time it causes a fragmentation of programming styles, conventions, techniques, and ultimately the patterns of its ecosystem. There are so many ways to achieve the same result using JavaScript that everybody has their own opinion on what the best way is to approach a problem. A clear demonstration of this phenomenon is the abundance of frameworks and opinionated libraries in the JavaScript ecosystem; probably no other language has ever seen so many, especially now that Node.js has given new astonishing possibilities to JavaScript and has created so many new scenarios.","text_count":1042,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Applying this set of object-oriented design patterns in JavaScript is not as linear and formal as it would be in a classical object-oriented language. As we know, JavaScript is multi-paradigm, object-oriented, and prototype-based, and has dynamic typing; it treats functions as first-class citizens, and allows functional programming styles. These characteristics make JavaScript a very versatile language, which gives tremendous power to the developer but at the same time it causes a fragmentation of programming styles, conventions, techniques, and ultimately the patterns of its ecosystem. There are so many ways to achieve the same result using JavaScript that everybody has their own opinion on what the best way is to approach a problem. A clear demonstration of this phenomenon is the abundance of frameworks and opinionated libraries in the JavaScript ecosystem; probably no other language has ever seen so many, especially now that Node.js has given new astonishing possibilities to JavaScript and has created so many new scenarios."}]},{"block_type":"element","block":"k5zy5bcb","search_text":"In this context, the traditional design patterns are affected by the nature of JavaScript too. There are so many ways in which they can be implemented that their traditional, strongly object-oriented implementation means they cease to be patterns. In some cases, they are not even possible, because JavaScript, as we know, doesn't have real classes or abstract interfaces. What doesn't change though is the original idea at the base of each pattern, the problem it solves, and the concepts at the heart of the solution.","text_count":519,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this context, the traditional design patterns are affected by the nature of JavaScript too. There are so many ways in which they can be implemented that their traditional, strongly object-oriented implementation means they cease to be patterns. In some cases, they are not even possible, because JavaScript, as we know, doesn't have"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"real"}]},{"block_type":"text","content":"classes or abstract interfaces. What doesn't change though is the original idea at the base of each pattern, the problem it solves, and the concepts at the heart of the solution."}]},{"block_type":"element","block":"k5zy5bcc","search_text":"In this chapter, we will see how some of the most important GoF design patterns apply to Node.js and its philosophy, thus rediscovering their importance from another perspective. Among these traditional patterns, we will also have a look at some \"less traditional\" design patterns generated within the JavaScript ecosystem.","text_count":323,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will see how some of the most important GoF design patterns apply to Node.js and its philosophy, thus rediscovering their importance from another perspective. Among these traditional patterns, we will also have a look at some \"less traditional\" design patterns generated within the JavaScript ecosystem."}]},{"block_type":"element","block":"k5zy5bcd","search_text":"The design patterns explored in this chapter are as follows:","text_count":60,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The design patterns explored in this chapter are as follows:"}]},{"block_type":"element","block":"k5zy5bce","search_text":"Factory Revealing constructor Proxy Decorator Adapter Strategy State Template Middleware Command ","text_count":97,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Factory"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Revealing constructor"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Proxy"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Decorator"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Adapter"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Strategy"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"State"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Template"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Middleware"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Command"}]}]},{"block_type":"element","block":"k5zy5bcf","search_text":"Note This chapter assumes that the reader has some notion of how inheritance works in JavaScript. Please also be advised that throughout this chapter we will often use generic and more intuitive diagrams to describe a pattern in place of standard UML, since many patterns can have an implementation based not only on classes, but also on objects and even functions. ","text_count":366,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This chapter assumes that the reader has some notion of how inheritance works in JavaScript. Please also be advised that throughout this chapter we will often use generic and more intuitive diagrams to describe a pattern in place of standard UML, since many patterns can have an implementation based not only on classes, but also on objects and even functions."}]}]},{"block_type":"element","block":"k5zy5bcg","search_text":"Factory","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Factory"}]},{"block_type":"element","block":"k5zy5bch","search_text":"We begin our journey starting from what is probably the most simple and common design pattern in Node.js: factory .","text_count":115,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We begin our journey starting from what is probably the most simple and common design pattern in Node.js:"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"factory"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bci","search_text":"A generic interface for creating objects","text_count":40,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"A generic interface for creating objects"}]},{"block_type":"element","block":"k5zy5bcj","search_text":"We already stressed the fact that, in JavaScript, the functional paradigm is often preferred to a purely object-oriented design, for its simplicity, usability, and small surface area . This is especially true when creating new object instances. In fact, invoking a factory, instead of directly creating a new object from a prototype using the new operator or Object.create() , is so much more convenient and flexible in several respects.","text_count":437,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We already stressed the fact that, in JavaScript, the functional paradigm is often preferred to a purely object-oriented design, for its simplicity, usability, and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"small surface area"}]},{"block_type":"text","content":". This is especially true when creating new object instances. In fact, invoking a factory, instead of directly creating a new object from a prototype using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":"operator or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Object.create()"}]},{"block_type":"text","content":", is so much more convenient and flexible in several respects."}]},{"block_type":"element","block":"k5zy5bck","search_text":"First and foremost, a factory allows us to separate the object creation from its implementation; essentially, a factory wraps the creation of a new instance giving us more flexibility and control in the way we do it. Inside the factory, we can create a new instance leveraging closures, using a prototype and the new operator, using Object.create() , or even returning a different instance based on a particular condition. The consumer of the factory is totally agnostic about how the creation of the instance is carried out. The truth is that, by using new , we are binding our code to one specific way of creating an object, while in JavaScript we can have much more flexibility, almost for free. As a quick example, let's consider a simple factory that creates an Image object:","text_count":780,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First and foremost, a factory allows us to separate the object creation from its implementation; essentially, a factory wraps the creation of a new instance giving us more flexibility and control in the way we do it. Inside the factory, we can create a new instance leveraging closures, using a prototype and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":"operator, using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Object.create()"}]},{"block_type":"text","content":", or even returning a different instance based on a particular condition. The consumer of the factory is totally agnostic about how the creation of the instance is carried out. The truth is that, by using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":", we are binding our code to one specific way of creating an object, while in JavaScript we can have much more flexibility, almost for free. As a quick example, let's consider a simple factory that creates an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Image"}]},{"block_type":"text","content":"object:"}]},{"block_type":"element","block":"k5zy5bcl","search_text":"function createImage(name) { return new Image(name); } const image = createImage('photo.jpeg'); ","text_count":96,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function createImage(name) { \n  return new Image(name); \n} \nconst image = createImage('photo.jpeg');"}]}]},{"block_type":"element","block":"k5zy5bcm","search_text":"The createImage() factory might look totally unnecessary; why not instantiate the Image class by using the new operator directly? Something like the following line of code:","text_count":172,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"createImage()"}]},{"block_type":"text","content":"factory might look totally unnecessary; why not instantiate the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Image"}]},{"block_type":"text","content":"class by using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":"operator directly? Something like the following line of code:"}]},{"block_type":"element","block":"k5zy5bcn","search_text":"const image = new Image(name); ","text_count":31,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const image = new Image(name);"}]}]},{"block_type":"element","block":"k5zy5bco","search_text":"As we already mentioned, using new binds our code to one particular type of object; in the preceding case, to objects of type Image . A factory instead gives us much more flexibility; imagine that we want to refactor the Image class, splitting it into smaller classes, one for each image format that we support. If we exposed a factory as the only means to create new images, we can simply rewrite it as follows, without breaking any of the existing code:","text_count":455,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we already mentioned, using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":"binds our code to one particular type of object; in the preceding case, to objects of type"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Image"}]},{"block_type":"text","content":". A factory instead gives us much more flexibility; imagine that we want to refactor the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Image"}]},{"block_type":"text","content":"class, splitting it into smaller classes, one for each image format that we support. If we exposed a factory as the only means to create new images, we can simply rewrite it as follows, without breaking any of the existing code:"}]},{"block_type":"element","block":"k5zy5bcp","search_text":"function createImage(name) { if(name.match(/\\.jpeg$/)) { return new JpegImage(name); } else if(name.match(/\\.gif$/)) { return new GifImage(name); } else if(name.match(/\\.png$/)) { return new PngImage(name); } else { throw new Exception('Unsupported format'); } } ","text_count":263,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function createImage(name) { \n  if(name.match(/\\.jpeg$/)) { \n    return new JpegImage(name); \n  } else if(name.match(/\\.gif$/)) { \n    return new GifImage(name); \n  } else if(name.match(/\\.png$/)) { \n    return new PngImage(name); \n  } else { \n    throw new Exception('Unsupported format'); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5bcq","search_text":"Our factory also allows us to not expose the constructors of the objects it creates, and prevents them from being extended or modified (remember the principle of small surface area?). In Node.js, this can be achieved by exporting only the factory, while keeping each constructor private.","text_count":287,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our factory also allows us to not expose the constructors of the objects it creates, and prevents them from being extended or modified (remember the principle of small surface area?). In Node.js, this can be achieved by exporting only the factory, while keeping each constructor private."}]},{"block_type":"element","block":"k5zy5bcr","search_text":"A mechanism to enforce encapsulation","text_count":36,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"A mechanism to enforce encapsulation"}]},{"block_type":"element","block":"k5zy5bcs","search_text":"A factory can also be used as an encapsulation mechanism, thanks to closures.","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A factory can also be used as an encapsulation mechanism, thanks to closures."}]},{"block_type":"element","block":"k5zy5bct","search_text":"Note Encapsulation refers to the technique of controlling the access to some internal details of an object by preventing the external code from manipulating them directly. The interaction with the object happens only through its public interface, isolating the external code from the changes in the implementation details of the object. This practice is also referred to as information hiding . Encapsulation is also a fundamental principle of object-oriented design, together with inheritance, polymorphism, and abstraction. ","text_count":526,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Encapsulation"}]},{"block_type":"text","content":"refers to the technique of controlling the access to some internal details of an object by preventing the external code from manipulating them directly. The interaction with the object happens only through its public interface, isolating the external code from the changes in the implementation details of the object. This practice is also referred to as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"information hiding"}]},{"block_type":"text","content":". Encapsulation is also a fundamental principle of object-oriented design, together with inheritance, polymorphism, and abstraction."}]}]},{"block_type":"element","block":"k5zy5bcu","search_text":"As we know, in JavaScript, we don't have access level modifiers (for example, we can't declare a private variable), so the only way to enforce encapsulation is through function scopes and closures. A factory makes it straightforward to enforce private variables; consider the following code for example:","text_count":303,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we know, in JavaScript, we don't have"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"access level modifiers"}]},{"block_type":"text","content":"(for example, we can't declare a private variable), so the only way to enforce encapsulation is through function scopes and closures. A factory makes it straightforward to enforce private variables; consider the following code for example:"}]},{"block_type":"element","block":"k5zy5bcv","search_text":"function createPerson(name) { const privateProperties = {}; const person = { setName: name => { if(!name) throw new Error('A person must have a name'); privateProperties.name = name; }, getName: () => { return privateProperties.name; } }; person.setName(name); return person; } ","text_count":278,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function createPerson(name) { \n  const privateProperties = {}; \n \n  const person = { \n    setName: name =&gt; { \n      if(!name) throw new Error('A person must have a name'); \n      privateProperties.name = name; \n    }, \n    getName: () =&gt; { \n      return privateProperties.name; \n    } \n  }; \n \n  person.setName(name); \n  return person; \n}"}]}]},{"block_type":"element","block":"k5zy5bcw","search_text":"In the preceding code, we leverage closures to create two objects: a person object which represents the public interface returned by the factory, and a group of privateProperties that are inaccessible from the outside and that can be manipulated only through the interface provided by the person object. For example, in the preceding code, we make sure that a person's name is never empty; this would not be possible to enforce if name was just a property of the person object.","text_count":477,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we leverage closures to create two objects: a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"person"}]},{"block_type":"text","content":"object which represents the public interface returned by the factory, and a group of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"privateProperties"}]},{"block_type":"text","content":"that are inaccessible from the outside and that can be manipulated only through the interface provided by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"person"}]},{"block_type":"text","content":"object. For example, in the preceding code, we make sure that a person's"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"name"}]},{"block_type":"text","content":"is never empty; this would not be possible to enforce if"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"name"}]},{"block_type":"text","content":"was just a property of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"person"}]},{"block_type":"text","content":"object."}]},{"block_type":"element","block":"k5zy5bcx","search_text":"Note Factories are only one of the techniques that we have for creating private members; in fact, other possible approaches are as follows: Defining private variables in a constructor (as recommended by Douglas Crockford: http://javascript.crockford.com/private.html ). Using conventions, for example, prefixing the name of a property with an underscore \" _ \" or the dollar sign \" $ \" (this however, does not technically prevent a member from being accessed from the outside) Using ES2015 WeakMaps: ( http://fitzgeraldnick.com/weblog/53/ ). A very complete article on this subject was published by Mozilla: https://developer.mozilla.org/en-US/Add-ons/SDK/Guides/Contributor_s_Guide/Private_Properties. ","text_count":702,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Factories are only one of the techniques that we have for creating private members; in fact, other possible approaches are as follows:"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Defining private variables in a constructor (as recommended by Douglas Crockford:"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://javascript.crockford.com/private.html"},"children":[{"block_type":"text","content":"http://javascript.crockford.com/private.html"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using conventions, for example, prefixing the name of a property with an underscore \""},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_"}]},{"block_type":"text","content":"\" or the dollar sign \""},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"$"}]},{"block_type":"text","content":"\" (this however, does not technically prevent a member from being accessed from the outside)"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using ES2015 WeakMaps: ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://fitzgeraldnick.com/weblog/53/"},"children":[{"block_type":"text","content":"http://fitzgeraldnick.com/weblog/53/"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A very complete article on this subject was published by Mozilla:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://developer.mozilla.org/en-US/Add-ons/SDK/Guides/Contributor_s_Guide/Private_Properties"},"children":[{"block_type":"text","content":"https://developer.mozilla.org/en-US/Add-ons/SDK/Guides/Contributor_s_Guide/Private_Properties."}]}]}]},{"block_type":"element","block":"k5zy5bcy","search_text":"Building a simple code profiler","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Building a simple code profiler"}]},{"block_type":"element","block":"k5zy5bcz","search_text":"Now, let's work on a complete example using a factory. Let's build a simple code profiler , an object with the following properties:","text_count":132,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's work on a complete example using a factory. Let's build a simple"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"code profiler"}]},{"block_type":"text","content":", an object with the following properties:"}]},{"block_type":"element","block":"k5zy5bd0","search_text":"A start() method that triggers the start of a profiling session An end() method to terminate the session and log its execution time to the console ","text_count":147,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"start()"}]},{"block_type":"text","content":"method that triggers the start of a profiling session"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"An"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end()"}]},{"block_type":"text","content":"method to terminate the session and log its execution time to the console"}]}]},{"block_type":"element","block":"k5zy5bd1","search_text":"Let's start by creating a file named profiler.js , which will have the following content:","text_count":89,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start by creating a file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"profiler.js"}]},{"block_type":"text","content":", which will have the following content:"}]},{"block_type":"element","block":"k5zy5bd2","search_text":"class Profiler { constructor(label) { this.label = label; this.lastTime = null; } start() { this.lastTime = process.hrtime(); } end() { const diff = process.hrtime(this.lastTime); console.log( `Timer \"${this.label}\" took ${diff[0]} seconds and ${diff[1]} nanoseconds.` ); } } ","text_count":276,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class Profiler { \n  constructor(label) { \n    this.label = label; \n    this.lastTime = null; \n  } \n \n  start() { \n    this.lastTime = process.hrtime(); \n  } \n \n  end() { \n    const diff = process.hrtime(this.lastTime); \n    console.log( \n      `Timer \"${this.label}\" took ${diff[0]} seconds and ${diff[1]} \n        nanoseconds.` \n    ); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5bd3","search_text":"There is nothing fancy in the preceding class; we simply use the default high resolution timer to save the current time when start() is invoked, and then calculate the elapsed time when end() is executed, printing the result to the console.","text_count":240,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There is nothing fancy in the preceding class; we simply use the default high resolution timer to save the current time when"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"start()"}]},{"block_type":"text","content":"is invoked, and then calculate the elapsed time when"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end()"}]},{"block_type":"text","content":"is executed, printing the result to the console."}]},{"block_type":"element","block":"k5zy5bd4","search_text":"Now, if we are going to use such a profiler in a real-world application to calculate the execution time of the different routines, we can easily imagine the huge amount of logging we will generate to the standard output, especially in a production environment. What we might want to do instead is redirect the profiling information to another source, for example, a database, or alternatively, disable the profiler altogether if the application is running in production mode. It's clear that if we were to instantiate a Profiler object directly by using the new operator, we would need some extra logic in the client code or in the Profiler object itself in order to switch between the different logics. We can instead use a factory to abstract the creation of the Profiler object, so that, depending on whether the application runs in production or development mode, we can return a fully working Profiler object, or alternatively, a mock object with the same interface, but with empty methods. Let's do this then in the profiler.js module, instead of exporting the Profiler constructor, we will export only a function, our factory. The following is its code:","text_count":1160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, if we are going to use such a profiler in a real-world application to calculate the execution time of the different routines, we can easily imagine the huge amount of logging we will generate to the standard output, especially in a production environment. What we might want to do instead is redirect the profiling information to another source, for example, a database, or alternatively, disable the profiler altogether if the application is running in production mode. It's clear that if we were to instantiate a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Profiler"}]},{"block_type":"text","content":"object directly by using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":"operator, we would need some extra logic in the client code or in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Profiler"}]},{"block_type":"text","content":"object itself in order to switch between the different logics. We can instead use a factory to abstract the creation of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Profiler"}]},{"block_type":"text","content":"object, so that, depending on whether the application runs in production or development mode, we can return a fully working"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Profiler"}]},{"block_type":"text","content":"object, or alternatively, a mock object with the same interface, but with empty methods. Let's do this then in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"profiler.js"}]},{"block_type":"text","content":"module, instead of exporting the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Profiler"}]},{"block_type":"text","content":"constructor, we will export only a function, our factory. The following is its code:"}]},{"block_type":"element","block":"k5zy5bd5","search_text":"module.exports = function(label) { if(process.env.NODE_ENV === 'development') { return new Profiler(label); //[1] } else if(process.env.NODE_ENV === 'production') { return { //[2] start: function() {}, end: function() {} } } else { throw new Error('Must set NODE_ENV'); } }; ","text_count":275,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = function(label) { \n  if(process.env.NODE_ENV === 'development') { \n    return new Profiler(label);                       //[1] \n  } else if(process.env.NODE_ENV === 'production') { \n    return {                                          //[2] \n      start: function() {}, \n      end: function() {} \n    } \n  } else { \n    throw new Error('Must set NODE_ENV'); \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5bd6","search_text":"The factory that we created abstracts the creation of a Profiler object from its implementation:","text_count":96,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The factory that we created abstracts the creation of a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Profiler"}]},{"block_type":"text","content":"object from its implementation:"}]},{"block_type":"element","block":"k5zy5bd7","search_text":"If the application is running in development mode, we return a new, fully functional Profiler object If instead the application is running in production mode, we return a mock object where the start() and stop() methods are empty functions ","text_count":240,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If the application is running in development mode, we return a new, fully functional"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Profiler"}]},{"block_type":"text","content":"object"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If instead the application is running in production mode, we return a mock object where the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"start()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stop()"}]},{"block_type":"text","content":"methods are empty functions"}]}]},{"block_type":"element","block":"k5zy5bd8","search_text":"The nice feature to highlight is that, thanks to JavaScript dynamic typing, we were able to return an object instantiated with the new operator in one circumstance and a simple object literal in the other (this is also known as duck typing https://en.wikipedia.org/wiki/Duck_typing ). Our factory is doing its job perfectly; we really can create objects in any way that we like inside the factory function, and we can execute additional initialization steps or return a different type of object based on particular conditions, and all of this while isolating the consumer of the object from all these details. We can easily understand the power of this simple pattern.","text_count":668,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The nice feature to highlight is that, thanks to JavaScript dynamic typing, we were able to return an object instantiated with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":"operator in one circumstance and a simple object literal in the other (this is also known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"duck typing"}]},{"block_type":"element","tag_name":"a","attributes":{"href":"https://en.wikipedia.org/wiki/Duck_typing"},"children":[{"block_type":"text","content":"https://en.wikipedia.org/wiki/Duck_typing"}]},{"block_type":"text","content":"). Our factory is doing its job perfectly; we really can create objects in any way that we like inside the factory function, and we can execute additional initialization steps or return a different type of object based on particular conditions, and all of this while isolating the consumer of the object from all these details. We can easily understand the power of this simple pattern."}]},{"block_type":"element","block":"k5zy5bd9","search_text":"Now we can play with our profiler; this is a possible use case for the factory that we just created earlier:","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we can play with our profiler; this is a possible use case for the factory that we just created earlier:"}]},{"block_type":"element","block":"k5zy5bda","search_text":"const profiler = require('./profiler'); function getRandomArray(len) { const p = profiler('Generating a ' + len + ' items long array'); p.start(); const arr = []; for(let i = 0; i < len; i++) { arr.push(Math.random()); } p.end(); } getRandomArray(1e6); console.log('Done'); ","text_count":274,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const profiler = require('./profiler'); \n \nfunction getRandomArray(len) { \n  const p = profiler('Generating a ' + len + ' items long array'); \n  p.start(); \n  const arr = []; \n  for(let i = 0; i &lt; len; i++) { \n    arr.push(Math.random()); \n  } \n  p.end(); \n} \n \ngetRandomArray(1e6); \nconsole.log('Done');"}]}]},{"block_type":"element","block":"k5zy5bdb","search_text":"The p variable contains the instance of our Profiler object, but we don't know how it's created and what its implementation is at this point in the code.","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"p"}]},{"block_type":"text","content":"variable contains the instance of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Profiler"}]},{"block_type":"text","content":"object, but we don't know how it's created and what its implementation is at this point in the code."}]},{"block_type":"element","block":"k5zy5bdc","search_text":"If we include the preceding code in a file named profilerTest.js , we can easily test these assumptions. To try the program with profiling enabled, run the following command:","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we include the preceding code in a file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"profilerTest.js"}]},{"block_type":"text","content":", we can easily test these assumptions. To try the program with profiling enabled, run the following command:"}]},{"block_type":"element","block":"k5zy5bdd","search_text":"export NODE_ENV=development; node profilerTest ","text_count":47,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"export NODE_ENV=development; node profilerTest"}]}]},{"block_type":"element","block":"k5zy5bde","search_text":"The preceding command enables the real profiler and prints the profiling information to the console. If we want to try the mock profiler instead, we can run the following command:","text_count":179,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding command enables the real profiler and prints the profiling information to the console. If we want to try the mock profiler instead, we can run the following command:"}]},{"block_type":"element","block":"k5zy5bdf","search_text":"export NODE_ENV=production; node profilerTest ","text_count":46,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"export NODE_ENV=production; node profilerTest"}]}]},{"block_type":"element","block":"k5zy5bdg","search_text":"The example that we just presented is just a simple application of the factory function pattern, but it clearly shows the advantages of separating an object's creation from its implementation.","text_count":192,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The example that we just presented is just a simple application of the factory function pattern, but it clearly shows the advantages of separating an object's creation from its implementation."}]},{"block_type":"element","block":"k5zy5bdh","search_text":"Composable factory functions","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Composable factory functions"}]},{"block_type":"element","block":"k5zy5bdi","search_text":"Now that we have a good idea about how factory functions can be implemented in Node.js, we are ready to introduce a new advanced pattern that has recently been getting traction in the JavaScript community. We are talking about composable factory functions , which represent a particular type of factory function that can be \"composed\" together to build new enhanced factory functions. They are especially useful for allowing us to construct objects that \"inherit\" behaviors and properties from different sources without the need for building complex class hierarchies.","text_count":568,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have a good idea about how factory functions can be implemented in Node.js, we are ready to introduce a new advanced pattern that has recently been getting traction in the JavaScript community. We are talking about"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"composable factory functions"}]},{"block_type":"text","content":", which represent a particular type of factory function that can be \"composed\" together to build new enhanced factory functions. They are especially useful for allowing us to construct objects that \"inherit\" behaviors and properties from different sources without the need for building complex class hierarchies."}]},{"block_type":"element","block":"k5zy5bdj","search_text":"We can clarify this concept with a simple and effective example. Let's assume we want to build a videogame in which the characters on the screen can have a number of different behaviors: they can move on the screen; they can slash and shoot. And yes, to be a character they should have some basic properties such as life points, position on the screen, and name.","text_count":362,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can clarify this concept with a simple and effective example. Let's assume we want to build a videogame in which the characters on the screen can have a number of different behaviors: they can"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"move"}]},{"block_type":"text","content":"on the screen; they can"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"slash"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"shoot."}]},{"block_type":"text","content":"And yes, to be a character they should have some basic properties such as life points, position on the screen, and name."}]},{"block_type":"element","block":"k5zy5bdk","search_text":"We want to define several types of character, one for every specific behavior:","text_count":78,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We want to define several types of character, one for every specific behavior:"}]},{"block_type":"element","block":"k5zy5bdl","search_text":"Character : base character that has life points, a position, and a name Mover : character that is able to move Slasher : character that is able to slash Shooter : character that is able to shoot (as long as it has bullets!) ","text_count":224,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Character"}]},{"block_type":"text","content":": base character that has life points, a position, and a name"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Mover"}]},{"block_type":"text","content":": character that is able to move"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Slasher"}]},{"block_type":"text","content":": character that is able to slash"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Shooter"}]},{"block_type":"text","content":": character that is able to shoot (as long as it has bullets!)"}]}]},{"block_type":"element","block":"k5zy5bdm","search_text":"Ideally we would be able to define new types of characters, combining different behaviors from the existing ones. We want absolute freedom and, for example, we would like to define these new types on top of the existing ones:","text_count":225,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Ideally we would be able to define new types of characters, combining different behaviors from the existing ones. We want absolute freedom and, for example, we would like to define these new types on top of the existing ones:"}]},{"block_type":"element","block":"k5zy5bdn","search_text":"Runner : a character that can move Samurai : a character that can move and slash Sniper : a character that can shoot (it doesn't move) Gunslinger : a character that can move and shoot Western Samurai : a character that can move, slash, and shoot ","text_count":246,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Runner"}]},{"block_type":"text","content":": a character that can move"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Samurai"}]},{"block_type":"text","content":": a character that can move and slash"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Sniper"}]},{"block_type":"text","content":": a character that can shoot (it doesn't move)"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Gunslinger"}]},{"block_type":"text","content":": a character that can move and shoot"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Western Samurai"}]},{"block_type":"text","content":": a character that can move, slash, and shoot"}]}]},{"block_type":"element","block":"k5zy5bdo","search_text":"As you can see, we want total freedom in combining the features of every basic type, so it should now be obvious that we cannot easily model this problem using classes and inheritance.","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, we want total freedom in combining the features of every basic type, so it should now be obvious that we cannot easily model this problem using classes and inheritance."}]},{"block_type":"element","block":"k5zy5bdp","search_text":"So instead, we are going to use composable factory functions and in particular we are going to use the stamp specification as implemented by the stampit module: ( https://www.npmjs.com/package/stampit ).","text_count":203,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So instead, we are going to use composable factory functions and in particular we are going to use the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"stamp specification"}]},{"block_type":"text","content":"as implemented by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stampit"}]},{"block_type":"text","content":"module: ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.npmjs.com/package/stampit"},"children":[{"block_type":"text","content":"https://www.npmjs.com/package/stampit"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5bdq","search_text":"This module offers an intuitive interface for defining factory functions that can be composed together to build new factory functions. Basically, it allows us to define factory functions that will generate objects with a specific set of properties and methods, by using a handy fluent interface to describe them.","text_count":312,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This module offers an intuitive interface for defining factory functions that can be composed together to build new factory functions. Basically, it allows us to define factory functions that will generate objects with a specific set of properties and methods, by using a handy fluent interface to describe them."}]},{"block_type":"element","block":"k5zy5bdr","search_text":"Let's see how easily we can define our basic types for our game. We will start with the basic character type:","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see how easily we can define our basic types for our game. We will start with the basic character type:"}]},{"block_type":"element","block":"k5zy5bds","search_text":"const stampit = require('stampit'); const character = stampit(). props({ name: 'anonymous', lifePoints: 100, x: 0, y: 0 }); ","text_count":124,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const stampit = require('stampit'); \n \nconst character = stampit(). \n  props({ \n    name: 'anonymous', \n    lifePoints: 100, \n    x: 0, \n    y: 0 \n  });"}]}]},{"block_type":"element","block":"k5zy5bdt","search_text":"In the previous snippet of code, we defined the character factory function, which can be used to create new instances of basic characters. Every character will have these properties: name , lifePoints , x , and y and the default values will be respectively anonymous , 100 , 0, and 0. The props method of stampit allows us to define these properties. To use this factory function, we can do something like this:","text_count":411,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous snippet of code, we defined the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"character"}]},{"block_type":"text","content":"factory function, which can be used to create new instances of basic characters. Every character will have these properties:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"name"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lifePoints"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"and the default values will be respectively"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"anonymous"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"100"}]},{"block_type":"text","content":", 0, and 0. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"props"}]},{"block_type":"text","content":"method of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stampit"}]},{"block_type":"text","content":"allows us to define these properties. To use this factory function, we can do something like this:"}]},{"block_type":"element","block":"k5zy5bdu","search_text":"const c = character(); c.name = 'John'; c.lifePoints = 10; console.log(c); // { name: 'John', lifePoints: 10, x:0, y:0 } ","text_count":121,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const c = character(); \nc.name = 'John'; \nc.lifePoints = 10; \nconsole.log(c); // { name: 'John', lifePoints: 10, x:0, y:0 }"}]}]},{"block_type":"element","block":"k5zy5bdv","search_text":"Now let's define our mover factory function:","text_count":44,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now let's define our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mover"}]},{"block_type":"text","content":"factory function:"}]},{"block_type":"element","block":"k5zy5bdw","search_text":"const mover = stampit() .methods({ move(xIncr, yIncr) { this.x += xIncr; this.y += yIncr; console.log(`${this.name} moved to [${this.x}, ${this.y}]`); } }); ","text_count":157,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const mover = stampit() \n  .methods({ \n    move(xIncr, yIncr) { \n      this.x += xIncr; \n      this.y += yIncr; \n      console.log(`${this.name} moved to [${this.x}, ${this.y}]`);            \n    } \n  });"}]}]},{"block_type":"element","block":"k5zy5bdx","search_text":"In this case, we are using the methods function of stampit to declare all the methods available in the objects produced by this factory function. For our Mover definition, we have a move function that can increase the x and the y position of the instance. Notice that we can access instance properties with the keyword this from inside a method.","text_count":345,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this case, we are using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"methods"}]},{"block_type":"text","content":"function of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stampit"}]},{"block_type":"text","content":"to declare all the methods available in the objects produced by this factory function. For our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Mover"}]},{"block_type":"text","content":"definition, we have a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"move"}]},{"block_type":"text","content":"function that can increase the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"position of the instance. Notice that we can access instance properties with the keyword"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this"}]},{"block_type":"text","content":"from inside a method."}]},{"block_type":"element","block":"k5zy5bdy","search_text":"Now that we have understood the basic concepts, we can easily add the factory function definitions for the slasher and shooter types:","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have understood the basic concepts, we can easily add the factory function definitions for the slasher and shooter types:"}]},{"block_type":"element","block":"k5zy5bdz","search_text":"const slasher = stampit() .methods({ slash(direction) { console.log(`${this.name} slashed to the ${direction}`); } }); const shooter = stampit() .props({ bullets: 6 }) .methods({ shoot(direction) { if (this.bullets > 0) { --this.bullets; console.log(`${this.name} shoot to the ${direction}`); } } }); ","text_count":301,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const slasher = stampit() \n  .methods({ \n    slash(direction) { \n      console.log(`${this.name} slashed to the ${direction}`); \n    } \n  }); \n \n  const shooter = stampit() \n    .props({ \n      bullets: 6 \n    }) \n    .methods({ \n      shoot(direction) { \n        if (this.bullets &gt; 0) { \n          --this.bullets; \n            console.log(`${this.name} shoot to the ${direction}`);                 \n        } \n      } \n    });"}]}]},{"block_type":"element","block":"k5zy5be0","search_text":"Notice how we are using both props and methods to define our shooter factory function.","text_count":86,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Notice how we are using both"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"props"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"methods"}]},{"block_type":"text","content":"to define our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"shooter"}]},{"block_type":"text","content":"factory function."}]},{"block_type":"element","block":"k5zy5be1","search_text":"Ok, now that we have all our base types defined, we are ready to compose them to create new powerful and expressive factory functions:","text_count":134,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Ok, now that we have all our base types defined, we are ready to compose them to create new powerful and expressive factory functions:"}]},{"block_type":"element","block":"k5zy5be2","search_text":"const runner = stampit.compose(character, mover); const samurai = stampit.compose(character, mover, slasher); const sniper = stampit.compose(character, shooter); const gunslinger = stampit.compose(character, mover, shooter); const westernSamurai = stampit.compose(gunslinger, samurai); ","text_count":286,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const runner = stampit.compose(character, mover); \nconst samurai = stampit.compose(character, mover, slasher); \nconst sniper = stampit.compose(character, shooter); \nconst gunslinger = stampit.compose(character, mover, shooter); \nconst westernSamurai = stampit.compose(gunslinger, samurai);"}]}]},{"block_type":"element","block":"k5zy5be3","search_text":"The method stampit.compose defines a new composed factory function that will produce an object based on the methods and properties of the composed factory functions. As you can tell, this is a powerful mechanism that gives us a lot of freedom and allows us to reason in terms of behaviors rather than in terms of classes.","text_count":321,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The method"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"stampit.compose"}]},{"block_type":"text","content":"defines a new composed factory function that will produce an object based on the methods and properties of the composed factory functions. As you can tell, this is a powerful mechanism that gives us a lot of freedom and allows us to reason in terms of behaviors rather than in terms of classes."}]},{"block_type":"element","block":"k5zy5be4","search_text":"To wrap up our example, let's instantiate and use a new westernSamurai .","text_count":72,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To wrap up our example, let's instantiate and use a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"westernSamurai"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5be5","search_text":"const gojiro = westernSamurai(); gojiro.name = 'Gojiro Kiryu'; gojiro.move(1,0); gojiro.slash('left'); gojiro.shoot('right'); ","text_count":126,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const gojiro = westernSamurai();\ngojiro.name = 'Gojiro Kiryu';\ngojiro.move(1,0);\ngojiro.slash('left');\ngojiro.shoot('right');"}]}]},{"block_type":"element","block":"k5zy5be6","search_text":"This will produce the following output:","text_count":39,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This will produce the following output:"}]},{"block_type":"element","block":"k5zy5be7","search_text":"Yojimbo moved to [1, 0] Yojimbo slashed to the left Yojimbo shoot to the right ","text_count":79,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Yojimbo moved to [1, 0] \nYojimbo slashed to the left \nYojimbo shoot to the right"}]}]},{"block_type":"element","block":"k5zy5be8","search_text":"Note More details about the stamp specification and the ideas behind it can be found in this post written by Eric Elliot, the original author of the specification: https://medium.com/javascript-scene/introducing-the-stamp-specification-77f8911c2fee. ","text_count":250,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"More details about the stamp specification and the ideas behind it can be found in this post written by Eric Elliot, the original author of the specification:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://medium.com/javascript-scene/introducing-the-stamp-specification-77f8911c2fee"},"children":[{"block_type":"text","content":"https://medium.com/javascript-scene/introducing-the-stamp-specification-77f8911c2fee."}]}]}]},{"block_type":"element","block":"k5zy5be9","search_text":"In the wild","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"In the wild"}]},{"block_type":"element","block":"k5zy5bea","search_text":"As we said, factories are very popular in Node.js. Many packages offer only a factory for creating new instances; some examples are the following:","text_count":146,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we said, factories are very popular in Node.js. Many packages offer only a factory for creating new instances; some examples are the following:"}]},{"block_type":"element","block":"k5zy5beb","search_text":"Dnode ( https://npmjs.org/package/dnode ): This is a Remote Procedure Call (RPC) system for Node.js. If we look into its source code, we will see that its logic is implemented into a class named D ; however, this is never exposed to the outside as the only exported interface is a factory, which allows us to create new instances of the class. You can take a look at its source code at: https://github.com/substack/dnode/blob/34d1c9aa9696f13bdf8fb99d9d039367ad873f90/index.js#L7-9 . Restify ( https://npmjs.org/package/restify ): This is a framework for building REST APIs that allow us to create new instances of a server using the restify.createServer() factory, which internally creates a new instance of the Server class (which is not exported). You can take a look at its source code at: https://github.com/mcavage/noderestify/blob/5f31e2334b38361ac7ac1a5e5d852b7206ef7d94/lib/index.js#L91-116 . ","text_count":901,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Dnode"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/dnode"},"children":[{"block_type":"text","content":"https://npmjs.org/package/dnode"}]},{"block_type":"text","content":"): This is a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Remote Procedure Call"}]},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"(RPC)"}]},{"block_type":"text","content":"system for Node.js. If we look into its source code, we will see that its logic is implemented into a class named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"D"}]},{"block_type":"text","content":"; however, this is never exposed to the outside as the only exported interface is a factory, which allows us to create new instances of the class. You can take a look at its source code at:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/substack/dnode/blob/34d1c9aa9696f13bdf8fb99d9d039367ad873f90/index.js#L7-9"},"children":[{"block_type":"text","content":"https://github.com/substack/dnode/blob/34d1c9aa9696f13bdf8fb99d9d039367ad873f90/index.js#L7-9"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Restify"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/restify"},"children":[{"block_type":"text","content":"https://npmjs.org/package/restify"}]},{"block_type":"text","content":"): This is a framework for building REST APIs that allow us to create new instances of a server using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"restify.createServer()"}]},{"block_type":"text","content":"factory, which internally creates a new instance of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Server"}]},{"block_type":"text","content":"class (which is not exported). You can take a look at its source code at:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/mcavage/noderestify/blob/5f31e2334b38361ac7ac1a5e5d852b7206ef7d94/lib/index.js#L91-116"},"children":[{"block_type":"text","content":"https://github.com/mcavage/noderestify/blob/5f31e2334b38361ac7ac1a5e5d852b7206ef7d94/lib/index.js#L91-116"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5bec","search_text":"Other modules expose both a class and a factory, but document the factory as the main method—or the most convenient way—to create new instances; some of the examples are as follows:","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Other modules expose both a class and a factory, but document the factory as the main method&mdash;or the most convenient way&mdash;to create new instances; some of the examples are as follows:"}]},{"block_type":"element","block":"k5zy5bed","search_text":"http-proxy ( https://npmjs.org/package/http-proxy ): This is a programmable proxying library, where new instances are created with httpProxy.createProxyServer(options) The core Node.js HTTP server: This is where new instances are mostly created using http.createServer() , even though this is essentially a shortcut for new http.Server() bunyan ( https://npmjs.org/package/bunyan ): This is a popular logging library; in its readme file the contributors propose a factory, bunyan.createLogger() , as the main method to create new instances, even though this would be equivalent to running new bunyan() ","text_count":602,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http-proxy"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/http-proxy"},"children":[{"block_type":"text","content":"https://npmjs.org/package/http-proxy"}]},{"block_type":"text","content":"): This is a programmable proxying library, where new instances are created with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"httpProxy.createProxyServer(options)"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The core Node.js HTTP server: This is where new instances are mostly created using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http.createServer()"}]},{"block_type":"text","content":", even though this is essentially a shortcut for"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new http.Server()"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"bunyan"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/bunyan"},"children":[{"block_type":"text","content":"https://npmjs.org/package/bunyan"}]},{"block_type":"text","content":"): This is a popular logging library; in its readme file the contributors propose a factory,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"bunyan.createLogger()"}]},{"block_type":"text","content":", as the main method to create new instances, even though this would be equivalent to running"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new bunyan()"}]}]}]},{"block_type":"element","block":"k5zy5bee","search_text":"Some other modules provide a factory to wrap the creation of other components. Popular examples are through2 and from2 (we saw them in Chapter 5, Coding with Streams ), which allow us to simplify the creation of new streams using a factory approach, freeing the developer from explicitly using inheritance and the new operator.","text_count":327,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Some other modules provide a factory to wrap the creation of other components. Popular examples are"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"through2"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"from2"}]},{"block_type":"text","content":"(we saw them in Chapter 5,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Coding with Streams"}]},{"block_type":"text","content":"), which allow us to simplify the creation of new streams using a factory approach, freeing the developer from explicitly using inheritance and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"new"}]},{"block_type":"text","content":"operator."}]},{"block_type":"element","block":"k5zy5bef","search_text":"Finally, to see some packages that are using the stamp specification and composable factory functions internally, you can have a look at react-stampit ( https://www.npmjs.com/package/react-stampit ), which brings the power of composable factory functions to the frontend allowing you to easily compose widget behaviors and remitter ( https://www.npmjs.com/package/remitter ), a pub/sub module based on Redis.","text_count":408,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, to see some packages that are using the stamp specification and composable factory functions internally, you can have a look at"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"react-stampit"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.npmjs.com/package/react-stampit"},"children":[{"block_type":"text","content":"https://www.npmjs.com/package/react-stampit"}]},{"block_type":"text","content":"), which brings the power of composable factory functions to the frontend allowing you to easily compose widget behaviors and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"remitter"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.npmjs.com/package/remitter"},"children":[{"block_type":"text","content":"https://www.npmjs.com/package/remitter"}]},{"block_type":"text","content":"), a pub/sub module based on Redis."}]},{"block_type":"element","block":"k5zy5beg","search_text":"Revealing constructor","text_count":21,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Revealing constructor"}]},{"block_type":"element","block":"k5zy5beh","search_text":"The revealing constructor pattern is a relatively new pattern that is gaining traction in the Node.js community and in JavaScript, especially because it's used within some core libraries such as Promise .","text_count":204,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The revealing constructor pattern is a relatively new pattern that is gaining traction in the Node.js community and in JavaScript, especially because it's used within some core libraries such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bei","search_text":"We have already implicitly seen this pattern in Chapter 4, Asynchronous Control Flow Patterns with ES2015 and Beyond , while exploring promises, but let's get back to it and analyze the Promise constructor to embrace it in greater detail:","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We have already implicitly seen this pattern in Chapter 4,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with ES2015 and Beyond"}]},{"block_type":"text","content":", while exploring promises, but let's get back to it and analyze the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"constructor to embrace it in greater detail:"}]},{"block_type":"element","block":"k5zy5bej","search_text":"const promise = new Promise(function (resolve, reject) { // ... }); ","text_count":68,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const promise = new Promise(function (resolve, reject) { \n  // ... \n});"}]}]},{"block_type":"element","block":"k5zy5bek","search_text":"As you can see, Promise accepts a function as a constructor argument, which is called the executor function . This function is called by the internal implementation of the Promise constructor and it is used to allow the constructing code to manipulate only a limited part of the internal state of the promise under construction. In other words, it serves as a mechanism to expose the resolve and reject functions so that they can be invoked to change the internal state of the object.","text_count":484,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"accepts a function as a constructor argument, which is called the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"executor function"}]},{"block_type":"text","content":". This function is called by the internal implementation of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"constructor and it is used to allow the constructing code to manipulate only a limited part of the internal state of the promise under construction. In other words, it serves as a mechanism to expose the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"resolve"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reject"}]},{"block_type":"text","content":"functions so that they can be invoked to change the internal state of the object."}]},{"block_type":"element","block":"k5zy5bel","search_text":"The advantage of this is that only the constructing code has access to resolve and reject and once the promise object is constructed, it can be passed around safely; no other code will be able to call reject or resolve and change the internal state of the promise.","text_count":264,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The advantage of this is that only the constructing code has access to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"resolve"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reject"}]},{"block_type":"text","content":"and once the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"promise"}]},{"block_type":"text","content":"object is constructed, it can be passed around safely; no other code will be able to call"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reject"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"resolve"}]},{"block_type":"text","content":"and change the internal state of the promise."}]},{"block_type":"element","block":"k5zy5bem","search_text":"That is exactly the reason why this pattern has been named \"revealing constructor\" by Domenic Denicola in one of his blog posts.","text_count":128,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That is exactly the reason why this pattern has been named \"revealing constructor\" by Domenic Denicola in one of his blog posts."}]},{"block_type":"element","block":"k5zy5ben","search_text":"Note The full post by Domenic is extremely interesting and also analyzes the historical origins of the pattern and compares some aspects of this pattern with the template pattern used by node streams, or with other construction patterns used by earlier implementation, of the Promise libraries. You can read it here: https://blog.domenic.me/the-revealing-constructor-pattern/ . ","text_count":378,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The full post by Domenic is extremely interesting and also analyzes the historical origins of the pattern and compares some aspects of this pattern with the template pattern used by node streams, or with other construction patterns used by earlier implementation, of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"libraries. You can read it here:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://blog.domenic.me/the-revealing-constructor-pattern/"},"children":[{"block_type":"text","content":"https://blog.domenic.me/the-revealing-constructor-pattern/"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5beo","search_text":"A read-only event emitter","text_count":25,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"A read-only event emitter"}]},{"block_type":"element","block":"k5zy5bep","search_text":"In this paragraph, we are going to use the revealing constructor pattern to build a read-only event emitter , a special kind of event emitter in which is not possible to call the emit method (apart from within the function passed to the constructor).","text_count":250,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this paragraph, we are going to use the revealing constructor pattern to build a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"read-only event emitter"}]},{"block_type":"text","content":", a special kind of event emitter in which is not possible to call the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit"}]},{"block_type":"text","content":"method (apart from within the function passed to the constructor)."}]},{"block_type":"element","block":"k5zy5beq","search_text":"Let's write the code for the Roee (read-only event emitter) class in a file called roee.js :","text_count":92,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's write the code for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Roee"}]},{"block_type":"text","content":"(read-only event emitter) class in a file called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"roee.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5ber","search_text":"const EventEmitter = require('events'); module.exports = class Roee extends EventEmitter { constructor (executor) { super(); const emit = this.emit.bind(this); this.emit = undefined; executor(emit); } }; ","text_count":204,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const EventEmitter = require('events'); \n \nmodule.exports = class Roee extends EventEmitter { \n  constructor (executor) { \n    super(); \n    const emit = this.emit.bind(this); \n    this.emit = undefined; \n    executor(emit); \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5bes","search_text":"In this simple class, we are extending the core EventEmitter class and accepting an executor function as the only constructor argument.","text_count":135,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this simple class, we are extending the core"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"class and accepting an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"executor"}]},{"block_type":"text","content":"function as the only constructor argument."}]},{"block_type":"element","block":"k5zy5bet","search_text":"Inside the constructor, we invoke the super function to be sure to initialize the event emitter properly by calling its parent constructor, then we save a backup of the emit function and we remove it by assigning undefined to it.","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Inside the constructor, we invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"super"}]},{"block_type":"text","content":"function to be sure to initialize the event emitter properly by calling its parent constructor, then we save a backup of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit"}]},{"block_type":"text","content":"function and we remove it by assigning"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"undefined"}]},{"block_type":"text","content":"to it."}]},{"block_type":"element","block":"k5zy5beu","search_text":"Finally, we call the executor function by passing the emit method backup as argument.","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we call the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"executor"}]},{"block_type":"text","content":"function by passing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit"}]},{"block_type":"text","content":"method backup as argument."}]},{"block_type":"element","block":"k5zy5bev","search_text":"What is important to understand here is that after undefined is assigned to the emit method, it won't be possible to call it anymore from other parts of our code. Our backup version of emit is defined as a local variable that will be forwarded only to the executor function. This mechanism allows us to be able to use emit only within the executor function.","text_count":357,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What is important to understand here is that after"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"undefined"}]},{"block_type":"text","content":"is assigned to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit"}]},{"block_type":"text","content":"method, it won't be possible to call it anymore from other parts of our code. Our backup version of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit"}]},{"block_type":"text","content":"is defined as a local variable that will be forwarded only to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"executor"}]},{"block_type":"text","content":"function. This mechanism allows us to be able to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit"}]},{"block_type":"text","content":"only within the executor function."}]},{"block_type":"element","block":"k5zy5bew","search_text":"Now let's use this new class to create a simple ticker, a class that emits a tick every second and keeps the count of all the ticks emitted. This will be the content of our new ticker.js module:","text_count":194,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now let's use this new class to create a simple ticker, a class that emits a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"tick"}]},{"block_type":"text","content":"every second and keeps the count of all the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"ticks"}]},{"block_type":"text","content":"emitted. This will be the content of our new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ticker.js"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5bex","search_text":"const Roee = require('./roee'); const ticker = new Roee((emit) => { let tickCount = 0; setInterval(() => emit('tick', tickCount++), 1000); }); module.exports = ticker; ","text_count":168,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const Roee = require('./roee'); \n \nconst ticker = new Roee((emit) =&gt; { \n  let tickCount = 0; \n  setInterval(() =&gt; emit('tick', tickCount++), 1000); \n}); \n \nmodule.exports = ticker;"}]}]},{"block_type":"element","block":"k5zy5bey","search_text":"As you can see here, the code is very trivial. We instantiate a new Roee and we pass the logic of event emission within the executor function. Our executor function receives emit as argument so we can use it to emit a new tick event every second.","text_count":246,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see here, the code is very trivial. We instantiate a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Roee"}]},{"block_type":"text","content":"and we pass the logic of event emission within the executor function. Our executor function receives"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit"}]},{"block_type":"text","content":"as argument so we can use it to emit a new tick event every second."}]},{"block_type":"element","block":"k5zy5bez","search_text":"Now let's see a quick example on how to use this ticker module:","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now let's see a quick example on how to use this ticker module:"}]},{"block_type":"element","block":"k5zy5bf0","search_text":"const ticker = require('./ticker'); ticker.on('tick', (tickCount) => console.log(tickCount, 'TICK')); // ticker.emit('something', {}); <-- This will fail ","text_count":154,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const ticker = require('./ticker'); \n \nticker.on('tick', (tickCount) =&gt; console.log(tickCount, 'TICK')); \n// ticker.emit('something', {}); &lt;-- This will fail"}]}]},{"block_type":"element","block":"k5zy5bf1","search_text":"We use the ticker object the same as any other event emitter-based object, and we can attach any number of listeners with the on method, but in this case, if we try to use the emit method, our code will fail by triggering a TypeError: ticker.emit is not a function error.","text_count":271,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ticker"}]},{"block_type":"text","content":"object the same as any other event emitter-based object, and we can attach any number of listeners with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"on"}]},{"block_type":"text","content":"method, but in this case, if we try to use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit"}]},{"block_type":"text","content":"method, our code will fail by triggering a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"TypeError: ticker.emit is not a function"}]},{"block_type":"text","content":"error."}]},{"block_type":"element","block":"k5zy5bf2","search_text":"Note Even if this example plays a nice role in showing how the revealing constructor pattern can be used, it is worth mentioning that this read-only functionality for the event emitter is not completely bulletproof and it is still possible to bypass it in several ways. For example, we can still emit an event on our ticker instance by using the original emit prototype directly, as follows: require('events').prototype.emit.call(ticker, 'someEvent', {}); ","text_count":456,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even if this example plays a nice role in showing how the revealing constructor pattern can be used, it is worth mentioning that this read-only functionality for the event emitter is not completely bulletproof and it is still possible to bypass it in several ways. For example, we can still emit an event on our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ticker"}]},{"block_type":"text","content":"instance by using the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"emit"}]},{"block_type":"text","content":"prototype directly, as follows:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require('events').prototype.emit.call(ticker, 'someEvent', {});"}]}]}]},{"block_type":"element","block":"k5zy5bf3","search_text":"In the wild","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"In the wild"}]},{"block_type":"element","block":"k5zy5bf4","search_text":"Even if this pattern is quite interesting and clever, it is really hard to find common use cases apart from the Promise constructor.","text_count":132,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even if this pattern is quite interesting and clever, it is really hard to find common use cases apart from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Promise"}]},{"block_type":"text","content":"constructor."}]},{"block_type":"element","block":"k5zy5bf5","search_text":"It's worth mentioning that there is a new specification for streams under development that tries to adopt this pattern as a better alternative to the currently used template pattern to be able to describe the behavior of various stream objects: https://streams.spec.whatwg.org .","text_count":278,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's worth mentioning that there is a new specification for streams under development that tries to adopt this pattern as a better alternative to the currently used template pattern to be able to describe the behavior of various stream objects:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://streams.spec.whatwg.org/"},"children":[{"block_type":"text","content":"https://streams.spec.whatwg.org"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bf6","search_text":"Also it's important to point out that we already used this pattern in Chapter 5, Coding with Streams when we implemented the ParallelStream class. This class accepts as constructor argument the userTransform function (the executor function).","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also it's important to point out that we already used this pattern in Chapter 5,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Coding with Streams"}]},{"block_type":"text","content":"when we implemented the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ParallelStream"}]},{"block_type":"text","content":"class. This class accepts as constructor argument the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"userTransform"}]},{"block_type":"text","content":"function (the executor function)."}]},{"block_type":"element","block":"k5zy5bf7","search_text":"Even if in this case the executor function is not called at construction time, but in the internal _transform method of the stream, the general concept of the pattern remains valid. In fact, this approach allows us to expose some internals of the stream (for example, the push function) only to the specific logic of the transformation that we want to specify at construction time when creating a new instance of ParallelStream .","text_count":429,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even if in this case the executor function is not called at construction time, but in the internal"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform"}]},{"block_type":"text","content":"method of the stream, the general concept of the pattern remains valid. In fact, this approach allows us to expose some internals of the stream (for example, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"push"}]},{"block_type":"text","content":"function) only to the specific logic of the transformation that we want to specify at construction time when creating a new instance of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ParallelStream"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bf8","search_text":"Proxy","text_count":5,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Proxy"}]},{"block_type":"element","block":"k5zy5bf9","search_text":"A proxy is an object that controls access to another object, called a subject . The proxy and the subject have an identical interface and this allows us to transparently swap one for the other; in fact, the alternative name for this pattern is surrogate . A proxy intercepts all or some of the operations that are meant to be executed on the subject, augmenting or complementing their behavior. The following figure shows a diagrammatic representation:","text_count":452,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A proxy is an object that controls access to another object, called a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"subject"}]},{"block_type":"text","content":". The proxy and the subject have an identical interface and this allows us to transparently swap one for the other; in fact, the alternative name for this pattern is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"surrogate"}]},{"block_type":"text","content":". A proxy intercepts all or some of the operations that are meant to be executed on the subject, augmenting or complementing their behavior. The following figure shows a diagrammatic representation:"}]},{"block_type":"element","block":"k5zy5bfa","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000050.jpg","alt":"Proxy","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bfb","search_text":"The preceding figure shows us how the Proxy and the Subject have the same interface, and how this is totally transparent to the client, who can use one or the other interchangeably. The Proxy forwards each operation to the subject, enhancing its behavior with additional pre-processing or post-processing.","text_count":305,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding figure shows us how the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Proxy"}]},{"block_type":"text","content":"and the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Subject"}]},{"block_type":"text","content":"have the same interface, and how this is totally transparent to the client, who can use one or the other interchangeably. The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Proxy"}]},{"block_type":"text","content":"forwards each operation to the subject, enhancing its behavior with additional pre-processing or post-processing."}]},{"block_type":"element","block":"k5zy5bfc","search_text":"Note It's important to observe that we are not talking about proxying between classes; the proxy pattern involves wrapping actual instances of the subject, thus preserving its state. ","text_count":183,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to observe that we are not talking about proxying between classes; the proxy pattern involves wrapping actual instances of the subject, thus preserving its state."}]}]},{"block_type":"element","block":"k5zy5bfd","search_text":"A proxy is useful in several circumstances; for example, consider the following ones:","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A proxy is useful in several circumstances; for example, consider the following ones:"}]},{"block_type":"element","block":"k5zy5bfe","search_text":"Data validation : The proxy validates the input before forwarding it to the subject Security : The proxy verifies that the client is authorized to perform the operation and it passes the request to the subject only if the outcome of the check is positive Caching : The proxy keeps an internal cache so that the operations are executed on the subject only if the data is not yet present in the cache Lazy initialization : If the creation of the subject is expensive, the proxy can delay it to when it's really necessary Logging : The proxy intercepts the method invocations and the relative parameters, recoding them as they happen Remote objects : A proxy can take an object that is located remotely, and make it appear local ","text_count":726,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Data validation"}]},{"block_type":"text","content":": The proxy validates the input before forwarding it to the subject"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Security"}]},{"block_type":"text","content":": The proxy verifies that the client is authorized to perform the operation and it passes the request to the subject only if the outcome of the check is positive"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Caching"}]},{"block_type":"text","content":": The proxy keeps an internal cache so that the operations are executed on the subject only if the data is not yet present in the cache"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Lazy initialization"}]},{"block_type":"text","content":": If the creation of the subject is expensive, the proxy can delay it to when it's really necessary"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Logging"}]},{"block_type":"text","content":": The proxy intercepts the method invocations and the relative parameters, recoding them as they happen"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Remote objects"}]},{"block_type":"text","content":": A proxy can take an object that is located remotely, and make it appear local"}]}]},{"block_type":"element","block":"k5zy5bff","search_text":"Of course, there are many more applications for the proxy pattern, but these should give us an idea of the extent of its purpose.","text_count":129,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Of course, there are many more applications for the proxy pattern, but these should give us an idea of the extent of its purpose."}]},{"block_type":"element","block":"k5zy5bfg","search_text":"Techniques for implementing proxies","text_count":35,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Techniques for implementing proxies"}]},{"block_type":"element","block":"k5zy5bfh","search_text":"When proxying an object, we can decide to intercept all of its methods or only some of them, while delegating the rest of them directly to the subject. There are several ways in which this can be achieved; let's analyze some of them.","text_count":233,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When proxying an object, we can decide to intercept all of its methods or only some of them, while delegating the rest of them directly to the subject. There are several ways in which this can be achieved; let's analyze some of them."}]},{"block_type":"element","block":"k5zy5bfi","search_text":"Object composition","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Object composition"}]},{"block_type":"element","block":"k5zy5bfj","search_text":"Composition is a technique whereby an object is combined with another object for the purpose of extending or using its functionality. In the specific case of the proxy pattern, a new object with the same interface as the subject is created, and a reference to the subject is stored internally in the proxy in the form of an instance variable or a closure variable. The subject can be injected from the client at creation time or created by the proxy itself.","text_count":457,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Composition is a technique whereby an object is combined with another object for the purpose of extending or using its functionality. In the specific case of the proxy pattern, a new object with the same interface as the subject is created, and a reference to the subject is stored internally in the proxy in the form of an instance variable or a closure variable. The subject can be injected from the client at creation time or created by the proxy itself."}]},{"block_type":"element","block":"k5zy5bfk","search_text":"The following is one example of this technique using a pseudo class and a factory:","text_count":82,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following is one example of this technique using a pseudo class and a factory:"}]},{"block_type":"element","block":"k5zy5bfl","search_text":"function createProxy(subject) { const proto = Object.getPrototypeOf(subject); function Proxy(subject) { this.subject = subject; } Proxy.prototype = Object.create(proto); //proxied method Proxy.prototype.hello = function(){ return this.subject.hello() + ' world!'; }; //delegated method Proxy.prototype.goodbye = function(){ return this.subject.goodbye .apply(this.subject, arguments); }; return new Proxy(subject); } module.exports = createProxy; ","text_count":447,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function createProxy(subject) { \n  const proto = Object.getPrototypeOf(subject); \n \n  function Proxy(subject) { \n    this.subject = subject; \n  } \n \n  Proxy.prototype = Object.create(proto); \n \n  //proxied method \n  Proxy.prototype.hello = function(){ \n    return this.subject.hello() + ' world!'; \n  }; \n \n  //delegated method \n  Proxy.prototype.goodbye = function(){ \n    return this.subject.goodbye \n      .apply(this.subject, arguments); \n  }; \n \n  return new Proxy(subject); \n}\nmodule.exports = createProxy;"}]}]},{"block_type":"element","block":"k5zy5bfm","search_text":"To implement a proxy using composition, we have to intercept the methods that we are interested in manipulating (such as hello() ), while simply delegating the rest of them to the subject (as we did with goodbye() ).","text_count":216,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To implement a proxy using composition, we have to intercept the methods that we are interested in manipulating (such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"hello()"}]},{"block_type":"text","content":"), while simply delegating the rest of them to the subject (as we did with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"goodbye()"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5bfn","search_text":"The preceding code also shows the particular case where the subject has a prototype and we want to maintain the correct prototype chain, so that executing proxy instanceof Subject will return true ; we used pseudo-classical inheritance to achieve this.","text_count":252,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code also shows the particular case where the subject has a prototype and we want to maintain the correct prototype chain, so that executing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"proxy instanceof Subject"}]},{"block_type":"text","content":"will return"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true"}]},{"block_type":"text","content":"; we used"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"pseudo-classical inheritance"}]},{"block_type":"text","content":"to achieve this."}]},{"block_type":"element","block":"k5zy5bfo","search_text":"This is just an extra step, required only if we are interested in maintaining the prototype chain, which can be useful in order to improve the compatibility of the proxy with code initially meant to work with the subject.","text_count":221,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is just an extra step, required only if we are interested in maintaining the prototype chain, which can be useful in order to improve the compatibility of the proxy with code initially meant to work with the subject."}]},{"block_type":"element","block":"k5zy5bfp","search_text":"However, as JavaScript has dynamic typing, most of the time we can avoid using inheritance and use more immediate approaches. For example, an alternative implementation of the proxy presented in the preceding code might just use an object literal and a factory:","text_count":261,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, as JavaScript has dynamic typing, most of the time we can avoid using inheritance and use more immediate approaches. For example, an alternative implementation of the proxy presented in the preceding code might just use an object literal and a factory:"}]},{"block_type":"element","block":"k5zy5bfq","search_text":"function createProxy(subject) { return { //proxied method hello: () => (subject.hello() + ' world!'), //delegated method goodbye: () => (subject.goodbye.apply(subject, arguments)) }; } ","text_count":185,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function createProxy(subject) { \n  return { \n    //proxied method \n    hello: () =&gt; (subject.hello() + ' world!'), \n \n    //delegated method \n    goodbye: () =&gt; (subject.goodbye.apply(subject, arguments)) \n  }; \n}"}]}]},{"block_type":"element","block":"k5zy5bfr","search_text":"Note If we want to create a proxy that delegates most of its methods, it would be convenient to generate these automatically using a library, such as delegates ( https://npmjs.org/package/delegates ). ","text_count":201,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we want to create a proxy that delegates most of its methods, it would be convenient to generate these automatically using a library, such as"},{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"delegates"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/delegates"},"children":[{"block_type":"text","content":"https://npmjs.org/package/delegates"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5bfs","search_text":"Object augmentation","text_count":19,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Object augmentation"}]},{"block_type":"element","block":"k5zy5bft","search_text":"Object augmentation (or monkey patching) is probably the most pragmatic way of proxying individual methods of an object and consists of modifying the subject directly by replacing a method with its proxied implementation; consider the following example:","text_count":253,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Object augmentation"}]},{"block_type":"text","content":"(or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"monkey patching)"}]},{"block_type":"text","content":"is probably the most pragmatic way of proxying individual methods of an object and consists of modifying the subject directly by replacing a method with its proxied implementation; consider the following example:"}]},{"block_type":"element","block":"k5zy5bfu","search_text":"function createProxy(subject) { const helloOrig = subject.hello; subject.hello = () => (helloOrig.call(this) + ' world!'); return subject; } ","text_count":141,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function createProxy(subject) { \n  const helloOrig = subject.hello; \n  subject.hello = () =&gt; (helloOrig.call(this) + ' world!'); \n\n  return subject; \n}"}]}]},{"block_type":"element","block":"k5zy5bfv","search_text":"This technique is definitely the most convenient one when we need to proxy only one or a few methods, but it has the drawback of modifying the subject object directly.","text_count":167,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This technique is definitely the most convenient one when we need to proxy only one or a few methods, but it has the drawback of modifying the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subject"}]},{"block_type":"text","content":"object directly."}]},{"block_type":"element","block":"k5zy5bfw","search_text":"A comparison of the different techniques","text_count":40,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"A comparison of the different techniques"}]},{"block_type":"element","block":"k5zy5bfx","search_text":"Composition can be considered the safest way of creating a proxy, because it leaves the subject untouched without mutating its original behavior. Its only drawback is that we have to manually delegate all the methods, even if we want to proxy only one of them. If needed, we might also have to delegate the access to the properties of the subject.","text_count":347,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Composition can be considered the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"safest"}]},{"block_type":"text","content":"way of creating a proxy, because it leaves the subject untouched without mutating its original behavior. Its only drawback is that we have to manually delegate all the methods, even if we want to proxy only one of them. If needed, we might also have to delegate the access to the properties of the subject."}]},{"block_type":"element","block":"k5zy5bfy","search_text":"Tip The object properties can be delegated using Object.defineProperty() . Find out more at: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty . ","text_count":198,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The object properties can be delegated using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Object.defineProperty()"}]},{"block_type":"text","content":". Find out more at:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty"},"children":[{"block_type":"text","content":"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5bfz","search_text":"Object augmentation, on the other hand, modifies the subject, which might not always be what we want, but it does not present the various inconveniences related to delegation. For this reason, object augmentation is definitely the most pragmatic way to implement proxies in JavaScript, and it's the preferred technique in all those circumstances where modifying the subject is not a big concern.","text_count":395,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Object augmentation, on the other hand, modifies the subject, which might not always be what we want, but it does not present the various inconveniences related to delegation. For this reason, object augmentation is definitely the most pragmatic way to implement proxies in JavaScript, and it's the preferred technique in all those circumstances where modifying the subject is not a big concern."}]},{"block_type":"element","block":"k5zy5bg0","search_text":"However, there is at least one situation where composition is almost necessary; this is when we want to control the initialization of the subject, to, for example, create it only when needed ( lazy initialization ).","text_count":215,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, there is at least one situation where composition is almost necessary; this is when we want to control the initialization of the subject, to, for example, create it only when needed ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"lazy initialization"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5bg1","search_text":"Tip It is worth pointing out that by using a factory function ( createProxy() in our examples), we can shield our code from the technique used to generate the proxy. ","text_count":166,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is worth pointing out that by using a factory function ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"createProxy()"}]},{"block_type":"text","content":"in our examples), we can shield our code from the technique used to generate the proxy."}]}]},{"block_type":"element","block":"k5zy5bg2","search_text":"Creating a logging Writable stream","text_count":34,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Creating a logging Writable stream"}]},{"block_type":"element","block":"k5zy5bg3","search_text":"To see the proxy pattern in a real example, we will now build an object that acts as a proxy to a Writable stream, by intercepting all the calls to the write() method and logging a message every time this happens. We will use an object composition to implement our proxy; this is how the loggingWritable.js file looks:","text_count":318,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To see the proxy pattern in a real example, we will now build an object that acts as a proxy to a Writable stream, by intercepting all the calls to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"write()"}]},{"block_type":"text","content":"method and logging a message every time this happens. We will use an object composition to implement our proxy; this is how the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"loggingWritable.js"}]},{"block_type":"text","content":"file looks:"}]},{"block_type":"element","block":"k5zy5bg4","search_text":"function createLoggingWritable(writableOrig) { const proto = Object.getPrototypeOf(writableOrig); function LoggingWritable(writableOrig) { this.writableOrig = writableOrig; } LoggingWritable.prototype = Object.create(proto); LoggingWritable.prototype.write = function(chunk, encoding, callback) { if(!callback && typeof encoding === 'function') { callback = encoding; encoding = undefined; } console.log('Writing ', chunk); return this.writableOrig.write(chunk, encoding, function() { console.log('Finished writing ', chunk); callback && callback(); }); }; LoggingWritable.prototype.on = function() { return this.writableOrig.on .apply(this.writableOrig, arguments); }; LoggingWritable.prototype.end = function() { return this.writableOrig.end .apply(this.writableOrig, arguments); }; return new LoggingWritable(writableOrig); } ","text_count":829,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function createLoggingWritable(writableOrig) { \n  const proto = Object.getPrototypeOf(writableOrig); \n \n  function LoggingWritable(writableOrig) { \n    this.writableOrig = writableOrig; \n  } \n \n  LoggingWritable.prototype = Object.create(proto); \n \n  LoggingWritable.prototype.write = function(chunk, encoding, callback) { \n    if(!callback && typeof encoding === 'function') { \n      callback = encoding; \n      encoding = undefined; \n    } \n    console.log('Writing ', chunk); \n    return this.writableOrig.write(chunk, encoding, function() { \n      console.log('Finished writing ', chunk); \n      callback && callback(); \n    }); \n  }; \n \n  LoggingWritable.prototype.on = function() { \n    return this.writableOrig.on \n      .apply(this.writableOrig, arguments); \n  }; \n \n  LoggingWritable.prototype.end = function() { \n    return this.writableOrig.end \n      .apply(this.writableOrig, arguments); \n  }; \n \n  return new LoggingWritable(writableOrig); \n}"}]}]},{"block_type":"element","block":"k5zy5bg5","search_text":"In the preceding code, we created a factory that returns a proxied version of the writable object passed as an argument. We provide an override for the write() method that logs a message to the standard output every time it is invoked and every time the asynchronous operation completes. This is also a good example of creating proxies of asynchronous functions, which makes proxying the callback necessary as well; this is an important detail to be considered in a platform such as Node.js. The remaining methods, on() and end() , are simply delegated to the original writable stream (to keep the code leaner we are not considering the other methods of the writable interface).","text_count":678,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we created a factory that returns a proxied version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writable"}]},{"block_type":"text","content":"object passed as an argument. We provide an override for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"write()"}]},{"block_type":"text","content":"method that logs a message to the standard output every time it is invoked and every time the asynchronous operation completes. This is also a good example of creating proxies of asynchronous functions, which makes proxying the callback necessary as well; this is an important detail to be considered in a platform such as Node.js. The remaining methods,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"on()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end()"}]},{"block_type":"text","content":", are simply delegated to the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writable"}]},{"block_type":"text","content":"stream (to keep the code leaner we are not considering the other methods of the writable interface)."}]},{"block_type":"element","block":"k5zy5bg6","search_text":"We can now include a few more lines of code into the loggingWritable.js module to test the proxy that we just created:","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now include a few more lines of code into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"loggingWritable.js"}]},{"block_type":"text","content":"module to test the proxy that we just created:"}]},{"block_type":"element","block":"k5zy5bg7","search_text":"const fs = require('fs'); const writable = fs.createWriteStream('test.txt'); const writableProxy = createLoggingWritable(writable); writableProxy.write('First chunk'); writableProxy.write('Second chunk'); writable.write('This is not logged'); writableProxy.end(); ","text_count":264,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \n \nconst writable = fs.createWriteStream('test.txt'); \nconst writableProxy = createLoggingWritable(writable); \n \nwritableProxy.write('First chunk'); \nwritableProxy.write('Second chunk'); \nwritable.write('This is not logged'); \nwritableProxy.end();"}]}]},{"block_type":"element","block":"k5zy5bg8","search_text":"The proxy did not change the original interface of the stream or its external behavior, but if we run the preceding code, we will now see that every chunk that is written into the stream is transparently logged to the console.","text_count":226,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The proxy did not change the original interface of the stream or its external behavior, but if we run the preceding code, we will now see that every chunk that is written into the stream is transparently logged to the console."}]},{"block_type":"element","block":"k5zy5bg9","search_text":"Proxy in the ecosystem – function hooks and AOP","text_count":47,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Proxy in the ecosystem&nbsp;&ndash; function hooks and AOP"}]},{"block_type":"element","block":"k5zy5bga","search_text":"In its numerous forms, proxy is quite a popular pattern in Node.js, as well as in the ecosystem. In fact, we can find several libraries that allow us to simplify the creation of proxies, most of the time leveraging object augmentation as an implementation approach. In the community, this pattern can also be referred to as function hooking , or sometimes as Aspect-Oriented Programming ( AOP ), which is actually a common area of application for proxies. In AOP, these libraries usually allow the developer to set pre- or post- execution hooks for a specific method (or a set of methods) that allow us to execute custom code before and after the execution of the advised method, respectively.","text_count":693,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In its numerous forms, proxy is quite a popular pattern in Node.js, as well as in the ecosystem. In fact, we can find several libraries that allow us to simplify the creation of proxies, most of the time leveraging object augmentation as an implementation approach. In the community, this pattern can also be referred to as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"function hooking"}]},{"block_type":"text","content":", or sometimes as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Aspect-Oriented Programming"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"AOP"}]},{"block_type":"text","content":"), which is actually a common area of application for proxies. In AOP, these libraries usually allow the developer to set"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pre-"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"post-"}]},{"block_type":"text","content":"execution hooks for a specific method (or a set of methods) that allow us to execute custom code before and after the execution of the advised method, respectively."}]},{"block_type":"element","block":"k5zy5bgb","search_text":"Sometimes proxies are also called middleware , because, as it happens in the middleware pattern (which we will see later in the chapter), they allow us to pre-process and post-process the input/output of a function. Sometimes, they also allow the registering of multiple hooks for the same method using a middleware-like pipeline.","text_count":330,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sometimes proxies are also called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"middleware"}]},{"block_type":"text","content":", because, as it happens in the middleware pattern (which we will see later in the chapter), they allow us to pre-process and post-process the input/output of a function. Sometimes, they also allow the registering of multiple hooks for the same method using a middleware-like pipeline."}]},{"block_type":"element","block":"k5zy5bgc","search_text":"There are several libraries on npm that allow us to implement function hooks with little effort. Among them there are hooks ( https://npmjs.org/package/hooks ), hooker ( https://npmjs.org/package/hooker ), and meld ( https://npmjs.org/package/meld ).","text_count":250,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are several libraries on npm that allow us to implement function hooks with little effort. Among them there are"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"hooks"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/hooks"},"children":[{"block_type":"text","content":"https://npmjs.org/package/hooks"}]},{"block_type":"text","content":"),"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"hooker"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/hooker"},"children":[{"block_type":"text","content":"https://npmjs.org/package/hooker"}]},{"block_type":"text","content":"), and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"meld"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/meld"},"children":[{"block_type":"text","content":"https://npmjs.org/package/meld"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5bgd","search_text":"ES2015 Proxy","text_count":12,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"ES2015 Proxy"}]},{"block_type":"element","block":"k5zy5bge","search_text":"The ES2015 specification introduced a global object called Proxy, which is available in Node.js starting from version 6.","text_count":120,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The ES2015 specification introduced a global object called Proxy, which is available in Node.js starting from version 6."}]},{"block_type":"element","block":"k5zy5bgf","search_text":"The Proxy API contains a Proxy constructor that accepts a target and a handler as arguments:","text_count":92,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Proxy API contains a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Proxy"}]},{"block_type":"text","content":"constructor that accepts a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"target"}]},{"block_type":"text","content":"and a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"handler"}]},{"block_type":"text","content":"as arguments:"}]},{"block_type":"element","block":"k5zy5bgg","search_text":"const proxy = new Proxy(target, handler); ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const proxy = new Proxy(target, handler);"}]}]},{"block_type":"element","block":"k5zy5bgh","search_text":"Here,c target represents the object on which the proxy is applied (the subject for our canonical definition), while handler is a special object that defines the behavior of the proxy.","text_count":183,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Here,c"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"target"}]},{"block_type":"text","content":"represents the object on which the proxy is applied (the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"subject"}]},{"block_type":"text","content":"for our canonical definition), while"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"handler"}]},{"block_type":"text","content":"is a special object that defines the behavior of the proxy."}]},{"block_type":"element","block":"k5zy5bgi","search_text":"The handler object contains a series of optional methods with predefined names called trap methods (for example, apply , get , set , and has ) that are automatically called when the corresponding operations are performed on the proxy instance.","text_count":243,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"handler"}]},{"block_type":"text","content":"object contains a series of optional methods with predefined names called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"trap methods"}]},{"block_type":"text","content":"(for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"apply"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"set"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"has"}]},{"block_type":"text","content":") that are automatically called when the corresponding operations are performed on the proxy instance."}]},{"block_type":"element","block":"k5zy5bgj","search_text":"To better understand how this API works, let's see an example:","text_count":62,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To better understand how this API works, let's see an example:"}]},{"block_type":"element","block":"k5zy5bgk","search_text":"const scientist = { name: 'nikola', surname: 'tesla' }; const uppercaseScientist = new Proxy(scientist, { get: (target, property) => target[property].toUpperCase() }); console.log(uppercaseScientist.name, uppercaseScientist.surname); // prints NIKOLA TESLA ","text_count":257,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const scientist = { \n  name: 'nikola', \n  surname: 'tesla' \n}; \n \nconst uppercaseScientist = new Proxy(scientist, { \n  get: (target, property) =&gt; target[property].toUpperCase() \n}); \n \nconsole.log(uppercaseScientist.name, uppercaseScientist.surname);  \n  // prints NIKOLA TESLA"}]}]},{"block_type":"element","block":"k5zy5bgl","search_text":"In this example, we are using the Proxy API to intercept all access to the properties of the target object, scientist , and convert the original value of the property to an uppercase string.","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this example, we are using the Proxy API to intercept all access to the properties of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"target"}]},{"block_type":"text","content":"object,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"scientist"}]},{"block_type":"text","content":", and convert the original value of the property to an uppercase string."}]},{"block_type":"element","block":"k5zy5bgm","search_text":"If you look carefully at this example, you can probably notice something very peculiar about this API: it allows us to intercept access to the generic attribute in the target object. This is possible because the API is not just a simple wrapper to facilitate the creation of proxy objects, like the ones we defined in the previous sections of this chapter; instead it is a feature deeply integrated into the JavaScript language itself, which enables developers to intercept and customize many operations that can be performed on objects. This characteristic opens up new interesting scenarios that were not easily achievable before such as meta-programming , operator overloading , and object virtualization .","text_count":709,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you look carefully at this example, you can probably notice something very peculiar about this API: it allows us to intercept access to the generic attribute in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"target"}]},{"block_type":"text","content":"object. This is possible because the API is not just a simple wrapper to facilitate the creation of proxy objects, like the ones we defined in the previous sections of this chapter; instead it is a feature deeply integrated into the JavaScript language itself, which enables developers to intercept and customize many operations that can be performed on objects. This characteristic opens up new interesting scenarios that were not easily achievable before such as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"meta-programming"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"operator overloading"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"object virtualization"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bgn","search_text":"Let's see another example to clarify this concept:","text_count":50,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see another example to clarify this concept:"}]},{"block_type":"element","block":"k5zy5bgo","search_text":"const evenNumbers = new Proxy([], { get: (target, index) => index * 2, has: (target, number) => number % 2 === 0 }); console.log(2 in evenNumbers); // true console.log(5 in evenNumbers); // false console.log(evenNumbers[7]); // 14 ","text_count":231,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const evenNumbers = new Proxy([], { \n  get: (target, index) =&gt; index * 2, \n  has: (target, number) =&gt; number % 2 === 0 \n}); \n \nconsole.log(2 in evenNumbers); // true \nconsole.log(5 in evenNumbers); // false \nconsole.log(evenNumbers[7]);   // 14"}]}]},{"block_type":"element","block":"k5zy5bgp","search_text":"In this example, we are creating a virtual array that contains all the even numbers. It can be used as a regular array, which means we can access items in the array with the regular array syntax (for example, evenNumbers[7] ), or check the existence of an element in the array with th in operator (for example, 2 in evenNumbers ). The array is considered virtual because we never store data in it.","text_count":397,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this example, we are creating a virtual array that contains all the even numbers. It can be used as a regular array, which means we can access items in the array with the regular array syntax (for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"evenNumbers[7]"}]},{"block_type":"text","content":"), or check the existence of an element in the array with th"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"in"}]},{"block_type":"text","content":"operator (for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"2 in evenNumbers"}]},{"block_type":"text","content":"). The array is considered"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"virtual"}]},{"block_type":"text","content":"because we never store data in it."}]},{"block_type":"element","block":"k5zy5bgq","search_text":"Looking at the implementation, this proxy uses an empty array as the target and then defines the traps get and has in the handler:","text_count":130,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Looking at the implementation, this proxy uses an empty array as the target and then defines the traps"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"has"}]},{"block_type":"text","content":"in the handler:"}]},{"block_type":"element","block":"k5zy5bgr","search_text":"The get trap intercepts access to the array elements, returning the even number for the given index The has trap instead intercepts the usage of the in operator and checks whether the given number is even or not ","text_count":212,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get"}]},{"block_type":"text","content":"trap intercepts access to the array elements, returning the even number for the given index"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"has"}]},{"block_type":"text","content":"trap instead intercepts the usage of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"in"}]},{"block_type":"text","content":"operator and checks whether the given number is even or not"}]}]},{"block_type":"element","block":"k5zy5bgs","search_text":"The Proxy API supports a number of other interesting traps such as set , delete , and construct , and allows us to create proxies that can be revoked on demand, disabling all the traps and restoring the original behavior of the target object.","text_count":242,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Proxy API supports a number of other interesting traps such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"set"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"delete"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"construct"}]},{"block_type":"text","content":", and allows us to create proxies that can be revoked on demand, disabling all the traps and restoring the original behavior of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"target"}]},{"block_type":"text","content":"object."}]},{"block_type":"element","block":"k5zy5bgt","search_text":"Analyzing all these features goes beyond the scope of this chapter; what is important here is understanding that the Proxy API provides a powerful foundation for taking advantage of the Proxy design pattern when you need it.","text_count":224,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Analyzing all these features goes beyond the scope of this chapter; what is important here is understanding that the Proxy API provides a powerful foundation for taking advantage of the Proxy design pattern when you need it."}]},{"block_type":"element","block":"k5zy5bgu","search_text":"Tip If you are curious to know more about the Proxy API and discover all its capabilities and trap methods, you can read more in this article by Mozilla: https://developer.mozilla.org/it/docs/Web/JavaScript/Reference/Global_Objects/Proxy . Another good source is this detailed article from Google: https://developers.google.com/web/updates/2016/02/es2015-proxies . ","text_count":365,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you are curious to know more about the Proxy API and discover all its capabilities and trap methods, you can read more in this article by Mozilla:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://developer.mozilla.org/it/docs/Web/JavaScript/Reference/Global_Objects/Proxy"},"children":[{"block_type":"text","content":"https://developer.mozilla.org/it/docs/Web/JavaScript/Reference/Global_Objects/Proxy"}]},{"block_type":"text","content":". Another good source is this detailed article from Google:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://developers.google.com/web/updates/2016/02/es2015-proxies"},"children":[{"block_type":"text","content":"https://developers.google.com/web/updates/2016/02/es2015-proxies"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5bgv","search_text":"In the wild","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"In the wild"}]},{"block_type":"element","block":"k5zy5bgw","search_text":"Mongoose ( http://mongoosejs.com ) is a popular Object-Document Mapping ( ODM ) library for MongoDB. Internally, it uses the hooks package ( https://npmjs.org/package/hooks ) to provide pre-and post-execution hooks for the init , validate , save , and remove methods of its Document objects. Find out more with the official documentation at http://mongoosejs.com/docs/middleware.html .","text_count":385,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Mongoose"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://mongoosejs.com/"},"children":[{"block_type":"text","content":"http://mongoosejs.com"}]},{"block_type":"text","content":") is a popular"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Object-Document Mapping"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"ODM"}]},{"block_type":"text","content":") library for MongoDB. Internally, it uses the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"hooks"}]},{"block_type":"text","content":"package ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/hooks"},"children":[{"block_type":"text","content":"https://npmjs.org/package/hooks"}]},{"block_type":"text","content":") to provide pre-and post-execution hooks for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"init"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"validate"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"save"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"remove"}]},{"block_type":"text","content":"methods of its"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Document"}]},{"block_type":"text","content":"objects. Find out more with the official documentation at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://mongoosejs.com/docs/middleware.html"},"children":[{"block_type":"text","content":"http://mongoosejs.com/docs/middleware.html"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bgx","search_text":"Decorator","text_count":9,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Decorator"}]},{"block_type":"element","block":"k5zy5bgy","search_text":"Decorator is a structural pattern that consists of dynamically augmenting the behavior of an existing object. It's different from classical inheritance, because the behavior is not added to all the objects of the same class, but only to the instances that are explicitly decorated.","text_count":281,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Decorator is a structural pattern that consists of dynamically augmenting the behavior of an existing object. It's different from classical inheritance, because the behavior is not added to all the objects of the same class, but only to the instances that are explicitly decorated."}]},{"block_type":"element","block":"k5zy5bgz","search_text":"Implementation-wise, it is very similar to the Proxy pattern, but instead of enhancing or modifying the behavior of the existing interface of an object, it augments it with new functionalities, as described in the following figure:","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Implementation-wise, it is very similar to the Proxy pattern, but instead of enhancing or modifying the behavior of the existing interface of an object, it augments it with new functionalities, as described in the following figure:"}]},{"block_type":"element","block":"k5zy5bh0","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000069.jpg","alt":"Decorator","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bh1","search_text":"In the previous figure, the Decorator object is extending the Component object by adding the methodC() operation. The existing methods are usually delegated to the decorated object, without further processing. Of course, if necessary we can easily combine the Proxy pattern so that the calls to the existing methods can be intercepted and manipulated as well.","text_count":359,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous figure, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Decorator"}]},{"block_type":"text","content":"object is extending the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Component"}]},{"block_type":"text","content":"object by adding the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"methodC()"}]},{"block_type":"text","content":"operation. The existing methods are usually delegated to the decorated object, without further processing. Of course, if necessary we can easily combine the Proxy pattern so that the calls to the existing methods can be intercepted and manipulated as well."}]},{"block_type":"element","block":"k5zy5bh2","search_text":"Techniques for implementing Decorators","text_count":38,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Techniques for implementing Decorators"}]},{"block_type":"element","block":"k5zy5bh3","search_text":"Although Proxy and Decorator are conceptually two different patterns with different intents, they practically share the same implementation strategies. Let's review them.","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Although Proxy and Decorator are conceptually two different patterns with different intents, they practically share the same implementation strategies. Let's review them."}]},{"block_type":"element","block":"k5zy5bh4","search_text":"Composition","text_count":11,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Composition"}]},{"block_type":"element","block":"k5zy5bh5","search_text":"Using composition, the decorated component is wrapped around a new object that usually inherits from it. The Decorator in this case simply needs to define the new methods, while delegating the existing ones to the original component:","text_count":233,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using composition, the decorated component is wrapped around a new object that usually inherits from it. The Decorator in this case simply needs to define the new methods, while delegating the existing ones to the original component:"}]},{"block_type":"element","block":"k5zy5bh6","search_text":"function decorate(component) { const proto = Object.getPrototypeOf(component); function Decorator(component) { this.component = component; } Decorator.prototype = Object.create(proto); //new method Decorator.prototype.greetings = function() { return 'Hi!'; }; //delegated method Decorator.prototype.hello = function() { return this.component.hello.apply(this.component, arguments); }; return new Decorator(component); }","text_count":419,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function decorate(component) { \n  const proto = Object.getPrototypeOf(component); \n \n  function Decorator(component) { \n    this.component = component; \n  } \n \n  Decorator.prototype = Object.create(proto); \n \n  //new method \n  Decorator.prototype.greetings = function() { \n    return 'Hi!'; \n  }; \n \n  //delegated method \n  Decorator.prototype.hello = function() { \n    return this.component.hello.apply(this.component, arguments);  \n  }; \n \n  return new Decorator(component); \n}"}]}]},{"block_type":"element","block":"k5zy5bh7","search_text":"Object augmentation","text_count":19,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Object augmentation"}]},{"block_type":"element","block":"k5zy5bh8","search_text":"Object decoration can also be achieved by simply attaching new methods directly to the decorated object, as follows:","text_count":116,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Object decoration&nbsp;"}]},{"block_type":"text","content":"can also be achieved by simply attaching new methods directly to the decorated object, as follows:"}]},{"block_type":"element","block":"k5zy5bh9","search_text":"function decorate(component) { //new method component.greetings = () => { //... }; return component; } ","text_count":103,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function decorate(component) { \n  //new method \n  component.greetings = () =&gt; { \n    //... \n  }; \n  return component; \n}"}]}]},{"block_type":"element","block":"k5zy5bha","search_text":"The same caveats discussed during the analysis of the Proxy pattern are also valid for Decorator. Let's now practice the pattern with a working example!","text_count":152,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The same caveats discussed during the analysis of the Proxy pattern are also valid for Decorator. Let's now practice the pattern with a working example!"}]},{"block_type":"element","block":"k5zy5bhb","search_text":"Decorating a LevelUP database","text_count":29,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Decorating a LevelUP database"}]},{"block_type":"element","block":"k5zy5bhc","search_text":"Before we start coding the next example, let's say a few words about LevelUP , the module that we are now going to work with.","text_count":125,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Before we start coding the next example, let's say a few words about"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"LevelUP"}]},{"block_type":"text","content":", the module that we are now going to work with."}]},{"block_type":"element","block":"k5zy5bhd","search_text":"Introducing LevelUP and LevelDB","text_count":31,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Introducing LevelUP and LevelDB"}]},{"block_type":"element","block":"k5zy5bhe","search_text":"LevelUP ( https://npmjs.org/package/levelup ) is a Node.js wrapper around Google's LevelDB , a key/value store originally built to implement IndexedDB in the Chrome browser, but it's much more than that. LevelDB has been defined by Dominic Tarr as the \"Node.js of databases\" because of its minimalism and extensibility. Like Node.js, LevelDB provides blazingly fast performance and only the most basic set of features, allowing developers to build any kind of database on top of it.","text_count":482,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"LevelUP"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/levelup"},"children":[{"block_type":"text","content":"https://npmjs.org/package/levelup"}]},{"block_type":"text","content":") is a Node.js wrapper around Google's"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"LevelDB"}]},{"block_type":"text","content":", a key/value store originally built to implement IndexedDB in the Chrome browser, but it's much more than that. LevelDB has been defined by Dominic Tarr as the \"Node.js of databases\" because of its minimalism and extensibility. Like Node.js, LevelDB provides blazingly fast performance and only the most basic set of features, allowing developers to build any kind of database on top of it."}]},{"block_type":"element","block":"k5zy5bhf","search_text":"The Node.js community, and in this case Rod Vagg, did not miss the chance to bring the power of this database into Node.js by creating LevelUP. Born as a wrapper for LevelDB, it then evolved to support several kinds of backend, from in-memory stores, to other NoSQL databases such as Riak and Redis, to web storage engines such as IndexedDB and localStorage, allowing us to use the same API on both the server and the client, opening up some really interesting scenarios.","text_count":471,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Node.js community, and in this case Rod Vagg, did not miss the chance to bring the power of this database into Node.js by creating LevelUP. Born as a wrapper for LevelDB, it then evolved to support several kinds of backend, from in-memory stores, to other NoSQL databases such as Riak and Redis, to web storage engines such as IndexedDB and localStorage, allowing us to use the same API on both the server and the client, opening up some really interesting scenarios."}]},{"block_type":"element","block":"k5zy5bhg","search_text":"Today, there is a fully-fledged ecosystem around LevelUP made of plugins and modules that extend the tiny core to implement features such as replication, secondary indexes, live updates, query engines, and more. Also, complete databases were built on top of LevelUP, including CouchDB clones such as PouchDB ( https://npmjs.org/package/pouchdb ) and CouchUP ( https://npmjs.org/package/couchup ), and even a graph database, levelgraph ( https://npmjs.org/package/levelgraph ), which can work both on Node.js and the browser!","text_count":524,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Today, there is a fully-fledged ecosystem around LevelUP made of plugins and modules that extend the tiny core to implement features such as replication, secondary indexes, live updates, query engines, and more. Also, complete databases were built on top of LevelUP, including CouchDB clones such as PouchDB ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/pouchdb"},"children":[{"block_type":"text","content":"https://npmjs.org/package/pouchdb"}]},{"block_type":"text","content":") and CouchUP ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/couchup"},"children":[{"block_type":"text","content":"https://npmjs.org/package/couchup"}]},{"block_type":"text","content":"), and even a graph database, levelgraph ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/levelgraph"},"children":[{"block_type":"text","content":"https://npmjs.org/package/levelgraph"}]},{"block_type":"text","content":"), which can work both on Node.js and the browser!"}]},{"block_type":"element","block":"k5zy5bhh","search_text":"Note Find out more about the LevelUP ecosystem at: https://github.com/rvagg/node-levelup/wiki/Modules . ","text_count":104,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Find out more about the LevelUP ecosystem at:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/rvagg/node-levelup/wiki/Modules"},"children":[{"block_type":"text","content":"https://github.com/rvagg/node-levelup/wiki/Modules"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5bhi","search_text":"Implementing a LevelUP plugin","text_count":29,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing a LevelUP plugin"}]},{"block_type":"element","block":"k5zy5bhj","search_text":"In the next example, we are going to show how we can create a simple plugin for LevelUP using the Decorator pattern, and in particular, the object augmentation technique, which is the simplest but nevertheless the most pragmatic and effective way to decorate objects with additional capabilities.","text_count":296,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next example, we are going to show how we can create a simple plugin for LevelUP using the Decorator pattern, and in particular, the object augmentation technique, which is the simplest but nevertheless the most pragmatic and effective way to decorate objects with additional capabilities."}]},{"block_type":"element","block":"k5zy5bhk","search_text":"Note For convenience, we are going to use the level package ( http://npmjs.org/package/level ), which bundles both levelup and the default adapter called leveldown , which uses LevelDB as the backend. ","text_count":201,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For convenience, we are going to use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"level"}]},{"block_type":"text","content":"package ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://npmjs.org/package/level"},"children":[{"block_type":"text","content":"http://npmjs.org/package/level"}]},{"block_type":"text","content":"), which bundles both"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"levelup"}]},{"block_type":"text","content":"and the default adapter called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"leveldown"}]},{"block_type":"text","content":", which uses LevelDB as the backend."}]}]},{"block_type":"element","block":"k5zy5bhl","search_text":"What we want to build is a plugin for LevelUP that allows us to receive notifications every time an object with a certain pattern is saved into the database. For example, if we subscribe to a pattern such as {a: 1} , we want to receive a notification when objects such as {a: 1, b: 3} or {a: 1, c: 'x'} are saved into the database.","text_count":331,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What we want to build is a plugin for LevelUP that allows us to receive notifications every time an object with a certain pattern is saved into the database. For example, if we subscribe to a pattern such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{a: 1}"}]},{"block_type":"text","content":", we want to receive a notification when objects such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{a: 1, b: 3}"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{a: 1, c: 'x'}"}]},{"block_type":"text","content":"are saved into the database."}]},{"block_type":"element","block":"k5zy5bhm","search_text":"Let's start to build our small plugin by creating a new module called levelSubscribe.js . We will then insert the following code:","text_count":129,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start to build our small plugin by creating a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"levelSubscribe.js"}]},{"block_type":"text","content":". We will then insert the following code:"}]},{"block_type":"element","block":"k5zy5bhn","search_text":"module.exports = function levelSubscribe(db) { db.subscribe = (pattern, listener) => { //[1] db.on('put', (key, val) => { //[2] const match = Object.keys(pattern).every( k => (pattern[k] === val[k]) //[3] ); if(match) { listener(key, val); //[4] } }); }; return db; }; ","text_count":269,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = function levelSubscribe(db) { \n \n  db.subscribe = (pattern, listener) =&gt; {        //[1] \n    db.on('put', (key, val) =&gt; {                 //[2] \n      const match = Object.keys(pattern).every( \n        k =&gt; (pattern[k] === val[k])             //[3] \n      ); \n      if(match) { \n        listener(key, val);                      //[4] \n      } \n    }); \n  }; \n \n  return db; \n};"}]}]},{"block_type":"element","block":"k5zy5bho","search_text":"That's it for our plugin, it's extremely simple. Let's briefly see what happens in the preceding code:","text_count":102,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's it for our plugin, it's extremely simple. Let's briefly see what happens in the preceding code:"}]},{"block_type":"element","block":"k5zy5bhp","search_text":"We decorated the db object with a new method named subscribe() . We simply attached the method directly to the provided db instance (object augmentation). We listened for any put operation performed on the database. We performed a very simple pattern-matching algorithm, which verified that all the properties in the provided pattern are also available on the data being inserted. If we have a match, we notify the listener. ","text_count":425,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We decorated the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"object with a new method named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subscribe()"}]},{"block_type":"text","content":". We simply attached the method directly to the provided"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"instance (object augmentation)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We listened for any"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"put"}]},{"block_type":"text","content":"operation performed on the database."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We performed a very simple pattern-matching algorithm, which verified that all the properties in the provided pattern are also available on the data being inserted."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If we have a match, we notify the listener."}]}]},{"block_type":"element","block":"k5zy5bhq","search_text":"Let's now create some code—in a new file named levelSubscribeTest.js —to try out our new plugin:","text_count":96,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now create some code&mdash;in a new file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"levelSubscribeTest.js"}]},{"block_type":"text","content":"&mdash;to try out our new plugin:"}]},{"block_type":"element","block":"k5zy5bhr","search_text":"const level = require('level'); //[1] const levelSubscribe = require('./levelSubscribe'); //[2] let db = level(__dirname + '/db', {valueEncoding: 'json'}); db = levelSubscribe(db); db.subscribe( {doctype: 'tweet', language: 'en'}, //[3] (k, val) => console.log(val) ); db.put('1', {doctype: 'tweet', text: 'Hi', language: 'en'}); //[4] db.put('2', {doctype: 'company', name: 'ACME Co.'}); ","text_count":389,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const level = require('level');                              //[1] \nconst levelSubscribe = require('./levelSubscribe');          //[2] \n \nlet db = level(__dirname + '/db', {valueEncoding: 'json'}); \ndb = levelSubscribe(db); \n \ndb.subscribe( \n  {doctype: 'tweet', language: 'en'},                        //[3] \n  (k, val) =&gt; console.log(val)  \n); \ndb.put('1', {doctype: 'tweet', text: 'Hi', language: 'en'}); //[4] \ndb.put('2', {doctype: 'company', name: 'ACME Co.'});"}]}]},{"block_type":"element","block":"k5zy5bhs","search_text":"This is what we did in the preceding code:","text_count":42,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is what we did in the preceding code:"}]},{"block_type":"element","block":"k5zy5bht","search_text":"First, we initialize our LevelUP database, choosing the directory where the files will be stored and the default encoding for the values. Then, we attach our plugin, which decorates the original db object. At this point, we are ready to use the new feature provided by our plugin, the subscribe() method, where we specify that we are interested in all the objects with doctype: 'tweet' and language: 'en' . Finally, we save some values in the database using put . The first call will trigger the callback associated to our subscription and we will see the stored object printed in the console. This is because in this case the object matches the subscription. Instead, the second call will not generate any output because the stored object will not match the subscription criteria. ","text_count":782,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, we initialize our LevelUP database, choosing the directory where the files will be stored and the default encoding for the values."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Then, we attach our plugin, which decorates the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"object."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At this point, we are ready to use the new feature provided by our plugin, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subscribe()"}]},{"block_type":"text","content":"method, where we specify that we are interested in all the objects with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"doctype: 'tweet'"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"language: 'en'"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, we save some values in the database using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"put"}]},{"block_type":"text","content":". The first call will trigger the callback associated to our subscription and we will see the stored object printed in the console. This is because in this case the object matches the subscription. Instead, the second call will not generate any output because the stored object will not match the subscription criteria."}]}]},{"block_type":"element","block":"k5zy5bhu","search_text":"This example shows a real application of the decorator pattern in its simplest implementation: object augmentation. It might look like a trivial pattern, but it has undoubted power if used appropriately.","text_count":203,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This example shows a real application of the decorator pattern in its simplest implementation: object augmentation. It might look like a trivial pattern, but it has undoubted power if used appropriately."}]},{"block_type":"element","block":"k5zy5bhv","search_text":"Tip For simplicity, our plugin will work only in combination with the put operations, but it can be easily expanded to work even with the batch operations ( https://github.com/rvagg/node-levelup#batch ). ","text_count":204,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For simplicity, our plugin will work only in combination with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"put"}]},{"block_type":"text","content":"operations, but it can be easily expanded to work even with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"batch"}]},{"block_type":"text","content":"operations ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/rvagg/node-levelup#batch"},"children":[{"block_type":"text","content":"https://github.com/rvagg/node-levelup#batch"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5bhw","search_text":"In the wild","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"In the wild"}]},{"block_type":"element","block":"k5zy5bhx","search_text":"For more examples of how Decorator is used in the real world, we might want to inspect the code of some more LevelUP plugins:","text_count":125,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For more examples of how Decorator is used in the real world, we might want to inspect the code of some more LevelUP plugins:"}]},{"block_type":"element","block":"k5zy5bhy","search_text":"level-inverted-index ( https://github.com/dominictarr/level-inverted-index ): This is a plugin that adds inverted indexes to a LevelUP database, allowing us to perform simple text searches across the values stored in the database level-plus ( https://github.com/eugeneware/levelplus ): This is a plugin that adds atomic updates to a LevelUP database ","text_count":350,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"level-inverted-index"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/dominictarr/level-inverted-index"},"children":[{"block_type":"text","content":"https://github.com/dominictarr/level-inverted-index"}]},{"block_type":"text","content":"): This is a plugin that adds inverted indexes to a LevelUP database, allowing us to perform simple text searches across the values stored in the database"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"level-plus"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/eugeneware/levelplus"},"children":[{"block_type":"text","content":"https://github.com/eugeneware/levelplus"}]},{"block_type":"text","content":"): This is a plugin that adds atomic updates to a LevelUP database"}]}]},{"block_type":"element","block":"k5zy5bhz","search_text":"Adapter","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Adapter"}]},{"block_type":"element","block":"k5zy5bi0","search_text":"The Adapter pattern allows us to access the functionality of an object using a different interface. As the name suggests, it adapts an object so that it can be used by components expecting a different interface. The following diagram clarifies the situation:","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Adapter pattern allows us to access the functionality of an object using a different interface. As the name suggests, it adapts an object so that it can be used by components expecting a different interface. The following diagram clarifies the situation:"}]},{"block_type":"element","block":"k5zy5bi1","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000039.jpg","alt":"Adapter","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bi2","search_text":"The preceding diagram shows how the Adapter is essentially a wrapper for the Adaptee, exposing a different interface. The diagram also highlights the fact that the operations of the Adapter can also be a composition of one or more method invocations on the Adaptee. From an implementation perspective, the most common technique is composition, where the methods of the Adapter provide a bridge to the methods of the Adaptee. This pattern is pretty straightforward, so let's immediately work on an example.","text_count":505,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding diagram shows how the Adapter is essentially a wrapper for the Adaptee, exposing a different interface. The diagram also highlights the fact that the operations of the Adapter can also be a composition of one or more method invocations on the Adaptee. From an implementation perspective, the most common technique is composition, where the methods of the Adapter provide a bridge to the methods of the Adaptee. This pattern is pretty straightforward, so let's immediately work on an example."}]},{"block_type":"element","block":"k5zy5bi3","search_text":"Using LevelUP through the filesystem API","text_count":40,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Using LevelUP through the filesystem API"}]},{"block_type":"element","block":"k5zy5bi4","search_text":"We are now going to build an Adapter around the LevelUP API, transforming it into an interface that is compatible with the core fs module. In particular, we will make sure that every call to readFile() and writeFile() will translate into calls to db.get() and db.put() ; this way we will be able to use a LevelUP database as a storage backend for simple filesystem operations.","text_count":376,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are now going to build an Adapter around the LevelUP API, transforming it into an interface that is compatible with the core"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"module. In particular, we will make sure that every call to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readFile()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writeFile()"}]},{"block_type":"text","content":"will translate into calls to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db.get()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db.put()"}]},{"block_type":"text","content":"; this way we will be able to use a LevelUP database as a storage backend for simple filesystem operations."}]},{"block_type":"element","block":"k5zy5bi5","search_text":"Let's start by creating a new module named fsAdapter.js . We will begin by loading the dependencies and exporting the createFsAdapter() factory that we are going to use to build the adapter:","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start by creating a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fsAdapter.js"}]},{"block_type":"text","content":". We will begin by loading the dependencies and exporting the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"createFsAdapter()"}]},{"block_type":"text","content":"factory that we are going to use to build the adapter:"}]},{"block_type":"element","block":"k5zy5bi6","search_text":"const path = require('path'); module.exports = function createFsAdapter(db) { const fs = {}; //...continues with the next code fragments ","text_count":137,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const path = require('path'); \n \nmodule.exports = function createFsAdapter(db) { \n  const fs = {}; \n  //...continues with the next code fragments"}]}]},{"block_type":"element","block":"k5zy5bi7","search_text":"Next, we will implement the readFile() function inside the factory and ensure that its interface is compatible with one of the original functions from the fs module:","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, we will implement the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"readFile()"}]},{"block_type":"text","content":"function inside the factory and ensure that its interface is compatible with one of the original functions from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5bi8","search_text":"fs.readFile = (filename, options, callback) => { if(typeof options === 'function') { callback = options; options = {}; } else if(typeof options === 'string') { options = {encoding: options}; } db.get(path.resolve(filename), { //[1] valueEncoding: options.encoding }, (err, value) => { if(err) { if(err.type === 'NotFoundError') { //[2] err = new Error(`ENOENT, open \"${filename}\"`); err.code = 'ENOENT'; err.errno = 34; err.path = filename; } return callback && callback(err); } callback && callback(null, value); //[3] } ); }; ","text_count":528,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fs.readFile = (filename, options, callback) =&gt; { \n  if(typeof options === 'function') { \n    callback = options; \n    options = {}; \n  } else if(typeof options === 'string') { \n    options = {encoding: options}; \n  } \n \n  db.get(path.resolve(filename), {                   //[1] \n      valueEncoding: options.encoding \n    }, \n    (err, value) =&gt; { \n      if(err) { \n        if(err.type === 'NotFoundError') {           //[2] \n          err = new Error(`ENOENT, open \"${filename}\"`); \n          err.code = 'ENOENT'; \n          err.errno = 34; \n          err.path = filename; \n        } \n        return callback && callback(err); \n      } \n      callback && callback(null, value);             //[3] \n    } \n  ); \n};"}]}]},{"block_type":"element","block":"k5zy5bi9","search_text":"In the preceding code, we had to do some extra work to make sure that the behavior of our new function is as close as possible to the original fs.readFile() function. The steps performed by the function are described as follows:","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we had to do some extra work to make sure that the behavior of our new function is as close as possible to the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs.readFile()"}]},{"block_type":"text","content":"function. The steps performed by the function are described as follows:"}]},{"block_type":"element","block":"k5zy5bia","search_text":"To retrieve a file from the db class, we invoke db.get() , using filename as a key, by making sure to always use its full path (using path.resolve() ). We set the value of valueEncoding used by the database to be equal to any eventual encoding option received as an input. If the key is not found in the database, we create an error with ENOENT as the error code, which is the code used by the original fs module to indicate a missing file. Any other type of error is forwarded to callback (for the scope of this example, we are adapting only the most common error condition). If the key/value pair is retrieved successfully from the database, we will return the value to the caller using the callback . ","text_count":704,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"To retrieve a file from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"class, we invoke"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db.get()"}]},{"block_type":"text","content":", using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"filename"}]},{"block_type":"text","content":"as a key, by making sure to always use its full path (using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"path.resolve()"}]},{"block_type":"text","content":"). We set the value of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"valueEncoding"}]},{"block_type":"text","content":"used by the database to be equal to any eventual"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"encoding"}]},{"block_type":"text","content":"option received as an input."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If the key is not found in the database, we create an error with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ENOENT"}]},{"block_type":"text","content":"as the error code, which is the code used by the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"module to indicate a missing file. Any other type of error is forwarded to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"(for the scope of this example, we are adapting only the most common error condition)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If the key/value pair is retrieved successfully from the database, we will return the value to the caller using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5bib","search_text":"As we can see, the function that we created is quite rough; it does not want to be a perfect replacement for the fs.readFile() function, but it definitely does its job in the most common situations.","text_count":198,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, the function that we created is quite rough; it does not want to be a perfect replacement for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs.readFile()"}]},{"block_type":"text","content":"function, but it definitely does its job in the most common situations."}]},{"block_type":"element","block":"k5zy5bic","search_text":"To complete our small adapter, let's now see how to implement the writeFile() function:","text_count":87,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To complete our small adapter, let's now see how to implement the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"writeFile()"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k5zy5bid","search_text":"fs.writeFile = (filename, contents, options, callback) => { if(typeof options === 'function') { callback = options; options = {}; } else if(typeof options === 'string') { options = {encoding: options}; } db.put(path.resolve(filename), contents, { valueEncoding: options.encoding }, callback); } ","text_count":295,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"fs.writeFile = (filename, contents, options, callback) =&gt; { \n  if(typeof options === 'function') { \n    callback = options; \n    options = {}; \n  } else if(typeof options === 'string') { \n    options = {encoding: options}; \n  } \n \n  db.put(path.resolve(filename), contents, { \n    valueEncoding: options.encoding \n  }, callback); \n}"}]}]},{"block_type":"element","block":"k5zy5bie","search_text":"Also, in this case, we don't have a perfect wrapper; we will ignore some options such as file permissions ( options.mode ), and we will forward any error that we receive from the database as it is.","text_count":197,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, in this case, we don't have a perfect wrapper; we will ignore some options such as file permissions ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"options.mode"}]},{"block_type":"text","content":"), and we will forward any error that we receive from the database as it is."}]},{"block_type":"element","block":"k5zy5bif","search_text":"Finally, we only have to return the fs object and close the factory function using the following line of code:","text_count":110,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we only have to return the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"object and close the factory function using the following line of code:"}]},{"block_type":"element","block":"k5zy5big","search_text":"return fs; } ","text_count":13,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"return fs; \n}"}]}]},{"block_type":"element","block":"k5zy5bih","search_text":"Our new adapter is now ready; if we now write a small test module, we can try to use it:","text_count":88,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our new adapter is now ready; if we now write a small test module, we can try to use it:"}]},{"block_type":"element","block":"k5zy5bii","search_text":"const fs = require('fs'); fs.writeFile('file.txt', 'Hello!', () => { fs.readFile('file.txt', {encoding: 'utf8'}, (err, res) => { console.log(res); }); }); //try to read a missing file fs.readFile('missing.txt', {encoding: 'utf8'}, (err, res) => { console.log(err); }); ","text_count":269,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \n \nfs.writeFile('file.txt', 'Hello!', () =&gt; { \n  fs.readFile('file.txt', {encoding: 'utf8'}, (err, res) =&gt; { \n    console.log(res); \n  }); \n}); \n \n//try to read a missing file \nfs.readFile('missing.txt', {encoding: 'utf8'}, (err, res) =&gt; { \n  console.log(err); \n});"}]}]},{"block_type":"element","block":"k5zy5bij","search_text":"The preceding code uses the original fs API to perform a few read and write operations on the filesystem, and should print something like the following to the console:","text_count":167,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code uses the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"API to perform a few read and write operations on the filesystem, and should print something like the following to the console:"}]},{"block_type":"element","block":"k5zy5bik","search_text":"{ [Error: ENOENT, open 'missing.txt'] errno: 34, code: 'ENOENT', path: 'missing.txt' } Hello! ","text_count":94,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"{ [Error: ENOENT, open 'missing.txt'] errno: 34, code: 'ENOENT', path: 'missing.txt' }\nHello!"}]}]},{"block_type":"element","block":"k5zy5bil","search_text":"Now, we can try to replace the fs module with our adapter, as follows:","text_count":70,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, we can try to replace the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"module with our adapter, as follows:"}]},{"block_type":"element","block":"k5zy5bim","search_text":"const levelup = require('level'); const fsAdapter = require('./fsAdapter'); const db = levelup('./fsDB', {valueEncoding: 'binary'}); const fs = fsAdapter(db); ","text_count":159,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const levelup = require('level'); \nconst fsAdapter = require('./fsAdapter'); \nconst db = levelup('./fsDB', {valueEncoding: 'binary'}); \nconst fs = fsAdapter(db);"}]}]},{"block_type":"element","block":"k5zy5bin","search_text":"Running our program again should produce the same output, except for the fact that no parts of the file that we specified is read or written using the filesystem; instead, any operation performed using our adapter will be converted into an operation performed on a LevelUP database.","text_count":282,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Running our program again should produce the same output, except for the fact that no parts of the file that we specified is read or written using the filesystem; instead, any operation performed using our adapter will be converted into an operation performed on a LevelUP database."}]},{"block_type":"element","block":"k5zy5bio","search_text":"The adapter that we just created might look silly; what's the purpose of using a database in place of the real filesystem? However, we should remember that LevelUP itself has adapters that enable the database to also run in the browser; one of these adapters is level.js ( https://npmjs.org/package/level-js ). Now our adapter should make perfect sense; we can think of using it to share with the browser code, which relies on the fs module! For example, the web spider that we created in Chapter 3, Asynchronous Control Flow Patterns with Callbacks , uses the fs API to store the web pages downloaded during its operations; our adapter will allow it to run in the browser by applying only minor modifications! We will soon realize that Adapter is also an extremely important pattern when it comes to sharing code with the browser, as we will see in more detail in Chapter 8, Universal JavaScript for Web Applications .","text_count":919,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The adapter that we just created might look silly; what's the purpose of using a database in place of the real filesystem? However, we should remember that LevelUP itself has adapters that enable the database to also run in the browser; one of these adapters is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"level.js"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/level-js"},"children":[{"block_type":"text","content":"https://npmjs.org/package/level-js"}]},{"block_type":"text","content":"). Now our adapter should make perfect sense; we can think of using it to share with the browser code, which relies on the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"module! For example, the web spider that we created in Chapter 3,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with Callbacks"}]},{"block_type":"text","content":", uses the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"API to store the web pages downloaded during its operations; our adapter will allow it to run in the browser by applying only minor modifications! We will soon realize that Adapter is also an extremely important pattern when it comes to sharing code with the browser, as we will see in more detail in Chapter 8,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Universal JavaScript for Web Applications"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bip","search_text":"In the wild","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"In the wild"}]},{"block_type":"element","block":"k5zy5biq","search_text":"There are plenty of real-world examples of the Adapter pattern: we list some of the most notable examples here for you to explore and analyze:","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are plenty of real-world examples of the Adapter pattern: we list some of the most notable examples here for you to explore and analyze:"}]},{"block_type":"element","block":"k5zy5bir","search_text":"We already know that LevelUP is able to run with different storage backends, from the default LevelDB to IndexedDB in the browser. This is made possible by the various adapters that are created to replicate the internal (private) LevelUP API. Take a look at some of them to see how they are implemented: https://github.com/rvagg/node-levelup/wiki/Modules#storage-back-ends . jugglingdb is a multi-database ORM and of course, multiple adapters are used to make it compatible with different databases. Take a look at some of them at: https://github.com/1602/jugglingdb/tree/master/lib/adapters . The perfect complement to the example that we created is level-filesystem ( https://www.npmjs.org/package/level-filesystem ), which is the proper implementation of the fs API on top of LevelUP. ","text_count":788,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We already know that LevelUP is able to run with different storage backends, from the default LevelDB to IndexedDB in the browser. This is made possible by the various adapters that are created to replicate the internal (private) LevelUP API. Take a look at some of them to see how they are implemented:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/rvagg/node-levelup/wiki/Modules#storage-back-ends"},"children":[{"block_type":"text","content":"https://github.com/rvagg/node-levelup/wiki/Modules#storage-back-ends"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"jugglingdb"}]},{"block_type":"text","content":"is a multi-database ORM and of course, multiple adapters are used to make it compatible with different databases. Take a look at some of them at:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/1602/jugglingdb/tree/master/lib/adapters"},"children":[{"block_type":"text","content":"https://github.com/1602/jugglingdb/tree/master/lib/adapters"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The perfect complement to the example that we created is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"level-filesystem"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.npmjs.org/package/level-filesystem"},"children":[{"block_type":"text","content":"https://www.npmjs.org/package/level-filesystem"}]},{"block_type":"text","content":"), which is the proper implementation of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"API on top of LevelUP."}]}]},{"block_type":"element","block":"k5zy5bis","search_text":"Strategy","text_count":8,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Strategy"}]},{"block_type":"element","block":"k5zy5bit","search_text":"The Strategy pattern enables an object, called the Context , to support variations in its logic by extracting the variable parts into separate, interchangeable objects called Strategies . The context implements the common logic of a family of algorithms, while a strategy implements the mutable parts, allowing the context to adapt its behavior depending on different factors such as an input value, a system configuration, or user preferences. The strategies are usually part of a family of solutions and all of them implement the same interface, which is the one that is expected by the context. The following figure shows the situation we just described:","text_count":657,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Strategy pattern enables an object, called the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Context"}]},{"block_type":"text","content":", to support variations in its logic by extracting the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"variable"}]},{"block_type":"text","content":"parts into separate, interchangeable objects called"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Strategies"}]},{"block_type":"text","content":". The context implements the common logic of a family of algorithms, while a strategy implements the mutable parts, allowing the context to adapt its behavior depending on different factors such as an input value, a system configuration, or user preferences. The strategies are usually part of a family of solutions and all of them implement the same interface, which is the one that is expected by the context. The following figure shows the situation we just described:"}]},{"block_type":"element","block":"k5zy5biu","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000000.jpg","alt":"Strategy","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5biv","search_text":"The preceding figure shows how the context object can plug different strategies into its structure, as if they were replaceable parts of a piece of machinery. Imagine a car; its tires can be considered its strategy for adapting to the different road conditions. We can fit winter tires to go on snowy roads thanks to their studs, while we can decide to fit high-performance tires for traveling mainly on motorways, for a long trip. On the one hand, we don't want to change the entire car for this to be possible, and on the other, we don't want a car with eight wheels so that it can go on every possible road.","text_count":610,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding figure shows how the context object can plug different strategies into its structure, as if they were replaceable parts of a piece of machinery. Imagine a car; its tires can be considered its strategy for adapting to the different road conditions. We can fit winter tires to go on snowy roads thanks to their studs, while we can decide to fit high-performance tires for traveling mainly on motorways, for a long trip. On the one hand, we don't want to change the entire car for this to be possible, and on the other, we don't want a car with eight wheels so that it can go on every possible road."}]},{"block_type":"element","block":"k5zy5biw","search_text":"We quickly understand how powerful this pattern is; not only does it help with separating the concerns within an algorithm, but it also enables it to have better flexibility and adapt to different variations of the same problem.","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We quickly understand how powerful this pattern is; not only does it help with separating the concerns within an algorithm, but it also enables it to have better flexibility and adapt to different variations of the same problem."}]},{"block_type":"element","block":"k5zy5bix","search_text":"The Strategy pattern is particularly useful in all those situations where supporting variations of an algorithm requires complex conditional logic (lots of if…else or switch statements), or mixing together different algorithms of the same family. Imagine an object called Order that represents an online order of an e-commerce website. The object has a method called pay() that, as it says, finalizes the order and transfers the funds from the user to the online store.","text_count":469,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Strategy pattern is particularly useful in all those situations where supporting variations of an algorithm requires complex conditional logic (lots of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if&hellip;else"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"switch"}]},{"block_type":"text","content":"statements), or mixing together different algorithms of the same family. Imagine an object called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Order"}]},{"block_type":"text","content":"that represents an online order of an e-commerce website. The object has a method called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pay()"}]},{"block_type":"text","content":"that, as it says, finalizes the order and transfers the funds from the user to the online store."}]},{"block_type":"element","block":"k5zy5biy","search_text":"To support different payment systems, we have a couple of options, as follows:","text_count":78,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To support different payment systems, we have a couple of options, as follows:"}]},{"block_type":"element","block":"k5zy5biz","search_text":"Use an if…else statement in the pay() method to complete the operation-based on the chosen payment option Delegate the logic of the payment to a strategy object that implements the logic for the specific payment gateway selected by the user ","text_count":241,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Use an&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if&hellip;else"}]},{"block_type":"text","content":"statement in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pay()"}]},{"block_type":"text","content":"method to complete the operation-based on the chosen payment option"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Delegate the logic of the payment to a strategy object that implements the logic for the specific payment gateway selected by the user"}]}]},{"block_type":"element","block":"k5zy5bj0","search_text":"In the first solution, our Order object cannot support other payment methods unless its code is modified. Also, this can become quite complex when the number of payment options grows. Instead, using the Strategy pattern enables the Order object to support a virtually unlimited number of payment methods and keeps its scope limited to only managing the details of the user, the purchased items, and relative price, while delegating the job of completing the payment to another object.","text_count":484,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the first solution, our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Order"}]},{"block_type":"text","content":"object cannot support other payment methods unless its code is modified. Also, this can become quite complex when the number of payment options grows. Instead, using the Strategy pattern enables the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Order"}]},{"block_type":"text","content":"object to support a virtually unlimited number of payment methods and keeps its scope limited to only managing the details of the user, the purchased items, and relative price, while delegating the job of completing the payment to another object."}]},{"block_type":"element","block":"k5zy5bj1","search_text":"Let's now demonstrate this pattern with a simple, realistic example.","text_count":68,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now demonstrate this pattern with a simple, realistic example."}]},{"block_type":"element","block":"k5zy5bj2","search_text":"Multi-format configuration objects","text_count":34,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Multi-format configuration objects"}]},{"block_type":"element","block":"k5zy5bj3","search_text":"Let's consider an object called Config that holds a set of configuration parameters used by an application, such as the database URL, the listening port of the server, and so on. The Config object should be able to provide a simple interface to access these parameters, but also a way to import and export the configuration using a persistent storage, such as a file. We want to be able to support different formats to store the configuration, for example, JSON, INI, or YAML.","text_count":476,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's consider an object called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"that holds a set of configuration parameters used by an application, such as the database URL, the listening port of the server, and so on. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"object should be able to provide a simple interface to access these parameters, but also a way to import and export the configuration using a persistent storage, such as a file. We want to be able to support different formats to store the configuration, for example, JSON, INI, or YAML."}]},{"block_type":"element","block":"k5zy5bj4","search_text":"By applying what we learned about the Strategy pattern, we can immediately identify the variable part of the Config object, which is the functionality that allows us to serialize and deserialize the configuration. This is going to be our strategy.","text_count":247,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By applying what we learned about the Strategy pattern, we can immediately identify the variable part of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"object, which is the functionality that allows us to serialize and deserialize the configuration. This is going to be our strategy."}]},{"block_type":"element","block":"k5zy5bj5","search_text":"Let's create a new module called config.js , and let's define the generic part of our configuration manager:","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"config.js"}]},{"block_type":"text","content":", and let's define the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"generic"}]},{"block_type":"text","content":"part of our configuration manager:"}]},{"block_type":"element","block":"k5zy5bj6","search_text":"const fs = require('fs'); const objectPath = require('object-path'); class Config { constructor(strategy) { this.data = {}; this.strategy = strategy; } get(path) { return objectPath.get(this.data, path); } //... rest of the class ","text_count":230,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nconst objectPath = require('object-path'); \n \nclass Config { \n  constructor(strategy) { \n    this.data = {}; \n    this.strategy = strategy; \n  } \n \n  get(path) { \n    return objectPath.get(this.data, path); \n  } \n//... rest of the class"}]}]},{"block_type":"element","block":"k5zy5bj7","search_text":"In the preceding code, we encapsulate the configuration data into an instance variable ( this.data ) and then we provide the set() and get() methods that allow us to access the configuration properties using a dotted path notation (for example, property.subProperty ) by leveraging npm library called object-path ( https://npmjs.org/package/object-path ). In the constructor, we also take in a strategy as input, which represents an algorithm for parsing and serializing the data.","text_count":480,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we encapsulate the configuration data into an instance variable ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this.data"}]},{"block_type":"text","content":") and then we provide the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"set()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get()"}]},{"block_type":"text","content":"methods that allow us to access the configuration properties using a dotted path notation (for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"property.subProperty"}]},{"block_type":"text","content":") by leveraging npm library called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"object-path"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/object-path"},"children":[{"block_type":"text","content":"https://npmjs.org/package/object-path"}]},{"block_type":"text","content":"). In the constructor, we also take in a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"strategy"}]},{"block_type":"text","content":"as input, which represents an algorithm for parsing and serializing the data."}]},{"block_type":"element","block":"k5zy5bj8","search_text":"Let's now see how we are going to use strategy , by writing the remaining part of the Config class:","text_count":99,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now see how we are going to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"strategy"}]},{"block_type":"text","content":", by writing the remaining part of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"class:"}]},{"block_type":"element","block":"k5zy5bj9","search_text":"set(path, value) { return objectPath.set(this.data, path, value); } read(file) { console.log(`Deserializing from ${file}`); this.data = this.strategy.deserialize(fs.readFileSync(file, 'utf-8')); } save(file) { console.log(`Serializing to ${file}`); fs.writeFileSync(file, this.strategy.serialize(this.data)); } } module.exports = Config; ","text_count":338,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"set(path, value) { \n    return objectPath.set(this.data, path, value); \n  } \n \n  read(file) { \n    console.log(`Deserializing from ${file}`); \n    this.data = this.strategy.deserialize(fs.readFileSync(file, 'utf-8')); \n  } \n \n  save(file) { \n    console.log(`Serializing to ${file}`); \n    fs.writeFileSync(file, this.strategy.serialize(this.data)); \n  } \n} \nmodule.exports = Config;"}]}]},{"block_type":"element","block":"k5zy5bja","search_text":"In the previous code, when reading the configuration from a file, we delegate the deserialization task to the strategy ; then, when we want to save the configuration into a file, we use strategy to serialize the configuration. This simple design allows the Config object to support different file formats when loading and saving its data.","text_count":338,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous code, when reading the configuration from a file, we delegate the deserialization task to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"strategy"}]},{"block_type":"text","content":"; then, when we want to save the configuration into a file, we use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"strategy"}]},{"block_type":"text","content":"to serialize the configuration. This simple design allows the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"object to support different file formats when loading and saving its data."}]},{"block_type":"element","block":"k5zy5bjb","search_text":"To demonstrate this, let's create a couple of strategies in a file called strategies.js . Let's start with a strategy for parsing and serializing JSON data:","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate this, let's create a couple of strategies in a file called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"strategies.js"}]},{"block_type":"text","content":". Let's start with a strategy for parsing and serializing JSON data:"}]},{"block_type":"element","block":"k5zy5bjc","search_text":"module.exports.json = { deserialize: data => JSON.parse(data), serialize: data => JSON.stringify(data, null, ' ') } ","text_count":116,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports.json = { \n  deserialize: data =&gt; JSON.parse(data), \n  serialize: data =&gt; JSON.stringify(data, null, '  ') \n}"}]}]},{"block_type":"element","block":"k5zy5bjd","search_text":"Nothing really complicated! Our strategy simply implements the agreed interface, so that it can be used by the Config object.","text_count":125,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Nothing really complicated! Our strategy simply implements the agreed interface, so that it can be used by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"object."}]},{"block_type":"element","block":"k5zy5bje","search_text":"Similarly, the next strategy we are going to create allows us to support the INI file format:","text_count":93,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Similarly, the next strategy we are going to create allows us to support the INI file format:"}]},{"block_type":"element","block":"k5zy5bjf","search_text":"const ini = require('ini'); //-> https://npmjs.org/package/ini module.exports.ini = { deserialize: data => ini.parse(data), serialize: data => ini.stringify(data) } ","text_count":165,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const ini = require('ini'); //-&gt; https://npmjs.org/package/ini \nmodule.exports.ini = { \n  deserialize: data =&gt; ini.parse(data), \n  serialize: data =&gt; ini.stringify(data) \n}"}]}]},{"block_type":"element","block":"k5zy5bjg","search_text":"Now, to show you how everything comes together, let's create a file named configTest.js , and let's try to load and save a sample configuration using different formats:","text_count":168,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, to show you how everything comes together, let's create a file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"configTest.js"}]},{"block_type":"text","content":", and let's try to load and save a sample configuration using different formats:"}]},{"block_type":"element","block":"k5zy5bjh","search_text":"const Config = require('./config'); const strategies = require('./strategies'); const jsonConfig = new Config(strategies.json); jsonConfig.read('samples/conf.json'); jsonConfig.set('book.nodejs', 'design patterns'); jsonConfig.save('samples/conf_mod.json'); const iniConfig = new Config(strategies.ini); iniConfig.read('samples/conf.ini'); iniConfig.set('book.nodejs', 'design patterns'); iniConfig.save('samples/conf_mod.ini'); ","text_count":429,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const Config = require('./config'); \nconst strategies = require('./strategies'); \n \nconst jsonConfig = new Config(strategies.json); \njsonConfig.read('samples/conf.json'); \njsonConfig.set('book.nodejs', 'design patterns'); \njsonConfig.save('samples/conf_mod.json'); \n \nconst iniConfig = new Config(strategies.ini); \niniConfig.read('samples/conf.ini'); \niniConfig.set('book.nodejs', 'design patterns'); \niniConfig.save('samples/conf_mod.ini');"}]}]},{"block_type":"element","block":"k5zy5bji","search_text":"Our test module reveals the properties of the Strategy pattern. We defined only one Config class, which implements the common parts of our configuration manager, while changing the strategy used for serializing and deserializing allowed us to create different Config instances supporting different file formats.","text_count":311,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our test module reveals the properties of the Strategy pattern. We defined only one"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"class, which implements the common parts of our configuration manager, while changing the strategy used for serializing and deserializing allowed us to create different"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"instances supporting different file formats."}]},{"block_type":"element","block":"k5zy5bjj","search_text":"The preceding example shows only one of the possible alternatives that we had for selecting the strategy. Other valid approaches might have been the following:","text_count":159,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding example shows only one of the possible alternatives that we had for selecting the strategy. Other valid approaches might have been the following:"}]},{"block_type":"element","block":"k5zy5bjk","search_text":"Creating two different strategy families: one for the deserialization and the other for the serialization. This would have allowed reading from a format and saving into another. Dynamically selecting the strategy, depending on the extension of the file provided; the Config object could have maintained a map extension->strategy and used it to select the right algorithm for the given extension. ","text_count":396,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Creating two different strategy families: one for the deserialization and the other for the serialization. This would have allowed reading from a format and saving into another."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Dynamically selecting the strategy, depending on the extension of the file provided; the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"object could have maintained a map"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"extension-&gt;strategy"}]},{"block_type":"text","content":"and used it to select the right algorithm for the given extension."}]}]},{"block_type":"element","block":"k5zy5bjl","search_text":"As we can see, there are several options for selecting the strategy to use and the right one only depends on our requirements and the trade-off in terms of features/simplicity we want to obtain.","text_count":194,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, there are several options for selecting the strategy to use and the right one only depends on our requirements and the trade-off in terms of features/simplicity we want to obtain."}]},{"block_type":"element","block":"k5zy5bjm","search_text":"Also, the implementation of the pattern itself can vary a lot; for example, in its simplest form, the context and the strategy can both be simple functions:","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, the implementation of the pattern itself can vary a lot; for example, in its simplest form, the context and the strategy can both be simple functions:"}]},{"block_type":"element","block":"k5zy5bjn","search_text":"function context(strategy) {...} ","text_count":33,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function context(strategy) {...}"}]}]},{"block_type":"element","block":"k5zy5bjo","search_text":"Even though the preceding situation might seem insignificant, it should not be underestimated in a programming language, such as JavaScript, where functions are first-class citizens and used as much as fully-fledged objects.","text_count":224,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even though the preceding situation might seem insignificant, it should not be underestimated in a programming language, such as JavaScript, where functions are first-class citizens and used as much as fully-fledged objects."}]},{"block_type":"element","block":"k5zy5bjp","search_text":"Between all these variations, though, what does not change is the idea behind the pattern; as always the implementation can slightly change but the core concepts that drive the pattern are always the same.","text_count":205,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Between all these variations, though, what does not change is the idea behind the pattern; as always the implementation can slightly change but the core concepts that drive the pattern are always the same."}]},{"block_type":"element","block":"k5zy5bjq","search_text":"In the wild","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"In the wild"}]},{"block_type":"element","block":"k5zy5bjr","search_text":"Passport.js ( http://passportjs.org ) is an authentication framework for Node.js which allows support for different authentication schemes on a web server. With Passport, we can provide a login with Facebook or login with Twitter functionality to our web application with minimal effort. Passport uses the Strategy pattern to separate the common logic required during an authentication process from the parts that can change, namely the actual authentication step. For example, we might want to use OAuth in order to obtain an access token to access a Facebook or Twitter profile, or simply use a local database to verify a username/password pair. For Passport, these are all different strategies for completing the authentication process and, as we can imagine, this allows the library to support a virtually unlimited number of authentication services. Take a look at the number of different authentication providers supported at http://passportjs.org/guide/providers to get an idea of what the strategy pattern can do.","text_count":1021,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Passport.js"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://passportjs.org/"},"children":[{"block_type":"text","content":"http://passportjs.org"}]},{"block_type":"text","content":") is an authentication framework for Node.js which allows support for different authentication schemes on a web server. With Passport, we can provide a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"login with Facebook"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"login with Twitter"}]},{"block_type":"text","content":"functionality to our web application with minimal effort. Passport uses the Strategy pattern to separate the common logic required during an authentication process from the parts that can change, namely the actual authentication step. For example, we might want to use OAuth in order to obtain an access token to access a Facebook or Twitter profile, or simply use a local database to verify a username/password pair. For Passport, these are all different strategies for completing the authentication process and, as we can imagine, this allows the library to support a virtually unlimited number of authentication services. Take a look at the number of different authentication providers supported at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://passportjs.org/guide/providers"},"children":[{"block_type":"text","content":"http://passportjs.org/guide/providers"}]},{"block_type":"text","content":"to get an idea of what the strategy pattern can do."}]},{"block_type":"element","block":"k5zy5bjs","search_text":"State","text_count":5,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"State"}]},{"block_type":"element","block":"k5zy5bjt","search_text":"State is a variation of the Strategy pattern where the strategy changes depending on the state of the context. We have seen in the previous section how a strategy can be selected based on different variables such as user preferences, a configuration parameter, and the input provided, and once this selection is done, the strategy stays unchanged for the rest of the lifespan of the context.","text_count":391,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"State is a variation of the Strategy pattern where the strategy changes depending on the state of the context. We have seen in the previous section how a strategy can be selected based on different variables such as user preferences, a configuration parameter, and the input provided, and once this selection is done, the strategy stays unchanged for the rest of the lifespan of the context."}]},{"block_type":"element","block":"k5zy5bju","search_text":"Instead, in the State pattern, the strategy (also called s tate in this circumstance) is dynamic and can change during the lifetime of the context, thus allowing its behavior to adapt depending on its internal state, as shown in the following figure:","text_count":250,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Instead, in the State pattern, the strategy (also called s"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"tate"}]},{"block_type":"text","content":"in this circumstance) is dynamic and can change during the lifetime of the context, thus allowing its behavior to adapt depending on its internal state, as shown in the following figure:"}]},{"block_type":"element","block":"k5zy5bjv","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000042.jpg","alt":"State","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bjw","search_text":"Imagine that we have a hotel booking system and an object called Reservation that models a room reservation. This is a classical situation where we have to adapt the behavior of an object based on its state. Consider the following series of events:","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Imagine that we have a hotel booking system and an object called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Reservation"}]},{"block_type":"text","content":"that models a room reservation. This is a classical situation where we have to adapt the behavior of an object based on its state. Consider the following series of events:"}]},{"block_type":"element","block":"k5zy5bjx","search_text":"When the reservation is initially created, the user can confirm (using confirm() ) the reservation; of course, they cannot cancel it (using cancel() ), because it's still not confirmed. They can however delete it (using delete() ) if they change their mind before buying. Once the reservation is confirmed, using the confirm() function again does not make any sense; however, now it should be possible to cancel the reservation but no longer delete it, because it has to be kept for the record. On the day before the reservation date, it should not be possible to cancel the reservation; it's too late for that. ","text_count":612,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the reservation is initially created, the user can confirm (using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"confirm()"}]},{"block_type":"text","content":") the reservation; of course, they cannot cancel it (using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cancel()"}]},{"block_type":"text","content":"), because it's still not confirmed. They can however delete it (using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"delete()"}]},{"block_type":"text","content":") if they change their mind before buying."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Once the reservation is confirmed, using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"confirm()"}]},{"block_type":"text","content":"function again does not make any sense; however, now it should be possible to cancel the reservation but no longer delete it, because it has to be kept for the record."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"On the day before the reservation date, it should not be possible to cancel the reservation; it's too late for that."}]}]},{"block_type":"element","block":"k5zy5bjy","search_text":"Now, imagine that we have to implement the reservation system that we described in one monolithic object; we can already picture all the if…else or switch statements that we would have to write to enable/disable each action depending on the state of the reservation.","text_count":266,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, imagine that we have to implement the reservation system that we described in one monolithic object; we can already picture all the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if&hellip;else"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"switch"}]},{"block_type":"text","content":"statements that we would have to write to enable/disable each action depending on the state of the reservation."}]},{"block_type":"element","block":"k5zy5bjz","search_text":"The State pattern instead is perfect in this situation: there will be three strategies, all implementing the three methods described ( confirm() , cancel() , and delete() ) and each one implementing only one behavior, the one corresponding to the modeled state. By using this pattern, it should be very easy for the Reservation object to switch from one behavior to another; this will simply require the activation of a different strategy on each state change.","text_count":460,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The State pattern instead is perfect in this situation: there will be three strategies, all implementing the three methods described ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"confirm()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cancel()"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"delete()"}]},{"block_type":"text","content":") and each one implementing only one behavior, the one corresponding to the modeled state. By using this pattern, it should be very easy for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Reservation"}]},{"block_type":"text","content":"object to switch from one behavior to another; this will simply require the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"activation"}]},{"block_type":"text","content":"of a different strategy on each state change."}]},{"block_type":"element","block":"k5zy5bk0","search_text":"The state transition can be initiated and controlled by the context object, by the client code, or by the State objects themselves. This last option usually provides the best results in terms of flexibility and decoupling, as the context does not have to know about all the possible states and how to transition between them.","text_count":325,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The state transition can be initiated and controlled by the context object, by the client code, or by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"State"}]},{"block_type":"text","content":"objects themselves. This last option usually provides the best results in terms of flexibility and decoupling, as the context does not have to know about all the possible states and how to transition between them."}]},{"block_type":"element","block":"k5zy5bk1","search_text":"Implementing a basic fail-safe socket","text_count":37,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Implementing a basic fail-safe socket"}]},{"block_type":"element","block":"k5zy5bk2","search_text":"Let's now work on a concrete example so that we can apply what we learned about the State pattern. Let's build a client TCP socket that does not fail when the connection with the server is lost; instead, we want to queue all the data sent during the time in which the server is offline and then try to send it again as soon as the connection is re-established. We want to leverage this socket in the context of a simple monitoring system, where a set of machines sends some statistics about their resource utilization at regular intervals; if the server that collects these resources goes down, our socket will continue to queue the data locally until the server comes back online.","text_count":681,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now work on a concrete example so that we can apply what we learned about the State pattern. Let's build a client TCP socket that does not fail when the connection with the server is lost; instead, we want to queue all the data sent during the time in which the server is offline and then try to send it again as soon as the connection is re-established. We want to leverage this socket in the context of a simple monitoring system, where a set of machines sends some statistics about their resource utilization at regular intervals; if the server that collects these resources goes down, our socket will continue to queue the data locally until the server comes back online."}]},{"block_type":"element","block":"k5zy5bk3","search_text":"Let's start by creating a new module called failsafeSocket.js that represents our context object:","text_count":97,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start by creating a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"failsafeSocket.js"}]},{"block_type":"text","content":"that represents our context object:"}]},{"block_type":"element","block":"k5zy5bk4","search_text":"const OfflineState = require('./offlineState'); const OnlineState = require('./onlineState'); class FailsafeSocket{ constructor (options) { //[1] this.options = options; this.queue = []; this.currentState = null; this.socket = null; this.states = { offline: new OfflineState(this), online: new OnlineState(this) }; this.changeState('offline'); } changeState (state) { //[2] console.log('Activating state: ' + state); this.currentState = this.states[state]; this.currentState.activate(); } send(data) { //[3] this.currentState.send(data); } } module.exports = options => { return new FailsafeSocket(options); }; ","text_count":611,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const OfflineState = require('./offlineState'); \nconst OnlineState = require('./onlineState'); \n \nclass FailsafeSocket{ \n  constructor (options) {                        //[1] \n    this.options = options; \n    this.queue = []; \n    this.currentState = null; \n    this.socket = null; \n    this.states = { \n      offline: new OfflineState(this), \n      online: new OnlineState(this) \n    }; \n    this.changeState('offline'); \n  } \n \n  changeState (state) {                          //[2] \n    console.log('Activating state: ' + state); \n    this.currentState = this.states[state]; \n    this.currentState.activate(); \n  } \n \n  send(data) {                                   //[3] \n    this.currentState.send(data); \n  } \n} \n \nmodule.exports = options =&gt; { \n  return new FailsafeSocket(options); \n};"}]}]},{"block_type":"element","block":"k5zy5bk5","search_text":"The FailsafeSocket class is made of three main elements:","text_count":56,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"FailsafeSocket"}]},{"block_type":"text","content":"class is made of three main elements:"}]},{"block_type":"element","block":"k5zy5bk6","search_text":"The constructor initializes various data structures, including the queue that will contain any data sent while the socket is offline. Also, it creates a set of two states , one for implementing the behavior of the socket while it's offline, and another one when the socket is online. The changeState() method is responsible for transitioning from one state to another. It simply updates the currentState instance variable and calls activate() on the target state. The send() method is the functionality of the socket this is where we want to have a different behavior based on the offline/online state. As we can see, this is done by delegating the operation to the currently active state. ","text_count":690,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The constructor initializes various data structures, including the queue that will contain any data sent while the socket is offline. Also, it creates a set of two"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"states"}]},{"block_type":"text","content":", one for implementing the behavior of the socket while it's offline, and another one when the socket is online."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"changeState()"}]},{"block_type":"text","content":"method is responsible for transitioning from one state to another. It simply updates the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"currentState"}]},{"block_type":"text","content":"instance variable and calls"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"activate()"}]},{"block_type":"text","content":"on the target state."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"send()"}]},{"block_type":"text","content":"method is the functionality of the socket this is where we want to have a different behavior based on the offline/online state. As we can see, this is done by delegating the operation to the currently active state."}]}]},{"block_type":"element","block":"k5zy5bk7","search_text":"Let's now see what the two states look like, starting from the offlineState.js module:","text_count":86,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now see what the two states look like, starting from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"offlineState.js"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5bk8","search_text":"const jot = require('json-over-tcp'); //[1] module.exports = class OfflineState { constructor (failsafeSocket) { this.failsafeSocket = failsafeSocket; } send(data) { //[2] this.failsafeSocket.queue.push(data); } activate() { //[3] const retry = () => { setTimeout(() => this.activate(), 500); } this.failsafeSocket.socket = jot.connect( this.failsafeSocket.options, () => { this.failsafeSocket.socket.removeListener('error', retry); this.failsafeSocket.changeState('online'); } ); this.failsafeSocket.socket.once('error', retry); } }; ","text_count":535,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const jot = require('json-over-tcp');         //[1] \n \nmodule.exports = class OfflineState { \n \n  constructor (failsafeSocket) { \n    this.failsafeSocket = failsafeSocket; \n  } \n \n  send(data) {                                //[2] \n    this.failsafeSocket.queue.push(data); \n  } \n \n  activate() {                                //[3] \n    const retry = () =&gt; { \n      setTimeout(() =&gt; this.activate(), 500); \n    } \n \n    this.failsafeSocket.socket = jot.connect( \n      this.failsafeSocket.options, \n      () =&gt; { \n        this.failsafeSocket.socket.removeListener('error', retry); \n        this.failsafeSocket.changeState('online'); \n      } \n    ); \n    this.failsafeSocket.socket.once('error', retry); \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5bk9","search_text":"The module that we created is responsible for managing the behavior of the socket while it's offline; this is how it works:","text_count":123,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The module that we created is responsible for managing the behavior of the socket while it's offline; this is how it works:"}]},{"block_type":"element","block":"k5zy5bka","search_text":"Instead of using a raw TCP socket, we will use a little library called json-over-tcp ( https://npmjs.org/package/json-over-tcp ), which will allow us to easily send JSON objects over a TCP connection. The send() method is only responsible for queuing any data it receives; we are assuming that we are offline, so that's all we need to do. The activate() method tries to establish a connection with the server using json-over-tcp . If the operation fails, it tries again after 500 milliseconds. It continues trying until a valid connection is established, in which case the state of failsafeSocket is transitioned to online . ","text_count":625,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Instead of using a raw TCP socket, we will use a little library called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"json-over-tcp"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/json-over-tcp"},"children":[{"block_type":"text","content":"https://npmjs.org/package/json-over-tcp"}]},{"block_type":"text","content":"), which will allow us to easily send JSON objects over a TCP connection."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"send()"}]},{"block_type":"text","content":"method is only responsible for queuing any data it receives; we are assuming that we are offline, so that's all we need to do."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"activate()"}]},{"block_type":"text","content":"method tries to establish a connection with the server using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"json-over-tcp"}]},{"block_type":"text","content":". If the operation fails, it tries again after 500 milliseconds. It continues trying until a valid connection is established, in which case the state of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"failsafeSocket"}]},{"block_type":"text","content":"is transitioned to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"online"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5bkb","search_text":"Next, let's implement the onlineState.js module, and then let's implement the onlineState strategy, as follows:","text_count":111,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, let's implement the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onlineState.js"}]},{"block_type":"text","content":"module, and then let's&nbsp;implement&nbsp;the &nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onlineState"}]},{"block_type":"text","content":"strategy, as follows:"}]},{"block_type":"element","block":"k5zy5bkc","search_text":"module.exports = class OnlineState { constructor(failsafeSocket) { this.failsafeSocket = failsafeSocket; } send(data) { //[1] this.failsafeSocket.socket.write(data); }; activate() { //[2] this.failsafeSocket.queue.forEach(data => { this.failsafeSocket.socket.write(data); }); this.failsafeSocket.queue = []; this.failsafeSocket.socket.once('error', () => { this.failsafeSocket.changeState('offline'); }); } }; ","text_count":410,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = class OnlineState { \n  constructor(failsafeSocket) { \n    this.failsafeSocket = failsafeSocket; \n  } \n \n  send(data) {                                 //[1] \n    this.failsafeSocket.socket.write(data); \n  }; \n \n  activate() {                                 //[2] \n    this.failsafeSocket.queue.forEach(data =&gt; { \n      this.failsafeSocket.socket.write(data); \n    }); \n    this.failsafeSocket.queue = []; \n \n    this.failsafeSocket.socket.once('error', () =&gt; { \n      this.failsafeSocket.changeState('offline'); \n    }); \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5bkd","search_text":"The OnlineState strategy is very simple and is explained as follows:","text_count":68,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"OnlineState"}]},{"block_type":"text","content":"strategy is very simple and is explained as follows:"}]},{"block_type":"element","block":"k5zy5bke","search_text":"The send() method writes the data directly into the socket, as we assume we are online. The activate() method flushes any data that was queued while the socket was offline and it also starts listening for any error events; we will take this as a symptom that the socket went offline (for simplicity). When this happens, we transition to the offline state. ","text_count":356,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"send()"}]},{"block_type":"text","content":"method writes the data directly into the socket, as we assume we are online."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"activate()"}]},{"block_type":"text","content":"method flushes any data that was queued while the socket was offline and it also starts listening for any"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":"events; we will take this as a symptom that the socket went offline (for simplicity). When this happens, we transition to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"offline"}]},{"block_type":"text","content":"state."}]}]},{"block_type":"element","block":"k5zy5bkf","search_text":"That's it for our failsafeSocket ; now we are ready to build a sample client and a server to try it out. Let's put the server code in a module named server.js :","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's it for our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"failsafeSocket"}]},{"block_type":"text","content":"; now we are ready to build a sample client and a server to try it out. Let's put the server code in a module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"server.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bkg","search_text":"const jot = require('json-over-tcp'); const server = jot.createServer(5000); server.on('connection', socket => { socket.on('data', data => { console.log('Client data', data); }); }); server.listen(5000, () => console.log('Started'));","text_count":233,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const jot = require('json-over-tcp'); \nconst server = jot.createServer(5000); \nserver.on('connection', socket =&gt; { \n  socket.on('data', data =&gt; { \n    console.log('Client data', data); \n  }); \n}); \nserver.listen(5000, () =&gt; console.log('Started'));"}]}]},{"block_type":"element","block":"k5zy5bkh","search_text":"Then the client-side code, which is what we are really interested in, goes into client.js :","text_count":91,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then the client-side code, which is what we are really interested in, goes into"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"client.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bki","search_text":"const createFailsafeSocket = require('./failsafeSocket'); const failsafeSocket = createFailsafeSocket({port: 5000}); setInterval(() => { //send current memory usage failsafeSocket.send(process.memoryUsage()); }, 1000); ","text_count":219,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const createFailsafeSocket = require('./failsafeSocket'); \nconst failsafeSocket = createFailsafeSocket({port: 5000}); \n \nsetInterval(() =&gt; { \n  //send current memory usage \n  failsafeSocket.send(process.memoryUsage()); \n}, 1000);"}]}]},{"block_type":"element","block":"k5zy5bkj","search_text":"Our server simply prints any JSON message it receives to the console, while our clients are sending a measurement of their memory utilization every second, leveraging a FailsafeSocket object.","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our server simply prints any JSON message it receives to the console, while our clients are sending a measurement of their memory utilization every second, leveraging a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"FailsafeSocket"}]},{"block_type":"text","content":"object."}]},{"block_type":"element","block":"k5zy5bkk","search_text":"To try the small system that we built, we should run both the client and the server, then we can test the features of failsafeSocket by stopping and then restarting the server. We should see that the state of the client changes between online and offline and that any memory measurement collected while the server is offline is queued and then resent as soon as the server goes back online.","text_count":390,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To try the small system that we built, we should run both the client and the server, then we can test the features of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"failsafeSocket"}]},{"block_type":"text","content":"by stopping and then restarting the server. We should see that the state of the client changes between"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"online"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"offline"}]},{"block_type":"text","content":"and that any memory measurement collected while the server is offline is queued and then resent as soon as the server goes back online."}]},{"block_type":"element","block":"k5zy5bkl","search_text":"This sample should be a clear demonstration of how the State pattern can help increase the modularity and readability of a component that has to adapt its behavior depending on its state.","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This sample should be a clear demonstration of how the State pattern can help increase the modularity and readability of a component that has to adapt its behavior depending on its state."}]},{"block_type":"element","block":"k5zy5bkm","search_text":"Note Thec FailsafeSocket class that we built in this section is only for demonstrating the state pattern and doesn't want to be a complete and 100%-reliable solution for handling connectivity issues within TCP sockets. For example, we are not verifying that all the data written into the socket stream is received by the server, which would require some more code not strictly related to the pattern that we wanted to describe. ","text_count":428,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Thec"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"FailsafeSocket"}]},{"block_type":"text","content":"class that we built in this section is only for demonstrating the state pattern and doesn't want to be a complete and 100%-reliable solution for handling connectivity issues within TCP sockets. For example, we are not verifying that all the data written into the socket stream is received by the server, which would require some more code not strictly related to the pattern that we wanted to describe."}]}]},{"block_type":"element","block":"k5zy5bkn","search_text":"Template","text_count":8,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Template"}]},{"block_type":"element","block":"k5zy5bko","search_text":"The next pattern that we are going to analyze is called Template and it also has a lot in common with the Strategy pattern. Template consists of defining an abstract pseudo class that represents the skeleton of an algorithm, where some of its steps are left undefined. Subclasses can then fill the gaps in the algorithm by implementing the missing steps, called template methods . The intent of this pattern is to make it possible to define a family of classes that are all variations of a similar algorithm. The following UML diagram shows the structure that we just described:","text_count":578,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next pattern that we are going to analyze is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Template"}]},{"block_type":"text","content":"and it also has a lot in common with the Strategy pattern. Template consists of defining an abstract pseudo class that represents the skeleton of an algorithm, where some of its steps are left undefined. Subclasses can then"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"fill"}]},{"block_type":"text","content":"the gaps in the algorithm by implementing the missing steps, called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"template methods"}]},{"block_type":"text","content":". The intent of this pattern is to make it possible to define a family of classes that are all variations of a similar algorithm. The following UML diagram shows the structure that we just described:"}]},{"block_type":"element","block":"k5zy5bkp","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000011.jpg","alt":"Template","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bkq","search_text":"The three concrete classes shown in the previous diagram, extend Template and provide an implementation for templateMethod() , which is abstract or pure virtual , to use the C++ terminology; in JavaScript this means that the method is left undefined or is assigned to a function that always throws an exception, indicating the fact that the method has to be implemented. The Template pattern can be considered more classically object-oriented than the other patterns we have seen so far, because inheritance is a core part of its implementation.","text_count":545,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The three concrete classes shown in the previous diagram, extend Template and provide an implementation for"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"templateMethod()"}]},{"block_type":"text","content":", which is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"abstract"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pure virtual"}]},{"block_type":"text","content":", to use the C++ terminology; in JavaScript this means that the method is left undefined or is assigned to a function that always throws an exception, indicating the fact that the method has to be implemented. The Template pattern can be considered more classically object-oriented than the other patterns we have seen so far, because inheritance is a core part of its implementation."}]},{"block_type":"element","block":"k5zy5bkr","search_text":"The purpose of Template and Strategy is very similar, but the main difference between the two lies in their structure and implementation. Both allow us to change some parts of an algorithm while reusing the common parts; however, while Strategy allows us to do it dynamically and possibly at runtime, with Template the complete algorithm is determined the moment the concrete class is defined. Under these assumptions, the Template pattern might be more suitable in those circumstances where we want to create prepackaged variations of an algorithm. As always, the choice between one pattern and the other is up to the developer, who has to consider the various pros and cons for each use case.","text_count":694,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The purpose of Template and Strategy is very similar, but the main difference between the two lies in their structure and implementation. Both allow us to change some parts of an algorithm while reusing the common parts; however, while Strategy allows us to do it"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"dynamically"}]},{"block_type":"text","content":"and possibly at runtime, with Template the complete algorithm is determined the moment the concrete class is defined. Under these assumptions, the Template pattern might be more suitable in those circumstances where we want to create prepackaged variations of an algorithm. As always, the choice between one pattern and the other is up to the developer, who has to consider the various pros and cons for each use case."}]},{"block_type":"element","block":"k5zy5bks","search_text":"A configuration manager template","text_count":32,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"A configuration manager template"}]},{"block_type":"element","block":"k5zy5bkt","search_text":"To have a better idea of the differences between Strategy and Template, let's now re-implement the Config object that we defined in the section about the Strategy pattern, but this time using Template. Like in the previous version of the Config object, we want to have the ability to load and save a set of configuration properties using different file formats.","text_count":361,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To have a better idea of the differences between Strategy and Template, let's now re-implement the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"object that we defined in the section about the Strategy pattern, but this time using Template. Like in the previous version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Config"}]},{"block_type":"text","content":"object, we want to have the ability to load and save a set of configuration properties using different file formats."}]},{"block_type":"element","block":"k5zy5bku","search_text":"Let's start by defining the template class; we will call it ConfigTemplate :","text_count":76,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start by defining the template class; we will call it"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ConfigTemplate"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bkv","search_text":"const fs = require('fs'); const objectPath = require('object-path'); class ConfigTemplate { read(file) { console.log(`Deserializing from ${file}`); this.data = this._deserialize(fs.readFileSync(file, 'utf-8')); } save(file) { console.log(`Serializing to ${file}`); fs.writeFileSync(file, this._serialize(this.data)); } get(path) { return objectPath.get(this.data, path); } set(path, value) { return objectPath.set(this.data, path, value); } _serialize() { throw new Error('_serialize() must be implemented'); } _deserialize() { throw new Error('_deserialize() must be implemented'); } } module.exports = ConfigTemplate; ","text_count":620,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fs = require('fs'); \nconst objectPath = require('object-path'); \n \nclass ConfigTemplate { \n \n  read(file) { \n    console.log(`Deserializing from ${file}`); \n    this.data = this._deserialize(fs.readFileSync(file, 'utf-8')); \n  } \n \n  save(file) { \n    console.log(`Serializing to ${file}`); \n    fs.writeFileSync(file, this._serialize(this.data)); \n  } \n \n  get(path) { \n    return objectPath.get(this.data, path); \n  } \n \n  set(path, value) { \n    return objectPath.set(this.data, path, value); \n  } \n \n  _serialize() { \n    throw new Error('_serialize() must be implemented'); \n  } \n \n  _deserialize() { \n    throw new Error('_deserialize() must be implemented'); \n  } \n} \nmodule.exports = ConfigTemplate;"}]}]},{"block_type":"element","block":"k5zy5bkw","search_text":"The new ConfigTemplate class defines two template methods: _deserialize() and _serialize() , which are needed to carry out the loading and saving of the configuration. The underscore at the beginning of their names indicates that they are for internal use only, an easy way to flag protected methods. Since in JavaScript we cannot declare a method as abstract, we simply define them as stubs , throwing an exception if they are invoked (in other words, if they are not overridden by a concrete subclass).","text_count":504,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ConfigTemplate"}]},{"block_type":"text","content":"class defines two template methods:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_deserialize()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_serialize()"}]},{"block_type":"text","content":", which are needed to carry out the loading and saving of the configuration. The underscore at the beginning of their names indicates that they are for internal use only, an easy way to flag protected methods. Since in JavaScript we cannot declare a method as abstract, we simply define them as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"stubs"}]},{"block_type":"text","content":", throwing an exception if they are invoked (in other words, if they are not overridden by a concrete subclass)."}]},{"block_type":"element","block":"k5zy5bkx","search_text":"Let's now create a concrete class using our template, for example, one that allows us to load and save the configuration using the JSON format:","text_count":143,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now create a concrete class using our template, for example, one that allows us to load and save the configuration using the JSON format:"}]},{"block_type":"element","block":"k5zy5bky","search_text":"const util = require('util'); const ConfigTemplate = require('./configTemplate'); class JsonConfig extends ConfigTemplate { _deserialize(data) { return JSON.parse(data); }; _serialize(data) { return JSON.stringify(data, null, ' '); } } module.exports = JsonConfig; ","text_count":265,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const util = require('util'); \nconst ConfigTemplate = require('./configTemplate'); \n \nclass JsonConfig extends ConfigTemplate { \n \n  _deserialize(data) { \n    return JSON.parse(data); \n  }; \n \n  _serialize(data) { \n    return JSON.stringify(data, null, '  '); \n  } \n} \nmodule.exports = JsonConfig;"}]}]},{"block_type":"element","block":"k5zy5bkz","search_text":"The JsonConfig class extends from our template, the ConfigTemplate class, and provides a concrete implementation for the _deserialize() and _serialize() methods.","text_count":161,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"JsonConfig"}]},{"block_type":"text","content":"class extends from our template, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ConfigTemplate"}]},{"block_type":"text","content":"class, and provides a concrete implementation for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_deserialize()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_serialize()"}]},{"block_type":"text","content":"methods."}]},{"block_type":"element","block":"k5zy5bl0","search_text":"The JsonConfig class can now be used as a standalone configuration object without the need to specify a strategy for serialization and deserialization, as it is baked in the class itself:","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"JsonConfig"}]},{"block_type":"text","content":"class can now be used as a standalone configuration object without the need to specify a strategy for serialization and deserialization, as it is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"baked in"}]},{"block_type":"text","content":"the class itself:"}]},{"block_type":"element","block":"k5zy5bl1","search_text":"const JsonConfig = require('./jsonConfig'); constjsonConfig = new JsonConfig(); jsonConfig.read('samples/conf.json'); jsonConfig.set('nodejs', 'design patterns'); jsonConfig.save('samples/conf_mod.json'); ","text_count":205,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const JsonConfig = require('./jsonConfig'); \n \nconstjsonConfig = new JsonConfig(); \njsonConfig.read('samples/conf.json'); \njsonConfig.set('nodejs', 'design patterns'); \njsonConfig.save('samples/conf_mod.json');"}]}]},{"block_type":"element","block":"k5zy5bl2","search_text":"With minimal effort, the Template pattern allowed us to obtain a new, fully-working configuration manager by reusing the logic and the interface inherited from the parent template class and providing only the implementation of a few abstract methods.","text_count":250,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With minimal effort, the Template pattern allowed us to obtain a new, fully-working configuration manager by reusing the logic and the interface inherited from the parent template class and providing only the implementation of a few abstract methods."}]},{"block_type":"element","block":"k5zy5bl3","search_text":"In the wild","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"In the wild"}]},{"block_type":"element","block":"k5zy5bl4","search_text":"This pattern should not sound entirely new to us. We already encountered it in Chapter 5, Coding with Streams , when we were extending the different stream classes to implement our custom streams. In that context, the template methods were the _write() , _read() , _transform() , or _flush() methods, depending on the stream class that we wanted to implement. To create a new custom stream, we needed to inherit from a specific abstract stream class, providing an implementation for the template methods.","text_count":504,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This pattern should not sound entirely new to us. We already encountered it in Chapter 5,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Coding with Streams"}]},{"block_type":"text","content":", when we were extending the different stream classes to implement our custom streams. In that context, the template methods were the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_write()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_read()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_transform()"}]},{"block_type":"text","content":", or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_flush()"}]},{"block_type":"text","content":"methods, depending on the stream class that we wanted to implement. To create a new custom stream, we needed to inherit from a specific abstract stream class, providing an implementation for the template methods."}]},{"block_type":"element","block":"k5zy5bl5","search_text":"Middleware","text_count":10,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Middleware"}]},{"block_type":"element","block":"k5zy5bl6","search_text":"One of the most distinctive patterns in Node.js is definitely middleware . Unfortunately, it's also one of the most confusing for the inexperienced, especially for developers coming from the enterprise programming world. The reason for the disorientation is probably connected to the meaning of the term middleware, which in enterprise architecture jargon represents the various software suites that help to abstract lower-level mechanisms such as OS APIs, network communications, memory management, and so on, allowing the developer to focus only on the business case of the application. In this context, the term middleware recalls topics such as CORBA, Enterprise Service Bus, Spring, JBoss, but in its more generic meaning it can also define any kind of software layer that acts like a glue between lower-level services and the application (literally the software in the middle ).","text_count":884,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the most distinctive patterns in Node.js is definitely"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"middleware"}]},{"block_type":"text","content":". Unfortunately, it's also one of the most confusing for the inexperienced, especially for developers coming from the enterprise programming world. The reason for the disorientation is probably connected to the meaning of the term middleware, which in enterprise architecture jargon represents the various software suites that help to abstract lower-level mechanisms such as OS APIs, network communications, memory management, and so on, allowing the developer to focus only on the business case of the application. In this context, the term middleware recalls topics such as CORBA, Enterprise Service Bus, Spring, JBoss, but in its more generic meaning it can also define any kind of software layer that acts like a glue between lower-level services and the application (literally the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"software in the middle"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5bl7","search_text":"Middleware in Express","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Middleware in Express"}]},{"block_type":"element","block":"k5zy5bl8","search_text":"Express ( http://expressjs.com ) popularized the term middleware in the Node.js world, binding it to a very specific design pattern. In Express, in fact, middleware represents a set of services, typically functions, that are organized in a pipeline and are responsible for processing incoming HTTP requests and relative responses.","text_count":330,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Express ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://expressjs.com/"},"children":[{"block_type":"text","content":"http://expressjs.com"}]},{"block_type":"text","content":") popularized the term middleware in the Node.js world, binding it to a very specific design pattern. In Express, in fact, middleware represents a set of services, typically functions, that are organized in a pipeline and are responsible for processing incoming HTTP requests and relative responses."}]},{"block_type":"element","block":"k5zy5bl9","search_text":"Express is famous for being a very non-opinionated and minimalist web framework. Using the middleware pattern is an effective strategy for allowing developers to easily create and distribute new features that can be easily added to the current application, without the need to grow the minimalistic core of the framework.","text_count":321,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Express is famous for being a very non-opinionated and minimalist web framework. Using the middleware pattern is an effective strategy for allowing developers to easily create and distribute new features that can be easily added to the current application, without the need to grow the minimalistic core of the framework."}]},{"block_type":"element","block":"k5zy5bla","search_text":"An Express middleware has the following signature:","text_count":50,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An Express middleware has the following signature:"}]},{"block_type":"element","block":"k5zy5blb","search_text":"function(req, res, next) { ... } ","text_count":33,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function(req, res, next) { ... }"}]}]},{"block_type":"element","block":"k5zy5blc","search_text":"Here, req is the incoming HTTP request, res is the response, and next is the callback to be invoked when the current middleware has completed its tasks and that in turn triggers the next middleware in the pipeline.","text_count":214,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Here,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"req"}]},{"block_type":"text","content":"is the incoming HTTP request,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"res"}]},{"block_type":"text","content":"is the response, and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"next"}]},{"block_type":"text","content":"is the callback to be invoked when the current middleware has completed its tasks and that in turn triggers the next middleware in the pipeline."}]},{"block_type":"element","block":"k5zy5bld","search_text":"Examples of the tasks carried out by Express middleware include the following:","text_count":78,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Examples of the tasks carried out by Express&nbsp; middleware include the following:"}]},{"block_type":"element","block":"k5zy5ble","search_text":"Parsing the body of the request Compressing/decompressing requests and responses Producing access logs Managing sessions Managing encrypted cookies Providing Cross-site Request Forgery (CSRF) protection ","text_count":203,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Parsing the body of the request"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Compressing/decompressing requests and responses"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Producing access logs"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Managing sessions"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Managing encrypted cookies"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Providing"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cross-site Request Forgery (CSRF)"}]},{"block_type":"text","content":"protection"}]}]},{"block_type":"element","block":"k5zy5blf","search_text":"If we think about it, these are all tasks that are not strictly related to the main functionality of an application, nor essential parts of a minimal core of a web server; rather, they are accessories, components providing support to the rest of the application and allowing the actual request handlers to focus only on their main business logic. Essentially, those tasks are software in the middle.","text_count":399,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we think about it, these are all tasks that are not strictly related to the main functionality of an application, nor essential parts of a minimal core of a web server; rather, they are accessories, components providing support to the rest of the application and allowing the actual request handlers to focus only on their main business logic. Essentially, those tasks are software in the middle."}]},{"block_type":"element","block":"k5zy5blg","search_text":"Middleware as a pattern","text_count":23,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Middleware as a pattern"}]},{"block_type":"element","block":"k5zy5blh","search_text":"The technique used to implement middleware in Express is not new; in fact, it can be considered the Node.js incarnation of the Intercepting Filter pattern and the Chain of Responsibility pattern. In more generic terms, it also represents a processing pipeline , which reminds us about streams. Today, in Node.js the word middleware is used well beyond the boundaries of the Express framework, and indicates a particular pattern whereby a set of processing units, filters, and handlers, under the form of functions, are connected to form an asynchronous sequence in order to perform the preprocessing and postprocessing of any kind of data. The main advantage of this pattern is flexibility ; in fact, this pattern allows us to obtain a plugin infrastructure with incredibly little effort, providing an unobtrusive way for extending a system with new filters and handlers.","text_count":871,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The technique used to implement middleware in Express is not new; in fact, it can be considered the Node.js incarnation of the Intercepting Filter pattern and the Chain of Responsibility pattern. In more generic terms, it also represents a processing"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"pipeline"}]},{"block_type":"text","content":", which reminds us about streams. Today, in Node.js the word middleware is used well beyond the boundaries of the Express framework, and indicates a particular pattern whereby a set of processing units, filters, and handlers, under the form of functions, are connected to form an asynchronous sequence in order to perform the preprocessing and postprocessing of any kind of data. The main advantage of this pattern is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"flexibility"}]},{"block_type":"text","content":"; in fact, this pattern allows us to obtain a plugin infrastructure with incredibly little effort, providing an unobtrusive way for extending a system with new filters and handlers."}]},{"block_type":"element","block":"k5zy5bli","search_text":"Tip If you want to know more about the Intercepting Filter pattern, the following article is a good starting point: http://www.oracle.com/technetwork/java/interceptingfilter-142169.html . A nice overview of the Chain of Responsibility pattern is available at this URL: http://java.dzone.com/articles/design-patterns-uncovered-chain-of-responsibility . ","text_count":352,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you want to know more about the Intercepting Filter pattern, the following article is a good starting point:"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.oracle.com/technetwork/java/interceptingfilter-142169.html"},"children":[{"block_type":"text","content":"http://www.oracle.com/technetwork/java/interceptingfilter-142169.html"}]},{"block_type":"text","content":". A nice overview of the Chain of Responsibility pattern is available at this URL:"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://java.dzone.com/articles/design-patterns-uncovered-chain-of-responsibility"},"children":[{"block_type":"text","content":"http://java.dzone.com/articles/design-patterns-uncovered-chain-of-responsibility"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5blj","search_text":"The following diagram shows the components of the middleware pattern:","text_count":69,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following diagram shows the components of the middleware pattern:"}]},{"block_type":"element","block":"k5zy5blk","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000043.jpg","alt":"Middleware as a pattern","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bll","search_text":"The essential component of the pattern is the Middleware Manager , which is responsible for organizing and executing the middleware functions. The most important implementation details of the pattern are as follows:","text_count":215,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The essential component of the pattern is the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Middleware Manager"}]},{"block_type":"text","content":", which is responsible for organizing and executing the middleware functions. The most important implementation details of the pattern are as follows:"}]},{"block_type":"element","block":"k5zy5blm","search_text":"New middleware can be registered by invoking the use() function (the name of this function is a common convention in many implementations of this pattern, but we can choose any name). Usually, new middleware can only be appended at the end of the pipeline, but this is not a strict rule. When new data is received for processing, the registered middleware is invoked in an asynchronous sequential execution flow. Each unit in the pipeline receives the result of the execution of the previous unit as input. Each piece of middleware can decide to stop further processing of the data by simply not invoking its callback or by passing an error to the callback. An error situation usually triggers the execution of another sequence of middleware that is specifically dedicated to handling errors. ","text_count":793,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"New middleware can be registered by invoking the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"use()"}]},{"block_type":"text","content":"function (the name of this function is a common convention in many implementations of this pattern, but we can choose any name). Usually, new middleware can only be appended at the end of the pipeline, but this is not a strict rule."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When new data is received for processing, the registered middleware is invoked in an asynchronous sequential execution flow. Each unit in the pipeline receives the result of the execution of the previous unit as input."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Each piece of middleware can decide to stop further processing of the data by simply not invoking its callback or by passing an error to the callback. An error situation usually triggers the execution of another sequence of middleware that is specifically dedicated to handling errors."}]}]},{"block_type":"element","block":"k5zy5bln","search_text":"There is no strict rule on how the data is processed and propagated in the pipeline. The strategies include:","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There is no strict rule on how the data is processed and propagated in the pipeline. The strategies include:"}]},{"block_type":"element","block":"k5zy5blo","search_text":"Augmenting the data with additional properties or functions Replacing the data with the result of some kind of processing Maintaining the immutability of the data and always returning fresh copies as result of processing ","text_count":221,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Augmenting the data with additional properties or functions"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Replacing the data with the result of some kind of processing"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Maintaining the immutability of the data and always returning fresh copies as result of processing"}]}]},{"block_type":"element","block":"k5zy5blp","search_text":"The right approach depends on the way the Middleware Manager is implemented and on the type of processing carried out by the middleware itself.","text_count":143,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The right approach depends on the way the Middleware Manager is implemented and on the type of processing carried out by the middleware itself."}]},{"block_type":"element","block":"k5zy5blq","search_text":"Creating a middleware framework for ØMQ","text_count":39,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Creating a middleware framework for &Oslash;MQ"}]},{"block_type":"element","block":"k5zy5blr","search_text":"Let's now demonstrate the pattern by building a middleware framework around the ØMQ ( http://zeromq.org ) messaging library. ØMQ (also known as ZMQ, or ZeroMQ) provides a simple interface for exchanging atomic messages across the network using a variety of protocols; it shines for its performance, and its basic set of abstractions are specifically built to facilitate the implementation of custom messaging architectures. For this reason, ØMQ is often chosen to build complex distributed systems.","text_count":498,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now demonstrate the pattern by building a middleware framework around the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&Oslash;MQ"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://zeromq.org/"},"children":[{"block_type":"text","content":"http://zeromq.org"}]},{"block_type":"text","content":") messaging library. &Oslash;MQ (also known as ZMQ, or ZeroMQ) provides a simple interface for exchanging atomic messages across the network using a variety of protocols; it shines for its performance, and its basic set of abstractions are specifically built to facilitate the implementation of custom messaging architectures. For this reason, &Oslash;MQ is often chosen to build complex distributed systems."}]},{"block_type":"element","block":"k5zy5bls","search_text":"Note In Chapter 11, Messaging and Integration Patterns , we will have the chance to analyze the features of ØMQ in more detail. ","text_count":128,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Chapter 11,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Messaging and Integration Patterns"}]},{"block_type":"text","content":", we will have the chance to analyze the features of &Oslash;MQ in more detail."}]}]},{"block_type":"element","block":"k5zy5blt","search_text":"The interface of ØMQ is pretty low-level; it only allows us to use strings and binary buffers for messages, so any encoding or custom formatting of data has to be implemented by the users of the library.","text_count":203,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The interface of &Oslash;MQ is pretty low-level; it only allows us to use strings and binary buffers for messages, so any encoding or custom formatting of data has to be implemented by the users of the library."}]},{"block_type":"element","block":"k5zy5blu","search_text":"In the next example, we are going to build a middleware infrastructure to abstract the preprocessing and post processing of the data passing through a ØMQ socket, so that we can transparently work with JSON objects, but also seamlessly compress messages traveling over the wire.","text_count":278,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next example, we are going to build a middleware infrastructure to abstract the preprocessing and post processing of the data passing through a &Oslash;MQ socket, so that we can transparently work with JSON objects, but also seamlessly compress messages traveling over the wire."}]},{"block_type":"element","block":"k5zy5blv","search_text":"Note Before continuing with the example, please make sure to install the ØMQ native libraries following the instructions at this URL: http://zeromq.org/intro:get-the-software . Any version in the 4.0 branch should be enough to work on this example. ","text_count":249,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Before continuing with the example, please make sure to install the &Oslash;MQ native libraries following the instructions at this URL:"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://zeromq.org/intro:get-the-software"},"children":[{"block_type":"text","content":"http://zeromq.org/intro:get-the-software"}]},{"block_type":"text","content":". Any version in the 4.0 branch should be enough to work on this example."}]}]},{"block_type":"element","block":"k5zy5blw","search_text":"The Middleware Manager","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The Middleware Manager"}]},{"block_type":"element","block":"k5zy5blx","search_text":"The first step toward building a middleware infrastructure around ØMQ is to create a component that is responsible for executing the middleware pipeline when a new message is received or sent. For this purpose, let's create a new module called zmqMiddlewareManager.js and let's define it:","text_count":288,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first step toward building a middleware infrastructure around &Oslash;MQ is to create a component that is responsible for executing the middleware pipeline when a new message is received or sent. For this purpose, let's create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"zmqMiddlewareManager.js"}]},{"block_type":"text","content":"and let's define it:"}]},{"block_type":"element","block":"k5zy5bly","search_text":"module.exports = class ZmqMiddlewareManager { constructor(socket) { this.socket = socket; this.inboundMiddleware = []; //[1] this.outboundMiddleware = []; socket.on('message', message => { //[2] this.executeMiddleware(this.inboundMiddleware, { data: message }); }); } send(data) { constmessage = { data: data }; this.executeMiddleware(this.outboundMiddleware, message, () => { this.socket.send(message.data); } ); } use(middleware) { if (middleware.inbound) { this.inboundMiddleware.push(middleware.inbound); } if (middleware.outbound) { this.outboundMiddleware.unshift(middleware.outbound); } } executeMiddleware(middleware, arg, finish) { function iterator(index) { if (index === middleware.length) { return finish && finish(); } middleware[index].call(this, arg, err => { if (err) { return console.log('There was an error: ' + err.message); } iterator.call(this, ++index); }); } iterator.call(this, 0); } }; ","text_count":911,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = class ZmqMiddlewareManager { \n  constructor(socket) { \n    this.socket = socket; \n    this.inboundMiddleware = [];                    //[1] \n    this.outboundMiddleware = []; \n    socket.on('message', message =&gt; {               //[2] \n      this.executeMiddleware(this.inboundMiddleware, { \n        data: message \n      }); \n    }); \n  } \n \n  send(data) { \n    constmessage = { \n      data: data \n    }; \n \n    this.executeMiddleware(this.outboundMiddleware, message, \n      () =&gt; { \n        this.socket.send(message.data); \n      } \n    ); \n  } \n \n  use(middleware) { \n    if (middleware.inbound) { \n      this.inboundMiddleware.push(middleware.inbound); \n    } \n    if (middleware.outbound) { \n      this.outboundMiddleware.unshift(middleware.outbound); \n    } \n  } \n \n  executeMiddleware(middleware, arg, finish) { \n    function iterator(index) { \n      if (index === middleware.length) { \n        return finish && finish(); \n      } \n      middleware[index].call(this, arg, err =&gt; { \n        if (err) { \n          return console.log('There was an error: ' + err.message); \n        } \n        iterator.call(this, ++index); \n      }); \n    } \n \n    iterator.call(this, 0); \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5blz","search_text":"In the first part of the class, we define the constructor for this new component. It accepts a ØMQ socket as an argument and:","text_count":125,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the first part of the class, we define the constructor for this new component. It accepts a &Oslash;MQ socket as an argument and:"}]},{"block_type":"element","block":"k5zy5bm0","search_text":"Creates two empty lists that will contain our middleware functions, one for the inbound messages and another one for the outbound messages. It immediately starts listening for new messages coming from the socket by attaching a new listener to the 'message' event. In the listener, we process the inbound message by executing the inboundMiddleware pipeline. ","text_count":357,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Creates two empty lists that will contain our middleware functions, one for the inbound messages and another one for the outbound messages."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"It immediately starts listening for new messages coming from the socket by attaching a new listener to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"'message'"}]},{"block_type":"text","content":"event. In the listener, we process the inbound message by executing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inboundMiddleware"}]},{"block_type":"text","content":"pipeline."}]}]},{"block_type":"element","block":"k5zy5bm1","search_text":"The next method of the ZmqMiddlewareManager class, send , is responsible for executing the middleware when a new message is sent through the socket.","text_count":148,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next method of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ZmqMiddlewareManager"}]},{"block_type":"text","content":"class,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"send"}]},{"block_type":"text","content":", is responsible for executing the middleware when a new message is sent through the socket."}]},{"block_type":"element","block":"k5zy5bm2","search_text":"This time the message is processed using the filters in the outboundMiddleware list and then passed to socket.send() for the actual network transmission.","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This time the message is processed using the filters in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"outboundMiddleware"}]},{"block_type":"text","content":"list and then passed to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"socket.send()"}]},{"block_type":"text","content":"for the actual network transmission."}]},{"block_type":"element","block":"k5zy5bm3","search_text":"Now, let's talk about the use method. This method is necessary for appending new middleware functions to our pipelines. Each middleware comes in pairs; in our implementation it's an object that contains two properties, inbound and outbound , that contain the middleware functions to be added to the respective list.","text_count":315,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's talk about the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"use"}]},{"block_type":"text","content":"method. This method is necessary for appending new middleware functions to our pipelines. Each middleware comes in pairs; in our implementation it's an object that contains two properties,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inbound"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"outbound"}]},{"block_type":"text","content":", that contain the middleware functions to be added to the respective list."}]},{"block_type":"element","block":"k5zy5bm4","search_text":"It's important to observe here that the inbound middleware is pushed to the end of the inboundMiddleware list, while the outbound middleware is inserted (using unshift ) at the beginning of the outboundMiddleware list. This is because complementary inbound/outbound middleware functions usually need to be executed in an inverted order. For example, if we want to decompress and then deserialize an inbound message using JSON, it means that for the outbound, we should instead first serialize and then compress.","text_count":511,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to observe here that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inbound"}]},{"block_type":"text","content":"middleware is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"pushed"}]},{"block_type":"text","content":"to the end of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inboundMiddleware"}]},{"block_type":"text","content":"list, while the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"outbound"}]},{"block_type":"text","content":"middleware is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"inserted"}]},{"block_type":"text","content":"(using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"unshift"}]},{"block_type":"text","content":") at the beginning of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"outboundMiddleware"}]},{"block_type":"text","content":"list. This is because complementary inbound/outbound middleware functions usually need to be executed in an inverted order. For example, if we want to decompress and then deserialize an inbound message using JSON, it means that for the outbound, we should instead first serialize and then compress."}]},{"block_type":"element","block":"k5zy5bm5","search_text":"Note It's important to understand that this convention for organizing the middleware in pairs is not strictly part of the general pattern, but only an implementation detail of our specific example. ","text_count":198,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to understand that this convention for organizing the middleware in pairs is not strictly part of the general pattern, but only an implementation detail of our specific example."}]}]},{"block_type":"element","block":"k5zy5bm6","search_text":"The last function, executeMiddleware , represents the core of our component, it's the function that is responsible for executing the middleware functions. The code from this function should look very familiar; in fact, it is a simple implementation of the asynchronous sequential iteration pattern that we learned in Chapter 3, Asynchronous Control Flow Patterns with Callbacks . Each function in the middleware array received as input is executed one after the other, and the same arg object is provided as an argument to each middleware function; this is the trick that makes it possible to propagate the data from one middleware to the next. At the end of the iteration, the finish() callback is invoked.","text_count":707,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The last function,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"executeMiddleware"}]},{"block_type":"text","content":", represents the core of our component, it's the function that is responsible for executing the middleware functions. The code from this function should look very familiar; in fact, it is a simple implementation of the asynchronous sequential iteration pattern that we learned in Chapter 3,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with Callbacks"}]},{"block_type":"text","content":". Each function in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"middleware"}]},{"block_type":"text","content":"array received as input is executed one after the other, and the same"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"arg"}]},{"block_type":"text","content":"object is provided as an argument to each middleware function; this is the trick that makes it possible to propagate the data from one middleware to the next. At the end of the iteration, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"finish()"}]},{"block_type":"text","content":"callback is invoked."}]},{"block_type":"element","block":"k5zy5bm7","search_text":"Note For brevity we are not supporting an error middleware pipeline. Normally, when a middleware function propagates an error, another set of middleware specifically dedicated to handling errors is executed. This can be easily implemented using the same technique that we are demonstrating here. ","text_count":296,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For brevity we are not supporting an error middleware pipeline. Normally, when a middleware function propagates an error, another set of middleware specifically dedicated to handling errors is executed. This can be easily implemented using the same technique that we are demonstrating here."}]}]},{"block_type":"element","block":"k5zy5bm8","search_text":"A middleware to support JSON messages","text_count":37,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"A middleware to support JSON messages"}]},{"block_type":"element","block":"k5zy5bm9","search_text":"Now that we have implemented our Middleware Manager, we can create a pair of middleware functions to demonstrate how to process inbound and outbound messages. As we said, one of the goals of our middleware infrastructure is to have a filter that serializes and deserializes JSON messages, so let's create new middleware to take care of this. In a new module called jsonMiddleware.js , let's include the following code:","text_count":418,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have implemented our Middleware Manager, we can create a pair of middleware functions to demonstrate how to process inbound and outbound messages. As we said, one of the goals of our middleware infrastructure is to have a filter that serializes and deserializes JSON messages, so let's create new middleware to take care of this. In a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"jsonMiddleware.js"}]},{"block_type":"text","content":", let's include the following code:"}]},{"block_type":"element","block":"k5zy5bma","search_text":"module.exports.json = () => { return { inbound: function (message, next) { message.data = JSON.parse(message.data.toString()); next(); }, outbound: function (message, next) { message.data = new Buffer(JSON.stringify(message.data)); next(); } } }; ","text_count":247,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports.json = () =&gt; { \n  return { \n    inbound: function (message, next) { \n      message.data = JSON.parse(message.data.toString()); \n      next(); \n    }, \n    outbound: function (message, next) { \n      message.data = new Buffer(JSON.stringify(message.data)); \n      next(); \n    } \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5bmb","search_text":"The json middleware that we just created is very simple:","text_count":56,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"json"}]},{"block_type":"text","content":"middleware that we just created is very simple:"}]},{"block_type":"element","block":"k5zy5bmc","search_text":"The inbound middleware deserializes the message received as an input and assigns the result back to the data property of message , so that it can be further processed along the pipeline The outbound middleware serializes any data found into message.data ","text_count":254,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inbound"}]},{"block_type":"text","content":"middleware deserializes the message received as an input and assigns the result back to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"data"}]},{"block_type":"text","content":"property of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"message"}]},{"block_type":"text","content":", so that it can be further processed along the pipeline"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"outbound"}]},{"block_type":"text","content":"middleware serializes any data found into"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"message.data"}]}]}]},{"block_type":"element","block":"k5zy5bmd","search_text":"Please note how the middleware supported by our framework is quite different from the one used in Express; this is totally normal and a perfect demonstration of how we can adapt this pattern to fit our specific need.","text_count":216,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Please note how the middleware supported by our framework is quite different from the one used in Express; this is totally normal and a perfect demonstration of how we can adapt this pattern to fit our specific need."}]},{"block_type":"element","block":"k5zy5bme","search_text":"Using the ØMQ middleware framework","text_count":34,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Using the &Oslash;MQ middleware framework"}]},{"block_type":"element","block":"k5zy5bmf","search_text":"We are now ready to use the middleware infrastructure that we just created. To do that, we are going to build a very simple application, with a client sending a ping to a server at regular intervals and the server echoing back the message received.","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are now ready to use the middleware infrastructure that we just created. To do that, we are going to build a very simple application, with a client sending a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"ping"}]},{"block_type":"text","content":"to a server at regular intervals and the server echoing back the message received."}]},{"block_type":"element","block":"k5zy5bmg","search_text":"From an implementation perspective, we are going to rely on a request/reply messaging pattern using the req/rep socket pair provided by ØMQ ( http://zguide.zeromq.org/page:all#Ask-and-Ye-Shall-Receive ). We will then wrap the sockets with our zmqMiddlewareManager to get all the advantages from the middleware infrastructure that we built, including the middleware for serializing/deserializing JSON messages.","text_count":409,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From an implementation perspective, we are going to rely on a request/reply messaging pattern using the req/rep socket pair provided by &Oslash;MQ ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://zguide.zeromq.org/page:all#Ask-and-Ye-Shall-Receive"},"children":[{"block_type":"text","content":"http://zguide.zeromq.org/page:all#Ask-and-Ye-Shall-Receive"}]},{"block_type":"text","content":"). We will then wrap the sockets with our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"zmqMiddlewareManager"}]},{"block_type":"text","content":"to get all the advantages from the middleware infrastructure that we built, including the middleware for serializing/deserializing JSON messages."}]},{"block_type":"element","block":"k5zy5bmh","search_text":"The server","text_count":10,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The server"}]},{"block_type":"element","block":"k5zy5bmi","search_text":"Let's start by creating the server side ( server.js ). In the first part of the module, we initialize our components:","text_count":117,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start by creating the server side ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"server.js"}]},{"block_type":"text","content":"). In the first part of the module, we initialize our components:"}]},{"block_type":"element","block":"k5zy5bmj","search_text":"const zmq = require('zmq'); const ZmqMiddlewareManager = require('./zmqMiddlewareManager'); const jsonMiddleware = require('./jsonMiddleware'); const reply = zmq.socket('rep'); reply.bind('tcp://127.0.0.1:5000'); ","text_count":213,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const zmq = require('zmq'); \nconst ZmqMiddlewareManager = require('./zmqMiddlewareManager'); \nconst jsonMiddleware = require('./jsonMiddleware'); \nconst reply = zmq.socket('rep'); \nreply.bind('tcp://127.0.0.1:5000');"}]}]},{"block_type":"element","block":"k5zy5bmk","search_text":"In the preceding code, we loaded the required dependencies and bind a ØMQ'rep' (reply) socket to a local port. Next, we initialize our middleware:","text_count":146,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we loaded the required dependencies and bind a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"&Oslash;MQ'rep'"}]},{"block_type":"text","content":"(reply) socket to a local port. Next, we initialize our middleware:"}]},{"block_type":"element","block":"k5zy5bml","search_text":"const zmqm = new ZmqMiddlewareManager(reply); zmqm.use(jsonMiddleware.json()); ","text_count":79,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const zmqm = new ZmqMiddlewareManager(reply); \nzmqm.use(jsonMiddleware.json());"}]}]},{"block_type":"element","block":"k5zy5bmm","search_text":"We created a new ZmqMiddlewareManager object and then added two items of middleware, one for compressing/decompressing the messages and another one for parsing/serializing JSON messages.","text_count":186,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We created a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ZmqMiddlewareManager"}]},{"block_type":"text","content":"object and then added two items of middleware, one for compressing/decompressing the messages and another one for parsing/serializing JSON messages."}]},{"block_type":"element","block":"k5zy5bmn","search_text":"Note For brevity, we did not show the implementation of the zlib middleware, but you can find it in the sample code that is distributed with the book. ","text_count":151,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For brevity, we did not show the implementation of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"zlib"}]},{"block_type":"text","content":"middleware, but you can find it in the sample code that is distributed with the book."}]}]},{"block_type":"element","block":"k5zy5bmo","search_text":"Now we are ready to handle a request coming from the client; we will do this by simply adding more middleware, this time using it as a request handler:","text_count":151,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to handle a request coming from the client; we will do this by simply adding more middleware, this time using it as a request handler:"}]},{"block_type":"element","block":"k5zy5bmp","search_text":"zmqm.use({ inbound: function (message, next) { console.log('Received: ', message.data); if (message.data.action === 'ping') { this.send({action: 'pong', echo: message.data.echo}); } next(); } }); ","text_count":196,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"zmqm.use({ \n  inbound: function (message, next) { \n    console.log('Received: ', message.data); \n    if (message.data.action === 'ping') { \n      this.send({action: 'pong', echo: message.data.echo}); \n    } \n    next(); \n  } \n});"}]}]},{"block_type":"element","block":"k5zy5bmq","search_text":"Since this last item of middleware is defined after the zlib and json middleware, we can transparently use the decompressed and deserialized message that is available in the message.data variable. On the other hand, any data passed to send() will be processed by the outbound middleware, which in our case will serialize then compress the data.","text_count":344,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Since this last item of middleware is defined after the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"zlib"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"json"}]},{"block_type":"text","content":"middleware, we can transparently use the decompressed and deserialized message that is available in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"message.data"}]},{"block_type":"text","content":"variable. On the other hand, any data passed to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"send()"}]},{"block_type":"text","content":"will be processed by the outbound middleware, which in our case will serialize then compress the data."}]},{"block_type":"element","block":"k5zy5bmr","search_text":"The client","text_count":10,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The client"}]},{"block_type":"element","block":"k5zy5bms","search_text":"On the client side of our little application, 'client.js' , we will first have to initiate a new ØMQ'req' (request) socket connected to the port 5000 , the one used by our server:","text_count":179,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the client side of our little application,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"'client.js'"}]},{"block_type":"text","content":", we will first have to initiate a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"&Oslash;MQ'req'"}]},{"block_type":"text","content":"(request) socket connected to the port"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"5000"}]},{"block_type":"text","content":", the one used by our server:"}]},{"block_type":"element","block":"k5zy5bmt","search_text":"const zmq = require('zmq'); const ZmqMiddlewareManager = require('./zmqMiddlewareManager'); const jsonMiddleware = require('./jsonMiddleware'); const request = zmq.socket('req'); request.connect('tcp://127.0.0.1:5000'); ","text_count":220,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const zmq = require('zmq'); \nconst ZmqMiddlewareManager = require('./zmqMiddlewareManager'); \nconst jsonMiddleware = require('./jsonMiddleware'); \n \nconst request = zmq.socket('req'); \nrequest.connect('tcp://127.0.0.1:5000');"}]}]},{"block_type":"element","block":"k5zy5bmu","search_text":"Then, we need to set up our middleware framework in the same way that we did for the server:","text_count":92,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we need to set up our middleware framework in the same way that we did for the server:"}]},{"block_type":"element","block":"k5zy5bmv","search_text":"const zmqm = new ZmqMiddlewareManager(request); zmqm.use(jsonMiddleware.json()); ","text_count":81,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const zmqm = new ZmqMiddlewareManager(request); \nzmqm.use(jsonMiddleware.json());"}]}]},{"block_type":"element","block":"k5zy5bmw","search_text":"Next, we create an inbound item of middleware to handle the responses coming from the server:","text_count":93,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, we create an inbound item of middleware to handle the responses coming from the server:"}]},{"block_type":"element","block":"k5zy5bmx","search_text":"zmqm.use({ inbound: function (message, next) { console.log('Echoed back: ', message.data); next(); } }); ","text_count":105,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"zmqm.use({ \n  inbound: function (message, next) { \n    console.log('Echoed back: ', message.data); \n    next(); \n  } \n});"}]}]},{"block_type":"element","block":"k5zy5bmy","search_text":"In the preceding code, we simply intercept any inbound response and print it to the console.","text_count":92,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we simply intercept any inbound response and print it to the console."}]},{"block_type":"element","block":"k5zy5bmz","search_text":"Finally, we set up a timer to send some ping requests at regular intervals, always using the zmqMiddlewareManager to get all the advantages of our middleware:","text_count":158,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we set up a timer to send some ping requests at regular intervals, always using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"zmqMiddlewareManager"}]},{"block_type":"text","content":"to get all the advantages of our middleware:"}]},{"block_type":"element","block":"k5zy5bn0","search_text":"setInterval( () => { zmqm.send({action: 'ping', echo: Date.now()}); }, 1000); ","text_count":78,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"setInterval( () =&gt; { \n  zmqm.send({action: 'ping', echo: Date.now()}); \n}, 1000);"}]}]},{"block_type":"element","block":"k5zy5bn1","search_text":"Note that we are defining all our inbound and outbound functions explicitly using the function keyword, avoiding the usage of the arrow function syntax. This is intentional because, as we learned in Chapter 1 , Welcome to the Node.js Platform , the arrow function declaration blocks the function scope to its lexical scope. Using call on a function defined with an arrow function will not alter its internal scope. In other words, if we use an arrow function, our middleware will not recognize this as an instance of zmqMiddlewareManager and a \"TypeError: this.send is not a function\" will be raised.","text_count":600,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Note that we are defining all our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inbound"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"outbound"}]},{"block_type":"text","content":"functions explicitly using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"function"}]},{"block_type":"text","content":"keyword, avoiding the usage of the arrow function syntax. This is intentional because, as we learned in Chapter 1"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":", Welcome to the Node.js Platform"}]},{"block_type":"text","content":", the arrow function declaration blocks the function scope to its lexical scope. Using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"call"}]},{"block_type":"text","content":"on a function defined with an arrow function will not alter its internal scope. In other words, if we use an arrow function, our middleware will not recognize"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this"}]},{"block_type":"text","content":"as an instance of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"zmqMiddlewareManager"}]},{"block_type":"text","content":"and a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"\"TypeError: this.send is not a function\""}]},{"block_type":"text","content":"will be raised."}]},{"block_type":"element","block":"k5zy5bn2","search_text":"We can now try our application by first starting the server:","text_count":60,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now try our application by first starting the server:"}]},{"block_type":"element","block":"k5zy5bn3","search_text":"node server ","text_count":12,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node server"}]}]},{"block_type":"element","block":"k5zy5bn4","search_text":"We can then start the client with the following command:","text_count":56,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can then start the client with the following command:"}]},{"block_type":"element","block":"k5zy5bn5","search_text":"node client ","text_count":12,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node client"}]}]},{"block_type":"element","block":"k5zy5bn6","search_text":"At this point, we should see the client sending messages and the server echoing them back.","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we should see the client sending messages and the server echoing them back."}]},{"block_type":"element","block":"k5zy5bn7","search_text":"Our middleware framework did its job; it allowed us to decompress/compress and deserialize/serialize our messages transparently, leaving the handlers free to focus on their business logic!","text_count":188,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our middleware framework did its job; it allowed us to decompress/compress and deserialize/serialize our messages transparently, leaving the handlers free to focus on their business logic!"}]},{"block_type":"element","block":"k5zy5bn8","search_text":"Middleware using generators in Koa","text_count":34,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Middleware using generators in Koa"}]},{"block_type":"element","block":"k5zy5bn9","search_text":"In the previous paragraphs we saw how it's possible to implement the middleware pattern with callbacks and an example applied to a messaging system.","text_count":148,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous paragraphs we saw how it's possible to implement the middleware pattern with callbacks and an example applied to a messaging system."}]},{"block_type":"element","block":"k5zy5bna","search_text":"As we saw when we introduced it, the middleware pattern really shines in web frameworks as a handy mechanism to build \"layers\" of logic that can deal with input and output as data flows throughout the core of the application.","text_count":225,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we saw when we introduced it, the middleware pattern really shines in web frameworks as a handy mechanism to build \"layers\" of logic that can deal with input and output as data flows throughout the core of the application."}]},{"block_type":"element","block":"k5zy5bnb","search_text":"Apart from Express, another web framework which makes heavy use of the middleware pattern is Koa ( http://koajs.com/ ). Koa is an extremely interesting framework mostly because of its radical choice to implement the middleware pattern only using ES2015 generator functions rather than using callbacks. We will see in a moment how this choice dramatically simplifies the way middleware can be written, but before moving to some code let's picture another way to visualize the middleware pattern, specific for this web framework:","text_count":527,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Apart from Express, another web framework which makes heavy use of the middleware pattern is Koa ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://koajs.com/"},"children":[{"block_type":"text","content":"http://koajs.com/"}]},{"block_type":"text","content":"). Koa is an extremely interesting framework mostly because of its radical choice to implement the middleware pattern only using ES2015 generator functions rather than using callbacks. We will see in a moment how this choice dramatically simplifies the way middleware can be written, but before moving to some code let's picture another way to visualize the middleware pattern, specific for this web framework:"}]},{"block_type":"element","block":"k5zy5bnc","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000028.jpg","alt":"Middleware using generators in Koa","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bnd","search_text":"In this representation, we have an incoming request that, before getting into the core of our app, traverses a number of middlewares. This part of the flow is called inbound or downstream . After the flow reaches the core of the app, it traverses all the middlewares again, but this time in an inverse order. This allows the middlewares to perform other actions after the main logic of the app has been executed and the response is ready to be sent to the user. This part of the flow is called outbound or upstream .","text_count":516,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this representation, we have an incoming request that, before getting into the core of our app, traverses a number of middlewares. This part of the flow is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"inbound"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"downstream"}]},{"block_type":"text","content":". After the flow reaches the core of the app, it traverses all the middlewares again, but this time in an inverse order. This allows the middlewares to perform other actions after the main logic of the app has been executed and the response is ready to be sent to the user. This part of the flow is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"outbound"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"upstream"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bne","search_text":"The representation above is sometime called \"the onion\" among programmers because of the way middleware wraps the core app, which reminds us of the layers of an onion.","text_count":167,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The representation above is sometime called \"the onion\" among programmers because of the way middleware wraps the core app, which reminds us of the layers of an onion."}]},{"block_type":"element","block":"k5zy5bnf","search_text":"Now let's create a new web application with Koa to see how we can easily write a custom middleware with generator functions.","text_count":124,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now let's create a new web application with Koa to see how we can easily write a custom middleware with generator functions."}]},{"block_type":"element","block":"k5zy5bng","search_text":"Our app will be a very simple JSON API that returns the current timestamp in our server.","text_count":88,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our app will be a very simple JSON API that returns the current timestamp in our server."}]},{"block_type":"element","block":"k5zy5bnh","search_text":"First of all, we need to install Koa:","text_count":37,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First of all, we need to install Koa:"}]},{"block_type":"element","block":"k5zy5bni","search_text":"npm install koa ","text_count":16,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install koa"}]}]},{"block_type":"element","block":"k5zy5bnj","search_text":"Then we can write our new app.js :","text_count":34,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then we can write our new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bnk","search_text":"const app = require('koa')(); app.use(function *(){ this.body = {\"now\": new Date()}; }); app.listen(3000); ","text_count":107,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const app = require('koa')(); \n \napp.use(function *(){ \n  this.body = {\"now\": new Date()}; \n}); \n \napp.listen(3000);"}]}]},{"block_type":"element","block":"k5zy5bnl","search_text":"It's important to notice that the core of our application is defined with a generator function within an app.use call. We will see in a moment that middlewares are added to the app in the exact same way and we will realize that the core of our app is, nonetheless, the last middleware added to the application (and which doesn't need to yield to another following item of middleware).","text_count":384,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to notice that the core of our application is defined with a generator function within an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.use"}]},{"block_type":"text","content":"call. We will see in a moment that middlewares are added to the app in the exact same way and we will realize that the core of our app is, nonetheless, the last middleware added to the application (and which doesn't need to yield to another following item of middleware)."}]},{"block_type":"element","block":"k5zy5bnm","search_text":"The first draft of our app is ready. We can now run it:","text_count":55,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first draft of our app is ready. We can now run it:"}]},{"block_type":"element","block":"k5zy5bnn","search_text":"node app.js ","text_count":12,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app.js"}]}]},{"block_type":"element","block":"k5zy5bno","search_text":"We then point our browser to http://localhost:3000 to see it in action.","text_count":71,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We then point our browser to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:3000"}]},{"block_type":"text","content":"to see it in action."}]},{"block_type":"element","block":"k5zy5bnp","search_text":"Notice that Koa takes care of converting the response to a JSON string and adds the correct content-type header when we set a JavaScript object to be the body of the current response.","text_count":183,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Notice that Koa takes care of converting the response to a JSON string and adds the correct"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"content-type"}]},{"block_type":"text","content":"header when we set a JavaScript object to be the body of the current response."}]},{"block_type":"element","block":"k5zy5bnq","search_text":"Our API works great, but now we might decide that we would like to protect it from people abusing it and make sure people don't make more than one request in less than one second. This logic can be considered external to the business logic of our API, so we should add it by simply writing a new dedicated item of middleware. Let's write it as a separate module called rateLimit.js :","text_count":383,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our API works great, but now we might decide that we would like to protect it from people abusing it and make sure people don't make more than one request in less than one second. This logic can be considered external to the business logic of our API, so we should add it by simply writing a new dedicated item of middleware. Let's write it as a separate module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"rateLimit.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bnr","search_text":"const lastCall = new Map(); module.exports = function *(next) { // inbound const now = new Date(); if (lastCall.has(this.ip) && now.getTime() - lastCall.get(this.ip).getTime() < 1000) { return this.status = 429; // Too Many Requests } yield next; // outbound lastCall.set(this.ip, now); this.set('X-RateLimit-Reset', now.getTime() + 1000); }; ","text_count":343,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const lastCall = new Map(); \n \nmodule.exports = function *(next) { \n \n  // inbound \n  const now = new Date(); \n  if (lastCall.has(this.ip) && now.getTime() - \n      lastCall.get(this.ip).getTime() &lt; 1000) { \n     return this.status = 429; // Too Many Requests \n  } \n \n  yield next; \n \n  // outbound \n  lastCall.set(this.ip, now); \n  this.set('X-RateLimit-Reset', now.getTime() + 1000); \n};"}]}]},{"block_type":"element","block":"k5zy5bns","search_text":"Our module exports a generator function that implements the logic for our middleware.","text_count":85,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our module exports a generator function that implements the logic for our middleware."}]},{"block_type":"element","block":"k5zy5bnt","search_text":"The first thing to notice is that we are using a Map object to store the time we received the last call from a given IP address. We will use this Map as a sort of in-memory database to be able to check whether a specific user is overloading our server with more than one request per second. Of course this implementation is just a dummy example and it's not ideal in a real case scenario, where it is better to just use external storage such as Redis or Memcache and a more refined logic to detect overloads.","text_count":508,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first thing to notice is that we are using a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Map"}]},{"block_type":"text","content":"object to store the time we received the last call from a given IP address. We will use this"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Map"}]},{"block_type":"text","content":"as a sort of in-memory database to be able to check whether a specific user is overloading our server with more than one request per second. Of course this implementation is just a dummy example and it's not ideal in a real case scenario, where it is better to just use external storage such as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Redis"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Memcache"}]},{"block_type":"text","content":"and a more refined logic to detect overloads."}]},{"block_type":"element","block":"k5zy5bnu","search_text":"We can see that the body of the middleware is divided in two logical parts, inbound and outbound , separated from the yield next call. In the inbound part, we haven't hit the core of the application yet, so it's the place where we need to check whether the user is exceeding our rate limit. If that is the case, we simply set the HTTP status code of the response to 429 (too many requests) and we return to stop the execution of the flow.","text_count":438,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can see that the body of the middleware is divided in two logical parts,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"inbound"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"outbound"}]},{"block_type":"text","content":", separated from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield next"}]},{"block_type":"text","content":"call. In the inbound part, we haven't hit the core of the application yet, so it's the place where we need to check whether the user is exceeding our rate limit. If that is the case, we simply set the HTTP status code of the response to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"429"}]},{"block_type":"text","content":"(too many requests) and we return to stop the execution of the flow."}]},{"block_type":"element","block":"k5zy5bnv","search_text":"Another way we can progress to the next item of middleware is by calling yield next . This is where the magic happens: using generator functions and yield, the execution of the middleware is suspended to execute all the other middlewares in the list sequentially and only when the last item of middleware is executed (the real core of the app) the outbound flow can start and control is given back to every middleware in an inverted order, until the first middleware is called again.","text_count":483,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another way we can progress to the next item of middleware is by calling"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"yield next"}]},{"block_type":"text","content":". This is where the magic happens: using generator functions and yield, the execution of the middleware is suspended to execute all the other middlewares in the list sequentially and only when the last item of middleware is executed (the real core of the app) the outbound flow can start and control is given back to every middleware in an inverted order, until the first middleware is called again."}]},{"block_type":"element","block":"k5zy5bnw","search_text":"When our middleware again receives control and the generator function is resumed, we take care of storing the timestamp for the successful call, and adding a X-RateLimit-Reset header to the request, to signal when the user will be able to make a new request.","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When our middleware again receives control and the generator function is resumed, we take care of storing the timestamp for the successful call, and adding a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"X-RateLimit-Reset"}]},{"block_type":"text","content":"header to the request, to signal when the user will be able to make a new request."}]},{"block_type":"element","block":"k5zy5bnx","search_text":"Note If you need a more complete and reliable implementation of rate-limit middleware, you can have a look at the koajs/ratelimit module: https://github.com/koajs/ratelimit ","text_count":173,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you need a more complete and reliable implementation of rate-limit middleware, you can have a look at the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"koajs/ratelimit"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/koajs/ratelimit"},"children":[{"block_type":"text","content":"https://github.com/koajs/ratelimit"}]}]}]},{"block_type":"element","block":"k5zy5bny","search_text":"To enable this middleware, we need to add the following line in our app.js before the existing app.use which contains the core logic of our app:","text_count":144,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To enable this middleware, we need to add the following line in our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"before the existing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.use"}]},{"block_type":"text","content":"which contains the core logic of our app:"}]},{"block_type":"element","block":"k5zy5bnz","search_text":"app.use(require('./rateLimit')); ","text_count":33,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"app.use(require('./rateLimit'));"}]}]},{"block_type":"element","block":"k5zy5bo0","search_text":"Now to see our new app in action, we need to restart our server and open our browser again. If we refresh the page quickly a few times, we will probably hit the rate limit and we should see the descriptive error message \" Too Many Requests\" . This message is automatically added by Koa as a consequence of setting the status code to 429 and having an empty response body.","text_count":371,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now to see our new app in action, we need to restart our server and open our browser again. If we refresh the page quickly a few times, we will probably hit the rate limit and we should see the descriptive error message \""},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Too Many Requests\""}]},{"block_type":"text","content":". This message is automatically added by Koa as a consequence of setting the status code to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"429"}]},{"block_type":"text","content":"and having an empty response body."}]},{"block_type":"element","block":"k5zy5bo1","search_text":"Note If you are interested in reading the actual implementation of the middleware pattern, based on generators used within the Koa framework, you can have a look at the koajs/compose repository ( https://github.com/koajs/compose ), which is the core module used to transform an array of generators into a new generator which executes the original ones in a pipeline. ","text_count":367,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you are interested in reading the actual implementation of the middleware pattern, based on generators used within the Koa framework, you can have a look at the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"koajs/compose"}]},{"block_type":"text","content":"repository ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/koajs/compose"},"children":[{"block_type":"text","content":"https://github.com/koajs/compose"}]},{"block_type":"text","content":"), which is the core module used to transform an array of generators into a new generator which executes the original ones in a pipeline."}]}]},{"block_type":"element","block":"k5zy5bo2","search_text":"Command","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Command"}]},{"block_type":"element","block":"k5zy5bo3","search_text":"Another design pattern with huge importance in Node.js is Command . In its most generic definition, we can consider a Command as any object that encapsulates all the information necessary to perform an action at a later time. So, instead of invoking a method or a function directly, we create an object representing the intention to perform such an invocation; it will then be the responsibility of another component to materialize the intent, transforming it into an actual action. Traditionally, this pattern is built around four major components, as shown in the following figure:","text_count":583,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another design pattern with huge importance in Node.js is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Command"}]},{"block_type":"text","content":". In its most generic definition, we can consider a Command as any object that encapsulates all the information necessary to perform an action at a later time. So, instead of invoking a method or a function directly, we create an object representing the intention to perform such an invocation; it will then be the responsibility of another component to materialize the intent, transforming it into an actual action. Traditionally, this pattern is built around four major components, as shown in the following figure:"}]},{"block_type":"element","block":"k5zy5bo4","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000045.jpg","alt":"Command","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bo5","search_text":"The typical organization of the Command pattern can be described as follows:","text_count":76,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The typical organization of the Command pattern can be described as follows:"}]},{"block_type":"element","block":"k5zy5bo6","search_text":"Command : This is the object encapsulating the information necessary to invoke a method or function. Client : This creates the command and provides it to the Invoker. Invoker : This is responsible for executing the command on the target. Target (or Receiver ): This is the subject of the invocation. It can be a lone function or the method of an object. ","text_count":354,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Command"}]},{"block_type":"text","content":": This is the object encapsulating the information necessary to invoke a method or function."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Client"}]},{"block_type":"text","content":": This creates the command and provides it to the Invoker."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Invoker"}]},{"block_type":"text","content":": This is responsible for executing the command on the target."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Target"}]},{"block_type":"text","content":"(or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Receiver"}]},{"block_type":"text","content":"): This is the subject of the invocation. It can be a lone function or the method of an object."}]}]},{"block_type":"element","block":"k5zy5bo7","search_text":"As we will see, these four components can vary a lot depending on the way we want to implement the pattern; this should not sound new at this point.","text_count":148,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we will see, these four components can vary a lot depending on the way we want to implement the pattern; this should not sound new at this point."}]},{"block_type":"element","block":"k5zy5bo8","search_text":"Using the Command pattern instead of directly executing an operation has several advantages and applications:","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using the Command pattern instead of directly executing an operation has several advantages and applications:"}]},{"block_type":"element","block":"k5zy5bo9","search_text":"A command can be scheduled for execution at a later time. A command can be easily serialized and sent over the network. This simple property allows us to distribute jobs across remote machines, transmit commands from the browser to the server, create RPC systems, and so on. Commands make it easy to keep a history of all the operations executed on a system. Commands are an important part of some algorithms for data synchronization and conflict resolution. A command scheduled for execution can be cancelled if it's not yet executed. It can also be reverted (undone), bringing the state of the application to the point before the command was executed. Several commands can be grouped together. This can be used to create atomic transactions or to implement a mechanism whereby all the operations in the group are executed at once. Different kinds of transformation can be performed on a set of commands, such as duplicate removal, joining and splitting, or applying more complex algorithms such as Operational Transformation ( OT ), which is the base for most of today's real-time collaborative software, such as collaborative text editing. ","text_count":1143,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A command can be scheduled for execution at a later time."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A command can be easily serialized and sent over the network. This simple property allows us to distribute jobs across remote machines, transmit commands from the browser to the server, create RPC systems, and so on."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Commands make it easy to keep a history of all the operations executed on a system."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Commands are an important part of some algorithms for data synchronization and conflict resolution."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A command scheduled for execution can be cancelled if it's not yet executed. It can also be reverted (undone), bringing the state of the application to the point before the command was executed."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Several commands can be grouped together. This can be used to create atomic transactions or to implement a mechanism whereby all the operations in the group are executed at once."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Different kinds of transformation can be performed on a set of commands, such as duplicate removal, joining and splitting, or applying more complex algorithms such as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Operational Transformation"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"OT"}]},{"block_type":"text","content":"), which is the base for most of today's real-time collaborative software, such as collaborative text editing."}]}]},{"block_type":"element","block":"k5zy5boa","search_text":"Tip A great explanation of how OT works can be found at http://www.codecommit.com/blog/java/understanding-and-applying-operational-transformation . ","text_count":148,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A great explanation of how OT works can be found at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.codecommit.com/blog/java/understanding-and-applying-operational-transformation"},"children":[{"block_type":"text","content":"http://www.codecommit.com/blog/java/understanding-and-applying-operational-transformation"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5bob","search_text":"The preceding list clearly shows us how important this pattern is, especially in a platform such as Node.js where networking and asynchronous execution are essential players.","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding list clearly shows us how important this pattern is, especially in a platform such as Node.js where networking and asynchronous execution are essential players."}]},{"block_type":"element","block":"k5zy5boc","search_text":"A flexible pattern","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"A flexible pattern"}]},{"block_type":"element","block":"k5zy5bod","search_text":"As we already mentioned, the Command pattern in JavaScript can be implemented in many different ways; we are now going to demonstrate only a few of them just to give an idea of its scope.","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we already mentioned, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Command"}]},{"block_type":"text","content":"pattern in JavaScript can be implemented in many different ways; we are now going to demonstrate only a few of them just to give an idea of its scope."}]},{"block_type":"element","block":"k5zy5boe","search_text":"The task pattern","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The task pattern"}]},{"block_type":"element","block":"k5zy5bof","search_text":"We can start off with the most basic and trivial implementation: the task pattern . The easiest way in JavaScript to create an object representing an invocation is, of course, by creating a closure:","text_count":198,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can start off with the most basic and trivial implementation: the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"task pattern"}]},{"block_type":"text","content":". The easiest way in JavaScript to create an object representing an invocation is, of course, by creating a closure:"}]},{"block_type":"element","block":"k5zy5bog","search_text":"function createTask(target, args) { return () => { target.apply(null, args); } } ","text_count":81,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function createTask(target, args) { \n  return () =&gt; { \n    target.apply(null, args); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5boh","search_text":"This should not look new at all; we have used this pattern already so many times throughout the book, and in particular in Chapter 3, Asynchronous Control Flow Patterns with Callbacks . This technique allowed us to use a separate component to control and schedule the execution of our tasks, which is essentially equivalent to the Invoker of the Command pattern. For example, do you remember how we were defining tasks to pass to the async library? Or even better, do you remember how we were using thunks in combination with generators? The callback pattern itself can be considered a very simple version of the Command pattern.","text_count":629,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This should not look new at all; we have used this pattern already so many times throughout the book, and in particular in Chapter 3,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with Callbacks"}]},{"block_type":"text","content":". This technique allowed us to use a separate component to control and schedule the execution of our tasks, which is essentially equivalent to the Invoker of the Command pattern. For example, do you remember how we were defining tasks to pass to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async"}]},{"block_type":"text","content":"library? Or even better, do you remember how we were using"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"thunks"}]},{"block_type":"text","content":"in combination with generators? The callback pattern itself can be considered a very simple version of the Command pattern."}]},{"block_type":"element","block":"k5zy5boi","search_text":"A more complex command","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"A more complex command"}]},{"block_type":"element","block":"k5zy5boj","search_text":"Let's now work on an example of a more complex command; this time we want to support undo and serialization . Let's start with the target of our commands, a little object that is responsible for sending status updates to a service like Twitter. We use a mock-up of such a service for simplicity:","text_count":295,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now work on an example of a more complex command; this time we want to support"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"undo"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"serialization"}]},{"block_type":"text","content":". Let's start with the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"target"}]},{"block_type":"text","content":"of our commands, a little object that is responsible for sending status updates to a service like Twitter. We use a mock-up of such a service for simplicity:"}]},{"block_type":"element","block":"k5zy5bok","search_text":"const statusUpdateService = { statusUpdates: {}, sendUpdate: function(status) { console.log('Status sent: ' + status); let id = Math.floor(Math.random() * 1000000); statusUpdateService.statusUpdates[id] = status; return id; }, destroyUpdate: id => { console.log('Status removed: ' + id); delete statusUpdateService.statusUpdates[id]; } }; ","text_count":339,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const statusUpdateService = { \n  statusUpdates: {}, \n  sendUpdate: function(status) { \n    console.log('Status sent: ' + status); \n    let id = Math.floor(Math.random() * 1000000); \n    statusUpdateService.statusUpdates[id] = status; \n    return id; \n  }, \n \n  destroyUpdate: id =&gt; { \n    console.log('Status removed: ' + id); \n    delete statusUpdateService.statusUpdates[id]; \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5bol","search_text":"Now, let's create a command to represent the posting of a new status update:","text_count":76,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's create a command to represent the posting of a new status update:"}]},{"block_type":"element","block":"k5zy5bom","search_text":"function createSendStatusCmd(service, status) { let postId = null; const command = () => { postId = service.sendUpdate(status); }; command.undo = () => { if(postId) { service.destroyUpdate(postId); postId = null; } }; command.serialize = () => { return {type: 'status', action: 'post', status: status}; }; return command; } ","text_count":324,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function createSendStatusCmd(service, status) { \n  let postId = null; \n \n  const command = () =&gt; { \n    postId = service.sendUpdate(status); \n  }; \n \n  command.undo = () =&gt; { \n    if(postId) { \n      service.destroyUpdate(postId); \n      postId = null; \n    } \n  }; \n \n  command.serialize = () =&gt; { \n    return {type: 'status', action: 'post', status: status}; \n  }; \n \n  return command; \n}"}]}]},{"block_type":"element","block":"k5zy5bon","search_text":"The preceding function is a factory that produces new sendStatus commands. Each command implements the following three functionalities:","text_count":135,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding function is a factory that produces new"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"sendStatus"}]},{"block_type":"text","content":"commands. Each command implements the following three functionalities:"}]},{"block_type":"element","block":"k5zy5boo","search_text":"The command itself is a function that, when invoked, will trigger the action; in other words, it implements the task pattern that we have seen before. The command when executed will send a new status update using the methods of the target service. An undo() function, attached to the main task, that reverts the effects of the operations. In our case, we are simply invoking the destroyUpdate() method on the target service. A serialize() function that builds a JSON object that contains all the necessary information to reconstruct the same command object. ","text_count":558,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The command itself is a function that, when invoked, will trigger the action; in other words, it implements the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"task"}]},{"block_type":"text","content":"pattern that we have seen before. The command when executed will send a new status update using the methods of the target service."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"An"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"undo()"}]},{"block_type":"text","content":"function, attached to the main task, that reverts the effects of the operations. In our case, we are simply invoking the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"destroyUpdate()"}]},{"block_type":"text","content":"method on the target service."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"serialize()"}]},{"block_type":"text","content":"function that builds a JSON object that contains all the necessary information to reconstruct the same command object."}]}]},{"block_type":"element","block":"k5zy5bop","search_text":"After this, we can build an Invoker; we can start by implementing its constructor and its run() method:","text_count":103,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"After this, we can build an Invoker; we can start by implementing its constructor and its"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"run()"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k5zy5boq","search_text":"class Invoker { constructor() { this.history = []; } run (cmd) { this.history.push(cmd); cmd(); console.log('Command executed', cmd.serialize()); } } ","text_count":150,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class Invoker { \n \n  constructor() { \n    this.history = []; \n  } \n \n  run (cmd) { \n    this.history.push(cmd); \n    cmd(); \n    console.log('Command executed', cmd.serialize()); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5bor","search_text":"The run() method that we defined earlier is the basic functionality of our Invoker ; it is responsible for saving the command into the history instance variable and then triggering the execution of the command itself. Next, we can add a new method that delays the execution of a command:","text_count":287,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"run()"}]},{"block_type":"text","content":"method that we defined earlier is the basic functionality of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Invoker"}]},{"block_type":"text","content":"; it is responsible for saving the command into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"history"}]},{"block_type":"text","content":"instance variable and then triggering the execution of the command itself. Next, we can add a new method that delays the execution of a command:"}]},{"block_type":"element","block":"k5zy5bos","search_text":"delay (cmd, delay) { setTimeout(() => { this.run(cmd); }, delay) } ","text_count":67,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"delay (cmd, delay) { \n  setTimeout(() =&gt; { \n    this.run(cmd); \n  }, delay) \n}"}]}]},{"block_type":"element","block":"k5zy5bot","search_text":"Then, we can implement an undo() method that reverts the last command:","text_count":70,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can implement an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"undo()"}]},{"block_type":"text","content":"method that reverts the last command:"}]},{"block_type":"element","block":"k5zy5bou","search_text":"undo () { const cmd = this.history.pop(); cmd.undo(); console.log('Command undone', cmd.serialize()); } ","text_count":104,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"undo () { \n  const cmd = this.history.pop(); \n  cmd.undo(); \n  console.log('Command undone', cmd.serialize()); \n}"}]}]},{"block_type":"element","block":"k5zy5bov","search_text":"Finally, we also want to be able to run a command on a remote server, by serializing and then transferring it over the network using a web service:","text_count":147,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we also want to be able to run a command on a remote server, by serializing and then transferring it over the network using a web service:"}]},{"block_type":"element","block":"k5zy5bow","search_text":"runRemotely (cmd) { request.post('http://localhost:3000/cmd', {json: cmd.serialize()}, err => { console.log('Command executed remotely', cmd.serialize()); } ); } } ","text_count":164,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"runRemotely (cmd) { \n    request.post('http://localhost:3000/cmd', \n      {json: cmd.serialize()}, \n      err =&gt; { \n        console.log('Command executed remotely', cmd.serialize()); \n      } \n    ); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5box","search_text":"Now that we have the Command, the Invoker, and the Target, the only component missing is the Client. Let's start with instantiating Invoker :","text_count":141,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have the Command, the Invoker, and the Target, the only component missing is the Client. Let's start with instantiating&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Invoker"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5boy","search_text":"const invoker = new Invoker(); ","text_count":31,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const invoker = new Invoker();"}]}]},{"block_type":"element","block":"k5zy5boz","search_text":"Then, we can create a command using the following line of code:","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can create a command using the following line of code:"}]},{"block_type":"element","block":"k5zy5bp0","search_text":"const command = createSendStatusCmd(statusUpdateService, 'HI!'); ","text_count":65,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const command = createSendStatusCmd(statusUpdateService, 'HI!');"}]}]},{"block_type":"element","block":"k5zy5bp1","search_text":"We now have a command representing the posting of a status message; we can then decide to dispatch it immediately:","text_count":114,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We now have a command representing the posting of a status message; we can then decide to dispatch it immediately:"}]},{"block_type":"element","block":"k5zy5bp2","search_text":"invoker.run(command); ","text_count":22,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"invoker.run(command);"}]}]},{"block_type":"element","block":"k5zy5bp3","search_text":"Oops, we made a mistake; let's revert to the state of our timeline as it was before sending the last message:","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Oops, we made a mistake; let's revert to the state of our timeline as it was before sending the last message:"}]},{"block_type":"element","block":"k5zy5bp4","search_text":"invoker.undo(); ","text_count":16,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"invoker.undo();"}]}]},{"block_type":"element","block":"k5zy5bp5","search_text":"We can also decide to schedule the message to be sent in an hour from now:","text_count":74,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can also decide to schedule the message to be sent in an hour from now:"}]},{"block_type":"element","block":"k5zy5bp6","search_text":"invoker.delay(command, 1000 * 60 * 60); ","text_count":40,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"invoker.delay(command, 1000 * 60 * 60);"}]}]},{"block_type":"element","block":"k5zy5bp7","search_text":"Alternatively, we can distribute the load of the application by migrating the task to another machine:","text_count":102,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Alternatively, we can distribute the load of the application by migrating the task to another machine:"}]},{"block_type":"element","block":"k5zy5bp8","search_text":"invoker.runRemotely(command); ","text_count":30,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"invoker.runRemotely(command);"}]}]},{"block_type":"element","block":"k5zy5bp9","search_text":"The little example that we have just created shows how wrapping an operation in a command can open a world of possibilities, and that's just the tip of the iceberg.","text_count":164,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The little example that we have just created shows how wrapping an operation in a command can open a world of possibilities, and that's just the tip of the iceberg."}]},{"block_type":"element","block":"k5zy5bpa","search_text":"As the last remarks, it is worth noticing that a fully-fledged Command pattern has been used only when really needed. We saw, in fact, how much additional code we had to write to simply invoke a method of statusUpdateService ; if all that we need is only an invocation, then a complex command would be overkill. If, however, we need to schedule the execution of a task, or run an asynchronous operation, then the simpler task pattern offers the best compromise. If instead, we need more advanced features such as undo support, transformations, conflict resolution, or one of the other fancy use cases that we described previously, using a more complex representation for the command is almost necessary.","text_count":703,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As the last remarks, it is worth noticing that a fully-fledged Command pattern has been used only when really needed. We saw, in fact, how much additional code we had to write to simply invoke a method of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"statusUpdateService"}]},{"block_type":"text","content":"; if all that we need is only an invocation, then a complex command would be overkill. If, however, we need to schedule the execution of a task, or run an asynchronous operation, then the simpler"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"task pattern"}]},{"block_type":"text","content":"offers the best compromise. If instead, we need more advanced features such as undo support, transformations, conflict resolution, or one of the other fancy use cases that we described previously, using a more complex representation for the command is almost necessary."}]},{"block_type":"element","block":"k5zy5bpb","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5bpc","search_text":"In this chapter, we learned how some of the traditional GoF design patterns can be applied to JavaScript and, in particular, to the Node.js philosophy. Some of them were transformed, some were simplified, others renamed or adapted as part of their assimilation by the language, the platform, and the community. We emphasized how simple patterns such as factory can greatly improve the flexibility of our code and how with Proxy, Decorator, and Adapter we can manipulate, extend, and adapt the interface of existing objects. Strategy, State, and Template, instead, have shown us how to split a bigger algorithm into its static and variable parts, allowing us to improve the code reuse and extensibility of our components. By learning the Middleware pattern, we are now able to process our data using a simple, extensible, and elegant paradigm. Finally, the Command pattern provided us with a simple abstraction to make any operation more flexible and powerful.","text_count":959,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we learned how some of the traditional GoF design patterns can be applied to JavaScript and, in particular, to the Node.js philosophy. Some of them were transformed, some were simplified, others renamed or adapted as part of their assimilation by the language, the platform, and the community. We emphasized how simple patterns such as factory can greatly improve the flexibility of our code and how with Proxy, Decorator, and Adapter we can manipulate, extend, and adapt the interface of existing objects. Strategy, State, and Template, instead, have shown us how to split a bigger algorithm into its static and variable parts, allowing us to improve the code reuse and extensibility of our components. By learning the Middleware pattern, we are now able to process our data using a simple, extensible, and elegant paradigm. Finally, the Command pattern provided us with a simple abstraction to make any operation more flexible and powerful."}]},{"block_type":"element","block":"k5zy5bpd","search_text":"Apart from observing the JavaScript reincarnation of these widely accepted design patterns, we also discovered some new design patterns born and raised specifically in the JavaScript community, such as the R evealing constructor and the Composable factory function patterns. These patterns help to deal with specific aspects of the JavaScript language such as asynchronicity and prototype-based programming .","text_count":408,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Apart from observing the JavaScript reincarnation of these widely accepted design patterns, we also discovered some new design patterns born and raised specifically in the JavaScript community, such as the R"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"evealing constructor"}]},{"block_type":"text","content":"and the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Composable factory function"}]},{"block_type":"text","content":"patterns. These patterns help to deal with specific aspects of the JavaScript language such as"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"asynchronicity"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"prototype-based programming"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bpe","search_text":"Finally, we acquired more evidence of how JavaScript is about getting things done and building software by composing different reusable objects or functions instead of extending many little classes or interfaces. Also, for developers coming from other object-oriented languages, it might have looked weird to see how different some design patterns become when implemented in JavaScript; some might feel lost knowing that there might not be only one, but rather many different ways of implementing a design pattern.","text_count":514,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we acquired more evidence of how JavaScript is about getting things done and building software by composing different reusable objects or functions instead of extending many little classes or interfaces. Also, for developers coming from other object-oriented languages, it might have looked weird to see how different some design patterns become when implemented in JavaScript; some might feel lost knowing that there might not be only one, but rather many different ways of implementing a design pattern."}]},{"block_type":"element","block":"k5zy5bpf","search_text":"JavaScript is a pragmatic language, we said; it allows us to get things done quickly, however, without any kind of structure or guidelines, we are asking for trouble. That's where this book and, in particular, this chapter comes in useful. It tries to teach the right balance between creativity and rigor. It shows not only that there are patterns that can be reused to improve our code, but also that their implementation is not the most important detail; it can vary a lot, or even overlap with other patterns. What really matters is the blueprint, the guidelines, and the idea at the base of the pattern. This is the real reusable piece of information that we can exploit to design better Node.js applications in a fun way.","text_count":726,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"JavaScript is a pragmatic language, we said; it allows us to get things done quickly, however, without any kind of structure or guidelines, we are asking for trouble. That's where this book and, in particular, this chapter comes in useful. It tries to teach the right balance between creativity and rigor. It shows not only that there are patterns that can be reused to improve our code, but also that their implementation is not the most important detail; it can vary a lot, or even overlap with other patterns. What really matters is the blueprint, the guidelines, and the idea at the base of the pattern. This is the real reusable piece of information that we can exploit to design better Node.js applications in a fun way."}]},{"block_type":"element","block":"k5zy5bpg","search_text":"In the next chapter, we will analyze some more design patterns by focusing on one of the most opinionated aspects of programming: how to organize and connect modules together.","text_count":175,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter, we will analyze some more design patterns by focusing on one of the most opinionated aspects of programming: how to organize and connect modules together."}]}]},{"title":"Wiring Modules","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4mr0","number":7,"contents":[{"block_type":"element","block":"k5zy5bph","search_text":"The Node.js module system brilliantly fills an old gap in the JavaScript language: the lack of a native way of organizing code into different self-contained units. One of its biggest advantages is the ability to link these modules together using the require() function (as we have seen in Chapter 2, Node.js Essential Patterns ), a simple yet powerful approach. However, many developers new to Node.js might find this confusing; one of the most frequently asked questions is in fact: what's the best way to pass an instance of component X into module Y?","text_count":553,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Node.js module system brilliantly fills an old gap in the JavaScript language: the lack of a native way of organizing code into different self-contained units. One of its biggest advantages is the ability to link these modules together using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function (as we have seen in Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Essential Patterns"}]},{"block_type":"text","content":"), a simple yet powerful approach. However, many developers new to Node.js might find this confusing; one of the most frequently asked questions is in fact:"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"what's the best way to pass an instance of component X into module Y?"}]}]},{"block_type":"element","block":"k5zy5bpi","search_text":"Sometimes, this confusion results in a desperate quest for the Singleton pattern in the hope of finding a more familiar way to link our modules together. On the other hand, some might overuse the Dependency Injection pattern, leveraging it to handle any type of dependency (even stateless) without a particular reason. It should not be surprising that the art of module wiring is one of the most controversial and opinionated topics in Node.js. There are many schools of thought influencing this area, but none of them can be considered to possess the undisputed truth. Every approach, in fact, has its pros and cons and they often end up mixed together in the same application, adapted, customized, or used in disguise under other names.","text_count":738,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sometimes, this confusion results in a desperate quest for the Singleton pattern in the hope of finding a more familiar way to link our modules together. On the other hand, some might overuse the Dependency Injection pattern, leveraging it to handle any type of dependency (even stateless) without a particular reason. It should not be surprising that the art of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"module wiring"}]},{"block_type":"text","content":"is one of the most controversial and opinionated topics in Node.js. There are many schools of thought influencing this area, but none of them can be considered to possess the undisputed truth. Every approach, in fact, has its pros and cons and they often end up mixed together in the same application, adapted, customized, or used in disguise under other names."}]},{"block_type":"element","block":"k5zy5bpj","search_text":"In this chapter, we're going to analyze the various approaches for wiring modules and highlight their strengths and weaknesses so that we can rationally choose and mix them together depending on the balance between simplicity, reusability, and extensibility that we want to obtain. In particular, we're going to present the most important patterns related to this topic, which are as follows:","text_count":392,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we're going to analyze the various approaches for wiring modules and highlight their strengths and weaknesses so that we can rationally choose and mix them together depending on the balance between simplicity, reusability, and extensibility that we want to obtain. In particular, we're going to present the most important patterns related to this topic, which are as follows:"}]},{"block_type":"element","block":"k5zy5bpk","search_text":"Hardcoded dependency Dependency Injection Service locator Dependency Injection containers ","text_count":90,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Hardcoded dependency"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Dependency Injection"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Service locator"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Dependency Injection containers"}]}]},{"block_type":"element","block":"k5zy5bpl","search_text":"We will then explore a closely related problem, namely, how to wire plugins. This can be considered a specialization of module wiring and it mostly presents the same traits, but the context of its application is slightly different and presents its own challenges, especially when a plugin is distributed as a separate Node.js package. We will learn the main techniques to create a plugin-capable architecture and we will then focus on how to integrate these plugins into the flow of the main application.","text_count":504,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will then explore a closely related problem, namely, how to wire plugins. This can be considered a specialization of module wiring and it mostly presents the same traits, but the context of its application is slightly different and presents its own challenges, especially when a plugin is distributed as a separate Node.js package. We will learn the main techniques to create a plugin-capable architecture and we will then focus on how to integrate these plugins into the flow of the main application."}]},{"block_type":"element","block":"k5zy5bpm","search_text":"At the end of this chapter, the obscure art of Node.js module wiring should not be a mystery to us anymore.","text_count":107,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At the end of this chapter, the obscure art of Node.js module wiring should not be a mystery to us anymore."}]},{"block_type":"element","block":"k5zy5bpn","search_text":"Modules and dependencies","text_count":24,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Modules and dependencies"}]},{"block_type":"element","block":"k5zy5bpo","search_text":"Every modern application is the result of the aggregation of several components and, as the application grows, the way we connect these components becomes a win or lose factor. It's not only a problem related to technical aspects such as extensibility, but it's also a concern with the way we perceive the system. A tangled dependency graph is a liability and it adds to the technical debt of the project; in such a situation, any change in the code aimed to either modify or extend its functionality can result in tremendous effort.","text_count":533,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Every modern application is the result of the aggregation of several components and, as the application grows, the way we connect these components becomes a win or lose factor. It's not only a problem related to technical aspects such as extensibility, but it's also a concern with the way we perceive the system. A tangled"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"dependency graph"}]},{"block_type":"text","content":"is a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"liability"}]},{"block_type":"text","content":"and it adds to the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"technical debt"}]},{"block_type":"text","content":"of the project; in such a situation, any change in the code aimed to either modify or extend its functionality can result in tremendous effort."}]},{"block_type":"element","block":"k5zy5bpp","search_text":"In the worst case, the components are so tightly connected together that it becomes impossible to add or change anything without refactoring or even completely rewriting entire parts of the application. This, of course, does not mean that we have to over-engineer our design starting from the very first module, but surely finding a good balance from the very beginning can make a huge difference.","text_count":397,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the worst case, the components are so tightly connected together that it becomes impossible to add or change anything without refactoring or even completely rewriting entire parts of the application. This, of course, does not mean that we have to over-engineer our design starting from the very first module, but surely finding a good balance from the very beginning can make a huge difference."}]},{"block_type":"element","block":"k5zy5bpq","search_text":"Node.js provides a great tool for organizing and wiring the components of an application together: it's the CommonJS module system. However, the module system alone is not a guarantee of success; if on the one hand, it adds a convenient level of indirection between the client module and the dependency, then on the other, it might introduce a tighter coupling if not used properly. In this section, we will discuss some fundamental aspects of dependency wiring in Node.js.","text_count":473,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Node.js provides a great tool for organizing and wiring the components of an application together: it's the CommonJS module system. However, the module system alone is not a guarantee of success; if on the one hand, it adds a convenient"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"level of indirection"}]},{"block_type":"text","content":"between the client module and the dependency, then on the other, it might introduce a tighter"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"coupling"}]},{"block_type":"text","content":"if not used properly. In this section, we will discuss some fundamental aspects of dependency wiring in Node.js."}]},{"block_type":"element","block":"k5zy5bpr","search_text":"The most common dependency in Node.js","text_count":37,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The most common dependency in Node.js"}]},{"block_type":"element","block":"k5zy5bps","search_text":"In software architecture, we can consider any entity, state, or data format which influences the behavior or structure of a component as a dependency . For example, a component might use the services offered by another component, rely on a particular global state of the system, or implement a specific communication protocol in order to exchange information with other components, and so on. The concept of dependency is very broad and sometimes hard to evaluate.","text_count":464,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In software architecture, we can consider any entity, state, or data format which influences the behavior or structure of a component as a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"dependency"}]},{"block_type":"text","content":". For example, a component might use the services offered by another component, rely on a particular global state of the system, or implement a specific communication protocol in order to exchange information with other components, and so on. The concept of dependency is very broad and sometimes hard to evaluate."}]},{"block_type":"element","block":"k5zy5bpt","search_text":"In Node.js, though, we can immediately identify one essential type of dependency, which is the most common and easy to identify; of course, we are talking about the dependency between modules . Modules are the fundamental mechanism at our disposal to organize and structure our code; it's unreasonable to build a large application without relying on the module system at all. If used properly to group the various elements of an application, it can bring a lot of advantages. In fact, the properties of a module can be summed up as follows:","text_count":540,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Node.js, though, we can immediately identify one essential type of dependency, which is the most common and easy to identify; of course, we are talking about the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"dependency between modules"}]},{"block_type":"text","content":". Modules are the fundamental mechanism at our disposal to organize and structure our code; it's unreasonable to build a large application without relying on the module system at all. If used properly to group the various elements of an application, it can bring a lot of advantages. In fact, the properties of a module can be summed up as follows:"}]},{"block_type":"element","block":"k5zy5bpu","search_text":"A module is more readable and understandable because (ideally) it's more focused Being represented as a separate file, a module is easier to identify A module can be more easily reused across different applications ","text_count":215,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A module is more readable and understandable because (ideally) it's more focused"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Being represented as a separate file, a module is easier to identify"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A module can be more easily reused across different applications"}]}]},{"block_type":"element","block":"k5zy5bpv","search_text":"A module represents the perfect level of granularity for performing information hiding and offers an effective mechanism to expose only the public interface of a component (using module.exports ).","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A module represents the perfect level of granularity for performing"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"information hiding"}]},{"block_type":"text","content":"and offers an effective mechanism to expose only the public interface of a component (using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5bpw","search_text":"However, simply spreading the functionality of an application or a library across different modules is not enough for a successful design—it has to be done right. One of the fallacies is ending up in a situation where the relationship between our modules becomes so strong we create a unique monolithic entity, where removing or replacing a module would reverberate across most of the architecture. We are immediately able to recognize that the way we organize our code into modules and the way we connect them together play a strategic role. And, as with any problem in software design, it's a matter of finding the right balance between different measures.","text_count":658,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, simply spreading the functionality of an application or a library across different modules is not enough for a successful design&mdash;it has to be done right. One of the fallacies is ending up in a situation where the relationship between our modules becomes so strong we create a unique monolithic entity, where removing or replacing a module would reverberate across most of the architecture. We are immediately able to recognize that the way we organize our code into modules and the way we connect them together play a strategic role. And, as with any problem in software design, it's a matter of finding the right balance between different measures."}]},{"block_type":"element","block":"k5zy5bpx","search_text":"Cohesion and coupling","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Cohesion and coupling"}]},{"block_type":"element","block":"k5zy5bpy","search_text":"The two most important properties to balance when building modules are cohesion and coupling . They can be applied to any type of a component or subsystem in software architecture, so we can use them as guidelines when building Node.js modules as well. These two properties can be defined as follows:","text_count":300,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The two most important properties to balance when building modules are"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"cohesion"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"coupling"}]},{"block_type":"text","content":". They can be applied to any type of a component or subsystem in software architecture, so we can use them as guidelines when building Node.js modules as well. These two properties can be defined as follows:"}]},{"block_type":"element","block":"k5zy5bpz","search_text":"Cohesion : This is a measure of the correlation between the functionalities of a component. For example, a module that does only one thing , where all its parts contribute to that one single task has a high cohesion . A module that contains functions to save any type of object into a database— saveProduct() , saveInvoice() , saveUser() , and so on has a low cohesion . Coupling : This measures how much a component is dependent on the other components of a system. For example, a module is tightly coupled to another module when it directly reads or modifies the data of the other module. Also, two modules that interact via a global or shared state are tightly coupled. On the other hand, two modules that communicate only via the passing of parameters are loosely coupled . ","text_count":778,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cohesion"}]},{"block_type":"text","content":": This is a measure of the correlation between the functionalities of a component. For example, a module that does"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"only one thing"}]},{"block_type":"text","content":", where all its parts contribute to that one single task has a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"high cohesion"}]},{"block_type":"text","content":". A module that contains functions to save any type of object into a database&mdash;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"saveProduct()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"saveInvoice()"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"saveUser()"}]},{"block_type":"text","content":", and so on has a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"low cohesion"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Coupling"}]},{"block_type":"text","content":": This measures how much a component is dependent on the other components of a system. For example, a module is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"tightly coupled"}]},{"block_type":"text","content":"to another module when it directly reads or modifies the data of the other module. Also, two modules that interact via a global or shared state are tightly coupled. On the other hand, two modules that communicate only via the passing of parameters are"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"loosely coupled"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5bq0","search_text":"The desirable scenario is to have a high cohesion and a loose coupling, which usually results in more understandable, reusable, and extensible modules.","text_count":151,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The desirable scenario is to have a high cohesion and a loose coupling, which usually results in more understandable, reusable, and extensible modules."}]},{"block_type":"element","block":"k5zy5bq1","search_text":"Stateful modules","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Stateful modules"}]},{"block_type":"element","block":"k5zy5bq2","search_text":"In JavaScript, everything is an object. We don't have abstract concepts such as pure interfaces or classes; its dynamic typing already provides a natural mechanism to decouple the interface (or policy ) from the implementation (or detail ). That's one of the reasons why some of the design patterns that we have seen in Chapter 6, Design Patterns , looked so different and simplified compared to their traditional implementation.","text_count":429,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In JavaScript, everything is an object. We don't have abstract concepts such as pure interfaces or classes; its dynamic typing already provides a natural mechanism to decouple the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"interface"}]},{"block_type":"text","content":"(or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"policy"}]},{"block_type":"text","content":") from the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"implementation"}]},{"block_type":"text","content":"(or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"detail"}]},{"block_type":"text","content":"). That's one of the reasons why some of the design patterns that we have seen in Chapter 6,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Design Patterns"}]},{"block_type":"text","content":", looked so different and simplified compared to their traditional implementation."}]},{"block_type":"element","block":"k5zy5bq3","search_text":"In JavaScript, we have minimal problems in separating interfaces from implementations; however, by simply using the Node.js module system, we are already introducing a hardcoded relationship with one particular implementation. Under normal conditions, there is nothing wrong with this, but if we use require() to load a module that exports a stateful instance, such as a db handle, an HTTP server instance, the instance of a service, or in general any object which is not stateless, we are actually referencing something very similar to a Singleton, thus inheriting its pros and cons, with the addition of some caveats.","text_count":619,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In JavaScript, we have minimal problems in separating interfaces from implementations; however, by simply using the Node.js module system, we are already introducing a hardcoded relationship with one particular implementation. Under normal conditions, there is nothing wrong with this, but if we use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"to load a module that exports a stateful instance, such as a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"handle, an HTTP server instance, the instance of a service, or in general any object which is not stateless, we are actually referencing something very similar to a Singleton, thus inheriting its pros and cons, with the addition of some caveats."}]},{"block_type":"element","block":"k5zy5bq4","search_text":"The Singleton pattern in Node.js","text_count":32,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The Singleton pattern in Node.js"}]},{"block_type":"element","block":"k5zy5bq5","search_text":"A lot of people new to Node.js get confused about how to implement the Singleton pattern correctly, most of the time with the simple intent of sharing an instance across the various modules of an application. However, the answer in Node.js is easier than what we might think; simply exporting an instance using module.exports is already enough to obtain something very similar to the Singleton pattern. Consider, for example, the following line of code:","text_count":453,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A lot of people new to Node.js get confused about how to implement the Singleton pattern correctly, most of the time with the simple intent of sharing an instance across the various modules of an application. However, the answer in Node.js is easier than what we might think; simply exporting an instance using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"is already enough to obtain something very similar to the Singleton pattern. Consider, for example, the following line of code:"}]},{"block_type":"element","block":"k5zy5bq6","search_text":"//'db.js' module module.exports = new Database('my-app-db'); ","text_count":61,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//'db.js' module \nmodule.exports = new Database('my-app-db');"}]}]},{"block_type":"element","block":"k5zy5bq7","search_text":"By simply exporting a new instance of our database, we can already assume that within the current package (which can easily be the entire code of our application), we are going to have only one instance of the db module. This is possible because, as we know, Node.js will cache the module after the first invocation of require() , making sure to not execute it again at any subsequent invocation, returning instead the cached instance. For example, we can easily obtain a shared instance of the db module that we defined earlier, with the following line of code:","text_count":562,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By simply exporting a new instance of our database, we can already assume that within the current package (which can easily be the entire code of our application), we are going to have only one instance of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module. This is possible because, as we know, Node.js will cache the module after the first invocation of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":", making sure to not execute it again at any subsequent invocation, returning instead the cached instance. For example, we can easily obtain a shared instance of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module that we defined earlier, with the following line of code:"}]},{"block_type":"element","block":"k5zy5bq8","search_text":"const db = require('./db'); ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const db = require('./db');"}]}]},{"block_type":"element","block":"k5zy5bq9","search_text":"But there is a caveat; the module is cached using its full path as lookup key, therefore it is guaranteed to be a Singleton only within the current package. We saw in Chapter 2, Node.js Essential Patterns , that each package might have its own set of private dependencies inside its node_modules directory, which might result in multiple instances of the same package and therefore of the same module, with the result that our Singleton might not be single anymore. Consider, for example, the case where the db module is wrapped into a package named mydb . The following lines of code will be in its package.json file:","text_count":618,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But there is a caveat; the module is cached using its full path as lookup key, therefore it is guaranteed to be a Singleton only within the current package. We saw in Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Essential Patterns"}]},{"block_type":"text","content":", that each package might have its own set of private dependencies inside its"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules"}]},{"block_type":"text","content":"directory, which might result in multiple instances of the same package and therefore of the same module, with the result that our Singleton might not be"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"single"}]},{"block_type":"text","content":"anymore. Consider, for example, the case where the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module is wrapped into a package named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mydb"}]},{"block_type":"text","content":". The following lines of code will be in its"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"package.json"}]},{"block_type":"text","content":"file:"}]},{"block_type":"element","block":"k5zy5bqa","search_text":"{ \"name\": \"mydb\", \"main\": \"db.js\" } ","text_count":36,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"{ \n  \"name\": \"mydb\", \n  \"main\": \"db.js\" \n}"}]}]},{"block_type":"element","block":"k5zy5bqb","search_text":"Now consider the following package dependency tree:","text_count":51,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now consider the following package dependency tree:"}]},{"block_type":"element","block":"k5zy5bqc","search_text":"app/ `-- node_modules |-- packageA | `-- node_modules | `-- mydb `-- packageB `-- node_modules `-- mydb ","text_count":104,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"app/ \n`-- node_modules \n    |-- packageA \n    |  `-- node_modules \n    |      `-- mydb \n    `-- packageB \n        `-- node_modules \n            `-- mydb"}]}]},{"block_type":"element","block":"k5zy5bqd","search_text":"Both packageA and packageB have a dependency on the mydb package; in turn, the app package, which is our main application, depends on packageA and packageB . The scenario we just described will break the assumption about the uniqueness of the database instance; in fact, both packageA and packageB will load the database instance using a command such as the following:","text_count":368,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Both"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"packageA"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"packageB"}]},{"block_type":"text","content":"have a dependency on the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mydb"}]},{"block_type":"text","content":"package; in turn, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"package, which is our main application, depends on"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"packageA"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"packageB"}]},{"block_type":"text","content":". The scenario we just described will break the assumption about the uniqueness of the database instance; in fact, both"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"packageA"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"packageB"}]},{"block_type":"text","content":"will load the database instance using a command such as the following:"}]},{"block_type":"element","block":"k5zy5bqe","search_text":"const db = require('mydb'); ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const db = require('mydb');"}]}]},{"block_type":"element","block":"k5zy5bqf","search_text":"However, packageA and packageB will actually load two different instances of our pretending Singleton because the mydb module will resolve to a different directory depending on the package it is required from.","text_count":209,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"packageA"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"packageB"}]},{"block_type":"text","content":"will actually load two different instances of our pretending Singleton because the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mydb"}]},{"block_type":"text","content":"module will resolve to a different directory depending on the package it is required from."}]},{"block_type":"element","block":"k5zy5bqg","search_text":"At this point, we can easily say that the Singleton pattern, as described in the literature, does not exist in Node.js, unless we don't use a real global variable to store it, something such as the following:","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we can easily say that the Singleton pattern, as described in the literature, does not exist in Node.js, unless we don't use a real"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"global variable"}]},{"block_type":"text","content":"to store it, something such as the following:"}]},{"block_type":"element","block":"k5zy5bqh","search_text":"global.db = new Database('my-app-db'); ","text_count":39,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"global.db = new Database('my-app-db');"}]}]},{"block_type":"element","block":"k5zy5bqi","search_text":"This would guarantee that the instance will be the only one and shared across the entire application, not just the same package. However, this is a practice to avoid at all costs; most of the time, we don't really need a pure Singleton, and anyway, as we will see later, there are other patterns that we can use to share an instance across the different packages.","text_count":363,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This would guarantee that the instance will be the only one and shared across the entire application, not just the same package. However, this is a practice to avoid at all costs; most of the time, we don't really need a pure Singleton, and anyway, as we will see later, there are other patterns that we can use to share an instance across the different packages."}]},{"block_type":"element","block":"k5zy5bqj","search_text":"Note Throughout this book, for simplicity, we will use the term Singleton to describe a stateful object exported by a module, even if this doesn't represent a real Singleton in the strict definition of the term. We can surely say, though, that it shares the same practical intent with the original pattern: to easily share a state across different components. ","text_count":360,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Throughout this book, for simplicity, we will use the term Singleton to describe a stateful object exported by a module, even if this doesn't represent a real Singleton in the strict definition of the term. We can surely say, though, that it shares the same practical intent with the original pattern: to easily share a state across different components."}]}]},{"block_type":"element","block":"k5zy5bqk","search_text":"Patterns for wiring modules","text_count":27,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Patterns for wiring modules"}]},{"block_type":"element","block":"k5zy5bql","search_text":"Now that we have discussed some basic theory around dependencies and coupling, we are ready to dive into some more practical concepts. In this section, in fact, we are going to present the main module wiring patterns. Our focus will be mainly pointed towards the wiring of stateful instances, which are, without any doubt, the most important type of dependencies in an application.","text_count":381,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have discussed some basic theory around dependencies and coupling, we are ready to dive into some more practical concepts. In this section, in fact, we are going to present the main module wiring patterns. Our focus will be mainly pointed towards the wiring of stateful instances, which are, without any doubt, the most important type of dependencies in an application."}]},{"block_type":"element","block":"k5zy5bqm","search_text":"Hardcoded dependency","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Hardcoded dependency"}]},{"block_type":"element","block":"k5zy5bqn","search_text":"We start our analysis by looking at the most conventional relationship between two modules, which is the hardcoded dependency . In Node.js, this is obtained when a client module explicitly loads another module using require() . As we will see in this section, this way of establishing module dependencies is simple and effective, but we have to pay additional attention to hardcoding dependencies with stateful instances, as this would limit the reusability of our modules.","text_count":473,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We start our analysis by looking at the most"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"conventional"}]},{"block_type":"text","content":"relationship between two modules, which is the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"hardcoded dependency"}]},{"block_type":"text","content":". In Node.js, this is obtained when a client module explicitly loads another module using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":". As we will see in this section, this way of establishing module dependencies is simple and effective, but we have to pay additional attention to hardcoding dependencies with stateful instances, as this would limit the reusability of our modules."}]},{"block_type":"element","block":"k5zy5bqo","search_text":"Building an authentication server using hardcoded dependencies","text_count":62,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Building an authentication server using hardcoded dependencies"}]},{"block_type":"element","block":"k5zy5bqp","search_text":"Let's start our analysis by looking at the structure represented by the following figure:","text_count":89,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start our analysis by looking at the structure represented by the following figure:"}]},{"block_type":"element","block":"k5zy5bqq","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000012.jpg","alt":"Building an authentication server using hardcoded dependencies","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bqr","search_text":"The preceding figure shows a typical example of layered architecture; it describes the structure of a simple authentication system. AuthController accepts the input from the client, extracts the login information from the request, and performs some preliminary validation. It then relies on AuthService to check whether the provided credentials match with the information stored in the database; this is done by executing some specific queries using the db module handle, as a means to communicate with the database. The way these three components are connected together will determine their level of reusability, testability, and maintainability.","text_count":647,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding figure shows a typical example of layered architecture; it describes the structure of a simple authentication system."},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"AuthController"}]},{"block_type":"text","content":"accepts the input from the client, extracts the login information from the request, and performs some preliminary validation. It then relies on"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"AuthService"}]},{"block_type":"text","content":"to check whether the provided credentials match with the information stored in the database; this is done by executing some specific queries using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module handle, as a means to communicate with the database. The way these three components are connected together will determine their level of reusability, testability, and maintainability."}]},{"block_type":"element","block":"k5zy5bqs","search_text":"The most natural way to wire these components together is by requiring the db module from AuthService and then requiring AuthService from AuthController . This is the hardcoded dependency that we are talking about.","text_count":214,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most natural way to wire these components together is by requiring the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"AuthService"}]},{"block_type":"text","content":"and then requiring"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"AuthService"}]},{"block_type":"text","content":"from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"AuthController"}]},{"block_type":"text","content":". This is the hardcoded dependency that we are talking about."}]},{"block_type":"element","block":"k5zy5bqt","search_text":"Let's demonstrate this in practice by actually implementing the system that we just described. Let's then design a simple authentication server , which exposes the following two HTTP APIs:","text_count":188,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's demonstrate this in practice by actually implementing the system that we just described. Let's then design a simple"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"authentication server"}]},{"block_type":"text","content":", which exposes the following two HTTP APIs:"}]},{"block_type":"element","block":"k5zy5bqu","search_text":"POST '/login' : This receives a JSON object that contains a username and password pair to authenticate. On success, it returns a JSON Web Token ( JWT ), which can be used in subsequent requests to verify the identity of the user. ","text_count":230,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"POST '/login'"}]},{"block_type":"text","content":": This receives a JSON object that contains a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"username"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"password"}]},{"block_type":"text","content":"pair to authenticate. On success, it returns a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"JSON Web Token"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"JWT"}]},{"block_type":"text","content":"), which can be used in subsequent requests to verify the identity of the user."}]}]},{"block_type":"element","block":"k5zy5bqv","search_text":"Note JSON Web Token is a format for representing and sharing claims between parties. Its popularity is growing with the explosion of Single Page Applications and Cross-origin resource sharing ( CORS ) as a more flexible alternative to cookie-based authentication. To know more about JWT, you can refer to its specification (currently in draft) at http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html ","text_count":413,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"JSON Web Token is a format for representing and sharing"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"claims"}]},{"block_type":"text","content":"between parties. Its popularity is growing with the explosion of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Single Page Applications"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cross-origin resource sharing"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"CORS"}]},{"block_type":"text","content":") as a more flexible alternative to cookie-based authentication. To know more about JWT, you can refer to its specification (currently in draft) at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html"},"children":[{"block_type":"text","content":"http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html"}]}]}]},{"block_type":"element","block":"k5zy5bqw","search_text":"GET '/checkToken' : This reads a token from a GET query parameter and verifies its validity. ","text_count":93,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"GET '/checkToken'"}]},{"block_type":"text","content":": This reads a token from a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"GET"}]},{"block_type":"text","content":"query parameter and verifies its validity."}]}]},{"block_type":"element","block":"k5zy5bqx","search_text":"For this example, we are going to use several technologies; some of them are not new to us. In particular, we are going to use express ( https://npmjs.org/package/express ) to implement the Web API and levelup ( https://npmjs.org/package/levelup ) to store the user's data.","text_count":273,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For this example, we are going to use several technologies; some of them are not new to us. In particular, we are going to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"express"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/express"},"children":[{"block_type":"text","content":"https://npmjs.org/package/express"}]},{"block_type":"text","content":") to implement the Web API and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"levelup"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/levelup"},"children":[{"block_type":"text","content":"https://npmjs.org/package/levelup"}]},{"block_type":"text","content":") to store the user's data."}]},{"block_type":"element","block":"k5zy5bqy","search_text":"The db module","text_count":13,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The db module"}]},{"block_type":"element","block":"k5zy5bqz","search_text":"Let's start by building our application from the bottom up; the very first thing we need is a module that exposes a levelUp database instance. Let's do this by creating a new file named lib/db.js and including the following content:","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start by building our application from the bottom up; the very first thing we need is a module that exposes a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"levelUp"}]},{"block_type":"text","content":"database instance. Let's do this by creating a new file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/db.js"}]},{"block_type":"text","content":"and including the following content:"}]},{"block_type":"element","block":"k5zy5br0","search_text":"const level = require('level'); const sublevel = require('level-sublevel'); module.exports = sublevel( level('example-db', {valueEncoding: 'json'}) ); ","text_count":151,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const level = require('level'); \nconst sublevel = require('level-sublevel'); \n \nmodule.exports = sublevel( \n  level('example-db', {valueEncoding: 'json'}) \n);"}]}]},{"block_type":"element","block":"k5zy5br1","search_text":"The preceding module simply creates a connection to a LevelDB database stored in the ./example-db directory, then it decorates the instance using the sublevel plugin ( https://npmjs.org/package/level-sublevel ), which adds the support to create and query separate sections of the database (it can be compared to a SQL table or MongoDB collection). The object exported by the module is the database handle itself, which is a stateful instance; therefore, we are creating a singleton.","text_count":482,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding module simply creates a connection to a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"LevelDB"}]},{"block_type":"text","content":"database stored in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"./example-db"}]},{"block_type":"text","content":"directory, then it decorates the instance using the sublevel plugin ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/level-sublevel"},"children":[{"block_type":"text","content":"https://npmjs.org/package/level-sublevel"}]},{"block_type":"text","content":"), which adds the support to create and query separate sections of the database (it can be compared to a SQL table or MongoDB collection). The object exported by the module is the database handle itself, which is a stateful instance; therefore, we are creating a singleton."}]},{"block_type":"element","block":"k5zy5br2","search_text":"The authService module","text_count":22,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The authService module"}]},{"block_type":"element","block":"k5zy5br3","search_text":"Now that we have the db singleton, we can use it to implement the lib/authService.js module, which is the component responsible for checking a user's credentials against the information in the database. The code is as follows (only the relevant parts are shown):","text_count":262,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"singleton, we can use it to implement the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/authService.js"}]},{"block_type":"text","content":"module, which is the component responsible for checking a user's credentials against the information in the database. The code is as follows (only the relevant parts are shown):"}]},{"block_type":"element","block":"k5zy5br4","search_text":"// ... const db = require('./db'); const users = db.sublevel('users'); const tokenSecret = 'SHHH!'; exports.login = (username, password, callback) => { users.get(username, function(err, user) { // ... }); }; exports.checkToken = (token, callback) => { // ... users.get(userData.username, function(err, user) { // ... }); }; ","text_count":324,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \nconst db = require('./db'); \nconst users = db.sublevel('users'); \n \nconst tokenSecret = 'SHHH!'; \n \nexports.login = (username, password, callback) =&gt; { \n  users.get(username, function(err, user) { \n    // ... \n  }); \n}; \n \nexports.checkToken = (token, callback) =&gt; { \n  // ... \n  users.get(userData.username, function(err, user) { \n    // ... \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5br5","search_text":"The authService module implements the login() service, which is responsible for checking a username/password pair against the information in the database, and the checkToken() service, which takes in a token and verifies its validity.","text_count":234,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module implements the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"login()"}]},{"block_type":"text","content":"service, which is responsible for checking a username/password pair against the information in the database, and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkToken()"}]},{"block_type":"text","content":"service, which takes in a token and verifies its validity."}]},{"block_type":"element","block":"k5zy5br6","search_text":"The preceding code also shows the first example of a hardcoded dependency with a stateful module. We are talking about the db module, which we load by simply requiring it. The resulting db variable contains an already initialized database handle that we can use straight away to perform our queries.","text_count":299,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code also shows the first example of a hardcoded dependency with a stateful module. We are talking about the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module, which we load by simply requiring it. The resulting"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"variable contains an already initialized database handle that we can use straight away to perform our queries."}]},{"block_type":"element","block":"k5zy5br7","search_text":"At this point, we can see that all the code that we created for the authService module does not really necessitate one particular instance of the db module—any instance will simply work. However, we hardcoded the dependency to one particular db instance, and this means that we will be unable to reuse authService in combination with another database instance without touching its code.","text_count":386,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we can see that all the code that we created for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module does not really necessitate one particular instance of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module&mdash;any instance will simply work. However, we hardcoded the dependency to one particular"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"instance, and this means that we will be unable to reuse"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"in combination with another database instance without touching its code."}]},{"block_type":"element","block":"k5zy5br8","search_text":"The authController module","text_count":25,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The authController module"}]},{"block_type":"element","block":"k5zy5br9","search_text":"Continuing to go up in the layers of the application, we are now going to see what the lib/authController.js module looks like. This module is responsible for handling the HTTP requests, and it's essentially a collection of the Express routes; the module's code is the following:","text_count":279,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Continuing to go up in the layers of the application, we are now going to see what the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/authController.js"}]},{"block_type":"text","content":"module looks like. This module is responsible for handling the HTTP requests, and it's essentially a collection of the Express routes; the module's code is the following:"}]},{"block_type":"element","block":"k5zy5bra","search_text":"const authService = require('./authService'); exports.login = (req, res, next) => { authService.login(req.body.username, req.body.password, (err, result) => { // ... } ); }; exports.checkToken = (req, res, next) => { authService.checkToken(req.query.token, (err, result) => { // ... } ); }; ","text_count":291,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const authService = require('./authService'); \n \nexports.login = (req, res, next) =&gt; { \n  authService.login(req.body.username, req.body.password, \n    (err, result) =&gt; { \n      // ... \n    } \n  ); \n}; \n \nexports.checkToken = (req, res, next) =&gt; { \n  authService.checkToken(req.query.token, \n    (err, result) =&gt; { \n      // ... \n    } \n  ); \n};"}]}]},{"block_type":"element","block":"k5zy5brb","search_text":"The authController module implements two Express routes: one for performing the login and returning the corresponding authentication token ( login() ) and another for checking the validity of the token ( checkToken() ). Both the routes delegate most of their logic to authService , so their only job is to deal with the HTTP request and response.","text_count":346,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authController"}]},{"block_type":"text","content":"module implements two Express routes: one for performing the login and returning the corresponding authentication token ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"login()"}]},{"block_type":"text","content":") and another for checking the validity of the token ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkToken()"}]},{"block_type":"text","content":"). Both the routes delegate most of their logic to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":", so their only job is to deal with the HTTP request and response."}]},{"block_type":"element","block":"k5zy5brc","search_text":"We can see that, in this case too, we are hardcoding the dependency with a stateful module: authService . Yes, the authService module is stateful by transitivity because it depends directly on the db module. With this, we should start to understand how a hardcoded dependency can easily propagate across the structure of the entire application: the authController module depends on the authService module, which in turn depends on the db module; transitively, this means that the authService module itself is indirectly linked to one particular db instance.","text_count":557,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can see that, in this case too, we are hardcoding the dependency with a stateful module:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":". Yes, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module is stateful by transitivity because it depends directly on the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module. With this, we should start to understand how a hardcoded dependency can easily propagate across the structure of the entire application: the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authController"}]},{"block_type":"text","content":"module depends on the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module, which in turn depends on the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module; transitively, this means that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module itself is indirectly linked to one particular"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"instance."}]},{"block_type":"element","block":"k5zy5brd","search_text":"The app module","text_count":14,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The app module"}]},{"block_type":"element","block":"k5zy5bre","search_text":"Finally, we can put all the pieces together by implementing the entry point of the application. Following the convention, we will place this logic in a module named app.js , sitting in the root of our project as follows:","text_count":220,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we can put all the pieces together by implementing the entry point of the application. Following the convention, we will place this logic in a module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":", sitting in the root of our project as follows:"}]},{"block_type":"element","block":"k5zy5brf","search_text":"const express = require('express'); const bodyParser = require('body-parser'); const errorHandler = require('errorhandler'); const http = require('http'); const authController = require('./lib/authController'); const app = module.exports = express(); app.use(bodyParser.json()); app.post('/login', authController.login); app.get('/checkToken', authController.checkToken); app.use(errorHandler()); http.createServer(app).listen(3000, () => { console.log('Express server started'); }); ","text_count":484,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const express = require('express'); \nconst bodyParser = require('body-parser'); \nconst errorHandler = require('errorhandler'); \nconst http = require('http'); \n \nconst authController = require('./lib/authController'); \n \nconst app = module.exports = express(); \napp.use(bodyParser.json()); \n \napp.post('/login', authController.login); \napp.get('/checkToken', authController.checkToken); \n\napp.use(errorHandler()); \nhttp.createServer(app).listen(3000, () =&gt; { \n  console.log('Express server started'); \n});"}]}]},{"block_type":"element","block":"k5zy5brg","search_text":"As we can see, our app module is really basic; it contains a simple Express server, which registers some middleware and the two routes exported by authController . Of course, the most important line of code for us is where we require authController to create a hardcoded dependency with its stateful instance.","text_count":309,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module is really basic; it contains a simple Express server, which registers some middleware and the two routes exported by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authController"}]},{"block_type":"text","content":". Of course, the most important line of code for us is where we require"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authController"}]},{"block_type":"text","content":"to create a hardcoded dependency with its stateful instance."}]},{"block_type":"element","block":"k5zy5brh","search_text":"Running the authentication server","text_count":33,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Running the authentication server"}]},{"block_type":"element","block":"k5zy5bri","search_text":"Before we can try the authentication server that we just implemented, we advise you to populate the database with some sample data using the populate_db.js script, which is provided in the code samples. After doing this, we can fire up the server by running the following command:","text_count":280,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Before we can try the authentication server that we just implemented, we advise you to populate the database with some sample data using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"populate_db.js"}]},{"block_type":"text","content":"script, which is provided in the code samples. After doing this, we can fire up the server by running the following command:"}]},{"block_type":"element","block":"k5zy5brj","search_text":"node app ","text_count":9,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app"}]}]},{"block_type":"element","block":"k5zy5brk","search_text":"We can then try to invoke the two web services that we created; we can use a REST client to do this or, alternatively, the good old curl command. For example, to execute a login, we can run the following command:","text_count":212,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can then try to invoke the two web services that we created; we can use a REST client to do this or, alternatively, the good old"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"curl"}]},{"block_type":"text","content":"command. For example, to execute a login, we can run the following command:"}]},{"block_type":"element","block":"k5zy5brl","search_text":"curl -X POST -d '{\"username\": \"alice\", \"password\":\"secret\"}' http://localhost:3000/login -H \"Content-Type: application/json\" ","text_count":125,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -X POST -d '{\"username\": \"alice\", \"password\":\"secret\"}' http://localhost:3000/login -H \"Content-Type: application/json\""}]}]},{"block_type":"element","block":"k5zy5brm","search_text":"The preceding command should return a token that we can use to test the /checkLogin web service (just replace <TOKEN HERE> in the following command):","text_count":149,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding command should return a token that we can use to test the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/checkLogin"}]},{"block_type":"text","content":"web service (just replace"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"&lt;TOKEN HERE&gt;"}]},{"block_type":"text","content":"in the following command):"}]},{"block_type":"element","block":"k5zy5brn","search_text":"curl -X GET -H \"Accept: application/json\" http://localhost:3000/checkToken?token=<TOKEN HERE> ","text_count":94,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -X GET -H \"Accept: application/json\" http://localhost:3000/checkToken?token=&lt;TOKEN HERE&gt;"}]}]},{"block_type":"element","block":"k5zy5bro","search_text":"The preceding command should return a string such as the following, which confirms that our server is working as expected:","text_count":122,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding command should return a string such as the following, which confirms that our server is working as expected:"}]},{"block_type":"element","block":"k5zy5brp","search_text":"{\"ok\":\"true\",\"user\":{\"username\":\"alice\"}} ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"{\"ok\":\"true\",\"user\":{\"username\":\"alice\"}}"}]}]},{"block_type":"element","block":"k5zy5brq","search_text":"Pros and cons of hardcoded dependencies","text_count":39,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Pros and cons of hardcoded dependencies"}]},{"block_type":"element","block":"k5zy5brr","search_text":"The sample we just implemented demonstrates the conventional way of wiring modules in Node.js, leveraging the full power of its module system to manage the dependencies between the various components of the application. We exported stateful instances from our modules, letting Node.js manage their life cycle, and then we required them directly from other parts of the application. The result is an immediately intuitive organization, easy to understand and debug, where each module initializes and wires itself without any external intervention.","text_count":546,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The sample we just implemented demonstrates the conventional way of wiring modules in Node.js, leveraging the full power of its module system to manage the dependencies between the various components of the application. We exported stateful instances from our modules, letting Node.js manage their life cycle, and then we required them directly from other parts of the application. The result is an immediately intuitive organization, easy to understand and debug, where each module initializes and wires itself without any external intervention."}]},{"block_type":"element","block":"k5zy5brs","search_text":"On the other hand, however, hardcoding the dependency on a stateful instance limits the possibility of wiring the module against other instances, which makes it less reusable and harder to unit test. For example, reusing authService in combination with another database instance would be close to impossible, as its dependency is hardcoded with one particular instance. Similarly, testing authService in isolation can be a difficult task because we cannot easily mock the database used by the module.","text_count":500,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other hand, however, hardcoding the dependency on a stateful instance limits the possibility of wiring the module against other instances, which makes it less reusable and harder to unit test. For example, reusing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"in combination with another database instance would be close to impossible, as its dependency is hardcoded with one particular instance. Similarly, testing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"in isolation can be a difficult task because we cannot easily mock the database used by the module."}]},{"block_type":"element","block":"k5zy5brt","search_text":"As a last consideration, it's important to see that most of the disadvantages of using hardcoded dependencies are associated with stateful instances. This means that if we use require() to load a stateless module, for example, a factory, constructor, or a set of stateless functions, we don't incur the same kind of problems. We will still have a tight coupling with a specific implementation, but in Node.js, this usually does not impact the reusability of a component, as it does not introduce a coupling with a particular state.","text_count":531,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a last consideration, it's important to see that most of the disadvantages of using hardcoded dependencies are associated with stateful instances. This means that if we use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"to load a stateless module, for example, a factory, constructor, or a set of stateless functions, we don't incur the same kind of problems. We will still have a tight coupling with a specific implementation, but in Node.js, this usually does not impact the reusability of a component, as it does not introduce a coupling with a particular state."}]},{"block_type":"element","block":"k5zy5bru","search_text":"Dependency Injection","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Dependency Injection"}]},{"block_type":"element","block":"k5zy5brv","search_text":"The Dependency Injection ( DI ) pattern is probably one of the most misunderstood concepts in software design. Many associate the term with frameworks and DI containers such as Spring (for Java and C#) or Pimple (for PHP), but in reality it is a much simpler concept. The main idea behind the Dependency Injection pattern is the dependencies of a component being provided as input by an external entity.","text_count":403,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Dependency Injection"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"DI"}]},{"block_type":"text","content":") pattern is probably one of the most misunderstood concepts in software design. Many associate the term with frameworks and&nbsp;DI containers such as Spring (for Java and C#) or Pimple (for PHP), but in reality it is a much simpler concept. The main idea behind the Dependency Injection pattern is the dependencies of a component being"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"provided as input"}]},{"block_type":"text","content":"by an external entity."}]},{"block_type":"element","block":"k5zy5brw","search_text":"Such an entity can be a client component or a global container , which centralizes the wiring of all the modules of the system. The main advantage of this approach is an improved decoupling, especially for modules depending on stateful instances. Using DI, each dependency, instead of being hardcoded into the module, is received from the outside. This means that the module can be configured to use any dependency, and therefore can be reused in different contexts.","text_count":466,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Such an entity can be a client component or a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"global"}]},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"container"}]},{"block_type":"text","content":", which centralizes the wiring of all the modules of the system. The main advantage of this approach is an improved decoupling, especially for modules depending on stateful instances. Using DI, each dependency, instead of being hardcoded into the module, is received from the outside. This means that the module can be configured to use any dependency, and therefore can be reused in different contexts."}]},{"block_type":"element","block":"k5zy5brx","search_text":"To demonstrate this pattern in practice, we are now going to refactor the authentication server that we built in the previous section, using DI to wire its modules.","text_count":164,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate this pattern in practice, we are now going to refactor the authentication server that we built in the previous section, using DI to wire its modules."}]},{"block_type":"element","block":"k5zy5bry","search_text":"Refactoring the authentication server to use DI","text_count":47,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Refactoring the authentication server to use DI"}]},{"block_type":"element","block":"k5zy5brz","search_text":"Refactoring our modules to use DI involves the use of a very simple recipe: instead of hardcoding the dependency to a stateful instance, we will instead create a factory, which takes a set of dependencies as arguments.","text_count":218,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Refactoring our modules to use DI involves the use of a very simple recipe: instead of hardcoding the dependency to a stateful instance, we will instead create a factory, which takes a set of dependencies as arguments."}]},{"block_type":"element","block":"k5zy5bs0","search_text":"Let's start immediately with this refactoring; let's work on the lib/db.js module, given as follows:","text_count":100,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start immediately with this refactoring; let's work on the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/db.js"}]},{"block_type":"text","content":"module, given as follows:"}]},{"block_type":"element","block":"k5zy5bs1","search_text":"const level = require('level'); const sublevel = require('level-sublevel'); module.exports = dbName => { return sublevel( level(dbName, {valueEncoding: 'json'}) ); }; ","text_count":167,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const level = require('level'); \nconst sublevel = require('level-sublevel'); \n \nmodule.exports = dbName =&gt; { \n  return sublevel( \n    level(dbName, {valueEncoding: 'json'}) \n  ); \n};"}]}]},{"block_type":"element","block":"k5zy5bs2","search_text":"The first step in our refactoring process is to transform the db module into a factory. The result is that we can now use it to create as many database instances as we want; this means that the entire module is now reusable and stateless.","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first step in our refactoring process is to transform the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module into a factory. The result is that we can now use it to create as many database instances as we want; this means that the entire module is now reusable and stateless."}]},{"block_type":"element","block":"k5zy5bs3","search_text":"Let's move on and implement the new version of the lib/authService.js module:","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's move on and implement the new version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/authService.js"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5bs4","search_text":"const jwt = require('jwt-simple'); const bcrypt = require('bcrypt'); module.exports = (db, tokenSecret) => { const users = db.sublevel('users'); const authService = {}; authService.login = (username, password, callback) => { //...same as in the previous version }; authService.checkToken = (token, callback) => { //...same as in the previous version }; return authService; }; ","text_count":376,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const jwt = require('jwt-simple'); \nconst bcrypt = require('bcrypt'); \n \nmodule.exports = (db, tokenSecret) =&gt; { \n  const users = db.sublevel('users'); \n  const authService = {}; \n \n  authService.login = (username, password, callback) =&gt; { \n    //...same as in the previous version \n  }; \n \n  authService.checkToken = (token, callback) =&gt; { \n    //...same as in the previous version \n  }; \n \n  return authService; \n};"}]}]},{"block_type":"element","block":"k5zy5bs5","search_text":"Also, the authService module is now stateless; it doesn't export any particular instance anymore, just a simple factory. The most important detail, though, is that we made the db dependency injectable as an argument of the factory function, removing what was previously a hardcoded dependency. This simple change enables us to create a new authService module by wiring it to any database instance.","text_count":397,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module is now stateless; it doesn't export any particular instance anymore, just a simple factory. The most important detail, though, is that we made the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"dependency"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"injectable"}]},{"block_type":"text","content":"as an argument of the factory function, removing what was previously a hardcoded dependency. This simple change enables us to create a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module by wiring it to any database instance."}]},{"block_type":"element","block":"k5zy5bs6","search_text":"We can refactor the lib/authController.js module in a similar way as follows:","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can refactor the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/authController.js"}]},{"block_type":"text","content":"module in a similar way as follows:"}]},{"block_type":"element","block":"k5zy5bs7","search_text":"module.exports = (authService) => { const authController = {}; authController.login = (req, res, next) => { //...same as in the previous version }; authController.checkToken = (req, res, next) => { //...same as in the previous version }; return authController; }; ","text_count":264,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = (authService) =&gt; { \n  const authController = {}; \n \n  authController.login = (req, res, next) =&gt; { \n    //...same as in the previous version \n  }; \n \n  authController.checkToken = (req, res, next) =&gt; { \n    //...same as in the previous version \n  }; \n \n  return authController; \n};"}]}]},{"block_type":"element","block":"k5zy5bs8","search_text":"The authController module does not have any hardcoded dependency at all, not even stateless! The only dependency, the authService module, is provided as input to the factory at the moment of its invocation.","text_count":206,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authController"}]},{"block_type":"text","content":"module does not have any hardcoded dependency at all, not even stateless! The only dependency, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module, is provided as input to the factory at the moment of its invocation."}]},{"block_type":"element","block":"k5zy5bs9","search_text":"Okay, now it's time to see where all these modules are actually created and wired together; the answer lies in the app.js module, which represents the topmost layer in our application. Its code is the following:","text_count":211,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Okay, now it's time to see where all these modules are actually created and wired together; the answer lies in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module, which represents the topmost layer in our application. Its code is the following:"}]},{"block_type":"element","block":"k5zy5bsa","search_text":"// ... const dbFactory = require('./lib/db'); //[1] const authServiceFactory = require('./lib/authService'); const authControllerFactory = require('./lib/authController'); const db = dbFactory('example-db'); //[2] const authService = authServiceFactory(db, 'SHHH!'); const authController = authControllerFactory(authService); app.post('/login', authController.login); //[3] app.get('/checkToken', authController.checkToken); // ... ","text_count":432,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \nconst dbFactory = require('./lib/db');                        //[1] \nconst authServiceFactory = require('./lib/authService'); \nconst authControllerFactory = require('./lib/authController'); \n \nconst db = dbFactory('example-db');                           //[2] \nconst authService = authServiceFactory(db, 'SHHH!'); \nconst authController = authControllerFactory(authService); \n \napp.post('/login', authController.login);                     //[3] \napp.get('/checkToken', authController.checkToken); \n// ..."}]}]},{"block_type":"element","block":"k5zy5bsb","search_text":"The previous code can be summed up as follows:","text_count":46,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The previous code can be summed up as follows:"}]},{"block_type":"element","block":"k5zy5bsc","search_text":"Firstly, we load the factories of our services; at this point, they are still stateless objects. Next, we instantiate each service by providing the dependencies it requires. This is the phase where all the modules are created and wired. Finally, we register the routes of the authController module with the Express server as we would normally do. ","text_count":347,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Firstly, we load the factories of our services; at this point, they are still stateless objects."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Next, we instantiate each service by providing the dependencies it requires. This is the phase where all the modules are created and wired."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, we register the routes of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authController"}]},{"block_type":"text","content":"module with the Express server as we would normally do."}]}]},{"block_type":"element","block":"k5zy5bsd","search_text":"Our authentication server is now wired using DI and ready to be used again.","text_count":75,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our authentication server is now wired using DI and ready to be used again."}]},{"block_type":"element","block":"k5zy5bse","search_text":"The different types of DI","text_count":25,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The different types of DI"}]},{"block_type":"element","block":"k5zy5bsf","search_text":"The example we just presented demonstrated only one type of DI ( factory injection ), but there are a couple more worth mentioning:","text_count":131,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The example we just presented demonstrated only one type of DI ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"factory injection"}]},{"block_type":"text","content":"), but there are a couple more worth mentioning:"}]},{"block_type":"element","block":"k5zy5bsg","search_text":"Constructor injection : In this type of DI, the dependencies are passed to a constructor at the moment of its creation; one possible example can be the following: ","text_count":163,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Constructor injection"}]},{"block_type":"text","content":": In this type of DI, the dependencies are passed to a constructor at the moment of its creation; one possible example can be the following:"}]}]},{"block_type":"element","block":"k5zy5bsh","search_text":"const service = new Service(dependencyA, dependencyB); ","text_count":55,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const service = new Service(dependencyA, dependencyB);"}]}]},{"block_type":"element","block":"k5zy5bsi","search_text":"Property injection : In this type of DI, the dependencies are attached to an object after its creation, as demonstrated by the following code: ","text_count":143,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Property injection"}]},{"block_type":"text","content":": In this type of DI, the dependencies are"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"attached"}]},{"block_type":"text","content":"to an object after its creation, as demonstrated by the following code:"}]}]},{"block_type":"element","block":"k5zy5bsj","search_text":"const service = new Service(); //works also with a factory service.dependencyA = anInstanceOfDependencyA; ","text_count":106,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const service = new Service();  //works also with a factory \n       service.dependencyA = anInstanceOfDependencyA;"}]}]},{"block_type":"element","block":"k5zy5bsk","search_text":"Property injection implies that an object is created in an inconsistent state because it's not wired to its dependencies, so it's the least robust, but it may sometimes be useful when there are cycles between the dependencies. For example, if we have two components, A and B , both using factory or constructor injection and both depending on each other, we cannot instantiate either of them because both would require the other to exist in order to be created. Let's consider a simple example, as follows:","text_count":506,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Property injection implies that an object is created in an"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"inconsistent"}]},{"block_type":"text","content":"state because it's not wired to its dependencies, so it's the least robust, but it may sometimes be useful when there are cycles between the dependencies. For example, if we have two components,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"A"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"B"}]},{"block_type":"text","content":", both using factory or constructor injection and both depending on each other, we cannot instantiate either of them because both would require the other to exist in order to be created. Let's consider a simple example, as follows:"}]},{"block_type":"element","block":"k5zy5bsl","search_text":"function Afactory(b) { return { foo: function() { b.say(); }, what: function() { return 'Hello!'; } } } function Bfactory(a) { return { a: a, say: function() { console.log('I say: ' + a.what); } } } ","text_count":199,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function Afactory(b) { \n  return { \n    foo: function() { \n      b.say(); \n    }, \n    what: function() { \n      return 'Hello!'; \n    } \n  } \n} \n \nfunction Bfactory(a) { \n  return { \n    a: a, \n    say: function() { \n      console.log('I say: ' + a.what); \n    } \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5bsm","search_text":"The dependency deadlock between the two preceding factories can be resolved only using property injection, for example, by first creating an incomplete instance of B , which then can be used to create A . Finally, we will inject A into B by setting the relative property as follows:","text_count":282,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The dependency deadlock between the two preceding factories can be resolved only using property injection, for example, by first creating an incomplete instance of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"B"}]},{"block_type":"text","content":", which then can be used to create"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"A"}]},{"block_type":"text","content":". Finally, we will inject"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"A"}]},{"block_type":"text","content":"into"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"B"}]},{"block_type":"text","content":"by setting the relative property as follows:"}]},{"block_type":"element","block":"k5zy5bsn","search_text":"const b = Bfactory(null); const a = Afactory(b); a.b = b; ","text_count":58,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const b = Bfactory(null); \nconst a = Afactory(b); \na.b = b;"}]}]},{"block_type":"element","block":"k5zy5bso","search_text":"Note In some rare circumstances, a cycle in the dependency graph is not easily avoidable; however, it is important to remember that often it is a symptom of bad design. ","text_count":169,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In some rare circumstances, a cycle in the dependency graph is not easily avoidable; however, it is important to remember that often it is a symptom of bad design."}]}]},{"block_type":"element","block":"k5zy5bsp","search_text":"Pros and cons of DI","text_count":19,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Pros and cons of DI"}]},{"block_type":"element","block":"k5zy5bsq","search_text":"In the authentication server example using DI, we were able to decouple our modules from a particular dependency instance. The result is that we can now reuse each module with minimal effort and without any change in their code. Testing a module that uses the DI pattern is also greatly simplified; we can easily provide mocked dependencies and test our modules in isolation from the state of the rest of the system.","text_count":416,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the authentication server example using DI, we were able to decouple our modules from a particular dependency instance. The result is that we can now reuse each module with minimal effort and without any change in their code. Testing a module that uses the DI pattern is also greatly simplified; we can easily provide mocked dependencies and test our modules in isolation from the state of the rest of the system."}]},{"block_type":"element","block":"k5zy5bsr","search_text":"Another important aspect to be highlighted from the example we presented earlier is that we shifted the dependency wiring responsibility from the bottom to the top of our architecture. The idea is that high-level components are by nature less reusable than low-level components, and that's because the more we go up in the layers of an application, the more a component becomes specific.","text_count":387,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another important aspect to be highlighted from the example we presented earlier is that we"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"shifted"}]},{"block_type":"text","content":"the dependency wiring responsibility from the bottom to the top of our architecture. The idea is that high-level components are by nature less reusable than low-level components, and that's because the more we go up in the layers of an application, the more a component becomes specific."}]},{"block_type":"element","block":"k5zy5bss","search_text":"Starting from this assumption, we can then understand that the conventional way to see an application architecture where high-level components own their lower-level dependencies can be inverted, so that the lower-level components depend only on an interface (in JavaScript, it's just the interface that we expect from a dependency), while the ownership of defining the implementation of a dependency is given to the higher-level components. In our authentication server, in fact, all the dependencies are instantiated and wired in the topmost component, the app module, which is also the less reusable and so is the most expendable in terms of coupling.","text_count":653,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Starting from this assumption, we can then understand that the conventional way to see an application architecture where high-level components own their lower-level dependencies can be inverted, so that the lower-level components depend only on an interface (in JavaScript, it's just the interface that we expect from a dependency), while the ownership of defining the implementation of a dependency is given to the higher-level components. In our authentication server, in fact, all the dependencies are instantiated and wired in the topmost component, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module, which is also the less reusable and so is the most expendable in terms of coupling."}]},{"block_type":"element","block":"k5zy5bst","search_text":"All these advantages in terms of decoupling and reusability, though, come with a price to pay. In general, the inability to resolve a dependency at coding time makes it more difficult to understand the relationship between the various components of a system. Also, if we look at the way we instantiated all the dependencies in the app module, we can see that we had to follow a specific order; we practically had to manually build the dependency graph of the entire application. This can become unmanageable when the number of modules to wire becomes high.","text_count":556,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All these advantages in terms of decoupling and reusability, though, come with a price to pay. In general, the inability to resolve a dependency at"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"coding time"}]},{"block_type":"text","content":"makes it more difficult to understand the relationship between the various components of a system. Also, if we look at the way we instantiated all the dependencies in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module, we can see that we had to follow a specific order; we practically had to manually build the dependency graph of the entire application. This can become unmanageable when the number of modules to wire becomes high."}]},{"block_type":"element","block":"k5zy5bsu","search_text":"A viable solution to this problem is to split the dependency ownership between multiple components, instead of having it centralized all in one place. This can reduce the complexity involved in managing the dependencies exponentially, as each component would be responsible only for its particular dependency subgraph. Of course, we can also choose to use DI only locally, just when necessary, instead of building the entire application on top of it.","text_count":450,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A viable solution to this problem is to split the dependency ownership between multiple components, instead of having it centralized all in one place. This can reduce the complexity involved in managing the dependencies exponentially, as each component would be responsible only for its particular dependency subgraph. Of course, we can also choose to use DI only locally, just when necessary, instead of building the entire application on top of it."}]},{"block_type":"element","block":"k5zy5bsv","search_text":"We will see later in the chapter that another possible solution to simplify the wiring of modules in complex architectures is to use a DI container, a component exclusively responsible for instantiating and wiring all the dependencies of an application.","text_count":253,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will see later in the chapter that another possible solution to simplify the wiring of modules in complex architectures is to use a DI container, a component exclusively responsible for instantiating and wiring all the dependencies of an application."}]},{"block_type":"element","block":"k5zy5bsw","search_text":"Using DI surely increases the complexity and verbosity of our modules, but as we saw earlier, there are many good reasons for doing this. It is up to us to choose the right approach, depending on the balance between simplicity and reusability that we want to obtain.","text_count":266,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using DI surely increases the complexity and verbosity of our modules, but as we saw earlier, there are many good reasons for doing this. It is up to us to choose the right approach, depending on the balance between simplicity and reusability that we want to obtain."}]},{"block_type":"element","block":"k5zy5bsx","search_text":"Note DI is often mentioned in combination with the Dependency Inversion principle and Inversion of Control ; however, they all are different concepts (even though correlated). ","text_count":176,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"DI is often mentioned in combination with the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Dependency Inversion principle"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Inversion of Control"}]},{"block_type":"text","content":"; however, they all are different concepts (even though correlated)."}]}]},{"block_type":"element","block":"k5zy5bsy","search_text":"Service locator","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Service locator"}]},{"block_type":"element","block":"k5zy5bsz","search_text":"In the previous section, we learned how DI can literally transform the way we wire our dependencies by obtaining reusable and decoupled modules. Another pattern with very similar intent is service locator . Its core principle is to have a central registry in order to manage the components of the system and to act as a mediator whenever a module needs to load a dependency. The idea is to ask the service locator for the dependency instead of hardcoding.","text_count":455,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous section, we learned how DI can literally transform the way we wire our dependencies by obtaining reusable and decoupled modules. Another pattern with very similar intent is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"service locator"}]},{"block_type":"text","content":". Its core principle is to have a central registry in order to manage the components of the system and to act as a mediator whenever a module needs to load a dependency. The idea is to ask the service locator for the dependency instead of hardcoding."}]},{"block_type":"element","block":"k5zy5bt0","search_text":"It is important to understand that by using a service locator, we are introducing a dependency on it, so the way we wire it to our modules determines their level of coupling and, therefore, their reusability. In Node.js, we can identify three types of service locators, depending on the way they are wired to the various components of the system:","text_count":346,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is important to understand that by using a service locator, we are introducing a dependency on it, so the way we wire it to our modules determines their level of coupling and, therefore, their reusability. In Node.js, we can identify three types of service locators, depending on the way they are wired to the various components of the system:"}]},{"block_type":"element","block":"k5zy5bt1","search_text":"Hardcoded dependency on service locator Injected service locator Global service locator ","text_count":88,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Hardcoded dependency on service locator"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Injected service locator"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Global service locator"}]}]},{"block_type":"element","block":"k5zy5bt2","search_text":"The first is definitely the one offering the fewest advantages in terms of decoupling, as it consists of directly referencing the instance of the service locator using require() . In Node.js, this can be considered an anti-pattern because it introduces a tight coupling with the component supposedly meant to provide a better decoupling. In this context, a service locator clearly does not provide any value in terms of reusability, only adding another level of indirection and complexity.","text_count":489,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first is definitely the one offering the fewest advantages in terms of decoupling, as it consists of directly referencing the instance of the service locator using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":". In Node.js, this can be considered an anti-pattern because it introduces a tight coupling with the component supposedly meant to provide a better decoupling. In this context, a service locator clearly does not provide any value in terms of reusability, only adding another level of indirection and complexity."}]},{"block_type":"element","block":"k5zy5bt3","search_text":"On the other hand, an injected service locator is referenced by a component through DI. This can be considered a more convenient way of injecting an entire set of dependencies at once, instead of providing them one by one. And as we will see its advantages do not end here.","text_count":273,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other hand, an"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"injected service locator"}]},{"block_type":"text","content":"is referenced by a component through DI. This can be considered a more convenient way of injecting an entire set of dependencies at once, instead of providing them one by one. And as we will see its advantages do not end here."}]},{"block_type":"element","block":"k5zy5bt4","search_text":"The third way of referencing a service locator is directly from the global scope. This has the same disadvantages as that of the hardcoded service locator, but since it is global, it is a real singleton and can therefore be easily used as a pattern for sharing instances between packages. We will see how this works later in the chapter, but for now we can certainly say that there are very few reasons for using a global service locator.","text_count":438,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The third way of referencing a service locator is directly from the global scope. This has the same disadvantages as that of the hardcoded service locator, but since it is global, it is a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"real singleton"}]},{"block_type":"text","content":"and can therefore be easily used as a pattern for sharing instances between packages. We will see how this works later in the chapter, but for now we can certainly say that there are very few reasons for using a global service locator."}]},{"block_type":"element","block":"k5zy5bt5","search_text":"Tip The Node.js module system already implements a variation of the service locator pattern, with require() representing the global instance of the service locator itself. ","text_count":172,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Node.js module system already implements a variation of the service locator pattern, with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"representing the global instance of the service locator itself."}]}]},{"block_type":"element","block":"k5zy5bt6","search_text":"All the considerations discussed here will become clearer once we start using the service locator pattern in a real example. Let's now refactor the authentication server again to apply what we learned.","text_count":201,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All the considerations discussed here will become clearer once we start using the service locator pattern in a real example. Let's now refactor the authentication server again to apply what we learned."}]},{"block_type":"element","block":"k5zy5bt7","search_text":"Refactoring the authentication server to use a service locator","text_count":62,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Refactoring the authentication server to use a service locator"}]},{"block_type":"element","block":"k5zy5bt8","search_text":"We are now going to convert the authentication server to use an injected service locator. To do this, the first step is to implement the service locator itself; we will use a new module, lib/serviceLocator.js :","text_count":210,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are now going to convert the authentication server to use an injected service locator. To do this, the first step is to implement the service locator itself; we will use a new module,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/serviceLocator.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bt9","search_text":"module.exports = function() { const dependencies = {}; const factories = {}; const serviceLocator = {}; serviceLocator.factory = (name, factory) => { //[1] factories[name] = factory; }; serviceLocator.register = (name, instance) => { //[2] dependencies[name] = instance; }; serviceLocator.get = (name) => { //[3] if(!dependencies[name]) { const factory = factories[name]; dependencies[name] = factory && factory(serviceLocator); if(!dependencies[name]) { throw new Error('Cannot find module: ' + name); } } return dependencies[name]; }; return serviceLocator; }; ","text_count":563,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = function() { \n  const dependencies = {}; \n  const factories = {}; \n  const serviceLocator = {}; \n \n  serviceLocator.factory = (name, factory) =&gt; {     //[1] \n    factories[name] = factory; \n  }; \n \n  serviceLocator.register = (name, instance) =&gt; {   //[2] \n    dependencies[name] = instance; \n  }; \n \n  serviceLocator.get = (name) =&gt; {                  //[3] \n    if(!dependencies[name]) { \n      const factory = factories[name]; \n      dependencies[name] = factory && factory(serviceLocator); \n      if(!dependencies[name]) { \n        throw new Error('Cannot find module: ' + name); \n      } \n    } \n    return dependencies[name]; \n  }; \n \n  return serviceLocator; \n};"}]}]},{"block_type":"element","block":"k5zy5bta","search_text":"Our serviceLocator module is a factory returning an object with three methods:","text_count":78,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"serviceLocator"}]},{"block_type":"text","content":"module is a factory returning an object with three methods:"}]},{"block_type":"element","block":"k5zy5btb","search_text":"factory() is used to associate a component name against a factory. register() is used to associate a component name directly with an instance. get() retrieves a component by its name. If an instance is already available, it simply returns it; otherwise, it tries to invoke the registered factory to obtain a new instance. It is very important to observe that the module factories are invoked by injecting the current instance of the service locator ( serviceLocator ). This is the core mechanism of the pattern that allows the dependency graph for our system to be built automatically and on-demand. We will see how this works in a moment. ","text_count":640,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"factory()"}]},{"block_type":"text","content":"is used to associate a component name against a factory."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"register()"}]},{"block_type":"text","content":"is used to associate a component name directly with an instance."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get()"}]},{"block_type":"text","content":"retrieves a component by its name. If an instance is already available, it simply returns it; otherwise, it tries to invoke the registered factory to obtain a new instance. It is very important to observe that the module factories are invoked by injecting the current instance of the service locator ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"serviceLocator"}]},{"block_type":"text","content":"). This is the core mechanism of the pattern that allows the dependency graph for our system to be built automatically and on-demand. We will see how this works in a moment."}]}]},{"block_type":"element","block":"k5zy5btc","search_text":"Note A simple pattern, closely resembling a service locator, is to use an object as a namespace for a set of dependencies: const dependencies = {}; const db = require('./lib/db'); const authService = require('./lib/authService'); dependencies.db = db(); dependencies.authService = authService(dependencies); ","text_count":308,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A simple pattern, closely resembling a service locator, is to use an object as a namespace for a set of dependencies:"}]},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const dependencies = {};"}]},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"const db = require('./lib/db');"}]},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"const authService = require('./lib/authService');"}]},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"dependencies.db = db();"}]},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"dependencies.authService = authService(dependencies);"}]}]}]},{"block_type":"element","block":"k5zy5btd","search_text":"Let's now convert the lib/db.js module straight away to demonstrate how our serviceLocator works:","text_count":97,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now convert the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/db.js"}]},{"block_type":"text","content":"&nbsp;module straight away to demonstrate how our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"serviceLocator"}]},{"block_type":"text","content":"works:"}]},{"block_type":"element","block":"k5zy5bte","search_text":"const level = require('level'); const sublevel = require('level-sublevel'); module.exports = (serviceLocator) => { const dbName = serviceLocator.get('dbName'); return sublevel( level(dbName, {valueEncoding: 'json'}) ); } ","text_count":221,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const level = require('level'); \nconst sublevel = require('level-sublevel'); \n \nmodule.exports = (serviceLocator) =&gt; { \n  const dbName = serviceLocator.get('dbName'); \n \n  return sublevel( \n    level(dbName, {valueEncoding: 'json'}) \n  ); \n}"}]}]},{"block_type":"element","block":"k5zy5btf","search_text":"The db module uses the service locator received in input to retrieve the name of the database to instantiate. This is an interesting point to highlight; a service locator can be used not only to return component instances but also to provide configuration parameters that define the behavior of the entire dependency graph that we want to create.","text_count":346,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module uses the service locator received in input to retrieve the name of the database to instantiate. This is an interesting point to highlight; a service locator can be used not only to return component instances but also to provide configuration parameters that define the behavior of the entire dependency graph that we want to create."}]},{"block_type":"element","block":"k5zy5btg","search_text":"The next step is to convert the lib/authService.js module:","text_count":58,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next step is to convert the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/authService.js"}]},{"block_type":"text","content":"&nbsp;module:"}]},{"block_type":"element","block":"k5zy5bth","search_text":"// ... module.exports = (serviceLocator) => { const db = serviceLocator.get('db'); const tokenSecret = serviceLocator.get('tokenSecret'); const users = db.sublevel('users'); const authService = {}; authService.login = (username, password, callback) => { //...same as in the previous version } authService.checkToken = (token, callback) => { //...same as in the previous version } return authService; }; ","text_count":403,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \nmodule.exports = (serviceLocator) =&gt; { \n  const db = serviceLocator.get('db'); \n  const tokenSecret = serviceLocator.get('tokenSecret'); \n \n  const users = db.sublevel('users'); \n  const authService = {}; \n \n  authService.login = (username, password, callback) =&gt; { \n    //...same as in the previous version \n  } \n \n  authService.checkToken = (token, callback) =&gt; { \n    //...same as in the previous version \n  } \n \n  return authService; \n};"}]}]},{"block_type":"element","block":"k5zy5bti","search_text":"Also, the authService module is a factory that takes the service locator as the input. The two dependencies of the module, the db handle and tokenSecret (which is another configuration parameter), are retrieved using the get() method of the service locator.","text_count":257,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module is a factory that takes the service locator as the input. The two dependencies of the module, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"handle and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tokenSecret"}]},{"block_type":"text","content":"(which is another configuration parameter), are retrieved using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get()"}]},{"block_type":"text","content":"method of the service locator."}]},{"block_type":"element","block":"k5zy5btj","search_text":"In a similar way, we can convert the lib/authController.js module:","text_count":66,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a similar way, we can convert the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/authController.js"}]},{"block_type":"text","content":"&nbsp;module:"}]},{"block_type":"element","block":"k5zy5btk","search_text":"module.exports = (serviceLocator) => { const authService = serviceLocator.get('authService'); const authController = {}; authController.login = (req, res, next) => { //...same as in the previous version }; authController.checkToken = (req, res, next) => { //...same as in the previous version }; return authController; } ","text_count":321,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = (serviceLocator) =&gt; { \n  const authService = serviceLocator.get('authService'); \n  const authController = {}; \n \n  authController.login = (req, res, next) =&gt; { \n    //...same as in the previous version \n  }; \n \n  authController.checkToken = (req, res, next) =&gt; { \n    //...same as in the previous version \n  }; \n \n  return authController; \n}"}]}]},{"block_type":"element","block":"k5zy5btl","search_text":"Now we are ready to see how the service locator is instantiated and configured. This happens, of course, in the app.js module:","text_count":126,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to see how the service locator is instantiated and configured. This happens, of course, in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"&nbsp;module:"}]},{"block_type":"element","block":"k5zy5btm","search_text":"//... const svcLoc = require('./lib/serviceLocator')(); //[1] svcLoc.register('dbName', 'example-db'); //[2] svcLoc.register('tokenSecret', 'SHHH!'); svcLoc.factory('db', require('./lib/db')); svcLoc.factory('authService', require('./lib/authService')); svcLoc.factory('authController', require('./lib/authController')); const authController = svcLoc.get('authController'); //[3] app.post('/login', authController.login); app.all('/checkToken', authController.checkToken); // ... ","text_count":480,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//... \nconst svcLoc = require('./lib/serviceLocator')();      //[1] \n \nsvcLoc.register('dbName', 'example-db');               //[2] \nsvcLoc.register('tokenSecret', 'SHHH!'); \nsvcLoc.factory('db', require('./lib/db')); \nsvcLoc.factory('authService', require('./lib/authService')); \nsvcLoc.factory('authController', require('./lib/authController')); \n \nconst authController = svcLoc.get('authController');   //[3] \n \napp.post('/login', authController.login); \napp.all('/checkToken', authController.checkToken); \n// ..."}]}]},{"block_type":"element","block":"k5zy5btn","search_text":"This is how the wiring works using our new service locator:","text_count":59,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is how the wiring works using our new service locator:"}]},{"block_type":"element","block":"k5zy5bto","search_text":"We instantiate a new service locator by invoking its factory. We register the configuration parameters and module factories against the service locator. At this point, all our dependencies are not instantiated yet; we just registered their factories. We load authController from the service locator; this is the entry point that triggers the instantiation of the entire dependency graph of our application. When we ask for the instance of the authController component, the service locator invokes the associated factory by injecting an instance of itself, then the authController factory will try to load the authService module, which in turn instantiates the db module. ","text_count":671,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We instantiate a new service locator by invoking its factory."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We register the configuration parameters and module factories against the service locator. At this point, all our dependencies are not instantiated yet; we just registered their factories."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We load"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authController"}]},{"block_type":"text","content":"from the service locator; this is the entry point that triggers the instantiation of the entire dependency graph of our application. When we ask for the instance of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authController"}]},{"block_type":"text","content":"component, the service locator invokes the associated factory by injecting an instance of itself, then the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authController"}]},{"block_type":"text","content":"factory will try to load the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module, which in turn instantiates the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module."}]}]},{"block_type":"element","block":"k5zy5btp","search_text":"It's interesting to see the lazy nature of the service locator; each instance is created only when needed. But there is another important implication: we can see, in fact, that every dependency is automatically wired without the need to manually do it in advance. The advantage is that we don't have to know in advance what the right order for instantiating and wiring the modules is—it all happens automatically and on-demand . This is much more convenient compared to the simple DI pattern.","text_count":492,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's interesting to see the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"lazy"}]},{"block_type":"text","content":"nature of the service locator; each instance is created only when needed. But there is another important implication: we can see, in fact, that every dependency is automatically wired without the need to manually do it in advance. The advantage is that we don't have to know in advance what the right order for instantiating and wiring the modules is&mdash;it all happens automatically and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"on-demand"}]},{"block_type":"text","content":". This is much more convenient compared to the simple DI pattern."}]},{"block_type":"element","block":"k5zy5btq","search_text":"Tip Another common pattern is to use an Express server instance as a simple service locator. This can be achieved using expressApp.set(name, instance) to register a service and expressApp.get(name) to then retrieve it. The convenient part of this pattern is that the server instance, which acts as a service locator, is already injected into each middleware and is accessible through the request.app property. You can find an example of this pattern in the samples distributed with the book. ","text_count":492,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another common pattern is to use an Express server instance as a simple service locator. This can be achieved using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"expressApp.set(name, instance)"}]},{"block_type":"text","content":"to register a service and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"expressApp.get(name)"}]},{"block_type":"text","content":"to then retrieve it. The convenient part of this pattern is that the server instance, which acts as a service locator, is already injected into each middleware and is accessible through the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request.app"}]},{"block_type":"text","content":"property. You can find an example of this pattern in the samples distributed with the book."}]}]},{"block_type":"element","block":"k5zy5btr","search_text":"Pros and cons of a service locator","text_count":34,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Pros and cons of a service locator"}]},{"block_type":"element","block":"k5zy5bts","search_text":"Service locator and Dependency Injection have a lot in common: both shift the dependency ownership to an entity external to the component. But the way we wire the service locator determines the flexibility of our entire architecture. It is not by chance that we chose an injected service locator to implement our example, as opposed to a hardcoded or global service locator. These last two variations almost nullify the advantages of this pattern. In fact, the result would be that, instead of coupling a component directly to its dependencies using require() , we would be coupling it to one particular instance of the service locator. It's also true that a hardcoded service locator will still give more flexibility in configuring what component to associate with a particular name, but this still does not give any big advantage in terms of reusability.","text_count":856,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service locator"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Dependency Injection"}]},{"block_type":"text","content":"have a lot in common: both shift the dependency ownership to an entity external to the component. But the way we wire the service locator determines the flexibility of our entire architecture. It is not by chance that we chose an injected service locator to implement our example, as opposed to a hardcoded or global service locator. These last two variations almost nullify the advantages of this pattern. In fact, the result would be that, instead of coupling a component directly to its dependencies using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":", we would be coupling it to one particular instance of the service locator. It's also true that a hardcoded service locator will still give more flexibility in configuring what component to associate with a particular name, but this still does not give any big advantage in terms of reusability."}]},{"block_type":"element","block":"k5zy5btt","search_text":"Also, like DI, using a service locator makes it harder to identify the relationship between the components as they are resolved at runtime. In addition, it also makes it more difficult to know exactly what dependency a particular component is going to require. With DI, this is expressed in a much clearer way: by declaring the dependencies in the factory or constructor arguments. With a service locator, this is much less clear and would require a code inspection or an explicit statement in the documentation explaining what dependencies a particular component will try to load.","text_count":581,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, like DI, using a service locator makes it harder to identify the relationship between the components as they are resolved at runtime. In addition, it also makes it more difficult to know exactly what dependency a particular component is going to require. With DI, this is expressed in a much clearer way: by declaring the dependencies in the factory or constructor arguments. With a service locator, this is much less clear and would require a code inspection or an explicit statement in the documentation explaining what dependencies a particular component will try to load."}]},{"block_type":"element","block":"k5zy5btu","search_text":"As a final note, it is important to know that often a service locator is incorrectly mistaken for a DI container because it shares the same role of service registry with it; however, there is a big difference between the two. With a service locator, each component loads its dependencies explicitly from the service locator itself. When using a DI container instead, the component has no knowledge of the container.","text_count":415,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As a final note, it is important to know that often a service locator is incorrectly mistaken for a DI container because it shares the same role of service registry with it; however, there is a big difference between the two. With a service locator, each component loads its dependencies explicitly from the service locator itself. When using a DI container instead, the component has no knowledge of the container."}]},{"block_type":"element","block":"k5zy5btv","search_text":"The difference between these two approaches is noticeable for two reasons:","text_count":74,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The difference between these two approaches is noticeable for two reasons:"}]},{"block_type":"element","block":"k5zy5btw","search_text":"Reusability : A component relying on a service locator is less reusable because it requires that a service locator is available in the system Readability : As we have already said, a service locator obfuscates the dependency requirements of a component ","text_count":253,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Reusability"}]},{"block_type":"text","content":": A component relying on a service locator is less reusable because it requires that a service locator is available in the system"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Readability"}]},{"block_type":"text","content":": As we have already said, a service locator obfuscates the dependency requirements of a component"}]}]},{"block_type":"element","block":"k5zy5btx","search_text":"In terms of reusability, we can say that the service locator pattern sits inbetween hardcoded dependencies and DI. In terms of convenience and simplicity, it is definitely better than manual DI, as we don't have to manually take care of building the entire dependency graph.","text_count":274,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In terms of reusability, we can say that the service locator pattern sits inbetween hardcoded dependencies and DI. In terms of convenience and simplicity, it is definitely better than manual DI, as we don't have to manually take care of building the entire dependency graph."}]},{"block_type":"element","block":"k5zy5bty","search_text":"Under these assumptions, a DI container definitely offers the best compromise in terms of reusability of the components and convenience. We are going to better analyze this pattern in the next section.","text_count":201,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Under these assumptions, a DI container definitely offers the best compromise in terms of reusability of the components and convenience. We are going to better analyze this pattern in the next section."}]},{"block_type":"element","block":"k5zy5btz","search_text":"Dependency Injection container","text_count":30,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Dependency Injection container"}]},{"block_type":"element","block":"k5zy5bu0","search_text":"The step to transform a service locator into a Dependency Injection (DI) container is not big, but as we have already mentioned, it makes a huge difference in terms of decoupling. With this pattern, in fact, each module doesn't have to depend on the service locator, it can simply express its need in terms of dependencies and the DI container will do the rest seamlessly. As we will see, the big leap forward of this mechanism is that every module can be reused even without the container.","text_count":490,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The step to transform a service locator into a Dependency Injection (DI) container is not big, but as we have already mentioned, it makes a huge difference in terms of decoupling. With this pattern, in fact, each module doesn't have to depend on the service locator, it can simply express its need in terms of dependencies and the DI container will do the rest seamlessly. As we will see, the big leap forward of this mechanism is that every module can be reused even without the container."}]},{"block_type":"element","block":"k5zy5bu1","search_text":"Declaring a set of dependencies to a DI container","text_count":49,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Declaring a set of dependencies to a DI container"}]},{"block_type":"element","block":"k5zy5bu2","search_text":"A DI container is essentially a service locator with the addition of one feature: it identifies the dependency requirements of a module before instantiating it. For this to be possible, a module has to declare its dependencies in some way, and as we will see, we have multiple options for doing this.","text_count":300,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A DI container is essentially a service locator with the addition of one feature: it identifies the dependency requirements of a module before instantiating it. For this to be possible, a module has to declare its dependencies in some way, and as we will see, we have multiple options for doing this."}]},{"block_type":"element","block":"k5zy5bu3","search_text":"The first, and probably the most popular, technique consists of injecting a set of dependencies based on the arguments' names used in a factory or constructor. Let's take, for example, the authService module:","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first, and probably the most popular, technique consists of injecting a set of dependencies based on the arguments' names used in a factory or constructor. Let's take, for example, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5bu4","search_text":"module.exports = (db, tokenSecret) => { //... } ","text_count":48,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = (db, tokenSecret) =&gt; { \n  //... \n}"}]}]},{"block_type":"element","block":"k5zy5bu5","search_text":"As we defined it, the preceding module will be instantiated by our DI container using the dependencies with names db and tokenSecret —a very simple and intuitive mechanism. However, to be able to read the names of the arguments of a function, it's necessary to use a little trick. In JavaScript, we have the possibility to serialize a function, obtaining at runtime its source code; this is as easy as invoking toString() on the function reference. With regular expressions, obtaining the arguments list is certainly not black magic.","text_count":533,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we defined it, the preceding module will be instantiated by our DI container using the dependencies with names"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tokenSecret"}]},{"block_type":"text","content":"&mdash;a very simple and intuitive mechanism. However, to be able to read the names of the arguments of a function, it's necessary to use a little trick. In JavaScript, we have the possibility to serialize a function, obtaining at runtime its source code; this is as easy as invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"toString()"}]},{"block_type":"text","content":"on the function reference. With regular expressions, obtaining the arguments list is certainly not black magic."}]},{"block_type":"element","block":"k5zy5bu6","search_text":"Tip This technique of injecting a set of dependencies using the names of the arguments of a function was popularized by AngularJS ( http://angularjs.org ), a client-side JavaScript framework developed by Google and entirely built on top of a DI container. ","text_count":256,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This technique of injecting a set of dependencies using the names of the arguments of a function was popularized by AngularJS ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://angularjs.org"},"children":[{"block_type":"text","content":"http://angularjs.org"}]},{"block_type":"text","content":"), a client-side JavaScript framework developed by Google and entirely built on top of a DI container."}]}]},{"block_type":"element","block":"k5zy5bu7","search_text":"The biggest problem of this approach is that it doesn't play well with minification , a practice used extensively in client-side JavaScript which consists of applying particular code transformations to reduce to the minimum the size of the source code. Many minificators apply a technique known as name mangling , which essentially renames any local variable to reduce its length, usually to a single character. The bad news is that function arguments are local variables and are usually affected by this process, causing the mechanism that we described for declaring dependencies to fall apart. Even though minification is not really necessary in server-side code, it's important to consider that often Node.js modules are shared with the browser, and this is an important factor to consider in our analysis.","text_count":809,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The biggest problem of this approach is that it doesn't play well with"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"minification"}]},{"block_type":"text","content":", a practice used extensively in client-side JavaScript which consists of applying particular code transformations to reduce to the minimum the size of the source code. Many minificators apply a technique known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"name mangling"}]},{"block_type":"text","content":", which essentially renames any local variable to reduce its length, usually to a single character. The bad news is that function arguments are local variables and are usually affected by this process, causing the mechanism that we described for declaring dependencies to fall apart. Even though minification is not really necessary in server-side code, it's important to consider that often Node.js modules are shared with the browser, and this is an important factor to consider in our analysis."}]},{"block_type":"element","block":"k5zy5bu8","search_text":"Luckily, a DI container might use other techniques to know which dependencies to inject. These techniques are given as follows:","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Luckily, a DI container might use other techniques to know which dependencies to inject. These techniques are given as follows:"}]},{"block_type":"element","block":"k5zy5bu9","search_text":"We can use a special property attached to the factory function, for example, an array explicitly listing all the dependencies to inject: ","text_count":137,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We can use a special property attached to the factory function, for example, an array explicitly listing all the dependencies to inject:"}]}]},{"block_type":"element","block":"k5zy5bua","search_text":"module.exports = (a, b) => {}; module.exports._inject = ['db', 'another/dependency']; ","text_count":86,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = (a, b) =&gt; {}; \n       module.exports._inject = ['db', 'another/dependency'];"}]}]},{"block_type":"element","block":"k5zy5bub","search_text":"We can specify a module as an array of dependency names followed by the factory function: ","text_count":90,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We can specify a module as an array of dependency names followed by the factory function:"}]}]},{"block_type":"element","block":"k5zy5buc","search_text":"module.exports = ['db', 'another/depencency',(a, b) => {}]; ","text_count":60,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = ['db', 'another/depencency',(a, b) =&gt; {}];"}]}]},{"block_type":"element","block":"k5zy5bud","search_text":"We can use a comment annotation that is appended to each argument of a function (however, this also doesn't play well with minification): ","text_count":138,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We can use a comment annotation that is appended to each argument of a function (however, this also doesn't play well with minification):"}]}]},{"block_type":"element","block":"k5zy5bue","search_text":"module.exports = function(a /*db*/, b /*another/depencency*/) {}; ","text_count":66,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = function(a /*db*/, b /*another/depencency*/) {};"}]}]},{"block_type":"element","block":"k5zy5buf","search_text":"All these techniques are quite opinionated, so for our example, we are going to use the most simple and popular, which is to obtain the dependency names using the arguments of a function.","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All these techniques are quite opinionated, so for our example, we are going to use the most simple and popular, which is to obtain the dependency names using the arguments of a function."}]},{"block_type":"element","block":"k5zy5bug","search_text":"Refactoring the authentication server to use a DI container","text_count":59,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Refactoring the authentication server to use a DI container"}]},{"block_type":"element","block":"k5zy5buh","search_text":"To demonstrate how a DI container is much less invasive than a service locator, we are now going to again refactor our authentication server, and to do so we are going to use as a starting point the version in which we were using the plain DI pattern. In fact, what we are going to do is just leave untouched all the components of the application except for the app.js module, which is going to be the module responsible for initializing the container.","text_count":452,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate how a DI container is much less invasive than a service locator, we are now going to again refactor our authentication server, and to do so we are going to use as a starting point the version in which we were using the plain DI pattern. In fact, what we are going to do is just leave untouched all the components of the application except for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module, which is going to be the module responsible for initializing the container."}]},{"block_type":"element","block":"k5zy5bui","search_text":"But first, we need to implement our DI container. Let's do that by creating a new module called diContainer.js under the lib/ directory. This is its initial part:","text_count":162,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But first, we need to implement our DI container. Let's do that by creating a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"diContainer.js"}]},{"block_type":"text","content":"under the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"lib/"}]},{"block_type":"text","content":"directory. This is its initial part:"}]},{"block_type":"element","block":"k5zy5buj","search_text":"const fnArgs= require('parse-fn-args'); module.exports = function() { const dependencies = {}; const factories = {}; const diContainer = {}; diContainer.factory = (name, factory) => { factories[name] = factory; }; diContainer.register = (name, dep) => { dependencies[name] = dep; }; diContainer.get = (name) => { if(!dependencies[name]) { const factory = factories[name]; dependencies[name] = factory && diContainer.inject(factory); if(!dependencies[name]) { throw new Error('Cannot find module: ' + name); } } return dependencies[name]; }; //...to be continued ","text_count":562,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fnArgs= require('parse-fn-args'); \n \nmodule.exports = function() { \n  const dependencies = {}; \n  const factories = {}; \n  const diContainer = {}; \n \n  diContainer.factory = (name, factory) =&gt; { \n    factories[name] = factory; \n  }; \n \n  diContainer.register = (name, dep) =&gt; { \n    dependencies[name] = dep; \n  }; \n \n  diContainer.get = (name) =&gt; { \n    if(!dependencies[name]) { \n      const factory = factories[name]; \n      dependencies[name] = factory && \n          diContainer.inject(factory); \n      if(!dependencies[name]) { \n        throw new Error('Cannot find module: ' + name); \n      } \n    } \n    return dependencies[name]; \n  }; \n  //...to be continued"}]}]},{"block_type":"element","block":"k5zy5buk","search_text":"The first part of the diContainer module is functionally identical to the service locator we have seen previously. The only notable differences are:","text_count":148,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first part of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"diContainer"}]},{"block_type":"text","content":"module is functionally identical to the service locator we have seen previously. The only notable differences are:"}]},{"block_type":"element","block":"k5zy5bul","search_text":"We require a new npm module called args-list ( https://npmjs.org/package/args-list ), which we will use to extract the names of the arguments of a function This time, instead of directly invoking the module factory, we rely on another method of the diContainer module called inject() , which will resolve the dependencies of a module and use them to invoke the factory ","text_count":369,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We require a new npm module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"args-list"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/args-list"},"children":[{"block_type":"text","content":"https://npmjs.org/package/args-list"}]},{"block_type":"text","content":"), which we will use to extract the names of the arguments of a function"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"This time, instead of directly invoking the module factory, we rely on another method of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"diContainer"}]},{"block_type":"text","content":"module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inject()"}]},{"block_type":"text","content":", which will resolve the dependencies of a module and use them to invoke the factory"}]}]},{"block_type":"element","block":"k5zy5bum","search_text":"Let's see how the diContainer.inject() method looks:","text_count":52,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see how the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"diContainer.inject()"}]},{"block_type":"text","content":"method looks:"}]},{"block_type":"element","block":"k5zy5bun","search_text":"diContainer.inject = (factory) => { const args = fnArgs(factory) .map(dependency => diContainer.get(dependency)); return factory.apply(null, args); }; }; //end of module.exports = function() { ","text_count":193,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"diContainer.inject = (factory) =&gt; { \n  const args = fnArgs(factory) \n  .map(dependency =&gt; diContainer.get(dependency)); \n    return factory.apply(null, args); \n  }; \n \n}; //end of module.exports = function() {"}]}]},{"block_type":"element","block":"k5zy5buo","search_text":"The preceding method is what makes the DI container different from a service locator. Its logic is very straightforward:","text_count":120,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding method is what makes the DI container different from a service locator. Its logic is very straightforward:"}]},{"block_type":"element","block":"k5zy5bup","search_text":"We extract the arguments list from the factory function we receive as the input, using the parse-fn-args library. We then map each argument name to the correspondent dependency instance retrieved using the get() method. At the end, all we have to do is just invoke the factory by providing the dependency list that we just generated. ","text_count":334,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We extract the arguments list from the factory function we receive as the input, using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"parse-fn-args"}]},{"block_type":"text","content":"library."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We then map each argument name to the correspondent dependency instance retrieved using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get()"}]},{"block_type":"text","content":"method."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At the end, all we have to do is just invoke the factory by providing the dependency list that we just generated."}]}]},{"block_type":"element","block":"k5zy5buq","search_text":"That's really it for our diContainer . As we saw, it's not that much different from a service locator, but the simple step of instantiating a module by injecting its dependencies makes a dramatic difference (as compared to injecting the entire service locator).","text_count":261,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's really it for our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"diContainer"}]},{"block_type":"text","content":". As we saw, it's not that much different from a service locator, but the simple step of instantiating a module by injecting its dependencies makes a dramatic difference (as compared to injecting the entire service locator)."}]},{"block_type":"element","block":"k5zy5bur","search_text":"To complete the refactoring of the authentication server, we also need to tweak the app.js module:","text_count":98,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To complete the refactoring of the authentication server, we also need to tweak the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5bus","search_text":"// ... const diContainer = require('./lib/diContainer')(); diContainer.register('dbName', 'example-db'); diContainer.register('tokenSecret', 'SHHH!'); diContainer.factory('db', require('./lib/db')); diContainer.factory('authService', require('./lib/authService')); diContainer.factory('authController', require('./lib/authController')); const authController = diContainer.get('authController'); app.post('/login', authController.login); app.get('/checkToken', authController.checkToken); // ... ","text_count":495,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \nconst diContainer = require('./lib/diContainer')(); \n \ndiContainer.register('dbName', 'example-db'); \ndiContainer.register('tokenSecret', 'SHHH!'); \ndiContainer.factory('db', require('./lib/db')); \ndiContainer.factory('authService', require('./lib/authService')); \ndiContainer.factory('authController', require('./lib/authController')); \n \nconst authController = diContainer.get('authController'); \n \napp.post('/login', authController.login); \napp.get('/checkToken', authController.checkToken); \n// ..."}]}]},{"block_type":"element","block":"k5zy5but","search_text":"As we can see, the code of the app module is identical to the one that we used to initialize the service locator in the previous section. We can also notice that to bootstrap the DI container, and therefore trigger the loading of the entire dependency graph, we still have to use it as a service locator by invoking diContainer.get('authController') . From that point on, every module registered with the DI container will be instantiated and wired automatically.","text_count":463,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, the code of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module is identical to the one that we used to initialize the service locator in the previous section. We can also notice that to bootstrap the DI container, and therefore trigger the loading of the entire dependency graph, we still have to use it as a service locator by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"diContainer.get('authController')"}]},{"block_type":"text","content":". From that point on, every module registered with the DI container will be instantiated and wired automatically."}]},{"block_type":"element","block":"k5zy5buu","search_text":"Pros and cons of a DI container","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Pros and cons of a DI container"}]},{"block_type":"element","block":"k5zy5buv","search_text":"A DI container assumes that our modules use the DI pattern and therefore inherit most of its pros and cons. In particular, we have an improved decoupling and testability, but on the other hand more complexity, because our dependencies are resolved at runtime. A DI container also shares many properties with the service locator pattern, but it has on its side the fact that it doesn't force the modules to depend on any extra service except its actual dependencies. This is a huge advantage because it allows each module to be used even without the DI container, using a simple manual injection.","text_count":595,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A DI container assumes that our modules use the DI pattern and therefore inherit most of its pros and cons. In particular, we have an improved decoupling and testability, but on the other hand more complexity, because our dependencies are resolved at runtime. A DI container also shares many properties with the service locator pattern, but it has on its side the fact that it doesn't force the modules to depend on any extra service except its actual dependencies. This is a huge advantage because it allows each module to be used even without the DI container, using a simple manual injection."}]},{"block_type":"element","block":"k5zy5buw","search_text":"That's essentially what we demonstrated in this section: we took the version of the authentication server where we used the plain DI pattern, and then without modifying any of its components (except for the app module), we were able to automatize the injection of every dependency.","text_count":281,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's essentially what we demonstrated in this section: we took the version of the authentication server where we used the plain DI pattern, and then without modifying any of its components (except for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module), we were able to automatize the injection of every dependency."}]},{"block_type":"element","block":"k5zy5bux","search_text":"Tip On npm, you can find a lot of DI containers to reuse or take inspiration from at https://www.npmjs.org/search?q=dependency%20injection . ","text_count":141,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On npm, you can find a lot of DI containers to reuse or take inspiration from at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.npmjs.org/search?q=dependency%20injection"},"children":[{"block_type":"text","content":"https://www.npmjs.org/search?q=dependency%20injection"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5buy","search_text":"Wiring plugins","text_count":14,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Wiring plugins"}]},{"block_type":"element","block":"k5zy5buz","search_text":"The dream architecture of a software engineer is the one having a small, minimal core, extensible as needed through the use of plugins . Unfortunately, this is not always easy to obtain, since most of the time it has a cost in terms of time, resources, and complexity. Nonetheless, it's always desirable to support some kind of external extensibility , even if limited to just some parts of the system. In this section, we are going to plunge into this fascinating world and focus on a dualistic problem:","text_count":504,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The dream architecture of a software engineer is the one having a small, minimal core, extensible as needed through the use of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"plugins"}]},{"block_type":"text","content":". Unfortunately, this is not always easy to obtain, since most of the time it has a cost in terms of time, resources, and complexity. Nonetheless, it's always desirable to support some kind of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"external extensibility"}]},{"block_type":"text","content":", even if limited to just some parts of the system. In this section, we are going to plunge into this fascinating world and focus on a dualistic problem:"}]},{"block_type":"element","block":"k5zy5bv0","search_text":"Exposing the services of an application to a plugin Integrating a plugin into the flow of the parent application ","text_count":113,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Exposing the services of an application to a plugin"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Integrating a plugin into the flow of the parent application"}]}]},{"block_type":"element","block":"k5zy5bv1","search_text":"Plugins as packages","text_count":19,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Plugins as packages"}]},{"block_type":"element","block":"k5zy5bv2","search_text":"Often in Node.js, the plugins of an application are installed as packages into the node_modules directory of a project. There are two advantages for doing this. Firstly, we can leverage the power of npm to distribute the plugin and manage its dependencies. And secondly, a package can have its own private dependency graph, which reduces the chances of having conflicts and incompatibilities between dependencies, as opposed to letting the plugin use the dependencies of the parent project.","text_count":490,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Often in Node.js, the plugins of an application are installed as packages into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules"}]},{"block_type":"text","content":"directory of a project. There are two advantages for doing this. Firstly, we can leverage the power of npm to distribute the plugin and manage its dependencies. And secondly, a package can have its own private dependency graph, which reduces the chances of having conflicts and incompatibilities between dependencies, as opposed to letting the plugin use the dependencies of the parent project."}]},{"block_type":"element","block":"k5zy5bv3","search_text":"The following directory structure gives an example of an application with two plugins distributed as packages:","text_count":110,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following directory structure gives an example of an application with two plugins distributed as packages:"}]},{"block_type":"element","block":"k5zy5bv4","search_text":"application '-- node_modules |-- pluginA '-- pluginB ","text_count":53,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"application \n'-- node_modules \n    |-- pluginA \n    '-- pluginB"}]}]},{"block_type":"element","block":"k5zy5bv5","search_text":"In the Node.js world, this is a very common practice. Some popular examples are express ( http://expressjs.com ) with its middleware, gulp ( http://gulpjs.com ), grunt ( http://gruntjs.com ), nodebb ( http://nodebb.org ), and docpad ( http://docpad.org ).","text_count":255,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the Node.js world, this is a very common practice. Some popular examples are"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"express"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://expressjs.com"},"children":[{"block_type":"text","content":"http://expressjs.com"}]},{"block_type":"text","content":") with its middleware,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"gulp"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://gulpjs.com"},"children":[{"block_type":"text","content":"http://gulpjs.com"}]},{"block_type":"text","content":"),"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"grunt"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://gruntjs.com"},"children":[{"block_type":"text","content":"http://gruntjs.com"}]},{"block_type":"text","content":"),"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"nodebb"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nodebb.org"},"children":[{"block_type":"text","content":"http://nodebb.org"}]},{"block_type":"text","content":"), and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"docpad"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://docpad.org"},"children":[{"block_type":"text","content":"http://docpad.org"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5bv6","search_text":"However, the benefits of using packages are not only limited to external plugins . In fact, one popular pattern is to build entire applications by wrapping their components into packages, as if they were internal plugins . So, instead of organizing the modules in the main package of the application, we can create a separate package for each big chunk of functionality and install it into the node_modules directory.","text_count":417,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, the benefits of using packages are not only limited to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"external plugins"}]},{"block_type":"text","content":". In fact, one popular pattern is to build entire applications by wrapping their components into packages, as if they were"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"internal plugins"}]},{"block_type":"text","content":". So, instead of organizing the modules in the main package of the application, we can create a separate package for each big chunk of functionality and install it into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules"}]},{"block_type":"text","content":"directory."}]},{"block_type":"element","block":"k5zy5bv7","search_text":"Tip A package can be private and not necessarily available on the public npm registry. We can always set the private flag into the package.json to prevent accidental publication to npm. Then, we can commit the packages into a version control system such as git or leverage a private npm server to share them with the rest of the team. ","text_count":335,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A package can be private and not necessarily available on the public npm registry. We can always set the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"private"}]},{"block_type":"text","content":"flag into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"package.json"}]},{"block_type":"text","content":"to prevent accidental publication to npm. Then, we can commit the packages into a version control system such as git or leverage a private npm server to share them with the rest of the team."}]}]},{"block_type":"element","block":"k5zy5bv8","search_text":"Why follow this pattern? First of all, convenience: people often find it impractical or too verbose to reference the local modules of a package using the relative path notation. Let's, for example, consider the following directory structure:","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Why follow this pattern? First of all, convenience: people often find it impractical or too verbose to reference the local modules of a package using the relative path notation. Let's, for example, consider the following directory structure:"}]},{"block_type":"element","block":"k5zy5bv9","search_text":"application |-- componentA | '-- subdir | '-- moduleA '-- componentB '-- moduleB ","text_count":81,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"application \n|-- componentA \n|   '-- subdir \n|       '-- moduleA \n'-- componentB \n    '-- moduleB"}]}]},{"block_type":"element","block":"k5zy5bva","search_text":"If we want to reference moduleB from moduleA , we have to write something like this:","text_count":84,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we want to reference"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"moduleB"}]},{"block_type":"text","content":"from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"moduleA"}]},{"block_type":"text","content":", we have to write something like this:"}]},{"block_type":"element","block":"k5zy5bvb","search_text":"require('../../componentB/moduleB'); ","text_count":37,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"require('../../componentB/moduleB');"}]}]},{"block_type":"element","block":"k5zy5bvc","search_text":"Instead, we can leverage the properties of the resolving algorithm of require() (as we have studied it in Chapter 2, Node.js Essential Patterns ) and put the entire componentB directory into a package. By installing it into the node_modules directory, we can then write something such as the following (from anywhere in the main package of the application):","text_count":357,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Instead, we can leverage the properties of the resolving algorithm of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"(as we have studied it in Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Essential Patterns"}]},{"block_type":"text","content":") and put the entire"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"componentB"}]},{"block_type":"text","content":"directory into a package. By installing it into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules"}]},{"block_type":"text","content":"directory, we can then write something such as the following (from anywhere in the main package of the application):"}]},{"block_type":"element","block":"k5zy5bvd","search_text":"require('componentB/module'); ","text_count":30,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"require('componentB/module');"}]}]},{"block_type":"element","block":"k5zy5bve","search_text":"The second reason for splitting a project into packages is, of course, reusability. A package can have its own private dependencies, and it forces the developer to think in terms of what to expose to the main application and what instead to keep private, with beneficial effects on the decoupling and information hiding of the entire application.","text_count":346,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The second reason for splitting a project into packages is, of course, reusability. A package can have its own private dependencies, and it forces the developer to think in terms of what to expose to the main application and what instead to keep private, with beneficial effects on the decoupling and information hiding of the entire application."}]},{"block_type":"element","block":"k5zy5bvf","search_text":"Tip Pattern Use packages as a means to organize your application, not just for distributing code in combination with npm. ","text_count":122,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Use packages as a means to organize your application, not just for distributing code in combination with npm."}]}]},{"block_type":"element","block":"k5zy5bvg","search_text":"The use cases we have just described make use of a package not just as a stateless, reusable library (like most of the packages on npm), but more as an integral part of a particular application, providing services, extending its functionality, or modifying its behavior. The main difference is that these types of packages are integrated inside an application rather than just used.","text_count":382,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The use cases we have just described make use of a package not just as a stateless, reusable library (like most of the packages on npm), but more as an integral part of a particular application, providing services, extending its functionality, or modifying its behavior. The main difference is that these types of packages are"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"integrated"}]},{"block_type":"text","content":"inside an application rather than just used."}]},{"block_type":"element","block":"k5zy5bvh","search_text":"Note For simplicity, we will use the term plugin to describe any package meant to integrate with a particular application. ","text_count":123,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For simplicity, we will use the term plugin to describe any package meant to integrate with a particular application."}]}]},{"block_type":"element","block":"k5zy5bvi","search_text":"As we will see, the common problem that we are going to face when deciding to support this type of architecture is exposing parts of the main application to plugins. In fact, we cannot think of only stateless plugins—this is, of course, the aim for a perfect extensibility, because sometimes the plugin has to use some of the services of the parent application in order to carry out its tasks. This aspect might depend a lot on the technique used to wire modules in the parent application.","text_count":489,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we will see, the common problem that we are going to face when deciding to support this type of architecture is exposing parts of the main application to plugins. In fact, we cannot think of only stateless plugins&mdash;this is, of course, the aim for a perfect extensibility, because sometimes the plugin has to use some of the services of the parent application in order to carry out its tasks. This aspect might depend a lot on the technique used to wire modules in the parent application."}]},{"block_type":"element","block":"k5zy5bvj","search_text":"Extension points","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Extension points"}]},{"block_type":"element","block":"k5zy5bvk","search_text":"There are literally infinite ways to make an application extensible. For example, some of the design patterns we studied in Chapter 6, Design Patterns, are meant exactly for this: using Proxy or Decorator we are able to change or augment the functionality of a service; with Strategy, we can swap parts of an algorithm; with middleware, we can insert processing units in an existing pipeline. Also, streams can provide great extensibility thanks to their composable nature.","text_count":473,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are literally infinite ways to make an application extensible. For example, some of the design patterns we studied in Chapter 6,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Design Patterns,"}]},{"block_type":"text","content":"are meant exactly for this: using Proxy or Decorator we are able to change or augment the functionality of a service; with Strategy, we can swap parts of an algorithm; with middleware, we can insert processing units in an existing pipeline. Also, streams can provide great extensibility thanks to their composable nature."}]},{"block_type":"element","block":"k5zy5bvl","search_text":"On the other hand, EventEmitters allow us to decouple our components using events and the publish/subscribe pattern. Another important technique is to explicitly define in the application some points where new functionalities can be attached or the existing ones modified; these points in an application are commonly known as hooks. To summarize, the most important ingredient to support plugins is a set of extension points.","text_count":425,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other hand,"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"EventEmitters"}]},{"block_type":"text","content":"allow us to decouple our components using events and the publish/subscribe pattern. Another important technique is to explicitly define in the application some points where new functionalities can be attached or the existing ones modified; these points in an application are commonly known as hooks. To summarize, the most important ingredient to support plugins is a set of extension points."}]},{"block_type":"element","block":"k5zy5bvm","search_text":"The way we wire our components also plays a decisive role because it can affect the way we expose the services of the application to the plugin. In this section, we are mainly going to focus on this aspect.","text_count":206,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The way we wire our components also plays a decisive role because it can affect the way we expose the services of the application to the plugin. In this section, we are mainly going to focus on this aspect."}]},{"block_type":"element","block":"k5zy5bvn","search_text":"Plugin-controlled vs application-controlled extension","text_count":53,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Plugin-controlled vs application-controlled extension"}]},{"block_type":"element","block":"k5zy5bvo","search_text":"Before we go ahead and present some examples, it is important to understand the background of the technique we are going to use. There are mainly two approaches for extending the components of an application:","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Before we go ahead and present some examples, it is important to understand the background of the technique we are going to use. There are mainly two approaches for extending the components of an application:"}]},{"block_type":"element","block":"k5zy5bvp","search_text":"Explicit extension Extension through Inversion of Control ( IoC ) ","text_count":66,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Explicit extension"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Extension through Inversion of Control ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"IoC"}]},{"block_type":"text","content":")"}]}]},{"block_type":"element","block":"k5zy5bvq","search_text":"In the first case, we have a more specific component (the one providing the new functionality) explicitly extending the infrastructure, while in the second case, it is the infrastructure to control the extension by loading, installing, or executing the new specific component. In the second scenario, the flow of control is inverted, as shown in the following image:","text_count":366,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the first case, we have a more specific component (the one providing the new functionality) explicitly extending the infrastructure, while in the second case, it is the infrastructure to control the extension by loading, installing, or executing the new specific component. In the second scenario, the flow of control is inverted, as shown in the following image:"}]},{"block_type":"element","block":"k5zy5bvr","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000057.jpg","alt":"Plugin-controlled vs application-controlled extension","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5bvs","search_text":"IoC is a very broad principle that can be applied not only to the problem of application extensibility. In fact, in more general terms it can be said that by implementing some form of IoC, instead of the custom code controlling the infrastructure, the infrastructure controls the custom code. With IoC, the various components of an application trade off their power of controlling the flow in exchange for an improved level of decoupling. This is also known as the Hollywood principle or \" don't call us, we'll call you \".","text_count":522,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"IoC is a very broad principle that can be applied not only to the problem of application extensibility. In fact, in more general terms it can be said that by implementing some form of IoC, instead of the custom code controlling the infrastructure, the infrastructure controls the custom code. With IoC, the various components of an application trade off their power of controlling the flow in exchange for an improved level of decoupling. This is also known as the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Hollywood principle"}]},{"block_type":"text","content":"or \""},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"don't call us, we'll call you"}]},{"block_type":"text","content":"\"."}]},{"block_type":"element","block":"k5zy5bvt","search_text":"For example, a DI container is a demonstration of the IoC principle applied to the specific case of dependency management. The Observer pattern is another example of IoC applied to state management. Template, Strategy, State, and Middleware are also more localized manifestations of the same principle. The browser implements the IoC principle when dispatching UI events to the JavaScript code (it's not the JavaScript code actively polling the browser for events), and guess what, Node.js itself follows the IoC principle when controlling the execution of the various callbacks for us.","text_count":586,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For example, a DI container is a demonstration of the IoC principle applied to the specific case of dependency management. The Observer pattern is another example of IoC applied to state management. Template, Strategy, State, and Middleware are also more localized manifestations of the same principle. The browser implements the IoC principle when dispatching UI events to the JavaScript code (it's not the JavaScript code actively polling the browser for events), and guess what, Node.js itself follows the IoC principle when controlling the execution of the various callbacks for us."}]},{"block_type":"element","block":"k5zy5bvu","search_text":"Note To know more about the IoC principle, we advise you to study the topic directly from the words of its master, Martin Fowler, at http://martinfowler.com/bliki/InversionOfControl.html. ","text_count":188,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To know more about the IoC principle, we advise you to study the topic directly from the words of its master, Martin Fowler, at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://martinfowler.com/bliki/InversionOfControl.html"},"children":[{"block_type":"text","content":"http://martinfowler.com/bliki/InversionOfControl.html."}]}]}]},{"block_type":"element","block":"k5zy5bvv","search_text":"Applying this concept to the specific case of plugins, we can then identify two forms of extension:","text_count":99,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Applying this concept to the specific case of plugins, we can then identify two forms of extension:"}]},{"block_type":"element","block":"k5zy5bvw","search_text":"Plugin-controlled extension Application-controlled extension (IoC) ","text_count":67,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Plugin-controlled extension"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Application-controlled extension (IoC)"}]}]},{"block_type":"element","block":"k5zy5bvx","search_text":"In the first case, it is the plugin that taps into the components of the application to extend them as needed, while in the second case, the control is in the hands of the application, which integrates the plugin into one of its extension points.","text_count":246,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the first case, it is the plugin that taps into the components of the application to extend them as needed, while in the second case, the control is in the hands of the application, which integrates the plugin into one of its extension points."}]},{"block_type":"element","block":"k5zy5bvy","search_text":"To make a quick example, let's consider a plugin that extends the Express application with a new route. By using a plugin-controlled extension, this would look like the following:","text_count":179,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To make a quick example, let's consider a plugin that extends the Express application with a new route. By using a plugin-controlled extension, this would look like the following:"}]},{"block_type":"element","block":"k5zy5bvz","search_text":"//in the application: const app = express(); require('thePlugin')(app); //in the plugin: module.exports = function plugin(app) { app.get('/newRoute', function(req, res) {...}) }; ","text_count":179,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//in the application: \nconst app = express(); \nrequire('thePlugin')(app); \n \n//in the plugin: \nmodule.exports = function plugin(app) { \n  app.get('/newRoute', function(req, res) {...}) \n};"}]}]},{"block_type":"element","block":"k5zy5bw0","search_text":"If, instead, we want to use an application-controlled extension (IoC), the same preceding example would look like the following:","text_count":128,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If, instead, we want to use an application-controlled extension (IoC), the same preceding example would look like the following:"}]},{"block_type":"element","block":"k5zy5bw1","search_text":"//in the application: const app = express(); const plugin = require('thePlugin')(); app[plugin.method](plugin.route, plugin.handler); //in the plugin: module.exports = function plugin() { return { method: 'get', route: '/newRoute', handler: function(req, res) {...} } } ","text_count":270,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//in the application: \nconst app = express(); \nconst plugin = require('thePlugin')(); \napp[plugin.method](plugin.route, plugin.handler); \n \n//in the plugin: \nmodule.exports = function plugin() { \n  return { \n    method: 'get', \n    route: '/newRoute', \n    handler: function(req, res) {...} \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5bw2","search_text":"In the last code fragment, we saw how the plugin is only a passive player in the extension process; the control is in the hands of the application, which implements the framework to receive the plugin.","text_count":201,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the last code fragment, we saw how the plugin is only a passive player in the extension process; the control is in the hands of the application, which implements the framework to receive the plugin."}]},{"block_type":"element","block":"k5zy5bw3","search_text":"Based on the preceding example, we can immediately identify a few important differences between the two approaches:","text_count":115,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Based on the preceding example, we can immediately identify a few important differences between the two approaches:"}]},{"block_type":"element","block":"k5zy5bw4","search_text":"Plugin-controlled extension is more powerful and flexible, as often we have access to the internals of the application and we can move freely as if the plugin was actually a part of the application itself. However, this sometimes can be more of a liability than an advantage. In fact, any change in the application would have repercussions on the plugins more readily, requiring constant updates as the main application evolves. Application-controlled extension requires a plugin infrastructure in the main application. With a plugin-controlled extension, the only requirement is that the components of the application are extensible in some way. With a plugin-controlled extension, it becomes essential to share the internal services of the application with the plugin (in the preceding small example, the service to share was the app instance); otherwise, we would not be able to extend them. With an application-controlled extension, it might still be necessary to access some of the services of the application, not to extend but rather to use them. For example, we might want to query the db instance in our plugin or leverage the logger of the main application, just to name a few scenarios. ","text_count":1198,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Plugin-controlled extension"}]},{"block_type":"text","content":"is more powerful and flexible, as often we have access to the internals of the application and we can move freely as if the plugin was actually a part of the application itself. However, this sometimes can be more of a liability than an advantage. In fact, any change in the application would have repercussions on the plugins more readily, requiring constant updates as the main application evolves."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Application-controlled extension requires a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"plugin infrastructure"}]},{"block_type":"text","content":"in the main application. With a plugin-controlled extension, the only requirement is that the components of the application are extensible in some way."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"With a plugin-controlled extension, it becomes essential to share the internal services of the application with the plugin (in the preceding small example, the service to share was the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"instance); otherwise, we would not be able to extend them. With an application-controlled extension, it might still be necessary to access some of the services of the application, not to extend but rather to use them. For example, we might want to query the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"instance in our plugin or leverage the logger of the main application, just to name a few scenarios."}]}]},{"block_type":"element","block":"k5zy5bw5","search_text":"This last point should allow us to think about the importance of exposing the services of an application to the plugin—that's what we are mainly interested in exploring. The best way of doing this is to show a practical example of a plugin-controlled extension, which requires minimal effort in terms of infrastructure and we can emphasize more on the problem of sharing the application's state with the plugins.","text_count":412,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This last point should allow us to think about the importance of exposing the services of an application to the plugin&mdash;that's what we are mainly interested in exploring. The best way of doing this is to show a practical example of a plugin-controlled extension, which requires minimal effort in terms of infrastructure and we can emphasize more on the problem of sharing the application's state with the plugins."}]},{"block_type":"element","block":"k5zy5bw6","search_text":"Implementing a logout plugin","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Implementing a logout plugin"}]},{"block_type":"element","block":"k5zy5bw7","search_text":"Let's now start to work on a small plugin for our authentication server. With the way we originally created the application, it is not possible to explicitly invalidate a token; it simply becomes invalid when it expires. Now we want to add support for this feature, namely logout , and we want to do that by not modifying the code of the main application but rather delegating the task to an external plugin.","text_count":408,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now start to work on a small plugin for our authentication server. With the way we originally created the application, it is not possible to explicitly invalidate a token; it simply becomes invalid when it expires. Now we want to add support for this feature, namely"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"logout"}]},{"block_type":"text","content":", and we want to do that by not modifying the code of the main application but rather delegating the task to an external plugin."}]},{"block_type":"element","block":"k5zy5bw8","search_text":"To support this new feature, we need to save each token in the database after it is created and then check for its existence every time we want to validate it. To invalidate a token, we simply need to remove it from the database.","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To support this new feature, we need to save each token in the database after it is created and then check for its existence every time we want to validate it. To invalidate a token, we simply need to remove it from the database."}]},{"block_type":"element","block":"k5zy5bw9","search_text":"To do this, we are going to use a plugin-controlled extension to proxy the calls to authService.login() and authService.checkToken() . We then need to decorate the authService with a new method called logout() . After doing this, we also want to register a new route against the main Express server to expose a new endpoint ( /logout ), which we can use to invalidate a token using an HTTP request.","text_count":398,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To do this, we are going to use a plugin-controlled extension to proxy the calls to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService.login()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService.checkToken()"}]},{"block_type":"text","content":". We then need to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"decorate"}]},{"block_type":"text","content":"the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"with a new method called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"logout()"}]},{"block_type":"text","content":". After doing this, we also want to register a new route against the main Express server to expose a new endpoint ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/logout"}]},{"block_type":"text","content":"), which we can use to invalidate a token using an HTTP request."}]},{"block_type":"element","block":"k5zy5bwa","search_text":"We are going to implement the plugin we just described in four different variations:","text_count":84,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are going to implement the plugin we just described in four different variations:"}]},{"block_type":"element","block":"k5zy5bwb","search_text":"Using hardcoded dependencies Using dependency injection Using a service locator Using a DI container ","text_count":101,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using hardcoded dependencies"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using dependency injection"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using a service locator"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using a DI container"}]}]},{"block_type":"element","block":"k5zy5bwc","search_text":"Using hardcoded dependencies","text_count":28,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Using hardcoded dependencies"}]},{"block_type":"element","block":"k5zy5bwd","search_text":"The first variation of the plugin we are now going to implement covers the case in which our application mainly uses hardcoded dependencies for wiring its stateful modules. In this context, if our plugin lives in a package under the node_modules directory, to use the services of the main application we have to gain access to the parent package. We can do this in two ways:","text_count":374,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first variation of the plugin we are now going to implement covers the case in which our application mainly uses hardcoded dependencies for wiring its stateful modules. In this context, if our plugin lives in a package under the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules"}]},{"block_type":"text","content":"directory, to use the services of the main application we have to gain access to the parent package. We can do this in two ways:"}]},{"block_type":"element","block":"k5zy5bwe","search_text":"Using require() and navigating to the application's root using relative or absolute paths. Using require() by impersonating a module in the parent application—usually the module instantiating the plugin. This will allow us to easily gain access to all the services of the application by using require() , as if it was invoked by the parent application and not from the plugin. ","text_count":377,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"and navigating to the application's root using relative or absolute paths."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"by impersonating a module in the parent application&mdash;usually the module instantiating the plugin. This will allow us to easily gain access to all the services of the application by using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":", as if it was invoked by the parent application and not from the plugin."}]}]},{"block_type":"element","block":"k5zy5bwf","search_text":"The first technique is less robust as it assumes that the package is aware of the position of the main application. The module impersonation pattern can instead be used regardless of where the package is required from, and for this reason, this is the technique that we are going to use to implement the next demo.","text_count":314,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first technique is less robust as it assumes that the package is aware of the position of the main application. The module impersonation pattern can instead be used regardless of where the package is required from, and for this reason, this is the technique that we are going to use to implement the next demo."}]},{"block_type":"element","block":"k5zy5bwg","search_text":"To build our plugin, we first need to create a new package under the node_modules directory, named authsrv-plugin-logout . Before we start coding, we need to create a minimal package.json to describe the package, filling in only the essential parameters (the complete path to the file is : node_modules/authsrv-plugin-logout/package.json ):","text_count":340,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To build our plugin, we first need to create a new package under the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules"}]},{"block_type":"text","content":"directory, named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authsrv-plugin-logout"}]},{"block_type":"text","content":". Before we start coding, we need to create a minimal"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"package.json"}]},{"block_type":"text","content":"to describe the package, filling in only the essential parameters (the complete path to the file is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":": node_modules/authsrv-plugin-logout/package.json"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5bwh","search_text":"{ \"name\": \"authsrv-plugin-logout\", \"version\": \"0.0.0\" } ","text_count":56,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"{ \n  \"name\": \"authsrv-plugin-logout\", \n  \"version\": \"0.0.0\" \n}"}]}]},{"block_type":"element","block":"k5zy5bwi","search_text":"Now we are ready to create the main module of our plugin, we will use the file index.js , as it is the default module that Node.js will try to load when requiring the package (if no main property is defined in the package.json ). As always, the initial lines of the module are dedicated to loading the dependencies; pay attention to how we are going to require them (file node_modules/authsrv-plugin-logout/index.js ):","text_count":418,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to create the main module of our plugin, we will use the file"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.js"}]},{"block_type":"text","content":", as it is the default module that Node.js will try to load when requiring the package (if no"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main"}]},{"block_type":"text","content":"property is defined in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"package.json"}]},{"block_type":"text","content":"). As always, the initial lines of the module are dedicated to loading the dependencies; pay attention to how we are going to require them (file"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules/authsrv-plugin-logout/index.js"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5bwj","search_text":"const parentRequire = module.parent.require; const authService = parentRequire('./lib/authService'); const db = parentRequire('./lib/db'); const app = parentRequire('./app'); const tokensDb = db.sublevel('tokens'); ","text_count":215,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const parentRequire = module.parent.require; \n \nconst authService = parentRequire('./lib/authService'); \nconst db = parentRequire('./lib/db'); \nconst app = parentRequire('./app'); \n \nconst tokensDb = db.sublevel('tokens');"}]}]},{"block_type":"element","block":"k5zy5bwk","search_text":"The first line of code is what makes the difference. We obtain a reference to the require() function of the parent module, which is the one that loads the plugin. In our case, the parent is going to be the app module in the main application, and this means that every time we use parentRequire() , we are loading a module as if we were doing it from app.js .","text_count":358,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first line of code is what makes the difference. We obtain a reference to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"parent"}]},{"block_type":"text","content":"module, which is the one that loads the plugin. In our case, the parent is going to be the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module in the main application, and this means that every time we use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"parentRequire()"}]},{"block_type":"text","content":", we are loading a module as if we were doing it from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5bwl","search_text":"The next step is creating a proxy for the authService.login() method. After studying this pattern in Chapter 6, Design Patterns , we should already know how it works:","text_count":166,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next step is creating a proxy for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService.login()"}]},{"block_type":"text","content":"method. After studying this pattern in Chapter 6,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Design Patterns"}]},{"block_type":"text","content":", we should already know how it works:"}]},{"block_type":"element","block":"k5zy5bwm","search_text":"const oldLogin = authService.login; //[1] authService.login = (username, password, callback) => { oldLogin(username, password, (err, token) => { //[2] if(err) return callback(err); //[3] tokensDb.put(token, {username: username}, () => { callback(null, token); }); }); } ","text_count":270,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const oldLogin = authService.login;                    //[1] \nauthService.login = (username, password, callback) =&gt; { \n  oldLogin(username, password, (err, token) =&gt; {       //[2] \n    if(err) return callback(err);                      //[3] \n \n    tokensDb.put(token, {username: username}, () =&gt; { \n      callback(null, token); \n    }); \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5bwn","search_text":"In the preceding code, the steps performed are explained as follows:","text_count":68,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, the steps performed are explained as follows:"}]},{"block_type":"element","block":"k5zy5bwo","search_text":"We first save a reference to the old login() method and we then override it with our proxied version. In the proxy function, we invoke the original login() method by providing a custom callback so that we can intercept the original return value. If the original login() returns an error, we simply forward it to the callback; otherwise, we save the token into the database. ","text_count":374,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We first save a reference to the old"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"login()"}]},{"block_type":"text","content":"method and we then override it with our proxied version."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In the proxy function, we invoke the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"login()"}]},{"block_type":"text","content":"method by providing a custom callback so that we can intercept the original return value."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"login()"}]},{"block_type":"text","content":"returns an error, we simply forward it to the callback; otherwise, we save the token into the database."}]}]},{"block_type":"element","block":"k5zy5bwp","search_text":"Similarly, we need to intercept the calls to checkToken() so that we can add our custom logic:","text_count":94,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Similarly, we need to intercept the calls to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkToken()"}]},{"block_type":"text","content":"so that we can add our custom logic:"}]},{"block_type":"element","block":"k5zy5bwq","search_text":"const oldCheckToken = authService.checkToken; authService.checkToken = (token, callback) => { tokensDb.get(token, function(err, res) { if(err) return callback(err); oldCheckToken(token, callback); }); } ","text_count":203,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const oldCheckToken = authService.checkToken; \n \nauthService.checkToken = (token, callback) =&gt; { \n  tokensDb.get(token, function(err, res) { \n    if(err) return callback(err); \n \n    oldCheckToken(token, callback); \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5bwr","search_text":"This time, we first want to check whether the token exists in the database before giving control to the original checkToken() method. If the token is not found, the get() operation returns an error; this means that our token was invalidated and so we immediately return the error back to the callback.","text_count":301,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This time, we first want to check whether the token exists in the database before giving control to the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkToken()"}]},{"block_type":"text","content":"method. If the token is not found, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"get()"}]},{"block_type":"text","content":"operation returns an error; this means that our token was invalidated and so we immediately return the error back to the callback."}]},{"block_type":"element","block":"k5zy5bws","search_text":"To finalize the extension of the authService , we now need to decorate it with a new method, which we will use to invalidate a token:","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To finalize the extension of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":", we now need to decorate it with a new method, which we will use to invalidate a token:"}]},{"block_type":"element","block":"k5zy5bwt","search_text":"authService.logout = (token, callback) => { tokensDb.del(token, callback); } ","text_count":77,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"authService.logout = (token, callback) =&gt; { \n  tokensDb.del(token, callback); \n}"}]}]},{"block_type":"element","block":"k5zy5bwu","search_text":"The logout() method is very simple: we just delete the token from the database.","text_count":79,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"logout()"}]},{"block_type":"text","content":"method is very simple: we just delete the token from the database."}]},{"block_type":"element","block":"k5zy5bwv","search_text":"Finally, we can attach a new route to the Express server to expose the new functionality through a web service:","text_count":111,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, we can attach a new route to the Express server to expose the new functionality through a web service:"}]},{"block_type":"element","block":"k5zy5bww","search_text":"app.get('/logout', (req, res, next) => { authService.logout(req.query.token, function() { res.status(200).send({ok: true}); }); }); ","text_count":132,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"app.get('/logout', (req, res, next) =&gt; { \n  authService.logout(req.query.token, function() { \n    res.status(200).send({ok: true}); \n  }); \n});"}]}]},{"block_type":"element","block":"k5zy5bwx","search_text":"Now our plugin is ready to be attached to the main application. To do this we just need to go back to the main directory of the application and edit the app.js module:","text_count":167,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now our plugin is ready to be attached to the main application. To do this we just need to go back to the main directory of the application and edit the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5bwy","search_text":"// ... let app = module.exports = express(); app.use(bodyParser.json()); require('authsrv-plugin-logout'); app.post('/login', authController.login); app.all('/checkToken', authController.checkToken); // ... ","text_count":207,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \nlet app = module.exports = express(); \napp.use(bodyParser.json()); \n \nrequire('authsrv-plugin-logout'); \n \napp.post('/login', authController.login); \napp.all('/checkToken', authController.checkToken); \n// ..."}]}]},{"block_type":"element","block":"k5zy5bwz","search_text":"As we can see, to attach the plugin we only need to require it. As soon as this happens—during the startup of the application—the flow of control is given to the plugin, which in turn will extend the authService and the app modules, as we saw earlier.","text_count":251,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, to attach the plugin we only need to require it. As soon as this happens&mdash;during the startup of the application&mdash;the flow of control is given to the plugin, which in turn will extend the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authService"}]},{"block_type":"text","content":"and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"modules, as we saw earlier."}]},{"block_type":"element","block":"k5zy5bx0","search_text":"Now our authentication server also supports the invalidation of the token. We did that in a reusable way, the core of the application remained almost untouched, and we were able to easily apply the Proxy and Decorator patterns to extend its functionalities.","text_count":257,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now our authentication server also supports the invalidation of the token. We did that in a reusable way, the core of the application remained almost untouched, and we were able to easily apply the Proxy and Decorator patterns to extend its functionalities."}]},{"block_type":"element","block":"k5zy5bx1","search_text":"We can now try to start the application again:","text_count":46,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now try to start the application again:"}]},{"block_type":"element","block":"k5zy5bx2","search_text":"node app ","text_count":9,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app"}]}]},{"block_type":"element","block":"k5zy5bx3","search_text":"Then, we can verify that the new /logout web service actually exists and works as expected. Using curl , we can now try to obtain a new token using /login :","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can verify that the new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/logout"}]},{"block_type":"text","content":"web service actually exists and works as expected. Using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"curl"}]},{"block_type":"text","content":", we can now try to obtain a new token using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/login"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bx4","search_text":"curl -X POST -d '{\"username\": \"alice\", \"password\":\"secret\"}' http://localhost:3000/login -H \"Content-Type: application/json\" ","text_count":125,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -X POST -d '{\"username\": \"alice\", \"password\":\"secret\"}' http://localhost:3000/login -H \"Content-Type: application/json\""}]}]},{"block_type":"element","block":"k5zy5bx5","search_text":"Then, we can check whether the token is valid using /checkToken :","text_count":65,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can check whether the token is valid using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/checkToken"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bx6","search_text":"curl -X GET -H \"Accept: application/json\" http://localhost:3000/checkToken?token=<TOKEN HERE> ","text_count":94,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -X GET -H \"Accept: application/json\" http://localhost:3000/checkToken?token=&lt;TOKEN HERE&gt;"}]}]},{"block_type":"element","block":"k5zy5bx7","search_text":"Then, we can pass the token to the /logout endpoint to invalidate it; with curl , this can be done with a command such as this:","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can pass the token to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/logout"}]},{"block_type":"text","content":"endpoint to invalidate it; with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"curl"}]},{"block_type":"text","content":", this can be done with a command such as this:"}]},{"block_type":"element","block":"k5zy5bx8","search_text":"curl -X GET -H \"Accept: application/json\" http://localhost:3000/logout?token=<TOKEN HERE> ","text_count":90,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -X GET -H \"Accept: application/json\" http://localhost:3000/logout?token=&lt;TOKEN HERE&gt;"}]}]},{"block_type":"element","block":"k5zy5bx9","search_text":"Now, if we try to check the validity of the token again, we should get a negative response, confirming that our plugin is working perfectly.","text_count":140,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, if we try to check the validity of the token again, we should get a negative response, confirming that our plugin is working perfectly."}]},{"block_type":"element","block":"k5zy5bxa","search_text":"Even with a small plugin like the one we just implemented, the advantages of supporting plugin-based extensibility are clear. We also learned how to gain access to the services of the main application from another package using the module impersonation.","text_count":253,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even with a small plugin like the one we just implemented, the advantages of supporting plugin-based extensibility are clear. We also learned how to gain access to the services of the main application from another package using the module impersonation."}]},{"block_type":"element","block":"k5zy5bxb","search_text":"Note The module impersonation pattern is used by quite a few NodeBB plugins; you might want to check a couple of them in order to have an idea of how this is used in a real application. These are the links to some notable examples: nodebb-plugin-poll : https://github.com/Schamper/nodebb-plugin-poll/blob/b4a46561aff279e19c23b7c635fda5037c534b84/lib/nodebb.js nodebb-plugin-mentions : https://github.com/julianlam/nodebb-plugin-mentions/blob/9638118fa7e06a05ceb24eb521427440abd0dd8a/library.js#L4-13 ","text_count":500,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The module impersonation pattern is used by quite a few"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"NodeBB"}]},{"block_type":"text","content":"plugins; you might want to check a couple of them in order to have an idea of how this is used in a real application. These are the links to some notable examples:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"nodebb-plugin-poll"}]},{"block_type":"text","content":":"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/Schamper/nodebb-plugin-poll/blob/b4a46561aff279e19c23b7c635fda5037c534b84/lib/nodebb.js"},"children":[{"block_type":"text","content":"https://github.com/Schamper/nodebb-plugin-poll/blob/b4a46561aff279e19c23b7c635fda5037c534b84/lib/nodebb.js"}]},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"nodebb-plugin-mentions"}]},{"block_type":"text","content":":"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/julianlam/nodebb-plugin-mentions/blob/9638118fa7e06a05ceb24eb521427440abd0dd8a/library.js#L4-13"},"children":[{"block_type":"text","content":"https://github.com/julianlam/nodebb-plugin-mentions/blob/9638118fa7e06a05ceb24eb521427440abd0dd8a/library.js#L4-13"}]}]}]},{"block_type":"element","block":"k5zy5bxc","search_text":"Module impersonation is, of course, a form of hardcoded dependency and shares with it strengths and weaknesses. From one side, it allows us to access any service of the main application with little effort and minimal infrastructural requirements, but from the other, it creates a tight coupling, not only with a particular instance of a service but also with its location, which more easily exposes the plugin to changes and refactoring in the main application.","text_count":461,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Module impersonation is, of course, a form of hardcoded dependency and shares with it strengths and weaknesses. From one side, it allows us to access any service of the main application with little effort and minimal infrastructural requirements, but from the other, it creates a tight coupling, not only with a particular instance of a service but also with its location, which more easily exposes the plugin to changes and refactoring in the main application."}]},{"block_type":"element","block":"k5zy5bxd","search_text":"Exposing services using a service locator","text_count":41,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Exposing services using a service locator"}]},{"block_type":"element","block":"k5zy5bxe","search_text":"Similar to module impersonation, the service locator is also a good choice if we want to expose all the components of an application to its plugins, but on top of that, it has a major advantage, because a plugin can use the service locator to expose its own services to the application or even to other plugins.","text_count":311,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Similar to module impersonation, the service locator is also a good choice if we want to expose all the components of an application to its plugins, but on top of that, it has a major advantage, because a plugin can use the service locator to expose its own services to the application or even to other plugins."}]},{"block_type":"element","block":"k5zy5bxf","search_text":"Let's now refactor our logout plugin again to use a service locator. We'll refactor the main module of the plugin in the node_modules/authsrv-plugin-logout/index.js file:","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now refactor our logout plugin again to use a service locator. We'll refactor the main module of the plugin in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules/authsrv-plugin-logout/index.js"}]},{"block_type":"text","content":"file:"}]},{"block_type":"element","block":"k5zy5bxg","search_text":"module.exports = (serviceLocator) => { const authService = serviceLocator.get('authService'); const db = serviceLocator.get('db'); const app = serviceLocator.get('app'); const tokensDb = db.sublevel('tokens'); const oldLogin = authService.login; authService.login = (username, password, callback) => { //...same as in the previous version } const oldCheckToken = authService.checkToken; authService.checkToken = (token, callback) => { //...same as in the previous version } authService.logout = (token, callback) => { //...same as in the previous version } app.get('/logout', (req, res, next) => { //...same as in the previous version }); }; ","text_count":642,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = (serviceLocator) =&gt; { \n  const authService = serviceLocator.get('authService'); \n  const db = serviceLocator.get('db'); \n  const app = serviceLocator.get('app'); \n \n  const tokensDb = db.sublevel('tokens'); \n \n  const oldLogin = authService.login; \n  authService.login = (username, password, callback) =&gt; { \n    //...same as in the previous version \n  } \n \n  const oldCheckToken = authService.checkToken; \n  authService.checkToken = (token, callback) =&gt; { \n    //...same as in the previous version \n  } \n \n  authService.logout = (token, callback) =&gt; { \n    //...same as in the previous version \n  } \n \n  app.get('/logout', (req, res, next) =&gt; { \n    //...same as in the previous version \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5bxh","search_text":"Now that our plugin receives the service locator of the parent application as the input, it can access any of its services as needed. This means that the application does not have to know in advance what the plugin is going to need in terms of dependencies; this is surely a major advantage when implementing a plugin-controlled extension.","text_count":339,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that our plugin receives the service locator of the parent application as the input, it can access any of its services as needed. This means that the application does not have to know in advance what the plugin is going to need in terms of dependencies; this is surely a major advantage when implementing a plugin-controlled extension."}]},{"block_type":"element","block":"k5zy5bxi","search_text":"The next step is to execute the plugin from the main application, and to do that, we have to modify the app.js module. We will use the version of the authentication server already based on the service locator pattern. The required changes are given in the following block of code:","text_count":280,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next step is to execute the plugin from the main application, and to do that, we have to modify the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module. We will use the version of the authentication server already based on the service locator pattern. The required changes are given in the following block of code:"}]},{"block_type":"element","block":"k5zy5bxj","search_text":"// ... const svcLoc = require('./lib/serviceLocator')(); svcLoc.register(...); // ... svcLoc.register('app', app); const plugin = require('authsrv-plugin-logout'); plugin(svcLoc); // ... ","text_count":187,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \nconst svcLoc = require('./lib/serviceLocator')(); \nsvcLoc.register(...); \n// ... \n \nsvcLoc.register('app', app); \nconst plugin = require('authsrv-plugin-logout'); \nplugin(svcLoc); \n \n// ..."}]}]},{"block_type":"element","block":"k5zy5bxk","search_text":"The changes are highlighted in the preceding code; those changes enabled us to:","text_count":79,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The changes are highlighted in the preceding code; those changes enabled us to:"}]},{"block_type":"element","block":"k5zy5bxl","search_text":"Register the app module itself in the service locator, as the plugin might want to have access to it Require the plugin Invoke the plugin's main function by providing the service locator as an argument ","text_count":202,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Register the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module itself in the service locator, as the plugin might want to have access to it"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Require the plugin"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Invoke the plugin's main function by providing the service locator as an argument"}]}]},{"block_type":"element","block":"k5zy5bxm","search_text":"As we already said, the main strength of the service locator is that it provides a simple way to expose all the services of an application to its plugins, but it can also be used as a mechanism for sharing services from the plugin back into the parent application or even other plugins. This last consideration is probably the main strength of the service locator pattern in the context of plugin-based extensibility.","text_count":417,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we already said, the main strength of the service locator is that it provides a simple way to expose all the services of an application to its plugins, but it can also be used as a mechanism for sharing services from the plugin back into the parent application or even other plugins. This last consideration is probably the main strength of the service locator pattern in the context of plugin-based extensibility."}]},{"block_type":"element","block":"k5zy5bxn","search_text":"Exposing services using DI","text_count":26,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Exposing services using DI"}]},{"block_type":"element","block":"k5zy5bxo","search_text":"Using DI to propagate services to a plugin is as easy as using it in the application itself. This pattern becomes almost a requirement if it's already the main method for wiring dependencies in the parent application, but nothing prevents us from using it when the prevalent form of dependency management is hardcoded dependencies or a service locator. DI is also an ideal choice when we want to support an application-controlled extension because it provides better control over what is shared with the plugin.","text_count":511,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using DI to propagate services to a plugin is as easy as using it in the application itself. This pattern becomes almost a requirement if it's already the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main"}]},{"block_type":"text","content":"method for wiring dependencies in the parent application, but nothing prevents us from using it when the prevalent form of dependency management is hardcoded dependencies or a service locator. DI is also an ideal choice when we want to support an application-controlled extension because it provides better control over what is shared with the plugin."}]},{"block_type":"element","block":"k5zy5bxp","search_text":"To test these assumptions, let's immediately try to refactor the logout plugin to use DI. The changes required are minimal, so let's start from the main module of the plugin ( node_modules/authsrv-plugin-logout/index.js ):","text_count":222,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To test these assumptions, let's immediately try to refactor the logout plugin to use DI. The changes required are minimal, so let's start from the main module of the plugin ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node_modules/authsrv-plugin-logout/index.js"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5bxq","search_text":"module.exports = (app, authService, db) => { const tokensDb = db.sublevel('tokens'); const oldLogin = authService.login; authService.login = (username, password, callback) => { //...same as in the previous version } let oldCheckToken = authService.checkToken; authService.checkToken = (token, callback) => { //...same as in the previous version } authService.logout = (token, callback) => { //...same as in the previous version } app.get('/logout', (req, res, next) => { //...same as in the previous version }); }; ","text_count":515,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = (app, authService, db) =&gt; { \n  const tokensDb = db.sublevel('tokens'); \n \n  const oldLogin = authService.login; \n  authService.login = (username, password, callback) =&gt; { \n    //...same as in the previous version \n  } \n \n  let oldCheckToken = authService.checkToken; \n  authService.checkToken = (token, callback) =&gt; { \n    //...same as in the previous version \n  } \n \n  authService.logout = (token, callback) =&gt; { \n    //...same as in the previous version \n  } \n \n  app.get('/logout', (req, res, next) =&gt; { \n    //...same as in the previous version \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5bxr","search_text":"All we did is wrap the plugin's code into a factory that receives the services of the parent application as the input; the rest of it remains unchanged.","text_count":152,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All we did is wrap the plugin's code into a factory that receives the services of the parent application as the input; the rest of it remains unchanged."}]},{"block_type":"element","block":"k5zy5bxs","search_text":"To complete our refactoring, we also need to change the way we attach the plugin from the parent application; let's then change that one line where we require the plugin in the app.js module:","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To complete our refactoring, we also need to change the way we attach the plugin from the parent application; let's then change that one line where we require the plugin in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5bxt","search_text":"// ... const plugin = require('authsrv-plugin-logout'); plugin(app, authService, authController, db); // ... ","text_count":109,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \nconst plugin = require('authsrv-plugin-logout'); \nplugin(app, authService, authController, db); \n// ..."}]}]},{"block_type":"element","block":"k5zy5bxu","search_text":"We intentionally didn't show how these dependencies were obtained. In fact, it doesn't really make any difference, any method will equally work; we might use hardcoded dependencies or obtain the instances from factories or from a service locator—it doesn't really matter. This proves that DI is a flexible pattern when wiring plugins that can be used regardless of the way we wire the services in the parent application.","text_count":420,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We intentionally didn't show how these dependencies were obtained. In fact, it doesn't really make any difference, any method will equally work; we might use hardcoded dependencies or obtain the instances from factories or from a service locator&mdash;it doesn't really matter. This proves that DI is a flexible pattern when wiring plugins that can be used regardless of the way we wire the services in the parent application."}]},{"block_type":"element","block":"k5zy5bxv","search_text":"But the differences are much more profound. DI is definitely the cleanest way of providing a set of services to a plugin, but most importantly, it offers the best level of control over what's exposed to it, resulting in better information hiding and better protection against overly aggressive extensions. However, this can be also considered a drawback, because the main application can't always know what services the plugin is going to need, so we end up either injecting every service, which is impractical, or only a subset of them, for example, only the essential core services of the parent application. For this reason, DI is not the ideal choice if we mainly want to support plugin-controlled extensibility; however, the use of a DI container can easily solve these issues.","text_count":782,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But the differences are much more profound. DI is definitely the cleanest way of providing a set of services to a plugin, but most importantly, it offers the best level of control over what's exposed to it, resulting in better information hiding and better protection against overly aggressive extensions. However, this can be also considered a drawback, because the main application can't always know what services the plugin is going to need, so we end up either injecting every service, which is impractical, or only a subset of them, for example, only the essential core services of the parent application. For this reason, DI is not the ideal choice if we mainly want to support plugin-controlled extensibility; however, the use of a DI container can easily solve these issues."}]},{"block_type":"element","block":"k5zy5bxw","search_text":"Note Grunt ( http://gruntjs.com ), a task runner for Node.js, uses DI to provide each plugin with an instance of the core Grunt service. Each plugin can then extend it by attaching new tasks, using it to retrieve the configuration parameters, or running other tasks. A Grunt plugin looks like the following: module.exports = function(grunt) { grunt.registerMultiTask('taskName', 'description', function(...) {...} ); }; ","text_count":420,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Grunt ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://gruntjs.com"},"children":[{"block_type":"text","content":"http://gruntjs.com"}]},{"block_type":"text","content":"), a task runner for Node.js, uses DI to provide each plugin with an instance of the core Grunt service. Each plugin can then extend it by attaching new tasks, using it to retrieve the configuration parameters, or running other tasks. A Grunt plugin looks like the following:"}]},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = function(grunt) { \n&nbsp; grunt.registerMultiTask('taskName', 'description',\n&nbsp; &nbsp; function(...)&nbsp;{...}  \n&nbsp; );  \n};"}]}]}]},{"block_type":"element","block":"k5zy5bxx","search_text":"Exposing services using a DI container","text_count":38,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Exposing services using a DI container"}]},{"block_type":"element","block":"k5zy5bxy","search_text":"Taking the previous example as a starting point, we can use a DI container in combination with our plugin by applying a small change to the app module, as shown in the following code:","text_count":183,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Taking the previous example as a starting point, we can use a DI container in combination with our plugin by applying a small change to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module, as shown in the following code:"}]},{"block_type":"element","block":"k5zy5bxz","search_text":"// ... const diContainer = require('./lib/diContainer')(); diContainer.register(...); // ... //initialize the plugin diContainer.inject(require('authsrv-plugin-logout')); // ... ","text_count":178,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \nconst diContainer = require('./lib/diContainer')(); \ndiContainer.register(...); \n// ... \n//initialize the plugin \ndiContainer.inject(require('authsrv-plugin-logout')); \n// ..."}]}]},{"block_type":"element","block":"k5zy5by0","search_text":"After registering the factories or the instances of our application, all we have to do is instantiate the plugin, which is done by injecting its dependencies using the DI container. This way, each plugin can require its own set of dependencies without the parent application needing to know. All the wiring is again carried out automatically by the DI container.","text_count":362,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"After registering the factories or the instances of our application, all we have to do is instantiate the plugin, which is done by injecting its dependencies using the DI container. This way, each plugin can require its own set of dependencies without the parent application needing to know. All the wiring is again carried out automatically by the DI container."}]},{"block_type":"element","block":"k5zy5by1","search_text":"Using a DI container also means that each plugin can potentially access any service of the application, reducing the information hiding and the control over what can be used or extended. A possible solution to this problem is to create a separate DI container registering only the services that we want to expose to plugins; this way, we can control what each plugin can see of the main application. This demonstrates that a DI container can also be a very good choice in terms of encapsulation and information hiding.","text_count":518,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using a DI container also means that each plugin can potentially access any service of the application, reducing the information hiding and the control over what can be used or extended. A possible solution to this problem is to create a separate DI container registering only the services that we want to expose to plugins; this way, we can control what each plugin can see of the main application. This demonstrates that a DI container can also be a very good choice in terms of encapsulation and information hiding."}]},{"block_type":"element","block":"k5zy5by2","search_text":"This concludes our last refactoring of the logout plugin and the authentication server.","text_count":87,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This concludes our last refactoring of the logout plugin and the authentication server."}]},{"block_type":"element","block":"k5zy5by3","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5by4","search_text":"The topic of dependency wiring is certainly one of the most opinionated in software engineering, but in this chapter, we tried to keep the analysis as factual as possible to give an objective overview of the most important wiring patterns. We cleared some of the most common doubts around Singletons and instances in Node.js, and we learned how to connect modules using hardcoded dependencies, DI, and service locators. We practiced each technique using the authentication server as a playground, allowing us to identify the pros and cons of each approach.","text_count":556,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The topic of dependency wiring is certainly one of the most opinionated in software engineering, but in this chapter, we tried to keep the analysis as factual as possible to give an objective overview of the most important wiring patterns. We cleared some of the most common doubts around Singletons and instances in Node.js, and we learned how to connect modules using hardcoded dependencies, DI, and service locators. We practiced each technique using the authentication server as a playground, allowing us to identify the pros and cons of each approach."}]},{"block_type":"element","block":"k5zy5by5","search_text":"In the second part of the chapter, we learned how an application can support plugins, but most importantly, how we can wire those plugins into the main application. We applied the same techniques presented in the first part of the chapter but analyzed them from another perspective. We discovered how important it can be for a plugin to have access to the right services of the main application and how much this can impact its capabilities.","text_count":441,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the second part of the chapter, we learned how an application can support plugins, but most importantly, how we can wire those plugins into the main application. We applied the same techniques presented in the first part of the chapter but analyzed them from another perspective. We discovered how important it can be for a plugin to have access to the right services of the main application and how much this can impact its capabilities."}]},{"block_type":"element","block":"k5zy5by6","search_text":"By the end of this chapter, we should feel comfortable in choosing the best approach for the level of decoupling, reusability, and simplicity we want to obtain in our application. We can also consider using more than one pattern in the same application. For example, we can use hardcoded dependencies as the main technique and then use a service locator when it comes to linking plugins; there are really no limits to what we can do now that we know the best use case for each approach.","text_count":486,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By the end of this chapter, we should feel comfortable in choosing the best approach for the level of decoupling, reusability, and simplicity we want to obtain in our application. We can also consider using more than one pattern in the same application. For example, we can use hardcoded dependencies as the main technique and then use a service locator when it comes to linking plugins; there are really no limits to what we can do now that we know the best use case for each approach."}]},{"block_type":"element","block":"k5zy5by7","search_text":"So far in this book, we have focused our analysis on highly generic and customizable patterns, but from the next chapter onwards, we will shift our attention to solving more specific technical problems. What comes next is, in fact, a collection of recipes which can be used to solve specific issues related to CPU-bound tasks, asynchronous caching, and sharing code with the browser.","text_count":383,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So far in this book, we have focused our analysis on highly generic and customizable patterns, but from the next chapter onwards, we will shift our attention to solving more specific technical problems. What comes next is, in fact, a collection of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"recipes"}]},{"block_type":"text","content":"which can be used to solve specific issues related to CPU-bound tasks, asynchronous caching, and sharing code with the browser."}]}]},{"title":"Universal Javascript for Web Application","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4msc","number":8,"contents":[{"block_type":"element","block":"k5zy5by8","search_text":"JavaScript was born in 1995 with the original goal of giving web developers the power to execute code directly in the browser and build more dynamic and interactive websites.","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"JavaScript was born in 1995 with the original goal of giving web developers the power to execute code directly in the browser and build more dynamic and interactive websites."}]},{"block_type":"element","block":"k5zy5by9","search_text":"Since then, JavaScript has grown up a lot and it is today one of the most famous and widespread languages in the world. If, at the very beginning, JavaScript was a very simple and limited language, today it can be considered a complete general purpose language that can be used even outside the browser to build almost any kind of application. In fact, JavaScript now powers frontend applications, web servers, and mobile applications, as well as embedded devices such as wearable devices, thermostats, and flying drones.","text_count":521,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Since then, JavaScript has grown up a lot and it is today one of the most famous and widespread languages in the world. If, at the very beginning, JavaScript was a very simple and limited language, today it can be considered a complete general purpose language that can be used even outside the browser to build almost any kind of application. In fact, JavaScript now powers frontend applications, web servers, and mobile applications, as well as embedded devices such as wearable devices, thermostats, and flying drones."}]},{"block_type":"element","block":"k5zy5bya","search_text":"This availability across platforms and devices is fostering a new trend among JavaScript developers, which is being able to simplify code reuse across different environments in the same project. The most meaningful case in relation to Node.js regards the opportunity to build web applications where it is easy to share code between the server (backend) and the browser (frontend). This quest for code reuse was originally identified with the term Isomorphic JavaScript , but it's now widely recognized as Universal JavaScript .","text_count":527,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This availability across platforms and devices is fostering a new trend among JavaScript developers, which is being able to simplify code reuse across different environments in the same project. The most meaningful case in relation to Node.js regards the opportunity to build web applications where it is easy to share code between the server (backend) and the browser (frontend). This quest for code reuse was originally identified with the term"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Isomorphic JavaScript"}]},{"block_type":"text","content":", but it's now widely recognized as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Universal JavaScript"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5byb","search_text":"In this chapter, we are going to explore the wonders of Universal JavaScript, specifically in the field of web development, and discover many tools and techniques to be able to share most of our code between the server and the browser.","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we are going to explore the wonders of Universal JavaScript, specifically in the field of web development, and discover many tools and techniques to be able to share most of our code between the server and the browser."}]},{"block_type":"element","block":"k5zy5byc","search_text":"In particular, we are going to learn how modules can be used both on the server and the client and how to use tools such as Webpack and Babel to package them for the browser. We will adopt the React library and other famous modules to build the web interface and share the state of the web server with the frontend, and finally we are going to explore some interesting solutions to enable universal routing and universal data retrieval within our apps.","text_count":452,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In particular, we are going to learn how modules can be used both on the server and the client and how to use tools such as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Webpack"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Babel"}]},{"block_type":"text","content":"to package them for the browser. We will adopt the React library and other famous modules to build the web interface and share the state of the web server with the frontend, and finally we are going to explore some interesting solutions to enable universal routing and universal data retrieval within our apps."}]},{"block_type":"element","block":"k5zy5byd","search_text":"At the end of this chapter, we should be able to write React-powered Single-Page Applications ( SPAs ) that reuse most of the code that is already present in our Node.js server, resulting in applications that are consistent, easy to reason about, and easy to maintain.","text_count":268,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At the end of this chapter, we should be able to write React-powered"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Single-Page Applications"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"SPAs"}]},{"block_type":"text","content":") that reuse most of the code that is already present in our Node.js server, resulting in applications that are consistent, easy to reason about, and easy to maintain."}]},{"block_type":"element","block":"k5zy5bye","search_text":"Sharing code with the browser","text_count":29,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Sharing code with the browser"}]},{"block_type":"element","block":"k5zy5byf","search_text":"One of the main selling points of Node.js is the fact that it's based on JavaScript and runs on V8, an engine that actually powers one of the most popular browsers: Chrome. We might think that that's enough to conclude that sharing code between Node.js and the browser is an easy task; however, as we will see, this is not always true, unless we want to share only small, self-contained, and generic fragments of code. Developing code for both the client and the server requires a non-negligible level of effort in making sure that the same code can run properly in two environments that are intrinsically different. For example, in Node.js we don't have the DOM or long-living views, while in the browser we surely don't have the filesystem or the ability to start new processes. Moreover, we need to consider that we can safely use many of the new ES2015 features in Node.js. We cannot do the same in the browser, as the majority of browsers are still stuck with ES5, and running ES5 code in the client will remain the safest option for a relatively long time before ES2015-enabled web browsers are ubiquitous.","text_count":1112,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the main selling points of Node.js is the fact that it's based on JavaScript and runs on V8, an engine that actually powers one of the most popular browsers: Chrome. We might think that that's enough to conclude that sharing code between Node.js and the browser is an easy task; however, as we will see, this is not always true, unless we want to share only small, self-contained, and generic fragments of code. Developing code for both the client and the server requires a non-negligible level of effort in making sure that the same code can run properly in two environments that are intrinsically different. For example, in Node.js we don't have the DOM or long-living views, while in the browser we surely don't have the filesystem or the ability to start new processes. Moreover, we need to consider that we can safely use many of the new ES2015 features in Node.js. We cannot do the same in the browser, as the majority of browsers are still stuck with ES5, and running ES5 code in the client will remain the safest option for a relatively long time before ES2015-enabled web browsers are ubiquitous."}]},{"block_type":"element","block":"k5zy5byg","search_text":"So, most of the effort required when developing for both platforms is making sure to reduce those differences to a minimum. This can be done with the help of abstractions and patterns that enable the application to switch, dynamically or at build time, between the browser-compatible code and the Node.js code.","text_count":310,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So, most of the effort required when developing for both platforms is making sure to reduce those differences to a minimum. This can be done with the help of abstractions and patterns that enable the application to switch, dynamically or at build time, between the browser-compatible code and the Node.js code."}]},{"block_type":"element","block":"k5zy5byh","search_text":"Luckily, with the rising interest in this new mind-blowing possibility, many libraries and frameworks in the ecosystem have started to support both environments. This evolution is also backed by a growing number of tools supporting this new kind of workflow, which over the years have been refined and perfected. This means that if we are using an npm package on Node.js, there is a good probability that it will work seamlessly on the browser as well. However, this is often not enough to guarantee that our application can run without problems on both the browser and Node.js. As we will see, a careful design is always needed when developing cross-platform code.","text_count":665,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Luckily, with the rising interest in this new mind-blowing possibility, many libraries and frameworks in the ecosystem have started to support both environments. This evolution is also backed by a growing number of tools supporting this new kind of workflow, which over the years have been refined and perfected. This means that if we are using an npm package on Node.js, there is a good probability that it will work seamlessly on the browser as well. However, this is often not enough to guarantee that our application can run without problems on both the browser and Node.js. As we will see, a careful design is always needed when developing cross-platform code."}]},{"block_type":"element","block":"k5zy5byi","search_text":"In this section, we are going to explore the fundamental problems we might encounter when writing code for both Node.js and the browser, and we are going to propose some tools and patterns that can help us in tackling this new and exciting challenge.","text_count":250,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we are going to explore the fundamental problems we might encounter when writing code for both Node.js and the browser, and we are going to propose some tools and patterns that can help us in tackling this new and exciting challenge."}]},{"block_type":"element","block":"k5zy5byj","search_text":"Sharing modules","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sharing modules"}]},{"block_type":"element","block":"k5zy5byk","search_text":"The first wall we hit when we want to share some code between the browser and the server is the mismatch between the module system used by Node.js and the heterogeneous landscape of the module systems used in the browser. Another problem is that in the browser, we don't have a require() function or the filesystem from which we can resolve modules. So, if we want to write large portions of code that can work on both platforms and we want to continue to use the CommonJS module system, we need to take an extra step—we need a tool to help us in bundling all the dependencies together at build time and abstracting the require() mechanism on the browser.","text_count":655,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first wall we hit when we want to share some code between the browser and the server is the mismatch between the module system used by Node.js and the heterogeneous landscape of the module systems used in the browser. Another problem is that in the browser, we don't have a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function or the filesystem from which we can resolve modules. So, if we want to write large portions of code that can work on both platforms and we want to continue to use the CommonJS module system, we need to take an extra step&mdash;we need a tool to help us in bundling all the dependencies together at build time and abstracting the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"mechanism on the browser."}]},{"block_type":"element","block":"k5zy5byl","search_text":"Universal Module Definition","text_count":27,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Universal Module Definition"}]},{"block_type":"element","block":"k5zy5bym","search_text":"In Node.js, we know perfectly well that the CommonJS modules are the default mechanism for establishing dependencies between components. The situation in browser-space is unfortunately way more fragmented:","text_count":205,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Node.js, we know perfectly well that the CommonJS modules are the default mechanism for establishing dependencies between components. The situation in"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"browser-space"}]},{"block_type":"text","content":"is unfortunately way more fragmented:"}]},{"block_type":"element","block":"k5zy5byn","search_text":"We might have an environment with no module system at all, which means that globals are the main mechanism to access other modules We might have an environment based on an Asynchronous Module Definition ( AMD ) loader, for example, RequireJS ( http://requirejs.org ) We might have an environment abstracting the CommonJS module system ","text_count":335,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We might have an environment with no module system at all, which means that globals are the main mechanism to access other modules"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We might have an environment based on an"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Module Definition"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"AMD"}]},{"block_type":"text","content":") loader, for example, RequireJS ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://requirejs.org"},"children":[{"block_type":"text","content":"http://requirejs.org"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We might have an environment abstracting the CommonJS module system"}]}]},{"block_type":"element","block":"k5zy5byo","search_text":"Luckily, there is a pattern called Universal Module Definition ( UMD ) that can help us abstract our code from the module system used in the environment.","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Luckily, there is a pattern called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Universal Module Definition"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"UMD"}]},{"block_type":"text","content":") that can help us abstract our code from the module system used in the environment."}]},{"block_type":"element","block":"k5zy5byp","search_text":"Creating an UMD module","text_count":22,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Creating an UMD module"}]},{"block_type":"element","block":"k5zy5byq","search_text":"UMD is not quite standardized yet, so there might be many variations that depend on the needs of the component and the module systems it has to support. However, there is one form that is probably the most popular and also allows us to support the most common module systems, such as AMD, CommonJS, and browser globals.","text_count":319,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"UMD is not quite standardized yet, so there might be many variations that depend on the needs of the component and the module systems it has to support. However, there is one form that is probably the most popular and also allows us to support the most common module systems, such as AMD, CommonJS, and browser globals."}]},{"block_type":"element","block":"k5zy5byr","search_text":"Let's see a simple example of how it looks. In a new project, let's create a new module called umdModule.js :","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see a simple example of how it looks. In a new project, let's create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"umdModule.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5bys","search_text":"(function(root, factory) { //[1] if(typeof define === 'function' && define.amd) { //[2] define(['mustache'], factory); } else if(typeof module === 'object' && //[3] typeof module.exports === 'object') { var mustache = require('mustache'); module.exports = factory(mustache); } else { //[4] root.UmdModule = factory(root.Mustache); } }(this, function(mustache) { //[5] var template = '<h1>Hello <i>{{name}}</i></h1>'; mustache.parse(template); return { sayHello:function(toWhom) { return mustache.render(template, {name: toWhom}); } }; })); ","text_count":540,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"(function(root, factory) {                           //[1] \n  if(typeof define === 'function' && define.amd) {   //[2] \n    define(['mustache'], factory); \n  } else if(typeof module === 'object' &&            //[3] \n      typeof module.exports === 'object') { \n    var mustache = require('mustache'); \n    module.exports = factory(mustache); \n  } else {                                           //[4] \n    root.UmdModule = factory(root.Mustache); \n  } \n}(this, function(mustache) {                         //[5] \n  var template = '&lt;h1&gt;Hello &lt;i&gt;{{name}}&lt;/i&gt;&lt;/h1&gt;'; \n  mustache.parse(template); \n \n  return { \n    sayHello:function(toWhom) { \n      return mustache.render(template, {name: toWhom}); \n    } \n  }; \n}));"}]}]},{"block_type":"element","block":"k5zy5byt","search_text":"The preceding example defines a simple module with one external dependency: mustache ( http://mustache.github.io ), which is a simple template engine. The final product of the preceding UMD module is an object with one method called sayHello() that will render a mustache template and return it to the caller. The goal of UMD is integrating the module with other module systems available on the environment. This is how it works:","text_count":429,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding example defines a simple module with one external dependency:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mustache"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://mustache.github.io"},"children":[{"block_type":"text","content":"http://mustache.github.io"}]},{"block_type":"text","content":"), which is a simple template engine. The final product of the preceding UMD module is an object with one method called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sayHello()"}]},{"block_type":"text","content":"that will render a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mustache"}]},{"block_type":"text","content":"template and return it to the caller. The goal of UMD is integrating the module with other module systems available on the environment. This is how it works:"}]},{"block_type":"element","block":"k5zy5byu","search_text":"All the code is wrapped in an anonymous self-executing function, very similar to the Revealing Module pattern we have seen in Chapter 2, Node.js Essential Patterns . The function accepts a root that is the global namespace object available on the system (for example, window on the browser). This is needed mainly for registering the dependency as a global variable, as we will see in a moment. The second argument is factory() of the module, a function returning an instance of the module and accepting its dependencies as input (Dependency Injection). The first thing we do is check whether AMD is available on the system. We do this by verifying the existence of the define function and its amd flag. If found, it means that we have an AMD loader on the system, so we proceed with registering our module using define and requiring the dependency mustache to be injected into factory() . We then check whether we are in a Node.js-flavored CommonJS environment by checking the existence of the module and module.exports objects. If that's the case, we load the dependencies of the module using require() and provide them to the factory() . The return value of the factory is then assigned to module.exports . Lastly, if we have neither AMD nor CommonJS, we proceed with assigning the module to a global variable, using the root object, which in a browser environment will usually be the window object. In addition, you can see how the dependency, Mustache , is expected to be in the global scope. As a final step, the wrapper function is self-invoked, providing the this object as root (in the browser, it will be the window object) and providing our module factory as a second argument. You can see how the factory accepts its dependencies as arguments. ","text_count":1756,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"All the code is wrapped in an anonymous self-executing function, very similar to the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Revealing Module"}]},{"block_type":"text","content":"pattern we have seen in Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Essential Patterns"}]},{"block_type":"text","content":". The function accepts a root that is the global namespace object available on the system (for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"window"}]},{"block_type":"text","content":"on the browser). This is needed mainly for registering the dependency as a global variable, as we will see in a moment. The second argument is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"factory()"}]},{"block_type":"text","content":"of the module, a function returning an instance of the module and accepting its dependencies as input (Dependency Injection)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The first thing we do is check whether AMD is available on the system. We do this by verifying the existence of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"define"}]},{"block_type":"text","content":"function and its"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"amd"}]},{"block_type":"text","content":"flag. If found, it means that we have an AMD loader on the system, so we proceed with registering our module using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"define"}]},{"block_type":"text","content":"and requiring the dependency"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mustache"}]},{"block_type":"text","content":"to be injected into"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"factory()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We then check whether we are in a Node.js-flavored CommonJS environment by checking the existence of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"objects. If that's the case, we load the dependencies of the module using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"and provide them to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"factory()"}]},{"block_type":"text","content":". The return value of the factory is then assigned to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Lastly, if we have neither AMD nor CommonJS, we proceed with assigning the module to a global variable, using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"root"}]},{"block_type":"text","content":"object, which in a browser environment will usually be the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"window"}]},{"block_type":"text","content":"object. In addition, you can see how the dependency,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Mustache"}]},{"block_type":"text","content":", is expected to be in the global scope."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"As a final step, the wrapper function is self-invoked, providing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this"}]},{"block_type":"text","content":"object as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"root"}]},{"block_type":"text","content":"(in the browser, it will be the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"window"}]},{"block_type":"text","content":"object) and providing our module factory as a second argument. You can see how the factory accepts its dependencies as arguments."}]}]},{"block_type":"element","block":"k5zy5byv","search_text":"It's also worth underlining that in the module, we haven't used any ES2015 feature. This is to guarantee that the code will run fine even in the browser without any modification.","text_count":178,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's also worth underlining that in the module, we haven't used any ES2015 feature. This is to guarantee that the code will run fine even in the browser without any modification."}]},{"block_type":"element","block":"k5zy5byw","search_text":"Now, let's see how we can use this UMD module in both Node.js and the browser.","text_count":78,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's see how we can use this UMD module in both Node.js and the browser."}]},{"block_type":"element","block":"k5zy5byx","search_text":"First of all, we create a new testServer.js file:","text_count":49,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First of all, we create a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"testServer.js"}]},{"block_type":"text","content":"file:"}]},{"block_type":"element","block":"k5zy5byy","search_text":"const umdModule = require('./umdModule'); console.log(umdModule.sayHello('Server!')); ","text_count":86,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const umdModule = require('./umdModule'); \nconsole.log(umdModule.sayHello('Server!'));"}]}]},{"block_type":"element","block":"k5zy5byz","search_text":"If we execute this script, it will output the following:","text_count":56,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we execute this script, it will output the following:"}]},{"block_type":"element","block":"k5zy5bz0","search_text":"<h1>Hello <i>Server!</i></h1> ","text_count":30,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&lt;h1&gt;Hello &lt;i&gt;Server!&lt;/i&gt;&lt;/h1&gt;"}]}]},{"block_type":"element","block":"k5zy5bz1","search_text":"If we want to use our freshly baked module on the client as well, we can create a testBrowser.html page with the following content:","text_count":131,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we want to use our freshly baked module on the client as well, we can create a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"testBrowser.html"}]},{"block_type":"text","content":"page with the following content:"}]},{"block_type":"element","block":"k5zy5bz2","search_text":"<html> <head> <script src=\"node_modules/mustache/mustache.js\"></script> <script src=\"umdModule.js\"></script> </head> <body> <div id=\"main\"></div> <script> document.getElementById('main').innerHTML = UmdModule.sayHello('Browser!'); </script> </body> </html> ","text_count":257,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&lt;html&gt; \n  &lt;head&gt; \n    &lt;script src=\"node_modules/mustache/mustache.js\"&gt;&lt;/script&gt; \n    &lt;script src=\"umdModule.js\"&gt;&lt;/script&gt; \n  &lt;/head&gt; \n  &lt;body&gt; \n    &lt;div id=\"main\"&gt;&lt;/div&gt; \n    &lt;script&gt; \n       document.getElementById('main').innerHTML = \n         UmdModule.sayHello('Browser!'); \n    &lt;/script&gt; \n  &lt;/body&gt; \n&lt;/html&gt;"}]}]},{"block_type":"element","block":"k5zy5bz3","search_text":"This will produce a page with a big fancy Hello Browser! as the title of the page.","text_count":82,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This will produce a page with a big fancy"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Hello Browser!"}]},{"block_type":"text","content":"as the title of the page."}]},{"block_type":"element","block":"k5zy5bz4","search_text":"What has happened here is that we included our dependencies ( mustache and our umdModule ) as regular scripts in the head of the page and we then created a small inline script that uses UmdModule (available as a global variable in the browser) to generate some HTML code that was then placed inside the main block.","text_count":314,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What has happened here is that we included our dependencies ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mustache"}]},{"block_type":"text","content":"and our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"umdModule"}]},{"block_type":"text","content":") as regular scripts in the head of the page and we then created a small inline script that uses"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"UmdModule"}]},{"block_type":"text","content":"(available as a global variable in the browser) to generate some HTML code that was then placed inside the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main"}]},{"block_type":"text","content":"block."}]},{"block_type":"element","block":"k5zy5bz5","search_text":"Tip In the code examples available for this book on the Packt Publishing website, you can find other examples showing how the UMD module we just created can also be used in combination with an AMD loader and a CommonJS system. ","text_count":227,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the code examples available for this book on the Packt Publishing website, you can find other examples showing how the UMD module we just created can also be used in combination with an AMD loader and a CommonJS system."}]}]},{"block_type":"element","block":"k5zy5bz6","search_text":"Considerations on the UMD pattern","text_count":33,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Considerations on the UMD pattern"}]},{"block_type":"element","block":"k5zy5bz7","search_text":"The UMD pattern is an effective and simple technique used for creating a module compatible with the most popular module systems out there. However, we have seen that it requires a lot of boilerplate, which can be difficult to test in each environment and is inevitably error-prone. This means that writing the UMD boilerplate manually can make sense for wrapping a single module which has already been developed and tested. It is not a practice to use when we are writing a new module from scratch; it is unfeasible and impractical, so in these situations, it is better to leave the task to tools that can help us automate the process. One of those tools is Webpack, which we will use in this chapter.","text_count":701,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The UMD pattern is an effective and simple technique used for creating a module compatible with the most popular module systems out there. However, we have seen that it requires a lot of boilerplate, which can be difficult to test in each environment and is inevitably error-prone. This means that writing the UMD boilerplate manually can make sense for wrapping a single module which has already been developed and tested. It is not a practice to use when we are writing a new module from scratch; it is unfeasible and impractical, so in these situations, it is better to leave the task to tools that can help us automate the process. One of those tools is Webpack, which we will use in this chapter."}]},{"block_type":"element","block":"k5zy5bz8","search_text":"We should also mention that AMD, CommonJS, and browser globals are not the only module systems out there. The pattern we have presented will cover most of the use cases, but it requires adaptations to support any other module system. For example, the ES2015 module specification is something that we are going to discuss in the next section of the chapter as it offers a number of advantages over other solutions and it is already part of the new ECMAScript standard (even if at the time of writing it is not natively supported in Node.js).","text_count":540,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We should also mention that AMD, CommonJS, and browser globals are not the only module systems out there. The pattern we have presented will cover most of the use cases, but it requires adaptations to support any other module system. For example, the ES2015 module specification is something that we are going to discuss in the next section of the chapter as it offers a number of advantages over other solutions and it is already part of the new ECMAScript standard (even if at the time of writing it is not natively supported in Node.js)."}]},{"block_type":"element","block":"k5zy5bz9","search_text":"Tip You can find a broad list of formalized UMD patterns at https://github.com/umdjs/umd . ","text_count":91,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can find a broad list of formalized UMD patterns at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/umdjs/umd"},"children":[{"block_type":"text","content":"https://github.com/umdjs/umd"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5bza","search_text":"ES2015 modules","text_count":14,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"ES2015 modules"}]},{"block_type":"element","block":"k5zy5bzb","search_text":"One of the features introduced by the ES2015 specification is a built-in module system . This is the first time we will encounter it in this book because, unfortunately, at the time of writing, ES2015 modules are still not supported in the current version of Node.js.","text_count":267,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the features introduced by the ES2015 specification is a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"built-in module system"}]},{"block_type":"text","content":". This is the first time we will encounter it in this book because, unfortunately, at the time of writing, ES2015 modules are still not supported in the current version of Node.js."}]},{"block_type":"element","block":"k5zy5bzc","search_text":"We will not describe this feature in detail here but it is important to know about it because it will most likely become the go-to module syntax for years to come. Apart from being standard, ES2015 modules introduce a nicer syntax and a number of advantages over the other module systems we just discussed.","text_count":306,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will not describe this feature in detail here but it is important to know about it because it will most likely become the go-to module syntax for years to come. Apart from being standard, ES2015 modules introduce a nicer syntax and a number of advantages over the other module systems we just discussed."}]},{"block_type":"element","block":"k5zy5bzd","search_text":"The goal for ES2015 modules was to take the best out of CommonJS and AMD modules:","text_count":81,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The goal for ES2015 modules was to take the best out of CommonJS and AMD modules:"}]},{"block_type":"element","block":"k5zy5bze","search_text":"Like CommonJS, this specification provides a compact syntax, a preference for single exports, and support for cyclic dependencies Like AMD, it offers direct support for asynchronous loading and configurable module loading ","text_count":222,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Like CommonJS, this specification provides a compact syntax, a preference for single exports, and support for cyclic dependencies"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Like AMD, it offers direct support for asynchronous loading and configurable module loading"}]}]},{"block_type":"element","block":"k5zy5bzf","search_text":"Moreover, thanks to the declarative syntax, it is possible to use static analyzers to perform tasks such as static checking and optimizations. For instance, it is possible to analyze the dependency tree of a script and create a bundled file for the browser where all the unused functions of the imported modules are stripped, thus providing a more compact file on the client and reducing load times.","text_count":399,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Moreover, thanks to the declarative syntax, it is possible to use static analyzers to perform tasks such as static checking and optimizations. For instance, it is possible to analyze the dependency tree of a script and create a bundled file for the browser where all the unused functions of the imported modules are stripped, thus providing a more compact file on the client and reducing load times."}]},{"block_type":"element","block":"k5zy5bzg","search_text":"Note To learn more about the syntax of the ES2015 modules you can have a look at the ES2015 specification: http://www.ecma-international.org/ecma-262/6.0/#sec-scripts-and-modules . ","text_count":181,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To learn more about the syntax of the ES2015 modules you can have a look at the ES2015 specification:"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.ecma-international.org/ecma-262/6.0/#sec-scripts-and-modules"},"children":[{"block_type":"text","content":"http://www.ecma-international.org/ecma-262/6.0/#sec-scripts-and-modules"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5bzh","search_text":"Today, you can also use the new module syntax in Node.js, adopting a transpiler such as Babel . Actually, many developers are advocating it while presenting their own solutions for building Universal JavaScript apps. It's generally a good idea to be future-proof, especially because this feature is already standardized and will eventually be part of the Node.js core. For the sake of simplicity, we will stick to the CommonJS syntax also all over this chapter.","text_count":461,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Today, you can also use the new module syntax in Node.js, adopting a transpiler such as Babel"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"."}]},{"block_type":"text","content":"Actually, many developers are advocating it while presenting their own solutions for building Universal JavaScript apps. It's generally a good idea to be future-proof, especially because this feature is already standardized and will eventually be part of the Node.js core. For the sake of simplicity, we will stick to the CommonJS syntax also all over this chapter."}]},{"block_type":"element","block":"k5zy5bzi","search_text":"Introducing Webpack","text_count":19,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Introducing Webpack"}]},{"block_type":"element","block":"k5zy5bzj","search_text":"When writing a Node.js application, the last thing we want to do is to manually add support for a module system different from the one offered as default by the platform. The ideal situation would be to continue writing our modules as we have always done, using require() and module.exports , and then use a tool to transform our code into a bundle that can easily run in the browser. Luckily, this problem has already been solved by many projects, among which Webpack ( https://webpack.github.io ) is one of the most popular and broadly adopted.","text_count":546,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When writing a Node.js application, the last thing we want to do is to manually add support for a module system different from the one offered as default by the platform. The ideal situation would be to continue writing our modules as we have always done, using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":", and then use a tool to transform our code into a bundle that can easily run in the browser. Luckily, this problem has already been solved by many projects, among which Webpack ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://webpack.github.io"},"children":[{"block_type":"text","content":"https://webpack.github.io"}]},{"block_type":"text","content":") is one of the most popular and broadly adopted."}]},{"block_type":"element","block":"k5zy5bzk","search_text":"Webpack allows us to write modules using the Node.js module conventions, and then, thanks to a compilation step, it creates a bundle (a single JavaScript file) that contains all the dependencies our modules need for working in the browser (including an abstraction of the require() function). This bundle can then be easily included into a web page and executed inside a browser. Webpack recursively scans our sources and looks for references of the require() function, resolving and then including the referenced modules into the bundle.","text_count":538,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Webpack allows us to write modules using the Node.js module conventions, and then, thanks to a compilation step, it creates a bundle (a single JavaScript file) that contains all the dependencies our modules need for working in the browser (including an abstraction of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function). This bundle can then be easily included into a web page and executed inside a browser. Webpack recursively scans our sources and looks for references of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"function, resolving and then including the referenced modules into the bundle."}]},{"block_type":"element","block":"k5zy5bzl","search_text":"Tip Webpack is not the only tool we have for creating browser bundles from Node.js modules. Other popular alternatives are Browserify ( http://browserify.org ), RollupJs ( http://rollupjs.org ) and Webmake ( https://npmjs.org/package/webmake ). In addition, require.js allows us to create modules for both the client and Node.js but it uses AMD in place of CommonJS ( http://requirejs.org/docs/node.html ). ","text_count":407,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Webpack is not the only tool we have for creating browser bundles from Node.js modules. Other popular alternatives are"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Browserify"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://browserify.org"},"children":[{"block_type":"text","content":"http://browserify.org"}]},{"block_type":"text","content":"),"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"RollupJs"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://rollupjs.org"},"children":[{"block_type":"text","content":"http://rollupjs.org"}]},{"block_type":"text","content":") and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Webmake"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/webmake"},"children":[{"block_type":"text","content":"https://npmjs.org/package/webmake"}]},{"block_type":"text","content":"). In addition,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require.js"}]},{"block_type":"text","content":"allows us to create modules for both the client and Node.js but it uses AMD in place of CommonJS ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://requirejs.org/docs/node.html"},"children":[{"block_type":"text","content":"http://requirejs.org/docs/node.html"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5bzm","search_text":"Exploring the magic of Webpack","text_count":30,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Exploring the magic of Webpack"}]},{"block_type":"element","block":"k5zy5bzn","search_text":"To quickly demonstrate how this magic works, let's see how umdModule , we created in the previous section looks, if we use Webpack. First, we need to install Webpack itself; we can do so with a simple command:","text_count":209,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To quickly demonstrate how this magic works, let's see how"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"umdModule"}]},{"block_type":"text","content":", we created in the previous section looks, if we use Webpack. First, we need to install Webpack itself; we can do so with a simple command:"}]},{"block_type":"element","block":"k5zy5bzo","search_text":"npm install webpack -g ","text_count":23,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install webpack -g"}]}]},{"block_type":"element","block":"k5zy5bzp","search_text":"The -g option will tell npm to install Webpack globally so that we can access it using a simple command from the console, as we will see in a moment.","text_count":149,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"-g"}]},{"block_type":"text","content":"option will tell"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"npm"}]},{"block_type":"text","content":"to install Webpack globally so that we can access it using a simple command from the console, as we will see in a moment."}]},{"block_type":"element","block":"k5zy5bzq","search_text":"Next, let's create a fresh project and let's try to build a module equivalent to the umdModule we created before. This is how it looks if we had to implement it in Node.js (file sayHello.js ):","text_count":192,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, let's create a fresh project and let's try to build a module equivalent to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"umdModule"}]},{"block_type":"text","content":"we created before. This is how it looks if we had to implement it in Node.js (file"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sayHello.js"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5bzr","search_text":"var mustache = require('mustache'); var template = '<h1>Hello <i>{{name}}</i></h1>'; mustache.parse(template); module.exports.sayHello = function(toWhom) { return mustache.render(template, {name: toWhom}); }; ","text_count":209,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"var mustache = require('mustache'); \nvar template = '&lt;h1&gt;Hello &lt;i&gt;{{name}}&lt;/i&gt;&lt;/h1&gt;'; \nmustache.parse(template); \nmodule.exports.sayHello = function(toWhom) { \n  return mustache.render(template, {name: toWhom}); \n};"}]}]},{"block_type":"element","block":"k5zy5bzs","search_text":"Definitely simpler than applying a UMD pattern, isn't it? Now, let's create a file called main.js , that is, the entry point of our browser code:","text_count":145,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Definitely simpler than applying a UMD pattern, isn't it? Now, let's create a file called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main.js"}]},{"block_type":"text","content":", that is, the entry point of our browser code:"}]},{"block_type":"element","block":"k5zy5bzt","search_text":"window.addEventListener('load', function(){ var sayHello = require('./sayHello').sayHello; var hello = sayHello(Browser!'); var body = document.getElementsByTagName(\"body\")[0]; body.innerHTML = hello; }); ","text_count":205,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"window.addEventListener('load', function(){ \n  var sayHello = require('./sayHello').sayHello; \n  var hello = sayHello(Browser!'); \n  var body = document.getElementsByTagName(\"body\")[0]; \n  body.innerHTML = hello; \n});"}]}]},{"block_type":"element","block":"k5zy5bzu","search_text":"In the preceding code, we require the sayHello module in exactly the same way as we would do in Node.js so, no more annoyances for managing dependencies or configuring paths; a simple require() does the job.","text_count":207,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we require the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sayHello"}]},{"block_type":"text","content":"module in exactly the same way as we would do in Node.js so, no more annoyances for managing dependencies or configuring paths; a simple"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"does the job."}]},{"block_type":"element","block":"k5zy5bzv","search_text":"Next, let's make sure to have mustache installed in the project:","text_count":64,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, let's make sure to have"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"mustache"}]},{"block_type":"text","content":"installed in the project:"}]},{"block_type":"element","block":"k5zy5bzw","search_text":"npm install mustache ","text_count":21,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install mustache"}]}]},{"block_type":"element","block":"k5zy5bzx","search_text":"Now comes the magical step. In a terminal, let's run the following command:","text_count":75,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now comes the magical step. In a terminal, let's run the following command:"}]},{"block_type":"element","block":"k5zy5bzy","search_text":"webpack main.js bundle.js ","text_count":26,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"webpack main.js bundle.js"}]}]},{"block_type":"element","block":"k5zy5bzz","search_text":"The previous command will compile the main module and bundle all the required dependencies into a single file called bundle.js , which is now ready to be used in the browser!","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The previous command will compile the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main"}]},{"block_type":"text","content":"module and bundle all the required dependencies into a single file called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"bundle.js"}]},{"block_type":"text","content":", which is now ready to be used in the browser!"}]},{"block_type":"element","block":"k5zy5c00","search_text":"To quickly test this assumption, let's create an HTML page called magic.html that contains the following code:","text_count":110,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To quickly test this assumption, let's create an HTML page called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"magic.html"}]},{"block_type":"text","content":"that contains the following code:"}]},{"block_type":"element","block":"k5zy5c01","search_text":"<html> <head> <title>Webpack magic</title> <script src=\"bundle.js\"></script> </head> <body> </body> </html> ","text_count":108,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&lt;html&gt; \n  &lt;head&gt; \n    &lt;title&gt;Webpack magic&lt;/title&gt; \n    &lt;script src=\"bundle.js\"&gt;&lt;/script&gt; \n  &lt;/head&gt; \n    &lt;body&gt; \n    &lt;/body&gt; \n&lt;/html&gt;"}]}]},{"block_type":"element","block":"k5zy5c02","search_text":"This is enough for running our code in the browser. Try to open the page and see it with your eyes. Boom!","text_count":105,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is enough for running our code in the browser. Try to open the page and see it with your eyes. Boom!"}]},{"block_type":"element","block":"k5zy5c03","search_text":"Tip During development, we don't want to manually run Webpack at every change we make to our sources. What we want instead is an automatic mechanism to regenerate the bundle when our sources change. To do that, we can use the --watch option when running the Webpack command. This option will keep Webpack running continuously and it will take care to re-compile our bundle every time one of the related source files changes. ","text_count":425,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"During development, we don't want to manually run Webpack at every change we make to our sources. What we want instead is an automatic mechanism to regenerate the bundle when our sources change. To do that, we can use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"--watch"}]},{"block_type":"text","content":"option when running the Webpack command. This option will keep Webpack running continuously and it will take care to re-compile our bundle every time one of the related source files changes."}]}]},{"block_type":"element","block":"k5zy5c04","search_text":"The advantages of using Webpack","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The advantages of using Webpack"}]},{"block_type":"element","block":"k5zy5c05","search_text":"The magic of Webpack doesn't stop here. This is a (incomplete) list of features that make sharing code with the browser a simpler and seamless experience:","text_count":154,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The magic of Webpack doesn't stop here. This is a (incomplete) list of features that make sharing code with the browser a simpler and seamless experience:"}]},{"block_type":"element","block":"k5zy5c06","search_text":"Webpack automatically provides a version for many of the Node.js core modules that are compatible with the browser. This means that we can use modules such as http , assert , or events , and many more, in the browser! ","text_count":218,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Webpack automatically provides a version for many of the Node.js core modules that are compatible with the browser. This means that we can use modules such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"assert"}]},{"block_type":"text","content":", or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"events"}]},{"block_type":"text","content":", and many more, in the browser!"}]}]},{"block_type":"element","block":"k5zy5c07","search_text":"Tip The fs module is among those not supported. ","text_count":48,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"module is among those not supported."}]}]},{"block_type":"element","block":"k5zy5c08","search_text":"If we have a module that is incompatible with the browser, we can exclude it from the build or replace it with an empty object or with another module providing an alternative and browser-compatible implementation. This is a crucial feature and we will have the chance to use it in the example we are going to see shortly. Webpack can generate bundles for different modules. Webpack allows us to perform additional processing of the source files using third-party loaders and plugins . There are loaders and plugins for almost everything one might need, from CoffeeScript, TypeScript, or ES2015 compilation, to support for loading AMD, Bower ( http://bower.io ), and Component ( http://component.github.io ) packages using require() , from minification to the compilation and bundling of other assets such as templates and stylesheets. We can easily invoke Webpack from task managers such as Gulp ( https://npmjs.com/package/gulp-webpack ) and Grunt ( https://npmjs.org/package/grunt-webpack ). Webpack allows you to manage and pre-process all your project's resources, not just JavaScript files but also stylesheets, images, fonts, and templates. We can also configure Webpack to split the dependency tree and organize it into different chunks that can be loaded on demand whenever the browser needs them. ","text_count":1306,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If we have a module that is incompatible with the browser, we can exclude it from the build or replace it with an empty object or with another module providing an alternative and browser-compatible implementation. This is a crucial feature and we will have the chance to use it in the example we are going to see shortly."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Webpack can generate bundles for different modules."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Webpack allows us to perform additional processing of the source files using third-party"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"loaders"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"plugins"}]},{"block_type":"text","content":". There are loaders and plugins for almost everything one might need, from CoffeeScript, TypeScript, or ES2015 compilation, to support for loading AMD, Bower ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://bower.io"},"children":[{"block_type":"text","content":"http://bower.io"}]},{"block_type":"text","content":"), and Component ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://component.github.io"},"children":[{"block_type":"text","content":"http://component.github.io"}]},{"block_type":"text","content":") packages using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":", from minification to the compilation and bundling of other assets such as templates and stylesheets."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We can easily invoke Webpack from task managers such as Gulp ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.com/package/gulp-webpack"},"children":[{"block_type":"text","content":"https://npmjs.com/package/gulp-webpack"}]},{"block_type":"text","content":") and Grunt ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/grunt-webpack"},"children":[{"block_type":"text","content":"https://npmjs.org/package/grunt-webpack"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Webpack allows you to manage and pre-process all your project's resources, not just JavaScript files but also stylesheets, images, fonts, and templates."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We can also configure Webpack to split the dependency tree and organize it into different chunks that can be loaded on demand whenever the browser needs them."}]}]},{"block_type":"element","block":"k5zy5c09","search_text":"The power and flexibility of Webpack are so captivating that many developers started to use it even to manage client-side only code. This is also made possible by the fact that many client-side libraries are starting to support CommonJS and npm by default, opening new and interesting scenarios. For example, we can install jQuery as follows:","text_count":342,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The power and flexibility of Webpack are so captivating that many developers started to use it even to manage client-side only code. This is also made possible by the fact that many client-side libraries are starting to support CommonJS and npm by default, opening new and interesting scenarios. For example, we can install jQuery as follows:"}]},{"block_type":"element","block":"k5zy5c0a","search_text":"npm install jquery ","text_count":19,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install jquery"}]}]},{"block_type":"element","block":"k5zy5c0b","search_text":"And then, we can load it into our code with a simple line of code:","text_count":66,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"And then, we can load it into our code with a simple line of code:"}]},{"block_type":"element","block":"k5zy5c0c","search_text":"const $ = require('jquery'); ","text_count":29,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const $ = require('jquery');"}]}]},{"block_type":"element","block":"k5zy5c0d","search_text":"You will be surprised at how many client-side libraries already support CommonJS and Webpack.","text_count":93,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You will be surprised at how many client-side libraries already support CommonJS and Webpack."}]},{"block_type":"element","block":"k5zy5c0e","search_text":"Using ES2015 with Webpack","text_count":25,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Using ES2015 with Webpack"}]},{"block_type":"element","block":"k5zy5c0f","search_text":"As we said in the previous paragraph, one of the main advantages of Webpack is the ability to use loaders and plugins to transform the source code before bundling it.","text_count":166,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we said in the previous paragraph, one of the main advantages of Webpack is the ability to use loaders and plugins to transform the source code before bundling it."}]},{"block_type":"element","block":"k5zy5c0g","search_text":"Throughout this book we have been using many of the new handy features offered by the ES2015 standard, and we would love to keep using it even when working on a universal JavaScript application. In this section, we are going to see how to leverage the loader feature of Webpack to re-write the previous example using the ES2015 syntax within our source modules. With the proper configuration, Webpack will take care to transpile the resulting code for the browser to ES5 to guarantee the maximum compatibility with all the currently available browsers.","text_count":552,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Throughout this book we have been using many of the new handy features offered by the ES2015 standard, and we would love to keep using it even when working on a universal JavaScript application. In this section, we are going to see how to leverage the loader feature of Webpack to re-write the previous example using the ES2015 syntax within our source modules. With the proper configuration, Webpack will take care to transpile the resulting code for the browser to ES5 to guarantee the maximum compatibility with all the currently available browsers."}]},{"block_type":"element","block":"k5zy5c0h","search_text":"First of all, let's move our modules to a new src folder. This will make it easier for us to organize our code and separate the transpiled code from the original source code. This separation will also make it easier for us to configure Webpack properly and simplify the way we invoke Webpack from the command line.","text_count":314,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First of all, let's move our modules to a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"src"}]},{"block_type":"text","content":"folder. This will make it easier for us to organize our code and separate the transpiled code from the original source code. This separation will also make it easier for us to configure Webpack properly and simplify the way we invoke Webpack from the command line."}]},{"block_type":"element","block":"k5zy5c0i","search_text":"Now we are ready to rewrite our modules. The ES2015 of our src/sayHello.js will look like this:","text_count":95,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to rewrite our modules. The ES2015 of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"src/sayHello.js"}]},{"block_type":"text","content":"will look like this:"}]},{"block_type":"element","block":"k5zy5c0j","search_text":"const mustache = require('mustache'); const template = '<h1>Hello <i>{{name}}</i></h1>'; mustache.parse(template); module.exports.sayHello = toWhom => { return mustache.render(template, {name: toWhom}); }; ","text_count":206,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const mustache = require('mustache'); \nconst template = '&lt;h1&gt;Hello &lt;i&gt;{{name}}&lt;/i&gt;&lt;/h1&gt;'; \nmustache.parse(template); \nmodule.exports.sayHello = toWhom =&gt; { \n  return mustache.render(template, {name: toWhom}); \n};"}]}]},{"block_type":"element","block":"k5zy5c0k","search_text":"Notice that we are using const , let , and the arrow function syntax.","text_count":69,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Notice that we are using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"const"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"let"}]},{"block_type":"text","content":", and the arrow function syntax."}]},{"block_type":"element","block":"k5zy5c0l","search_text":"We can now update our src/main.js file to ES2015. Our src/main.js file instead can be re-written as follows:","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now update our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"src/main.js"}]},{"block_type":"text","content":"file to ES2015. Our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"src/main.js"}]},{"block_type":"text","content":"file instead can be re-written as follows:"}]},{"block_type":"element","block":"k5zy5c0m","search_text":"window.addEventListener('load', () => { const sayHello = require('./sayHello').sayHello; const hello = sayHello('Browser!'); const body = document.getElementsByTagName(\"body\")[0]; body.innerHTML = hello; }); ","text_count":208,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"window.addEventListener('load', () =&gt; { \n  const sayHello = require('./sayHello').sayHello; \n  const hello = sayHello('Browser!'); \n  const body = document.getElementsByTagName(\"body\")[0]; \n  body.innerHTML = hello; \n});"}]}]},{"block_type":"element","block":"k5zy5c0n","search_text":"Now we are ready to define the webpack.config.js file:","text_count":54,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to define the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"webpack.config.js"}]},{"block_type":"text","content":"file:"}]},{"block_type":"element","block":"k5zy5c0o","search_text":"const path = require('path'); module.exports = { entry: path.join(__dirname, \"src\", \"main.js\"), output: { path: path.join(__dirname, \"dist\"), filename: \"bundle.js\" }, module: { loaders: [ { test: path.join(__dirname, \"src\"), loader: 'babel-loader', query: { presets: ['es2015'] } } ] } }; ","text_count":289,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const path = require('path'); \n \nmodule.exports = { \n  entry:  path.join(__dirname, \"src\", \"main.js\"), \n  output: { \n    path: path.join(__dirname, \"dist\"), \n    filename: \"bundle.js\" \n  }, \n  module: { \n    loaders: [ \n      { \n        test: path.join(__dirname, \"src\"), \n        loader: 'babel-loader', \n        query: { \n          presets: ['es2015'] \n        } \n      } \n    ] \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5c0p","search_text":"This file is a module that exports a configuration object that will be read by Webpack when we invoke it from the command line without any argument.","text_count":148,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This file is a module that exports a configuration object that will be read by Webpack when we invoke it from the command line without any argument."}]},{"block_type":"element","block":"k5zy5c0q","search_text":"In the configuration object, we are defining the entry point as our src/main.js file and the destination for our bundle file as dist/bundle.js .","text_count":144,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the configuration object, we are defining the entry point as our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"src/main.js"}]},{"block_type":"text","content":"file and the destination for our bundle file as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"dist/bundle.js"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5c0r","search_text":"This part was quite self-explanatory, so let's now have a look at the loaders array. This optional array allows us to specify a set of loaders that can alter the content of our source files while Webpack constructs our bundle file. The idea is that every loader represents a specific transformation (in this case, ES2015 to ES5 using babel-loader ) and it is applied only if the current source file matches the specific test expression defined for the loader. In this example, we are telling Webpack to use babel-loader on all the files coming from our src folder and to apply the es2015 preset as Babel option.","text_count":611,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This part was quite self-explanatory, so let's now have a look at the loaders array. This optional array allows us to specify a set of loaders that can alter the content of our source files while Webpack constructs our bundle file. The idea is that every loader represents a specific transformation (in this case, ES2015 to ES5 using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"babel-loader"}]},{"block_type":"text","content":") and it is applied only if the current source file matches the specific"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"test"}]},{"block_type":"text","content":"expression defined for the loader. In this example, we are telling Webpack to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"babel-loader"}]},{"block_type":"text","content":"on all the files coming from our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"src"}]},{"block_type":"text","content":"folder and to apply the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"es2015"}]},{"block_type":"text","content":"preset as Babel option."}]},{"block_type":"element","block":"k5zy5c0s","search_text":"Now we are almost ready; the only missing step before running Webpack is to install Babel and the ES2015 preset with the following command:","text_count":139,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are almost ready; the only missing step before running Webpack is to install Babel and the ES2015 preset with the following command:"}]},{"block_type":"element","block":"k5zy5c0t","search_text":"npm install babel-core babel-loader babel-preset-es2015 ","text_count":56,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install babel-core babel-loader babel-preset-es2015"}]}]},{"block_type":"element","block":"k5zy5c0u","search_text":"Now, to generate your bundle, you can simply run:","text_count":49,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, to generate your bundle, you can simply run:"}]},{"block_type":"element","block":"k5zy5c0v","search_text":"webpack ","text_count":8,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"webpack"}]}]},{"block_type":"element","block":"k5zy5c0w","search_text":"Remember to reference the new dist/bundle.js in your magic.html file. You should be able to open it in the browser and see that everything is still working properly.","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Remember to reference the new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"dist/bundle.js"}]},{"block_type":"text","content":"in your"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"magic.html"}]},{"block_type":"text","content":"file. You should be able to open it in the browser and see that everything is still working properly."}]},{"block_type":"element","block":"k5zy5c0x","search_text":"If you are curious, you can read the content of the freshly generated bundle file and you will discover that all the ES2015 features we used in the source files have been converted to the equivalent code valid in ES5, which every browser on the market can execute just fine.","text_count":274,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you are curious, you can read the content of the freshly generated bundle file and you will discover that all the ES2015 features we used in the source files have been converted to the equivalent code valid in ES5, which every browser on the market can execute just fine."}]},{"block_type":"element","block":"k5zy5c0y","search_text":"Fundamentals of cross-platform development","text_count":42,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Fundamentals of cross-platform development"}]},{"block_type":"element","block":"k5zy5c0z","search_text":"When developing for different platforms, the most common problem we have to face is sharing the common parts of a component while providing different implementations for details that are platform-specific. We will now explore some of the principles and the patterns to use when facing this challenge.","text_count":300,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When developing for different platforms, the most common problem we have to face is sharing the common parts of a component while providing different implementations for details that are platform-specific. We will now explore some of the principles and the patterns to use when facing this challenge."}]},{"block_type":"element","block":"k5zy5c10","search_text":"Runtime code branching","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Runtime code branching"}]},{"block_type":"element","block":"k5zy5c11","search_text":"The most simple and intuitive technique for providing different implementations based on the host platform is to dynamically branch our code. This requires that we have a mechanism to recognize at runtime the host platform and then switch dynamically the implementation with an if…else statement. Some generic approaches involve checking global variables that are available only on Node.js or only in the browser. For example, we can check the existence of the window global:","text_count":475,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most simple and intuitive technique for providing different implementations based on the host platform is to dynamically branch our code. This requires that we have a mechanism to recognize at runtime the host platform and then switch dynamically the implementation with an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if&hellip;else"}]},{"block_type":"text","content":"statement. Some generic approaches involve checking global variables that are available only on Node.js or only in the browser. For example, we can check the existence of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"window"}]},{"block_type":"text","content":"global:"}]},{"block_type":"element","block":"k5zy5c12","search_text":"if(typeof window !== \"undefined\" && window.document) { //client side code console.log('Hey browser!'); } else { //Node.js code console.log('Hey Node.js!'); } ","text_count":158,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if(typeof window !== \"undefined\" && window.document) { \n  //client side code \n  console.log('Hey browser!'); \n} else { \n  //Node.js code \n  console.log('Hey Node.js!'); \n}"}]}]},{"block_type":"element","block":"k5zy5c13","search_text":"Using a runtime branching approach for switching between Node.js and the browser is definitely the most intuitive and simple pattern we can use for the purpose; however, there are some inconveniences:","text_count":200,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using a runtime branching approach for switching between Node.js and the browser is definitely the most intuitive and simple pattern we can use for the purpose; however, there are some inconveniences:"}]},{"block_type":"element","block":"k5zy5c14","search_text":"The code for both the platforms is included in the same module and therefore in the final bundle, increasing its size with unreachable code. If used too extensively, it can considerably reduce the readability of the code, as business logic would be mixed with logic meant only to add cross-platform compatibility. Using dynamic branching to load a different module depending on the platform will result in all the modules being added to the final bundle regardless of their target platform. For example, if we consider the next code fragment, both clientModule and serverModule will be included in a bundle generated with Webpack, unless we don't explicitly exclude one of them from the build: ","text_count":694,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The code for both the platforms is included in the same module and therefore in the final bundle, increasing its size with unreachable code."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If used too extensively, it can considerably reduce the readability of the code, as business logic would be mixed with logic meant only to add cross-platform compatibility."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Using dynamic branching to load a different module depending on the platform will result in all the modules being added to the final bundle regardless of their target platform. For example, if we consider the next code fragment, both"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"clientModule"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"serverModule"}]},{"block_type":"text","content":"will be included in a bundle generated with Webpack, unless we don't explicitly exclude one of them from the build:"}]}]},{"block_type":"element","block":"k5zy5c15","search_text":"if(typeof window !== \"undefined\" && window.document) { require('clientModule'); } else { require('serverModule'); } ","text_count":116,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if(typeof window !== \"undefined\" && window.document) { \n         require('clientModule'); \n       } else { \n         require('serverModule'); \n       }"}]}]},{"block_type":"element","block":"k5zy5c16","search_text":"This last inconvenience is due to the fact that bundlers have no sure way of knowing the value of a runtime variable at build time (unless the variable is a constant), so they include any module regardless of whether it's required from reachable or unreachable code.","text_count":266,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This last inconvenience is due to the fact that bundlers have no sure way of knowing the value of a runtime variable at build time (unless the variable is a constant), so they include any module regardless of whether it's required from reachable or unreachable code."}]},{"block_type":"element","block":"k5zy5c17","search_text":"A consequence of this last property is that modules required dynamically using variables are not included in the bundle. For example, from the following code, no module will be bundled:","text_count":185,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A consequence of this last property is that modules required dynamically using variables are not included in the bundle. For example, from the following code, no module will be bundled:"}]},{"block_type":"element","block":"k5zy5c18","search_text":"moduleList.forEach(function(module) { require(module); }); ","text_count":59,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"moduleList.forEach(function(module) { \n  require(module); \n});"}]}]},{"block_type":"element","block":"k5zy5c19","search_text":"It's worth underlining that Webpack overcomes some of these limitations and, under certain specific circumstances, it is able to guess all the possible values for a dynamic requirement. For instance, if you have a snippet of code like the following:","text_count":249,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's worth underlining that Webpack overcomes some of these limitations and, under certain specific circumstances, it is able to guess all the possible values for a dynamic requirement. For instance, if you have a snippet of code like the following:"}]},{"block_type":"element","block":"k5zy5c1a","search_text":"function getController(controllerName) { return require(\"./controller/\" + controllerName); }","text_count":92,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function getController(controllerName) { \n  return require(\"./controller/\" + controllerName); \n}"}]}]},{"block_type":"element","block":"k5zy5c1b","search_text":"It will put all the modules available in the controller folder.","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It will put all the modules available in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"controller"}]},{"block_type":"text","content":"folder."}]},{"block_type":"element","block":"k5zy5c1c","search_text":"It's heavily recommended to have a look at the official documentation to understand all the supported cases.","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's heavily recommended to have a look at the official documentation to understand all the supported cases."}]},{"block_type":"element","block":"k5zy5c1d","search_text":"Build-time code branching","text_count":25,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Build-time code branching"}]},{"block_type":"element","block":"k5zy5c1e","search_text":"In this section, we are going to see how to use Webpack to remove, at build time, all the parts of the code that we want only the server to use. This allows us to obtain lighter bundle files and to avoid accidentally exposing sensible code that should live only on the server.","text_count":276,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we are going to see how to use Webpack to remove, at build time, all the parts of the code that we want only the server to use. This allows us to obtain lighter bundle files and to avoid accidentally exposing sensible code that should live only on the server."}]},{"block_type":"element","block":"k5zy5c1f","search_text":"Apart from loaders, Webpack also offers support for plugins, which allows us to extend our processing pipeline used to build the bundle file. To perform build-time code branching, we can use a pipeline of two built-in plugins called DefinePlugin and UglifyJsPlugin.","text_count":265,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Apart from loaders, Webpack also offers support for plugins, which allows us to extend our processing pipeline used to build the bundle file. To perform build-time code branching, we can use a pipeline of two built-in plugins called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"DefinePlugin"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"UglifyJsPlugin."}]}]},{"block_type":"element","block":"k5zy5c1g","search_text":"DefinePlugin can be used to replace specific code occurrences in our source files with custom code or variables. Instead, UglifyJsPlugin allows us to compress the resulting code and remove unreachable statements (dead code).","text_count":224,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"DefinePlugin"}]},{"block_type":"text","content":"&nbsp;can be used to replace specific code occurrences in our source files with custom code or variables. Instead,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"UglifyJsPlugin"}]},{"block_type":"text","content":"&nbsp;allows us to compress the resulting code and remove unreachable statements (dead code)."}]},{"block_type":"element","block":"k5zy5c1h","search_text":"Let's see a practical example to better understand these concepts. Let's assume we have the following content in our main.js file:","text_count":130,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see a practical example to better understand these concepts. Let's assume we have the following content in our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main.js"}]},{"block_type":"text","content":"file:"}]},{"block_type":"element","block":"k5zy5c1i","search_text":"if (typeof __BROWSER__ !== \"undefined\") { console.log('Hey browser!'); } else { console.log('Hey Node.js!'); } ","text_count":111,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if (typeof __BROWSER__ !== \"undefined\") { \n  console.log('Hey browser!'); \n} else { \n  console.log('Hey Node.js!'); \n}"}]}]},{"block_type":"element","block":"k5zy5c1j","search_text":"Then, we can define the following webpack.config.js file:","text_count":57,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can define the following"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"webpack.config.js"}]},{"block_type":"text","content":"file:"}]},{"block_type":"element","block":"k5zy5c1k","search_text":"const path = require('path'); const webpack = require('webpack'); const definePlugin = new webpack.DefinePlugin({ \"__BROWSER__\": \"true\" }); const uglifyJsPlugin = new webpack.optimize.UglifyJsPlugin({ beautify: true, dead_code: true }); module.exports = { entry: path.join(__dirname, \"src\", \"main.js\"), output: { path: path.join(__dirname, \"dist\"), filename: \"bundle.js\" }, plugins: [definePlugin, uglifyJsPlugin] }; ","text_count":417,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const path = require('path'); \nconst webpack = require('webpack'); \n \nconst definePlugin = new webpack.DefinePlugin({ \n  \"__BROWSER__\": \"true\" \n});\nconst uglifyJsPlugin = new webpack.optimize.UglifyJsPlugin({ \n  beautify: true, \n  dead_code: true \n}); \n \nmodule.exports = { \n  entry:  path.join(__dirname, \"src\", \"main.js\"), \n  output: { \n    path: path.join(__dirname, \"dist\"), \n    filename: \"bundle.js\" \n  }, \n  plugins: [definePlugin, uglifyJsPlugin] \n};"}]}]},{"block_type":"element","block":"k5zy5c1l","search_text":"The important parts of the code here are the definition and configuration of the two plugins that we introduced. ","text_count":113,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The important parts of the code here are the definition and configuration of the two plugins that we introduced."}]},{"block_type":"element","block":"k5zy5c1m","search_text":"The first plugin, DefinePlugin , allows us to replace specific parts of the source code with dynamic code or constant values. The way it is configured is a bit tricky but this example should help with understanding how it works. In this case, we are configuring the plugin to look for all the occurrences of __BROWSER__ in the code and to replace them with true . Every value in the configuration object (in our case, \"true\" as a string and not as a boolean) represents a piece of code that will be evaluated at build time and then used to replace the currently matched snippet of code. This allows us to put in the bundle external dynamic values containing, for instance, the content of an environment variable, the current timestamp, or the hash of the last git commit. After occurrence of __BROWSER__ is replaced, the first if statement will internally look like if (true !== \"undefined\") , but Webpack is smart enough to understand that this expression will always be evaluated as true , so it transforms the resulting code again to be if (true) .","text_count":1051,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first plugin,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"DefinePlugin"}]},{"block_type":"text","content":", allows us to replace specific parts of the source code with dynamic code or constant values. The way it is configured is a bit tricky but this example should help with understanding how it works. In this case, we are configuring the plugin to look for all the occurrences of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"__BROWSER__"}]},{"block_type":"text","content":"&nbsp;in the code and to replace them with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true"}]},{"block_type":"text","content":". Every value in the configuration object (in our case,&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"\"true\""}]},{"block_type":"text","content":"as a string and not as a boolean) represents a piece of code that will be evaluated at build time and then used to replace the currently matched snippet of code. This allows us to put in the bundle external dynamic values containing, for instance, the content of an environment variable, the current timestamp, or the hash of the last git commit. After occurrence of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"__BROWSER__"}]},{"block_type":"text","content":"&nbsp;is replaced, the first"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if"}]},{"block_type":"text","content":"statement will internally look like"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if (true !== \"undefined\")"}]},{"block_type":"text","content":", but Webpack is smart enough to understand that this expression will always be evaluated as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true"}]},{"block_type":"text","content":", so it transforms the resulting code again to be"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if (true)"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5c1n","search_text":"The second plugin ( UglifyJsPlugin) is instead used to obfuscate and minify the JavaScript code of the bundle file using UglifyJs ( https://github.com/mishoo/UglifyJS ). With the dead_code option provided to the plugin, UglifyJs is able to remove all the dead code, so our currently processed code that will look like this:","text_count":323,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The second plugin ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"UglifyJsPlugin)"}]},{"block_type":"text","content":"&nbsp;is instead used to obfuscate and minify the JavaScript code of the bundle file using"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"UglifyJs"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/mishoo/UglifyJS"},"children":[{"block_type":"text","content":"https://github.com/mishoo/UglifyJS"}]},{"block_type":"text","content":"). With the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"dead_code"}]},{"block_type":"text","content":"option provided to the plugin, UglifyJs is able to remove all the dead code, so our currently processed code that will look like this:"}]},{"block_type":"element","block":"k5zy5c1o","search_text":"if (true) { console.log('Hey browser!'); } else { console.log('Hey Node.js!'); } ","text_count":81,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if (true) { \n  console.log('Hey browser!'); \n} else { \n  console.log('Hey Node.js!'); \n}"}]}]},{"block_type":"element","block":"k5zy5c1p","search_text":"can be easily converted only in:","text_count":32,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"can be easily converted only in:"}]},{"block_type":"element","block":"k5zy5c1q","search_text":"console.log('Hey browser!'); ","text_count":29,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"console.log('Hey browser!');"}]}]},{"block_type":"element","block":"k5zy5c1r","search_text":"The beautify: true option is used to avoid removing all the indentation and whitespaces so that, if you are curious, you can go and read the resulting bundle file. When creating bundles for production, it is better to avoid specifying this option, which is by default false .","text_count":275,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"beautify: true"}]},{"block_type":"text","content":"&nbsp;option is used to avoid removing all the indentation and whitespaces so that, if you are curious, you can go and read the resulting bundle file. When creating bundles for production, it is better to avoid specifying this option, which is by default"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"false"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5c1s","search_text":"Tip In the example code that you can download in addition to this book, you will find an extra example that will show you how to use the Webpack DefinePlugin to replace specific constants with dynamic variables such as the timestamp of bundle generation, the current user, and the current operative system. ","text_count":307,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the example code that you can download in addition to this book, you will find an extra example that will show you how to use the Webpack&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"DefinePlugin"}]},{"block_type":"text","content":"to replace specific constants with dynamic variables such as the timestamp of bundle generation, the current user, and the current operative system."}]}]},{"block_type":"element","block":"k5zy5c1t","search_text":"Even if this technique is way better than runtime code branching because it produces much leaner bundle files, it can still make our source code cumbersome when abused. You don't want to have statements that branches your server code from your browser code all around your application, right?","text_count":292,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even if this technique is way better than runtime code branching because it produces much leaner bundle files, it can still make our source code cumbersome when abused. You don't want to have statements that branches your server code from your browser code all around your application, right?"}]},{"block_type":"element","block":"k5zy5c1u","search_text":"Module swapping","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Module swapping"}]},{"block_type":"element","block":"k5zy5c1v","search_text":"Most of the time, we already know at build time what code has to be included in the client bundle and what shouldn't. This means that we can take this decision upfront and instruct the bundler to replace the implementation of a module at build time. This often results in a leaner bundle, as we are excluding unnecessary modules, and a more readable code because we don't have all the if…else statements required by runtime and build-time branching.","text_count":449,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Most of the time, we already know at build time what code has to be included in the client bundle and what shouldn't. This means that we can take this decision upfront and instruct the bundler to replace the implementation of a module at build time. This often results in a leaner bundle, as we are excluding unnecessary modules, and a more readable code because we don't have all the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"if&hellip;else"}]},{"block_type":"text","content":"statements required by runtime and build-time branching."}]},{"block_type":"element","block":"k5zy5c1w","search_text":"Let's find out how to adopt module swapping with Webpack with a very simple example.","text_count":84,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's find out how to adopt module swapping with Webpack with a very simple example."}]},{"block_type":"element","block":"k5zy5c1x","search_text":"We are going to build a module that exports a function called alert, which simply shows an alert message. We will have two different implementations, one for the server and one for the browser. Let's start with alertServer.js :","text_count":227,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are going to build a module that exports a function called alert, which simply shows an alert message. We will have two different implementations, one for the server and one for the browser. Let's start with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alertServer.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c1y","search_text":"module.exports = console.log; ","text_count":30,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = console.log;"}]}]},{"block_type":"element","block":"k5zy5c1z","search_text":"Then, with the alertBrowser.js :","text_count":32,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alertBrowser.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c20","search_text":"module.exports = alert; ","text_count":24,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = alert;"}]}]},{"block_type":"element","block":"k5zy5c21","search_text":"The code is super simple. As you can tell, we are just using the default functions console.log for the server and alert for the browser. They both accept a string as an argument, but the first prints the string in the console while the seconds displays it in a window.","text_count":268,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code is super simple. As you can tell, we are just using the default functions"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"console.log"}]},{"block_type":"text","content":"for the server and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alert"}]},{"block_type":"text","content":"for the browser. They both accept a string as an argument, but the first prints the string in the console while the seconds displays it in a window."}]},{"block_type":"element","block":"k5zy5c22","search_text":"Now let's write our generic main.js code, which by default, uses the module for the server:","text_count":91,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now let's write our generic"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main.js"}]},{"block_type":"text","content":"code, which by default, uses the module for the server:"}]},{"block_type":"element","block":"k5zy5c23","search_text":"const alert = require('./alertServer'); alert('Morning comes whether you set the alarm or not!'); ","text_count":98,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const alert = require('./alertServer'); \nalert('Morning comes whether you set the alarm or not!');"}]}]},{"block_type":"element","block":"k5zy5c24","search_text":"There's nothing crazy here—we are just importing the alert module and using it. If we run:","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There's nothing crazy here&mdash;we are just importing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alert"}]},{"block_type":"text","content":"module and using it. If we run:"}]},{"block_type":"element","block":"k5zy5c25","search_text":"node main.js ","text_count":13,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node main.js"}]}]},{"block_type":"element","block":"k5zy5c26","search_text":"it will just print Morning comes whether you set the alarm or not! in the console.","text_count":82,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"it will just print"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Morning comes whether you set the alarm or not!"}]},{"block_type":"text","content":"&nbsp;in the console."}]},{"block_type":"element","block":"k5zy5c27","search_text":"Now comes the interesting part, let's see how our webpack.config.js should look to be able to swap the require of alertServer with alertBrowser when we want to create the bundle for the browser:","text_count":194,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now comes the interesting part, let's see how our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"webpack.config.js"}]},{"block_type":"text","content":"should look to be able to swap the require of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alertServer"}]},{"block_type":"text","content":"with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alertBrowser"}]},{"block_type":"text","content":"when we want to create the bundle for the browser:"}]},{"block_type":"element","block":"k5zy5c28","search_text":"const path = require('path'); const webpack = require('webpack'); const moduleReplacementPlugin = new webpack.NormalModuleReplacementPlugin(/alertServer.js$/, './alertBrowser.js'); module.exports = { entry: path.join(__dirname, \"src\", \"main.js\"), output: { path: path.join(__dirname, \"dist\"), filename: \"bundle.js\" }, plugins: [moduleReplacementPlugin] }; ","text_count":356,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const path = require('path'); \nconst webpack = require('webpack'); \n \nconst moduleReplacementPlugin = \n  new webpack.NormalModuleReplacementPlugin(/alertServer.js$/,\n    './alertBrowser.js'); \n \nmodule.exports = { \n  entry:  path.join(__dirname, \"src\", \"main.js\"), \n  output: { \n    path: path.join(__dirname, \"dist\"), \n    filename: \"bundle.js\" \n  }, \n  plugins: [moduleReplacementPlugin] \n};"}]}]},{"block_type":"element","block":"k5zy5c29","search_text":"We are using the NormalModuleReplacementPlugin , which accepts two arguments. The first argument is a regular expression and the second one is a string representing a path to a resource. At build time, if a resource matches the given regular expression, it is replaced with the one provided in the second argument.","text_count":314,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"NormalModuleReplacementPlugin"}]},{"block_type":"text","content":", which accepts two arguments. The first argument is a regular expression and the second one is a string representing a path to a resource. At build time, if a resource matches the given regular expression, it is replaced with the one provided in the second argument."}]},{"block_type":"element","block":"k5zy5c2a","search_text":"In this example, we are providing a regular expression that matches our alertServer module and replaces it with alertBrowser .","text_count":126,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this example, we are providing a regular expression that matches our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alertServer"}]},{"block_type":"text","content":"&nbsp;module and replaces it with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alertBrowser"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5c2b","search_text":"Note Notice that we used the const keyword in this example but for the sake of simplicity, we didn't add the configuration to transpile ES2015 functionalities to the equivalent ES5 code, so with the current configuration the resulting code might not work with old browsers. ","text_count":274,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Notice that we used the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"const"}]},{"block_type":"text","content":"keyword in this example but for the sake of simplicity, we didn't add the configuration to transpile ES2015 functionalities to the equivalent ES5 code, so with the current configuration the resulting code might not work with old browsers."}]}]},{"block_type":"element","block":"k5zy5c2c","search_text":"Of course, we can use the same swapping technique also with external modules fetched from npm. Let's improve the previous example to see how to use one or more external modules together with module swapping.","text_count":207,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Of course, we can use the same swapping technique also with external modules fetched from npm. Let's improve the previous example to see how to use one or more external modules together with module swapping."}]},{"block_type":"element","block":"k5zy5c2d","search_text":"Nobody wants to use the alert function today, and for good reason. This function in fact displays a very bad looking window, which blocks the browser until the user dismisses it. It would be much nicer to use a fancy toast popup to display our alert message. There are a number of libraries on npm that provide this toast functionality, and one of these is toastr ( https://npmjs.com/package/toastr ), which provides a very simple programmatic interface and an enjoyable look and feel. toastr relies on jQuery, so the first thing that we need to do is to install both with:","text_count":573,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Nobody wants to use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alert"}]},{"block_type":"text","content":"function today, and for good reason. This function in fact displays a very bad looking window, which blocks the browser until the user dismisses it. It would be much nicer to use a fancy&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"toast popup"}]},{"block_type":"text","content":"to display our alert message. There are a number of libraries on npm that provide this toast functionality, and one of these is&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"toastr"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.com/package/toastr"},"children":[{"block_type":"text","content":"https://npmjs.com/package/toastr"}]},{"block_type":"text","content":"), which provides a very simple programmatic interface and an enjoyable look and feel."},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"toastr"}]},{"block_type":"text","content":"relies on jQuery, so the first thing that we need to do is to install both with:"}]},{"block_type":"element","block":"k5zy5c2e","search_text":"npm install jQuery toastr ","text_count":26,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install jQuery toastr"}]}]},{"block_type":"element","block":"k5zy5c2f","search_text":"Now we can rewrite our alertBrowser module to use toastr instead of the native alert function:","text_count":94,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we can rewrite our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alertBrowser"}]},{"block_type":"text","content":"module to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"toastr"}]},{"block_type":"text","content":"instead of the native"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alert"}]},{"block_type":"text","content":"function:"}]},{"block_type":"element","block":"k5zy5c2g","search_text":"const toastr = require('toastr'); module.exports = toastr.info; ","text_count":64,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const toastr = require('toastr'); \nmodule.exports = toastr.info;"}]}]},{"block_type":"element","block":"k5zy5c2h","search_text":"The toastr.info function accepts a string as an argument and it will take care to display the given message as a box in the top right corner of the browser window once invoked.","text_count":176,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"toastr.info"}]},{"block_type":"text","content":"function accepts a string as an argument and it will take care to display the given message as a box in the top right corner of the browser window once invoked."}]},{"block_type":"element","block":"k5zy5c2i","search_text":"Our Webpack configuration file remains the same but, this time, Webpack will resolve the full dependency tree for the new version of the alertBrowser module, thus including jQuery and toastr in the resulting bundle file.","text_count":220,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our Webpack configuration file remains the same but, this time, Webpack will resolve the full dependency tree for the new version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"alertBrowser"}]},{"block_type":"text","content":"module, thus including&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"jQuery"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"toastr"}]},{"block_type":"text","content":"in the resulting bundle file."}]},{"block_type":"element","block":"k5zy5c2j","search_text":"In addition, the server version of the module and the main.js file remained unchanged, and this proves how this solution makes our code much easier to maintain.","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In addition, the server version of the module and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main.js"}]},{"block_type":"text","content":"file remained unchanged, and this proves how this solution makes our code much easier to maintain."}]},{"block_type":"element","block":"k5zy5c2k","search_text":"Note To make this example work nicely in the browser, we should take care to add the toastr CSS file to our HTML file. ","text_count":119,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To make this example work nicely in the browser, we should take care to add the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"toastr"}]},{"block_type":"text","content":"CSS file to our HTML file."}]}]},{"block_type":"element","block":"k5zy5c2l","search_text":"Thanks to Webpack and the module replacement plugin, we can easily deal with structural differences between platforms. We can focus on writing separate modules that are meant to provide platform-specific code and we can then swap Node.js—only modules with browser-specific ones in the final bundle.","text_count":298,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Thanks to Webpack and the module replacement plugin, we can easily deal with structural differences between platforms. We can focus on writing separate modules that are meant to provide platform-specific code and we can then swap Node.js&mdash;only modules with browser-specific ones in the final bundle."}]},{"block_type":"element","block":"k5zy5c2m","search_text":"Design patterns for cross-platform development","text_count":46,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Design patterns for cross-platform development"}]},{"block_type":"element","block":"k5zy5c2n","search_text":"Now that we know how to switch between Node.js and browser code, the remaining pieces of the puzzle are how to integrate this within our design and how we can create our components in such a way that some of their parts are interchangeable. These challenges should not sound new to us at all; in fact, all throughout the book we have seen, analyzed, and used patterns to achieve this very purpose.","text_count":397,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we know how to switch between Node.js and browser code, the remaining pieces of the puzzle are how to integrate this within our design and how we can create our components in such a way that some of their parts are interchangeable. These challenges should not sound new to us at all; in fact, all throughout the book we have seen, analyzed, and used patterns to achieve this very purpose."}]},{"block_type":"element","block":"k5zy5c2o","search_text":"Let's revise some of them and describe how they apply to cross-platform development:","text_count":84,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's revise some of them and describe how they apply to cross-platform development:"}]},{"block_type":"element","block":"k5zy5c2p","search_text":"Strategy and Template : These two are probably the most useful patterns when sharing code with the browser. Their intent is, in fact, to define the common steps of an algorithm, allowing some of its parts to be replaced, which is exactly what we need! In cross-platform development, these patterns allow us to share the platform-agnostic part of our components, while allowing their platform-specific parts to be changed using a different strategy or template method (which can be changed using runtime or compile-time branching). Adapter : This pattern is probably the most useful when we need to swap an entire component. In Chapter 6, Design Patterns , we have already seen an example of how an entire module, incompatible with the browser, can be replaced with an adapter built on top of a browser-compatible interface. Do you remember the LevelUP adapter for the fs interface? Proxy : When code meant to run in the server runs in the browser, we often expect things that live on the server to be available in the browser as well. This is where the remote Proxy pattern comes into place. Imagine if we wanted to access the filesystem of the server from the browser: we could think of creating an fs object on the client that proxies every call to the fs module living on the server, using Ajax or Web Sockets as a way of exchanging commands and return values. Observer : The Observer pattern provides a natural abstraction between the component that emits the event and those that receive it. In cross-platform development, this means that we can replace the emitter with its browser-specific implementation without affecting the listeners and vice versa. DI and service locator : Both DI and service locator can be useful to replace the implementation of a module at the moment of its injection. ","text_count":1801,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Strategy and Template"}]},{"block_type":"text","content":": These two are probably the most useful patterns when sharing code with the browser. Their intent is, in fact, to define the common steps of an algorithm, allowing some of its parts to be replaced, which is exactly what we need! In cross-platform development, these patterns allow us to share the platform-agnostic part of our components, while allowing their platform-specific parts to be changed using a different strategy or template method (which can be changed using runtime or compile-time branching)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Adapter"}]},{"block_type":"text","content":": This pattern is probably the most useful when we need to swap an entire component. In Chapter 6,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Design Patterns"}]},{"block_type":"text","content":", we have already seen an example of how an entire module, incompatible with the browser, can be replaced with an adapter built on top of a browser-compatible interface. Do you remember the&nbsp;LevelUP adapter for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"interface?"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Proxy"}]},{"block_type":"text","content":": When code meant to run in the server runs in the browser, we often expect things that live on the server to be available in the browser as well. This is where the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"remote"}]},{"block_type":"text","content":"Proxy pattern comes into place. Imagine if we wanted to access the filesystem of the server from the browser: we could think of creating an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"object on the client that proxies every call to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"fs"}]},{"block_type":"text","content":"module living on the server, using Ajax or Web Sockets as a way of exchanging commands and return values."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Observer"}]},{"block_type":"text","content":": The Observer pattern provides a natural abstraction between the component that emits the event and those that receive it. In cross-platform development, this means that we can replace the emitter with its browser-specific implementation without affecting the listeners and vice versa."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"DI&nbsp;and service locator"}]},{"block_type":"text","content":": Both DI and service locator can be useful to replace the implementation of a module at the moment of its injection."}]}]},{"block_type":"element","block":"k5zy5c2q","search_text":"As we can see, the arsenal of patterns at our disposal is quite powerful, but the most powerful weapon is still the ability of the developer to choose the best approach and adapt it to the specific problem at hand. In the next section, we are going to put into action what we have learned, leveraging some of the concepts and patterns we have seen so far.","text_count":355,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, the arsenal of patterns at our disposal is quite powerful, but the most powerful weapon is still the ability of the developer to choose the best approach and adapt it to the specific problem at hand. In the next section, we are going to put into action what we have learned, leveraging some of the concepts and patterns we have seen so far."}]},{"block_type":"element","block":"k5zy5c2r","search_text":"Introducing React","text_count":17,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Introducing React"}]},{"block_type":"element","block":"k5zy5c2s","search_text":"From this point on in the chapter, we are going to use React (sometimes referred to as ReactJs ), a JavaScript library originally released by Facebook ( http://facebook.github.io/react/ ) and focused on providing a comprehensive set of functions and tools to build the view layer in our applications. React offers a view abstraction focused on the concept of components, where a component could be a button, a form input, a simple container such as an HTML div , or any other element in your user interface. The idea is that you should be able to construct the user interface of your application by just defining and composing highly reusable components with specific responsibilities.","text_count":685,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From this point on in the chapter, we are going to use"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"React"}]},{"block_type":"text","content":"(sometimes referred to as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"ReactJs"}]},{"block_type":"text","content":"), a JavaScript library originally released by Facebook ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://facebook.github.io/react/"},"children":[{"block_type":"text","content":"http://facebook.github.io/react/"}]},{"block_type":"text","content":") and focused on providing a comprehensive set of functions and tools to build the view layer in our applications. React offers a view abstraction focused on the concept of components, where a component could be a button, a form input, a simple container such as an HTML"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"div"}]},{"block_type":"text","content":", or any other element in your user interface. The idea is that you should be able to construct the user interface of your application by just defining and composing highly reusable components with specific responsibilities."}]},{"block_type":"element","block":"k5zy5c2t","search_text":"What makes React different from other view implementations for the web is that it is not bound to the DOM by design. In fact, it provides a higher level abstraction called virtual DOM that fits very well with the web but that can also be used in other contexts, for example, building mobile apps, modeling 3D environments, or even defining the interaction between hardware components.","text_count":384,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What makes React different from other view implementations for the web is that it is not bound to the DOM by design. In fact, it provides a higher level abstraction called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"virtual DOM"}]},{"block_type":"text","content":"that fits very well with the web but that can also be used in other contexts, for example, building mobile apps, modeling 3D environments, or even defining the interaction between hardware components."}]},{"block_type":"element","block":"k5zy5c2u","search_text":"\"Learn it once, use it everywhere\" -- Facebook ","text_count":47,"tag_name":"blockquote","attributes":{},"children":[{"block_type":"element","tag_name":"table","attributes":{"border":"0","width":"100%","cellspacing":"0","cellpadding":"0","summary":"Block quote"},"children":[{"block_type":"element","tag_name":"tbody","attributes":{},"children":[{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"&nbsp;"}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"\"Learn it once, use it everywhere\""}]}]}]},{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"&nbsp;"}]}]},{"block_type":"element","tag_name":"tr","attributes":{},"children":[{"block_type":"element","tag_name":"td","attributes":{},"children":[{"block_type":"text","content":"&nbsp;"}]},{"block_type":"element","tag_name":"td","attributes":{"colspan":"2"},"children":[{"block_type":"text","content":"--"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Facebook"}]}]}]}]}]}]},{"block_type":"element","block":"k5zy5c2v","search_text":"This is the motto often used by Facebook to introduce React. It intentionally mocks the famous Java motto, \"Write once, run it everywhere,\" with the clear intention to take distance from it and to state that every context is different and needs its own specific implementation but, at the same time, you can re-use some convenient principles and tools across contexts once you learn them.","text_count":388,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is the motto often used by Facebook to introduce React. It intentionally mocks the famous Java motto,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"\"Write once, run it everywhere,\""}]},{"block_type":"text","content":"with the clear intention to take distance from it and to state that every context is different and needs its own specific implementation but, at the same time, you can re-use some&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"convenient"}]},{"block_type":"text","content":"principles and tools across contexts once you learn them."}]},{"block_type":"element","block":"k5zy5c2w","search_text":"Note If you are interested in looking at the applications of React in contexts not strictly related to the field of web development, you can have a look at the following projects: React Native for mobile apps ( https://facebook.github.io/react-native ) React Three to create 3D scenes ( https://github.com/Izzimach/react-three ) React Hardware ( https://github.com/iamdustan/react-hardware ) ","text_count":392,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you are interested in looking at the applications of React in contexts not strictly related to the field of web development, you can have a look at the following projects:"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"React Native"}]},{"block_type":"text","content":"for mobile apps ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://facebook.github.io/react-native"},"children":[{"block_type":"text","content":"https://facebook.github.io/react-native"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"React Three"}]},{"block_type":"text","content":"to create 3D scenes ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/Izzimach/react-three"},"children":[{"block_type":"text","content":"https://github.com/Izzimach/react-three"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"React Hardware"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/iamdustan/react-hardware"},"children":[{"block_type":"text","content":"https://github.com/iamdustan/react-hardware"}]},{"block_type":"text","content":")"}]}]},{"block_type":"element","block":"k5zy5c2x","search_text":"The main reason why React is so interesting in the context of Universal JavaScript development is because it allows you to render the view code both from the server and on the client using almost the same code. To put it in another way, with React we are able to render all the HTML code that is required to display the page that the user requested directly from a Node.js server, and then, when the page is loaded, any additional interaction and rendering will be performed directly in the browser. This allows us to build Single-Page Applications (SPAs), where most of the things happen on the browser and only the part of the page that needs to be changed is refreshed. At the same time, this gives us the benefit of serving the first page loaded by the user straight off from the server, thus resulting in a faster (perceived) loading time and in a greater and easier indexability of the content for search engines.","text_count":919,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The main reason why React is so interesting in the context of Universal JavaScript development is because it allows you to render the view code both from the server and on the client using almost the same code. To put it in another way, with React we are able to render all the HTML code that is required to display the page that the user requested directly from a Node.js server, and then, when the page is loaded, any additional interaction and rendering will be performed directly in the browser. This allows us to build Single-Page Applications&nbsp;(SPAs), where most of the things happen on the browser and only the part of the page that needs to be changed is refreshed. At the same time, this gives us the benefit of serving the first page loaded by the user straight off from the server, thus resulting in a faster (perceived) loading time and in a greater and easier indexability of the content for search engines."}]},{"block_type":"element","block":"k5zy5c2y","search_text":"It's also worth mentioning that React Virtual DOM is capable of optimizing the way changes are rendered. This means that the DOM is not rendered in full after every change, and instead React uses a smart in-memory diffing algorithm that is able to pre-calculate the minimum number of changes to apply to the DOM in order to update the view. This results in a very efficient mechanism for fast browser rendering, and that's probably another important reason why React is gaining a lot of traction over other libraries and frameworks.","text_count":532,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's also worth mentioning that React Virtual DOM is capable of optimizing the way changes are rendered. This means that the DOM is not rendered in full after every change, and instead React uses a smart in-memory diffing algorithm that is able to pre-calculate the minimum number of changes to apply to the DOM in order to update the view. This results in a very efficient mechanism for fast browser rendering, and that's probably another important reason why React is gaining a lot of traction over other libraries and frameworks."}]},{"block_type":"element","block":"k5zy5c2z","search_text":"Without further ado, let's start to use React and jump to a concrete example.","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Without further ado, let's start to use React and jump to a concrete example."}]},{"block_type":"element","block":"k5zy5c30","search_text":"First React component","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"First React component"}]},{"block_type":"element","block":"k5zy5c31","search_text":"To start playing with React, we are going to build a very simple widget component to show a list of elements in our browser window.","text_count":131,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To start playing with React, we are going to build a very simple widget component to show a list of elements in our browser window."}]},{"block_type":"element","block":"k5zy5c32","search_text":"In this example, we will use some of the tools we have already seen throughout this chapter, such as Webpack and Babel, so before starting to write some code, let's install all the dependencies we are going to need:","text_count":215,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this example, we will use some of the tools we have already seen throughout this chapter, such as Webpack and Babel, so before starting to write some code, let's install all the dependencies we are going to need:"}]},{"block_type":"element","block":"k5zy5c33","search_text":"npm install webpack babel-core babel-loader babel-preset-es2015 ","text_count":64,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install webpack babel-core babel-loader babel-preset-es2015"}]}]},{"block_type":"element","block":"k5zy5c34","search_text":"We also need React and the Babel preset to turn React code into the equivalent ES5 code:","text_count":88,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We also need React and the Babel preset to turn React code into the equivalent ES5 code:"}]},{"block_type":"element","block":"k5zy5c35","search_text":"npm install react react-dom babel-preset-react ","text_count":47,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install react react-dom babel-preset-react"}]}]},{"block_type":"element","block":"k5zy5c36","search_text":"Now we are ready to write our first react component in a module called src/joyceBooks.js :","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to write our first react component in a module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"src/joyceBooks.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c37","search_text":"const React = require('react'); const books = [ 'Dubliners', 'A Portrait of the Artist as a Young Man', 'Exiles and poetry', 'Ulysses', 'Finnegans Wake' ]; class JoyceBooks extends React.Component { render() { return ( <div> <h2>James Joyce's major works</h2> <ul className=\"books\">{ books.map((book, index) => <li className=\"book\" key={index}>{book}</li> ) }</ul> </div> ); } } module.exports = JoyceBooks; ","text_count":408,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \n \nconst books = [ \n  'Dubliners', \n  'A Portrait of the Artist as a Young Man', \n  'Exiles and poetry', \n  'Ulysses', \n  'Finnegans Wake' \n]; \n \nclass JoyceBooks extends React.Component { \n  render() { \n    return ( \n      &lt;div&gt; \n        &lt;h2&gt;James Joyce's major works&lt;/h2&gt; \n        &lt;ul className=\"books\"&gt;{ \n          books.map((book, index) =&gt; \n            &lt;li className=\"book\" key={index}&gt;{book}&lt;/li&gt; \n          ) \n        }&lt;/ul&gt; \n      &lt;/div&gt; \n    ); \n  } \n} \n \nmodule.exports = JoyceBooks;"}]}]},{"block_type":"element","block":"k5zy5c38","search_text":"The first part of the code is very trivial; we are just importing the React module and defining a books array that contains book titles.","text_count":136,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first part of the code is very trivial; we are just importing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"React"}]},{"block_type":"text","content":"module and defining a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"books"}]},{"block_type":"text","content":"array that contains book titles."}]},{"block_type":"element","block":"k5zy5c39","search_text":"The second part is the most interesting one: it's the core of our component. Beware—if this is the first time you are looking at React code, it might look weird!","text_count":161,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The second part is the most interesting one: it's the core of our component. Beware&mdash;if this is the first time you are looking at React code, it might look weird!"}]},{"block_type":"element","block":"k5zy5c3a","search_text":"So, to define a React component, we need to create a class that extends from React.Component . This class must define a function called render , which is used to describe the part of the DOM for which the component is responsible.","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So, to define a React component, we need to create a class that extends from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"React.Component"}]},{"block_type":"text","content":". This class must define a function called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"render"}]},{"block_type":"text","content":", which is used to describe the part of the DOM for which the component is responsible."}]},{"block_type":"element","block":"k5zy5c3b","search_text":"But what is inside our render function? We are returning some sort of HTML with some sort of JavaScript code inside and we are not even wrapping all of it with quotes. Yes, in case you were wondering, this is not JavaScript, but it is JSX !","text_count":240,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But what is inside our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"render"}]},{"block_type":"text","content":"function? We are returning some sort of HTML with some sort of JavaScript code inside and we are not even wrapping all of it with quotes. Yes, in case you were wondering, this is not JavaScript, but it is&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"JSX"}]},{"block_type":"text","content":"!"}]},{"block_type":"element","block":"k5zy5c3c","search_text":"JSX, what?!","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"JSX, what?!"}]},{"block_type":"element","block":"k5zy5c3d","search_text":"As we said before, React provides a high level API for generating and manipulating the virtual DOM. The DOM is a great concept by itself and it can be easily represented with XML or HTML, but if we have to dynamically manipulate its tree dealing with low level concepts such as nodes , parents, and children, it might quickly get very cumbersome. To deal with this intrinsic complexity, React introduced JSX as an intermediate format designed to describe and manipulate the virtual DOM.","text_count":486,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we said before, React provides a&nbsp;high level API for generating and manipulating the virtual DOM. The DOM is a great concept by itself and it can be easily represented with XML or HTML, but if we have to dynamically manipulate its tree dealing with low level concepts such as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"nodes"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"parents,"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"children,"}]},{"block_type":"text","content":"it might quickly get very cumbersome. To deal with this intrinsic complexity, React introduced JSX as an intermediate format designed to describe and manipulate the virtual DOM."}]},{"block_type":"element","block":"k5zy5c3e","search_text":"Actually, JSX is not a language on its own, and it is in fact a superset of JavaScript that needs to be transpiled to plain JavaScript to be executed. However, it still gives the developer the advantage of using an XML-based syntax with JavaScript. When developing for the browser, JSX is used to describe the HTML code that defines our web components and, as you have seen in the previous example, we can put HTML tags directly in the middle of our JSX code as if they are a part of this enhanced JavaScript syntax.","text_count":516,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Actually, JSX is not a language on its own, and it is in fact a superset of JavaScript that needs to be transpiled to plain JavaScript to be executed. However, it still gives the developer the advantage of using an XML-based syntax with JavaScript. When developing for the browser, JSX is used to describe the HTML code that defines our web components and, as you have seen in the previous example, we can put HTML tags directly in the middle of our JSX code as if they are a part of this enhanced JavaScript syntax."}]},{"block_type":"element","block":"k5zy5c3f","search_text":"This approach offers an intrinsic advantage, that is, our HTML code is now dynamically validated at build time and we will get an ahead of time error if we forgot, for instance, to close one tag.","text_count":195,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This approach offers an intrinsic advantage, that is, our HTML code is now dynamically validated at build time and we will get an ahead of time error if we forgot, for instance, to close one tag."}]},{"block_type":"element","block":"k5zy5c3g","search_text":"Let's now analyze the render function from the previous example to understand some important details of JSX:","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now analyze the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"render"}]},{"block_type":"text","content":"function from the previous example to understand some important details of JSX:"}]},{"block_type":"element","block":"k5zy5c3h","search_text":"render() { return ( <div> <h2>James Joyce's major works</h2> <ul className=\"books\">{ books.map((book, index) => <li className=\"book\" key={index}>{book}</li> ) }</ul> </div> ); } ","text_count":178,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"render() { \n  return ( \n    &lt;div&gt; \n      &lt;h2&gt;James Joyce's major works&lt;/h2&gt; \n      &lt;ul className=\"books\"&gt;{ \n        books.map((book, index) =&gt; \n          &lt;li className=\"book\" key={index}&gt;{book}&lt;/li&gt; \n        ) \n      }&lt;/ul&gt; \n    &lt;/div&gt; \n  ); \n}"}]}]},{"block_type":"element","block":"k5zy5c3i","search_text":"As you saw, we can insert a piece of HTML code at any point of our JSX code without having to put any particular indicator or wrapper around it. In this case, we simply defined a div tag, which acts as a container for our component.","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you saw, we can insert a piece of HTML code at any point of our JSX code without having to put any particular indicator or wrapper around it. In this case, we simply defined a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"div"}]},{"block_type":"text","content":"&nbsp;tag, which acts as a container for our component."}]},{"block_type":"element","block":"k5zy5c3j","search_text":"We can also put some JavaScript logic within this HTML block; notice the curly brackets within the ul tag. This approach allows us to define parts of the HTML code dynamically in a similar fashion to what you can do with many templating engines. In this case, we are using the native JavaScript map function to iterate over all the available books in the array, and for every one of them we create another piece of HTML to add the book name to the list.","text_count":453,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can also put some JavaScript logic within this HTML block; notice the curly brackets within the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ul"}]},{"block_type":"text","content":"tag. This approach allows us to define parts of the HTML code dynamically in a similar fashion to what you can do with many templating engines. In this case, we are using the native JavaScript"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"function to iterate over all the available books in the array, and for every one of them we create another piece of HTML to add the book name to the list."}]},{"block_type":"element","block":"k5zy5c3k","search_text":"The curly brackets are used to define an expression within an HTML block, and the simplest use case is to use them to print the content of a variable, like we are doing here with {book} .","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The curly brackets are used to define an expression within an HTML block, and the simplest use case is to use them to print the content of a variable, like we are doing here with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{book}"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5c3l","search_text":"Finally, notice that we can again put another block of HTML code within this JavaScript content, so that HTML and JavaScript content can be mixed and nested at any level to describe the Virtual DOM.","text_count":198,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, notice that we can again put another block of HTML code within this JavaScript content, so that HTML and JavaScript content can be mixed and nested at any level to describe the Virtual DOM."}]},{"block_type":"element","block":"k5zy5c3m","search_text":"It is not mandatory to use JSX when developing with React. JSX is just a nice interface on top of the React Virtual DOM JavaScript library. With some additional effort, you can achieve the same results by calling these functions directly and completely skipping JSX and its transpilation step. Just to give you an idea about how React code looks without JSX, have a look at the transpiled version of the render function of our example:","text_count":435,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is not mandatory to use JSX when developing with React. JSX is just a nice interface on top of the React Virtual DOM JavaScript library. With some additional effort, you can achieve the same results by calling these functions directly and completely skipping JSX and its transpilation step. Just to give you an idea about how React code looks without JSX, have a look at the transpiled version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"render"}]},{"block_type":"text","content":"function of our example:"}]},{"block_type":"element","block":"k5zy5c3n","search_text":"function render() { return React.createElement( 'div', null, React.createElement( 'h2', null, 'James Joyce's major works' ), React.createElement( 'ul', { className: 'books' }, books.map(function (book) { return React.createElement( 'li', { className: 'book' }, book ); }) ) ); } ","text_count":279,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"function render() { \n  return React.createElement( \n    'div', \n    null, \n    React.createElement( \n      'h2', \n      null, \n      'James Joyce's major works' \n    ), \n    React.createElement( \n      'ul', \n      { className: 'books' }, \n      books.map(function (book) { \n        return React.createElement( \n          'li', \n          { className: 'book' }, \n           book \n        ); \n      }) \n    ) \n  ); \n}"}]}]},{"block_type":"element","block":"k5zy5c3o","search_text":"As you can see, this code looks much less readable and more prone to errors, so most of the time it is better to rely on JSX and use a transpiler to generate the equivalent JavaScript code.","text_count":189,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, this code looks much less readable and more prone to errors, so most of the time it is better to rely on JSX and use a transpiler to generate the equivalent JavaScript code."}]},{"block_type":"element","block":"k5zy5c3p","search_text":"To complete our quick overview of JSX, let's have a look at how this code will be finally rendered to HTML when executed:","text_count":121,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To complete our quick overview of JSX, let's have a look at how this code will be finally rendered to HTML when executed:"}]},{"block_type":"element","block":"k5zy5c3q","search_text":"<div data-reactroot=\"\"> <h2>James Joyce's major works</h2> <ul class=\"books\"> <li class=\"book\">Dubliners</li> <li class=\"book\">A Portrait of the Artist as a Young Man</li> <li class=\"book\">Exiles and poetry</li> <li class=\"book\">Ulysses</li> <li class=\"book\">Finnegans Wake</li> </ul> </div> ","text_count":292,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&lt;div data-reactroot=\"\"&gt; \n  &lt;h2&gt;James Joyce's major works&lt;/h2&gt; \n    &lt;ul class=\"books\"&gt; \n      &lt;li class=\"book\"&gt;Dubliners&lt;/li&gt; \n      &lt;li class=\"book\"&gt;A Portrait of the Artist as a Young Man&lt;/li&gt; \n      &lt;li class=\"book\"&gt;Exiles and poetry&lt;/li&gt; \n      &lt;li class=\"book\"&gt;Ulysses&lt;/li&gt; \n      &lt;li class=\"book\"&gt;Finnegans Wake&lt;/li&gt; \n    &lt;/ul&gt; \n&lt;/div&gt;"}]}]},{"block_type":"element","block":"k5zy5c3r","search_text":"One last thing to notice here is that in the JSX/JavaScript version of the code, we used the attribute className and it was here converted to class . It's important to underline that when we work with the virtual DOM, we must use the DOM equivalent attributes for HTML attributes; React will then take care to convert them when rendering the HTML code.","text_count":352,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One last thing to notice here is that in the JSX/JavaScript version of the code, we used the attribute"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"className"}]},{"block_type":"text","content":"and it was here converted to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"class"}]},{"block_type":"text","content":". It's important to underline that when we work with the virtual DOM, we must use the DOM equivalent attributes for HTML attributes; React will then take care to convert them when rendering the HTML code."}]},{"block_type":"element","block":"k5zy5c3s","search_text":"Note A list with all the supported tags and attributes in React is available in the official documentation at https://facebook.github.io/react/docs/tags-and-attributes.html . If you are interested in knowing more about JSX syntax, you can read the official specification provided by Facebook: https://facebook.github.io/jsx . ","text_count":326,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A list with all the supported tags and attributes in React is available in the official documentation at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://facebook.github.io/react/docs/tags-and-attributes.html"},"children":[{"block_type":"text","content":"https://facebook.github.io/react/docs/tags-and-attributes.html"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If you are interested in knowing more about JSX syntax, you can read the official specification provided by Facebook:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://facebook.github.io/jsx"},"children":[{"block_type":"text","content":"https://facebook.github.io/jsx"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5c3t","search_text":"Configuring Webpack to transpile JSX","text_count":36,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Configuring Webpack to transpile JSX"}]},{"block_type":"element","block":"k5zy5c3u","search_text":"In this section, we will see an example of Webpack configuration that we can use to be able to transpile JSX code to JavaScript code that can be executed in the browser:","text_count":169,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will see an example of Webpack configuration that we can use to be able to transpile JSX code to JavaScript code that can be executed in the browser:"}]},{"block_type":"element","block":"k5zy5c3v","search_text":"const path = require('path'); module.exports = { entry: path.join(__dirname, \"src\", \"main.js\"), output: { path: path.join(__dirname, \"dist\"), filename: \"bundle.js\" }, module: { loaders: [ { test: path.join(__dirname, \"src\"), loader: 'babel-loader', query: { cacheDirectory: 'babel_cache', presets: ['es2015', 'react'] } } ] } }; ","text_count":329,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const path = require('path'); \nmodule.exports = { \n  entry:  path.join(__dirname, \"src\", \"main.js\"), \n  output: { \n    path: path.join(__dirname, \"dist\"), \n    filename: \"bundle.js\" \n  }, \n  module: { \n    loaders: [ \n      { \n        test: path.join(__dirname, \"src\"), \n        loader: 'babel-loader', \n        query: { \n          cacheDirectory: 'babel_cache', \n          presets: ['es2015', 'react'] \n        } \n      } \n    ] \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5c3w","search_text":"As you might have noticed, this configuration is almost identical to the one we saw in the previous ES2015 Webpack example. The only relevant differences are as follows:","text_count":169,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you might have noticed, this configuration is almost identical to the one we saw in the previous ES2015 Webpack example. The only relevant differences are as follows:"}]},{"block_type":"element","block":"k5zy5c3x","search_text":"We are using the react preset in Babel. We are using the option cacheDirectory . This option allows Babel to use a specific directory as a cache folder (in this case, babel_cache ) and be faster while building the bundle file. It is not mandatory but highly encouraged to speed up the development. ","text_count":298,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We are using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"react"}]},{"block_type":"text","content":"preset in Babel."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We are using the option"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cacheDirectory"}]},{"block_type":"text","content":". This option allows Babel to use a specific directory as a cache folder (in this case,&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"babel_cache"}]},{"block_type":"text","content":") and be faster while building the bundle file. It is not mandatory but highly encouraged to speed up the development."}]}]},{"block_type":"element","block":"k5zy5c3y","search_text":"Rendering in the browser","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Rendering in the browser"}]},{"block_type":"element","block":"k5zy5c3z","search_text":"Now that we have our first React component ready, we just need to use it and render it in the browser. Let's create our src/main.js JavaScript file to use our JoyceBooks component:","text_count":180,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that we have our first React component ready, we just need to use it and render it in the browser. Let's create our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"src/main.js"}]},{"block_type":"text","content":"JavaScript file to use our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"JoyceBooks"}]},{"block_type":"text","content":"component:"}]},{"block_type":"element","block":"k5zy5c40","search_text":"const React = require('react'); const ReactDOM = require('react-dom'); const JoyceBooks = require('./joyceBooks'); window.onload = () => { ReactDOM.render(<JoyceBooks/>, document.getElementById('main')) }; ","text_count":206,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst ReactDOM = require('react-dom'); \nconst JoyceBooks = require('./joyceBooks'); \n \nwindow.onload = () =&gt; { \n  ReactDOM.render(&lt;JoyceBooks/&gt;, document.getElementById('main')) \n};"}]}]},{"block_type":"element","block":"k5zy5c41","search_text":"The most important part of the code here is the ReactDOM.render function call. This function takes as arguments a JSX code block and a DOM element, and it will take care to render the JSX block to HTML code and apply it to the DOM node given as a second argument. Also notice that the JSX block we are passing here contains only a custom tag ( JoyceBooks ). Every time we require a component, it will be available as a JSX tag (where the name of the tag is given by the class name of the component) so that we can easily insert a new instance of this component in other JSX blocks. This is the base mechanism that allows the developer to split the interface into several cohesive components.","text_count":691,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most important part of the code here is the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ReactDOM.render"}]},{"block_type":"text","content":"function call. This function takes as arguments a JSX code block and a DOM element, and it will take care to render the JSX block to HTML code and apply it to the DOM node given as a second argument. Also notice that the JSX block we are passing here contains only a custom tag ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"JoyceBooks"}]},{"block_type":"text","content":"). Every time we require a component, it will be available as a JSX tag (where the name of the tag is given by the class name of the component) so that we can easily insert a new instance of this component in other JSX blocks. This is the base mechanism that allows the developer to split the interface into several cohesive components."}]},{"block_type":"element","block":"k5zy5c42","search_text":"Now the last step we need to perform to see our first React example live is to create an index.html page:","text_count":105,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now the last step we need to perform to see our first React example live is to create an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.html"}]},{"block_type":"text","content":"page:"}]},{"block_type":"element","block":"k5zy5c43","search_text":"<!DOCTYPE html> <html> <head> <meta charset=\"utf-8\" /> <title>React Example - James Joyce books</title> </head> <body> <div id=\"main\"></div> <script src=\"dist/bundle.js\"></script> </body> </html> ","text_count":196,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&lt;!DOCTYPE html&gt; \n&lt;html&gt; \n  &lt;head&gt; \n    &lt;meta charset=\"utf-8\" /&gt; \n    &lt;title&gt;React Example - James Joyce books&lt;/title&gt; \n  &lt;/head&gt; \n  &lt;body&gt; \n    &lt;div id=\"main\"&gt;&lt;/div&gt; \n    &lt;script src=\"dist/bundle.js\"&gt;&lt;/script&gt; \n  &lt;/body&gt; \n&lt;/html&gt;"}]}]},{"block_type":"element","block":"k5zy5c44","search_text":"This is very simple and doesn't require much explanation. We are just adding our bundle.js file to a plain HTML page which contains div with the ID main that will act as a container for our React application.","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is very simple and doesn't require much explanation. We are just adding our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"bundle.js"}]},{"block_type":"text","content":"file to a plain HTML page which contains"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"div"}]},{"block_type":"text","content":"with the ID"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main"}]},{"block_type":"text","content":"that will act as a container for our React application."}]},{"block_type":"element","block":"k5zy5c45","search_text":"You can now just launch webpack from the command line and then open the index.html page in your browser.","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can now just launch"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"webpack"}]},{"block_type":"text","content":"from the command line and then open the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.html"}]},{"block_type":"text","content":"page in your browser."}]},{"block_type":"element","block":"k5zy5c46","search_text":"What is important to understand is what happens with client-side rendering when the user loads the page:","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What is important to understand is what happens with client-side rendering when the user loads the page:"}]},{"block_type":"element","block":"k5zy5c47","search_text":"The HTML code of the page is downloaded by the browser and then rendered. The bundle file is downloaded and its JavaScript content is evaluated. The evaluated code takes care to generate the real content of our page dynamically and updates the DOM to display it. ","text_count":263,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The HTML code of the page is downloaded by the browser and then rendered."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The bundle file is downloaded and its JavaScript content is evaluated."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The evaluated code takes care to generate the real content of our page dynamically and updates the DOM to display it."}]}]},{"block_type":"element","block":"k5zy5c48","search_text":"This means that if this page is loaded by a browser which has JavaScript disabled (for example, a search engine bot), our webpage will look like a blank webpage without any meaningful content. This might be a very serious problem, especially in terms of SEO.","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This means that if this page is loaded by a browser which has JavaScript disabled (for example, a search engine bot), our webpage will look like a blank webpage without any meaningful content. This might be a very serious problem, especially in terms of SEO."}]},{"block_type":"element","block":"k5zy5c49","search_text":"Later in this chapter, we will see how to render the same React component from the server to overcome this limitation.","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Later in this chapter, we will see how to render the same React component from the server to overcome this limitation."}]},{"block_type":"element","block":"k5zy5c4a","search_text":"The React Router library","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The React Router library"}]},{"block_type":"element","block":"k5zy5c4b","search_text":"In this section, we will improve our previous example of building a very simple navigable app consisting of several screens. We will have three different sections: an index page, the page of the books by James Joyce, and the page of the books by H. G. Wells. We will also have a page to show when the user tries to access a URL that does not exist.","text_count":348,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will improve our previous example of building a very simple navigable app consisting of several screens. We will have three different sections: an index page, the page of the books by James Joyce, and the page of the books by H. G. Wells. We will also have a page to show when the user tries to access a URL that does not exist."}]},{"block_type":"element","block":"k5zy5c4c","search_text":"To build this app, we will use the React Router library, ( https://github.com/reactjs/react-router ), a module that makes it easy to have navigable components in React. So, the first thing we need to do is to download React Router in our project with:","text_count":251,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To build this app, we will use the React Router library, ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/reactjs/react-router"},"children":[{"block_type":"text","content":"https://github.com/reactjs/react-router"}]},{"block_type":"text","content":"), a module that makes it easy to have navigable components in React. So, the first thing we need to do is to download React Router in our project with:"}]},{"block_type":"element","block":"k5zy5c4d","search_text":"npm install react-router ","text_count":25,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install react-router"}]}]},{"block_type":"element","block":"k5zy5c4e","search_text":"Now we are ready to create all the components needed to build the sections of this new app. Let's start with src/components/authorsIndex.js :","text_count":141,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to create all the components needed to build the sections of this new app. Let's start with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"src/components/authorsIndex.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c4f","search_text":"const React = require('react'); const Link = require('react-router').Link; const authors = [ {id: 1, name: 'James Joyce', slug: 'joyce'}, {id: 2, name: 'Herbert George Wells', slug: 'h-g-wells'} ]; class AuthorsIndex extends React.Component { render() { return ( <div> <h1>List of authors</h1> <ul>{ authors.map( author => <li key={author.id}><Link to={`/author/${author.slug}`}> {author.name}</Link></li> ) }</ul> </div> ) } } module.exports = AuthorsIndex; ","text_count":459,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst Link = require('react-router').Link; \n \nconst authors = [ \n  {id: 1, name: 'James Joyce', slug: 'joyce'}, \n  {id: 2, name: 'Herbert George Wells', slug: 'h-g-wells'} \n]; \n \nclass AuthorsIndex extends React.Component { \n  render() { \n    return ( \n      &lt;div&gt; \n        &lt;h1&gt;List of authors&lt;/h1&gt; \n        &lt;ul&gt;{ \n          authors.map( author =&gt; \n            &lt;li key={author.id}&gt;&lt;Link to={`/author/${author.slug}`}&gt;  \n                    {author.name}&lt;/Link&gt;&lt;/li&gt; \n          ) \n        }&lt;/ul&gt; \n      &lt;/div&gt; \n    ) \n  } \n} \n \nmodule.exports = AuthorsIndex;"}]}]},{"block_type":"element","block":"k5zy5c4g","search_text":"This component represents the index of our application. It displays the name of the two authors. Notice that, again, to keep things simple, we are storing the data necessary to render this component in authors , an array of objects, each one representing an author. Another new element is the Link component. As you might have guessed, this component comes from the React Router library and allows us to render clickable links that can be used to navigate through the available sections of the app. What is important to understand is the property to of the Link component. It is used to specify a relative URI that indicates the specific route to display when the link is clicked. So, it is not very different than a regular HTML <a> tag, the only difference is that, instead of moving to a new page by refreshing the full page, React Router will take care to dynamically only refresh the part of the page that needs to be changed to display the component associated with the new URI. We will see better how this mechanism works when we write the configuration for our router. For now, let's focus on writing all the other components that we want to use in our app. So, now let's rewrite our JoyceBooks components that, this time, will be stored in components/joyceBooks.js :","text_count":1275,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This component represents the index of our application. It displays the name of the two authors. Notice that, again, to keep things simple, we are storing the data necessary to render this component in"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authors"}]},{"block_type":"text","content":", an array of objects, each one representing an author. Another new element is the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Link"}]},{"block_type":"text","content":"component. As you might have guessed, this component comes from the React Router library and allows us to render clickable links that can be used to navigate through the available sections of the app. What is important to understand is the property"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"to"}]},{"block_type":"text","content":"of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Link"}]},{"block_type":"text","content":"component. It is used to specify a relative URI that indicates the specific route to display when the link is clicked. So, it is not very different than a regular HTML"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"&lt;a&gt;"}]},{"block_type":"text","content":"tag, the only difference is that, instead of moving to a new page by refreshing the full page, React Router will take care to dynamically only refresh the part of the page that needs to be changed to display the component associated with the new URI. We will see better how this mechanism works when we write the configuration for our router. For now, let's focus on writing all the other components that we want to use in our app. So, now let's rewrite our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"JoyceBooks"}]},{"block_type":"text","content":"components that, this time, will be stored in"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"components/joyceBooks.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c4h","search_text":"const React = require('react'); const Link = require('react-router').Link; const books = [ 'Dubliners', 'A Portrait of the Artist as a Young Man', 'Exiles and poetry', 'Ulysses', 'Finnegans Wake' ]; class JoyceBooks extends React.Component { render() { return ( <div> <h2>James Joyce's major works</h2> <ul className=\"books\">{ books.map( (book, key) => <li key={key} className=\"book\">{book}</li> ) }</ul> <Link to=\"/\">Go back to index</Link> </div> ); } } module.exports = JoyceBooks; ","text_count":485,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst Link = require('react-router').Link; \n \nconst books = [ \n  'Dubliners', \n  'A Portrait of the Artist as a Young Man', \n  'Exiles and poetry', \n  'Ulysses', \n  'Finnegans Wake' \n]; \n \nclass JoyceBooks extends React.Component { \n  render() { \n    return ( \n      &lt;div&gt; \n        &lt;h2&gt;James Joyce's major works&lt;/h2&gt; \n        &lt;ul className=\"books\"&gt;{ \n          books.map( (book, key) =&gt; \n            &lt;li key={key} className=\"book\"&gt;{book}&lt;/li&gt; \n          ) \n        }&lt;/ul&gt; \n        &lt;Link to=\"/\"&gt;Go back to index&lt;/Link&gt; \n      &lt;/div&gt; \n    ); \n  } \n} \n \nmodule.exports = JoyceBooks;"}]}]},{"block_type":"element","block":"k5zy5c4i","search_text":"As we might have expected, this component looks very similar to its previous version. The only notable differences are that we are adding Link to go back to the index at the end of the component and that we are using the attribute key inside our map function. With this last change, we are telling React that the specific element is identified by a unique key (in this case, we are using the index of the array for simplicity) so that it can perform a number of optimizations whenever it needs to re-render the list. This last change is not mandatory but it is heavily recommended, especially in larger applications.","text_count":616,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we might have expected, this component looks very similar to its previous version. The only notable differences are that we are adding&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Link"}]},{"block_type":"text","content":"to go back to the index at the end of the component and that we are using the attribute"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"key"}]},{"block_type":"text","content":"inside our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"map"}]},{"block_type":"text","content":"function. With this last change, we are telling React that the specific element is identified by a unique key (in this case, we are using the index of the array for simplicity) so that it can perform a number of optimizations whenever it needs to re-render the list. This last change is not mandatory but it is heavily recommended, especially in larger applications."}]},{"block_type":"element","block":"k5zy5c4j","search_text":"Now following the same schema, we can write our components/wellsBooks.js component:","text_count":83,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now following the same schema, we can write our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"components/wellsBooks.js"}]},{"block_type":"text","content":"component:"}]},{"block_type":"element","block":"k5zy5c4k","search_text":"const React = require('react'); const Link = require('react-router').Link; const books = [ 'The Time Machine', 'The War of the Worlds', 'The First Men in the Moon', 'The Invisible Man' ]; class WellsBooks extends React.Component { render() { return ( <div> <h2>Herbert George Wells's major works</h2> <ul className=\"books\">{ books.map( (book, key) => <li key={key} className=\"book\">{book}</li> ) }</ul> <Link to=\"/\">Go back to index</Link> </div> ); } } module.exports = WellsBooks; ","text_count":483,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst Link = require('react-router').Link; \n \nconst books = [ \n  'The Time Machine', \n  'The War of the Worlds', \n  'The First Men in the Moon', \n  'The Invisible Man' \n]; \n \nclass WellsBooks extends React.Component { \n  render() { \n    return ( \n      &lt;div&gt; \n        &lt;h2&gt;Herbert George Wells's major works&lt;/h2&gt; \n        &lt;ul className=\"books\"&gt;{ \n          books.map( (book, key) =&gt; \n            &lt;li key={key} className=\"book\"&gt;{book}&lt;/li&gt; \n          ) \n        }&lt;/ul&gt; \n        &lt;Link to=\"/\"&gt;Go back to index&lt;/Link&gt; \n      &lt;/div&gt; \n    ); \n  } \n} \n \nmodule.exports = WellsBooks;"}]}]},{"block_type":"element","block":"k5zy5c4l","search_text":"This component is almost identical to the previous one and, of course, this should ring a bell! We could build a more generic AuthorPage component and avoid code duplication, but this will be the topic for the next section, here we want to focus only on routing.","text_count":262,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This component is almost identical to the previous one and, of course, this should ring a bell! We could build a more generic"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"AuthorPage"}]},{"block_type":"text","content":"component and avoid code duplication, but this will be the topic for the next section, here we want to focus only on routing."}]},{"block_type":"element","block":"k5zy5c4m","search_text":"We also want to have a components/notFound.js component that just displays an error message. We will skip this trivial implementation for the sake of brevity.","text_count":158,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We also want to have a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"components/notFound.js"}]},{"block_type":"text","content":"component that just displays an error message. We will skip this trivial implementation for the sake of brevity."}]},{"block_type":"element","block":"k5zy5c4n","search_text":"So, now let's move to the interesting part—the routes.js component which defines the logic of our routing:","text_count":106,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So, now let's move to the interesting part&mdash;the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routes.js"}]},{"block_type":"text","content":"component which defines the logic of our routing:"}]},{"block_type":"element","block":"k5zy5c4o","search_text":"const React = require('react'); const ReactRouter = require('react-router'); const Router = ReactRouter.Router; const Route = ReactRouter.Route; const hashHistory = ReactRouter.hashHistory; const AuthorsIndex = require('./components/authorsIndex'); const JoyceBooks = require('./components/joyceBooks'); const WellsBooks = require('./components/wellsBooks'); const NotFound = require('./components/notFound'); class Routes extends React.Component { render() { return ( <Router history={hashHistory}> <Route path=\"/\" component={AuthorsIndex}/> <Route path=\"/author/joyce\" component={JoyceBooks}/> <Route path=\"/author/h-g-wells\" component={WellsBooks}/> <Route path=\"*\" component={NotFound} /> </Router> ) } } module.exports = Routes; ","text_count":734,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst ReactRouter = require('react-router'); \nconst Router = ReactRouter.Router; \nconst Route = ReactRouter.Route; \nconst hashHistory = ReactRouter.hashHistory; \nconst AuthorsIndex = require('./components/authorsIndex'); \nconst JoyceBooks = require('./components/joyceBooks'); \nconst WellsBooks = require('./components/wellsBooks'); \nconst NotFound = require('./components/notFound'); \n \nclass Routes extends React.Component { \n  render() { \n    return ( \n      &lt;Router history={hashHistory}&gt; \n        &lt;Route path=\"/\" component={AuthorsIndex}/&gt; \n        &lt;Route path=\"/author/joyce\" component={JoyceBooks}/&gt; \n        &lt;Route path=\"/author/h-g-wells\" component={WellsBooks}/&gt; \n        &lt;Route path=\"*\" component={NotFound} /&gt; \n      &lt;/Router&gt; \n    ) \n  } \n} \nmodule.exports = Routes;"}]}]},{"block_type":"element","block":"k5zy5c4p","search_text":"The first thing to analyze here is the list of modules that we need to implement the routing component of our app. We are requiring the react-router , which in turn contains three modules that we want to use: Router , Route , and hashHistory .","text_count":243,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first thing to analyze here is the list of modules that we need to implement the routing component of our app. We are requiring the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"react-router"}]},{"block_type":"text","content":", which in turn contains three modules that we want to use:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Router"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Route"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"hashHistory"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5c4q","search_text":"Router is the main component that holds all the routing configuration. It's the element we use as the root node for our Routes component. The property history specifies the mechanism used to detect which route is active and how to update the URL in the browser bar every time the user clicks on a link. There are commonly two strategies: hashHistory and browserHistory . The first one uses the fragment part of the URL (the one delimited by the hash symbol). With this strategy, our links will look like this: index.html#/author/h-g-wells .The second strategy does not use the fragment but leverages the HTML5 history API ( https://developer.mozilla.org/en-US/docs/Web/API/History_API ) to display more realistic URLs. With this strategy, every path has its own full URI, such as http://example.com/author/h-g-wells .","text_count":817,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Router"}]},{"block_type":"text","content":"is the main component that holds all the routing configuration. It's the element we use as the root node for our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Routes"}]},{"block_type":"text","content":"component. The property"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"history"}]},{"block_type":"text","content":"&nbsp;specifies the mechanism used to detect which route is active and how to update the URL in the browser bar every time the user clicks on a link. There are commonly two strategies:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"hashHistory"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"browserHistory"}]},{"block_type":"text","content":". The first one uses the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"fragment"}]},{"block_type":"text","content":"part of the URL (the one delimited by the hash symbol). With this strategy, our links will look like this:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.html#/author/h-g-wells"}]},{"block_type":"text","content":".The second strategy does not use the fragment but leverages the HTML5"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"history API"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://developer.mozilla.org/en-US/docs/Web/API/History_API"},"children":[{"block_type":"text","content":"https://developer.mozilla.org/en-US/docs/Web/API/History_API"}]},{"block_type":"text","content":") to display more realistic URLs. With this strategy, every path has its own full URI, such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://example.com/author/h-g-wells"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5c4r","search_text":"In this example, we are using the hashHistory strategy as it is the simplest to set up and doesn't require a web server to refresh the page. We will have chance to use the browserHistory strategy later in this chapter.","text_count":218,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this example, we are using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"hashHistory"}]},{"block_type":"text","content":"strategy as it is the simplest to set up and doesn't require a web server to refresh the page. We will have chance to use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"browserHistory"}]},{"block_type":"text","content":"strategy later in this chapter."}]},{"block_type":"element","block":"k5zy5c4s","search_text":"The Route component allows us to define an association between a path and a component . This component will be rendered when the route is matched.","text_count":146,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Route"}]},{"block_type":"text","content":"component allows us to define an association between a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"path"}]},{"block_type":"text","content":"and a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"component"}]},{"block_type":"text","content":". This component will be rendered when the route is matched."}]},{"block_type":"element","block":"k5zy5c4t","search_text":"Inside our render function, we are summarizing and composing all these concepts and, now that you know the meaning of every component and option, you should be able to make sense of it.","text_count":185,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Inside our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"render"}]},{"block_type":"text","content":"function, we are summarizing and composing all these concepts and, now that you know the meaning of every component and option, you should be able to make sense of it."}]},{"block_type":"element","block":"k5zy5c4u","search_text":"What is important to understand here is the way the Router component works with this declarative syntax:","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What is important to understand here is the way the&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Router"}]},{"block_type":"text","content":"component works with this declarative syntax:"}]},{"block_type":"element","block":"k5zy5c4v","search_text":"It acts as a container; it doesn't render any HTML code but contains a list of Route definitions. Every Route definition is associated to a component. This time, the component is a graphical component, meaning that it will be rendered in the HTML code of the page, but only if the current URL of the page matches the route. Only one route can be matched for a given URI. In ambiguous cases, the router prefers the less generic routes (for example, /author/joyce over /author ). It is possible to define a catch-all route with * , which is matched only when all the other routes are not matched. We are using it here to display our \"not found\" message. Now the last step to complete this example is to update our main.js to use the Routes component as the main component of our application: ","text_count":790,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"It acts as a container; it doesn't render any HTML code but contains a list of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Route"}]},{"block_type":"text","content":"definitions."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Every"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Route"}]},{"block_type":"text","content":"definition is associated to a component. This time, the component is a graphical component, meaning that it will be rendered in the HTML code of the page, but only if the current URL of the page matches the route."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Only one route can be matched for a given URI. In ambiguous cases, the router prefers the less generic routes (for example,&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/author/joyce"}]},{"block_type":"text","content":"over"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/author"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"It is possible to define a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"catch-all"}]},{"block_type":"text","content":"route with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"*"}]},{"block_type":"text","content":", which is matched only when all the other routes are not matched. We are using it here to display our \"not found\" message."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Now the last step to complete this example is to update our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main.js"}]},{"block_type":"text","content":"to use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Routes"}]},{"block_type":"text","content":"component as the main component of our application:"}]}]},{"block_type":"element","block":"k5zy5c4w","search_text":"const React = require('react'); const ReactDOM = require('react-dom'); const Routes = require('./routes'); window.onload = () => { ReactDOM.render(<Routes/>, document.getElementById('main')) }; ","text_count":194,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \n       const ReactDOM = require('react-dom'); \n       const Routes = require('./routes'); \n \n       window.onload = () =&gt; { \n         ReactDOM.render(&lt;Routes/&gt;, document.getElementById('main')) \n       };"}]}]},{"block_type":"element","block":"k5zy5c4x","search_text":"Now we just need to run Webpack to regenerate our bundle file and open the index.html to see our new app working.","text_count":113,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we just need to run Webpack to regenerate our bundle file and open the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.html"}]},{"block_type":"text","content":"to see our new app working."}]},{"block_type":"element","block":"k5zy5c4y","search_text":"Try to click around and see how the URL gets updated. Also, if you use any debug tool, you will notice how the transition between one section and another doesn't fully refresh the page neither trigger a new request. The app is in fact completely loaded when we open the index page and the router is used here to basically show and hide the right component given the current URI. Anyway, the router is smart enough that if we try to refresh the page with a specific URI (for example, index.html#/author/joyce ), it will immediately display the correct component.","text_count":561,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Try to click around and see how the URL gets updated. Also, if you use any debug tool, you will notice how the transition between one section and another doesn't fully refresh the page neither trigger a new request. The app is in fact completely loaded when we open the index page and the router is used here to basically show and hide the right component given the current URI. Anyway, the router is smart enough that if we try to refresh the page with a specific URI (for example,&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.html#/author/joyce"}]},{"block_type":"text","content":"), it will immediately display the correct component."}]},{"block_type":"element","block":"k5zy5c4z","search_text":"React Router is a very powerful component and it has a number of interesting features. For example, it allows you to have nested routes to represent multi-level user interfaces (components with nested sections). We will also see in this chapter how it can be extended to load components and data on demand. In the meantime, you can have a break and read the official documentation of the component to discover all the available features.","text_count":437,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"React Router is a very powerful component and it has a number of interesting features. For example, it allows you to have nested routes to represent multi-level user interfaces (components with nested sections). We will also see in this chapter how it can be extended to load components and data on demand. In the meantime, you can have a break and read the official documentation of the component to discover all the available features."}]},{"block_type":"element","block":"k5zy5c50","search_text":"Creating a Universal JavaScript app","text_count":35,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Creating a Universal JavaScript app"}]},{"block_type":"element","block":"k5zy5c51","search_text":"At this stage of the chapter, we should have got most of the basics that we need to transform our sample app into a full Universal JavaScript app. We met Webpack, ReactJs, and analyzed most of the patterns that help us to uniform and differentiate the code between platforms as needed.","text_count":285,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this stage of the chapter, we should have got most of the basics that we need to transform our sample app into a full Universal JavaScript app. We met Webpack, ReactJs, and analyzed most of the patterns that help us to uniform and differentiate the code between platforms as needed."}]},{"block_type":"element","block":"k5zy5c52","search_text":"In this section, we will keep improving our example by creating reusable components, by adding universal routing and rendering, and finally universal data retrieval.","text_count":165,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will keep improving our example by creating reusable components, by adding universal routing and rendering, and finally universal data retrieval."}]},{"block_type":"element","block":"k5zy5c53","search_text":"Creating reusable components","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Creating reusable components"}]},{"block_type":"element","block":"k5zy5c54","search_text":"In the previous example, we created two very similar components: JoyceBooks and WellsBooks . These two components are almost identical; the only difference between them is that they use different data. Now imagine a real case scenario where we might have hundreds or even thousands of authors... Yes, it wouldn't make much sense to keep having a dedicated component for every author.","text_count":383,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous example, we created two very similar components:&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"JoyceBooks"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WellsBooks"}]},{"block_type":"text","content":". These two components are almost identical; the only difference between them is that they use different data. Now imagine a real case scenario where we might have hundreds or even thousands of authors... Yes, it wouldn't make much sense to keep having a dedicated component for every author."}]},{"block_type":"element","block":"k5zy5c55","search_text":"In this section, we are going to create a more generic component and update our routing to be able to have parameterized routes.","text_count":128,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we are going to create a more generic component and update our routing to be able to have parameterized routes."}]},{"block_type":"element","block":"k5zy5c56","search_text":"Let's start by creating the generic components/authorPage.js component:","text_count":71,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start by creating the generic"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"components/authorPage.js"}]},{"block_type":"text","content":"component:"}]},{"block_type":"element","block":"k5zy5c57","search_text":"const React = require('react'); const Link = require('react-router').Link; const AUTHORS = require('../authors'); class AuthorPage extends React.Component { render() { const author = AUTHORS[this.props.params.id]; return ( <div> <h2>{author.name}'s major works</h2> <ul className=\"books\">{ author.books.map( (book, key) => <li key={key} className=\"book\">{book}</li> ) }</ul> <Link to=\"/\">Go back to index</Link> </div> ); } } module.exports = AuthorPage; ","text_count":455,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst Link = require('react-router').Link; \nconst AUTHORS = require('../authors'); \n \nclass AuthorPage extends React.Component { \n  render() { \n    const author = AUTHORS[this.props.params.id]; \n    return ( \n      &lt;div&gt; \n        &lt;h2&gt;{author.name}'s major works&lt;/h2&gt; \n        &lt;ul className=\"books\"&gt;{ \n          author.books.map( (book, key) =&gt; \n            &lt;li key={key} className=\"book\"&gt;{book}&lt;/li&gt; \n          ) \n        }&lt;/ul&gt; \n        &lt;Link to=\"/\"&gt;Go back to index&lt;/Link&gt; \n     &lt;/div&gt; \n    ); \n  } \n} \nmodule.exports = AuthorPage;"}]}]},{"block_type":"element","block":"k5zy5c58","search_text":"This component is, of course, very similar to the two components it is replacing. The two major differences here are that we need to have a way to fetch the data from within the component and a way to receive a parameter that indicates which author we want to display.","text_count":268,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This component is, of course, very similar to the two components it is replacing. The two major differences here are that we need to have a way to fetch the data from within the component and a way to receive a parameter that indicates which author we want to display."}]},{"block_type":"element","block":"k5zy5c59","search_text":"For the sake of simplicity, we require authors.js here, a module that exports a JavaScript object containing data about the authors that we use as a simple database. The variable this.props.params.id represents the identifier of the author we need to display. This parameter is populated by the router and we will see exactly how in a minute. So, we use this parameter to extract the author from the database object and then we have everything we need to render the component.","text_count":476,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For the sake of simplicity, we require"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authors.js"}]},{"block_type":"text","content":"here, a module that exports a JavaScript object containing data about the authors that we use as a simple database. The variable"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this.props.params.id"}]},{"block_type":"text","content":"represents the identifier of the author we need to display. This parameter is populated by the router and we will see exactly how in a minute. So, we use this parameter to extract the author from the database object and then we have everything we need to render the component."}]},{"block_type":"element","block":"k5zy5c5a","search_text":"Just to make you understand how we are fetching the data, here is an example of how our authors.js module might look:","text_count":117,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Just to make you understand how we are fetching the data, here is an example of how our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authors.js"}]},{"block_type":"text","content":"module might look:"}]},{"block_type":"element","block":"k5zy5c5b","search_text":"module.exports = { 'joyce': { 'name': 'James Joyce', 'books': [ 'Dubliners', 'A Portrait of the Artist as a Young Man', 'Exiles and poetry', 'Ulysses', 'Finnegans Wake' ] }, 'h-g-wells': { 'name': 'Herbert George Wells', 'books': [ 'The Time Machine', 'The War of the Worlds', 'The First Men in the Moon', 'The Invisible Man' ] } }; ","text_count":333,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = { \n \n  'joyce': { \n    'name': 'James Joyce', \n    'books': [ \n      'Dubliners', \n      'A Portrait of the Artist as a Young Man', \n      'Exiles and poetry', \n      'Ulysses', \n      'Finnegans Wake' \n    ] \n  }, \n \n  'h-g-wells': { \n    'name': 'Herbert George Wells', \n    'books': [ \n      'The Time Machine', \n      'The War of the Worlds', \n      'The First Men in the Moon', \n      'The Invisible Man' \n    ] \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5c5c","search_text":"It's a very simple object that indexes authors by a mnemonic string identifier.","text_count":79,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's a very simple object that indexes authors by a mnemonic string identifier."}]},{"block_type":"element","block":"k5zy5c5d","search_text":"Now the final step is to review our routes.js components:","text_count":57,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now the final step is to review our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routes.js"}]},{"block_type":"text","content":"components:"}]},{"block_type":"element","block":"k5zy5c5e","search_text":"const React = require('react'); const ReactRouter = require('react-router'); const Router = ReactRouter.Router; const hashHistory = ReactRouter.hashHistory; const AuthorsIndex = require('./components/authorsIndex'); const AuthorPage = require('./components/authorPage'); const NotFound = require('./components/notFound'); const routesConfig = [ {path: '/', component: AuthorsIndex}, {path: '/author/:id', component: AuthorPage}, {path: '*', component: NotFound} ]; class Routes extends React.Component { render() { return<Router history={hashHistory} routes={routesConfig}/>; } } module.exports = Routes; ","text_count":605,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst ReactRouter = require('react-router'); \nconst Router = ReactRouter.Router; \nconst hashHistory = ReactRouter.hashHistory; \nconst AuthorsIndex = require('./components/authorsIndex'); \nconst AuthorPage = require('./components/authorPage'); \nconst NotFound = require('./components/notFound'); \n \nconst routesConfig = [ \n  {path: '/', component: AuthorsIndex}, \n  {path: '/author/:id', component: AuthorPage}, \n  {path: '*', component: NotFound} \n]; \n \nclass Routes extends React.Component { \n  render() { \n    return&lt;Router history={hashHistory} routes={routesConfig}/&gt;; \n  } \n} \nmodule.exports = Routes;"}]}]},{"block_type":"element","block":"k5zy5c5f","search_text":"This time, we are using the new generic AuthorPage component in place of the two specific components we had in the previous example. We are also using an alternative configuration for the router; this time, we are using a plain JavaScript array to define our routes instead of putting the Route components within the render function of the Routes component. The object is then passed to the routes attribute of the Router component. This configuration is totally equivalent to the tag-based one we saw in the previous example and is sometimes easier to write. Other times, for instance when we have many nested routes, the tag-based configuration might be more comfortable to work with. The important change here is our new /author/:id route that is linked to our new generic component and which replaced our old specific routes. This route is parameterized (named parameters are defined with the \"column-prefixed-syntax,\" as you can see here) and will match both our old routes /author/joyce and /author/h-g-wells . Of course, it will match any other route of this kind and the matched string for the id parameter is directly passed to the component, which will be able to access it by reading props.params.id .","text_count":1212,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This time, we are using the new generic"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"AuthorPage"}]},{"block_type":"text","content":"component in place of the two specific components we had in the previous example. We are also using an alternative configuration for the router; this time, we are using a plain JavaScript array to define our routes instead of putting the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Route"}]},{"block_type":"text","content":"components within the render function of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Routes"}]},{"block_type":"text","content":"component. The object is then passed to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routes"}]},{"block_type":"text","content":"attribute of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Router"}]},{"block_type":"text","content":"component. This configuration is totally equivalent to the tag-based one we saw in the previous example and is sometimes easier to write. Other times, for instance when we have many nested routes, the tag-based configuration might be more comfortable to work with. The important change here is our new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/author/:id"}]},{"block_type":"text","content":"route that is linked to our new generic component and which replaced our old specific routes. This route is parameterized (named parameters are defined with the \"column-prefixed-syntax,\" as you can see here) and will match both our old routes&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/author/joyce"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/author/h-g-wells"}]},{"block_type":"text","content":". Of course, it will match any other route of this kind and the matched string for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"id"}]},{"block_type":"text","content":"parameter is directly passed to the component, which will be able to access it by reading"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"props.params.id"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5c5g","search_text":"This completes our example; to run it, you just need to regenerate the bundle file using Webpack and refresh the index.html page. This page and main.js remains unchanged.","text_count":170,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This completes our example; to run it, you just need to regenerate the bundle file using Webpack and refresh the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.html"}]},{"block_type":"text","content":"page. This page and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main.js"}]},{"block_type":"text","content":"remains unchanged."}]},{"block_type":"element","block":"k5zy5c5h","search_text":"Using generic components and parameterized routes, we have great flexibility and we should be able to build quite complex apps.","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using generic components and parameterized routes, we have great flexibility and we should be able to build quite complex apps."}]},{"block_type":"element","block":"k5zy5c5i","search_text":"Server-side rendering","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Server-side rendering"}]},{"block_type":"element","block":"k5zy5c5j","search_text":"Let's make another small step forwards in our journey through Universal JavaScript. We said that one of the most interesting features of React is the ability to render components even on the server side. In this section, we are going to leverage this feature to update our simple app and render it directly from the server.","text_count":323,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's make another small step forwards in our journey through Universal JavaScript. We said that one of the most interesting features of React is the ability to render components even on the server side. In this section, we are going to leverage this feature to update our simple app and render it directly from the server."}]},{"block_type":"element","block":"k5zy5c5k","search_text":"We are going to use Express ( http://expressjs.com ) as the web server and ejs ( https:// npmjs.com/package/ejs ) as the internal template engine. We will also need to run our server script on top of Babel to be able to leverage JSX, so the first thing we need to do is to install all these new dependencies:","text_count":308,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are going to use"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Express"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://expressjs.com"},"children":[{"block_type":"text","content":"http://expressjs.com"}]},{"block_type":"text","content":") as the web server and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"ejs"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.com/package/ejs"},"children":[{"block_type":"text","content":"https:// npmjs.com/package/ejs"}]},{"block_type":"text","content":") as the internal template engine. We will also need to run our server script on top of Babel to be able to leverage JSX, so the first thing we need to do is to install all these new dependencies:"}]},{"block_type":"element","block":"k5zy5c5l","search_text":"npm install express ejs babel-cli ","text_count":34,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install express ejs babel-cli"}]}]},{"block_type":"element","block":"k5zy5c5m","search_text":"All our components remain the same as they were in the previous example, so we are going to focus on the server. In the server, we will need to access to the routing configuration so, to make this task simpler, we are going to extract the routing configuration object from the routes.js file to a dedicated module called routesConfig.js :","text_count":338,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"All our components remain the same as they were in the previous example, so we are going to focus on the server. In the server, we will need to access to the routing configuration so, to make this task simpler, we are going to extract the routing configuration object from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routes.js"}]},{"block_type":"text","content":"file to a dedicated module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routesConfig.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c5n","search_text":"const AuthorsIndex = require('./components/authorsIndex'); const AuthorPage = require('./components/authorPage'); const NotFound = require('./components/notFound'); const routesConfig = [ {path: '/', component: AuthorsIndex}, {path: '/author/:id', component: AuthorPage}, {path: '*', component: NotFound} ]; module.exports = routesConfig; ","text_count":339,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const AuthorsIndex = require('./components/authorsIndex'); \nconst AuthorPage = require('./components/authorPage'); \nconst NotFound = require('./components/notFound'); \n \nconst routesConfig = [ \n  {path: '/', component: AuthorsIndex}, \n  {path: '/author/:id', component: AuthorPage}, \n  {path: '*', component: NotFound} \n]; \nmodule.exports = routesConfig;"}]}]},{"block_type":"element","block":"k5zy5c5o","search_text":"We are also going to transform our static index.html file into an ejs template called views/index.ejs :","text_count":103,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are also going to transform our static"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.html"}]},{"block_type":"text","content":"file into an ejs template called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"views/index.ejs"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c5p","search_text":"<!DOCTYPE html> <html> <head> <meta charset=\"utf-8\" /> <title>React Example - Authors archive</title> </head> <body> <div id=\"main\"> <%- markup -%> </div> <!--<script src=\"dist/bundle.js\"></script>--> </body> </html> ","text_count":217,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&lt;!DOCTYPE html&gt; \n&lt;html&gt; \n  &lt;head&gt; \n    &lt;meta charset=\"utf-8\" /&gt; \n    &lt;title&gt;React Example - Authors archive&lt;/title&gt; \n  &lt;/head&gt; \n  &lt;body&gt; \n    &lt;div id=\"main\"&gt; \n      &lt;%- markup -%&gt; \n    &lt;/div&gt; \n    &lt;!--&lt;script src=\"dist/bundle.js\"&gt;&lt;/script&gt;--&gt; \n  &lt;/body&gt; \n&lt;/html&gt;"}]}]},{"block_type":"element","block":"k5zy5c5q","search_text":"Everything is simple here; there are only two details worth underlining:","text_count":72,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Everything is simple here; there are only two details worth underlining:"}]},{"block_type":"element","block":"k5zy5c5r","search_text":"The <%- markup -%> tag is the part of the template that will be dynamically replaced with the React content that we will render on the server side before serving the page to the browser. We are commenting the inclusion of the bundle script for now because in this section we want to focus only on the server-side rendering. We will integrate a complete universal rendering solution in the next sections. ","text_count":404,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"&lt;%- markup -%&gt;"}]},{"block_type":"text","content":"tag is the part of the template that will be dynamically replaced with the React content that we will render on the server side before serving the page to the browser."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We are commenting the inclusion of the bundle script for now because in this section we want to focus only on the server-side rendering. We will integrate a complete universal rendering solution in the next sections."}]}]},{"block_type":"element","block":"k5zy5c5s","search_text":"We can now create our server.js script: ","text_count":40,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We can now create our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"server.js"}]},{"block_type":"text","content":"script:"}]}]},{"block_type":"element","block":"k5zy5c5t","search_text":"const http = require('http'); const Express = require('express'); const React = require('react'); const ReactDom = require('react-dom/server'); const Router = require('react-router'); const routesConfig = require('./src/routesConfig'); const app = new Express(); const server = new http.Server(app); app.set('view engine', 'ejs'); app.get('*', (req, res) => { Router.match( {routes: routesConfig, location: req.url}, (error, redirectLocation, renderProps) => { if (error) { res.status(500).send(error.message) } else if (redirectLocation) { res.redirect(302, redirectLocation.pathname + redirectLocation.search) } else if (renderProps) { const markup = ReactDom.renderToString(<Router.RouterContext {...renderProps} />); res.render('index', {markup}); } else { res.status(404).send('Not found') } } ); }); server.listen(3000, (err) => { if (err) { return console.error(err); } console.info('Server running on http://localhost:3000'); }); ","text_count":938,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \n       const Express = require('express'); \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const React = require('react'); \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const ReactDom = require('react-dom/server'); \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const Router = require('react-router'); \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const routesConfig = require('./src/routesConfig'); \n \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const app = new Express(); \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const server = new http.Server(app); \n \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app.set('view engine', 'ejs'); \n \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app.get('*', (req, res) =&gt; { \n   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Router.match( \n     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {routes: routesConfig, location: req.url}, \n     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (error, redirectLocation, renderProps) =&gt; { \n       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (error) { \n         &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; res.status(500).send(error.message) \n       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else if (redirectLocation) { \n         &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; res.redirect(302, redirectLocation.pathname + &nbsp;     \n                 redirectLocation.search) \n       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else if (renderProps) { \n         &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const markup = ReactDom.renderToString(&lt;Router.RouterContext \n                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;       {...renderProps} /&gt;); \n         &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; res.render('index', {markup}); \n       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else { \n         &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; res.status(404).send('Not found') \n       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } \n     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n         ); \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }); \n \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server.listen(3000, (err) =&gt; { \n   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (err) { \n     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return console.error(err); \n   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } \n   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console.info('Server running on http://localhost:3000'); \n &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });"}]}]},{"block_type":"element","block":"k5zy5c5u","search_text":"The important part of this code is the Express route defined with app.get('*', (req, res) => {...}) . This is an Express catch-all route that will intercept all the GET requests to every URL in the server. Inside this route, we take care of delegating the routing logic to the React Router that we setup before for the client-side application.","text_count":343,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The important part of this code is the Express route defined with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.get('*', (req, res) =&gt; {...})"}]},{"block_type":"text","content":". This is an"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Express catch-all"}]},{"block_type":"text","content":"route that will intercept all the GET requests to every URL in the server. Inside this route, we take care of delegating the routing logic to the React Router that we setup before for the client-side application."}]},{"block_type":"element","block":"k5zy5c5v","search_text":"Note Pattern The server router component (Express built-in router) is here replaced by a universal router (React Router) that is able to match the routes both on the client and on the server. ","text_count":192,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The server router component (Express built-in router) is here replaced by a universal router (React Router) that is able to match the routes both on the client and on the server."}]}]},{"block_type":"element","block":"k5zy5c5w","search_text":"To adopt the React Router in the server, we use the function Router.match . This function accepts two parameters: the first one is a configuration object and the second is a callback function . The configuration object must have two keys:","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To adopt the React Router in the server, we use the function"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Router.match"}]},{"block_type":"text","content":". This function accepts two parameters: the first one is a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"configuration object"}]},{"block_type":"text","content":"and the second is a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"callback function"}]},{"block_type":"text","content":". The configuration object must have two keys:"}]},{"block_type":"element","block":"k5zy5c5x","search_text":"routes : This is used to pass the React Router routes configuration. Here, we are passing the exact same configuration that we used for the client-side rendering, and that's the reason why we extracted it into a dedicated component at the beginning of this section. location : This is used to specify the currently requested URL on which the router will try to match one of the previously defined routes. ","text_count":405,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routes"}]},{"block_type":"text","content":": This is used to pass the React Router routes configuration. Here, we are passing the exact same configuration that we used for the client-side rendering, and that's the reason why we extracted it into a dedicated component at the beginning of this section."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"location"}]},{"block_type":"text","content":": This is used to specify the currently requested URL on which the router will try to match one of the previously defined routes."}]}]},{"block_type":"element","block":"k5zy5c5y","search_text":"The callback function is called when a route is matched. It will receive three arguments, error , redirectLocation , and renderProps , that we will use to determine what exactly the result of the match operation was. We can have four different cases that we need to handle:","text_count":273,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The callback function is called when a route is matched. It will receive three arguments,&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"error"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"redirectLocation"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"renderProps"}]},{"block_type":"text","content":", that we will use to determine what exactly the result of the match operation was. We can have four different cases that we need to handle:"}]},{"block_type":"element","block":"k5zy5c5z","search_text":"The first case is when we have an error during the routing resolution. To handle this case, we simply return a 500 internal server error response to the browser. The second case is when we match a route that is a redirect route. In this case, we need to create a server redirect message ( 302 redirect ) to tell the browser to go to the new destination. The third case is when we match a route and we have to render the associated component. In this case, the argument renderProps is an object that contains some data we need to use to render the component. This is the core of our server-side routing mechanism and we use the ReactDOM.renderToString function to be able to render the HTML code that represents the component associated to the currently matched route. Then, we inject the resulting HTML into the index.ejs template we defined before to obtain the full HTML page that we send to the browser. The last case is when the route is not matched, and here we simply return a 404 not found error to the browser. ","text_count":1019,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The first case is when we have an error during the routing resolution. To handle this case, we simply return a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"500 internal server error"}]},{"block_type":"text","content":"response to the browser."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The second case is when we match a route that is a redirect route. In this case, we need to create a server redirect message ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"302 redirect"}]},{"block_type":"text","content":") to tell the browser to go to the new destination."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The third case is when we match a route and we have to render the associated component. In this case, the argument"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"renderProps"}]},{"block_type":"text","content":"&nbsp;is an object that contains some data we need to use to render the component. This is the core of our server-side routing mechanism and we use the&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ReactDOM.renderToString"}]},{"block_type":"text","content":"function to be able to render the HTML code that represents the component associated to the currently matched route. Then, we inject the resulting HTML into the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index.ejs"}]},{"block_type":"text","content":"template we defined before to obtain the full HTML page that we send to the browser."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The last case is when the route is not matched, and here we simply return a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"404 not found"}]},{"block_type":"text","content":"error to the browser."}]}]},{"block_type":"element","block":"k5zy5c60","search_text":"So, definitively, the most important part of this code is the following line:","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So, definitively, the most important part of this code is the following line:"}]},{"block_type":"element","block":"k5zy5c61","search_text":"const markup = ReactDom.renderToString(<Router.RouterContext {...renderProps} /> ","text_count":81,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const markup = ReactDom.renderToString(&lt;Router.RouterContext {...renderProps} /&gt;"}]}]},{"block_type":"element","block":"k5zy5c62","search_text":"Let's see better how the renderToString function works:","text_count":55,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see better how the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"renderToString"}]},{"block_type":"text","content":"function works:"}]},{"block_type":"element","block":"k5zy5c63","search_text":"This function comes from the module react-dom/server and it is capable of rendering any React component to a string. It is used to render the HTML code in the server to be immediately sent to the browser, speeding up the page load time and making the page SEO friendly. React is smart enough that if we call ReactDOM.render() for the same component in the browser, it will not render the component again, it will just attach the event listeners to its existing DOM nodes. The component we are rendering is RouterContext (contained in the react-router module), which is responsible for rendering the component tree for a given router state. We pass to this component a set of attributes that are all the fields inside the renderProps object. To expand this object, we are using the JSX-spread attributes operator ( https://facebook.github.io/react/docs/jsx-spread.html#spread-attributes ), which extracts all the key/value pairs in the object to component attributes. ","text_count":967,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"This function comes from the module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"react-dom/server"}]},{"block_type":"text","content":"and it is capable of rendering any React component to a string. It is used to render the HTML code in the server to be immediately sent to the browser, speeding up the page load time and making the page SEO friendly. React is smart enough that if we call"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ReactDOM.render()"}]},{"block_type":"text","content":"for the same component in the browser, it will not render the component again, it will just attach the event listeners to its existing DOM nodes."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The component we are rendering is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"RouterContext"}]},{"block_type":"text","content":"(contained in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"react-router"}]},{"block_type":"text","content":"module), which is responsible for rendering the component tree for a given router state. We pass to this component a set of attributes that are all the fields inside the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"renderProps"}]},{"block_type":"text","content":"object. To expand this object, we are using the JSX-spread attributes operator ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://facebook.github.io/react/docs/jsx-spread.html#spread-attributes"},"children":[{"block_type":"text","content":"https://facebook.github.io/react/docs/jsx-spread.html#spread-attributes"}]},{"block_type":"text","content":"), which extracts all the key/value pairs in the object to component attributes."}]}]},{"block_type":"element","block":"k5zy5c64","search_text":"Now we are ready to run our server.js script with:","text_count":50,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to run our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"server.js"}]},{"block_type":"text","content":"script with:"}]},{"block_type":"element","block":"k5zy5c65","search_text":"node server ","text_count":12,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node server"}]}]},{"block_type":"element","block":"k5zy5c66","search_text":"Then, we can open the browser and point it to http://localhost:3000 to see our server-rendered app up and running.","text_count":114,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can open the browser and point it to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:3000"}]},{"block_type":"text","content":"to see our server-rendered app up and running."}]},{"block_type":"element","block":"k5zy5c67","search_text":"Remember that we disabled the inclusion of the bundle file, so at the moment, we have no client-side JavaScript code running and every interaction triggers a new server request that refreshes the page entirely. This is not so cool, right?","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Remember that we disabled the inclusion of the bundle file, so at the moment, we have no client-side JavaScript code running and every interaction triggers a new server request that refreshes the page entirely. This is not so cool, right?"}]},{"block_type":"element","block":"k5zy5c68","search_text":"In the next section, we will see how to enable both client and server rendering, adding to our sample app an effective universal routing and rendering solution.","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next section, we will see how to enable both client and server rendering, adding to our sample app an effective universal routing and rendering solution."}]},{"block_type":"element","block":"k5zy5c69","search_text":"Universal rendering and routing","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Universal rendering and routing"}]},{"block_type":"element","block":"k5zy5c6a","search_text":"In this paragraph, we will update our sample app to leverage both server- and client-side rendering and routing. We have already shown the individual parts working, so now it's just a matter of polishing things up a bit.","text_count":220,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this paragraph, we will update our sample app to leverage both server- and client-side rendering and routing. We have already shown the individual parts working, so now it's just a matter of polishing things up a bit."}]},{"block_type":"element","block":"k5zy5c6b","search_text":"The first thing that we are going to do is to uncomment the bundle.js inclusion in our main view file ( views/index.ejs ).","text_count":122,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first thing that we are going to do is to uncomment the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"bundle.js"}]},{"block_type":"text","content":"inclusion in our main view file ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"views/index.ejs"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5c6c","search_text":"Then, we need to change the history strategy in our client-side app ( main.js ). Do you remember that we were using the hash history strategy? Well, this strategy doesn't play well with universal rendering because we want to have the exact same URLs both in the client and the server routing. In the server, we can only use the browser history strategy, so let's rewrite the routes.js module to use it in the client as well:","text_count":424,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we need to change the history strategy in our client-side app ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"main.js"}]},{"block_type":"text","content":"). Do you remember that we were using the hash history strategy? Well, this strategy doesn't play well with universal rendering because we want to have the exact same URLs both in the client and the server routing. In the server, we can only use the browser history strategy, so let's rewrite the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routes.js"}]},{"block_type":"text","content":"module to use it in the client as well:"}]},{"block_type":"element","block":"k5zy5c6d","search_text":"const React = require('react'); const ReactRouter = require('react-router'); const Router = ReactRouter.Router; const browserHistory = ReactRouter.browserHistory; const routesConfig = require('./routesConfig'); class Routes extends React.Component { render() { return<Router history={browserHistory} routes={routesConfig}/>; } } module.exports = Routes; ","text_count":354,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst ReactRouter = require('react-router'); \nconst Router = ReactRouter.Router; \nconst browserHistory = ReactRouter.browserHistory; \nconst routesConfig = require('./routesConfig'); \n \nclass Routes extends React.Component { \n  render() { \n    return&lt;Router history={browserHistory} routes={routesConfig}/&gt;; \n  } \n} \nmodule.exports = Routes;"}]}]},{"block_type":"element","block":"k5zy5c6e","search_text":"As you can see, the only relevant change is that we are now requiring the ReactRouter.browserHistory function and passing it to our Router component.","text_count":149,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, the only relevant change is that we are now requiring the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ReactRouter.browserHistory"}]},{"block_type":"text","content":"&nbsp;function and passing it to our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Router"}]},{"block_type":"text","content":"component."}]},{"block_type":"element","block":"k5zy5c6f","search_text":"We are almost done; there is only a small change that we need to perform in our server app to be able to serve the bundle.js file to the client from our server as a static asset. To do this, we can use the Express.static middleware that allows us to expose the content of a folder as static files from a specific path. In our case, we want to expose the dist folder, so we just need to add the following line before our main server routing configuration:","text_count":454,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are almost done; there is only a small change that we need to perform in our server app to be able to serve the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"bundle.js"}]},{"block_type":"text","content":"file to the client from our server as a static asset. To do this, we can use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Express.static"}]},{"block_type":"text","content":"middleware that allows us to expose the content of a folder as static files from a specific path. In our case, we want to expose the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"dist"}]},{"block_type":"text","content":"folder, so we just need to add the following line before our main server routing configuration:"}]},{"block_type":"element","block":"k5zy5c6g","search_text":"app.use('/dist', Express.static('dist')); ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"app.use('/dist', Express.static('dist'));"}]}]},{"block_type":"element","block":"k5zy5c6h","search_text":"And that's pretty much it! Now to see our app live, we just need to regenerate our bundle file with Webpack and restart our server. Then you will be able to navigate through your app on http://localhost:3000 as you were doing before. Everything will look the same, but if you use an inspector or a debugger, you will notice that, this time, only the first request will be fully rendered by the server, while others will be managed by browser. If you want to keep playing a bit, you can also try to force refresh the page on specific URIs to also test that the routing is working seamlessly both on the server and on the browser.","text_count":628,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"And that's pretty much it! Now to see our app live, we just need to regenerate our bundle file with Webpack and restart our server. Then you will be able to navigate through your app on"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:3000"}]},{"block_type":"text","content":"as you were doing before. Everything will look the same, but if you use an inspector or a debugger, you will notice that, this time, only the first request will be fully rendered by the server, while others will be managed by browser. If you want to keep playing a bit, you can also try to force refresh the page on specific URIs to also test that the routing is working seamlessly both on the server and on the browser."}]},{"block_type":"element","block":"k5zy5c6i","search_text":"Universal data retrieval","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Universal data retrieval"}]},{"block_type":"element","block":"k5zy5c6j","search_text":"Our sample app is now starting to get a solid structure in order to grow and become a more complete and scalable app. However, there is still a very fundamental point that we haven't yet addressed properly, and that is, data retrieval . Do you remember that we used a module that just contains JSON data? Currently, we use that module as a sort of database, but of course, this is a very suboptimal approach for a number of reasons:","text_count":432,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our sample app is now starting to get a solid structure in order to grow and become a more complete and scalable app. However, there is still a very fundamental point that we haven't yet addressed properly, and that is,&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"data retrieval"}]},{"block_type":"text","content":". Do you remember that we used a module that just contains JSON data? Currently, we use that module as a sort of database, but of course, this is a very suboptimal approach for a number of reasons:"}]},{"block_type":"element","block":"k5zy5c6k","search_text":"We are sharing the JSON file everywhere in our app and accessing the data directly across frontend, backend, and in every React component. Given that we access the data also on the frontend, we end up putting the full database also in the frontend bundle. This is risky because we might accidentally expose any sensitive information. Also, our bundle file will grow with the growth of our database and we will be forced to recompile it after every change on the data. ","text_count":468,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We are sharing the JSON file everywhere in our app and accessing the data directly across frontend, backend, and in every React component."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Given that we access the data also on the frontend, we end up putting the full database also in the frontend bundle. This is risky because we might accidentally expose any sensitive information. Also, our bundle file will grow with the growth of our database and we will be forced to recompile it after every change on the data."}]}]},{"block_type":"element","block":"k5zy5c6l","search_text":"It's obvious that we need a better solution—a more decoupled and scalable one.","text_count":78,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's obvious that we need a better solution&mdash;a more decoupled and scalable one."}]},{"block_type":"element","block":"k5zy5c6m","search_text":"In this section, we will improve our example by building a dedicated REST API server that will allow us to fetch the data asynchronously and on demand: only when it is really needed and only the specific subset of data that we want to render to the current section of the app.","text_count":276,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we will improve our example by building a dedicated REST API server that will allow us to fetch the data asynchronously and on demand: only when it is really needed and only the specific subset of data that we want to render to the current section of the app."}]},{"block_type":"element","block":"k5zy5c6n","search_text":"The API server","text_count":14,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The API server"}]},{"block_type":"element","block":"k5zy5c6o","search_text":"We want the API server to be completely separated by our backend server; ideally, it should be possible to scale this server independently from the rest of the application.","text_count":172,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We want the API server to be completely separated by our backend server; ideally, it should be possible to scale this server independently from the rest of the application."}]},{"block_type":"element","block":"k5zy5c6p","search_text":"Without further ado, let's see the code of our apiServer.js :","text_count":61,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Without further ado, let's see the code of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"apiServer.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c6q","search_text":"const http = require('http'); const Express = require('express'); const app = new Express(); const server = new http.Server(app); const AUTHORS = require('./src/authors'); // [1] app.use((req, res, next) => { // [2] console.log(`Received request: ${req.method} ${req.url} from ${req.headers['user-agent']}`); next(); }); app.get('/authors', (req, res, next) => { // [3] const data = Object.keys(AUTHORS).map(id => { return { 'id': id, 'name': AUTHORS[id].name }; }); res.json(data); }); app.get('/authors/:id', (req, res, next) => { // [4] if (!AUTHORS.hasOwnProperty(req.params.id)) { return next(); } const data = AUTHORS[req.params.id]; res.json(data); }); server.listen(3001, (err) => { if (err) { return console.error(err); } console.info('API Server running on http://localhost:3001'); }); ","text_count":796,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst Express = require('express'); \n \nconst app = new Express(); \nconst server = new http.Server(app); \nconst AUTHORS = require('./src/authors');               // [1] \n \napp.use((req, res, next) =&gt; {                           // [2] \n  console.log(`Received request: ${req.method} ${req.url} from \n    ${req.headers['user-agent']}`); \n  next(); \n}); \n \napp.get('/authors', (req, res, next) =&gt; {               // [3] \n  const data = Object.keys(AUTHORS).map(id =&gt; { \n    return { \n      'id': id, \n      'name': AUTHORS[id].name \n    }; \n  }); \n \n  res.json(data); \n}); \n \napp.get('/authors/:id', (req, res, next) =&gt; {           // [4] \n  if (!AUTHORS.hasOwnProperty(req.params.id)) { \n    return next(); \n  } \n \n  const data = AUTHORS[req.params.id]; \n  res.json(data); \n}); \n \nserver.listen(3001, (err) =&gt; { \n  if (err) { \n    return console.error(err); \n  } \n  console.info('API Server running on http://localhost:3001'); \n});"}]}]},{"block_type":"element","block":"k5zy5c6r","search_text":"As you can see, we are again using Express as a web server framework, but let's still analyze the main parts of this code:","text_count":122,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, we are again using Express as a web server framework, but let's still analyze the main parts of this code:"}]},{"block_type":"element","block":"k5zy5c6s","search_text":"Our data still lies in a module as a JSON file ( src/authors.js ). This is, of course, only for simplicity and works for the sake of our example, but in a real world scenario, it should be replaced with a real database such as MongoDB , MySql, or LevelDB . In this example, we will access the data directly from the required JSON object, while in a real case app we will make queries to the external data source when we want to read the data. We are using a middleware that prints in the console some useful information every time we receive a request. We will see later that these logs can help us to understand who is calling the API (the frontend or the backend) and to verify that the whole app is behaving as expected. We expose a GET endpoint identified by the URI /authors that returns a JSON array containing all the available authors. For every author, we are exposing the fields' id and name . Again, here, we are extracting data directly from the JSON file we imported as database; in a real-world scenario, we would prefer to perform a query to a real database here. We are also exposing another GET endpoint on the URI /authors/:id , where :id is a generic placeholder that will match the ID of the specific author for which we want to read the data. If the given ID is valid (there is an entry in our JSON file for that ID), the API returns an object containing the name of the author and an array of books. ","text_count":1422,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Our data still lies in a module as a JSON file ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"src/authors.js"}]},{"block_type":"text","content":"). This is, of course, only for simplicity and works for the sake of our example, but in a real world scenario, it should be replaced with a real database such as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"MongoDB"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"MySql,"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"LevelDB"}]},{"block_type":"text","content":". In this example, we will access the data directly from the required JSON object, while in a real case app we will make queries to the external data source when we want to read the data."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We are using a middleware that prints in the console some useful information every time we receive a request. We will see later that these logs can help us to understand who is calling the API (the frontend or the backend) and to verify that the whole app is behaving as expected."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We expose a GET endpoint identified by the URI"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/authors"}]},{"block_type":"text","content":"that returns a JSON array containing all the available authors. For every author, we are exposing the fields'"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"id"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"name"}]},{"block_type":"text","content":". Again, here, we are extracting data directly from the JSON file we imported as database; in a real-world scenario, we would prefer to perform a query to a real database here."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We are also exposing another GET endpoint on the URI"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/authors/:id"}]},{"block_type":"text","content":", where"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":":id"}]},{"block_type":"text","content":"&nbsp;is a generic placeholder that will match the ID of the specific author for which we want to read the data. If the given ID is valid (there is an entry in our JSON file for that ID), the API returns an object containing the name of the author and an array of books."}]}]},{"block_type":"element","block":"k5zy5c6t","search_text":"We can now run our API server with:","text_count":35,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now run our API server with:"}]},{"block_type":"element","block":"k5zy5c6u","search_text":"node apiServer ","text_count":15,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node apiServer"}]}]},{"block_type":"element","block":"k5zy5c6v","search_text":"It will be now accessible on http://localhost:3001 , and if you want to test it, you can try to make a couple of curl requests:","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It will be now accessible on"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:3001"}]},{"block_type":"text","content":", and if you want to test it, you can try to make a couple of curl requests:"}]},{"block_type":"element","block":"k5zy5c6w","search_text":"curl http://localhost:3001/authors/ [{\"id\":\"joyce\",\"name\":\"James Joyce\"},{\"id\":\"h-g-wells\",\"name\":\"Herbert George Wells\"}] curl http://localhost:3001/authors/h-g-wells {\"name\":\"Herbert George Wells\",\"books\":[\"The Time Machine\",\"The War of the Worlds\",\"The First Men in the Moon\",\"The Invisible Man\"]} ","text_count":301,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl http://localhost:3001/authors/ \n[{\"id\":\"joyce\",\"name\":\"James Joyce\"},{\"id\":\"h-g-wells\",\"name\":\"Herbert George Wells\"}]\n \ncurl http://localhost:3001/authors/h-g-wells \n{\"name\":\"Herbert George Wells\",\"books\":[\"The Time Machine\",\"The War of the Worlds\",\"The First Men in the Moon\",\"The Invisible Man\"]}"}]}]},{"block_type":"element","block":"k5zy5c6x","search_text":"Proxying requests for the frontend","text_count":34,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Proxying requests for the frontend"}]},{"block_type":"element","block":"k5zy5c6y","search_text":"The API we just built should be accessible for both the backend and the frontend. The frontend will need to call the API with an AJAX request. You are probably aware of the security policies that allow the browser to make AJAX requests only to URLs in the domain where the page was loaded. That means that if we run our API server on localhost:3001 and our web server on localhost:3000 , we are actually using two different domains and the browser will fail to call the API endpoints directly. To overcome this limitation, we can create a proxy within our web server that will take care to expose the same endpoints of the API server locally using an internal convenience route ( localhost:3000/api ), as shown in the following picture:","text_count":736,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The API we just built should be accessible for both the backend and the frontend. The frontend will need to call the API with an AJAX request. You are probably aware of the security policies that allow the browser to make AJAX requests only to URLs in the domain where the page was loaded. That means that if we run our API server on"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"localhost:3001"}]},{"block_type":"text","content":"and our web server on"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"localhost:3000"}]},{"block_type":"text","content":", we are actually using two different domains and the browser will fail to call the API endpoints directly. To overcome this limitation, we can create a proxy within our web server that will take care to expose the same endpoints of the API server locally using an internal convenience route ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"localhost:3000/api"}]},{"block_type":"text","content":"), as shown in the following picture:"}]},{"block_type":"element","block":"k5zy5c6z","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000019.jpg","alt":"Proxying requests for the frontend","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5c70","search_text":"To build the proxy component in our web server, we are going to use the excellent http-proxy module ( https://npmjs.com/package/http-proxy ), so we need to install it with npm:","text_count":176,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To build the proxy component in our web server, we are going to use the excellent"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http-proxy"}]},{"block_type":"text","content":"module ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.com/package/http-proxy"},"children":[{"block_type":"text","content":"https://npmjs.com/package/http-proxy"}]},{"block_type":"text","content":"), so we need to install it with npm:"}]},{"block_type":"element","block":"k5zy5c71","search_text":"npm install http-proxy ","text_count":23,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install http-proxy"}]}]},{"block_type":"element","block":"k5zy5c72","search_text":"We will see in a moment how it will be included in the web server and configured.","text_count":81,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will see in a moment how it will be included in the web server and configured."}]},{"block_type":"element","block":"k5zy5c73","search_text":"Universal API client","text_count":20,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Universal API client"}]},{"block_type":"element","block":"k5zy5c74","search_text":"We will call the API using two different prefixes given the current environment:","text_count":80,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will call the API using two different prefixes given the current environment:"}]},{"block_type":"element","block":"k5zy5c75","search_text":"http://localhost:3001 when we call the API from the web server /api when we call the API from the browser ","text_count":106,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:3001"}]},{"block_type":"text","content":"when we call the API from the web server"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/api"}]},{"block_type":"text","content":"when we call the API from the browser"}]}]},{"block_type":"element","block":"k5zy5c76","search_text":"We also need to consider that in the browser we have only the XHR/AJAX mechanism to make asynchronous HTTP requests, while on the server we have to use a library like request or the built-in http library.","text_count":204,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We also need to consider that in the browser we have only the XHR/AJAX mechanism to make asynchronous HTTP requests, while on the server we have to use a library like"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request"}]},{"block_type":"text","content":"or the built-in&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http"}]},{"block_type":"text","content":"library."}]},{"block_type":"element","block":"k5zy5c77","search_text":"To overcome all these differences and build a universal API client module, we can use a library called axios ( https://npmjs.com/package/axios ). This library works both on the client and on the server and abstracts the two different mechanisms that each environment uses to make HTTP requests to a single uniform API.","text_count":318,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To overcome all these differences and build a universal API client module, we can use a library called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"axios"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.com/package/axios"},"children":[{"block_type":"text","content":"https://npmjs.com/package/axios"}]},{"block_type":"text","content":"). This library works both on the client and on the server and abstracts the two different mechanisms that each environment uses to make HTTP requests to a single uniform API."}]},{"block_type":"element","block":"k5zy5c78","search_text":"So, we need to install axios with:","text_count":34,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So, we need to install"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"axios"}]},{"block_type":"text","content":"with:"}]},{"block_type":"element","block":"k5zy5c79","search_text":"npm install axios ","text_count":18,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install axios"}]}]},{"block_type":"element","block":"k5zy5c7a","search_text":"Then, we also need to create a simple wrapper module that takes care to export a configured instance of axios. We call this module xhrClient.js :","text_count":145,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we also need to create a simple wrapper module that takes care to export a configured instance of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"axios."}]},{"block_type":"text","content":"We call this module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"xhrClient.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c7b","search_text":"const Axios = require('axios'); const baseURL = typeof window !== 'undefined' ? '/api' : 'http://localhost:3001'; const xhrClient = Axios.create({baseURL}); module.exports = xhrClient; ","text_count":185,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const Axios = require('axios'); \n \nconst baseURL = typeof window !== 'undefined' ? '/api' : \n  'http://localhost:3001'; \nconst xhrClient = Axios.create({baseURL}); \nmodule.exports = xhrClient;"}]}]},{"block_type":"element","block":"k5zy5c7c","search_text":"In this module, we are basically checking if the window variable is defined to detect whether we are running the code on the browser or on the web server so that we can set the proper API prefix accordingly. Then, we simply export a new instance of the axios client, configured with the current value of the base URL.","text_count":317,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this module, we are basically checking if the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"window"}]},{"block_type":"text","content":"variable is defined to detect whether we are running the code on the browser or on the web server so that we can set the proper API prefix accordingly. Then, we simply export a new instance of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"axios"}]},{"block_type":"text","content":"client, configured with the current value of the base URL."}]},{"block_type":"element","block":"k5zy5c7d","search_text":"Now we can simply import this module in our React components, and depending on whether they are executed on the server or on the browser, we will be able to use a universal interface and all the intrinsic differences of the two environments will be hidden within the code of the module.","text_count":286,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we can simply import this module in our React components, and depending on whether they are executed on the server or on the browser, we will be able to use a universal interface and all the intrinsic differences of the two environments will be hidden within the code of the module."}]},{"block_type":"element","block":"k5zy5c7e","search_text":"Note Other widely appreciated universal HTTP clients are superagent ( https://npmjs.com/package/superagent ) and isomorphic-fetch ( https://npmjs.com/package/isomorphic-fetch ) ","text_count":177,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Other widely appreciated universal HTTP clients are"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"superagent"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.com/package/superagent"},"children":[{"block_type":"text","content":"https://npmjs.com/package/superagent"}]},{"block_type":"text","content":") and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"isomorphic-fetch"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.com/package/isomorphic-fetch"},"children":[{"block_type":"text","content":"https://npmjs.com/package/isomorphic-fetch"}]},{"block_type":"text","content":")"}]}]},{"block_type":"element","block":"k5zy5c7f","search_text":"Asynchronous React components","text_count":29,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Asynchronous React components"}]},{"block_type":"element","block":"k5zy5c7g","search_text":"Now that our components will have to use this new set APIs, they will need to be asynchronously initialized. To be able to do so, we can use an extension of the React Router called async-props ( https://npmjs.com/package/async-props ).","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that our components will have to use this new set APIs, they will need to be asynchronously initialized. To be able to do so, we can use an extension of the React Router called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async-props"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.com/package/async-props"},"children":[{"block_type":"text","content":"https://npmjs.com/package/async-props"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5c7h","search_text":"So, let's install this module with:","text_count":35,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So, let's install this module with:"}]},{"block_type":"element","block":"k5zy5c7i","search_text":"npm install async-props ","text_count":24,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install async-props"}]}]},{"block_type":"element","block":"k5zy5c7j","search_text":"Now we are ready to rewrite our components to be asynchronous. Let's start with components/authorsIndex.js :","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to rewrite our components to be asynchronous. Let's start with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"components/authorsIndex.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c7k","search_text":"const React = require('react'); const Link = require('react-router').Link; const xhrClient = require('../xhrClient'); class AuthorsIndex extends React.Component { static loadProps(context, cb) { xhrClient.get('authors') .then(response => { const authors = response.data; cb(null, {authors}); }) .catch(error => cb(error)) ; } render() { return ( <div> <h1>List of authors</h1> <ul>{ this.props.authors.map(author => <li key={author.id}> <Link to={`/author/${author.id}`}>{author.name}</Link> </li> ) }</ul> </div> ) } } module.exports = AuthorsIndex;","text_count":550,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst Link = require('react-router').Link; \nconst xhrClient = require('../xhrClient'); \n \nclass AuthorsIndex extends React.Component { \n  static loadProps(context, cb) { \n    xhrClient.get('authors') \n      .then(response =&gt; { \n        const authors = response.data; \n        cb(null, {authors}); \n      }) \n      .catch(error =&gt; cb(error)) \n    ; \n  } \n \n  render() { \n    return ( \n      &lt;div&gt; \n        &lt;h1&gt;List of authors&lt;/h1&gt; \n        &lt;ul&gt;{ \n          this.props.authors.map(author =&gt; \n            &lt;li key={author.id}&gt; \n              &lt;Link to={`/author/${author.id}`}&gt;{author.name}&lt;/Link&gt; \n            &lt;/li&gt; \n          ) \n        }&lt;/ul&gt; \n      &lt;/div&gt; \n    ) \n  } \n} \nmodule.exports = AuthorsIndex;"}]}]},{"block_type":"element","block":"k5zy5c7l","search_text":"As you can see, in this new version of the module we require our new xhrClient in place of the old module containing the raw JSON data. Then, we add a new method in the component class called loadProps . This method accepts as arguments an object containing some context parameters that will be passed by the router ( context ) and a callback function ( cb ). Inside this method, we can perform all the asynchronous actions needed to retrieve the data necessary to initialize the component. When everything is loaded (or in case there is an error), we execute the callback function to propagate the data and notify the router that the component is ready. In this case, we are using xhrClient to fetch the data from the authors endpoint. ","text_count":737,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, in this new version of the module we require our new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"xhrClient"}]},{"block_type":"text","content":"in place of the old module containing the raw JSON data. Then, we add a new method in the component class called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"loadProps"}]},{"block_type":"text","content":". This method accepts as arguments an object containing some context parameters that will be passed by the router ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"context"}]},{"block_type":"text","content":") and a callback function ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cb"}]},{"block_type":"text","content":"). Inside this method, we can perform all the asynchronous actions needed to retrieve the data necessary to initialize the component. When everything is loaded (or in case there is an error), we execute the callback function to propagate the data and notify the router that the component is ready. In this case, we are using&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"xhrClient"}]},{"block_type":"text","content":"to fetch the data from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authors"}]},{"block_type":"text","content":"endpoint.&nbsp;"}]},{"block_type":"element","block":"k5zy5c7m","search_text":"In the same fashion, we also update the components/authorPage.js component:","text_count":75,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the same fashion, we also update the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"components/authorPage.js"}]},{"block_type":"text","content":"component:"}]},{"block_type":"element","block":"k5zy5c7n","search_text":"const React = require('react'); const Link = require('react-router').Link; const xhrClient = require('../xhrClient'); class AuthorPage extends React.Component { static loadProps(context, cb) { xhrClient.get(`authors/${context.params.id}`) .then(response => { const author = response.data; cb(null, {author}); }) .catch(error => cb(error)) ; } render() { return ( <div> <h2>{this.props.author.name}'s major works</h2> <ul className=\"books\">{ this.props.author.books.map( (book, key) => <li key={key} className=\"book\">{book}</li> ) }</ul> <Link to=\"/\">Go back to index</Link> </div> ); } } module.exports = AuthorPage; ","text_count":617,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst Link = require('react-router').Link; \nconst xhrClient = require('../xhrClient'); \n \nclass AuthorPage extends React.Component { \n  static loadProps(context, cb) { \n    xhrClient.get(`authors/${context.params.id}`) \n      .then(response =&gt; { \n        const author = response.data; \n        cb(null, {author}); \n      }) \n      .catch(error =&gt; cb(error)) \n    ; \n  } \n \n  render() { \n    return ( \n      &lt;div&gt; \n        &lt;h2&gt;{this.props.author.name}'s major works&lt;/h2&gt; \n        &lt;ul className=\"books\"&gt;{ \n          this.props.author.books.map( (book, key) =&gt; \n            &lt;li key={key} className=\"book\"&gt;{book}&lt;/li&gt; \n          ) \n        }&lt;/ul&gt; \n        &lt;Link to=\"/\"&gt;Go back to index&lt;/Link&gt; \n      &lt;/div&gt; \n    ); \n  } \n} \nmodule.exports = AuthorPage;"}]}]},{"block_type":"element","block":"k5zy5c7o","search_text":"The code here follows the same logic described in the previous component. The main difference is that, this time, we are calling the authors/:id API endpoint and we are taking the ID parameter from the context.params.id variable that will be passed by the router.","text_count":263,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The code here follows the same logic described in the previous component. The main difference is that, this time, we are calling the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"authors/:id"}]},{"block_type":"text","content":"API endpoint and we are taking the ID parameter from the&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"context.params.id"}]},{"block_type":"text","content":"variable that will be passed by the router."}]},{"block_type":"element","block":"k5zy5c7p","search_text":"To be able to load these asynchronous components correctly, we need to also update our router definition for both the client and the server. For now, let's focus on the client and see how the new version of routes.js will look:","text_count":227,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To be able to load these asynchronous components correctly, we need to also update our router definition for both the client and the server. For now, let's focus on the client and see how the new version of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routes.js"}]},{"block_type":"text","content":"will look:"}]},{"block_type":"element","block":"k5zy5c7q","search_text":"const React = require('react'); const AsyncProps = require('async-props').default; const ReactRouter = require('react-router'); const Router = ReactRouter.Router; const browserHistory = ReactRouter.browserHistory; const routesConfig = require('./routesConfig'); class Routes extends React.Component { render() { return <Router history={browserHistory} routes={routesConfig} render={(props) => <AsyncProps {...props}/>} />; } } module.exports = Routes; ","text_count":452,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const React = require('react'); \nconst AsyncProps = require('async-props').default; \nconst ReactRouter = require('react-router'); \nconst Router = ReactRouter.Router; \nconst browserHistory = ReactRouter.browserHistory; \nconst routesConfig = require('./routesConfig'); \n \nclass Routes extends React.Component { \n  render() { \n    return &lt;Router \n      history={browserHistory} \n      routes={routesConfig} \n      render={(props) =&gt; &lt;AsyncProps {...props}/&gt;} \n    /&gt;; \n  } \n} \nmodule.exports = Routes;"}]}]},{"block_type":"element","block":"k5zy5c7r","search_text":"The two differences from the previous version are that we require the async-props module and that we are using it to redefine the render function of the Router component to use it. This approach actually hooks the logic of async-props module within the rendering logic of the router, enabling the support for asynchronous behavior.","text_count":331,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The two differences from the previous version are that we require the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async-props"}]},{"block_type":"text","content":"module and that we are using it to redefine the render function of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Router"}]},{"block_type":"text","content":"component to use it. This approach actually hooks the logic of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async-props"}]},{"block_type":"text","content":"module within the rendering logic of the router, enabling the support for asynchronous behavior."}]},{"block_type":"element","block":"k5zy5c7s","search_text":"The web server","text_count":14,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The web server"}]},{"block_type":"element","block":"k5zy5c7t","search_text":"Finally, the last task we need to complete in this example is to update our web server in order to use the proxy server to redirect the API calls to the real API server and to render the router using the async-props module.","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, the last task we need to complete in this example is to update our web server in order to use the proxy server to redirect the API calls to the real API server and to render the router using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async-props"}]},{"block_type":"text","content":"module."}]},{"block_type":"element","block":"k5zy5c7u","search_text":"We renamed our server.js to webServer.js to clearly distinguish it from the API server file. This will be the content of the new file:","text_count":134,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We renamed our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"server.js"}]},{"block_type":"text","content":"to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"webServer.js"}]},{"block_type":"text","content":"&nbsp;to clearly distinguish it from the API server file. This will be the content of the new file:"}]},{"block_type":"element","block":"k5zy5c7v","search_text":"const http = require('http'); const Express = require('express'); const httpProxy = require('http-proxy'); const React = require('react'); const AsyncProps = require('async-props').default; const loadPropsOnServer = AsyncProps.loadPropsOnServer; const ReactDom = require('react-dom/server'); const Router = require('react-router'); const routesConfig = require('./src/routesConfig'); const app = new Express(); const server = new http.Server(app); const proxy = httpProxy.createProxyServer({ target: 'http://localhost:3001' }); app.set('view engine', 'ejs'); app.use('/dist', Express.static('dist')); app.use('/api', (req, res) => { proxy.web(req, res, {target: targetUrl}); }); app.get('*', (req, res) => { Router.match({routes: routesConfig, location: req.url}, (error, redirectLocation, renderProps) => { if (error) { res.status(500).send(error.message) } else if (redirectLocation) { res.redirect(302, redirectLocation.pathname + redirectLocation.search) } else if (renderProps) { loadPropsOnServer(renderProps, {}, (err, asyncProps, scriptTag) => { const markup = ReactDom.renderToString(<AsyncProps {...renderProps} {...asyncProps} />); res.render('index', {markup, scriptTag}); }); } else { res.status(404).send('Not found') } }); }); server.listen(3000, (err) => { if (err) { return console.error(err); } console.info('WebServer running on http://localhost:3000'); }); ","text_count":1377,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst Express = require('express'); \nconst httpProxy = require('http-proxy'); \nconst React = require('react'); \nconst AsyncProps = require('async-props').default; \nconst loadPropsOnServer = AsyncProps.loadPropsOnServer; \nconst ReactDom = require('react-dom/server'); \nconst Router = require('react-router'); \nconst routesConfig = require('./src/routesConfig'); \n \nconst app = new Express(); \nconst server = new http.Server(app); \n \nconst proxy = httpProxy.createProxyServer({ \n  target: 'http://localhost:3001' \n}); \n \napp.set('view engine', 'ejs'); \napp.use('/dist', Express.static('dist')); \napp.use('/api', (req, res) =&gt; { \n  proxy.web(req, res, {target: targetUrl}); \n}); \n \napp.get('*', (req, res) =&gt; { \n  Router.match({routes: routesConfig, location: req.url}, (error, \n    redirectLocation, renderProps) =&gt; { \n    if (error) { \n      res.status(500).send(error.message) \n    } else if (redirectLocation) { \n      res.redirect(302, redirectLocation.pathname + \n        redirectLocation.search) \n    } else if (renderProps) { \n      loadPropsOnServer(renderProps, {}, (err, asyncProps, scriptTag) =&gt; {\nconst markup = ReactDom.renderToString(&lt;AsyncProps {...renderProps} \n          {...asyncProps} /&gt;); \n        res.render('index', {markup, scriptTag});\n      }); \n    } else { \n      res.status(404).send('Not found') \n    } \n  }); \n}); \n \nserver.listen(3000, (err) =&gt; { \n  if (err) { \n    return console.error(err); \n  } \n  console.info('WebServer running on http://localhost:3000'); \n});"}]}]},{"block_type":"element","block":"k5zy5c7w","search_text":"Let's analyze one-by-one the changes from the previous version:","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's analyze one-by-one the changes from the previous version:"}]},{"block_type":"element","block":"k5zy5c7x","search_text":"First of all, we need to import some new modules: http-proxy and async-props . We initialize the proxy instance and we add it to our web server through middleware mapped to the requests that matches /api . We change the server-side rendering logic a bit. This time, we cannot directly call the renderToString function because we must ensure that all the asynchronous data has been loaded. The async-props module offers the function loadPropsOnServer to serve this purpose. This function executes all the necessary logic to load the data from the currently matched component asynchronously. When the loading finishes, a callback function is called, and only within this function is it safe to call the renderToString method. Also notice that, this time, we are rendering the AsyncProps component instead of RouterContext , passing it a set of synchronous and asynchronous attributes with the JSX-spread syntax. Another very important detail is that, in the callback, we are also receiving an argument called scriptTag . This variable will contain some JavaScript code that needs to be placed in the HTML code. This code will contain a representation of the asynchronous data loaded during the server-side rendering process, so that the browser will be able to directly access this data and will not need to make a duplicated API request. To put this script in the resulting HTML code, we pass it to the view along with the markup obtained from the component rendering process. ","text_count":1476,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First of all, we need to import some new modules:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http-proxy"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async-props"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We initialize the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"proxy"}]},{"block_type":"text","content":"instance and we add it to our web server through middleware mapped to the requests that matches"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/api"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We change the server-side rendering logic a bit. This time, we cannot directly call the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"renderToString"}]},{"block_type":"text","content":"function because we must ensure that all the asynchronous data has been loaded. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"async-props"}]},{"block_type":"text","content":"module offers the function"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"loadPropsOnServer"}]},{"block_type":"text","content":"to serve this purpose. This function executes all the necessary logic to load the data from the currently matched component asynchronously. When the loading finishes, a callback function is called, and only within this function is it safe to call the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"renderToString"}]},{"block_type":"text","content":"method. Also notice that, this time, we are rendering the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"AsyncProps"}]},{"block_type":"text","content":"&nbsp;component instead of&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"RouterContext"}]},{"block_type":"text","content":", passing it a set of synchronous and asynchronous attributes with the JSX-spread syntax. Another very important detail is that, in the callback, we are also receiving an argument called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"scriptTag"}]},{"block_type":"text","content":". This variable will contain some JavaScript code that needs to be placed in the HTML code. This code will contain a representation of the asynchronous data loaded during the server-side rendering process, so that the browser will be able to directly access this data and will not need to make a duplicated API request. To put this script in the resulting HTML code, we pass it to the view along with the markup obtained from the component rendering process."}]}]},{"block_type":"element","block":"k5zy5c7y","search_text":"Our views/index.ejs template was also slightly modified to display the scriptTag variable we just mentioned:","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"views/index.ejs"}]},{"block_type":"text","content":"template was also slightly modified to display the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"scriptTag"}]},{"block_type":"text","content":"variable we just mentioned:"}]},{"block_type":"element","block":"k5zy5c7z","search_text":"<!DOCTYPE html> <html> <head> <meta charset=\"utf-8\"/> <title>React Example - Authors archive</title> </head> <body> <div id=\"main\"><%- markup %></div> <script src=\"/dist/bundle.js\"></script> <%- scriptTag %> </body> </html> ","text_count":224,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&lt;!DOCTYPE html&gt; \n&lt;html&gt; \n  &lt;head&gt; \n    &lt;meta charset=\"utf-8\"/&gt; \n    &lt;title&gt;React Example - Authors archive&lt;/title&gt; \n  &lt;/head&gt; \n  &lt;body&gt; \n    &lt;div id=\"main\"&gt;&lt;%- markup %&gt;&lt;/div&gt; \n    &lt;script src=\"/dist/bundle.js\"&gt;&lt;/script&gt; \n    &lt;%- scriptTag %&gt; \n  &lt;/body&gt; \n&lt;/html&gt;"}]}]},{"block_type":"element","block":"k5zy5c80","search_text":"As you can see, we are adding the scriptTag before closing the body of the page.","text_count":80,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As you can see, we are adding the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"scriptTag"}]},{"block_type":"text","content":"before closing the body of the page."}]},{"block_type":"element","block":"k5zy5c81","search_text":"Now we are almost ready to execute this example; we just need to regenerate our bundle with Webpack and to start the web server with:","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are almost ready to execute this example; we just need to regenerate our bundle with Webpack and to start the web server with:"}]},{"block_type":"element","block":"k5zy5c82","search_text":"babel-cli server.js ","text_count":20,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"babel-cli server.js"}]}]},{"block_type":"element","block":"k5zy5c83","search_text":"Finally, you can open your browser and point it to http://localhost:3000 . Again, everything will look the same, but what happens under the hood is now completely different. Open your inspector or debugger on the browser and try to figure out when an API request is made by the browser. You can also check the console where you started the API server and read the logs to understand who is requesting the data and when.","text_count":419,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, you can open your browser and point it to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:3000"}]},{"block_type":"text","content":". Again, everything will look the same, but what happens under the hood is now completely different. Open your inspector or debugger on the browser and try to figure out when an API request is made by the browser. You can also check the console where you started the API server and read the logs to understand who is requesting the data and when."}]},{"block_type":"element","block":"k5zy5c84","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5c85","search_text":"In this chapter, we explored the innovative and fast-moving world of Universal JavaScript. Universal JavaScript just opened up a lot of new opportunities in the field of web development, but it is still quite a fresh and immature field.","text_count":236,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we explored the innovative and fast-moving world of Universal JavaScript. Universal JavaScript just opened up a lot of new opportunities in the field of web development, but it is still quite a fresh and immature field."}]},{"block_type":"element","block":"k5zy5c86","search_text":"In this chapter, we focused on introducing all the basics of this subject, discussing topics such as component-oriented user interfaces, universal rendering, universal routing, and universal data retrieval. Throughout the process, we built a very simple application that demonstrates how to combine together all these concepts. We also added to our belt a new chain of powerful tools and libraries, such as Webpack and React.","text_count":425,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we focused on introducing all the basics of this subject, discussing topics such as component-oriented user interfaces, universal rendering, universal routing, and universal data retrieval. Throughout the process, we built a very simple application that demonstrates how to combine together all these concepts. We also added to our belt a new chain of powerful tools and libraries, such as Webpack and React."}]},{"block_type":"element","block":"k5zy5c87","search_text":"Even though we discussed a lot of topics, we barely scratched the surface of this wide topic, and you should have gained all the necessary knowledge to keep exploring this world on your own if you are interested in knowing more. Given this immaturity, tools and libraries will probably change a lot in the next few years, but all the basic concepts should stay as they are, so don't be ashamed to keep exploring and experimenting. To become an expert on this topic is now just a matter of using the acquired knowledge to build a first real-world app with real, business-driven use cases.","text_count":587,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Even though we discussed a lot of topics, we barely scratched the surface of this wide topic, and you should have gained all the necessary knowledge to keep exploring this world on your own if you are interested in knowing more. Given this immaturity, tools and libraries will probably change a lot in the next few years, but all the basic concepts should stay as they are, so don't be ashamed to keep exploring and experimenting. To become an expert on this topic is now just a matter of using the acquired knowledge to build a first real-world app with real, business-driven use cases."}]},{"block_type":"element","block":"k5zy5c88","search_text":"It's also worth underlining that the knowledge acquired here might be useful for projects that cross the boundaries of web development, like mobile app development. If you are interested in this topic, React Native might be a good starting point.","text_count":246,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's also worth underlining that the knowledge acquired here might be useful for projects that cross the boundaries of web development, like mobile app development. If you are interested in this topic, React Native might be a good starting point."}]},{"block_type":"element","block":"k5zy5c89","search_text":"In the next chapter, we are going to strengthen our knowledge of asynchronous design patterns and address some specific scenarios such as asynchronously initialized modules and asynchronous batching and caching. Are you ready for some more advanced and exciting topics?","text_count":269,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter, we are going to strengthen our knowledge of asynchronous design patterns and address some specific scenarios such as asynchronously initialized modules and asynchronous batching and caching. Are you ready for some more advanced and exciting topics?"}]}]},{"title":"Advance Asynchronous Recipes","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4mtx","number":9,"contents":[{"block_type":"element","block":"k5zy5c8a","search_text":"Almost all the design patterns we've seen so far can be considered generic and applicable to many different areas of an application. There is, however, a set of patterns that are more specific and focused on solving well-defined problems; we can call these patterns recipes . As in real-life cooking, we have a set of well-defined steps to follow that will lead us to an expected outcome. Of course, this doesn't mean that we can't use some creativity to customize the recipes to match the taste of our guests, but the outline of the procedure is usually the one that matters. In this chapter, we are going to provide some popular recipes to solve some specific problems we encounter in our everyday Node.js development. These recipes include the following:","text_count":757,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Almost all the design patterns we've seen so far can be considered generic and applicable to many different areas of an application. There is, however, a set of patterns that are more specific and focused on solving well-defined problems; we can call these patterns"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"recipes"}]},{"block_type":"text","content":". As in real-life cooking, we have a set of well-defined steps to follow that will lead us to an expected outcome. Of course, this doesn't mean that we can't use some creativity to customize the recipes to match the taste of our guests, but the outline of the procedure is usually the one that matters. In this chapter, we are going to provide some popular recipes to solve some specific problems we encounter in our everyday Node.js development. These recipes include the following:"}]},{"block_type":"element","block":"k5zy5c8b","search_text":"Requiring modules that are initialized asynchronously Batching and caching asynchronous operations to get a performance boost in busy applications, using only minimal development effort Running synchronous CPU-bound operations that can block the event loop and cripple the ability of Node.js to handle concurrent requests ","text_count":322,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Requiring modules that are initialized asynchronously"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Batching and caching asynchronous operations to get a performance boost in busy applications, using only minimal development effort"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Running synchronous CPU-bound operations that can block the event loop and cripple the ability of Node.js to handle concurrent requests"}]}]},{"block_type":"element","block":"k5zy5c8c","search_text":"Requiring asynchronously initialized modules","text_count":44,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Requiring asynchronously initialized modules"}]},{"block_type":"element","block":"k5zy5c8d","search_text":"In Chapter 2, Node.js Essential Patterns , when we discussed the fundamental properties of the Node.js module system, we mentioned the fact that require() works synchronously and that module.exports cannot be set asynchronously.","text_count":228,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Essential Patterns"}]},{"block_type":"text","content":", when we discussed the fundamental properties of the Node.js module system, we mentioned the fact that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"require()"}]},{"block_type":"text","content":"works synchronously and that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"module.exports"}]},{"block_type":"text","content":"cannot be set asynchronously."}]},{"block_type":"element","block":"k5zy5c8e","search_text":"This is one of the main reasons for the existence of synchronous API in the core modules and many npm packages, they are provided more as a convenient alternative, to be used primarily for initialization tasks rather than a substitute for asynchronous API.","text_count":256,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is one of the main reasons for the existence of synchronous API in the core modules and many npm packages, they are provided more as a convenient alternative, to be used primarily for initialization tasks rather than a substitute for asynchronous API."}]},{"block_type":"element","block":"k5zy5c8f","search_text":"Unfortunately, this is not always possible; a synchronous API might not always be available, especially for components using the network during their initialization phase, for example, to perform handshake protocols or to retrieve configuration parameters. This is the case for many database drivers and clients for middleware systems such as message queues.","text_count":358,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Unfortunately, this is not always possible; a synchronous API might not always be available, especially for components using the network during their initialization phase, for example, to perform handshake protocols or to retrieve configuration parameters. This is the case for many database drivers and clients for middleware systems such as message queues."}]},{"block_type":"element","block":"k5zy5c8g","search_text":"Canonical solutions","text_count":19,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Canonical solutions"}]},{"block_type":"element","block":"k5zy5c8h","search_text":"Let's take an example: a module called db , which connects to a remote database. The db module will be able to accept requests only after the connection and the handshake with the server have been completed. In this scenario, we usually have two options:","text_count":254,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's take an example: a module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":", which connects to a remote database. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"db"}]},{"block_type":"text","content":"module will be able to accept requests only after the connection and the handshake with the server have been completed. In this scenario, we usually have two options:"}]},{"block_type":"element","block":"k5zy5c8i","search_text":"Making sure that the module is initialized before starting to use it, otherwise wait for its initialization. This process has to be done every time we want to invoke an operation on the asynchronous module: ","text_count":207,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Making sure that the module is initialized before starting to use it, otherwise wait for its initialization. This process has to be done every time we want to invoke an operation on the asynchronous module:"}]}]},{"block_type":"element","block":"k5zy5c8j","search_text":"const db = require('aDb'); //The async module module.exports = function findAll(type, callback) { if(db.connected) { //is it initialized? runFind(); } else { db.once('connected', runFind); } function runFind() { db.findAll(type, callback); }); }; ","text_count":247,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const db = require('aDb'); //The async module \n \n       module.exports = function findAll(type, callback) { \n         if(db.connected) {  //is it initialized? \n           runFind(); \n         } else { \n           db.once('connected', runFind); \n         } \n         function runFind() { \n           db.findAll(type, callback); \n         }); \n       };"}]}]},{"block_type":"element","block":"k5zy5c8k","search_text":"Use Dependency Injection ( DI ) instead of directly requiring the asynchronous module. By doing this, we can delay the initialization of some modules until their asynchronous dependencies are fully initialized. This technique shifts the complexity of managing the module initialization to another component, usually the parent module. In the following example, this component is app.js : ","text_count":388,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Use"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Dependency Injection"}]},{"block_type":"text","content":"&nbsp;("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"DI"}]},{"block_type":"text","content":") instead of directly requiring the asynchronous module. By doing this, we can delay the initialization of some modules until their asynchronous dependencies are fully initialized. This technique shifts the complexity of managing the module initialization to another component, usually the parent module. In the following example, this component is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":":"}]}]},{"block_type":"element","block":"k5zy5c8l","search_text":"//in the module app.js const db = require('aDb'); //The async module const findAllFactory = require('./findAll'); db.on('connected', function() { const findAll = findAllFactory(db); }); //in the module findAll.js module.exports = db => { //db is guaranteed to be initialized return function findAll(type, callback) { db.findAll(type, callback); } } ","text_count":349,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//in the module app.js \n       const db = require('aDb'); //The async module \n       const findAllFactory = require('./findAll'); \n       db.on('connected', function() { \n         const findAll = findAllFactory(db); \n       }); \n \n       //in the module findAll.js \n       module.exports = db =&gt; { \n         //db is guaranteed to be initialized \n         return function findAll(type, callback) { \n           db.findAll(type, callback); \n         } \n       }"}]}]},{"block_type":"element","block":"k5zy5c8m","search_text":"We can immediately see that the first option can become highly undesirable, considering the amount of boilerplate code involved.","text_count":128,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can immediately see that the first option can become highly undesirable, considering the amount of boilerplate code involved."}]},{"block_type":"element","block":"k5zy5c8n","search_text":"Also, the second option, which uses DI, is sometimes undesirable, as we have seen in Chapter 7, Wiring Modules . In big projects, it can quickly become over-complicated, especially if done manually and with asynchronously initialized modules. These problems would be mitigated if we were using a DI container designed to support asynchronously initialized modules.","text_count":364,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, the second option, which uses DI, is sometimes undesirable, as we have seen in Chapter 7,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Wiring Modules"}]},{"block_type":"text","content":". In big projects, it can quickly become over-complicated, especially if done manually and with asynchronously initialized modules. These problems would be mitigated if we were using a DI container designed to support asynchronously initialized modules."}]},{"block_type":"element","block":"k5zy5c8o","search_text":"As we will see, though, there is a third alternative that allows us to easily isolate the module from the initialization state of its dependencies.","text_count":147,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we will see, though, there is a third alternative that allows us to easily isolate the module from the initialization state of its dependencies."}]},{"block_type":"element","block":"k5zy5c8p","search_text":"Preinitialization queues","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Preinitialization queues"}]},{"block_type":"element","block":"k5zy5c8q","search_text":"A simple pattern to decouple a module from the initialization state of a dependency involves the use of queues and the Command pattern. The idea is to save all the operations received by a module while it's not yet initialized and then execute them as soon as all the initialization steps have been completed.","text_count":309,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A simple pattern to decouple a module from the initialization state of a dependency involves the use of queues and the Command pattern. The idea is to save all the operations received by a module while it's not yet initialized and then execute them as soon as all the initialization steps have been completed."}]},{"block_type":"element","block":"k5zy5c8r","search_text":"Implementing a module that initializes asynchronously","text_count":53,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing a module that initializes asynchronously"}]},{"block_type":"element","block":"k5zy5c8s","search_text":"To demonstrate this simple but effective technique, let's build a small test application; nothing fancy, just something to verify our assumptions. Let's start by creating an asynchronously initialized module called asyncModule.js :","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate this simple but effective technique, let's build a small test application; nothing fancy, just something to verify our assumptions. Let's start by creating an asynchronously initialized module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c8t","search_text":"const asyncModule = module.exports; asyncModule.initialized = false; asyncModule.initialize = callback => { setTimeout(function() { asyncModule.initialized = true; callback(); }, 10000); }; asyncModule.tellMeSomething = callback => { process.nextTick(() => { if(!asyncModule.initialized) { return callback( new Error('I don't have anything to say right now') ); } callback(null, 'Current time is: ' + new Date()); }); }; ","text_count":421,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const asyncModule = module.exports; \n \nasyncModule.initialized = false; \n \nasyncModule.initialize = callback =&gt; { \n  setTimeout(function() { \n    asyncModule.initialized = true; \n    callback(); \n  }, 10000); \n}; \n \nasyncModule.tellMeSomething = callback =&gt; { \n  process.nextTick(() =&gt; { \n    if(!asyncModule.initialized) { \n      return callback( \n        new Error('I don't have anything to say right now') \n      ); \n    } \n    callback(null, 'Current time is: ' + new Date()); \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5c8u","search_text":"In the preceding code, asyncModule tries to demonstrate how an asynchronously initialized module works. It exposes an initialize() method, which after a delay of 10 seconds, sets the initialized variable to true and notifies its callback (10 seconds is a lot for a real application, but for us it's great for highlighting any race conditions). The other method, tellMeSomething() , returns the current time, but if the module is not yet initialized, it generates an error.","text_count":472,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"tries to demonstrate how an asynchronously initialized module works. It exposes an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"initialize()"}]},{"block_type":"text","content":"method, which after a delay of 10 seconds, sets the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"initialized"}]},{"block_type":"text","content":"variable to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true"}]},{"block_type":"text","content":"and notifies its callback (10 seconds is a lot for a real application, but for us it's great for highlighting any race conditions). The other method,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tellMeSomething()"}]},{"block_type":"text","content":", returns the current time, but if the module is not yet initialized, it generates an error."}]},{"block_type":"element","block":"k5zy5c8v","search_text":"The next step is to create another module depending on the service we just created. Let's consider a simple HTTP request handler implemented in a file called routes.js :","text_count":169,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next step is to create another module depending on the service we just created. Let's consider a simple HTTP request handler implemented in a file called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routes.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c8w","search_text":"const asyncModule = require('./asyncModule'); module.exports.say = (req, res) => { asyncModule.tellMeSomething((err, something) => { if(err) { res.writeHead(500); return res.end('Error:' + err.message); } res.writeHead(200); res.end('I say: ' + something); }); }; ","text_count":264,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const asyncModule = require('./asyncModule'); \n \nmodule.exports.say = (req, res) =&gt; { \n  asyncModule.tellMeSomething((err, something) =&gt; { \n    if(err) { \n      res.writeHead(500); \n      return res.end('Error:' + err.message); \n    } \n    res.writeHead(200); \n    res.end('I say: ' + something); \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5c8x","search_text":"The handler invokes the tellMeSomething() method of asyncModule , then it writes the result into an HTTP response. As we can see, we are not performing any checks on the initialization state of asyncModule , and as we can imagine, this will likely lead to problems.","text_count":265,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The handler invokes the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tellMeSomething()"}]},{"block_type":"text","content":"method of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":", then it writes the result into an HTTP response. As we can see, we are not performing any checks on the initialization state of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":", and as we can imagine, this will likely lead to problems."}]},{"block_type":"element","block":"k5zy5c8y","search_text":"Now, let's create a very basic HTTP server using nothing but the core http module (the app.js file):","text_count":100,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's create a very basic HTTP server using nothing but the core"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http"}]},{"block_type":"text","content":"module (the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"file):"}]},{"block_type":"element","block":"k5zy5c8z","search_text":"const http = require('http'); const routes = require('./routes'); const asyncModule = require('./asyncModule'); asyncModule.initialize(() => { console.log('Async module initialized'); }); http.createServer((req, res) => { if (req.method === 'GET' && req.url === '/say') { return routes.say(req, res); } res.writeHead(404); res.end('Not found'); }).listen(8000, () => console.log('Started')); ","text_count":392,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst routes = require('./routes'); \nconst asyncModule = require('./asyncModule'); \n \nasyncModule.initialize(() =&gt; { \n  console.log('Async module initialized'); \n}); \n \nhttp.createServer((req, res) =&gt; { \n  if (req.method === 'GET' && req.url === '/say') { \n    return routes.say(req, res); \n  } \n  res.writeHead(404); \n  res.end('Not found'); \n}).listen(8000, () =&gt; console.log('Started'));"}]}]},{"block_type":"element","block":"k5zy5c90","search_text":"The preceding small module is the entry point of our application, and all it does is trigger the initialization of asyncModule and create an HTTP server that makes use of the request handler we created previously ( routes.say() ).","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding small module is the entry point of our application, and all it does is trigger the initialization of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"and create an HTTP server that makes use of the request handler we created previously ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routes.say()"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5c91","search_text":"We can now try to fire up our server by executing the app.js module as usual. After the server is started, we can try to hit the URL, http://localhost:8000/say , with a browser and see what comes back from our asyncModule .","text_count":223,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now try to fire up our server by executing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module as usual. After the server is started, we can try to hit the URL,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:8000/say"}]},{"block_type":"text","content":", with a browser and see what comes back from our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5c92","search_text":"As expected, if we send the request just after the server is started, the result will be an error as follows:","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As expected, if we send the request just after the server is started, the result will be an error as follows:"}]},{"block_type":"element","block":"k5zy5c93","search_text":"Error:I don't have anything to say right now ","text_count":45,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Error:I don't have anything to say right now"}]}]},{"block_type":"element","block":"k5zy5c94","search_text":"This means that asyncModule is not yet initialized, but we still tried to use it. Depending on the implementation details of the asynchronously initialized module, we could have received a graceful error, lost important information, or even crashed the entire application. In general, the situation we just described has to always be avoided. Most of the time, a few failing requests might not be a concern or the initialization might be so fast that, in practice, it would never happen; however, for high load applications and cloud servers designed to autoscale , both of these assumptions might quickly get obliterated.","text_count":622,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This means that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"is not yet initialized, but we still tried to use it. Depending on the implementation details of the asynchronously initialized module, we could have received a graceful error, lost important information, or even crashed the entire application. In general, the situation we just described has to always be avoided. Most of the time, a few failing requests might not be a concern or the initialization might be so fast that, in practice, it would never happen; however, for high load applications and cloud servers designed to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"autoscale"}]},{"block_type":"text","content":", both of these assumptions might quickly get obliterated."}]},{"block_type":"element","block":"k5zy5c95","search_text":"Wrapping the module with preinitialization queues","text_count":49,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Wrapping the module with preinitialization queues"}]},{"block_type":"element","block":"k5zy5c96","search_text":"To add robustness to our server, we are now going to refactor it by applying the pattern we described at the beginning of the section. We will queue any operations invoked on asyncModule during the time it's not yet initialized and then flush the queue as soon we are ready to process them. This looks like a great application for the State pattern! We will need two states, one that queues all the operations while the module is not yet initialized, and another that simply delegates each method to the original asyncModule module, when the initialization is complete.","text_count":569,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To add robustness to our server, we are now going to refactor it by applying the pattern we described at the beginning of the section. We will queue any operations invoked on"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"during the time it's not yet initialized and then flush the queue as soon we are ready to process them. This looks like a great application for the State pattern! We will need two states, one that queues all the operations while the module is not yet initialized, and another that simply delegates each method to the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"module, when the initialization is complete."}]},{"block_type":"element","block":"k5zy5c97","search_text":"Often, we don't have the chance to modify the code of the asynchronous module; so, to add our queuing layer, we will need to create a proxy around the original asyncModule module.","text_count":179,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Often, we don't have the chance to modify the code of the asynchronous module; so, to add our queuing layer, we will need to create a proxy around the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"module."}]},{"block_type":"element","block":"k5zy5c98","search_text":"Let's start to work on the code; let's create a new file named asyncModuleWrapper.js and let's start building it piece-by-piece. The first thing that we need to do is to create the object that delegates the operations to the active state:","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start to work on the code; let's create a new file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModuleWrapper.js"}]},{"block_type":"text","content":"and let's start building it piece-by-piece. The first thing that we need to do is to create the object that delegates the operations to the active state:"}]},{"block_type":"element","block":"k5zy5c99","search_text":"const asyncModule = require('./asyncModule'); const asyncModuleWrapper = module.exports; asyncModuleWrapper.initialized = false; asyncModuleWrapper.initialize = () => { activeState.initialize.apply(activeState, arguments); }; asyncModuleWrapper.tellMeSomething = () => { activeState.tellMeSomething.apply(activeState, arguments); }; ","text_count":333,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const asyncModule = require('./asyncModule'); \n \nconst asyncModuleWrapper = module.exports; \n \nasyncModuleWrapper.initialized = false; \nasyncModuleWrapper.initialize = () =&gt; { \n  activeState.initialize.apply(activeState, arguments); \n}; \n \nasyncModuleWrapper.tellMeSomething = () =&gt; { \n  activeState.tellMeSomething.apply(activeState, arguments); \n};"}]}]},{"block_type":"element","block":"k5zy5c9a","search_text":"In the preceding code, asyncModuleWrapper simply delegates each of its methods to the currently active state. Let's see then what the two states look like, starting from notInitializedState :","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModuleWrapper"}]},{"block_type":"text","content":"simply delegates each of its methods to the currently active state. Let's see then what the two states look like, starting from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"notInitializedState"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c9b","search_text":"const pending = []; const notInitializedState = { initialize: function(callback) { asyncModule.initialize(() => { asyncModuleWrapper.initalized = true; activeState = initializedState; //[1] pending.forEach(req => { //[2] asyncModule[req.method].apply(null, req.args); }); pending = []; callback(); //[3] }); }, tellMeSomething: callback => { return pending.push({ method: 'tellMeSomething', args: arguments }); } }; ","text_count":416,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const pending = []; \nconst notInitializedState = { \n \n  initialize: function(callback) { \n    asyncModule.initialize(() =&gt; { \n      asyncModuleWrapper.initalized = true; \n      activeState = initializedState;                 //[1] \n \n      pending.forEach(req =&gt; {                        //[2] \n        asyncModule[req.method].apply(null, req.args); \n      }); \n      pending = []; \n \n      callback();                                     //[3] \n    }); \n  }, \n \n  tellMeSomething: callback =&gt; { \n    return pending.push({ \n      method: 'tellMeSomething', \n      args: arguments \n    }); \n  } \n};"}]}]},{"block_type":"element","block":"k5zy5c9c","search_text":"When the initialize() method is invoked, we trigger the initialization of the original asyncModule module, providing a callback proxy. This allows our wrapper to know when the original module is initialized and consequently triggers the following operations:","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"initialize()"}]},{"block_type":"text","content":"method is invoked, we trigger the initialization of the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"module, providing a callback proxy. This allows our wrapper to know when the original module is initialized and consequently triggers the following operations:"}]},{"block_type":"element","block":"k5zy5c9d","search_text":"Updates the activeState variable with the next state object in our flow— initializedState . Executes all the commands that were previously stored in the pending queue. Invokes the original callback. ","text_count":199,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Updates the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"activeState"}]},{"block_type":"text","content":"variable with the next state object in our flow&mdash;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"initializedState"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Executes all the commands that were previously stored in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pending"}]},{"block_type":"text","content":"queue."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Invokes the original callback."}]}]},{"block_type":"element","block":"k5zy5c9e","search_text":"As the module at this point is not yet initialized, the tellMeSomething() method of this state simply creates a new Command object and adds it to the queue of the pending operations.","text_count":182,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As the module at this point is not yet initialized, the&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tellMeSomething()"}]},{"block_type":"text","content":"method of this state simply creates a new Command object and adds it to the queue of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pending"}]},{"block_type":"text","content":"operations."}]},{"block_type":"element","block":"k5zy5c9f","search_text":"At this point, the pattern should already be clear when the original asyncModule module is not yet initialized, our wrapper will simply queue all the received requests. Then, when we are notified that the initialization is complete, we execute all the queued operations and then switch the internal state to initializedState . Let's see then, what this last piece of the wrapper looks like:","text_count":390,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, the pattern should already be clear when the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"module is not yet initialized, our wrapper will simply queue all the received requests. Then, when we are notified that the initialization is complete, we execute all the queued operations and then switch the internal state to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"initializedState"}]},{"block_type":"text","content":". Let's see then, what this last piece of the wrapper looks like:"}]},{"block_type":"element","block":"k5zy5c9g","search_text":"let initializedState = asyncModule; ","text_count":36,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"let initializedState = asyncModule;"}]}]},{"block_type":"element","block":"k5zy5c9h","search_text":"Without (probably) any surprise, the initializedState object is simply a reference to the original asyncModule ! In fact, when the initialization is complete, we can safely route any request directly to the original module. Nothing more is required.","text_count":249,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Without (probably) any surprise, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"initializedState"}]},{"block_type":"text","content":"object is simply a reference to the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"! In fact, when the initialization is complete, we can safely route any request directly to the original module. Nothing more is required."}]},{"block_type":"element","block":"k5zy5c9i","search_text":"At last, we have to set the initial active state, which of course will be notInitializedState :","text_count":95,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At last, we have to set the initial active state, which of course will be"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"notInitializedState"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5c9j","search_text":"let activeState = notInitializedState; ","text_count":39,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"let activeState = notInitializedState;"}]}]},{"block_type":"element","block":"k5zy5c9k","search_text":"We can now try to launch our test server again, but first, let's not forget to replace the references to the original asyncModule module with our new asyncModuleWrapper object; this has to be done in the app.js and routes.js modules.","text_count":233,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now try to launch our test server again, but first, let's not forget to replace the references to the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"module with our new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModuleWrapper"}]},{"block_type":"text","content":"object; this has to be done in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routes.js"}]},{"block_type":"text","content":"modules."}]},{"block_type":"element","block":"k5zy5c9l","search_text":"After doing this, if we try to send a request to the server again, we will see that during the time the asyncModule module is not yet initialized, the requests will not fail; instead, they will hang until the initialization is completed and will only then be actually executed. We can surely affirm that this is a much more robust behavior.","text_count":340,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"After doing this, if we try to send a request to the server again, we will see that during the time the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"asyncModule"}]},{"block_type":"text","content":"module is not yet initialized, the requests will not fail; instead, they will hang until the initialization is completed and will only then be actually executed. We can surely affirm that this is a much more robust behavior."}]},{"block_type":"element","block":"k5zy5c9m","search_text":"Tip Pattern If a module is initialized asynchronously, queue every operation until the module is fully initialized. ","text_count":116,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern"}]},{"block_type":"text","content":"&nbsp;"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If a module is initialized asynchronously, queue every operation until the module is fully initialized."}]}]},{"block_type":"element","block":"k5zy5c9n","search_text":"Now, our server can start accepting requests immediately after it's started and it guarantees that none of these requests will ever fail because of the initialization state of its modules. We were able to obtain this result without using DI or requiring verbose and error-prone checks to verify the state of the asynchronous module.","text_count":332,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, our server can start accepting requests immediately after it's started and it guarantees that none of these requests will ever fail because of the initialization state of its modules. We were able to obtain this result without using DI or requiring verbose and error-prone checks to verify the state of the asynchronous module."}]},{"block_type":"element","block":"k5zy5c9o","search_text":"In the wild","text_count":11,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"In the wild"}]},{"block_type":"element","block":"k5zy5c9p","search_text":"The pattern we just presented is used by many database drivers and ORM libraries. The most notable is Mongoose ( http://mongoosejs.com ), which is an ORM for MongoDB . With Mongoose, it's not necessary to wait for the database connection to open in order to be able to send queries, because each operation is queued and then executed later when the connection with the database is fully established. This clearly boosts the usability of its API.","text_count":445,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The pattern we just presented is used by many database drivers and ORM libraries. The most notable is Mongoose ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://mongoosejs.com"},"children":[{"block_type":"text","content":"http://mongoosejs.com"}]},{"block_type":"text","content":"), which is an ORM for"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"MongoDB"}]},{"block_type":"text","content":". With Mongoose, it's not necessary to wait for the database connection to open in order to be able to send queries, because each operation is queued and then executed later when the connection with the database is fully established. This clearly boosts the usability of its API."}]},{"block_type":"element","block":"k5zy5c9q","search_text":"Tip Take a look at the code of Mongoose to see how every method in the native driver is proxied to add the preinitialization queue (it also demonstrates an alternative way of implementing this pattern). You can find the code fragment responsible for implementing the pattern at https://github.com/LearnBoost/mongoose/blob/21f16c62e2f3230fe616745a40f22b4385a11b11/lib/drivers/node-mongodb-native/collection.js#L103-138 . ","text_count":420,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Take a look at the code of Mongoose to see how every method in the native driver is proxied to add the preinitialization queue (it also demonstrates an alternative way of implementing this pattern). You can find the code fragment responsible for implementing the pattern at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/LearnBoost/mongoose/blob/21f16c62e2f3230fe616745a40f22b4385a11b11/lib/drivers/node-mongodb-native/collection.js#L103-138"},"children":[{"block_type":"text","content":"https://github.com/LearnBoost/mongoose/blob/21f16c62e2f3230fe616745a40f22b4385a11b11/lib/drivers/node-mongodb-native/collection.js#L103-138"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5c9r","search_text":"Asynchronous batching and caching","text_count":33,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Asynchronous batching and caching"}]},{"block_type":"element","block":"k5zy5c9s","search_text":"In high-load applications, caching plays a critical role and is used almost everywhere in the web, from static resources such as web pages, images, and stylesheets, to pure data such as the result of database queries. In this section, we are going to learn how caching applies to asynchronous operations and how a high request throughput can be turned to our advantage.","text_count":369,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In high-load applications,"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"caching&nbsp;"}]},{"block_type":"text","content":"plays a critical role and is used almost everywhere in the web, from static resources such as web pages, images, and stylesheets, to pure data such as the result of database queries. In this section, we are going to learn how caching applies to asynchronous operations and how a high request throughput can be turned to our advantage."}]},{"block_type":"element","block":"k5zy5c9t","search_text":"Implementing a server with no caching or batching","text_count":49,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Implementing a server with no caching or batching"}]},{"block_type":"element","block":"k5zy5c9u","search_text":"Before we start diving into this new challenge, let's implement a small demo server that we will use as a reference to measure the impact of the various techniques we are going to implement.","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Before we start diving into this new challenge, let's implement a small demo server that we will use as a reference to measure the impact of the various techniques we are going to implement."}]},{"block_type":"element","block":"k5zy5c9v","search_text":"Let's consider a web server that manages the sales of an e-commerce company, in particular, we want to query our server for the sum of all the transactions of a particular type of merchandise. For this purpose, we are going to use LevelUP again for its simplicity and flexibility. The data model that we are going to use is a simple list of transactions stored in the sales sublevel (a section of the database), which is organized in the following format:","text_count":455,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's consider a web server that manages the sales of an e-commerce company, in particular, we want to query our server for the sum of all the transactions of a particular type of merchandise. For this purpose, we are going to use LevelUP again for its simplicity and flexibility. The data model that we are going to use is a simple list of transactions stored in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sales"}]},{"block_type":"text","content":"sublevel (a section of the database), which is organized in the following format:"}]},{"block_type":"element","block":"k5zy5c9w","search_text":"transactionId {amount, item} ","text_count":29,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"transactionId {amount, item}"}]}]},{"block_type":"element","block":"k5zy5c9x","search_text":"The key is represented by transactionId and the value is a JSON object that contains the amount of the sale ( amount ) and the item type.","text_count":137,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The key is represented by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"transactionId"}]},{"block_type":"text","content":"and the value is a JSON object that contains the amount of the sale ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"amount"}]},{"block_type":"text","content":") and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"item"}]},{"block_type":"text","content":"type."}]},{"block_type":"element","block":"k5zy5c9y","search_text":"The data to process is really basic, so let's implement the API immediately in a file named totalSales.js , which will be as follows:","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The data to process is really basic, so let's implement the API immediately in a file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales.js"}]},{"block_type":"text","content":", which will be as follows:"}]},{"block_type":"element","block":"k5zy5c9z","search_text":"const level = require('level'); const sublevel = require('level-sublevel'); const db = sublevel(level('example-db', {valueEncoding: 'json'})); const salesDb = db.sublevel('sales'); module.exports = function totalSales(item, callback) { console.log('totalSales() invoked'); let sum = 0; salesDb.createValueStream() // [1] .on('data', data => { if(!item || data.item === item) { // [2] sum += data.amount; } }) .on('end', () => { callback(null, sum); // [3] }); }; ","text_count":463,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const level = require('level'); \nconst sublevel = require('level-sublevel'); \nconst db = sublevel(level('example-db', {valueEncoding: 'json'})); \nconst salesDb = db.sublevel('sales'); \n \nmodule.exports = function totalSales(item, callback) { \n  console.log('totalSales() invoked'); \n  let sum = 0; \n  salesDb.createValueStream()            // [1] \n    .on('data', data =&gt; { \n      if(!item || data.item === item) {  // [2] \n        sum += data.amount; \n      } \n    }) \n    .on('end', () =&gt; { \n      callback(null, sum);               // [3] \n    }); \n};"}]}]},{"block_type":"element","block":"k5zy5ca0","search_text":"The core of the module is the totalSales function, which is also the only exported API; this is how it works:","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The core of the module is the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales"}]},{"block_type":"text","content":"function, which is also the only exported API; this is how it works:"}]},{"block_type":"element","block":"k5zy5ca1","search_text":"We create a stream from the salesDb sublevel that contains the sales transactions. The stream pulls all the entries from the database. The data event receives each sale transaction as it is returned from the database stream. We add the amount value of the current entry to the total sum value, but only if the item type is equal to the one provided in the input (or if no input is provided at all, allowing us to calculate the sum of all the transactions, regardless of the item type). At last, when the end event is received, we invoke the callback() method by providing the final sum as result. ","text_count":597,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We create a stream from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"salesDb"}]},{"block_type":"text","content":"sublevel that contains the sales transactions. The stream pulls all the entries from the database."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"data"}]},{"block_type":"text","content":"event receives each sale transaction as it is returned from the database stream. We add the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"amount"}]},{"block_type":"text","content":"value of the current entry to the total"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sum"}]},{"block_type":"text","content":"value, but only if the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"item"}]},{"block_type":"text","content":"type is equal to the one provided in the input (or if no input is provided at all, allowing us to calculate the sum of all the transactions, regardless of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"item"}]},{"block_type":"text","content":"type)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At last, when the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end"}]},{"block_type":"text","content":"event is received, we invoke the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback()"}]},{"block_type":"text","content":"method by providing the final"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sum"}]},{"block_type":"text","content":"as result."}]}]},{"block_type":"element","block":"k5zy5ca2","search_text":"The simple query that we built is definitely not the best in terms of performance. Ideally, in a real-world application, we would have used an index to query the transactions by the item type, or even better, an incremental map/reduce to calculate the sum in real time; however, for our example, a slow query is actually better as it will highlight the advantages of the patterns we are going to analyze.","text_count":404,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The simple query that we built is definitely not the best in terms of performance. Ideally, in a real-world application, we would have used an index to query the transactions by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"item"}]},{"block_type":"text","content":"type, or even better, an incremental map/reduce to calculate the sum in real time; however, for our example, a slow query is actually better as it will highlight the advantages of the patterns we are going to analyze."}]},{"block_type":"element","block":"k5zy5ca3","search_text":"To finalize the total sales application, we only need to expose the totalSales API from an HTTP server; so, the next step is to build one (the app.js file):","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To finalize the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"total sales"}]},{"block_type":"text","content":"application, we only need to expose the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales"}]},{"block_type":"text","content":"API from an HTTP server; so, the next step is to build one (the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"file):"}]},{"block_type":"element","block":"k5zy5ca4","search_text":"const http = require('http'); const url = require('url'); const totalSales = require('./totalSales'); http.createServer((req, res) => { const query = url.parse(req.url, true).query; totalSales(query.item, (err, sum) => { res.writeHead(200); res.end(`Total sales for item ${query.item} is ${sum}`); }); }).listen(8000, () => console.log('Started')); ","text_count":349,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst url = require('url'); \nconst totalSales = require('./totalSales'); \n \nhttp.createServer((req, res) =&gt; { \n  const query = url.parse(req.url, true).query; \n  totalSales(query.item, (err, sum) =&gt; { \n    res.writeHead(200); \n    res.end(`Total sales for item ${query.item} is ${sum}`); \n  }); \n}).listen(8000, () =&gt; console.log('Started'));"}]}]},{"block_type":"element","block":"k5zy5ca5","search_text":"The server we created is very minimalistic; we only need it to expose the totalSales API.","text_count":89,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The server we created is very minimalistic; we only need it to expose the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales"}]},{"block_type":"text","content":"API."}]},{"block_type":"element","block":"k5zy5ca6","search_text":"Before we start the server for the first time, we need to populate the database with some sample data; we can do this with the populate_db.js script that is found in the code samples dedicated to this section. The script will create 100 K random sales transactions in the database.","text_count":281,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Before we start the server for the first time, we need to populate the database with some sample data; we can do this with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"populate_db.js"}]},{"block_type":"text","content":"script that is found in the code samples dedicated to this section. The script will create 100 K random sales transactions in the database."}]},{"block_type":"element","block":"k5zy5ca7","search_text":"Okay! Now, everything is ready. In order to start the server, as usual, we execute the following command:","text_count":105,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Okay! Now, everything is ready. In order to start the server, as usual, we execute the following command:"}]},{"block_type":"element","block":"k5zy5ca8","search_text":"node app ","text_count":9,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app"}]}]},{"block_type":"element","block":"k5zy5ca9","search_text":"To query the server, simply navigate with a browser to the following URL:","text_count":73,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To query the server, simply navigate with a browser to the following URL:"}]},{"block_type":"element","block":"k5zy5caa","search_text":"http://localhost:8000?item=book ","text_count":32,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"http://localhost:8000?item=book"}]}]},{"block_type":"element","block":"k5zy5cab","search_text":"However, to have a better idea of the performance of our server, we will need more than one request; so, we will use a small script named loadTest.js , which sends requests at intervals of 200 ms. The script can be found in the code samples of the book and it's already configured to connect to the URL of the server, so, to run it, just execute the following command:","text_count":368,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, to have a better idea of the performance of our server, we will need more than one request; so, we will use a small script named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"loadTest.js"}]},{"block_type":"text","content":", which sends requests at intervals of 200 ms. The script can be found in the code samples of the book and it's already configured to connect to the URL of the server, so, to run it, just execute the following command:"}]},{"block_type":"element","block":"k5zy5cac","search_text":"node loadTest ","text_count":14,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node loadTest"}]}]},{"block_type":"element","block":"k5zy5cad","search_text":"We will see that the 20 requests will take a while to complete; take note of the total execution time of the test, because we are now going to apply our optimizations and measure how much time we can save.","text_count":205,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will see that the 20 requests will take a while to complete; take note of the total execution time of the test, because we are now going to apply our optimizations and measure how much time we can save."}]},{"block_type":"element","block":"k5zy5cae","search_text":"Asynchronous request batching","text_count":29,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Asynchronous request batching"}]},{"block_type":"element","block":"k5zy5caf","search_text":"When dealing with asynchronous operations, the most basic level of caching can be achieved by batching together a set of invocations to the same API. The idea is very simple: if we are invoking an asynchronous function while there is still another one pending, we can attach callback to the already running operation, instead of creating a brand new request. Take a look at the following figure:","text_count":395,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When dealing with asynchronous operations, the most basic level of caching can be achieved by"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"batching"}]},{"block_type":"text","content":"together a set of invocations to the same API. The idea is very simple: if we are invoking an asynchronous function while there is still another one pending, we can attach callback to the already running operation, instead of creating a brand new request. Take a look at the following figure:"}]},{"block_type":"element","block":"k5zy5cag","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000055.jpg","alt":"Asynchronous request batching","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cah","search_text":"The previous image shows two clients (they can be two different objects, or two different web requests) invoking the same asynchronous operation with exactly the same input . Of course, the natural way to picture this situation is with the two clients starting two separate operations that will complete at two different moments, as shown by the preceding image. Now, consider the next scenario, depicted in the following figure:","text_count":429,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The previous image shows two clients (they can be two different objects, or two different web requests) invoking the same asynchronous operation with"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"exactly the same input"}]},{"block_type":"text","content":". Of course, the natural way to picture this situation is with the two clients starting two separate operations that will complete at two different moments, as shown by the preceding image. Now, consider the next scenario, depicted in the following figure:"}]},{"block_type":"element","block":"k5zy5cai","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000023.jpg","alt":"Asynchronous request batching","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5caj","search_text":"This second image shows us how the two requests—which invoke the same API with the same input—can be batched, or in other words, appended to the same running operation. By doing this, when the operation completes, both the clients will be notified. This represents a simple, yet extremely powerful, way to optimize the load of an application while not having to deal with more complex caching mechanisms, which usually require an adequate memory management and invalidation strategy.","text_count":483,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This second image shows us how the two requests&mdash;which invoke the same API with the same input&mdash;can be batched, or in other words, appended to the same running operation. By doing this, when the operation completes, both the clients will be notified. This represents a simple, yet extremely powerful, way to optimize the load of an application while not having to deal with more complex caching mechanisms, which usually require an adequate memory management and invalidation strategy."}]},{"block_type":"element","block":"k5zy5cak","search_text":"Batching requests in the total sales web server","text_count":47,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Batching requests in the total sales web server"}]},{"block_type":"element","block":"k5zy5cal","search_text":"Let's now add a batching layer on top of our totalSales API. The pattern we are going to use is very simple: if there is already another identical request pending when the API is invoked, we will add the callback to a queue. When the asynchronous operation completes, all the callbacks in its queue are invoked at once.","text_count":319,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now add a batching layer on top of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales"}]},{"block_type":"text","content":"API. The pattern we are going to use is very simple: if there is already another identical request pending when the API is invoked, we will add the callback to a queue. When the asynchronous operation completes, all the callbacks in its queue are invoked at once."}]},{"block_type":"element","block":"k5zy5cam","search_text":"Now, let's see how this pattern translates in code. Let's create a new module named totalSalesBatch.js . Here, we're going to implement a batching layer on top of the original totalSales API:","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's see how this pattern translates in code. Let's create a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSalesBatch.js"}]},{"block_type":"text","content":". Here, we're going to implement a batching layer on top of the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales"}]},{"block_type":"text","content":"API:"}]},{"block_type":"element","block":"k5zy5can","search_text":"const totalSales = require('./totalSales'); const queues = {}; module.exports = function totalSalesBatch(item, callback) { if(queues[item]) { // [1] console.log('Batching operation'); return queues[item].push(callback); } queues[item] = [callback]; // [2] totalSales(item, (err, res) => { const queue = queues[item]; // [3] queues[item] = null; queue.forEach(cb => cb(err, res)); }); }; ","text_count":387,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const totalSales = require('./totalSales'); \n \nconst queues = {}; \nmodule.exports = function totalSalesBatch(item, callback) { \n  if(queues[item]) {                                   // [1] \n    console.log('Batching operation'); \n    return queues[item].push(callback); \n  } \n \n  queues[item] = [callback];                          // [2] \n  totalSales(item, (err, res) =&gt; { \n    const queue = queues[item];                      // [3] \n    queues[item] = null; \n    queue.forEach(cb =&gt; cb(err, res)); \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5cao","search_text":"The totalSalesBatch() function is a proxy for the original totalSales() API, and it works as follows:","text_count":101,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSalesBatch()"}]},{"block_type":"text","content":"function is a proxy for the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"API, and it works as follows:"}]},{"block_type":"element","block":"k5zy5cap","search_text":"If a queue already exists for the item type provided as the input, it means that a request for that particular item is already running. In this case, all we have to do is simply append the callback to the existing queue and return from the invocation immediately. Nothing else is required. If no queue is defined for the item, it means that we have to create a new request. To do this, we create a new queue for that particular item and we initialize it with the current callback function. Next, we invoke the original totalSales() API. When the original totalSales() request completes, we iterate over all the callbacks that were added in the queue for that specific item and invoke them one by one with the result of the operation. ","text_count":734,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If a queue already exists for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"item"}]},{"block_type":"text","content":"type provided as the input, it means that a request for that particular"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"item"}]},{"block_type":"text","content":"is already running. In this case, all we have to do is simply append the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"to the existing queue and return from the invocation immediately. Nothing else is required."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If no queue is defined for the item, it means that we have to create a new request. To do this, we create a new queue for that particular"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"item"}]},{"block_type":"text","content":"and we initialize it with the current"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function. Next, we invoke the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"API."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"request completes, we iterate over all the callbacks that were added in the queue for that specific"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"item"}]},{"block_type":"text","content":"and invoke them one by one with the result of the operation."}]}]},{"block_type":"element","block":"k5zy5caq","search_text":"The behavior of the totalSalesBatch() function is identical to that of the original totalSales() API, with the difference that, now, multiple calls to the API using the same input are batched, thus saving time and resources.","text_count":224,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The behavior of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSalesBatch()"}]},{"block_type":"text","content":"function is identical to that of the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"API, with the difference that, now, multiple calls to the API using the same input are batched, thus saving time and resources."}]},{"block_type":"element","block":"k5zy5car","search_text":"Curious to know what the performance improvement compared to the raw, non-batched version of the totalSales() API is? Let's then replace the totalSales module used by the HTTP server with the one we just created (the app.js file):","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Curious to know what the performance improvement compared to the raw, non-batched version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"API is? Let's then replace the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales"}]},{"block_type":"text","content":"module used by the HTTP server with the one we just created (the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"file):"}]},{"block_type":"element","block":"k5zy5cas","search_text":"//const totalSales = require('./totalSales'); const totalSales = require('./totalSalesBatch'); http.createServer(function(req, res) { // ... ","text_count":141,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//const totalSales = require('./totalSales'); \nconst totalSales = require('./totalSalesBatch'); \n \nhttp.createServer(function(req, res) { \n// ..."}]}]},{"block_type":"element","block":"k5zy5cat","search_text":"If we now try to start the server again and run the load test against it, the first thing we will see is that the requests are returned in batches . This is the effect of the pattern we just implemented and it's a great practical demonstration of how it works.","text_count":260,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we now try to start the server again and run the load test against it, the first thing we will see is that the requests are returned in"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"batches"}]},{"block_type":"text","content":". This is the effect of the pattern we just implemented and it's a great practical demonstration of how it works."}]},{"block_type":"element","block":"k5zy5cau","search_text":"Besides that, we should also observe a considerable reduction in the total time for executing the test; it should be at least four times faster than the original test performed against the plain totalSales() API!","text_count":212,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Besides that, we should also observe a considerable reduction in the total time for executing the test; it should be at least four times faster than the original test performed against the plain"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"API!"}]},{"block_type":"element","block":"k5zy5cav","search_text":"This is a stunning result, confirming the huge performance boost we can obtain by just applying a simple batching layer, without all the complexity of managing a full-fledged cache, and more importantly, without worrying about invalidation strategies.","text_count":251,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is a stunning result, confirming the huge performance boost we can obtain by just applying a simple batching layer, without all the complexity of managing a full-fledged cache, and more importantly, without worrying about invalidation strategies."}]},{"block_type":"element","block":"k5zy5caw","search_text":"Note The request-batching pattern reaches its best potential in high-load applications and with slow APIs, because it's exactly in these circumstances that we can batch together a high number of requests. ","text_count":205,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The request-batching pattern reaches its best potential in high-load applications and with slow APIs, because it's exactly in these circumstances that we can batch together a high number of requests."}]}]},{"block_type":"element","block":"k5zy5cax","search_text":"Asynchronous request caching","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Asynchronous request caching"}]},{"block_type":"element","block":"k5zy5cay","search_text":"One of the problems with the request-batching pattern is that the faster the API, the fewer batched requests we get. One can argue that if an API is already fast, there is no point in trying to optimize it; however, it still represents a factor in the resource load of an application that, when summed up, can still have a substantial impact. Also, sometimes we can safely assume that the result of an API invocation will not change so often; therefore, a simple request batching will not provide the best performance. In all these circumstances, the best candidate to reduce the load of an application and increase its responsiveness is definitely a more aggressive caching pattern.","text_count":683,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the problems with the request-batching pattern is that the faster the API, the fewer batched requests we get. One can argue that if an API is already fast, there is no point in trying to optimize it; however, it still represents a factor in the resource load of an application that, when summed up, can still have a substantial impact. Also, sometimes we can safely assume that the result of an API invocation will not change so often; therefore, a simple request batching will not provide the best performance. In all these circumstances, the best candidate to reduce the load of an application and increase its responsiveness is definitely a more aggressive caching pattern."}]},{"block_type":"element","block":"k5zy5caz","search_text":"The idea is simple: as soon as a request completes, we store its result in the cache, which can be a variable, an entry in the database, or in a specialized caching server. Hence, the next time the API is invoked, the result can be retrieved immediately from the cache, instead of spawning another request.","text_count":306,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The idea is simple: as soon as a request completes, we store its result in the cache, which can be a variable, an entry in the database, or in a specialized caching server. Hence, the next time the API is invoked, the result can be retrieved immediately from the cache, instead of spawning another request."}]},{"block_type":"element","block":"k5zy5cb0","search_text":"The idea of caching should not be new to an experienced developer, but what makes this pattern different in asynchronous programming is that it should be combined with the request batching, to be optimal. The reason is because multiple requests might run concurrently while the cache is not set, and when those requests complete, the cache will be set multiple times. ","text_count":368,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The idea of caching should not be new to an experienced developer, but what makes this pattern different in asynchronous programming is that it should be combined with the request batching, to be optimal. The reason is because multiple requests might run concurrently while the cache is not set, and when those requests complete, the cache will be set multiple times.&nbsp;"}]},{"block_type":"element","block":"k5zy5cb1","search_text":"Based on these assumptions, the final structure of the asynchronous request-caching pattern is shown in the following figure:","text_count":125,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Based on these assumptions, the final structure of the asynchronous request-caching pattern is shown in the following figure:"}]},{"block_type":"element","block":"k5zy5cb2","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000056.jpg","alt":"Asynchronous request caching","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cb3","search_text":"The preceding figure shows us the two phases of an optimal asynchronous caching algorithm:","text_count":90,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding figure shows us the two phases of an optimal asynchronous caching algorithm:"}]},{"block_type":"element","block":"k5zy5cb4","search_text":"The first phase is totally identical to the batching pattern. Any request received while the cache is not set will be batched together. When the request completes, the cache is set, once. When the cache is finally set, any subsequent request will be served directly from it. ","text_count":275,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The first phase is totally identical to the batching pattern. Any request received while the cache is not set will be batched together. When the request completes, the cache is set, once."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the cache is finally set, any subsequent request will be served directly from it."}]}]},{"block_type":"element","block":"k5zy5cb5","search_text":"Another crucial detail to consider is the unleashing Zalgo anti-pattern (we have seen it in action in Chapter 2, Node.js Essential Patterns ). As we are dealing with asynchronous APIs, we must be sure to always return the cached value asynchronously, even if accessing the cache involves only a synchronous operation.","text_count":317,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another crucial detail to consider is the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"unleashing Zalgo"}]},{"block_type":"text","content":"anti-pattern (we have seen it in action in Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Essential Patterns"}]},{"block_type":"text","content":"). As we are dealing with asynchronous APIs, we must be sure to always return the cached value asynchronously, even if accessing the cache involves only a synchronous operation."}]},{"block_type":"element","block":"k5zy5cb6","search_text":"Caching requests in the total sales web server","text_count":46,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Caching requests in the total sales web server"}]},{"block_type":"element","block":"k5zy5cb7","search_text":"To demonstrate and measure the advantages of the asynchronous caching pattern, let's now apply what we've learned to the totalSales() API. As in the request-batching example, we have to create a proxy for the original API with the sole purpose of adding a caching layer.","text_count":270,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate and measure the advantages of the asynchronous caching pattern, let's now apply what we've learned to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"API. As in the request-batching example, we have to create a proxy for the original API with the sole purpose of adding a caching layer."}]},{"block_type":"element","block":"k5zy5cb8","search_text":"Let's then create a new module named totalSalesCache.js that contains the following code:","text_count":89,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's then create a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSalesCache.js"}]},{"block_type":"text","content":"that contains the following code:"}]},{"block_type":"element","block":"k5zy5cb9","search_text":"const totalSales = require('./totalSales'); const queues = {}; const cache = {}; module.exports = function totalSalesBatch(item, callback) { const cached = cache[item]; if (cached) { console.log('Cache hit'); return process.nextTick(callback.bind(null, null, cached)); } if (queues[item]) { console.log('Batching operation'); return queues[item].push(callback); } queues[item] = [callback]; totalSales(item, (err, res) => { if (!err) { cache[item] = res; setTimeout(() => { delete cache[item]; }, 30 * 1000); //30 seconds expiry } const queue = queues[item]; queues[item] = null; queue.forEach(cb => cb(err, res)); }); }; ","text_count":622,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const totalSales = require('./totalSales'); \n \nconst queues = {}; \nconst cache = {}; \n \nmodule.exports = function totalSalesBatch(item, callback) { \n  const cached = cache[item]; \n  if (cached) { \n    console.log('Cache hit'); \n    return process.nextTick(callback.bind(null, null, cached)); \n  } \n \n  if (queues[item]) { \n    console.log('Batching operation'); \n    return queues[item].push(callback); \n  } \n \n  queues[item] = [callback]; \n  totalSales(item, (err, res) =&gt; { \n    if (!err) { \n      cache[item] = res; \n      setTimeout(() =&gt; { \n        delete cache[item]; \n      }, 30 * 1000); //30 seconds expiry \n    } \n \n    const queue = queues[item]; \n    queues[item] = null; \n    queue.forEach(cb =&gt; cb(err, res)); \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5cba","search_text":"We should straight away see that the preceding code is in many parts identical to what we used for the asynchronous batching. In fact, the only differences are the following ones:","text_count":179,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We should straight away see that the preceding code is in many parts identical to what we used for the asynchronous batching. In fact, the only differences are the following ones:"}]},{"block_type":"element","block":"k5zy5cbb","search_text":"The first thing that we need to do when the API is invoked is to check whether the cache is set and if that's the case, we will immediately return the cached value using callback() , making sure to defer it with process.nextTick() . The execution continues in batching mode, but this time, when the original API successfully completes, we save the result into the cache. We also set a timeout to invalidate the cache after 30 seconds. A simple but effective technique! ","text_count":469,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The first thing that we need to do when the API is invoked is to check whether the cache is set and if that's the case, we will immediately return the cached value using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback()"}]},{"block_type":"text","content":", making sure to defer it with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.nextTick()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The execution continues in batching mode, but this time, when the original API successfully completes, we save the result into the cache. We also set a timeout to invalidate the cache after 30 seconds. A simple but effective technique!"}]}]},{"block_type":"element","block":"k5zy5cbc","search_text":"Now, we are ready to try the totalSales wrapper we just created; to do that, we only need to update the app.js module as follows:","text_count":129,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, we are ready to try the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales"}]},{"block_type":"text","content":"wrapper we just created; to do that, we only need to update the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module as follows:"}]},{"block_type":"element","block":"k5zy5cbd","search_text":"//const totalSales = require('./totalSales'); //const totalSales = require('./totalSalesBatch'); const totalSales = require('./totalSalesCache'); http.createServer(function(req, res) { // ... ","text_count":192,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//const totalSales = require('./totalSales'); \n//const totalSales = require('./totalSalesBatch'); \nconst totalSales = require('./totalSalesCache'); \n \nhttp.createServer(function(req, res) { \n  // ..."}]}]},{"block_type":"element","block":"k5zy5cbe","search_text":"Now, the server can be started again and profiled using the loadTest.js script as we did in the previous examples. With the default test parameters, we should see a 10% reduction in the execution time as compared to simple batching. Of course, this is highly dependent on a lot of factors; for example, the number of requests received, and the delay between one request and the other. The advantages of using caching over batching will be much more substantial when the amount of requests is higher and spans a longer period of time.","text_count":533,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, the server can be started again and profiled using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"loadTest.js"}]},{"block_type":"text","content":"script as we did in the previous examples. With the default test parameters, we should see a 10% reduction in the execution time as compared to simple batching. Of course, this is highly dependent on a lot of factors; for example, the number of requests received, and the delay between one request and the other. The advantages of using caching over batching will be much more substantial when the amount of requests is higher and spans a longer period of time."}]},{"block_type":"element","block":"k5zy5cbf","search_text":"Note Memoization is the practice of caching the result of a function invocation. In npm, you can find many packages to implement asynchronous memoization with little effort; one of the most complete packages is memoizee ( https://npmjs.org/package/memoizee ). ","text_count":260,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Memoization"}]},{"block_type":"text","content":"is the practice of caching the result of a function invocation. In npm, you can find many packages to implement asynchronous memoization with little effort; one of the most complete packages is memoizee ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/memoizee"},"children":[{"block_type":"text","content":"https://npmjs.org/package/memoizee"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5cbg","search_text":"Notes about implementing caching mechanisms","text_count":43,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Notes about implementing caching mechanisms"}]},{"block_type":"element","block":"k5zy5cbh","search_text":"We must remember that in real-life applications, we might want to use more advanced invalidation techniques and storage mechanisms. This might be necessary for the following reasons:","text_count":182,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We must remember that in real-life applications, we might want to use more advanced invalidation techniques and storage mechanisms. This might be necessary for the following reasons:"}]},{"block_type":"element","block":"k5zy5cbi","search_text":"A large amount of cached values might easily consume a lot of memory. In this case, a Least Recently Used ( LRU ) algorithm can be applied to maintain constant memory utilization. ","text_count":180,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A large amount of cached values might easily consume a lot of memory. In this case, a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Least Recently Used"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"LRU"}]},{"block_type":"text","content":") algorithm can be applied to maintain constant memory utilization."}]}]},{"block_type":"element","block":"k5zy5cbj","search_text":"When the application is distributed across multiple processes, using a simple variable for the cache might result in different results to be returned by each server instance. If that's undesired for the particular application we are implementing, the solution is to use a shared store for the cache. Popular solutions are Redis ( http://redis.io ) and Memcached ( http://memcached.org ). A manual cache invalidation, as opposed to a timed expiry, can enable a longer-living cache and at the same time provide more up-to-date data, but, of course, it would be a lot more complex to manage. ","text_count":589,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the application is distributed across multiple processes, using a simple variable for the cache might result in different results to be returned by each server instance. If that's undesired for the particular application we are implementing, the solution is to use a shared store for the cache. Popular solutions are Redis ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://redis.io"},"children":[{"block_type":"text","content":"http://redis.io"}]},{"block_type":"text","content":") and Memcached ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://memcached.org"},"children":[{"block_type":"text","content":"http://memcached.org"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A manual cache invalidation, as opposed to a timed expiry, can enable a longer-living cache and at the same time provide more up-to-date data, but, of course, it would be a lot more complex to manage."}]}]},{"block_type":"element","block":"k5zy5cbk","search_text":"Batching and caching with promises","text_count":34,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Batching and caching with promises"}]},{"block_type":"element","block":"k5zy5cbl","search_text":"In Chapter 4, Asynchronous Control Flow Patterns with ES2015 and Beyond , we saw how promises can greatly simplify our asynchronous code, but they offer an even more interesting application when dealing with batching and caching. If we recall what we said about promises, there are two properties that can be exploited to our advantage in this circumstance:","text_count":357,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Chapter 4,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with ES2015 and Beyond"}]},{"block_type":"text","content":", we saw how promises can greatly simplify our asynchronous code, but they offer an even more interesting application when dealing with batching and caching. If we recall what we said about promises, there are two properties that can be exploited to our advantage in this circumstance:"}]},{"block_type":"element","block":"k5zy5cbm","search_text":"Multiple then() listeners can be attached to the same promise. The then() listener is guaranteed to be invoked at most once, and it works even if it's attached after the promise is already resolved. Moreover, then() is guaranteed to be invoked asynchronously, always . ","text_count":269,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Multiple"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"listeners can be attached to the same promise."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"&nbsp;listener is guaranteed to be invoked at most once, and it works even if it's attached after the promise is already resolved. Moreover,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"is guaranteed to be invoked asynchronously,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"always"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cbn","search_text":"In short, the first property is exactly what we need for batching requests, while the second means that a promise is already a cache for the resolved value and offers a natural mechanism for returning a cached value in a consistent asynchronous way. In other words, this means that batching and caching are extremely simple and concise with promises.","text_count":350,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In short, the first property is exactly what we need for batching requests, while the second means that a promise is already a cache for the resolved value and offers a natural mechanism for returning a cached value in a consistent asynchronous way. In other words, this means that batching and caching are extremely simple and concise with promises."}]},{"block_type":"element","block":"k5zy5cbo","search_text":"To demonstrate this, we can try to create a wrapper for the totalSales() API, using promises, and see what it takes to add a batching and caching layer. Let's see then what this looks like. Let's create a new module named totalSalesPromises.js :","text_count":245,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To demonstrate this, we can try to create a wrapper for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"API, using promises, and see what it takes to add a batching and caching layer. Let's see then what this looks like. Let's create a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSalesPromises.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cbp","search_text":"const pify = require('pify'); // [1] const totalSales = pify(require('./totalSales')); const cache = {}; module.exports = function totalSalesPromises(item) { if (cache[item]) { // [2] return cache[item]; } cache[item] = totalSales(item) // [3] .then(res => { // [4] setTimeout(() => {delete cache[item]}, 30 * 1000); //30s expiry return res; }) .catch(err => { // [5] delete cache[item]; throw err; }); return cache[item]; // [6] }; ","text_count":433,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const pify = require('pify');                    // [1] \nconst totalSales = pify(require('./totalSales')); \n \nconst cache = {}; \nmodule.exports = function totalSalesPromises(item) { \n  if (cache[item]) {                            // [2] \n    return cache[item]; \n  } \n \n  cache[item] = totalSales(item)                // [3] \n    .then(res =&gt; {                              // [4] \n      setTimeout(() =&gt; {delete cache[item]}, 30 * 1000); //30s expiry \n      return res; \n    }) \n    .catch(err =&gt; {                             // [5] \n      delete cache[item]; \n      throw err; \n    }); \n  return cache[item];                           // [6] \n};"}]}]},{"block_type":"element","block":"k5zy5cbq","search_text":"The first thing that strikes us is the simplicity and elegance of the solution we implemented in the preceding code. Promises are indeed a great tool, but for this particular application they offer a huge, out-of-the-box advantage. This is what happens in the preceding code:","text_count":275,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first thing that strikes us is the simplicity and elegance of the solution we implemented in the preceding code. Promises are indeed a great tool, but for this particular application they offer a huge, out-of-the-box advantage. This is what happens in the preceding code:"}]},{"block_type":"element","block":"k5zy5cbr","search_text":"First, we require a small module called pify ( https://www.npmjs.com/package/pify ) that allows us to apply a promisification to the original totalSales() . After doing this, totalSales() will return a ES2015 promise instead of accepting a callback. When the totalSalesPromises() wrapper is invoked, we check whether a cached promise already exists for the given item type. If we already have such a promise, we return it back to the caller. If we don't have a promise in the cache for the given item type, we proceed to create one by invoking the original (promisified) totalSales() API. When the promise resolves, we set up a time to clear the cache (after 30 seconds) and we return res to propagate the result of the operation to any other then() listener attached to the promise. If the promise rejects with an error, we immediately reset the cache and throw the error again to propagate it to the promise chain, so any other listener attached to the same promise will receive the error as well. At last, we return the cached promise we just created. ","text_count":1055,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, we require a small module called pify ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.npmjs.com/package/pify"},"children":[{"block_type":"text","content":"https://www.npmjs.com/package/pify"}]},{"block_type":"text","content":") that allows us to apply a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"promisification"}]},{"block_type":"text","content":"to the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":". After doing this,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"will return a ES2015 promise instead of accepting a callback."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSalesPromises()"}]},{"block_type":"text","content":"wrapper is invoked, we check whether a cached promise already exists for the given"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"item"}]},{"block_type":"text","content":"type. If we already have such a promise, we return it back to the caller."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If we don't have a promise in the cache for the given"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"item"}]},{"block_type":"text","content":"type, we proceed to create one by invoking the original (promisified)"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"API."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the promise resolves, we set up a time to clear the cache (after 30 seconds) and we return"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"res"}]},{"block_type":"text","content":"to propagate the result of the operation to any other"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"then()"}]},{"block_type":"text","content":"listener attached to the promise."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If the promise rejects with an error, we immediately reset the cache and throw the error again to propagate it to the promise chain, so any other listener attached to the same promise will receive the error as well."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At last, we return the cached promise we just created."}]}]},{"block_type":"element","block":"k5zy5cbs","search_text":"Very simple and intuitive, and more importantly, we were able to achieve both batching and caching.","text_count":99,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Very simple and intuitive, and more importantly, we were able to achieve both batching and caching."}]},{"block_type":"element","block":"k5zy5cbt","search_text":"If we now want to try the totalSalesPromise() function, we will have to slightly adapt the app.js module as well, because now, the API is using promises instead of callbacks. Let's do it by creating a modified version of the app module named appPromises.js :","text_count":258,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we now want to try the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSalesPromise()"}]},{"block_type":"text","content":"function, we will have to slightly adapt the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module as well, because now, the API is using promises instead of callbacks. Let's do it by creating a modified version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"appPromises.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cbu","search_text":"const http = require('http'); const url = require('url'); const totalSales = require('./totalSalesPromises'); http.createServer(function(req, res) { const query = url.parse(req.url, true).query; totalSales(query.item).then(function(sum) { res.writeHead(200); res.end(`Total sales for item ${query.item} is ${sum}`); }); }).listen(8000, () => console.log('Started')); ","text_count":367,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst url = require('url'); \nconst totalSales = require('./totalSalesPromises'); \n \nhttp.createServer(function(req, res) { \n  const query = url.parse(req.url, true).query; \n  totalSales(query.item).then(function(sum) { \n    res.writeHead(200); \n    res.end(`Total sales for item ${query.item} is ${sum}`); \n  }); \n}).listen(8000, () =&gt; console.log('Started'));"}]}]},{"block_type":"element","block":"k5zy5cbv","search_text":"Its implementation is almost identical to the original app module, with the difference that now we use the promise-based version of the batching/caching wrapper; therefore, the way we invoke it is also slightly different.","text_count":221,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Its implementation is almost identical to the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module, with the difference that now we use the promise-based version of the batching/caching wrapper; therefore, the way we invoke it is also slightly different."}]},{"block_type":"element","block":"k5zy5cbw","search_text":"That's it! We are now ready to try this new version of the server by running the following command:","text_count":99,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's it! We are now ready to try this new version of the server by running the following command:"}]},{"block_type":"element","block":"k5zy5cbx","search_text":"node appPromises ","text_count":17,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node appPromises"}]}]},{"block_type":"element","block":"k5zy5cby","search_text":"Using the loadTest script, we can verify that the new implementation is working as expected. The execution time should be the same as when we tested the server using the totalSalesCache() API.","text_count":192,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"loadTest"}]},{"block_type":"text","content":"script, we can verify that the new implementation is working as expected. The execution time should be the same as when we tested the server using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSalesCache()"}]},{"block_type":"text","content":"API."}]},{"block_type":"element","block":"k5zy5cbz","search_text":"Running CPU-bound tasks","text_count":23,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Running CPU-bound tasks"}]},{"block_type":"element","block":"k5zy5cc0","search_text":"The totalSales() API, even though expensive in terms of resources, was not affecting the ability of the server to accept concurrent requests. What we learned about the event loop in Chapter 1, Welcome to the Node.js Platform , should provide an explanation for this behavior: invoking an asynchronous operation causes the stack to unwind back to the event loop, leaving it free to handle other requests.","text_count":403,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"totalSales()"}]},{"block_type":"text","content":"API, even though expensive in terms of resources, was not affecting the ability of the server to accept concurrent requests. What we learned about the event loop in Chapter 1,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Welcome to the Node.js Platform"}]},{"block_type":"text","content":", should provide an explanation for this behavior: invoking an asynchronous operation causes the stack to unwind back to the event loop, leaving it free to handle other requests."}]},{"block_type":"element","block":"k5zy5cc1","search_text":"However, what happens when we run a long, synchronous task that never gives back the control to the event loop? This kind of task is also known as CPU-bound, because its main characteristic is that it is heavy on CPU utilization rather than being heavy on I/O operations.","text_count":271,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, what happens when we run a long, synchronous task that never gives back the control to the event loop? This kind of task is also known as&nbsp;CPU-bound, because its main characteristic is that it is heavy on CPU utilization rather than being heavy on I/O operations."}]},{"block_type":"element","block":"k5zy5cc2","search_text":"Let's work immediately on an example to see how these types of task behave in Node.js.","text_count":86,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's work immediately on an example to see how these types of task behave in Node.js."}]},{"block_type":"element","block":"k5zy5cc3","search_text":"Solving the subset sum problem","text_count":30,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Solving the subset sum problem"}]},{"block_type":"element","block":"k5zy5cc4","search_text":"Let's now choose a computationally expensive problem to use as a base for our experiment. A good candidate is the subset sum problem that consists of deciding whether a set (or multiset) of integers contains a non-empty subset that has a sum equal to zero. For example, if we had as input the set [1, 2, -4, 5, -3], the subsets satisfying the problem are [1, 2, -3] and [2, -4, 5, -3].","text_count":385,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now choose a computationally expensive problem to use as a base for our experiment. A good candidate is the subset sum problem that consists of deciding whether a set (or multiset) of integers contains a non-empty subset that has a sum equal to zero. For example, if we had as input the set [1, 2, -4, 5, -3], the subsets satisfying the problem are [1, 2, -3] and [2, -4, 5, -3]."}]},{"block_type":"element","block":"k5zy5cc5","search_text":"The simplest algorithm is the one that checks every possible combination of subsets of any size, and it has a computational cost of O(2 n ) , or in other words, it grows exponentially with the size of the input. This means that a set of 20 integers would require up to 1,048,576 combinations to be checked, not bad for testing our assumptions. Of course, the solution might be found a lot sooner than that; so, to make things harder, we are going to consider the following variation of the subset sum problem: given a set of integers, we want to calculate all the possible combinations whose sum is equal to a given arbitrary integer.","text_count":634,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The simplest algorithm is the one that checks every possible combination of subsets of any size, and it has a computational cost of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"O(2"},{"block_type":"element","tag_name":"sup","attributes":{},"children":[{"block_type":"text","content":"n"}]},{"block_type":"text","content":")"}]},{"block_type":"text","content":", or in other words, it grows exponentially with the size of the input. This means that a set of 20 integers would require up to 1,048,576 combinations to be checked, not bad for testing our assumptions. Of course, the solution might be found a lot sooner than that; so, to make things harder, we are going to consider the following variation of the subset sum problem: given a set of integers, we want to calculate all the possible combinations whose sum is equal to a given arbitrary integer."}]},{"block_type":"element","block":"k5zy5cc6","search_text":"Let's then work to build such an algorithm; let's create a new module called subsetSum.js . We will start by creating a class called SubsetSum :","text_count":144,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's then work to build such an algorithm; let's create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSum.js"}]},{"block_type":"text","content":". We will start by creating a class called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cc7","search_text":"const EventEmitter = require('events').EventEmitter; class SubsetSum extends EventEmitter { constructor(sum, set) { super(); this.sum = sum; this.set = set; this.totalSubsets = 0; } //... ","text_count":188,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const EventEmitter = require('events').EventEmitter; \n \nclass SubsetSum extends EventEmitter { \n  constructor(sum, set) { \n    super(); \n    this.sum = sum; \n    this.set = set; \n    this.totalSubsets = 0; \n  } \n//..."}]}]},{"block_type":"element","block":"k5zy5cc8","search_text":"The SubsetSum class is extending from the EventEmitter class; this allows us to produce an event every time we find a new subset matching the sum received as input. As we will see, this will give us a lot of flexibility.","text_count":220,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"class is extending from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"class; this allows us to produce an event every time we find a new subset matching the sum received as input. As we will see, this will give us a lot of flexibility."}]},{"block_type":"element","block":"k5zy5cc9","search_text":"Next, let's see how we can generate all the possible combinations of subsets:","text_count":77,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, let's see how we can generate all the possible combinations of subsets:"}]},{"block_type":"element","block":"k5zy5cca","search_text":"_combine(set, subset) { for(let i = 0; i < set.length; i++) { let newSubset = subset.concat(set[i]); this._combine(set.slice(i + 1), newSubset); this._processSubset(newSubset); } } ","text_count":181,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"_combine(set, subset) { \n    for(let i = 0; i &lt; set.length; i++) { \n      let newSubset = subset.concat(set[i]); \n      this._combine(set.slice(i + 1), newSubset); \n      this._processSubset(newSubset); \n    } \n  }"}]}]},{"block_type":"element","block":"k5zy5ccb","search_text":"We will not go into too much detail about the algorithm, but there are two important things to notice:","text_count":102,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will not go into too much detail about the algorithm, but there are two important things to notice:"}]},{"block_type":"element","block":"k5zy5ccc","search_text":"The _combine() method is completely synchronous; it recursively generates every possible subset without ever giving back the control to the event loop. If we think about it, this is perfectly normal for an algorithm not requiring any I/O. Every time a new combination is generated, we provide it to the _processSubset() method for further processing. ","text_count":351,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combine()"}]},{"block_type":"text","content":"method is completely synchronous; it recursively generates every possible subset without ever giving back the control to the event loop. If we think about it, this is perfectly normal for an algorithm not requiring any I/O."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Every time a new combination is generated, we provide it to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_processSubset()"}]},{"block_type":"text","content":"method for further processing."}]}]},{"block_type":"element","block":"k5zy5ccd","search_text":"The _processSubset() method is responsible for verifying that the sum of the elements of the given subset is equal to the number we are looking for:","text_count":148,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_processSubset()"}]},{"block_type":"text","content":"method is responsible for verifying that the sum of the elements of the given subset is equal to the number we are looking for:"}]},{"block_type":"element","block":"k5zy5cce","search_text":"_processSubset(subset) { console.log('Subset', ++this.totalSubsets, subset); const res = subset.reduce((prev, item) => (prev + item), 0); if(res == this.sum) { this.emit('match', subset); } } ","text_count":192,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"_processSubset(subset) { \n    console.log('Subset', ++this.totalSubsets, subset); \n    const res = subset.reduce((prev, item) =&gt; (prev + item), 0); \n    if(res == this.sum) { \n      this.emit('match', subset); \n    } \n  }"}]}]},{"block_type":"element","block":"k5zy5ccf","search_text":"Trivially, the _processSubset() method applies a reduce operation to the subset in order to calculate the sum of its elements. Then, it emits an event of type 'match' when the resulting sum is equal to the one we are interested in finding ( this.sum ).","text_count":252,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Trivially, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_processSubset()"}]},{"block_type":"text","content":"method applies a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reduce"}]},{"block_type":"text","content":"operation to the subset in order to calculate the sum of its elements. Then, it emits an event of type"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"'match'"}]},{"block_type":"text","content":"when the resulting sum is equal to the one we are interested in finding ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"this.sum"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5ccg","search_text":"Finally, the start() method puts all the preceding pieces together:","text_count":67,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Finally, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"start()"}]},{"block_type":"text","content":"method puts all the preceding pieces together:"}]},{"block_type":"element","block":"k5zy5cch","search_text":"start() { this._combine(this.set, []); this.emit('end'); } ","text_count":59,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"start() { \n    this._combine(this.set, []); \n    this.emit('end'); \n  }"}]}]},{"block_type":"element","block":"k5zy5cci","search_text":"The preceding method triggers the generation of all the combinations by invoking _combine() , and lastly, emits an 'end' event signaling that all the combinations were checked and any possible match has already been emitted. This is possible because _combine() is synchronous; therefore, the 'end' event will be emitted as soon as the function returns, which means that all the combinations were calculated.","text_count":407,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding method triggers the generation of all the combinations by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combine()"}]},{"block_type":"text","content":", and lastly, emits an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"'end'"}]},{"block_type":"text","content":"event signaling that all the combinations were checked and any possible match has already been emitted. This is possible because"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combine()"}]},{"block_type":"text","content":"is synchronous; therefore, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"'end'"}]},{"block_type":"text","content":"event will be emitted as soon as the function returns, which means that all the combinations were calculated."}]},{"block_type":"element","block":"k5zy5ccj","search_text":"Next, we have to expose the algorithm we just created over the network, as always we can use a simple HTTP server for the task. In particular, we want to create an endpoint in the format /subsetSum?data=<Array>∑=<Integer> that invokes the SubsetSum algorithm with the given array of integers and sum to match.","text_count":309,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, we have to expose the algorithm we just created over the network, as always we can use a simple HTTP server for the task. In particular, we want to create an endpoint in the format"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/subsetSum?data=&lt;Array&gt;&sum=&lt;Integer&gt;"}]},{"block_type":"text","content":"&nbsp;that invokes the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"algorithm with the given array of integers and sum to match."}]},{"block_type":"element","block":"k5zy5cck","search_text":"Let's then implement this simple server in a module named app.js :","text_count":66,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's then implement this simple server in a module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5ccl","search_text":"const http = require('http'); const SubsetSum = require('./subsetSum'); http.createServer((req, res) => { const url = require('url').parse(req.url, true); if(url.pathname === '/subsetSum') { const data = JSON.parse(url.query.data); res.writeHead(200); const subsetSum = new SubsetSum(url.query.sum, data); subsetSum.on('match', match => { res.write('Match: ' + JSON.stringify(match) + '\\n'); }); subsetSum.on('end', () => res.end()); subsetSum.start(); } else { res.writeHead(200); res.end('I\\m alive!\\n'); } }).listen(8000, () => console.log('Started')); ","text_count":556,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst SubsetSum = require('./subsetSum'); \n \nhttp.createServer((req, res) =&gt; { \n  const url = require('url').parse(req.url, true); \n  if(url.pathname === '/subsetSum') { \n    const data = JSON.parse(url.query.data); \n    res.writeHead(200); \n    const subsetSum = new SubsetSum(url.query.sum, data); \n    subsetSum.on('match', match =&gt; { \n      res.write('Match: ' + JSON.stringify(match) + '\\n'); \n    }); \n    subsetSum.on('end', () =&gt; res.end()); \n    subsetSum.start(); \n  } else { \n    res.writeHead(200); \n    res.end('I\\m alive!\\n'); \n  } \n}).listen(8000, () =&gt; console.log('Started'));"}]}]},{"block_type":"element","block":"k5zy5ccm","search_text":"Thanks to the fact that the SubsetSum object returns its results using events, we can stream the matching subsets as soon as they are generated by the algorithm, in real time. Another detail to mention is that our server responds with the text I'm Alive! every time we hit a URL different from /subsetSum . We will use this for checking the responsiveness of our server, as we will see in a moment.","text_count":398,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Thanks to the fact that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"object returns its results using events, we can stream the matching subsets as soon as they are generated by the algorithm, in real time. Another detail to mention is that our server responds with the text"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"I'm Alive!"}]},{"block_type":"text","content":"every time we hit a URL different from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/subsetSum"}]},{"block_type":"text","content":". We will use this for checking the responsiveness of our server, as we will see in a moment."}]},{"block_type":"element","block":"k5zy5ccn","search_text":"We are now ready to try our subset sum algorithm. Curious to know how our server will handle it? Let's fire it up then:","text_count":119,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are now ready to try our subset sum algorithm. Curious to know how our server will handle it? Let's fire it up then:"}]},{"block_type":"element","block":"k5zy5cco","search_text":"node app ","text_count":9,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app"}]}]},{"block_type":"element","block":"k5zy5ccp","search_text":"As soon as the server starts, we are ready to send our first request; let's try with a set of 17 random numbers, which will result in the generation of 131,071 combinations, a nice amount to keep our server busy for a while:","text_count":224,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As soon as the server starts, we are ready to send our first request; let's try with a set of 17 random numbers, which will result in the generation of 131,071 combinations, a nice amount to keep our server busy for a while:"}]},{"block_type":"element","block":"k5zy5ccq","search_text":"curl -G http://localhost:8000/subsetSum --data-urlencode \"data=[116, 119,101,101,-116,109,101,-105,-102,117,-115,-97,119,-116,-104,-105,115]\" --data-urlencode \"sum=0\" ","text_count":167,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -G http://localhost:8000/subsetSum --data-urlencode \"data=[116, 119,101,101,-116,109,101,-105,-102,117,-115,-97,119,-116,-104,-105,115]\" --data-urlencode \"sum=0\""}]}]},{"block_type":"element","block":"k5zy5ccr","search_text":"We will start to see the results streaming live from the server, but if we try the following command in another terminal while the first request is still running, we will spot a huge problem:","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will start to see the results streaming live from the server, but if we try the following command in another terminal while the first request is still running, we will spot a huge problem:"}]},{"block_type":"element","block":"k5zy5ccs","search_text":"curl -G http://localhost:8000 ","text_count":30,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -G http://localhost:8000"}]}]},{"block_type":"element","block":"k5zy5cct","search_text":"We will immediately see that this last request hangs until the subset sum algorithm of the first request has finished; the server is unresponsive! This was kind of what we expected. The Node.js event loop runs in a single thread, and if this thread is blocked by a long synchronous computation, it will be unable to execute even one more cycle in order to respond with a simple I'm alive! We quickly understand that this behavior does not work for any kind of application meant to serve multiple requests . But don't despair in Node.js, we can tackle this type of situation in several ways. Let's analyze the two most important ones.","text_count":633,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will immediately see that this last request hangs until the subset sum algorithm of the first request has finished; the server is unresponsive! This was kind of what we expected. The Node.js event loop runs in a single thread, and if this thread is blocked by a long synchronous computation, it will be unable to execute even one more cycle in order to respond with a simple"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"I'm alive!"}]},{"block_type":"text","content":"We quickly understand that this behavior does not work for any kind of application meant to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"serve multiple requests"}]},{"block_type":"text","content":". But don't despair in Node.js, we can tackle this type of situation in several ways. Let's analyze the two most important ones."}]},{"block_type":"element","block":"k5zy5ccu","search_text":"Interleaving with setImmediate","text_count":30,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Interleaving with setImmediate"}]},{"block_type":"element","block":"k5zy5ccv","search_text":"Usually, a CPU-bound algorithm is built upon a set of steps. It can be a set of recursive invocations, a loop, or any variation/combination of those. So, a simple solution to our problem would be to give back the control to the event loop after each one of these steps completes (or after a certain number of them). This way, any pending I/O can still be processed by the event loop in those intervals where the long-running algorithm yields the CPU. A simple way to achieve this is to schedule the next step of the algorithm to run after any pending I/O requests. This sounds like the perfect use case for the setImmediate() function (we already introduced this API in Chapter 2, Node.js Essential Patterns ).","text_count":710,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Usually, a CPU-bound algorithm is built upon a set of steps. It can be a set of recursive invocations, a loop, or any variation/combination of those. So, a simple solution to our problem would be to give back the control to the event loop after each one of these steps completes (or after a certain number of them). This way, any pending I/O can still be processed by the event loop in those intervals where the long-running algorithm yields the CPU. A simple way to achieve this is to schedule the next step of the algorithm to run after any pending I/O requests. This sounds like the perfect use case for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":"function (we already introduced this API in Chapter 2,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Node.js Essential Patterns"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5ccw","search_text":"Note Pattern Interleave the execution of a long-running synchronous task with setImmediate() . ","text_count":95,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Interleave the execution of a long-running synchronous task with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5ccx","search_text":"Interleaving the steps of the subset sum algorithm","text_count":50,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Interleaving the steps of the subset sum algorithm"}]},{"block_type":"element","block":"k5zy5ccy","search_text":"Let's now see how this pattern applies to the subset sum algorithm. All we have to do is slightly modify the subsetSum.js module. For convenience, we are going to create a new module called subsetSumDefer.js , taking the code of the original subsetSum class as a starting point.","text_count":278,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now see how this pattern applies to the subset sum algorithm. All we have to do is slightly modify the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSum.js"}]},{"block_type":"text","content":"module. For convenience, we are going to create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSumDefer.js"}]},{"block_type":"text","content":", taking the code of the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSum"}]},{"block_type":"text","content":"class as a starting point."}]},{"block_type":"element","block":"k5zy5ccz","search_text":"The first change we are going to make is to add a new method called _combineInterleaved() , which is the core of the pattern we are implementing:","text_count":145,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first change we are going to make is to add a new method called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combineInterleaved()"}]},{"block_type":"text","content":", which is the core of the pattern we are implementing:"}]},{"block_type":"element","block":"k5zy5cd0","search_text":"_combineInterleaved(set, subset) { this.runningCombine++; setImmediate(() => { this._combine(set, subset); if(--this.runningCombine === 0) { this.emit('end'); } }); } ","text_count":167,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"_combineInterleaved(set, subset) { \n  this.runningCombine++; \n  setImmediate(() =&gt; { \n    this._combine(set, subset); \n    if(--this.runningCombine === 0) { \n      this.emit('end'); \n    } \n  }); \n}"}]}]},{"block_type":"element","block":"k5zy5cd1","search_text":"As we can see, all we had to do is defer the invocation of the original (synchronous) _combine() method with setImmediate() . However, now it becomes more difficult to know when the function has finished generating all the combinations because the algorithm is not synchronous anymore. To fix this, we have to keep track of all the running instances of the _combine() method using a pattern very similar to the asynchronous parallel execution we have seen in Chapter 3, Asynchronous Control Flow Patterns with Callbacks . When all the instances of the _combine() method have finished running, we can emit the end event notifying any listener that the process has completed.","text_count":673,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, all we had to do is defer the invocation of the original (synchronous)"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combine()"}]},{"block_type":"text","content":"method with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":". However, now it becomes more difficult to know when the function has finished generating all the combinations because the algorithm is not synchronous anymore. To fix this, we have to keep track of all the running instances of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combine()"}]},{"block_type":"text","content":"method using a pattern very similar to the asynchronous parallel execution we have seen in Chapter 3,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Asynchronous Control Flow Patterns with Callbacks"}]},{"block_type":"text","content":". When all the instances of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combine()"}]},{"block_type":"text","content":"method have finished running, we can emit the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end"}]},{"block_type":"text","content":"event notifying any listener that the process has completed."}]},{"block_type":"element","block":"k5zy5cd2","search_text":"To finalize the refactoring of the subset sum algorithm, we need a couple more tweaks. First, we need to replace the recursive step in the _combine() method with its deferred counterpart:","text_count":187,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To finalize the refactoring of the subset sum algorithm, we need a couple more tweaks. First, we need to replace the recursive step in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combine()"}]},{"block_type":"text","content":"method with its deferred counterpart:"}]},{"block_type":"element","block":"k5zy5cd3","search_text":"_combine(set, subset) { for(let i = 0; i < set.length; i++) { let newSubset = subset.concat(set[i]); this._combineInterleaved(set.slice(i + 1), newSubset); this._processSubset(newSubset); } } ","text_count":192,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"_combine(set, subset) { \n    for(let i = 0; i &lt; set.length; i++) { \n      let newSubset = subset.concat(set[i]); \n      this._combineInterleaved(set.slice(i + 1), newSubset); \n      this._processSubset(newSubset); \n    } \n  }"}]}]},{"block_type":"element","block":"k5zy5cd4","search_text":"With the preceding change, we make sure that each step of the algorithm will be queued in the event loop using setImmediate() and therefore executed after any pending I/O request instead of running synchronously.","text_count":212,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With the preceding change, we make sure that each step of the algorithm will be queued in the event loop using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":"and therefore executed after any pending I/O request instead of running synchronously."}]},{"block_type":"element","block":"k5zy5cd5","search_text":"The other small tweak is in the start() method:","text_count":47,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The other small tweak is in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"start()"}]},{"block_type":"text","content":"method:"}]},{"block_type":"element","block":"k5zy5cd6","search_text":"start() { this.runningCombine = 0; this._combineInterleaved(this.set, []); } ","text_count":77,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"start() { \n    this.runningCombine = 0; \n    this._combineInterleaved(this.set, []); \n  }"}]}]},{"block_type":"element","block":"k5zy5cd7","search_text":"In the preceding code, we initialize the number of running instances of the _combine() method to 0. We also replaced the call to _combine() with a call to _combineInterleaved() and removed the emission of the 'end' event, because now this is handled asynchronously in _combineInterleaved() .","text_count":291,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we initialize the number of running instances of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combine()"}]},{"block_type":"text","content":"method to 0. We also replaced the call to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combine()"}]},{"block_type":"text","content":"with a call to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combineInterleaved()"}]},{"block_type":"text","content":"and removed the emission of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"'end'"}]},{"block_type":"text","content":"event, because now this is handled asynchronously in"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"_combineInterleaved()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5cd8","search_text":"With this last change, our subset sum algorithm should now be able to run its CPU-bound code in steps interleaved by intervals where the event loop can run and process any other pending request.","text_count":194,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this last change, our subset sum algorithm should now be able to run its CPU-bound code in steps interleaved by intervals where the event loop can run and process any other pending request."}]},{"block_type":"element","block":"k5zy5cd9","search_text":"The last missing bit is updating the app.js module so that it can use the new version of the SubsetSum API. This is actually a trivial change:","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The last missing bit is updating the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module so that it can use the new version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"API. This is actually a trivial change:"}]},{"block_type":"element","block":"k5zy5cda","search_text":"const http = require('http'); //const SubsetSum = require('./subsetSum'); const SubsetSum = require('./subsetSumDefer'); http.createServer(function(req, res) { // ... ","text_count":167,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \n//const SubsetSum = require('./subsetSum'); \nconst SubsetSum = require('./subsetSumDefer'); \n \nhttp.createServer(function(req, res) { \n  // ..."}]}]},{"block_type":"element","block":"k5zy5cdb","search_text":"We are now ready to try this new version of the subset sum server. Let's start the app module by using the following command:","text_count":125,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are now ready to try this new version of the subset sum server. Let's start the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module by using the following command:"}]},{"block_type":"element","block":"k5zy5cdc","search_text":"node app ","text_count":9,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app"}]}]},{"block_type":"element","block":"k5zy5cdd","search_text":"Then, try to send a request again to calculate all the subsets matching a given sum:","text_count":84,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, try to send a request again to calculate all the subsets matching a given sum:"}]},{"block_type":"element","block":"k5zy5cde","search_text":"curl -G http://localhost:8000/subsetSum --data-urlencode \"data=[116, 119,101,101,-116,109,101,-105,-102,117,-115,-97,119,-116,-104,-105,115]\" --data-urlencode \"sum=0\" ","text_count":167,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -G http://localhost:8000/subsetSum --data-urlencode \"data=[116, 119,101,101,-116,109,101,-105,-102,117,-115,-97,119,-116,-104,-105,115]\" --data-urlencode \"sum=0\""}]}]},{"block_type":"element","block":"k5zy5cdf","search_text":"While the request is running, we might now want to see whether the server is responsive:","text_count":88,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"While the request is running, we might now want to see whether the server is responsive:"}]},{"block_type":"element","block":"k5zy5cdg","search_text":"curl -G http://localhost:8000 ","text_count":30,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -G http://localhost:8000"}]}]},{"block_type":"element","block":"k5zy5cdh","search_text":"Cool! The second request now should return immediately, even while a SubsetSum task is running, confirming that our pattern is working well.","text_count":140,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Cool! The second request now should return immediately, even while a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"task is running, confirming that our pattern is working well."}]},{"block_type":"element","block":"k5zy5cdi","search_text":"Considerations on the interleaving pattern","text_count":42,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Considerations on the interleaving pattern"}]},{"block_type":"element","block":"k5zy5cdj","search_text":"As we saw, running a CPU-bound task while preserving the responsiveness of an application is not that complicated, it just requires the use of setImmediate() to schedule the next step of an algorithm after any pending I/O. However, this is not the best pattern in terms of efficiency; in fact, deferring a task introduces a small overhead that, multiplied by all the steps that an algorithm has to run, can have a significant impact. This is usually the last thing we want when running a CPU-bound task, especially if we have to return the result directly to the user, which should happen in a reasonable amount of time. A possible solution to mitigate the problem would be using setImmediate() only after a certain number of steps—instead of using it at every single step—but still this would not solve the root of the problem.","text_count":828,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we saw, running a CPU-bound task while preserving the responsiveness of an application is not that complicated, it just requires the use of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":"to schedule the next step of an algorithm after any pending I/O. However, this is not the best pattern in terms of efficiency; in fact, deferring a task introduces a small overhead that, multiplied by all the steps that an algorithm has to run, can have a significant impact. This is usually the last thing we want when running a CPU-bound task, especially if we have to return the result directly to the user, which should happen in a reasonable amount of time. A possible solution to mitigate the problem would be using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":"only after a certain number of steps&mdash;instead of using it at every single step&mdash;but still this would not solve the root of the problem."}]},{"block_type":"element","block":"k5zy5cdk","search_text":"Bear in mind that this does not mean that the pattern we have just seen should be avoided at all costs, in fact, if we look at the bigger picture, a synchronous task does not necessarily have to be extremely long and complex to create troubles. In a busy server, even a task that blocks the event loop for 200 milliseconds can create undesirable delays. In those situations where the task is executed sporadically or in the background and does not have to run for too long, using setImmediate() to interleave its execution is probably the simplest and most effective way to avoid blocking the event loop.","text_count":604,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Bear in mind that this does not mean that the pattern we have just seen should be avoided at all costs, in fact, if we look at the bigger picture, a synchronous task does not necessarily have to be extremely long and complex to create troubles. In a busy server, even a task that blocks the event loop for 200 milliseconds can create undesirable delays. In those situations where the task is executed sporadically or in the background and does not have to run for too long, using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":"to interleave its execution is probably the simplest and most effective way to avoid blocking the event loop."}]},{"block_type":"element","block":"k5zy5cdl","search_text":"Note process.nextTick() cannot be used to interleave a long-running task. As we saw in Chapter 1, Welcome to the Node.js Platform nextTick() schedules an operation before any pending I/O, and this can eventually cause I/O starvation in the case of repeated calls. You can verify that by yourself by replacing setImmediate() with process.nextTick() in the previous sample. You might also want to know that this behavior was introduced with Node.js 0.10; in fact, with Node.js 0.8, process.nextTick() can still be used as an interleaving mechanism. Take a look at this GitHub issue to know more about the history and motivations of this change at https://github.com/joyent/node/issues/3335 . ","text_count":690,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.nextTick()"}]},{"block_type":"text","content":"cannot be used to interleave a long-running task. As we saw in Chapter 1,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"&nbsp;Welcome to the Node.js Platform"}]},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"nextTick()"}]},{"block_type":"text","content":"schedules an operation before any pending I/O, and this can eventually cause I/O starvation in the case of repeated calls. You can verify that by yourself by replacing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":"with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.nextTick()"}]},{"block_type":"text","content":"in the previous sample. You might also want to know that this behavior was introduced with Node.js 0.10; in fact, with Node.js 0.8,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.nextTick()"}]},{"block_type":"text","content":"can still be used as an interleaving mechanism. Take a look at this GitHub issue to know more about the history and motivations of this change at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/joyent/node/issues/3335"},"children":[{"block_type":"text","content":"https://github.com/joyent/node/issues/3335"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cdm","search_text":"Using multiple processes","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Using multiple processes"}]},{"block_type":"element","block":"k5zy5cdn","search_text":"Deferring the steps of an algorithm is not the only option we have for running CPU-bound tasks; another pattern for preventing the event loop from blocking is using child processes . We already know that Node.js gives its best when running I/O-intensive applications such as web servers, which allows us to optimize resource utilization thanks to its asynchronous architecture.","text_count":377,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Deferring the steps of an algorithm is not the only option we have for running CPU-bound tasks; another pattern for preventing the event loop from blocking is using"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"child processes"}]},{"block_type":"text","content":". We already know that Node.js gives its best when running I/O-intensive applications such as web servers, which allows us to optimize resource utilization thanks to its asynchronous architecture."}]},{"block_type":"element","block":"k5zy5cdo","search_text":"So, the best way we have to maintain the responsiveness of an application is to not run expensive CPU-bound tasks in the context of the main application and instead, use separate processes. This has three main advantages:","text_count":221,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So, the best way we have to maintain the responsiveness of an application is to not run expensive CPU-bound tasks in the context of the main application and instead, use separate processes. This has three main advantages:"}]},{"block_type":"element","block":"k5zy5cdp","search_text":"The synchronous task can run at full speed, without the need to interleave the steps of its execution Working with processes in Node.js is simple, probably easier than modifying an algorithm to use setImmediate() , and allows us to easily use multiple processors without the need to scale the main application itself If we really need maximum performance, the external process might be created in lower-level languages, such as good old C (always use the best tool for the job!) ","text_count":479,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The synchronous task can run at full speed, without the need to interleave the steps of its execution"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Working with processes in Node.js is simple, probably easier than modifying an algorithm to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"setImmediate()"}]},{"block_type":"text","content":", and allows us to easily"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"use multiple processors"}]},{"block_type":"text","content":"without the need to scale the main application itself"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If we really need maximum performance, the external process might be created in lower-level languages, such as good old C (always use the best tool for the job!)"}]}]},{"block_type":"element","block":"k5zy5cdq","search_text":"Node.js has an ample tool belt of APIs for interacting with external processes. We can find all we need in the child_process module. Moreover, when the external process is just another Node.js program, connecting it to the main application is extremely easy and we don't even feel like we are running something external to the local application. The magic happens thanks to the child_process.fork() function, which creates a new child Node.js process and also automatically creates a communication channel with it, allowing us to exchange information using an interface very similar to an EventEmitter . Let's see how this works by refactoring our subset sum server again.","text_count":672,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Node.js has an ample tool belt of APIs for interacting with external processes. We can find all we need in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process"}]},{"block_type":"text","content":"module. Moreover, when the external process is just another Node.js program, connecting it to the main application is extremely easy and we don't even feel like we are running something external to the local application. The magic happens thanks to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":"function, which creates a new child Node.js process and also automatically creates a communication channel with it, allowing us to exchange information using an interface very similar to an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":". Let's see how this works by refactoring our subset sum server again."}]},{"block_type":"element","block":"k5zy5cdr","search_text":"Delegating the subset sum task to other processes","text_count":49,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Delegating the subset sum task to other processes"}]},{"block_type":"element","block":"k5zy5cds","search_text":"The goal for the refactoring of the SubsetSum task is to create a separate child process responsible for handling the synchronous processing, leaving the event loop of the server free to handle requests coming from the network. This is the recipe we are going to follow to make this possible:","text_count":292,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The goal for the refactoring of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"task is to create a separate child process responsible for handling the synchronous processing, leaving the event loop of the server free to handle requests coming from the network. This is the recipe we are going to follow to make this possible:"}]},{"block_type":"element","block":"k5zy5cdt","search_text":"We will create a new module named processPool.js that will allow us to create a pool of running processes. Starting a new process is expensive and requires time, so keeping them constantly running and ready to handle requests allows us to save time and CPU. Also, the pool will help us limit the number of processes running at the same time to avoid exposing the application to denial-of-service ( DoS ) attacks. Next, we will create a module called subsetSumFork.js responsible for abstracting a SubsetSum task running in a child process. Its role will be communicating with the child process and exposing the results of the task as if they were coming from the current application. At last, we need a worker (our child process), a new Node.js program with the only goal of running the subset sum algorithm and forwarding its results to the parent process. ","text_count":858,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We will create a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"processPool.js"}]},{"block_type":"text","content":"that will allow us to create a pool of running processes. Starting a new process is expensive and requires time, so keeping them constantly running and ready to handle requests allows us to save time and CPU. Also, the pool will help us limit the number of processes running at the same time to avoid exposing the application to"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"denial-of-service"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"DoS"}]},{"block_type":"text","content":") attacks."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Next, we will create a module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSumFork.js"}]},{"block_type":"text","content":"&nbsp;responsible for abstracting a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"task running in a child process. Its role will be communicating with the child process and exposing the results of the task as if they were coming from the current application."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At last, we need a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"worker"}]},{"block_type":"text","content":"(our child process), a new Node.js program with the only goal of running the subset sum algorithm and forwarding its results to the parent process."}]}]},{"block_type":"element","block":"k5zy5cdu","search_text":"Note A DoS attack is an attempt to make a machine or network resource unavailable to its intended users, such as to temporarily or indefinitely interrupt or suspend services of a host connected to the Internet. ","text_count":211,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A DoS attack is an attempt to make a machine or network resource unavailable to its intended users, such as to temporarily or indefinitely interrupt or suspend services of a host connected to the Internet."}]}]},{"block_type":"element","block":"k5zy5cdv","search_text":"Implementing a process pool","text_count":27,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing a process pool"}]},{"block_type":"element","block":"k5zy5cdw","search_text":"Let's start by building the processPool.js module piece by piece:","text_count":65,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start by building the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"processPool.js"}]},{"block_type":"text","content":"module piece by piece:"}]},{"block_type":"element","block":"k5zy5cdx","search_text":"const fork = require('child_process').fork; class ProcessPool { constructor(file, poolMax) { this.file = file; this.poolMax = poolMax; this.pool = []; this.active = []; this.waiting = []; } //... ","text_count":196,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const fork = require('child_process').fork; \n \nclass ProcessPool { \n  constructor(file, poolMax) { \n    this.file = file; \n    this.poolMax = poolMax; \n    this.pool = []; \n    this.active = []; \n    this.waiting = []; \n  } \n  //..."}]}]},{"block_type":"element","block":"k5zy5cdy","search_text":"In the first part of the module, we import the child_process.fork() function that we will use to create new processes. Then, we define the ProcessPool constructor that accepts a file parameter representing the Node.js program to run and the maximum number of running instances in the pool ( poolMax ). We then define three instance variables:","text_count":342,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the first part of the module, we import the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":"function that we will use to create new processes. Then, we define the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ProcessPool"}]},{"block_type":"text","content":"constructor that accepts a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"file"}]},{"block_type":"text","content":"&nbsp;parameter representing the Node.js program to run and the maximum number of running instances in the pool ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"poolMax"}]},{"block_type":"text","content":"). We then define three instance variables:"}]},{"block_type":"element","block":"k5zy5cdz","search_text":"pool is the set of running processes ready to be used active contains the list of the processes currently being used waiting contains a queue of callbacks for all those requests that could not be fulfilled immediately because of the lack of an available process ","text_count":262,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pool"}]},{"block_type":"text","content":"is the set of running processes ready to be used"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"active"}]},{"block_type":"text","content":"contains the list of the processes currently being used"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"waiting"}]},{"block_type":"text","content":"contains a queue of callbacks for all those requests that could not be fulfilled immediately because of the lack of an available process"}]}]},{"block_type":"element","block":"k5zy5ce0","search_text":"The next piece of the ProcessPool class is the acquire() method, which is responsible for returning a process ready to be used:","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next piece of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ProcessPool"}]},{"block_type":"text","content":"class is the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"acquire()"}]},{"block_type":"text","content":"method, which is responsible for returning a process ready to be used:"}]},{"block_type":"element","block":"k5zy5ce1","search_text":"acquire(callback) { let worker; if(this.pool.length > 0) { // [1] worker = this.pool.pop(); this.active.push(worker); return process.nextTick(callback.bind(null, null, worker)); } if(this.active.length >= this.poolMax) { // [2] return this.waiting.push(callback); } worker = fork(this.file); // [3] this.active.push(worker); process.nextTick(callback.bind(null, null, worker)); } ","text_count":380,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"acquire(callback) { \n  let worker; \n  if(this.pool.length &gt; 0) {                // [1] \n    worker = this.pool.pop(); \n    this.active.push(worker); \n    return process.nextTick(callback.bind(null, null, worker)); \n  } \n \n  if(this.active.length &gt;= this.poolMax) {  // [2] \n    return this.waiting.push(callback); \n  } \n \n  worker = fork(this.file);                 // [3] \n  this.active.push(worker); \n  process.nextTick(callback.bind(null, null, worker)); \n}"}]}]},{"block_type":"element","block":"k5zy5ce2","search_text":"Its logic is very simple and is explained as follows:","text_count":53,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Its logic is very simple and is explained as follows:"}]},{"block_type":"element","block":"k5zy5ce3","search_text":"If we have a process in pool ready to be used, we simply move it to the active list and then return it by invoking callback (in a deferred fashion... remember Zalgo?). If there are no available processes in pool and we already have reached the maximum number of running processes, we have to wait for one to be available. We achieve this by queuing the current callback in the waiting list. If we haven't yet reached the maximum number of running processes, we will create a new one using child_process.fork() , add it to the active list, and then return it to the caller using the callback . ","text_count":593,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If we have a process in"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pool"}]},{"block_type":"text","content":"ready to be used, we simply move it to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"active"}]},{"block_type":"text","content":"list and then return it by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"(in a deferred fashion... remember Zalgo?)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If there are no available processes in"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pool"}]},{"block_type":"text","content":"and we already have reached the maximum number of running processes, we have to wait for one to be available. We achieve this by queuing the current callback in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"waiting"}]},{"block_type":"text","content":"list."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If we haven't yet reached the maximum number of running processes, we will create a new one using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":", add it to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"active"}]},{"block_type":"text","content":"list, and then return it to the caller using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5ce4","search_text":"The last method of the ProcessPool class is release() , whose purpose is to put a process back in pool :","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The last method of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ProcessPool"}]},{"block_type":"text","content":"class is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"release()"}]},{"block_type":"text","content":", whose purpose is to put a process back in&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pool"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5ce5","search_text":"release(worker) { if(this.waiting.length > 0) { // [1] const waitingCallback = this.waiting.shift(); waitingCallback(null, worker); } this.active = this.active.filter(w => worker !== w); // [2] this.pool.push(worker); } ","text_count":220,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"release(worker) { \n    if(this.waiting.length &gt; 0) {                          // [1] \n      const waitingCallback = this.waiting.shift(); \n      waitingCallback(null, worker); \n    } \n    this.active = this.active.filter(w =&gt; worker !==  w);  // [2] \n    this.pool.push(worker); \n  }"}]}]},{"block_type":"element","block":"k5zy5ce6","search_text":"The preceding code is also very simple and its explanation is as follows:","text_count":73,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code is also very simple and its explanation is as follows:"}]},{"block_type":"element","block":"k5zy5ce7","search_text":"If there is a request in the waiting list, we simply reassign the worker being released by passing it to the callback at the head of the waiting queue. Otherwise, we remove the worker from the active list and put it back into pool . ","text_count":233,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If there is a request in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"waiting"}]},{"block_type":"text","content":"list, we simply reassign the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"worker"}]},{"block_type":"text","content":"being released by passing it to the callback at the head of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"waiting"}]},{"block_type":"text","content":"queue."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Otherwise, we remove the worker from the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"active"}]},{"block_type":"text","content":"list and put it back into"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pool"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5ce8","search_text":"As we can see, the processes are never stopped but just reassigned, allowing us to save time by not restarting them at each request. However, it's important to observe that this might not always be the best choice and this greatly depends on the requirements of our application. Possible tweaks for reducing long-term memory usage and adding robustness to our process pool are as follows:","text_count":388,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, the processes are never stopped but just reassigned, allowing us to save time by not restarting them at each request. However, it's important to observe that this might not always be the best choice and this greatly depends on the requirements of our application. Possible tweaks for reducing long-term memory usage and adding robustness to our process pool are as follows:"}]},{"block_type":"element","block":"k5zy5ce9","search_text":"Terminate idle processes to free memory after a certain time of inactivity Add a mechanism to kill non-responsive processes or restart those that have simply crashed ","text_count":166,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Terminate idle processes to free memory after a certain time of inactivity"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Add a mechanism to kill non-responsive processes or restart those that have simply crashed"}]}]},{"block_type":"element","block":"k5zy5cea","search_text":"But in this example, we will keep the implementation of our process pool simple, as the details we might want to add are really endless.","text_count":136,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But in this example, we will keep the implementation of our process pool simple, as the details we might want to add are really endless."}]},{"block_type":"element","block":"k5zy5ceb","search_text":"Communicating with a child process","text_count":34,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Communicating with a child process"}]},{"block_type":"element","block":"k5zy5cec","search_text":"Now that our ProcessPool class is ready, we can use it to implement the SubsetSumFork wrapper whose role is to communicate with the worker and expose the results it produces. As we said, starting a process with child_process.fork() also gives us a simple message-based communication channel, so let's see how this works by implementing the subsetSumFork.js module:","text_count":364,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now that our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ProcessPool"}]},{"block_type":"text","content":"class is ready, we can use it to implement the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSumFork"}]},{"block_type":"text","content":"wrapper whose role is to communicate with the worker and expose the results it produces. As we said, starting a process with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":"also gives us a simple message-based communication channel, so let's see how this works by implementing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSumFork.js"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5ced","search_text":"const EventEmitter = require('events').EventEmitter; const ProcessPool = require('./processPool'); const workers = new ProcessPool(__dirname + '/subsetSumWorker.js', 2); class SubsetSumFork extends EventEmitter { constructor(sum, set) { super(); this.sum = sum; this.set = set; } start() { workers.acquire((err, worker) => { // [1] worker.send({sum: this.sum, set: this.set}); const onMessage = msg => { if (msg.event === 'end') { // [3] worker.removeListener('message', onMessage); workers.release(worker); } this.emit(msg.event, msg.data); // [4] }; worker.on('message', onMessage); // [2] }); } } module.exports = SubsetSumFork; ","text_count":632,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const EventEmitter = require('events').EventEmitter; \nconst ProcessPool = require('./processPool'); \nconst workers = new ProcessPool(__dirname + '/subsetSumWorker.js', 2); \n \nclass SubsetSumFork extends EventEmitter { \n  constructor(sum, set) { \n    super(); \n    this.sum = sum; \n    this.set = set; \n  } \n \n  start() { \n    workers.acquire((err, worker) =&gt; {               // [1] \n      worker.send({sum: this.sum, set: this.set}); \n \n      const onMessage = msg =&gt; { \n        if (msg.event === 'end') {                   // [3] \n          worker.removeListener('message', onMessage); \n          workers.release(worker); \n        } \n \n        this.emit(msg.event, msg.data);             // [4] \n      }; \n \n      worker.on('message', onMessage);             // [2] \n    }); \n  } \n} \nmodule.exports = SubsetSumFork;"}]}]},{"block_type":"element","block":"k5zy5cee","search_text":"The first thing to notice is that we initialized a ProcessPool object using a file named subsetSumWorker.js as the target which represents our child worker. We also set the maximum capacity of the pool to 2 .","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first thing to notice is that we initialized a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ProcessPool"}]},{"block_type":"text","content":"object using a file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSumWorker.js"}]},{"block_type":"text","content":"as the target which represents our child worker. We also set the maximum capacity of the pool to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"2"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5cef","search_text":"Another point worth mentioning is that we tried to maintain the same public API of the original SubsetSum class. In fact, SubsetSumFork is an EventEmitter whose constructor accepts sum and set , while the start() method triggers the execution of the algorithm, which runs on a separate process this time. This is what happens when the start() method is invoked:","text_count":361,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another point worth mentioning is that we tried to maintain the same public API of the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"class. In fact,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSumFork"}]},{"block_type":"text","content":"is an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"EventEmitter"}]},{"block_type":"text","content":"whose constructor accepts&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sum"}]},{"block_type":"text","content":"and&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"set"}]},{"block_type":"text","content":", while the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"start()"}]},{"block_type":"text","content":"method triggers the execution of the algorithm, which runs on a separate process this time. This is what happens when the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"start()"}]},{"block_type":"text","content":"method is invoked:"}]},{"block_type":"element","block":"k5zy5ceg","search_text":"We try to acquire a new child process from the pool. When this happens, we immediately use the worker handle to send the child process a message with the input of the job to run. The send() API is provided automatically by Node.js to all processes that start with child_process.fork() , this is essentially the communication channel that we were talking about. We then start listening for any message returned from the worker process, using the on() method to attach a new listener (this is also a part of the communication channel provided by all processes that start with child_process.fork() ). In the listener, we first check whether we received an end event, which means that the SubsetSum task has finished, in which case we remove the onMessage listener and release the worker , putting it back into the pool. The worker produces messages in the format {event, data} allowing us to seamlessly re-emit any event produced by the child process. ","text_count":949,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We try to acquire a new child process from the pool. When this happens, we immediately use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"worker"}]},{"block_type":"text","content":"handle to send the child process a message with the input of the job to run. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"send()"}]},{"block_type":"text","content":"API is provided automatically by Node.js to all processes that start with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":", this is essentially the communication channel that we were talking about."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We then start listening for any message returned from the worker process, using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"on()"}]},{"block_type":"text","content":"method to attach a new listener (this is also a part of the communication channel provided by all processes that start with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In the listener, we first check whether we received an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end"}]},{"block_type":"text","content":"event, which means that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"task has finished, in which case we remove the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"onMessage"}]},{"block_type":"text","content":"listener and release the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"worker"}]},{"block_type":"text","content":", putting it back into the pool."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The worker produces messages in the format"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{event, data}"}]},{"block_type":"text","content":"allowing us to seamlessly re-emit any event produced by the child process."}]}]},{"block_type":"element","block":"k5zy5ceh","search_text":"That's it for the SubsetSumFork wrapper; let's now implement the worker application.","text_count":84,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's it for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSumFork"}]},{"block_type":"text","content":"wrapper; let's now implement the worker application."}]},{"block_type":"element","block":"k5zy5cei","search_text":"Note It is good to know that the send() method available on a child process instance can also be used to propagate a socket handle from the main application to a child process (look at the documentation at: http://nodejs.org/api/child_process.html#child_process_child_send_message_sendhandle ). This is actually the technique used by the cluster module to distribute the load of an HTTP server across multiple processes (as of Node.js 0.10). We will see this in more detail in the next chapter. ","text_count":495,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is good to know that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"send()"}]},{"block_type":"text","content":"method available on a child process instance can also be used to propagate a socket handle from the main application to a child process (look at the documentation at:&nbsp;"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nodejs.org/api/child_process.html#child_process_child_send_message_sendhandle"},"children":[{"block_type":"text","content":"http://nodejs.org/api/child_process.html#child_process_child_send_message_sendhandle"}]},{"block_type":"text","content":"). This is actually the technique used by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module to distribute the load of an HTTP server across multiple processes (as of Node.js 0.10). We will see this in more detail in the next chapter."}]}]},{"block_type":"element","block":"k5zy5cej","search_text":"Communicating with the parent process","text_count":37,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Communicating with the parent process"}]},{"block_type":"element","block":"k5zy5cek","search_text":"Let's now create the subsetSumWorker.js module, our worker application, the entire content of this module will run in a separate process:","text_count":137,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now create the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSumWorker.js"}]},{"block_type":"text","content":"module, our worker application, the entire content of this module will run in a separate process:"}]},{"block_type":"element","block":"k5zy5cel","search_text":"const SubsetSum = require('./subsetSum'); process.on('message', msg => { // [1] const subsetSum = new SubsetSum(msg.sum, msg.set); subsetSum.on('match', data => { // [2] process.send({event: 'match', data: data}); }); subsetSum.on('end', data => { process.send({event: 'end', data: data}); }); subsetSum.start(); }); ","text_count":317,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const SubsetSum = require('./subsetSum'); \n \nprocess.on('message', msg =&gt; {                   // [1] \n  const subsetSum = new SubsetSum(msg.sum, msg.set); \n \n  subsetSum.on('match', data =&gt; {                // [2] \n    process.send({event: 'match', data: data}); \n  }); \n \n  subsetSum.on('end', data =&gt; { \n    process.send({event: 'end', data: data}); \n  }); \n \n  subsetSum.start(); \n});"}]}]},{"block_type":"element","block":"k5zy5cem","search_text":"We can immediately see that we are reusing the original (and synchronous) SubsetSum as it is. Now that we are in a separate process, we don't have to worry about blocking the event loop anymore, all the HTTP requests will continue to be handled by the event loop of the main application, without disruptions.","text_count":308,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can immediately see that we are reusing the original (and synchronous)"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"as it is. Now that we are in a separate process, we don't have to worry about blocking the event loop anymore, all the HTTP requests will continue to be handled by the event loop of the main application, without disruptions."}]},{"block_type":"element","block":"k5zy5cen","search_text":"When the worker is started as a child process, this is what happens:","text_count":68,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When the worker is started as a child process, this is what happens:"}]},{"block_type":"element","block":"k5zy5ceo","search_text":"It immediately starts listening for messages coming from the parent process. This can be easily done with the process.on() function (also, a part of the communication API provided when the process starts using child_process.fork() ). The only message we expect from the parent process is the one providing the input to a new SubsetSum task. As soon as such a message is received, we create a new instance of a SubsetSum class and register the listeners for the match and end events. Lastly, we start the computation with subsetSum.start() . Every time an event is received from the running algorithm, we wrap it in an object with the format, {event, data} , and send it to the parent process. These messages are then handled in the subsetSumFork.js module, as we have seen in the previous section. ","text_count":798,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"It immediately starts listening for messages coming from the parent process. This can be easily done with the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.on()"}]},{"block_type":"text","content":"function (also, a part of the communication API provided when the process starts using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":"). The only message we expect from the parent process is the one providing the input to a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"task. As soon as such a message is received, we create a new instance of a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SubsetSum"}]},{"block_type":"text","content":"class and register the listeners for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"match"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"end"}]},{"block_type":"text","content":"events. Lastly, we start the computation with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSum.start()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Every time an event is received from the running algorithm, we wrap it in an object with the format,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{event, data}"}]},{"block_type":"text","content":", and send it to the parent process. These messages are then handled in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSumFork.js"}]},{"block_type":"text","content":"module, as we have seen in the previous section."}]}]},{"block_type":"element","block":"k5zy5cep","search_text":"As we can see, we just had to wrap the algorithm we already built, without modifying its internals. This clearly shows that any portion of an application can be easily put in an external process by simply using the pattern we have just seen.","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, we just had to wrap the algorithm we already built, without modifying its internals. This clearly shows that any portion of an application can be easily put in an external process by simply using the pattern we have just seen."}]},{"block_type":"element","block":"k5zy5ceq","search_text":"Tip When the child process is not a Node.js program, the simple communication channel we just described is not available. In these situations, we can still establish an interface with the child process by implementing our own protocol on top of the standard input and standard output streams, which are exposed to the parent process. To find out more about all the capabilities of the child_process API, you can refer to the official Node.js documentation at http://nodejs.org/api/child_process.html . ","text_count":502,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When the child process is not a Node.js program, the simple communication channel we just described is not available. In these situations, we can still establish an interface with the child process by implementing our own protocol on top of the standard input and standard output streams, which are exposed to the parent process."}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To find out more about all the capabilities of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process"}]},{"block_type":"text","content":"API, you can refer to the official Node.js documentation at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nodejs.org/api/child_process.html"},"children":[{"block_type":"text","content":"http://nodejs.org/api/child_process.html"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cer","search_text":"Considerations on the multiprocess pattern","text_count":42,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Considerations on the multiprocess pattern"}]},{"block_type":"element","block":"k5zy5ces","search_text":"As always, to try this new version of the subset sum algorithm, we simply have to replace the module used by the HTTP server (file app.js ):","text_count":140,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As always, to try this new version of the subset sum algorithm, we simply have to replace the module used by the HTTP server (file"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5cet","search_text":"const http = require('http'); //const SubsetSum = require('./subsetSum'); //const SubsetSum = require('./subsetSumDefer'); const SubsetSum = require('./subsetSumFork'); //... ","text_count":175,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \n//const SubsetSum = require('./subsetSum'); \n//const SubsetSum = require('./subsetSumDefer'); \nconst SubsetSum = require('./subsetSumFork'); \n//..."}]}]},{"block_type":"element","block":"k5zy5ceu","search_text":"We can now start the server again and try to send a sample request:","text_count":67,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now start the server again and try to send a sample request:"}]},{"block_type":"element","block":"k5zy5cev","search_text":"curl -G http://localhost:8000/subsetSum --data-urlencode \"data=[116,119,101,101,-116,109,101,-105,-102,117,-115,-97,119,-116,-104,-105,115]\" --data-urlencode \"sum=0\" ","text_count":166,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -G http://localhost:8000/subsetSum --data-urlencode \"data=[116,119,101,101,-116,109,101,-105,-102,117,-115,-97,119,-116,-104,-105,115]\" --data-urlencode \"sum=0\""}]}]},{"block_type":"element","block":"k5zy5cew","search_text":"Similar to the interleaving pattern we have seen before, with this new version of the subsetSum module the event loop is not blocked while running the CPU-bound task. This can be confirmed by sending another concurrent request as follows:","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Similar to the interleaving pattern we have seen before, with this new version of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSum"}]},{"block_type":"text","content":"module the event loop is not blocked while running the CPU-bound task. This can be confirmed by sending another concurrent request as follows:"}]},{"block_type":"element","block":"k5zy5cex","search_text":"curl -G http://localhost:8000 ","text_count":30,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl -G http://localhost:8000"}]}]},{"block_type":"element","block":"k5zy5cey","search_text":"The preceding command line should immediately return a string as follows:","text_count":73,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding command line should immediately return a string as follows:"}]},{"block_type":"element","block":"k5zy5cez","search_text":"I'm alive! ","text_count":11,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"I'm alive!"}]}]},{"block_type":"element","block":"k5zy5cf0","search_text":"More interestingly, we can also try to start two subsetSum tasks concurrently, we can see that they will use the full power of two different processors in order to run (if our system has more than one processor, of course). Instead, if we try to run three subsetSum tasks concurrently, the result should be that the last one to start will hang. This is not because the event loop of the main process is blocked, but because we set a concurrency limit of two processes for the subsetSum task, which means that the third request will be handled as soon as at least one of the two processes in the pool becomes available again.","text_count":624,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"More interestingly, we can also try to start two"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSum"}]},{"block_type":"text","content":"tasks concurrently, we can see that they will use the full power of two different processors in order to run (if our system has more than one processor, of course). Instead, if we try to run three"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSum"}]},{"block_type":"text","content":"tasks concurrently, the result should be that the last one to start will hang. This is not because the event loop of the main process is blocked, but because we set a concurrency limit of two processes for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"subsetSum"}]},{"block_type":"text","content":"task, which means that the third request will be handled as soon as at least one of the two processes in the pool becomes available again."}]},{"block_type":"element","block":"k5zy5cf1","search_text":"As we saw, the multiprocess pattern is definitely more powerful and flexible than the interleaving pattern; however, it's still not scalable as the amount of resources offered by a single machine is still a hard limit. The answer in this case is to distribute the load across multiple machines, but this is another story and falls under the category of distributed architectural patterns which we will explore in the next chapters.","text_count":431,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we saw, the multiprocess pattern is definitely more powerful and flexible than the interleaving pattern; however, it's still not scalable as the amount of resources offered by a single machine is still a hard limit. The answer in this case is to distribute the load across multiple machines, but this is another story and falls under the category of distributed architectural patterns which we will explore in the next chapters."}]},{"block_type":"element","block":"k5zy5cf2","search_text":"Tip It is worth mentioning that threads can be a possible alternative to processes when running CPU-bound tasks. Currently, there are a few npm packages that expose an API for working with threads to userland modules; one of the most popular is webworker-threads ( https://npmjs.org/package/webworker-threads ). However, even if threads are more lightweight, fully-fledged processes can offer more flexibility and a better level of isolation in the case of problems such as freezing or crashing. ","text_count":496,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is worth mentioning that threads can be a possible alternative to processes when running CPU-bound tasks. Currently, there are a few npm packages that expose an API for working with threads to userland modules; one of the most popular is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"webworker-threads"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/webworker-threads"},"children":[{"block_type":"text","content":"https://npmjs.org/package/webworker-threads"}]},{"block_type":"text","content":"). However, even if threads are more lightweight, fully-fledged processes can offer more flexibility and a better level of isolation in the case of problems such as freezing or crashing."}]}]},{"block_type":"element","block":"k5zy5cf3","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5cf4","search_text":"This chapter added some great new weapons to our tool belt, and as we can see, our journey is getting more focused on specific problems and we have started to delve deeply into more advanced solutions. Often, we reused some of the patterns we have analyzed in the previous chapters: State, Command, and Proxy to provide an effective abstraction for asynchronously initialized modules, asynchronous control flow patterns to add batching and caching to our APIs, deferred execution and events to help us run CPU-bound tasks.","text_count":522,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This chapter added some great new weapons to our tool belt, and as we can see, our journey is getting more focused on specific problems and we have started to delve deeply into more advanced solutions. Often, we reused some of the patterns we have analyzed in the previous chapters: State, Command, and Proxy to provide an effective abstraction for asynchronously initialized modules, asynchronous control flow patterns to add batching and caching to our APIs, deferred execution and events to help us run CPU-bound tasks."}]},{"block_type":"element","block":"k5zy5cf5","search_text":"This chapter gave us not only a set of recipes to reuse and customize for our needs, but also some great demonstrations of how mastering a few principles and patterns can help us tackle the most complex problems in Node.js development.","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This chapter gave us not only a set of recipes to reuse and customize for our needs, but also some great demonstrations of how mastering a few principles and patterns can help us tackle the most complex problems in Node.js development."}]},{"block_type":"element","block":"k5zy5cf6","search_text":"The next two chapters represent the peak of our journey. After studying the various tactics, we are now ready to move to the strategies, and explore the patterns for scaling and distributing our Node.js applications.","text_count":216,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next two chapters represent the peak of our journey. After studying the various tactics, we are now ready to move to the strategies, and explore the patterns for scaling and distributing our Node.js applications."}]}]},{"title":"Scalability and Architectural Patterns","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4mut","number":10,"contents":[{"block_type":"element","block":"k5zy5cf7","search_text":"In its early days, Node.js was mainly a non-blocking web server; its original name was in fact web.js . Its creator, Ryan Dahl , soon realized the potential of the platform and started extending it with tools to enable the creation of any type of server-side application on top of the duo JavaScript/non-blocking paradigm. The characteristics of Node.js were perfect for the implementation of distributed systems, made of nodes orchestrating their operations through the network. Node.js was born to be distributed. Unlike other web platforms, the word scalability enters the vocabulary of a Node.js developer very early in the life of an application, mainly because of its single-threaded nature, incapable of exploiting all the resources of a machine, but often there are more profound reasons. As we will see in this chapter, scaling an application does not only mean increasing its capacity, enabling it to handle more requests faster; it's also a crucial path to achieving high availability and tolerance to errors. Amazingly, it can also be a way to split the complexity of an application into more manageable pieces. Scalability is a concept with multiple faces, six to be precise, as many as the faces of a cube—the scale cube .","text_count":1236,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In its early days, Node.js was mainly a non-blocking web server; its original name was in fact"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"web.js"}]},{"block_type":"text","content":". Its creator,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Ryan Dahl"}]},{"block_type":"text","content":", soon realized the potential of the platform and started extending it with tools to enable the creation of any type of server-side application on top of the duo JavaScript/non-blocking paradigm. The characteristics of Node.js were perfect for the implementation of distributed systems, made of nodes orchestrating their operations through the network. Node.js was born to be distributed. Unlike other web platforms, the word scalability enters the vocabulary of a Node.js developer very early in the life of an application, mainly because of its single-threaded nature, incapable of exploiting all the resources of a machine, but often there are more profound reasons. As we will see in this chapter, scaling an application does not only mean increasing its capacity, enabling it to handle more requests faster; it's also a crucial path to achieving high availability and tolerance to errors. Amazingly, it can also be a way to split the complexity of an application into more manageable pieces. Scalability is a concept with multiple faces, six to be precise, as many as the faces of a cube&mdash;the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"scale cube"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5cf8","search_text":"In this chapter, we will learn the following topics:","text_count":52,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we will learn the following topics:"}]},{"block_type":"element","block":"k5zy5cf9","search_text":"What the scale cube is How to scale by running multiple instances of the same application How to leverage a load balancer when scaling an application What a service registry is and how it can be used How to design a microservice architecture out of a monolithic application How to integrate a large number of services through the use of some simple architectural patterns ","text_count":372,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"What the scale cube is"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"How to scale by running multiple instances of the same application"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"How to leverage a load balancer when scaling an application"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"What a service registry is and how it can be used"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"How to design a microservice architecture out of a monolithic application"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"How to integrate a large number of services through the use of some simple architectural patterns"}]}]},{"block_type":"element","block":"k5zy5cfa","search_text":"An introduction to application scaling","text_count":38,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"An introduction to application scaling"}]},{"block_type":"element","block":"k5zy5cfb","search_text":"Before we dive into some practical patterns and examples, it is worth saying a few words about the reasons for scaling an application and how it can be achieved.","text_count":161,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Before we dive into some practical patterns and examples, it is worth saying a few words about the reasons for scaling an application and how it can be achieved."}]},{"block_type":"element","block":"k5zy5cfc","search_text":"Scaling Node.js applications","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Scaling Node.js applications"}]},{"block_type":"element","block":"k5zy5cfd","search_text":"We already know that most of the tasks of a typical Node.js application run in the context of a single thread. In Chapter 1, Welcome to the Node.js Platform , we learned that this is not really a limitation but rather an advantage, because it allows the application to optimize the usage of the resources necessary to handle concurrent requests, thanks to the non-blocking I/O paradigm. A single thread fully exploited by non-blocking I/O works wonderfully for applications handling a moderate number of requests per second, usually a few hundred per second (this greatly depends on the application). Assuming we are using commodity hardware, the capacity that a single thread can support is limited no matter how powerful a server can be, therefore, if we want to use Node.js for high-load applications, the only way is to scale it across multiple processes and machines.","text_count":872,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We already know that most of the tasks of a typical Node.js application run in the context of a single thread. In Chapter 1,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Welcome to the Node.js Platform"}]},{"block_type":"text","content":", we learned that this is not really a limitation but rather an advantage, because it allows the application to optimize the usage of the resources necessary to handle concurrent requests, thanks to the non-blocking I/O paradigm. A single thread fully exploited by non-blocking I/O works wonderfully for applications handling a moderate number of requests per second, usually a few hundred per second (this greatly depends on the application). Assuming we are using commodity hardware, the capacity that a single thread can support is limited no matter how powerful a server can be, therefore, if we want to use Node.js for high-load applications, the only way is to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"scale"}]},{"block_type":"text","content":"it across multiple processes and machines."}]},{"block_type":"element","block":"k5zy5cfe","search_text":"However, workload is not the only reason to scale a Node.js application; in fact, with the same techniques, we can obtain other desirable properties such as availability and tolerance to failures . Scalability is also a concept applicable to the size and the complexity of an application; in fact, building architectures that can grow big is another important factor when designing software. JavaScript is a tool to be used with caution, the lack of type checking and its many gotchas can be an obstacle to the growth of an application, but with discipline and an accurate design, we can turn this into an advantage. With JavaScript, we are often pushed to keep the application simple and split it into manageable pieces, making it easier to scale and distribute.","text_count":763,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, workload is not the only reason to scale a Node.js application; in fact, with the same techniques, we can obtain other desirable properties such as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"availability"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"tolerance to failures"}]},{"block_type":"text","content":". Scalability is also a concept applicable to the size and the complexity of an application; in fact, building architectures that can grow big is another important factor when designing software. JavaScript is a tool to be used with caution, the lack of type checking and its many"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"gotchas"}]},{"block_type":"text","content":"can be an obstacle to the growth of an application, but with discipline and an accurate design, we can turn this into an advantage. With JavaScript, we are often pushed to keep the application simple and split it into manageable pieces, making it easier to scale and distribute."}]},{"block_type":"element","block":"k5zy5cff","search_text":"The three dimensions of scalability","text_count":35,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The three dimensions of scalability"}]},{"block_type":"element","block":"k5zy5cfg","search_text":"When talking about scalability, the first fundamental principle to understand is load distribution , the science of splitting the load of an application across several processes and machines. There are many ways to achieve this, and the book The Art of Scalability by Martin L. Abbott and Michael T. Fisher proposes an ingenious model to represent them, called the scale cube . This model describes scalability in terms of the following three dimensions:","text_count":454,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When talking about scalability, the first fundamental principle to understand is&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"load distribution"}]},{"block_type":"text","content":", the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"science"}]},{"block_type":"text","content":"of splitting the load of an application across several processes and machines. There are many ways to achieve this, and the book"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"The Art of Scalability"}]},{"block_type":"text","content":"by"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Martin L. Abbott"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Michael T. Fisher"}]},{"block_type":"text","content":"proposes an ingenious model to represent them, called the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"scale cube"}]},{"block_type":"text","content":". This model describes scalability in terms of the following three dimensions:"}]},{"block_type":"element","block":"k5zy5cfh","search_text":"x- axis : Cloning y- axis : Decomposing by service/functionality z- axis : Splitting by data partition ","text_count":103,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x-"}]},{"block_type":"text","content":"axis"}]},{"block_type":"text","content":": Cloning"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y-"}]},{"block_type":"text","content":"axis"}]},{"block_type":"text","content":": Decomposing by service/functionality"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"z-"}]},{"block_type":"text","content":"axis"}]},{"block_type":"text","content":": Splitting by data partition"}]}]},{"block_type":"element","block":"k5zy5cfi","search_text":"These three dimensions can be represented as a cube, as shown in the following figure:","text_count":86,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"These three dimensions can be represented as a cube, as shown in the following figure:"}]},{"block_type":"element","block":"k5zy5cfj","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000026.jpg","alt":"The three dimensions of scalability","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cfk","search_text":"The bottom-left corner of the cube represents the applications having all their functionalities and services in a single codebase (monolithic applications) and running on a single instance. This is a common situation for applications handling small workloads or at the early stages of development.","text_count":297,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The bottom-left corner of the cube represents the applications having all their functionalities and services in a single codebase (monolithic applications) and running on a single instance. This is a common situation for applications handling small workloads or at the early stages of development."}]},{"block_type":"element","block":"k5zy5cfl","search_text":"The most intuitive evolution of a monolithic, unscaled application is moving right along the x - axis, which is simple, most of the time inexpensive (in terms of development cost), and highly effective. The principle behind this technique is elementary, that is, cloning the same application n times and letting each instance handle 1/n th of the workload.","text_count":356,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most intuitive evolution of a monolithic, unscaled application is moving right along the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"- axis, which is simple, most of the time inexpensive (in terms of development cost), and highly effective. The principle behind this technique is elementary, that is, cloning the same application"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"n"}]},{"block_type":"text","content":"times and letting each instance handle"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"1/n"}]},{"block_type":"text","content":"th of the workload."}]},{"block_type":"element","block":"k5zy5cfm","search_text":"Scaling along the y -axis means decomposing the application based on its functionalities, services, or use cases. In this instance, decomposing means creating different, standalone applications, each with its own codebase, sometimes with its own dedicated database, or even with a separate UI. For example, a common situation is separating the part of an application responsible for the administration from the public-facing product. Another example is extracting the services responsible for user authentication, creating a dedicated authentication server. The criteria to split an application by its functionalities depend mostly on its business requirements, the use cases, the data, and many other factors, as we will see later in this chapter. Interestingly, this is the scaling dimension with the biggest repercussions, not only on the architecture of an application, but also on the way it is managed from a development perspective. As we will see, microservice is a term that at the moment is most commonly associated with a fine-grained y -axis scaling.","text_count":1062,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Scaling along the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"-axis means decomposing the application based on its functionalities, services, or use cases. In this instance,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"decomposing"}]},{"block_type":"text","content":"means creating different, standalone applications, each with its own codebase, sometimes with its own dedicated database, or even with a separate UI. For example, a common situation is separating the part of an application responsible for the administration from the public-facing product. Another example is extracting the services responsible for user authentication, creating a dedicated authentication server. The criteria to split an application by its functionalities depend mostly on its business requirements, the use cases, the data, and many other factors, as we will see later in this chapter. Interestingly, this is the scaling dimension with the biggest repercussions, not only on the architecture of an application, but also on the way it is managed from a development perspective. As we will see, microservice is a term that at the moment is most commonly associated with a fine-grained"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"-axis scaling."}]},{"block_type":"element","block":"k5zy5cfn","search_text":"The last scaling dimension is the z -axis, where the application is split in such a way that each instance is responsible for only a portion of the whole data. This is a technique mainly used in databases and also takes the name of horizontal partitioning or sharding . In this setup, there are multiple instances of the same application, each of them operating on a partition of the data, which is determined using different criteria. For example, we could partition the users of an application based on their country ( list partitioning ), or based on the starting letter of their surname ( range partitioning ), or by letting a hash function decide the partition each user belongs to ( hash partitioning ). Each partition can then be assigned to a particular instance of our application. The use of data partitions requires each operation to be preceded by a lookup step to determine which instance of the application is responsible for a given datum. As we said, data partitioning is usually applied and handled at the database level because its main purpose is overcoming the problems related to handling large monolithic datasets (limited disk space, memory, and network capacity). Applying it at the application level is worth considering only for complex, distributed architectures or for very particular use cases as, for example, when building applications relying on custom solutions for data persistence, when using databases not supporting partitioning, or when building applications at Google scale. Considering its complexity, scaling an application along the z -axis should be taken into consideration only after the x- and y -axes of the scale cube have been fully exploited.","text_count":1692,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The last scaling dimension is the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"z"}]},{"block_type":"text","content":"-axis, where the application is split in such a way that each instance is responsible for only a portion of the whole data. This is a technique mainly used in databases and also takes the name of&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"horizontal partitioning"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"sharding"}]},{"block_type":"text","content":". In this setup, there are multiple instances of the same application, each of them operating on a partition of the data, which is determined using different criteria. For example, we could partition the users of an application based on their country ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"list partitioning"}]},{"block_type":"text","content":"), or based on the starting letter of their surname ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"range partitioning"}]},{"block_type":"text","content":"), or by letting a hash function decide the partition each user belongs to ("},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"hash partitioning"}]},{"block_type":"text","content":"). Each partition can then be assigned to a particular instance of our application. The use of data partitions requires each operation to be preceded by a lookup step to determine which instance of the application is responsible for a given datum. As we said, data partitioning is usually applied and handled at the database level because its main purpose is overcoming the problems related to handling large monolithic datasets (limited disk space, memory, and network capacity). Applying it at the application level is worth considering only for complex, distributed architectures or for very particular use cases as, for example, when building applications relying on custom solutions for data persistence, when using databases not supporting partitioning, or when building applications at Google scale. Considering its complexity, scaling an application along the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"z"}]},{"block_type":"text","content":"-axis should be taken into consideration only after the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x-"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"-axes of the scale cube have been fully exploited."}]},{"block_type":"element","block":"k5zy5cfo","search_text":"In the next sections, we will focus on the two most common and effective techniques to scale Node.js applications, namely, cloning and decomposing by functionality/service.","text_count":172,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next sections, we will focus on the two most common and effective techniques to scale Node.js applications, namely,"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"cloning"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"decomposing"}]},{"block_type":"text","content":"by functionality/service."}]},{"block_type":"element","block":"k5zy5cfp","search_text":"Cloning and load balancing","text_count":26,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Cloning and load balancing"}]},{"block_type":"element","block":"k5zy5cfq","search_text":"Traditional, multithreaded web servers are usually scaled only when the resources assigned to a machine cannot be upgraded any more or when doing so would involve a higher cost than simply launching another machine. By using multiple threads, traditional web servers can take advantage of all the processing power of a server, using all the available processors and memory. However, with a single Node.js process it is harder to do that, being single-threaded and having by default a memory limit of 1.7 GB on 64-bit machines (which needs a special command-line option called --max_old_space_size to be increased). This means that Node.js applications are usually scaled much sooner compared to traditional web servers, even in the context of a single machine, to be able to take advantage of all its resources.","text_count":811,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Traditional, multithreaded web servers are usually scaled only when the resources assigned to a machine cannot be upgraded any more or when doing so would involve a higher cost than simply launching another machine. By using multiple threads, traditional web servers can take advantage of all the processing power of a server, using all the available processors and memory. However, with a single Node.js process it is harder to do that, being single-threaded and having by default a memory limit of 1.7 GB on 64-bit machines (which needs a special command-line option called&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"--max_old_space_size"}]},{"block_type":"text","content":"&nbsp;to be increased). This means that Node.js applications are usually scaled much sooner compared to traditional web servers, even in the context of a single machine, to be able to take advantage of all its resources."}]},{"block_type":"element","block":"k5zy5cfr","search_text":"Note In Node.js, vertical scaling (adding more resources to a single machine) and horizontal scaling (adding more machines to the infrastructure) are almost equivalent concepts; both in fact involve similar techniques to leverage all the available processing power. ","text_count":266,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Node.js,"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"vertical scaling"}]},{"block_type":"text","content":"(adding more resources to a single machine) and&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"horizontal scaling"}]},{"block_type":"text","content":"(adding more machines to the infrastructure) are almost equivalent concepts; both in fact involve similar techniques to leverage all the available processing power."}]}]},{"block_type":"element","block":"k5zy5cfs","search_text":"Don't be fooled into thinking about this as a disadvantage. On the contrary, being almost forced to scale has beneficial effects on other attributes of an application, in particular availability and fault-tolerance. In fact, scaling a Node.js application by cloning is relatively simple and it's often implemented even if there is no need to harvest more resources, just for the purpose of having a redundant, fail-tolerant setup.","text_count":430,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Don't be fooled into thinking about this as a disadvantage. On the contrary, being almost"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"forced"}]},{"block_type":"text","content":"to scale has beneficial effects on other attributes of an application, in particular availability and fault-tolerance. In fact, scaling a Node.js application by cloning is relatively simple and it's often implemented even if there is no need to harvest more resources, just for the purpose of having a redundant, fail-tolerant setup."}]},{"block_type":"element","block":"k5zy5cft","search_text":"This also pushes the developer to take into account scalability from the early stages of an application, making sure the application does not rely on any resource that cannot be shared across multiple processes or machines. In fact, an absolute prerequisite to scaling an application is that each instance does not have to store common information on resources that cannot be shared, usually hardware, such as memory or disk. For example, in a web server, storing the session data in memory or on disk is a practice that does not work well with scaling; instead, using a shared database will assure that each instance will have access to the same session information, wherever it is deployed.","text_count":692,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This also pushes the developer to take into account scalability from the early stages of an application, making sure the application does not rely on any resource that cannot be shared across multiple processes or machines. In fact, an absolute prerequisite to scaling an application is that each instance does not have to store common information on resources that cannot be shared, usually hardware, such as memory or disk. For example, in a web server, storing the session data in memory or on disk is a practice that does not work well with scaling; instead, using a shared database will assure that each instance will have access to the same session information, wherever it is deployed."}]},{"block_type":"element","block":"k5zy5cfu","search_text":"Let's now introduce the most basic mechanism for scaling Node.js applications: the cluster module.","text_count":98,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now introduce the most basic mechanism for scaling Node.js applications: the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module."}]},{"block_type":"element","block":"k5zy5cfv","search_text":"The cluster module","text_count":18,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The cluster module"}]},{"block_type":"element","block":"k5zy5cfw","search_text":"In Node.js, the simplest pattern to distribute the load of an application across different instances running on a single machine is by using the cluster module, which is part of the core libraries. The cluster module simplifies the forking of new instances of the same application and automatically distributes incoming connections across them, as shown in the following figure:","text_count":378,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Node.js, the simplest pattern to distribute the load of an application across different instances running on a single machine is by using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module, which is part of the core libraries. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module simplifies the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"forking"}]},{"block_type":"text","content":"of new instances of the same application and automatically distributes incoming connections across them, as shown in the following figure:"}]},{"block_type":"element","block":"k5zy5cfx","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000061.jpg","alt":"The cluster module","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cfy","search_text":"The M aster process is responsible for spawning a number of processes ( workers ), each representing an instance of the application we want to scale. Each incoming connection is then distributed across the cloned workers, spreading the load across them.","text_count":253,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The M"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"aster process"}]},{"block_type":"text","content":"is responsible for spawning a number of processes ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"workers"}]},{"block_type":"text","content":"), each representing an instance of the application we want to scale. Each incoming connection is then distributed across the cloned workers, spreading the load across them."}]},{"block_type":"element","block":"k5zy5cfz","search_text":"Notes on the behavior of the cluster module","text_count":43,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Notes on the behavior of the cluster module"}]},{"block_type":"element","block":"k5zy5cg0","search_text":"In Node.js 0.8 and 0.10, the cluster module shares the same server socket across the workers and leaves to the operating system, the job of load-balancing incoming connections across the available workers. However, there is a problem with this approach; in fact, the algorithms used by the operating system to distribute the load across the workers are not meant to load-balance network requests, but rather to schedule the execution of processes. As a result, the distribution is not always uniform across all the instances; often, a fraction of workers receive most of the load. This type of behavior can make sense for the operating system scheduler because it focuses on minimizing the context switches between different processes. The short story is that the cluster module does not work at its full potential in Node.js <= 0.10.","text_count":834,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Node.js 0.8 and 0.10, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module shares the same server socket across the workers and leaves to the operating system, the job of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"load-balancing"}]},{"block_type":"text","content":"incoming connections across the available workers. However, there is a problem with this approach; in fact, the algorithms used by the operating system to distribute the load across the workers are not meant to load-balance network requests, but rather to schedule the execution of processes. As a result, the distribution is not always uniform across all the instances; often, a fraction of workers receive most of the load. This type of behavior can make sense for the operating system scheduler because it focuses on minimizing the context switches between different processes. The short story is that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module does not work at its full potential in Node.js &lt;= 0.10."}]},{"block_type":"element","block":"k5zy5cg1","search_text":"However, the situation changes starting from version 0.11.2, where an explicit round robin load-balancing algorithm is included inside the master process, which makes sure the requests are evenly distributed across all the workers. The new load-balancing algorithm is enabled by default on all platforms except Windows, and it can be globally modified by setting the variable cluster.schedulingPolicy , using the constants cluster.SCHED_RR (round robin) or cluster.SCHED_NONE (handled by the operating system).","text_count":510,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, the situation changes starting from version 0.11.2, where an explicit round robin load-balancing algorithm is included inside the master process, which makes sure the requests are evenly distributed across all the workers. The new load-balancing algorithm is enabled by default on all platforms except Windows, and it can be globally modified by setting the variable"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster.schedulingPolicy"}]},{"block_type":"text","content":", using the constants"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster.SCHED_RR"}]},{"block_type":"text","content":"(round robin) or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster.SCHED_NONE"}]},{"block_type":"text","content":"(handled by the operating system)."}]},{"block_type":"element","block":"k5zy5cg2","search_text":"Note The round robin algorithm distributes the load evenly across the available servers on a rotational basis. The first request is forwarded to the first server, the second to the next server in the list, and so on. When the end of the list is reached, the iteration starts again from the beginning. This is one of the simplest and most used load balancing algorithms; however, it's not the only one. More sophisticated algorithms allow assigning priorities, selecting the least loaded server or the one with the fastest response time. You can find more details about the evolution of the cluster module in these two Node.js issues: https://github.com/nodejs/node-v0.x-archive/issues/3241 https://github.com/nodejs/node-v0.x-archive/issues/4435 ","text_count":746,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The round robin algorithm distributes the load evenly across the available servers on a rotational basis. The first request is forwarded to the first server, the second to the next server in the list, and so on. When the end of the list is reached, the iteration starts again from the beginning. This is one of the simplest and most used load balancing algorithms; however, it's not the only one. More sophisticated algorithms allow assigning priorities, selecting the least loaded server or the one with the fastest response time."}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can find more details about the evolution of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module in these two Node.js issues:"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/nodejs/node-v0.x-archive/issues/3241"},"children":[{"block_type":"text","content":"https://github.com/nodejs/node-v0.x-archive/issues/3241"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/nodejs/node-v0.x-archive/issues/4435"},"children":[{"block_type":"text","content":"https://github.com/nodejs/node-v0.x-archive/issues/4435"}]}]}]},{"block_type":"element","block":"k5zy5cg3","search_text":"Building a simple HTTP server","text_count":29,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Building a simple HTTP server"}]},{"block_type":"element","block":"k5zy5cg4","search_text":"Let's now start working on an example. Let's build a small HTTP server, cloned and load-balanced using the cluster module. First of all, we need an application to scale; for this example we don't need too much, just a very basic HTTP server.","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now start working on an example. Let's build a small HTTP server, cloned and load-balanced using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module. First of all, we need an application to scale; for this example we don't need too much, just a very basic HTTP server."}]},{"block_type":"element","block":"k5zy5cg5","search_text":"Let's create a file called app.js containing the following code:","text_count":64,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's create a file called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"containing the following code:"}]},{"block_type":"element","block":"k5zy5cg6","search_text":"const http = require('http'); const pid = process.pid; http.createServer((req, res) => { for (let i = 1e7; i> 0; i--) {} console.log(`Handling request from ${pid}`); res.end(`Hello from ${pid}\\n`); }).listen(8080, () => { console.log(`Started ${pid}`); }); ","text_count":257,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst pid = process.pid; \n \nhttp.createServer((req, res) =&gt; { \n  for (let i = 1e7; i&gt; 0; i--) {} \n  console.log(`Handling request from ${pid}`); \n  res.end(`Hello from ${pid}\\n`); \n}).listen(8080, () =&gt; { \n  console.log(`Started ${pid}`); \n});"}]}]},{"block_type":"element","block":"k5zy5cg7","search_text":"The HTTP server we just built responds to any request by sending back a message containing its PID; this will be useful to identify which instance of the application is handling the request. Also, to simulate some actual CPU work, we perform an empty loop 10 million times; without this, the server load would be almost nothing considering the small scale of the tests we are going to run for this example.","text_count":406,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The HTTP server we just built responds to any request by sending back a message containing its PID; this will be useful to identify which instance of the application is handling the request. Also, to simulate some actual CPU work, we perform an empty loop 10 million times; without this, the server load would be almost nothing considering the small scale of the tests we are going to run for this example."}]},{"block_type":"element","block":"k5zy5cg8","search_text":"Tip The app module we want to scale can be anything and can also be implemented using a web framework, for example, Express. ","text_count":125,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module we want to scale can be anything and can also be implemented using a web framework, for example, Express."}]}]},{"block_type":"element","block":"k5zy5cg9","search_text":"We can now check if all works as expected by running the application as usual and sending a request to http://localhost:8080 using either a browser or curl .","text_count":157,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now check if all works as expected by running the application as usual and sending a request to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:8080"}]},{"block_type":"text","content":"using either a browser or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"curl"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5cga","search_text":"We can also try to measure the requests per second that the server is able to handle using only one process; for this purpose, we can use a network benchmarking tool such as siege ( http://www.joedog.org/siege-home ) or Apache ab ( http://httpd.apache.org/docs/2.4/programs/ab.html ):","text_count":284,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can also try to measure the requests per second that the server is able to handle using only one process; for this purpose, we can use a network benchmarking tool such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"siege"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.joedog.org/siege-home"},"children":[{"block_type":"text","content":"http://www.joedog.org/siege-home"}]},{"block_type":"text","content":") or Apache"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ab"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://httpd.apache.org/docs/2.4/programs/ab.html"},"children":[{"block_type":"text","content":"http://httpd.apache.org/docs/2.4/programs/ab.html"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5cgb","search_text":"siege -c200 -t10S http://localhost:8080 ","text_count":40,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"siege -c200 -t10S http://localhost:8080"}]}]},{"block_type":"element","block":"k5zy5cgc","search_text":"With ab , the command line would be very similar:","text_count":49,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ab"}]},{"block_type":"text","content":", the command line would be very similar:"}]},{"block_type":"element","block":"k5zy5cgd","search_text":"ab -c200 -t10 http://localhost:8080/ ","text_count":37,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"ab -c200 -t10 http://localhost:8080/"}]}]},{"block_type":"element","block":"k5zy5cge","search_text":"The preceding commands will load the server with 200 concurrent connections for 10 seconds. As a reference, the result for a system with 4 processors is in the order of 90 transactions per second, with an average CPU utilization of only 20%.","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding commands will load the server with 200 concurrent connections for 10 seconds. As a reference, the result for a system with 4 processors is in the order of 90 transactions per second, with an average CPU utilization of only 20%."}]},{"block_type":"element","block":"k5zy5cgf","search_text":"Note Please remember that the load tests we will perform in this chapter are intentionally simple and minimal and are provided only for reference and learning purposes. Their results cannot provide a 100% accurate evaluation of the performance of the various techniques we are analyzing. ","text_count":288,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Please remember that the load tests we will perform in this chapter are intentionally simple and minimal and are provided only for reference and learning purposes. Their results cannot provide a 100% accurate evaluation of the performance of the various techniques we are analyzing."}]}]},{"block_type":"element","block":"k5zy5cgg","search_text":"Scaling with the cluster module","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Scaling with the cluster module"}]},{"block_type":"element","block":"k5zy5cgh","search_text":"Let's now try to scale our application using the cluster module. Let's create a new module called clusteredApp.js :","text_count":115,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now try to scale our application using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module. Let's create a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"clusteredApp.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cgi","search_text":"const cluster = require('cluster'); const os = require('os'); if(cluster.isMaster) { const cpus = os.cpus().length; console.log(`Clustering to ${cpus} CPUs`); for (let i = 0; i<cpus; i++) { // [1] cluster.fork(); } } else { require('./app'); // [2] } ","text_count":251,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const cluster = require('cluster'); \nconst os = require('os'); \n \nif(cluster.isMaster) { \n  const cpus = os.cpus().length; \n  console.log(`Clustering to ${cpus} CPUs`); \n  for (let i = 0; i&lt;cpus; i++) {      // [1] \n    cluster.fork(); \n  } \n} else { \n  require('./app');                   // [2] \n}"}]}]},{"block_type":"element","block":"k5zy5cgj","search_text":"As we can see, using the cluster module requires very little effort. Let's analyze what is happening:","text_count":101,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module requires very little effort. Let's analyze what is happening:"}]},{"block_type":"element","block":"k5zy5cgk","search_text":"When we launch clusteredApp from the command line, we are actually executing the master process. The cluster.isMaster variable is set to true and the only work we are required to do is forking the current process using cluster.fork() . In the preceding example, we are starting as many workers as the number of CPUs in the system to take advantage of all the available processing power. When cluster.fork() is executed from the master process, the current main module ( clusteredApp ) is run again, but this time in worker mode ( cluster.isWorker is set to true , while cluster.isMaster is false ). When the application runs as a worker, it can start doing some actual work. In our example, we load the app module, which actually starts a new HTTP server. ","text_count":756,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When we launch"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"clusteredApp"}]},{"block_type":"text","content":"from the command line, we are actually executing the master process. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster.isMaster"}]},{"block_type":"text","content":"variable is set to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true"}]},{"block_type":"text","content":"and the only work we are required to do is forking the current process using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster.fork()"}]},{"block_type":"text","content":". In the preceding example, we are starting as many workers as the number of CPUs in the system to take advantage of all the available processing power."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster.fork()"}]},{"block_type":"text","content":"is executed from the master process, the current main module ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"clusteredApp"}]},{"block_type":"text","content":") is run again, but this time in worker mode ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster.isWorker"}]},{"block_type":"text","content":"is set to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"true"}]},{"block_type":"text","content":", while"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster.isMaster"}]},{"block_type":"text","content":"is"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"false"}]},{"block_type":"text","content":"). When the application runs as a worker, it can start doing some actual work. In our example, we load the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app"}]},{"block_type":"text","content":"module, which actually starts a new HTTP server."}]}]},{"block_type":"element","block":"k5zy5cgl","search_text":"Note It's important to remember that each worker is a different Node.js process with its own event loop, memory space, and loaded modules. ","text_count":139,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's important to remember that each worker is a different Node.js process with its own event loop, memory space, and loaded modules."}]}]},{"block_type":"element","block":"k5zy5cgm","search_text":"It's interesting to notice that the usage of the cluster module is based on a recurring pattern, which makes it very easy to run multiple instances of an application:","text_count":166,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's interesting to notice that the usage of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module is based on a recurring pattern, which makes it very easy to run multiple instances of an application:"}]},{"block_type":"element","block":"k5zy5cgn","search_text":"if(cluster.isMaster) { // fork() } else { //do work } ","text_count":54,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if(cluster.isMaster) { \n  // fork() \n} else { \n  //do work \n}"}]}]},{"block_type":"element","block":"k5zy5cgo","search_text":"Tip Under the hood, the cluster module uses the child_process.fork() API (we already met this API in Chapter 9, Advanced Asynchronous Recipes ), therefore, we also have a communication channel available between the master and the workers. The instances of the workers can be accessed from the variable cluster.workers , so broadcasting a message to all of them would be as easy as running the following lines of code: Object.keys(cluster.workers).forEach(id => { cluster.workers[id].send('Hello from the master'); }); ","text_count":518,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Under the hood, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module uses the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":"API (we already met this API in Chapter 9,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Advanced Asynchronous Recipes"}]},{"block_type":"text","content":"), therefore, we also have a communication channel available between the master and the workers. The instances of the workers can be accessed from the variable&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster.workers"}]},{"block_type":"text","content":", so broadcasting a message to all of them would be as easy as running the following lines of code:"}]},{"block_type":"element","tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Object.keys(cluster.workers).forEach(id =&gt; {"}]},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"&nbsp; cluster.workers[id].send('Hello from the master');"}]},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"});"}]}]}]},{"block_type":"element","block":"k5zy5cgp","search_text":"Now, let's try to run our HTTP server in cluster mode. We can do that by starting the clusteredApp module as usual:","text_count":115,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's try to run our HTTP server in cluster mode. We can do that by starting the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"clusteredApp"}]},{"block_type":"text","content":"module as usual:"}]},{"block_type":"element","block":"k5zy5cgq","search_text":"node clusteredApp ","text_count":18,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node clusteredApp"}]}]},{"block_type":"element","block":"k5zy5cgr","search_text":"If our machine has more than one processor, we should see a number of workers being started by the master process, one after the other. For example, in a system with four processors, the terminal should look like this:","text_count":218,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If our machine has more than one processor, we should see a number of workers being started by the master process, one after the other. For example, in a system with four processors, the terminal should look like this:"}]},{"block_type":"element","block":"k5zy5cgs","search_text":"Started 14107 Started 14099 Started 14102 Started 14101 ","text_count":56,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Started 14107\nStarted 14099\nStarted 14102\nStarted 14101"}]}]},{"block_type":"element","block":"k5zy5cgt","search_text":"If we now try to hit our server again using the URL http://localhost:8080 , we should notice that each request will return a message with a different PID, which means that these requests have been handled by different workers, confirming that the load is being distributed among them.","text_count":284,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we now try to hit our server again using the URL"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:8080"}]},{"block_type":"text","content":", we should notice that each request will return a message with a different PID, which means that these requests have been handled by different workers, confirming that the load is being distributed among them."}]},{"block_type":"element","block":"k5zy5cgu","search_text":"Now we can try to load test our server again:","text_count":45,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we can try to load test our server again:"}]},{"block_type":"element","block":"k5zy5cgv","search_text":"siege -c200 -t10S http://localhost:8080 ","text_count":40,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"siege -c200 -t10S http://localhost:8080"}]}]},{"block_type":"element","block":"k5zy5cgw","search_text":"This way, we should be able to discover the performance increase obtained by scaling our application across multiple processes. As a reference, by using Node.js 6 in a Linux system with 4 processors, the performance increase should be around 3x (270 trans/sec versus 90 trans/sec) with an average CPU load of 90%.","text_count":313,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This way, we should be able to discover the performance increase obtained by scaling our application across multiple processes. As a reference, by using Node.js 6 in a Linux system with 4 processors, the performance increase should be around 3x (270 trans/sec versus 90 trans/sec) with an average CPU load of 90%."}]},{"block_type":"element","block":"k5zy5cgx","search_text":"Resiliency and availability with the cluster module","text_count":51,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Resiliency and availability with the cluster module"}]},{"block_type":"element","block":"k5zy5cgy","search_text":"As we already mentioned, scaling an application also brings other advantages, in particular the ability to maintain a certain level of service even in the presence of malfunctions or crashes. This property is also known as resiliency and it contributes towards the availability of a system.","text_count":290,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we already mentioned, scaling an application also brings other advantages, in particular the ability to maintain a certain level of service even in the presence of malfunctions or crashes. This property is also known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"resiliency"}]},{"block_type":"text","content":"and it contributes towards the availability of a system."}]},{"block_type":"element","block":"k5zy5cgz","search_text":"By starting multiple instances of the same application, we are creating a redundant system, which means that if one instance goes down for whatever reason, we still have other instances ready to serve requests. This pattern is pretty straightforward to implement using the cluster module. Let's see how it works!","text_count":312,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By starting multiple instances of the same application, we are creating a redundant system, which means that if one instance goes down for whatever reason, we still have other instances ready to serve requests. This pattern is pretty straightforward to implement using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module. Let's see how it works!"}]},{"block_type":"element","block":"k5zy5ch0","search_text":"Let's take the code from the previous section as the starting point. In particular, let's modify the app.js module so that it crashes after a random interval of time:","text_count":166,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's take the code from the previous section as the starting point. In particular, let's modify the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"module so that it crashes after a random interval of time:"}]},{"block_type":"element","block":"k5zy5ch1","search_text":"// ... // At the end of app.js setTimeout(() => { throw new Error('Ooops'); }, Math.ceil(Math.random() * 3) * 1000); ","text_count":117,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \n// At the end of app.js \nsetTimeout(() =&gt; { \n  throw new Error('Ooops'); \n}, Math.ceil(Math.random() * 3) * 1000);"}]}]},{"block_type":"element","block":"k5zy5ch2","search_text":"With this change in place, our server exits with an error after a random number of seconds between 1 and 3. In a real-life situation, this would cause our application to stop working, and of course, serve requests, unless we use some external tool to monitor its status and restart it automatically. However, if we only have one instance, there may be a non-negligible delay between restarts caused by the startup time of the application. This means that during those restarts, the application is not available. Having multiple instances instead will make sure we always have a backup system to serve an incoming request even when one of the workers fails.","text_count":656,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this change in place, our server exits with an error after a random number of seconds between 1 and 3. In a real-life situation, this would cause our application to stop working, and of course, serve requests, unless we use some external tool to monitor its status and restart it automatically. However, if we only have one instance, there may be a non-negligible delay between restarts caused by the startup time of the application. This means that during those restarts, the application is not available. Having multiple instances instead will make sure we always have a backup system to serve an incoming request even when one of the workers fails."}]},{"block_type":"element","block":"k5zy5ch3","search_text":"With the cluster module, all we have to do is spawn a new worker as soon as we detect that one is terminated with an error code. Let's then modify the clusteredApp.js module to take this into account:","text_count":200,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module, all we have to do is spawn a new worker as soon as we detect that one is terminated with an error code. Let's then modify the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"clusteredApp.js"}]},{"block_type":"text","content":"&nbsp;module to take this into account:"}]},{"block_type":"element","block":"k5zy5ch4","search_text":"if(cluster.isMaster) { // ... cluster.on('exit', (worker, code) => { if(code != 0 && !worker.suicide) { console.log('Worker crashed. Starting a new worker'); cluster.fork(); } }); } else { require('./app'); } ","text_count":209,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if(cluster.isMaster) { \n  // ... \n \n  cluster.on('exit', (worker, code) =&gt; { \n    if(code != 0 && !worker.suicide) { \n      console.log('Worker crashed. Starting a new worker'); \n      cluster.fork(); \n    } \n  }); \n} else { \n  require('./app'); \n}"}]}]},{"block_type":"element","block":"k5zy5ch5","search_text":"In the preceding code, as soon as the master process receives an 'exit' event, we check whether the process is terminated intentionally or as the result of an error; we do this by checking the status code and the flag worker.exitedAfterDisconnect , which indicates whether the worker was terminated explicitly by the master. If we confirm that the process was terminated because of an error, we start a new worker. It's interesting to notice that while the crashed worker restarts, the other workers can still serve requests, thus not affecting the availability of the application.","text_count":581,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, as soon as the master process receives an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"'exit'"}]},{"block_type":"text","content":"event, we check whether the process is terminated intentionally or as the result of an error; we do this by checking the status"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"code"}]},{"block_type":"text","content":"and the flag"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"worker.exitedAfterDisconnect"}]},{"block_type":"text","content":", which indicates whether the worker was terminated explicitly by the master. If we confirm that the process was terminated because of an error, we start a new worker. It's interesting to notice that while the crashed worker restarts, the other workers can still serve requests, thus not affecting the availability of the application."}]},{"block_type":"element","block":"k5zy5ch6","search_text":"To test this assumption, we can try to stress our server again using siege . When the stress test completes, we notice that among the various metrics produced by siege , there is also an indicator that measures the availability of the application. The expected result would be something similar to this:","text_count":303,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To test this assumption, we can try to stress our server again using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"siege"}]},{"block_type":"text","content":". When the stress test completes, we notice that among the various metrics produced by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"siege"}]},{"block_type":"text","content":", there is also an indicator that measures the availability of the application. The expected result would be something similar to this:"}]},{"block_type":"element","block":"k5zy5ch7","search_text":"Transactions: 3027 hits Availability: 99.31 % [...] Failed transactions: 21 ","text_count":76,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Transactions:           3027 hits\nAvailability:           99.31 %\n[...]\nFailed transactions:         21"}]}]},{"block_type":"element","block":"k5zy5ch8","search_text":"Bear in mind that this result can vary a lot; it greatly depends on the number of running instances and how many times they crash during the test, but it should give a good indicator of how our solution works. The preceding numbers tell us that despite the fact that our application is constantly crashing, we only had 21 failed requests over 3,027 hits. In the example scenario we built, most of the failing requests will be caused by the interruption of already established connections during a crash. In fact, when this happens, siege will print an error like the following:","text_count":577,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Bear in mind that this result can vary a lot; it greatly depends on the number of running instances and how many times they crash during the test, but it should give a good indicator of how our solution works. The preceding numbers tell us that despite the fact that our application is constantly crashing, we only had 21 failed requests over 3,027 hits. In the example scenario we built, most of the failing requests will be caused by the interruption of already established connections during a crash. In fact, when this happens,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"siege"}]},{"block_type":"text","content":"will print an error like the following:"}]},{"block_type":"element","block":"k5zy5ch9","search_text":"[error] socket: read error Connection reset by peer sock.c:479: Connection reset by peer ","text_count":89,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"[error] socket: read error Connection reset by peer sock.c:479: Connection reset by peer"}]}]},{"block_type":"element","block":"k5zy5cha","search_text":"Unfortunately, there is very little we can do to prevent these types of failures, especially when the application terminates because of a crash. Nonetheless, our solution proves to be working and its availability is not bad at all for an application that crashes so often!","text_count":272,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Unfortunately, there is very little we can do to prevent these types of failures, especially when the application terminates because of a crash. Nonetheless, our solution proves to be working and its availability is not bad at all for an application that crashes so often!"}]},{"block_type":"element","block":"k5zy5chb","search_text":"Zero-downtime restart","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Zero-downtime restart"}]},{"block_type":"element","block":"k5zy5chc","search_text":"A Node.js application might also need to be restarted when its code needs to be updated. So, also in this scenario, having multiple instances can help maintain the availability of our application.","text_count":196,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A Node.js application might also need to be restarted when its code needs to be updated. So, also in this scenario, having multiple instances can help maintain the availability of our application."}]},{"block_type":"element","block":"k5zy5chd","search_text":"When we have to intentionally restart an application to update it, there is a small window in which the application restarts and is unable to serve requests. This can be acceptable if we are updating our personal blog, but it's not even an option for a professional application with a Service Level Agreement ( SLA ) or one that is updated very often as part of a continuous delivery process. The solution is to implement a zero-downtime restart where the code of an application is updated without affecting its availability.","text_count":525,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When we have to intentionally restart an application to update it, there is a small window in which the application restarts and is unable to serve requests. This can be acceptable if we are updating our personal blog, but it's not even an option for a professional application with a&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service Level Agreement"}]},{"block_type":"text","content":"&nbsp;("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"SLA"}]},{"block_type":"text","content":") or one that is updated very often as part of a continuous delivery process. The solution is to implement a&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"zero-downtime restart"}]},{"block_type":"text","content":"where the code of an application is updated without affecting its availability."}]},{"block_type":"element","block":"k5zy5che","search_text":"With the cluster module, this is again a pretty easy task; the pattern consists of restarting the workers one at a time . This way, the remaining workers can continue to operate and maintain the services of the application available.","text_count":233,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module, this is again a pretty easy task; the pattern consists of restarting the workers"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"one at a time"}]},{"block_type":"text","content":". This way, the remaining workers can continue to operate and maintain the services of the application available."}]},{"block_type":"element","block":"k5zy5chf","search_text":"Let's then add this new feature to our clustered server; all we have to do is add some new code to be executed by the master process (the clusteredApp.js file):","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's then add this new feature to our clustered server; all we have to do is add some new code to be executed by the master process (the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"clusteredApp.js"}]},{"block_type":"text","content":"file):"}]},{"block_type":"element","block":"k5zy5chg","search_text":"if (cluster.isMaster) { // ... process.on('SIGUSR2', () => { //[1] const workers = Object.keys(cluster.workers); function restartWorker(i) { //[2] if (i >= workers.length) return; const worker = cluster.workers[workers[i]]; console.log(`Stopping worker: ${worker.process.pid}`); worker.disconnect(); //[3] worker.on('exit', () => { if (!worker.suicide) return; const newWorker = cluster.fork(); //[4] newWorker.on('listening', () => { restartWorker(i + 1); //[5] }); }); } restartWorker(0); }); } else { require('./app'); } ","text_count":524,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"if (cluster.isMaster) {\n  // ...\n \n  process.on('SIGUSR2', () =&gt; { //[1]\n    const workers = Object.keys(cluster.workers);\n\n    function restartWorker(i) { //[2]\n      if (i &gt;= workers.length) return;\n      const worker = cluster.workers[workers[i]];\n      console.log(`Stopping worker: ${worker.process.pid}`);\n      worker.disconnect(); //[3]\n\n      worker.on('exit', () =&gt; {\n        if (!worker.suicide) return;\n        const newWorker = cluster.fork(); //[4]\n        newWorker.on('listening', () =&gt; {\n          restartWorker(i + 1); //[5]\n        });\n      });\n    }\n    restartWorker(0);\n  });\n} else {\n  require('./app');\n}"}]}]},{"block_type":"element","block":"k5zy5chh","search_text":"This is how the preceding block of code works:","text_count":46,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is how the preceding block of code works:"}]},{"block_type":"element","block":"k5zy5chi","search_text":"The restarting of the workers is triggered on receiving the SIGUSR2 signal. We define an iterator function called restartWorker() . This implements an asynchronous sequential iteration pattern over the items of the cluster.workers object. The first task of the restartWorker() function is stopping a worker gracefully by invoking worker.disconnect() . When the terminated process exits, we can spawn a new worker. Only when the new worker is ready and listening for new connections can we proceed with restarting the next worker by invoking the next step of the iteration. ","text_count":573,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The restarting of the workers is triggered on receiving the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SIGUSR2"}]},{"block_type":"text","content":"signal."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We define an iterator function called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"restartWorker()"}]},{"block_type":"text","content":". This implements an asynchronous sequential iteration pattern over the items of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster.workers"}]},{"block_type":"text","content":"object."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The first task of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"restartWorker()"}]},{"block_type":"text","content":"function is stopping a worker gracefully by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"worker.disconnect()"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the terminated process exits, we can spawn a new worker."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Only when the new worker is ready and listening for new connections can we proceed with restarting the next worker by invoking the next step of the iteration."}]}]},{"block_type":"element","block":"k5zy5chj","search_text":"Note As our program makes use of UNIX signals, it will not work properly on Windows systems (unless you are using the recent Windows subsystem for Linux in Windows 10). Signals are the simplest mechanism to implement our solution. However, this isn't the only one; in fact, other approaches include listening for a command coming from a socket, a pipe, or the standard input. ","text_count":376,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As our program makes use of UNIX signals, it will not work properly on Windows systems (unless you are using the recent Windows subsystem for Linux in Windows 10). Signals are the simplest mechanism to implement our solution. However, this isn't the only one; in fact, other approaches include listening for a command coming from a socket, a pipe, or the standard input."}]}]},{"block_type":"element","block":"k5zy5chk","search_text":"Now we can test our zero-downtime restart by running the clusteredApp module and then sending a SIGUSR2 signal. However, first we need to obtain the PID of the master process; the following command can be useful to identify it from the list of all the running processes:","text_count":270,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we can test our zero-downtime restart by running the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"clusteredApp"}]},{"block_type":"text","content":"module and then sending a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SIGUSR2"}]},{"block_type":"text","content":"signal. However, first we need to obtain the PID of the master process; the following command can be useful to identify it from the list of all the running processes:"}]},{"block_type":"element","block":"k5zy5chl","search_text":"ps af ","text_count":6,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"ps af"}]}]},{"block_type":"element","block":"k5zy5chm","search_text":"The master process should be the parent of a set of node processes. Once we have the PID we are looking for, we can send the signal to it:","text_count":138,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The master process should be the parent of a set of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node"}]},{"block_type":"text","content":"processes. Once we have the PID we are looking for, we can send the signal to it:"}]},{"block_type":"element","block":"k5zy5chn","search_text":"kill -SIGUSR2 <PID> ","text_count":20,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"kill -SIGUSR2 &lt;PID&gt;"}]}]},{"block_type":"element","block":"k5zy5cho","search_text":"Now the output of the clusteredApp application should display something like this:","text_count":82,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now the output of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"clusteredApp"}]},{"block_type":"text","content":"application should display something like this:"}]},{"block_type":"element","block":"k5zy5chp","search_text":"Restarting workers Stopping worker: 19389 Started 19407 Stopping worker: 19390 Started 19409 ","text_count":93,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Restarting workers\nStopping worker: 19389\nStarted 19407\nStopping worker: 19390\nStarted 19409"}]}]},{"block_type":"element","block":"k5zy5chq","search_text":"We can try to use siege again to verify that we don't have any considerable impact on the availability of our application during the restart of the workers.","text_count":156,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can try to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"siege"}]},{"block_type":"text","content":"again to verify that we don't have any considerable impact on the availability of our application during the restart of the workers."}]},{"block_type":"element","block":"k5zy5chr","search_text":"Tip pm2 ( https://github.com/Unitech/pm2 ) is a small utility, based on cluster , which offers load balancing, process monitoring, zero-downtime restarts, and other goodies. ","text_count":174,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pm2"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://github.com/Unitech/pm2"},"children":[{"block_type":"text","content":"https://github.com/Unitech/pm2"}]},{"block_type":"text","content":") is a small utility, based on"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":", which offers load balancing, process monitoring, zero-downtime restarts, and other goodies."}]}]},{"block_type":"element","block":"k5zy5chs","search_text":"Dealing with stateful communications","text_count":36,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Dealing with stateful communications"}]},{"block_type":"element","block":"k5zy5cht","search_text":"The cluster module does not work well with stateful communications where the state maintained by the application is not shared between the various instances. This is because different requests belonging to the same stateful session may potentially be handled by a different instance of the application. This is not a problem limited only to the cluster module, but in general it applies to any kind of stateless, load balancing algorithm. Consider, for example, the situation described by the following figure:","text_count":510,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module does not work well with stateful communications where the state maintained by the application is not shared between the various instances. This is because different requests belonging to the same stateful session may potentially be handled by a different instance of the application. This is not a problem limited only to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module, but in general it applies to any kind of stateless, load balancing algorithm. Consider, for example, the situation described by the following figure:"}]},{"block_type":"element","block":"k5zy5chu","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000030.jpg","alt":"Dealing with stateful communications","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5chv","search_text":"The user John initially sends a request to our application to authenticate himself, but the result of the operation is registered locally (for example, in memory), so only the instance of the application that receives the authentication request ( Instance A ) knows that John is successfully authenticated. When John sends a new request, the load balancer might forward it to a different instance of the application, which actually doesn't possess the authentication details of John, hence refusing to perform the operation. The application we just described cannot be scaled as it is, but luckily, there are two easy solutions we can apply to solve the problem.","text_count":662,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The user"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"John"}]},{"block_type":"text","content":"initially sends a request to our application to authenticate himself, but the result of the operation is registered locally (for example, in memory), so only the instance of the application that receives the authentication request ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Instance A"}]},{"block_type":"text","content":") knows that John is successfully authenticated. When John sends a new request, the load balancer might forward it to a different instance of the application, which actually doesn't possess the authentication details of John, hence refusing to perform the operation. The application we just described cannot be scaled as it is, but luckily, there are two easy solutions we can apply to solve the problem."}]},{"block_type":"element","block":"k5zy5chw","search_text":"Sharing the state across multiple instances","text_count":43,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sharing the state across multiple instances"}]},{"block_type":"element","block":"k5zy5chx","search_text":"The first option we have to scale an application using stateful communications is sharing the state across all the instances. This can be easily achieved with a shared datastore, as, for example, a database such as PostgreSQL ( http://www.postgresql.org ), MongoDB ( http://www.mongodb.org ), or CouchDB ( http://couchdb.apache.org ), or even better, we can use an in-memory store such as Redis ( http://redis.io ) or Memcached ( http://memcached.org ).","text_count":453,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first option we have to scale an application using stateful communications is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"sharing the state"}]},{"block_type":"text","content":"across all the instances. This can be easily achieved with a shared datastore, as, for example, a database such as PostgreSQL ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.postgresql.org"},"children":[{"block_type":"text","content":"http://www.postgresql.org"}]},{"block_type":"text","content":"), MongoDB ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.mongodb.org"},"children":[{"block_type":"text","content":"http://www.mongodb.org"}]},{"block_type":"text","content":"), or CouchDB ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://couchdb.apache.org"},"children":[{"block_type":"text","content":"http://couchdb.apache.org"}]},{"block_type":"text","content":"), or even better, we can use an in-memory store such as Redis ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://redis.io"},"children":[{"block_type":"text","content":"http://redis.io"}]},{"block_type":"text","content":") or Memcached ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://memcached.org"},"children":[{"block_type":"text","content":"http://memcached.org"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5chy","search_text":"The following diagram outlines this simple and effective solution:","text_count":66,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following diagram outlines this simple and effective solution:"}]},{"block_type":"element","block":"k5zy5chz","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000064.jpg","alt":"Sharing the state across multiple instances","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5ci0","search_text":"The only drawback of using a shared store for the communication state is that it's not always possible, for example, we might be using an existing library that keeps the communication state in memory; anyway, if we have an existing application, applying this solution requires a change in the code of the application (if it's not already supported). As we will see next, there is a less invasive solution.","text_count":405,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The only drawback of using a shared store for the communication state is that it's not always possible, for example, we might be using an existing library that keeps the communication state in memory; anyway, if we have an existing application, applying this solution requires a change in the code of the application (if it's not already supported). As we will see next, there is a less invasive solution."}]},{"block_type":"element","block":"k5zy5ci1","search_text":"Sticky load balancing","text_count":21,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Sticky load balancing"}]},{"block_type":"element","block":"k5zy5ci2","search_text":"The other alternative we have to support stateful communications is having the load balancer always routing all of the requests associated with a session always to the same instance of the application. This technique is also called sticky load balancing .","text_count":255,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The other alternative we have to support stateful communications is having the load balancer always routing all of the requests associated with a session always to the same instance of the application. This technique is also called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"sticky load balancing"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5ci3","search_text":"The following figure illustrates a simplified scenario involving this technique:","text_count":80,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following figure illustrates a simplified scenario involving this technique:"}]},{"block_type":"element","block":"k5zy5ci4","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000032.jpg","alt":"Sticky load balancing","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5ci5","search_text":"As we can see from the preceding figure, when the load balancer receives a request associated with a new session, it creates a mapping with one particular instance selected by the load-balancing algorithm. The next time the load balancer receives a request from that same session, it bypasses the load-balancing algorithm, selecting the application instance that was previously associated with the session. The particular technique we just described involves the inspection of the session ID associated with the requests (usually included in a cookie by the application or the load balancer itself).","text_count":599,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see from the preceding figure, when the load balancer receives a request associated with a new session, it creates a mapping with one particular instance selected by the load-balancing algorithm. The next time the load balancer receives a request from that same session, it bypasses the load-balancing algorithm, selecting the application instance that was previously associated with the session. The particular technique we just described involves the inspection of the session ID associated with the requests (usually included in a cookie by the application or the load balancer itself)."}]},{"block_type":"element","block":"k5zy5ci6","search_text":"A simpler alternative to associate a stateful connection to a single server is by using the IP address of the client performing the request. Usually, the IP is provided to a hash function that generates an ID representing the application instance designated to receive the request. This technique has the advantage of not requiring the association to be remembered by the load balancer. However, it doesn't work well with devices that frequently change IP as, for example, when roaming on different networks.","text_count":508,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A simpler alternative to associate a stateful connection to a single server is by using the IP address of the client performing the request. Usually, the IP is provided to a hash function that generates an ID representing the application instance designated to receive the request. This technique has the advantage of not requiring the association to be remembered by the load balancer. However, it doesn't work well with devices that frequently change IP as, for example, when roaming on different networks."}]},{"block_type":"element","block":"k5zy5ci7","search_text":"Tip Sticky load balancing is not supported by default by the cluster module; however, it can be added with an npm library called sticky-session ( https://www.npmjs.org/package/sticky-session ). ","text_count":194,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Sticky load balancing is not supported by default by the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module; however, it can be added with an npm library called&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sticky-session"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.npmjs.org/package/sticky-session"},"children":[{"block_type":"text","content":"https://www.npmjs.org/package/sticky-session"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5ci8","search_text":"One big problem with sticky load balancing is the fact that it nullifies most of the advantages of having a redundant system, where all the instances of the application are the same, and where an instance can eventually replace another one that stopped working. For these reasons, the recommendation is to always try to avoid sticky load balancing and building applications that maintain any session state in a shared store or that don't require stateful communications at all (for example, by including the state in the request itself) are preferred.","text_count":551,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One big problem with sticky load balancing is the fact that it nullifies most of the advantages of having a redundant system, where all the instances of the application are the same, and where an instance can eventually replace another one that stopped working. For these reasons, the recommendation is to always try to avoid sticky load balancing and building applications that maintain any session state in a shared store or that don't require stateful communications at all (for example, by including the state in the request itself) are preferred."}]},{"block_type":"element","block":"k5zy5ci9","search_text":"Tip For a real example of a library requiring sticky load balancing, we can mention Socket.io ( http://socket.io/blog/introducing-socket-io-1-0/#scalability ). ","text_count":160,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For a real example of a library requiring sticky load balancing, we can mention&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Socket.io"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://socket.io/blog/introducing-socket-io-1-0/#scalability"},"children":[{"block_type":"text","content":"http://socket.io/blog/introducing-socket-io-1-0/#scalability"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5cia","search_text":"Scaling with a reverse proxy","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Scaling with a reverse proxy"}]},{"block_type":"element","block":"k5zy5cib","search_text":"The cluster module is not the only option we have to scale a Node.js web application. In fact, more traditional techniques are often preferred because they offer more control and power in highly available production environments.","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module is not the only option we have to scale a Node.js web application. In fact, more"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"traditional"}]},{"block_type":"text","content":"techniques are often preferred because they offer more control and power in highly available production environments."}]},{"block_type":"element","block":"k5zy5cic","search_text":"The alternative to using cluster is to start multiple standalone instances of the same application running on different ports or machines, and then use a reverse proxy (or gateway) to provide access to those instances, distributing the traffic across them. In this configuration, we don't have a master process distributing requests to a set of workers, but a set of distinct processes running on the same machine (using different ports) or scattered across different machines inside a network. To provide a single access point to our application, we can then use a reverse proxy, a special device or service placed between the clients and the instances of our application, which takes any request and forwards it to a destination server, returning the result to the client as if it was itself the origin. In this scenario, the reverse proxy is also used as a load balancer, distributing the requests among the instances of the application.","text_count":940,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The alternative to using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"is to start multiple&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"standalone instances"}]},{"block_type":"text","content":"of the same application running on different ports or machines, and then use a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"reverse proxy"}]},{"block_type":"text","content":"(or"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"gateway)"}]},{"block_type":"text","content":"to provide access to those instances, distributing the traffic across them. In this configuration, we don't have a master process distributing requests to a set of workers, but a set of distinct processes running on the same machine (using different ports) or scattered across different machines inside a network. To provide a single access point to our application, we can then use a reverse proxy, a special device or service placed between the clients and the instances of our application, which takes any request and forwards it to a destination server, returning the result to the client as if it was itself the origin. In this scenario, the reverse proxy is also used as a load balancer, distributing the requests among the instances of the application."}]},{"block_type":"element","block":"k5zy5cid","search_text":"Tip For a clear explanation of the differences between a reverse proxy and a forward proxy, you can refer to the Apache HTTP server documentation at http://httpd.apache.org/docs/2.4/mod/mod_proxy.html#forwardreverse . ","text_count":218,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For a clear explanation of the differences between a reverse proxy and a forward proxy, you can refer to the Apache HTTP server documentation at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://httpd.apache.org/docs/2.4/mod/mod_proxy.html#forwardreverse"},"children":[{"block_type":"text","content":"http://httpd.apache.org/docs/2.4/mod/mod_proxy.html#forwardreverse"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cie","search_text":"The next figure shows a typical multiprocess, multimachine configuration with a reverse proxy acting as a load balancer on the front:","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next figure shows a typical multiprocess, multimachine configuration with a reverse proxy acting as a load balancer on the front:"}]},{"block_type":"element","block":"k5zy5cif","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000067.jpg","alt":"Scaling with a reverse proxy","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cig","search_text":"For a Node.js application, there are many reasons to choose this approach in place of the cluster module:","text_count":105,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For a Node.js application, there are many reasons to choose this approach in place of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5cih","search_text":"A reverse proxy can distribute the load across several machines, not just several processes The most popular reverse proxies on the market support sticky load balancing A reverse proxy can route a request to any available server, regardless of its programming language or platform We can choose more powerful load balancing algorithms Many reverse proxies also offer other services such as URL rewrites, caching, SSL termination point, or even the functionality of fully-fledged web servers that can be used, for example, to serve static files ","text_count":544,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A reverse proxy can distribute the load across several machines, not just several processes"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The most popular reverse proxies on the market support sticky load balancing"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A reverse proxy can route a request to any available server, regardless of its programming language or platform"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We can choose more powerful load balancing algorithms"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Many reverse proxies also offer other services such as URL rewrites, caching, SSL termination point, or even the functionality of fully-fledged web servers that can be used, for example, to serve static files"}]}]},{"block_type":"element","block":"k5zy5cii","search_text":"That said, the cluster module could also be easily combined with a reverse proxy if necessary; for example, using cluster to scale vertically inside a single machine and then using the reverse proxy to scale horizontally across different nodes.","text_count":244,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That said, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"module could also be easily combined with a reverse proxy if necessary; for example, using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"to scale vertically inside a single machine and then using the reverse proxy to scale horizontally across different nodes."}]},{"block_type":"element","block":"k5zy5cij","search_text":"Note Pattern Use a reverse proxy to balance the load of an application across multiple instances running on different ports or machines. ","text_count":137,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Use a reverse proxy to balance the load of an application across multiple instances running on different ports or machines."}]}]},{"block_type":"element","block":"k5zy5cik","search_text":"We have many options to implement a load balancer using a reverse proxy; some popular solutions are the following:","text_count":114,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We have many options to implement a load balancer using a reverse proxy; some popular solutions are the following:"}]},{"block_type":"element","block":"k5zy5cil","search_text":"Nginx ( http://nginx.org ): This is a web server, reverse proxy, and load balancer, built upon the non-blocking I/O model. HAProxy ( http://www.haproxy.org ): This is a fast load balancer for TCP/HTTP traffic. Node.js-based proxies : There are many solutions for the implementation of reverse proxies and load balancers directly in Node.js. This might have advantages and disadvantages, as we will see later. Cloud-based proxies : In the era of cloud computing, it's not rare to utilize a load balancer as-a-service. This can be convenient because it requires minimal maintenance, it's usually highly scalable, and sometimes it can support dynamic configurations to enable on-demand scalability. ","text_count":696,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Nginx"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nginx.org"},"children":[{"block_type":"text","content":"http://nginx.org"}]},{"block_type":"text","content":"): This is a web server, reverse proxy, and load balancer, built upon the non-blocking I/O model."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"HAProxy"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.haproxy.org"},"children":[{"block_type":"text","content":"http://www.haproxy.org"}]},{"block_type":"text","content":"): This is a fast load balancer for TCP/HTTP traffic."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Node.js-based proxies"}]},{"block_type":"text","content":": There are many solutions for the implementation of reverse proxies and load balancers directly in Node.js. This might have advantages and disadvantages, as we will see later."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cloud-based proxies"}]},{"block_type":"text","content":": In the era of cloud computing, it's not rare to utilize a load balancer as-a-service. This can be convenient because it requires minimal maintenance, it's usually highly scalable, and sometimes it can support dynamic configurations to enable on-demand scalability."}]}]},{"block_type":"element","block":"k5zy5cim","search_text":"In the next few sections of this chapter, we will analyze a sample configuration using Nginx, and later on, we will also work on building our very own load balancer using nothing but Node.js!","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next few sections of this chapter, we will analyze a sample configuration using Nginx, and later on, we will also work on building our very own load balancer using nothing but Node.js!"}]},{"block_type":"element","block":"k5zy5cin","search_text":"Load balancing with Nginx","text_count":25,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Load balancing with Nginx"}]},{"block_type":"element","block":"k5zy5cio","search_text":"To give an idea of how dedicated reverse proxies work, we will now build a scalable architecture based on Nginx ( http://nginx.org ), but first we need to install it. We can do that by following the instructions at http://nginx.org/en/docs/install.html .","text_count":254,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To give an idea of how dedicated reverse proxies work, we will now build a scalable architecture based on Nginx ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nginx.org"},"children":[{"block_type":"text","content":"http://nginx.org"}]},{"block_type":"text","content":"), but first we need to install it. We can do that by following the instructions at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://nginx.org/en/docs/install.html"},"children":[{"block_type":"text","content":"http://nginx.org/en/docs/install.html"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5cip","search_text":"Tip On the latest Ubuntu system, you can quickly install Nginx with the command: sudo apt-get install nginx On Mac OS X, you can use brew ( http://brew.sh ): brew install nginx ","text_count":177,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the latest Ubuntu system, you can quickly install Nginx with the command:"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"sudo apt-get install nginx"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On Mac OS X, you can use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"brew"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://brew.sh"},"children":[{"block_type":"text","content":"http://brew.sh"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"brew install nginx"}]}]}]},{"block_type":"element","block":"k5zy5ciq","search_text":"As we are not going to use cluster to start multiple instances of our server, we need to slightly modify the code of our application so that we can specify the listening port using a command-line argument. This will allow us to launch multiple instances on different ports. Let's then consider again the main module of our example application ( app.js ):","text_count":354,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we are not going to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"to start multiple instances of our server, we need to slightly modify the code of our application so that we can specify the listening port using a command-line argument. This will allow us to launch multiple instances on different ports. Let's then consider again the main module of our example application ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5cir","search_text":"const http = require('http'); const pid = process.pid; http.createServer((req, res) => { for (let i = 1e7; i> 0; i--) {} console.log(`Handling request from ${pid}`); res.end(`Hello from ${pid}\\n`); }).listen(process.env.PORT || process.argv[2] || 8080, () => { console.log(`Started ${pid}`); }); ","text_count":296,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst pid = process.pid; \n \nhttp.createServer((req, res) =&gt; { \n  for (let i = 1e7; i&gt; 0; i--) {} \n  console.log(`Handling request from ${pid}`); \n  res.end(`Hello from ${pid}\\n`); \n}).listen(process.env.PORT || process.argv[2] || 8080, () =&gt; { \n  console.log(`Started ${pid}`); \n});"}]}]},{"block_type":"element","block":"k5zy5cis","search_text":"Another important feature we lack by not using cluster is the automatic restart in case of a crash. Luckily, this is easy to fix by using a dedicated supervisor, which is an external process monitoring our application and restarting it if necessary. Possible choices are the following:","text_count":285,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another important feature we lack by not using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"is the automatic restart in case of a crash. Luckily, this is easy to fix by using a dedicated&nbsp;supervisor, which is an external process monitoring our application and restarting it if necessary. Possible choices are the following:"}]},{"block_type":"element","block":"k5zy5cit","search_text":"Node.js-based supervisors such as forever ( https://npmjs.org/package/forever ) or pm2 ( https://npmjs.org/package/pm2 ) OS-based monitors such as upstart ( http://upstart.ubuntu.com ), systemd ( http://freedesktop.org/wiki/Software/systemd ) or runit ( http://smarden.org/runit/ ) More advanced monitoring solutions such as monit ( http://mmonit.com/monit ) or supervisor ( http://supervisord.org ) ","text_count":400,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Node.js-based supervisors such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"forever"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/forever"},"children":[{"block_type":"text","content":"https://npmjs.org/package/forever"}]},{"block_type":"text","content":") or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pm2"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/pm2"},"children":[{"block_type":"text","content":"https://npmjs.org/package/pm2"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"OS-based monitors such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"upstart"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://upstart.ubuntu.com"},"children":[{"block_type":"text","content":"http://upstart.ubuntu.com"}]},{"block_type":"text","content":"),"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"systemd"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://freedesktop.org/wiki/Software/systemd"},"children":[{"block_type":"text","content":"http://freedesktop.org/wiki/Software/systemd"}]},{"block_type":"text","content":") or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"runit"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://smarden.org/runit/"},"children":[{"block_type":"text","content":"http://smarden.org/runit/"}]},{"block_type":"text","content":")"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"More advanced monitoring solutions such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"monit"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://mmonit.com/monit"},"children":[{"block_type":"text","content":"http://mmonit.com/monit"}]},{"block_type":"text","content":") or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"supervisor"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://supervisord.org"},"children":[{"block_type":"text","content":"http://supervisord.org"}]},{"block_type":"text","content":")"}]}]},{"block_type":"element","block":"k5zy5ciu","search_text":"For this example, we are going to use forever , which is the simplest and most immediate for us to use. We can install it globally by running the following command:","text_count":164,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For this example, we are going to use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"forever"}]},{"block_type":"text","content":", which is the simplest and most immediate for us to use. We can install it globally by running the following command:"}]},{"block_type":"element","block":"k5zy5civ","search_text":"npm install forever -g ","text_count":23,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"npm install forever -g"}]}]},{"block_type":"element","block":"k5zy5ciw","search_text":"The next step is to start the four instances of our application, all on different ports and supervised by forever :","text_count":115,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next step is to start the four instances of our application, all on different ports and supervised by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"forever"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cix","search_text":"forever start app.js 8081 forever start app.js 8082 forever start app.js 8083 forever start app.js 8084 ","text_count":104,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"forever start app.js 8081\nforever start app.js 8082\nforever start app.js 8083\nforever start app.js 8084"}]}]},{"block_type":"element","block":"k5zy5ciy","search_text":"We can check the list of the started processes using the command:","text_count":65,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can check the list of the started processes using the command:"}]},{"block_type":"element","block":"k5zy5ciz","search_text":"forever list ","text_count":13,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"forever list"}]}]},{"block_type":"element","block":"k5zy5cj0","search_text":"Now it's time to configure the Nginx server as a load balancer.","text_count":63,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now it's time to configure the Nginx server as a load balancer."}]},{"block_type":"element","block":"k5zy5cj1","search_text":"First, we need to identify the location of the nginx.conf file that can be found in one of the following locations, depending on your system /usr/local/nginx/conf , /etc/nginx , or /usr/local/etc/nginx .","text_count":203,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"First, we need to identify the location of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"nginx.conf"}]},{"block_type":"text","content":"file that can be found in one of the following locations, depending on your system"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/usr/local/nginx/conf"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/etc/nginx"}]},{"block_type":"text","content":", or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/usr/local/etc/nginx"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5cj2","search_text":"Next, let's open the nginx.conf file and apply the following configuration, which is the very minimum required to get a working load balancer:","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, let's open the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"nginx.conf"}]},{"block_type":"text","content":"file and apply the following configuration, which is the very minimum required to get a working load balancer:"}]},{"block_type":"element","block":"k5zy5cj3","search_text":"http { # ... upstream nodejs_design_patterns_app { server 127.0.0.1:8081; server 127.0.0.1:8082; server 127.0.0.1:8083; server 127.0.0.1:8084; } # ... server { listen 80; location / { proxy_pass http://nodejs_design_patterns_app; } } # ... } ","text_count":242,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"http { \n  # ... \n  upstream nodejs_design_patterns_app { \n    server 127.0.0.1:8081; \n    server 127.0.0.1:8082; \n    server 127.0.0.1:8083; \n    server 127.0.0.1:8084; \n  } \n  # ... \n  server { \n    listen 80; \n \n    location / { \n      proxy_pass http://nodejs_design_patterns_app; \n    } \n  } \n  # ... \n}"}]}]},{"block_type":"element","block":"k5zy5cj4","search_text":"The configuration needs very little explanation. In the upstream nodejs_design_patterns_app section, we are defining a list of the backend servers used to handle the network requests, and then, in the server section, we specify the proxy_pass directive, which essentially tells Nginx to forward any request to the server group we defined before ( nodejs_design_patterns_app ). That's it, now we only need to reload the Nginx configuration with the command:","text_count":456,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The configuration needs very little explanation. In the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"upstream nodejs_design_patterns_app"}]},{"block_type":"text","content":"section, we are defining a list of the backend servers used to handle the network requests, and then, in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"server"}]},{"block_type":"text","content":"section, we specify the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"proxy_pass"}]},{"block_type":"text","content":"directive, which essentially tells Nginx to forward any request to the server group we defined before ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"nodejs_design_patterns_app"}]},{"block_type":"text","content":"). That's it, now we only need to reload the Nginx configuration with the command:"}]},{"block_type":"element","block":"k5zy5cj5","search_text":"nginx -s reload ","text_count":16,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"nginx -s reload"}]}]},{"block_type":"element","block":"k5zy5cj6","search_text":"Our system should now be up and running, ready to accept requests and balance the traffic across the four instances of our Node.js application. Simply point your browser to the address http://localhost to see how the traffic is balanced by our Nginx server.","text_count":257,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our system should now be up and running, ready to accept requests and balance the traffic across the four instances of our Node.js application. Simply point your browser to the address"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost"}]},{"block_type":"text","content":"to see how the traffic is balanced by our Nginx server."}]},{"block_type":"element","block":"k5zy5cj7","search_text":"Using a service registry","text_count":24,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Using a service registry"}]},{"block_type":"element","block":"k5zy5cj8","search_text":"One important advantage of modern cloud-based infrastructures is the ability to dynamically adjust the capacity of an application based on the current or predicted traffic; this is also known as dynamic scaling . If implemented properly, this practice can reduce the cost of the IT infrastructure enormously while still keeping the application highly available and responsive.","text_count":376,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One important advantage of modern cloud-based infrastructures is the ability to dynamically adjust the capacity of an application based on the current or predicted traffic; this is also known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"dynamic scaling"}]},{"block_type":"text","content":". If implemented properly, this practice can reduce the cost of the IT infrastructure enormously while still keeping the application highly available and responsive."}]},{"block_type":"element","block":"k5zy5cj9","search_text":"The idea is simple: if our application is experiencing a performance degradation caused by a peak in the traffic, we automatically spawn new servers to cope with the increased load. We could also decide to shut down some servers during certain hours, for example, at night, when we know that the traffic will be less, and restarting them again in the morning. This mechanism requires the load balancer to always be up-to-date with the current network topology, knowing at any time which server is up.","text_count":500,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The idea is simple: if our application is experiencing a performance degradation caused by a peak in the traffic, we automatically spawn new servers to cope with the increased load. We could also decide to shut down some servers during certain hours, for example, at night, when we know that the traffic will be less, and restarting them again in the morning. This mechanism requires the load balancer to always be up-to-date with the current network topology, knowing at any time which server is up."}]},{"block_type":"element","block":"k5zy5cja","search_text":"A common pattern to solve this problem is to use a central repository called a service registry, which keeps track of the running servers and the services they provide. The next figure shows a multiservice architecture with a load balancer on the front, dynamically configured using a service registry:","text_count":302,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A common pattern to solve this problem is to use a central repository called a service registry, which keeps track of the running servers and the services they provide. The next figure shows a multiservice architecture with a load balancer on the front, dynamically configured using a service registry:"}]},{"block_type":"element","block":"k5zy5cjb","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000058.jpg","alt":"Using a service registry","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cjc","search_text":"The preceding architecture assumes the presence of two services, API and WebApp . The load balancer distributes the requests arriving on the /api endpoint to all the servers implementing the API service, while the rest of the requests are spread across the servers implementing the WebApp service. The load balancer obtains the list of servers using the service registry.","text_count":371,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding architecture assumes the presence of two services,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"API"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WebApp"}]},{"block_type":"text","content":". The load balancer distributes the requests arriving on the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"/api"}]},{"block_type":"text","content":"endpoint to all the servers implementing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"API"}]},{"block_type":"text","content":"&nbsp;service, while the rest of the requests are spread across the servers implementing the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"WebApp"}]},{"block_type":"text","content":"service. The load balancer obtains the list of servers using the service registry."}]},{"block_type":"element","block":"k5zy5cjd","search_text":"For this to work in complete automation, each application instance has to register itself to the service registry the moment it comes up online, and unregister itself when it stops. This way, the load balancer can always have an up-to-date view of the servers and the services available on the network.","text_count":302,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For this to work in complete automation, each application instance has to register itself to the service registry the moment it comes up online, and unregister itself when it stops. This way, the load balancer can always have an up-to-date view of the servers and the services available on the network."}]},{"block_type":"element","block":"k5zy5cje","search_text":"Note Pattern (service registry) Use a central repository to store an always up-to-date view of the servers and the services available in a system. ","text_count":147,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern (service registry)"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Use a central repository to store an always up-to-date view of the servers and the services available in a system."}]}]},{"block_type":"element","block":"k5zy5cjf","search_text":"This pattern can be applied not only to load balancing, but also more generally as a way to decouple a service type from the servers providing it. We can look at it as a service locator design pattern applied to network services.","text_count":229,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This pattern can be applied not only to load balancing, but also more generally as a way to decouple a service type from the servers providing it. We can look at it as a service locator design pattern applied to network services."}]},{"block_type":"element","block":"k5zy5cjg","search_text":"Implementing a dynamic load balancer with http-proxy and Consul","text_count":63,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Implementing a dynamic load balancer with http-proxy and Consul"}]},{"block_type":"element","block":"k5zy5cjh","search_text":"To support a dynamic network infrastructure, we can use a reverse proxy such as Nginx or HAProxy ; all we need to do is update their configuration using an automated service and then force the load balancer to pick the changes. For Nginx, this can be done using the following command line:","text_count":289,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To support a dynamic network infrastructure, we can use a reverse proxy such as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Nginx"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"HAProxy"}]},{"block_type":"text","content":"; all we need to do is update their configuration using an automated service and then force the load balancer to pick the changes. For Nginx, this can be done using the following command line:"}]},{"block_type":"element","block":"k5zy5cji","search_text":"nginx -s reload ","text_count":16,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"nginx -s reload"}]}]},{"block_type":"element","block":"k5zy5cjj","search_text":"The same result can be achieved with a cloud-based solution, but we have a third and more familiar alternative that makes use of our favorite platform.","text_count":151,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The same result can be achieved with a cloud-based solution, but we have a third and more familiar alternative that makes use of our favorite platform."}]},{"block_type":"element","block":"k5zy5cjk","search_text":"We all know that Node.js is a great tool to build any sort of network application; as we said, this is exactly one of its main design goals. So, why not build a load balancer using nothing but Node.js? This would give us much more freedom and power, and would allow us to implement any sort of pattern or algorithm straight into our custom-built load balancer, including the one we are now going to explore, dynamic load balancing using a service registry. In this example we are going to use Consul ( https://www.consul.io ) as the service registry.","text_count":550,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We all know that Node.js is a great tool to build any sort of network application; as we said, this is exactly one of its main design goals. So, why not build a load balancer using nothing but Node.js? This would give us much more freedom and power, and would allow us to implement any sort of pattern or algorithm straight into our custom-built load balancer, including the one we are now going to explore, dynamic load balancing using a service registry. In this example we are going to use Consul ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.consul.io"},"children":[{"block_type":"text","content":"https://www.consul.io"}]},{"block_type":"text","content":") as the service registry."}]},{"block_type":"element","block":"k5zy5cjl","search_text":"For this example, we want to replicate the multiservice architecture we saw in the figure of the previous section, and to do that, we are going to mainly use three npm packages:","text_count":177,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For this example, we want to replicate the multiservice architecture we saw in the figure of the previous section, and to do that, we are going to mainly use three npm packages:"}]},{"block_type":"element","block":"k5zy5cjm","search_text":"http-proxy ( https://npmjs.org/package/http-proxy ): This is a library to simplify the creation of proxies and load balancers in Node.js portfinder ( https://npmjs.com/package/portfinder ): This is a library that allows a free port in the system to be discovered consul ( https://npmjs.org/package/consul ): This is a library that allows to services to be registered in Consul ","text_count":377,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http-proxy"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/http-proxy"},"children":[{"block_type":"text","content":"https://npmjs.org/package/http-proxy"}]},{"block_type":"text","content":"): This is a library to simplify the creation of proxies and load balancers in Node.js"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"portfinder"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.com/package/portfinder"},"children":[{"block_type":"text","content":"https://npmjs.com/package/portfinder"}]},{"block_type":"text","content":"): This is a library that allows a free port in the system to be discovered"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consul"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/consul"},"children":[{"block_type":"text","content":"https://npmjs.org/package/consul"}]},{"block_type":"text","content":"): This is a library that allows to services to be registered in Consul"}]}]},{"block_type":"element","block":"k5zy5cjn","search_text":"Let's start by implementing our services. They are simple HTTP servers like the ones we have used so far to test cluster and Nginx, but this time we want each server to register itself into the service registry the moment it starts.","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start by implementing our services. They are simple HTTP servers like the ones we have used so far to test"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cluster"}]},{"block_type":"text","content":"and Nginx, but this time we want each server to register itself into the service registry the moment it starts."}]},{"block_type":"element","block":"k5zy5cjo","search_text":"Let's see how this looks (file app.js ):","text_count":40,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see how this looks (file"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5cjp","search_text":"const http = require('http'); const pid = process.pid; const consul = require('consul')(); const portfinder = require('portfinder'); const serviceType = process.argv[2]; portfinder.getPort((err, port) => { // [1] const serviceId = serviceType+port; consul.agent.service.register({ // [2] id: serviceId, name: serviceType, address: 'localhost', port: port, tags: [serviceType] }, () => { const unregisterService = (err) => { // [3] consul.agent.service.deregister(serviceId, () => { process.exit(err ? 1 : 0); }); }; process.on('exit', unregisterService); // [4] process.on('SIGINT', unregisterService); process.on('uncaughtException', unregisterService); http.createServer((req, res) => { // [5] for (let i = 1e7; i> 0; i--) {} console.log(`Handling request from ${pid}`); res.end(`${serviceType} response from ${pid}\\n`); }).listen(port, () => { console.log(`Started ${serviceType} (${pid}) on port ${port}`); }); }); }); ","text_count":923,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst pid = process.pid; \nconst consul = require('consul')(); \nconst portfinder = require('portfinder'); \nconst serviceType = process.argv[2]; \n \nportfinder.getPort((err, port) =&gt; {        // [1] \n  const serviceId = serviceType+port; \n  consul.agent.service.register({          // [2] \n    id: serviceId, \n    name: serviceType, \n    address: 'localhost', \n    port: port, \n    tags: [serviceType] \n  }, () =&gt; { \n \n    const unregisterService = (err) =&gt; {   // [3] \n      consul.agent.service.deregister(serviceId, () =&gt; { \n        process.exit(err ? 1 : 0); \n      }); \n    }; \n \n    process.on('exit', unregisterService); // [4] \n    process.on('SIGINT', unregisterService); \n    process.on('uncaughtException', unregisterService); \n \n    http.createServer((req, res) =&gt; {      // [5] \n      for (let i = 1e7; i&gt; 0; i--) {} \n      console.log(`Handling request from ${pid}`); \n      res.end(`${serviceType} response from ${pid}\\n`); \n    }).listen(port, () =&gt; { \n      console.log(`Started ${serviceType} (${pid}) on port ${port}`); \n    }); \n  }); \n});"}]}]},{"block_type":"element","block":"k5zy5cjq","search_text":"In the preceding code, there are some parts that deserve our attention:","text_count":71,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, there are some parts that deserve our attention:"}]},{"block_type":"element","block":"k5zy5cjr","search_text":"First, we use portfinder.getPort to discover a free port in the system (by default, portfinder starts to search from port 8000). Next, we use the Consul library to register a new service in the registry. The service definition needs several attributes: id (a unique name for the service), name (a generic name that identifies the service), address and port (to identify how to access the service), tags (an optional array of tags that can be used to filter and group services). We are using serviceType (that we get as a command-line argument) to specify the service name and to add a tag. This will allow us to identify all the services of the same type available in the cluster. At this point we define a function called unregisterService that allows us to remove the service we just registered in Consul. We use unregisterService as a cleanup function, so that when the program is closed (either intentionally or by accident), the service is unregistered from Consul. Finally, we start the HTTP server for our service on the port discovered by portfinder . ","text_count":1060,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, we use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"portfinder.getPort"}]},{"block_type":"text","content":"to discover a free port in the system (by default,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"portfinder"}]},{"block_type":"text","content":"starts to search from port 8000)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Next, we use the Consul library to register a new service in the registry. The service definition needs several attributes:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"id"}]},{"block_type":"text","content":"(a unique name for the service),"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"name"}]},{"block_type":"text","content":"(a generic name that identifies the service),"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"address"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"port"}]},{"block_type":"text","content":"(to identify how to access the service),"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tags"}]},{"block_type":"text","content":"(an optional array of tags that can be used to filter and group services). We are using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"serviceType"}]},{"block_type":"text","content":"(that we get as a command-line argument) to specify the service name and to add a tag. This will allow us to identify all the services of the same type available in the cluster."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At this point we define a function called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"unregisterService"}]},{"block_type":"text","content":"that allows us to remove the service we just registered in Consul."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"unregisterService"}]},{"block_type":"text","content":"&nbsp;as a cleanup function, so that when the program is closed (either intentionally or by accident), the service is unregistered from Consul."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, we start the HTTP server for our service on the port discovered by"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"portfinder"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cjs","search_text":"Now it's time to implement the load balancer. Let's do that by creating a new module called loadBalancer.js . First, we need to define a routing table to map URL paths to services:","text_count":180,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now it's time to implement the load balancer. Let's do that by creating a new module called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"loadBalancer.js"}]},{"block_type":"text","content":". First, we need to define a routing table to map URL paths to services:"}]},{"block_type":"element","block":"k5zy5cjt","search_text":"const routing = [ { path: '/api', service: 'api-service', index: 0 }, { path: '/', service: 'webapp-service', index: 0 } ]; ","text_count":124,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const routing = [\n  { \n    path: '/api', \n    service: 'api-service', \n    index: 0 \n  },\n  { \n    path: '/', \n    service: 'webapp-service', \n    index: 0 \n  }\n];"}]}]},{"block_type":"element","block":"k5zy5cju","search_text":"Each item in the routing array contains service used to handle the requests arriving on the mapped path . The index property will be used to round robin the requests of a given servic Let's see how this works by implementing the second part of loadbalancer.js :","text_count":261,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Each item in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"routing"}]},{"block_type":"text","content":"array contains&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"service"}]},{"block_type":"text","content":"used to handle the requests arriving on the mapped"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"path"}]},{"block_type":"text","content":". The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"index"}]},{"block_type":"text","content":"property will be used to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"round robin"}]},{"block_type":"text","content":"the requests of a given servic Let's see how this works by implementing the second part of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"loadbalancer.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cjv","search_text":"const http = require('http'); const httpProxy = require('http-proxy'); const consul = require('consul')(); // [1] const proxy = httpProxy.createProxyServer({}); http.createServer((req, res) => { let route; routing.some(entry => { // [2] route = entry; //Starts with the route path? return req.url.indexOf(route.path) === 0; }); consul.agent.service.list((err, services) => { // [3] const servers = []; Object.keys(services).filter(id => { // if (services[id].Tags.indexOf(route.service) > -1) { servers.push(`http://${services[id].Address}:${services[id].Port}`) } }); if (!servers.length) { res.writeHead(502); return res.end('Bad gateway'); } route.index = (route.index + 1) % servers.length; // [4] proxy.web(req, res, {target: servers[route.index]}); }); }).listen(8080, () => console.log('Load balancer started on port 8080')); ","text_count":833,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst httpProxy = require('http-proxy'); \nconst consul = require('consul')();                  // [1] \n \nconst proxy = httpProxy.createProxyServer({}); \nhttp.createServer((req, res) =&gt; { \n  let route; \n  routing.some(entry =&gt; {                            // [2] \n    route = entry; \n    //Starts with the route path? \n    return req.url.indexOf(route.path) === 0; \n  }); \n \n  consul.agent.service.list((err, services) =&gt; {     // [3] \n    const servers = []; \n    Object.keys(services).filter(id =&gt; { // \n      if (services[id].Tags.indexOf(route.service) &gt; -1) { \n        servers.push(`http://${services[id].Address}:${services[id].Port}`) \n      } \n    }); \n \n    if (!servers.length) { \n      res.writeHead(502); \n      return res.end('Bad gateway'); \n    } \n \n    route.index = (route.index + 1) % servers.length; // [4] \n    proxy.web(req, res, {target: servers[route.index]}); \n  }); \n}).listen(8080, () =&gt; console.log('Load balancer started on port 8080'));"}]}]},{"block_type":"element","block":"k5zy5cjw","search_text":"This is how we implemented our Node.js-based load balancer:","text_count":59,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is how we implemented our Node.js-based load balancer:"}]},{"block_type":"element","block":"k5zy5cjx","search_text":"First, we need to require consul so that we can have access to the registry. Next, we instantiate an http-proxy object and start a normal web server. In the request handler of the server, the first thing we do is match the URL against our routing table. The result will be a descriptor containing the service name. We obtain from consul the list of servers implementing the required service. If this list is empty, we return an error to the client. We use the Tag attribute to filter all the available services and find the address of the servers that implements the current service type. At last, we can route the request to its destination. We update route.index to point to the next server in the list, following a round robin approach. We then use the index to select a server from the list, passing it to proxy.web() along with the request ( req ) and the response ( res ) objects. This will simply forward the request to the server we chose. ","text_count":948,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, we need to require"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consul"}]},{"block_type":"text","content":"so that we can have access to the registry. Next, we instantiate an"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http-proxy"}]},{"block_type":"text","content":"object and start a normal web server."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In the request handler of the server, the first thing we do is match the URL against our routing table. The result will be a descriptor containing the service name."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We obtain from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consul"}]},{"block_type":"text","content":"&nbsp;the list of servers implementing the required service. If this list is empty, we return an error to the client. We use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Tag"}]},{"block_type":"text","content":"attribute to filter all the available services and find the address of the servers that implements the current service type."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"At last, we can route the request to its destination. We update"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"route.index"}]},{"block_type":"text","content":"to point to the next server in the list, following a round robin approach. We then use the index to select a server from the list, passing it to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"proxy.web()"}]},{"block_type":"text","content":"along with the request ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"req"}]},{"block_type":"text","content":") and the response ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"res"}]},{"block_type":"text","content":") objects. This will simply forward the request to the server we chose."}]}]},{"block_type":"element","block":"k5zy5cjy","search_text":"It is now clear how simple it is to implement a load balancer using only Node.js and a service registry and how much flexibility we can have by doing so. Now we should be ready to give it a go, but first, let's install the consul server by following the official documentation at: https://www.consul.io/intro/getting-started/install.html .","text_count":339,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is now clear how simple it is to implement a load balancer using only Node.js and a service registry and how much flexibility we can have by doing so. Now we should be ready to give it a go, but first, let's install the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consul"}]},{"block_type":"text","content":"&nbsp;server by following the official documentation at:&nbsp;"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.consul.io/intro/getting-started/install.html"},"children":[{"block_type":"text","content":"https://www.consul.io/intro/getting-started/install.html"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5cjz","search_text":"This allows us to start the consul service registry in our development machine with this simple command line:","text_count":109,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This allows us to start the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consul"}]},{"block_type":"text","content":"&nbsp;service registry in our development machine with this simple command line:"}]},{"block_type":"element","block":"k5zy5ck0","search_text":"consul agent -dev ","text_count":18,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"consul agent -dev"}]}]},{"block_type":"element","block":"k5zy5ck1","search_text":"Now we are ready to start the load balancer:","text_count":44,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to start the load balancer:"}]},{"block_type":"element","block":"k5zy5ck2","search_text":"node loadBalancer ","text_count":18,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node loadBalancer"}]}]},{"block_type":"element","block":"k5zy5ck3","search_text":"Now if we try to access some of the services exposed by the load balancer, we will notice that it returns an HTTP 502 error, because we didn't start any server yet. Try it yourself:","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now if we try to access some of the services exposed by the load balancer, we will notice that it returns an HTTP 502 error, because we didn't start any server yet. Try it yourself:"}]},{"block_type":"element","block":"k5zy5ck4","search_text":"curl localhost:8080/api ","text_count":24,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl localhost:8080/api"}]}]},{"block_type":"element","block":"k5zy5ck5","search_text":"The preceding command should return the following output:","text_count":57,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding command should return the following output:"}]},{"block_type":"element","block":"k5zy5ck6","search_text":"Bad Gateway ","text_count":12,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"Bad Gateway"}]}]},{"block_type":"element","block":"k5zy5ck7","search_text":"The situation will change if we spawn some instances of our services, for example, two api-service and one webapp-service :","text_count":123,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The situation will change if we spawn some instances of our services, for example, two"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"api-service"}]},{"block_type":"text","content":"and one"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"webapp-service"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5ck8","search_text":"forever start app.js api-service forever start app.js api-service forever start app.js webapp-service ","text_count":102,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"forever start app.js api-service\nforever start app.js api-service\nforever start app.js webapp-service"}]}]},{"block_type":"element","block":"k5zy5ck9","search_text":"Now the load balancer should automatically see the new servers and start distributing requests across them. Let's try again with the following command:","text_count":151,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now the load balancer should automatically see the new servers and start distributing requests across them. Let's try again with the following command:"}]},{"block_type":"element","block":"k5zy5cka","search_text":"curl localhost:8080/api ","text_count":24,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"curl localhost:8080/api"}]}]},{"block_type":"element","block":"k5zy5ckb","search_text":"The preceding command should now return this:","text_count":45,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding command should now return this:"}]},{"block_type":"element","block":"k5zy5ckc","search_text":"api-service response from 6972 ","text_count":31,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"api-service response from 6972"}]}]},{"block_type":"element","block":"k5zy5ckd","search_text":"By running it again, we should now receive a message from another server, confirming that the requests are being distributed evenly among the different servers:","text_count":160,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By running it again, we should now receive a message from another server, confirming that the requests are being distributed evenly among the different servers:"}]},{"block_type":"element","block":"k5zy5cke","search_text":"api-service response from 6979 ","text_count":31,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"api-service response from 6979"}]}]},{"block_type":"element","block":"k5zy5ckf","search_text":"The advantages of this pattern are immediate. We can now scale our infrastructure dynamically, on demand, or based on a schedule, and our load balancer will automatically adjust with the new configuration without any extra effort!","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The advantages of this pattern are immediate. We can now scale our infrastructure dynamically, on demand, or based on a schedule, and our load balancer will automatically adjust with the new configuration without any extra effort!"}]},{"block_type":"element","block":"k5zy5ckg","search_text":"Peer-to-peer load balancing","text_count":27,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Peer-to-peer load balancing"}]},{"block_type":"element","block":"k5zy5ckh","search_text":"Using a reverse proxy is almost a necessity when we want to expose a complex internal network architecture to a public network such as the Internet. It helps hide the complexity, providing a single access point that external applications can easily use and rely on. However, if we need to scale a service that is for internal use only, we can have much more flexibility and control.","text_count":382,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Using a reverse proxy is almost a necessity when we want to expose a complex internal network architecture to a public network such as the Internet. It helps hide the complexity, providing a single access point that external applications can easily use and rely on. However, if we need to scale a service that is for internal use only, we can have much more flexibility and control."}]},{"block_type":"element","block":"k5zy5cki","search_text":"Let's imagine having a Service A which relies on a Service B to implement its functionality. Service B is scaled across multiple machines and it's available only in the internal network. What we have learned so far is that Service A will connect to Service B using a reverse proxy, which will distribute the traffic to all the servers implementing Service B .","text_count":359,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's imagine having a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service A"}]},{"block_type":"text","content":"which relies on a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service B"}]},{"block_type":"text","content":"to implement its functionality."},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service B"}]},{"block_type":"text","content":"is scaled across multiple machines and it's available only in the internal network. What we have learned so far is that"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service A"}]},{"block_type":"text","content":"will connect to"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service B"}]},{"block_type":"text","content":"using a reverse proxy, which will distribute the traffic to all the servers implementing"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service B"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5ckj","search_text":"However, there is an alternative. We can remove the reverse proxy from the picture and distribute the requests directly from the client ( Service A ), which now becomes directly responsible for load balancing its connections across the various instances of Service B . This is possible only if Server A knows the details about the servers exposing Service B , and in an internal network, this is usually known information. With this approach we are essentially implementing peer-to-peer load balancing .","text_count":503,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"However, there is an alternative. We can remove the reverse proxy from the picture and distribute the requests directly from the client ("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service A"}]},{"block_type":"text","content":"), which now becomes directly responsible for load balancing its connections across the various instances of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service B"}]},{"block_type":"text","content":". This is possible only if"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Server A"}]},{"block_type":"text","content":"knows the details about the servers exposing"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Service B"}]},{"block_type":"text","content":", and in an internal network, this is usually known information. With this approach we are essentially implementing"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"peer-to-peer load balancing"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5ckk","search_text":"The following diagram compares the two alternatives we just described:","text_count":70,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following diagram compares the two alternatives we just described:"}]},{"block_type":"element","block":"k5zy5ckl","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000059.jpg","alt":"Peer-to-peer load balancing","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5ckm","search_text":"This is an extremely simple and effective pattern that enables truly distributed communications without bottlenecks or single points of failure. Besides that, it also does the following:","text_count":186,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is an extremely simple and effective pattern that enables truly distributed communications without bottlenecks or single points of failure. Besides that, it also does the following:"}]},{"block_type":"element","block":"k5zy5ckn","search_text":"Reduces the infrastructure complexity by removing a network node Allows faster communications, because messages will travel through one fewer node Scales better, because performances are not limited by what the load balancer can handle ","text_count":236,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Reduces the infrastructure complexity by removing a network node"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Allows faster communications, because messages will travel through one fewer node"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Scales better, because performances are not limited by what the load balancer can handle"}]}]},{"block_type":"element","block":"k5zy5cko","search_text":"On the other hand, by removing the reverse proxy, we are actually exposing the complexity of its underlying infrastructure. Also, each client has to be smarter by implementing a load-balancing algorithm and, possibly, also a way to keep its knowledge of the infrastructure up-to-date.","text_count":284,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other hand, by removing the reverse proxy, we are actually exposing the complexity of its underlying infrastructure. Also, each client has to be"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"smarter"}]},{"block_type":"text","content":"by implementing a load-balancing algorithm and, possibly, also a way to keep its knowledge of the infrastructure up-to-date."}]},{"block_type":"element","block":"k5zy5ckp","search_text":"Tip Peer-to-peer load balancing is a pattern used extensively in the ØMQ ( http://zeromq.org ) library. ","text_count":104,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Peer-to-peer load balancing is a pattern used extensively in the &Oslash;MQ ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://zeromq.org"},"children":[{"block_type":"text","content":"http://zeromq.org"}]},{"block_type":"text","content":") library."}]}]},{"block_type":"element","block":"k5zy5ckq","search_text":"Implementing an HTTP client that can balance requests across multiple servers","text_count":77,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Implementing an HTTP client that can balance requests across multiple servers"}]},{"block_type":"element","block":"k5zy5ckr","search_text":"We already know how to implement a load balancer using only Node.js and distribute incoming requests across the available servers, so implementing the same mechanism on the client side should not be that different. All we have to do in fact is wrap the client API and augment it with a load-balancing mechanism. Take a look at the following module ( balancedRequest.js ):","text_count":371,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We already know how to implement a load balancer using only Node.js and distribute incoming requests across the available servers, so implementing the same mechanism on the client side should not be that different. All we have to do in fact is wrap the client API and augment it with a load-balancing mechanism. Take a look at the following module ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"balancedRequest.js"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5cks","search_text":"const http = require('http'); const servers = [ {host: 'localhost', port: '8081'}, {host: 'localhost', port: '8082'} ]; let i = 0; module.exports = (options, callback) => { i = (i + 1) % servers.length; options.hostname = servers[i].host; options.port = servers[i].port; return http.request(options, callback); }; ","text_count":314,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const http = require('http'); \nconst servers = [ \n  {host: 'localhost', port: '8081'}, \n  {host: 'localhost', port: '8082'} \n]; \nlet i = 0; \n \nmodule.exports = (options, callback) =&gt; { \n  i = (i + 1) % servers.length; \n  options.hostname = servers[i].host; \n  options.port = servers[i].port; \n \n  return http.request(options, callback); \n};"}]}]},{"block_type":"element","block":"k5zy5ckt","search_text":"The preceding code is very simple and needs little explanation. We wrapped the original http.request API so that it overrides the hostname and port of the request with those selected from the list of available servers using a round robin algorithm.","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code is very simple and needs little explanation. We wrapped the original"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http.request"}]},{"block_type":"text","content":"API so that it overrides the&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"hostname"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"port"}]},{"block_type":"text","content":"of the request with those selected from the list of available servers using a round robin algorithm."}]},{"block_type":"element","block":"k5zy5cku","search_text":"The new wrapped API can then be used seamlessly ( client.js ):","text_count":62,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The new wrapped API can then be used seamlessly ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"client.js"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5ckv","search_text":"const request = require('./balancedRequest'); for(let i = 10; i>= 0; i--) { request({method: 'GET', path: '/'}, res => { let str = ''; res.on('data', chunk => { str += chunk; }).on('end', () => { console.log(str); }); }).end(); } ","text_count":230,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const request = require('./balancedRequest'); \nfor(let i = 10; i&gt;= 0; i--) { \n  request({method: 'GET', path: '/'}, res =&gt; { \n    let str = ''; \n    res.on('data', chunk =&gt; {\n      str += chunk;\n    }).on('end', () =&gt; {\n      console.log(str);\n    }); \n  }).end(); \n}"}]}]},{"block_type":"element","block":"k5zy5ckw","search_text":"To try the preceding code, we have to start two instances of the sample server provided:","text_count":88,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To try the preceding code, we have to start two instances of the sample server provided:"}]},{"block_type":"element","block":"k5zy5ckx","search_text":"node app 8081 node app 8082 ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app 8081\nnode app 8082"}]}]},{"block_type":"element","block":"k5zy5cky","search_text":"Followed by the client application we just built:","text_count":49,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Followed by the client application we just built:"}]},{"block_type":"element","block":"k5zy5ckz","search_text":"node client ","text_count":12,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node client"}]}]},{"block_type":"element","block":"k5zy5cl0","search_text":"We should notice how each request is sent to a different server, confirming that we are now able to balance the load without a dedicated reverse proxy!","text_count":151,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We should notice how each request is sent to a different server, confirming that we are now able to balance the load without a dedicated reverse proxy!"}]},{"block_type":"element","block":"k5zy5cl1","search_text":"Tip An improvement to the wrapper we created before would be to integrate a service registry directly into the client and obtain the server list dynamically. You can find an example of this technique in the code distributed with the book. ","text_count":239,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An improvement to the wrapper we created before would be to integrate a service registry directly into the client and obtain the server list dynamically. You can find an example of this technique in the code distributed with the book."}]}]},{"block_type":"element","block":"k5zy5cl2","search_text":"Decomposing complex applications","text_count":32,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Decomposing complex applications"}]},{"block_type":"element","block":"k5zy5cl3","search_text":"So far in the chapter, we have mainly focused our analysis on the x -axis of the scale cube. We saw how it represents the easiest and most immediate way to distribute the load of an application, also improving its availability. In the following section, we are now going to focus on the y -axis of the scale cube, where applications are scaled by decomposing them by functionality and service. As we will learn, this technique allows us to scale not only the capacity of an application, but also, and most importantly, its complexity.","text_count":534,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"So far in the chapter, we have mainly focused our analysis on the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"-axis of the scale cube. We saw how it represents the easiest and most immediate way to distribute the load of an application, also improving its availability. In the following section, we are now going to focus on the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"-axis of the scale cube, where applications are scaled by"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"decomposing"}]},{"block_type":"text","content":"them by functionality and service. As we will learn, this technique allows us to scale not only the capacity of an application, but also, and most importantly, its complexity."}]},{"block_type":"element","block":"k5zy5cl4","search_text":"Monolithic architecture","text_count":23,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Monolithic architecture"}]},{"block_type":"element","block":"k5zy5cl5","search_text":"The term monolithic might make us think of a system without modularity, where all the services of an application are interconnected and almost indistinguishable. However, this is not always the case. Often, monolithic systems have a highly modular architecture and a good decoupling between their internal components.","text_count":317,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The term monolithic might make us think of a system without modularity, where all the services of an application are interconnected and almost indistinguishable. However, this is not always the case. Often, monolithic systems have a highly modular architecture and a good decoupling between their internal components."}]},{"block_type":"element","block":"k5zy5cl6","search_text":"A perfect example is the Linux OS kernel, which is part of a category called monolithic kernels (in perfect opposition with its ecosystem and the Unix philosophy). Linux has thousands of services and modules that we can load and unload dynamically even while the system is running. However, they all run in kernel mode , which means that a failure in any of them might bring the entire OS down (have you ever seen a kernel panic ?). This approach is opposite to the microkernel architecture, where only the core services of the operating system run in kernel mode, while the rest run in user mode, usually each one with its own process. The main advantage of this approach is that a problem in any of these services would more likely cause it to crash in isolation instead of affecting the stability of the entire system.","text_count":821,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A perfect example is the Linux OS kernel, which is part of a category called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"monolithic kernels"}]},{"block_type":"text","content":"(in perfect opposition with its ecosystem and the Unix philosophy). Linux has thousands of services and modules that we can load and unload dynamically even while the system is running. However, they all run in"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"kernel mode"}]},{"block_type":"text","content":", which means that a failure in any of them might bring the entire OS down (have you ever seen a&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"kernel panic"}]},{"block_type":"text","content":"?). This approach is opposite to the microkernel architecture, where only the core services of the operating system run in kernel mode, while the rest run in user mode, usually each one with its own process. The main advantage of this approach is that a problem in any of these services would more likely cause it to crash in isolation instead of affecting the stability of the entire system."}]},{"block_type":"element","block":"k5zy5cl7","search_text":"Note The Torvalds-Tanenbaum debate on kernel design is probably one of the most famous flame wars in the history of computer science, where one of the main points of dispute was exactly monolithic versus microkernel design. You can find a web version of the discussion (it originally appeared on Usenet) at https://groups.google.com/d/msg/comp.os.minix/wlhw16QWltI/P8isWhZ8PJ8J . ","text_count":380,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Torvalds-Tanenbaum debate on kernel design is probably one of the most famous"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"flame wars"}]},{"block_type":"text","content":"in the history of computer science, where one of the main points of dispute was exactly monolithic versus microkernel design. You can find a web version of the discussion (it originally appeared on Usenet) at"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://groups.google.com/d/msg/comp.os.minix/wlhw16QWltI/P8isWhZ8PJ8J"},"children":[{"block_type":"text","content":"https://groups.google.com/d/msg/comp.os.minix/wlhw16QWltI/P8isWhZ8PJ8J"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cl8","search_text":"It's remarkable how these design principles, more than 30 years old, can still be applied today and in totally different environments. Modern monolithic applications are comparable to monolithic kernels; if any of their components fail, the entire system is affected, which, translated into Node.js terms, means that all the services are part of the same codebase and run in a single process (when not cloned).","text_count":410,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's remarkable how these design principles, more than 30 years old, can still be applied today and in totally different environments. Modern monolithic applications are comparable to monolithic kernels; if any of their components fail, the entire system is affected, which, translated into Node.js terms, means that all the services are part of the same codebase and run in a single process (when not cloned)."}]},{"block_type":"element","block":"k5zy5cl9","search_text":"To make an example of a monolithic architecture, let's take a look at the following figure:","text_count":91,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To make an example of a monolithic architecture, let's take a look at the following figure:"}]},{"block_type":"element","block":"k5zy5cla","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000060.jpg","alt":"Monolithic architecture","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5clb","search_text":"The preceding figure shows the architecture of a typical e-commerce application. Its structure is modular; we have two different frontends, one for the main store and another for the administration interface. Internally, we have a clear separation of the services implemented by the application, each one responsible for a specific portion of its business logic: Products , Cart , Checkout , Search , and Authentication and Users . However, the preceding architecture is monolithic; every module, in fact, is part of the same codebase and runs as part of a single application. A failure in any of its components, for example, an uncaught exception, can potentially tear down the entire online store.","text_count":699,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding figure shows the architecture of a typical e-commerce application. Its structure is modular; we have two different frontends, one for the main store and another for the administration interface. Internally, we have a clear separation of the services implemented by the application, each one responsible for a specific portion of its business logic:"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Products"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cart"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Checkout"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Search"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Authentication and Users"}]},{"block_type":"text","content":". However, the preceding architecture is monolithic; every module, in fact, is part of the same codebase and runs as part of a single application. A failure in any of its components, for example, an uncaught exception, can potentially tear down the entire online store."}]},{"block_type":"element","block":"k5zy5clc","search_text":"Another problem with this type of architecture is the interconnection between its modules; the fact that they all live inside the same application makes it very easy for a developer to build interactions and coupling between modules. For example, consider the use case when a product is being purchased: the Checkout module has to update the availability of the Product object, and if those two modules are in the same application, it's too easy for a developer to just obtain a reference to a Product object and update its availability directly. Maintaining a low coupling between internal modules is very hard in a monolithic application, partly because the boundaries between them are not always clear or properly enforced.","text_count":726,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another problem with this type of architecture is the interconnection between its modules; the fact that they all live inside the same application makes it very easy for a developer to build interactions and coupling between modules. For example, consider the use case when a product is being purchased: the Checkout module has to update the availability of the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Product"}]},{"block_type":"text","content":"object, and if those two modules are in the same application, it's too easy for a developer to just obtain a reference to a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Product"}]},{"block_type":"text","content":"object and update its availability directly. Maintaining a low coupling between internal modules is very hard in a monolithic application, partly because the boundaries between them are not always clear or properly enforced."}]},{"block_type":"element","block":"k5zy5cld","search_text":"A high coupling is often one of the main obstacles to the growth of an application and prevents its scalability in terms of complexity. In fact, an intricate dependency graph means that every part of the system is a liability; it has to be maintained for the entire life of the product, and any change should be carefully evaluated because every component is like a wooden block in a Jenga tower: moving or removing one of them can cause the entire tower to collapse. This often results in the building of conventions and development processes to cope with the increasing complexity of the project.","text_count":598,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"high coupling"}]},{"block_type":"text","content":"is often one of the main obstacles to the growth of an application and prevents its scalability in terms of complexity. In fact, an intricate dependency graph means that every part of the system is a liability; it has to be maintained for the entire life of the product, and any change should be carefully evaluated because every component is like a wooden block in a Jenga tower: moving or removing one of them can cause the entire tower to collapse. This often results in the building of conventions and development processes to cope with the increasing complexity of the project."}]},{"block_type":"element","block":"k5zy5cle","search_text":"The microservice architecture","text_count":29,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The microservice architecture"}]},{"block_type":"element","block":"k5zy5clf","search_text":"Now we are going to reveal the most important pattern in Node.js to write big applications: avoid writing big applications . This seems like a trivial statement, but it's an incredibly effective strategy to scale both the complexity and the capacity of a software system. So what's the alternative to writing big applications? The answer is in the y -axis of the scale cube, decomposition and splitting by service and functionality. The idea is to break down an application into its essential components, creating separate, independent applications. It is practically the opposite of monolithic architecture. This fits perfectly with the Unix philosophy, and the Node.js principles we discussed at the beginning of the book, in particular \" make each program do one thing well \".","text_count":779,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are going to reveal the most important pattern in Node.js to write big applications:"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"avoid writing big applications"}]},{"block_type":"text","content":". This seems like a trivial statement, but it's an incredibly effective strategy to scale both the complexity and the capacity of a software system. So what's the alternative to writing big applications? The answer is in the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"-axis of the scale cube, decomposition and splitting by service and functionality. The idea is to break down an application into its essential components, creating separate, independent applications. It is practically the opposite of monolithic architecture. This fits perfectly with the Unix philosophy, and the Node.js principles we discussed at the beginning of the book, in particular \""},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"make each program do one thing well"}]},{"block_type":"text","content":"\"."}]},{"block_type":"element","block":"k5zy5clg","search_text":"Microservice architecture is today, probably the main reference pattern for this type of approach, where a set of self-sufficient services replace big monolithic applications. The prefix micro means that the services should be as small as possible, but always within reasonable limits. Don't be misled by thinking that creating an architecture with a hundred different applications exposing only one web service is necessarily a good choice. In reality, there is no strict rule on how small or big a service should be. It's not the size that matters in the design of a microservice architecture; instead, it's a combination of different factors, mainly loose coupling , high cohesion , and integration complexity .","text_count":714,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Microservice architecture"}]},{"block_type":"text","content":"is today, probably the main reference pattern for this type of approach, where a set of self-sufficient services replace big monolithic applications. The prefix micro means that the services should be as small as possible, but always within reasonable limits. Don't be misled by thinking that creating an architecture with a hundred different applications exposing only one web service is necessarily a good choice. In reality, there is no strict rule on how small or big a service should be. It's not the size that matters in the design of a microservice architecture; instead, it's a combination of different factors, mainly"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"loose coupling"}]},{"block_type":"text","content":","},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"high cohesion"}]},{"block_type":"text","content":", and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"integration complexity"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5clh","search_text":"An example of microservice architecture","text_count":39,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"An example of microservice architecture"}]},{"block_type":"element","block":"k5zy5cli","search_text":"Let's now see what the monolithic e-commerce application would look like, using a microservice architecture:","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now see what the monolithic e-commerce application would look like, using a microservice architecture:"}]},{"block_type":"element","block":"k5zy5clj","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000066.jpg","alt":"An example of microservice architecture","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5clk","search_text":"As we can see from the previous figure, each fundamental component of the e-commerce application is now a self-sustaining and independent entity, living in its own context, with its own database. In practice, they are all independent applications exposing a set of related services (high cohesion).","text_count":298,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see from the previous figure, each fundamental component of the e-commerce application is now a self-sustaining and independent entity, living in its own context, with its own database. In practice, they are all independent applications exposing a set of related services (high cohesion)."}]},{"block_type":"element","block":"k5zy5cll","search_text":"The data ownership of a service is an important characteristic of microservice architecture. This is why the database also has to be split to maintain the proper level of isolation and independence. If a unique shared database is used, it would become much easier for the services to work together; however, this would also introduce a coupling between the services (based on data), nullifying some of the advantages of having different applications.","text_count":450,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"data ownership"}]},{"block_type":"text","content":"of a service is an important characteristic of microservice architecture. This is why the database also has to be split to maintain the proper level of isolation and independence. If a unique shared database is used, it would become much easier for the services to work together; however, this would also introduce a coupling between the services (based on data), nullifying some of the advantages of having different applications."}]},{"block_type":"element","block":"k5zy5clm","search_text":"The dashed line connecting all the nodes tells us that, in some way, they have to communicate and exchange information for the entire system to be fully functional. As the services do not share the same database, there is more communication involved to maintain the consistency of the whole system. For example, the Checkout application needs to know some information about Products , such as the price and restrictions on shipping, and at the same time, it needs to update the data stored in the Products service, for example, the product availability when the checkout is complete. In the preceding figure, we tried to keep the way the nodes communicate abstract. Surely, the most popular strategy is using web services, but as we will see later, this is not the only option.","text_count":777,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The dashed line connecting all the nodes tells us that, in some way, they have to communicate and exchange information for the entire system to be fully functional. As the services do not share the same database, there is more communication involved to maintain the consistency of the whole system. For example, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Checkout"}]},{"block_type":"text","content":"application needs to know some information about"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Products"}]},{"block_type":"text","content":", such as the price and restrictions on shipping, and at the same time, it needs to update the data stored in the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Products"}]},{"block_type":"text","content":"service, for example, the product availability when the checkout is complete. In the preceding figure, we tried to keep the way the nodes communicate abstract. Surely, the most popular strategy is using web services, but as we will see later, this is not the only option."}]},{"block_type":"element","block":"k5zy5cln","search_text":"Note Pattern (microservice architecture) Split a complex application by creating several small, self-contained services. ","text_count":121,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pattern (microservice architecture)"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Split a complex application by creating several small, self-contained services."}]}]},{"block_type":"element","block":"k5zy5clo","search_text":"Pros and cons of microservices","text_count":30,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Pros and cons of microservices"}]},{"block_type":"element","block":"k5zy5clp","search_text":"In this section we are going to highlight some of the advantages and disadvantages of implementing a microservice architecture. As we will see, this approach promises to bring a radical change in the way we develop our applications, revolutionizing the way we see scalability and complexity, but on the other hand, it introduces new nontrivial challenges as well.","text_count":363,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section we are going to highlight some of the advantages and disadvantages of implementing a microservice architecture. As we will see, this approach promises to bring a radical change in the way we develop our applications, revolutionizing the way we see scalability and complexity, but on the other hand, it introduces new nontrivial challenges as well."}]},{"block_type":"element","block":"k5zy5clq","search_text":"Note Martin Fowler wrote a great article about microservices that you can find at http://martinfowler.com/articles/microservices.html . ","text_count":136,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Martin Fowler wrote a great article about microservices that you can find at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://martinfowler.com/articles/microservices.html"},"children":[{"block_type":"text","content":"http://martinfowler.com/articles/microservices.html"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5clr","search_text":"Every service is expendable","text_count":27,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Every service is expendable"}]},{"block_type":"element","block":"k5zy5cls","search_text":"The main technical advantage of having each service living in its own application context is that crashes, bugs, and breaking changes do not propagate to the entire system. The goal is to build truly independent services that are smaller, easier to change, or even rebuild from scratch . If, for example, the Checkout service of our e-commerce application suddenly crashes because of a serious bug, the rest of the system would continue to work as normal. Some functionality may be affected, for example, the ability to purchase a product, but the rest of the system would continue to work.","text_count":590,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The main technical advantage of having each service living in its own application context is that crashes, bugs, and breaking changes do not propagate to the entire system. The goal is to build truly independent services that are smaller, easier to change, or even"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"rebuild from scratch"}]},{"block_type":"text","content":". If, for example, the Checkout service of our e-commerce application suddenly crashes because of a serious bug, the rest of the system would continue to work as normal. Some functionality may be affected, for example, the ability to purchase a product, but the rest of the system would continue to work."}]},{"block_type":"element","block":"k5zy5clt","search_text":"Also, imagine if we suddenly realized that the database or the programming language we used to implement a component was not a good design decision. In a monolithic application, there would be very little we could do to change things without affecting the entire system; instead, in a microservice architecture, we could more easily re-implement the entire service from scratch, using a different database or platform, and the rest of the system would not even notice it.","text_count":471,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, imagine if we suddenly realized that the database or the programming language we used to implement a component was not a good design decision. In a monolithic application, there would be very little we could do to change things without affecting the entire system; instead, in a microservice architecture, we could more easily re-implement the entire service from scratch, using a different database or platform, and the rest of the system would not even notice it."}]},{"block_type":"element","block":"k5zy5clu","search_text":"Reusability across platforms and languages","text_count":42,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Reusability across platforms and languages"}]},{"block_type":"element","block":"k5zy5clv","search_text":"Splitting a big monolithic application into many small services allows us to create independent units that can be reused much more easily. Elasticsearch ( http://www.elasticsearch.org ) is a great example of a reusable search service; also, the authentication server we built in Chapter 7, Wiring Modules , is another example of a service that can be easily reused in any application, regardless of the programming language it's built in.","text_count":438,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Splitting a big monolithic application into many small services allows us to create independent units that can be reused much more easily."},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Elasticsearch"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.elasticsearch.org"},"children":[{"block_type":"text","content":"http://www.elasticsearch.org"}]},{"block_type":"text","content":") is a great example of a reusable search service; also, the authentication server we built in Chapter 7,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Wiring Modules"}]},{"block_type":"text","content":", is another example of a service that can be easily reused in any application, regardless of the programming language it's built in."}]},{"block_type":"element","block":"k5zy5clw","search_text":"The main advantage is that the level of information hiding is usually much higher compared to monolithic applications. This is possible because the interactions usually happen through a remote interface such as a web service or a message broker, which makes it much easier to hide the implementation details and shield the client from changes in the way the service is implemented or deployed. For example, if all we have to do is invoke a web service, we are shielded from the way the infrastructure behind is scaled, from what programming language it uses, from what database it uses to store its data, and so on.","text_count":615,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The main advantage is that the level of information hiding is usually much higher compared to monolithic applications. This is possible because the interactions usually happen through a remote interface such as a web service or a message broker, which makes it much easier to hide the implementation details and shield the client from changes in the way the service is implemented or deployed. For example, if all we have to do is invoke a web service, we are shielded from the way the infrastructure behind is scaled, from what programming language it uses, from what database it uses to store its data, and so on."}]},{"block_type":"element","block":"k5zy5clx","search_text":"A way to scale the application","text_count":30,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"A way to scale the application"}]},{"block_type":"element","block":"k5zy5cly","search_text":"Going back to the scale cube, it's clear that microservices are equivalent to scaling an application along the y -axis, so it's already a means for the distribution of the load across multiple machines. Also, we should not forget that we can combine microservices with the other two dimensions of the cube to scale the application even further. For example, each service could be cloned to handle more traffic, and the interesting aspect is that they can be scaled independently, allowing better resource management.","text_count":516,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Going back to the scale cube, it's clear that microservices are equivalent to scaling an application along the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"-axis, so it's already a means for the distribution of the load across multiple machines. Also, we should not forget that we can combine microservices with the other two dimensions of the cube to scale the application even further. For example, each service could be cloned to handle more traffic, and the interesting aspect is that they can be scaled independently, allowing better resource management."}]},{"block_type":"element","block":"k5zy5clz","search_text":"The challenges of microservices","text_count":31,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"The challenges of microservices"}]},{"block_type":"element","block":"k5zy5cm0","search_text":"At this point, it would look like microservices are the solution to all our problems; however, this is far from being true. In fact, having more nodes to manage introduces a higher complexity in terms of integration, deployment, and code sharing; it fixes some of the pains of traditional architectures but it also opens up many new questions. How do we make the services interact? How can we deploy, scale, and monitor such a high number of applications? How can we share and reuse code between services? Fortunately, cloud services and modern DevOps methodologies can provide some answers to those questions, and also, Node.js can help a lot. Its module system is a perfect companion to share code between different projects. Node.js was made to be a node in a distributed system such as those implemented using a microservice architecture.","text_count":842,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, it would look like microservices are the solution to all our problems; however, this is far from being true. In fact, having more nodes to manage introduces a higher complexity in terms of integration, deployment, and code sharing; it fixes some of the pains of traditional architectures but it also opens up many new questions. How do we make the services interact? How can we deploy, scale, and monitor such a high number of applications? How can we share and reuse code between services? Fortunately, cloud services and modern DevOps methodologies can provide some answers to those questions, and also, Node.js can help a lot. Its module system is a perfect companion to share code between different projects. Node.js was made to be a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"node"}]},{"block_type":"text","content":"in a distributed system such as those implemented using a microservice architecture."}]},{"block_type":"element","block":"k5zy5cm1","search_text":"Tip Although microservices can be built using any framework (or even just the core Node.js modules), there are a few solutions specialized for this purpose; among the most notable, we have Seneca ( https://npmjs.org/package/seneca ), AWS Lambda ( https://aws.amazon.com/lambda ), IBM OpenWhisk ( https://developer.ibm.com/openwhisk ) and Microsoft Azure Functions ( https://azure.microsoft.com/en-us/services/functions ). A useful tool to manage the deployment of microservices is Apache Mesos ( http://mesos.apache.org ). ","text_count":523,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Although microservices can be built using any framework (or even just the core Node.js modules), there are a few solutions specialized for this purpose; among the most notable, we have"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Seneca&nbsp;"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/seneca"},"children":[{"block_type":"text","content":"https://npmjs.org/package/seneca"}]},{"block_type":"text","content":"),"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"AWS Lambda"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://aws.amazon.com/lambda"},"children":[{"block_type":"text","content":"https://aws.amazon.com/lambda"}]},{"block_type":"text","content":"),"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"IBM OpenWhisk"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://developer.ibm.com/openwhisk"},"children":[{"block_type":"text","content":"https://developer.ibm.com/openwhisk"}]},{"block_type":"text","content":") and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Microsoft Azure Functions"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://azure.microsoft.com/en-us/services/functions"},"children":[{"block_type":"text","content":"https://azure.microsoft.com/en-us/services/functions"}]},{"block_type":"text","content":"). A useful tool to manage the deployment of microservices is"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Apache Mesos&nbsp;"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://mesos.apache.org"},"children":[{"block_type":"text","content":"http://mesos.apache.org"}]},{"block_type":"text","content":")."}]}]},{"block_type":"element","block":"k5zy5cm2","search_text":"Integration patterns in a microservice architecture","text_count":51,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Integration patterns in a microservice architecture"}]},{"block_type":"element","block":"k5zy5cm3","search_text":"One of the toughest challenges of microservices is connecting all the nodes to make them collaborate. For example, the Cart service of our e-commerce application would make little sense without some Products to add, and the Checkout service would be useless without a list of products to buy (a cart). As we already mentioned, there are also other factors that necessitate an interaction between the various services. For example, the Search service has to know which Products are available and must also ensure it keeps its information up-to-date. The same can be said about the Checkout service, which has to update the information about Product availability when a purchase is completed.","text_count":690,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One of the toughest challenges of microservices is connecting all the nodes to make them collaborate. For example, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cart"}]},{"block_type":"text","content":"service of our e-commerce application would make little sense without some"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Products"}]},{"block_type":"text","content":"to add, and the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Checkout"}]},{"block_type":"text","content":"service would be useless without a list of products to buy (a cart). As we already mentioned, there are also other factors that necessitate an interaction between the various services. For example, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Search"}]},{"block_type":"text","content":"service has to know which"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Products"}]},{"block_type":"text","content":"are available and must also ensure it keeps its information up-to-date. The same can be said about the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Checkout"}]},{"block_type":"text","content":"service, which has to update the information about"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Product"}]},{"block_type":"text","content":"availability when a purchase is completed."}]},{"block_type":"element","block":"k5zy5cm4","search_text":"When designing an integration strategy, it's also important to consider the coupling that it's going to introduce between the services in the system. We should not forget that designing a distributed architecture involves the same practices and principles that we use locally when designing a module or subsystem, therefore, we also need to take into consideration properties such as the reusability and extensibility of the service.","text_count":433,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When designing an integration strategy, it's also important to consider the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"coupling"}]},{"block_type":"text","content":"that it's going to introduce between the services in the system. We should not forget that designing a distributed architecture involves the same practices and principles that we use locally when designing a module or subsystem, therefore, we also need to take into consideration properties such as the reusability and extensibility of the service."}]},{"block_type":"element","block":"k5zy5cm5","search_text":"The API proxy","text_count":13,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The API proxy"}]},{"block_type":"element","block":"k5zy5cm6","search_text":"The first pattern we are going to show makes use of an API Proxy (also commonly identified as an API Gateway ), a server that proxies the communications between a client and a set of remote APIs. In a microservice architecture, its main purpose is to provide a single access point for multiple API endpoints, but it can also offer load balancing, caching, authentication, and traffic limiting, all features that prove to be very useful to implement a solid API solution.","text_count":470,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first pattern we are going to show makes use of an"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"API Proxy&nbsp;"}]},{"block_type":"text","content":"(also commonly identified as an&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"API Gateway"}]},{"block_type":"text","content":"), a server that"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"proxies"}]},{"block_type":"text","content":"the communications between a client and a set of remote APIs. In a microservice architecture, its main purpose is to provide a single access point for multiple API endpoints, but it can also offer load balancing, caching, authentication, and traffic limiting, all features that prove to be very useful to implement a solid API solution."}]},{"block_type":"element","block":"k5zy5cm7","search_text":"This pattern should not be new to us; we already saw it in action when we built the custom load balancer with http-proxy and consul. For that example, our load balancer was exposing only two services, and then, thanks to a Service Registry, it was able to map a URL path to a service and hence to a list of servers. An API proxy works in the same way; it is essentially a reverse proxy and often also a load balancer, specifically configured to handle API requests. The next figure shows how we can apply such a solution to our e-commerce application:","text_count":551,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This pattern should not be new to us; we already saw it in action when we built the custom load balancer with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http-proxy"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"consul."}]},{"block_type":"text","content":"For that example, our load balancer was exposing only two services, and then, thanks to a Service Registry, it was able to map a URL path to a service and hence to a list of servers. An API proxy works in the same way; it is essentially a reverse proxy and often also a load balancer, specifically configured to handle API requests. The next figure shows how we can apply such a solution to our e-commerce application:"}]},{"block_type":"element","block":"k5zy5cm8","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000029.jpg","alt":"The API proxy","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cm9","search_text":"From the preceding figure, it should be clear how an API proxy can hide the complexity of its underlying infrastructure. This is really handy in a microservice infrastructure, as the number of nodes may be high, especially if each service is scaled across multiple machines. The integration achieved by an API Proxy is therefore only structural; there is no semantic mechanism. It simply provides a familiar monolithic view of a complex microservice infrastructure. This is opposed to the next pattern we are going to learn, where the integration is semantic instead.","text_count":567,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From the preceding figure, it should be clear how an API proxy can hide the complexity of its underlying infrastructure. This is really handy in a microservice infrastructure, as the number of nodes may be high, especially if each service is scaled across multiple machines. The integration achieved by an&nbsp;API Proxy is therefore only structural; there is no semantic mechanism. It simply provides a familiar monolithic view of a complex microservice infrastructure. This is opposed to the next pattern we are going to learn, where the integration is semantic instead."}]},{"block_type":"element","block":"k5zy5cma","search_text":"API orchestration","text_count":17,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"API orchestration"}]},{"block_type":"element","block":"k5zy5cmb","search_text":"The pattern we are going to describe next is probably the most natural and explicit way to integrate and compose a set of services, and it's called API orchestration . Daniel Jacobson, VP of Engineering for the Netflix API, in one of his blog posts ( http://thenextweb.com/dd/2013/12/17/future-api-design-orchestration-layer ), defines API orchestration as follows:","text_count":365,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The pattern we are going to describe next is probably the most natural and explicit way to integrate and compose a set of services, and it's called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"API orchestration"}]},{"block_type":"text","content":". Daniel Jacobson, VP of Engineering for the Netflix API, in one of his blog posts ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://thenextweb.com/dd/2013/12/17/future-api-design-orchestration-layer"},"children":[{"block_type":"text","content":"http://thenextweb.com/dd/2013/12/17/future-api-design-orchestration-layer"}]},{"block_type":"text","content":"), defines API orchestration as follows:"}]},{"block_type":"element","block":"k5zy5cmc","search_text":"\"An API Orchestration Layer (OL) is an abstraction layer that takes generically-modeled data elements and/or features and prepares them in a more specific way for a targeted developer or application.\" ","text_count":201,"tag_name":"blockquote","attributes":{},"children":[{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"\"An API Orchestration Layer (OL) is an abstraction layer that takes generically-modeled data elements and/or features and prepares them in a more specific way for a targeted developer or application.\""}]}]}]},{"block_type":"element","block":"k5zy5cmd","search_text":"The generically modeled elements and/or features fit the description of a service in a microservice architecture perfectly. The idea is to create an abstraction to connect those bits and pieces to implement new services specific to the application.","text_count":248,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"generically modeled elements and/or features"}]},{"block_type":"text","content":"fit the description of a service in a microservice architecture perfectly. The idea is to create an abstraction to connect those bits and pieces to implement new services specific to the application."}]},{"block_type":"element","block":"k5zy5cme","search_text":"Let's make an example using the e-commerce application. Refer to the following figure:","text_count":86,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's make an example using the e-commerce application. Refer to the following figure:"}]},{"block_type":"element","block":"k5zy5cmf","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000037.jpg","alt":"API orchestration","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cmg","search_text":"The preceding figure shows how the Store front-end application uses an orchestration layer to build more complex and specific features by composing and orchestrating existing services. The described scenario takes as example, a hypothetical completeCheckout() service that is invoked the moment a customer clicks the Pay button at the end of the checkout. The figure shows how completeCheckout() is a composite operation made of three different steps:","text_count":451,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding figure shows how the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Store front-end application"}]},{"block_type":"text","content":"uses an orchestration layer to build more complex and specific features by composing and orchestrating existing services. The described scenario takes as example, a hypothetical"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"completeCheckout()"}]},{"block_type":"text","content":"service that is invoked the moment a customer clicks the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Pay"}]},{"block_type":"text","content":"button at the end of the checkout. The figure shows how"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"completeCheckout()"}]},{"block_type":"text","content":"is a composite operation made of three different steps:"}]},{"block_type":"element","block":"k5zy5cmh","search_text":"First, we complete the transaction by invoking checkoutService/pay . Then, when the payment is successfully processed, we need to tell the cart service that the items were purchased and they can be removed from the cart. We do that by invoking cartService/delete . Also, when the payment is complete, we need to update the availability of the products that were just purchased. This is done through productsService/update . ","text_count":424,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"First, we complete the transaction by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkoutService/pay"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Then, when the payment is successfully processed, we need to tell the cart service that the items were purchased and they can be removed from the cart. We do that by invoking"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cartService/delete"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Also, when the payment is complete, we need to update the availability of the products that were just purchased. This is done through"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"productsService/update"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cmi","search_text":"As we can see, we took three operations from three different services and we built a new API that coordinates the services to maintain the entire system in a consistent state.","text_count":175,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, we took three operations from three different services and we built a new API that coordinates the services to maintain the entire system in a consistent state."}]},{"block_type":"element","block":"k5zy5cmj","search_text":"Another common operation performed by the API Orchestration Layer is data aggregation , in other words, combining data from different services into a single response. Imagine if we wanted to list all the products contained in a cart. In this case, the orchestration would need to retrieve the list of product IDs from the Cart service and then retrieve the complete information about the products from the Products service. The ways in which we can combine and coordinate services are really infinite, but the important pattern to remember is the role of the orchestration layer, which acts as an abstraction between a number of services and a specific application.","text_count":665,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another common operation performed by the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"API Orchestration Layer"}]},{"block_type":"text","content":"is&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"data aggregation"}]},{"block_type":"text","content":", in other words, combining data from different services into a single response. Imagine if we wanted to list all the products contained in a cart. In this case, the orchestration would need to retrieve the list of product IDs from the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cart"}]},{"block_type":"text","content":"service and then retrieve the complete information about the products from the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Products"}]},{"block_type":"text","content":"service. The ways in which we can combine and coordinate services are really infinite, but the important pattern to remember is the role of the orchestration layer, which acts as an abstraction between a number of services and a specific application."}]},{"block_type":"element","block":"k5zy5cmk","search_text":"The orchestration layer is a great candidate for a further functional splitting. It is in fact very common to have it implemented as a dedicated, independent service, in which case it takes the name of API Orchestrator. This practice is perfectly in line with the microservice philosophy.","text_count":288,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The orchestration layer is a great candidate for a further functional splitting. It is in fact very common to have it implemented as a dedicated, independent service, in which case it takes the name of API Orchestrator. This practice is perfectly in line with the microservice philosophy."}]},{"block_type":"element","block":"k5zy5cml","search_text":"The next figure shows this further improvement of our architecture:","text_count":67,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next figure shows this further improvement of our architecture:"}]},{"block_type":"element","block":"k5zy5cmm","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000062.jpg","alt":"API orchestration","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cmn","search_text":"Creating a standalone orchestrator, as shown in the previous figure, can help in decoupling the client application (in our case, the Store front-end ) from the complexity of the microservice infrastructure. This reminds us about the API Proxy; however, there is a crucial difference; an orchestrator performs a semantic integration of the various services; it's not just a naïve proxy, and it often exposes an API that is different from the one exposed by the underlying services.","text_count":480,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Creating a standalone orchestrator, as shown in the previous figure, can help in decoupling the client application (in our case, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Store front-end"}]},{"block_type":"text","content":") from the complexity of the microservice infrastructure. This reminds us about the API Proxy; however, there is a crucial difference; an orchestrator performs a semantic integration of the various services; it's not just a na&iuml;ve proxy, and it often exposes an API that is different from the one exposed by the underlying services."}]},{"block_type":"element","block":"k5zy5cmo","search_text":"Integration with a message broker","text_count":33,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Integration with a message broker"}]},{"block_type":"element","block":"k5zy5cmp","search_text":"The orchestrator pattern gave us a mechanism to integrate the various services in an explicit way. This has both advantages and disadvantages. It is easy to design, easy to debug, and easy to scale, but unfortunately, it has to have a complete knowledge of the underlying architecture and how each service works. If we were talking about objects instead of architectural nodes, the orchestrator would be an anti-pattern called God Object , which defines an object that knows and does too much, which usually results in high coupling, low cohesion, but most importantly, high complexity.","text_count":586,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The orchestrator pattern gave us a mechanism to integrate the various services in an explicit way. This has both advantages and disadvantages. It is easy to design, easy to debug, and easy to scale, but unfortunately, it has to have a complete knowledge of the underlying architecture and how each service works. If we were talking about objects instead of architectural nodes, the orchestrator would be an anti-pattern called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"God Object"}]},{"block_type":"text","content":", which defines an object that knows and does too much, which usually results in high coupling, low cohesion, but most importantly, high complexity."}]},{"block_type":"element","block":"k5zy5cmq","search_text":"The pattern we are now going to show tries to distribute, across the services, the responsibility of synchronizing the information of the entire system. However, the last thing we want to do is create direct relationships between services, which would result in high coupling and a further increase in the complexity of the system, due to the increasing number of interconnections between nodes. The goal is to have each service maintain its isolation; they should be able to work even without the rest of the services in the system or in combination with new services and nodes.","text_count":579,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The pattern we are now going to show tries to distribute, across the services, the responsibility of synchronizing the information of the entire system. However, the last thing we want to do is create direct relationships between services, which would result in high coupling and a further increase in the complexity of the system, due to the increasing number of interconnections between nodes. The goal is to have each service maintain its isolation; they should be able to work even without the rest of the services in the system or in combination with new services and nodes."}]},{"block_type":"element","block":"k5zy5cmr","search_text":"The solution is to use a message broker, a system capable of decoupling the sender from the receiver of a message, allowing us to implement a centralized publish/subscribe pattern, in practice an observer pattern for distributed systems (we will talk more about this pattern later in the book). The following diagram shows an example of how this applies to the e-commerce application:","text_count":384,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The solution is to use a message broker, a system capable of decoupling the sender from the receiver of a message, allowing us to implement a centralized publish/subscribe pattern, in practice an observer pattern for distributed systems (we will talk more about this pattern later in the book). The following diagram shows an example of how this applies to the e-commerce application:"}]},{"block_type":"element","block":"k5zy5cms","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000049.jpg","alt":"Integration with a message broker","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cmt","search_text":"As we can see, the client of the Checkout service, which is the frontend application, does not need to carry out any explicit integration with the other services. All it has to do is invoke checkoutService/pay to complete the checkout and take the money from the customer; all the integration work happens in the background:","text_count":324,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, the client of the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Checkout"}]},{"block_type":"text","content":"service, which is the frontend application, does not need to carry out any explicit integration with the other services. All it has to do is invoke"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkoutService/pay"}]},{"block_type":"text","content":"to complete the checkout and take the money from the customer; all the integration work happens in the background:"}]},{"block_type":"element","block":"k5zy5cmu","search_text":"The Store front-end invokes the checkoutService/pay operation on the Checkout service. When the operation completes, the Checkout service generates an event, attaching the details of the operation, that is, the cartId and the list of products that were just purchased. The event is published into the message broker. At this point, the Checkout service does not know who is going to receive the message. The Cart service is subscribed to the broker, so it's going to receive the purchased event that was just published by the Checkout service. The Cart service reacts by removing from its database, the cart identified with the ID contained in the message. The Products service was subscribed to the message broker as well, so it receives the same purchased event. It then updates its database based on this new information, adjusting the availability of the products included in the message. ","text_count":893,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Store front-end"}]},{"block_type":"text","content":"invokes the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"checkoutService/pay"}]},{"block_type":"text","content":"operation on the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Checkout"}]},{"block_type":"text","content":"service."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When the operation completes, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Checkout"}]},{"block_type":"text","content":"service generates an event, attaching the details of the operation, that is, the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"cartId"}]},{"block_type":"text","content":"and the list of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"products"}]},{"block_type":"text","content":"that were just purchased. The event is published into the message broker. At this point, the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Checkout"}]},{"block_type":"text","content":"service does not know who is going to receive the message."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cart"}]},{"block_type":"text","content":"service is subscribed to the broker, so it's going to receive the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"purchased"}]},{"block_type":"text","content":"event that was just published by the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Checkout"}]},{"block_type":"text","content":"service. The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Cart"}]},{"block_type":"text","content":"service reacts by removing from its database, the cart identified with the ID contained in the message."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Products"}]},{"block_type":"text","content":"service was subscribed to the message broker as well, so it receives the same"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"purchased"}]},{"block_type":"text","content":"event. It then updates its database based on this new information, adjusting the availability of the products included in the message."}]}]},{"block_type":"element","block":"k5zy5cmv","search_text":"The whole process happens without any explicit intervention from external entities such as an orchestrator. The responsibility for spreading the knowledge and keeping information in sync is distributed across the services themselves. There is no g od service that has to know how to move the gears of the entire system; each service is in charge of its own part of the integration.","text_count":381,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The whole process happens without any explicit intervention from external entities such as an orchestrator. The responsibility for spreading the knowledge and keeping information in sync is distributed across the services themselves. There is no g"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"od"}]},{"block_type":"text","content":"service that has to know how to move the gears of the entire system; each service is in charge of its own part of the integration."}]},{"block_type":"element","block":"k5zy5cmw","search_text":"The message broker is a fundamental element to decouple the services and reduce the complexity of their interaction. It might also offer other interesting features, such as persistent message queues and guaranteed ordering of the messages. We will talk more about this in the next chapter.","text_count":289,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The message broker is a fundamental element to decouple the services and reduce the complexity of their interaction. It might also offer other interesting features, such as persistent message queues and guaranteed ordering of the messages. We will talk more about this in the next chapter."}]},{"block_type":"element","block":"k5zy5cmx","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5cmy","search_text":"In this chapter, we learned how to design Node.js architectures that scale both in capacity and complexity. We saw how scaling an application is not only about handling more traffic or reducing the response time, but it's also a practice to apply when we want better availability and tolerance to failures. We saw how these properties often are on the same wavelength and we understood that scaling early is not a bad practice, especially in Node.js, which allows us to do it easily and with few resources.","text_count":506,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this chapter, we learned how to design Node.js architectures that scale both in capacity and complexity. We saw how scaling an application is not only about handling more traffic or reducing the response time, but it's also a practice to apply when we want better availability and tolerance to failures. We saw how these properties often are on the same wavelength and we understood that scaling early is not a bad practice, especially in Node.js, which allows us to do it easily and with few resources."}]},{"block_type":"element","block":"k5zy5cmz","search_text":"The scale cube taught us that applications can be scaled across three dimensions. We dived into the two most important of them, the x -and y -axes, allowing us to discover two essential architectural patterns, namely, load balancing and microservices. We should know by now how to start multiple instances of the same Node.js application, how to distribute the traffic across them, and how to exploit this setup for other purposes such as fail tolerance and zero-downtime restarts. We also analyzed how to handle the problem of dynamic and autoscaled infrastructures; we saw that a service registry can really come in useful for those situations. However, cloning and load balancing cover only one dimension of the scale cube, so we moved our analysis to another dimension, studying in more detail what it means to split an application by its constituent services, by building a microservice architecture. We saw how microservices enable a complete revolution in how a project is developed and managed, providing a natural way to distribute the load of an application and split its complexity. However, we learned that this also means shifting the complexity from how to build a big monolithic application to how to integrate a set of services . This last aspect is where we focused the last part of our analysis, showing some of the architectural solutions to integrate a set of independent services.","text_count":1401,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The scale cube taught us that applications can be scaled across three dimensions. We dived into the two most important of them, the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"x"}]},{"block_type":"text","content":"-and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"y"}]},{"block_type":"text","content":"-axes, allowing us to discover two essential architectural patterns, namely, load balancing and microservices. We should know by now how to start multiple instances of the same Node.js application, how to distribute the traffic across them, and how to exploit this setup for other purposes such as fail tolerance and zero-downtime restarts. We also analyzed how to handle the problem of dynamic and autoscaled infrastructures; we saw that a service registry can really come in useful for those situations. However, cloning and load balancing cover only one dimension of the scale cube, so we moved our analysis to another dimension, studying in more detail what it means to split an application by its constituent services, by building a microservice architecture. We saw how microservices enable a complete revolution in how a project is developed and managed, providing a natural way to distribute the load of an application and split its complexity. However, we learned that this also means shifting the complexity from"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"how to build a big monolithic application"}]},{"block_type":"text","content":"to"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"how to integrate a set of services"}]},{"block_type":"text","content":". This last aspect is where we focused the last part of our analysis, showing some of the architectural solutions to integrate a set of independent services."}]},{"block_type":"element","block":"k5zy5cn0","search_text":"In the next chapter, we will have the chance to analyze in more detail, the messaging patterns we discussed in this chapter in addition to more advanced integration techniques, useful when implementing complex distributed architectures.","text_count":236,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the next chapter, we will have the chance to analyze in more detail, the messaging patterns we discussed in this chapter in addition to more advanced integration techniques, useful when implementing complex distributed architectures."}]}]},{"title":"Messaging and Intergration Patterns","author":"Mario Casciaro & Luciano Mammino","block":"k5zy4mw5","number":11,"contents":[{"block_type":"element","block":"k5zy5cn1","search_text":"If scalability is about splitting, systems integration is about rejoining. In the previous chapter, we learned how to distribute an apfunction is a simple iteration over all the connected clientsplication, fragmenting it across several machines. In order for it to work properly, all those pieces have to communicate in some way and, hence, they have to be integrated.","text_count":368,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If scalability is about splitting, systems integration is about rejoining. In the previous chapter, we learned how to distribute an apfunction is a simple iteration over all the connected clientsplication, fragmenting it across several machines. In order for it to work properly, all those pieces have to communicate in some way and, hence, they have to be integrated."}]},{"block_type":"element","block":"k5zy5cn2","search_text":"There are two main techniques to integrate a distributed application: one is to use a shared storage as a central coordinator and keeper of all the information, the other one is to use messages to disseminate data, events, and commands across the nodes of the system. This last option is what really makes the difference when scaling distributed systems, and it's also what makes this topic so fascinating and sometimes complex.","text_count":428,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"There are two main techniques to integrate a distributed application: one is to use a shared storage as a central coordinator and keeper of all the information, the other one is to use messages to disseminate data, events, and commands across the nodes of the system. This last option is what really makes the difference when scaling distributed systems, and it's also what makes this topic so fascinating and sometimes complex."}]},{"block_type":"element","block":"k5zy5cn3","search_text":"Messages are used in every layer of a software system. We exchange messages to communicate on the Internet, we can use messages to send information to other processes using pipes, we can use messages within an application as an alternative to direct function invocation (command pattern), and also device drivers use messages to communicate with the hardware. Any discrete and structured data that is used as a way to exchange information between components and systems can be seen as a message . However, when dealing with distributed architectures, the term messaging system is used to describe a specific class of solutions, patterns, and architectures that are meant to facilitate the exchange of information over the network.","text_count":730,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Messages are used in every layer of a software system. We exchange messages to communicate on the Internet, we can use messages to send information to other processes using pipes, we can use messages within an application as an alternative to direct function invocation (command pattern), and also device drivers use messages to communicate with the hardware. Any discrete and structured data that is used as a way to exchange information between components and systems can be seen as a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"message"}]},{"block_type":"text","content":". However, when dealing with distributed architectures, the term"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"messaging system"}]},{"block_type":"text","content":"is used to describe a specific class of solutions, patterns, and architectures that are meant to facilitate the exchange of information over the network."}]},{"block_type":"element","block":"k5zy5cn4","search_text":"As we will see, there are several traits that characterize these types of systems. We might choose to use a broker versus a peer-to-peer structure, we might use a request/reply or one-way communication, or we might use queues to deliver our messages more reliably; the scope of the topic is really broad. The book Enterprise Integration Patterns by Gregor Hohpe and Bobby Woolf gives you an idea about the vastness of the topic. It is considered the Bible of messaging and integration patterns and has more than 700 pages describing 65 different integration patterns. This chapter explores the most important of those well-known patterns, considering them from the perspective of Node.js and its ecosystem.","text_count":706,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we will see, there are several traits that characterize these types of systems. We might choose to use a broker versus a peer-to-peer structure, we might use a request/reply or one-way communication, or we might use queues to deliver our messages more reliably; the scope of the topic is really broad. The book&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Enterprise Integration Patterns"}]},{"block_type":"text","content":"by"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Gregor Hohpe"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Bobby Woolf"}]},{"block_type":"text","content":"gives you an idea about the vastness of the topic. It is considered the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Bible"}]},{"block_type":"text","content":"of messaging and integration patterns and has more than 700 pages describing 65 different integration patterns. This chapter explores the most important of those well-known patterns, considering them from the perspective of Node.js and its ecosystem."}]},{"block_type":"element","block":"k5zy5cn5","search_text":"To sum up, in this chapter, we will learn about the following topics:","text_count":69,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To sum up, in this chapter, we will learn about the following topics:"}]},{"block_type":"element","block":"k5zy5cn6","search_text":"The fundamentals of a messaging system The publish/subscribe pattern Pipelines and task distribution patterns Request/reply patterns ","text_count":133,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The fundamentals of a messaging system"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The publish/subscribe pattern"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Pipelines and task distribution patterns"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Request/reply patterns"}]}]},{"block_type":"element","block":"k5zy5cn7","search_text":"Fundamentals of a messaging system","text_count":34,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Fundamentals of a messaging system"}]},{"block_type":"element","block":"k5zy5cn8","search_text":"When talking about messages and messaging systems, there are four fundamental elements to take into consideration; these are as follows:","text_count":136,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When talking about messages and messaging systems, there are four fundamental elements to take into consideration; these are as follows:"}]},{"block_type":"element","block":"k5zy5cn9","search_text":"The direction of the communication, which can be one-way only or a request/reply exchange The purpose of the message, which also determines its content The timing of the message, which can be sent and received immediately or at a later time (asynchronously) The delivery of the message, which can happen directly or via a broker ","text_count":329,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The direction of the communication, which can be one-way only or a request/reply exchange"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The purpose of the message, which also determines its content"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The timing of the message, which can be sent and received immediately or at a later time (asynchronously)"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The delivery of the message, which can happen directly or via a broker"}]}]},{"block_type":"element","block":"k5zy5cna","search_text":"In the sections that follow, we are going to formalize these aspects in order to provide a base for our later discussions.","text_count":122,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the sections that follow, we are going to formalize these aspects in order to provide a base for our later discussions."}]},{"block_type":"element","block":"k5zy5cnb","search_text":"One-way and request/reply patterns","text_count":34,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"One-way and request/reply patterns"}]},{"block_type":"element","block":"k5zy5cnc","search_text":"The most fundamental aspect in a messaging system is the direction of the communication, which often also determines its semantics.","text_count":131,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most fundamental aspect in a messaging system is the direction of the communication, which often also determines its semantics."}]},{"block_type":"element","block":"k5zy5cnd","search_text":"The most simple communication pattern is when the message is pushed one-way from a source to a destination; this is a trivial situation, and it doesn't need much explanation:","text_count":174,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most simple communication pattern is when the message is pushed&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"one-way"}]},{"block_type":"text","content":"from a source to a destination; this is a trivial situation, and it doesn't need much explanation:"}]},{"block_type":"element","block":"k5zy5cne","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000034.jpg","alt":"One-way and request/reply patterns","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cnf","search_text":"A typical example of one-way communication is an e-mail or a web server that sends a message to a connected browser using WebSockets, or a system that distributes tasks to a set of workers.","text_count":189,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A typical example of one-way communication is an e-mail or a web server that sends a message to a connected browser using WebSockets, or a system that distributes tasks to a set of workers."}]},{"block_type":"element","block":"k5zy5cng","search_text":"The request/reply pattern is, however, far more popular than the one-way only communication; a typical example is the invocation of a web service. The following figure shows this simple and well-known scenario:","text_count":210,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The request/reply pattern is, however, far more popular than the one-way only communication; a typical example is the invocation of a web service. The following figure shows this simple and well-known scenario:"}]},{"block_type":"element","block":"k5zy5cnh","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000035.jpg","alt":"One-way and request/reply patterns","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cni","search_text":"The request/reply pattern might seem a trivial pattern to implement; however, we will see that it becomes more complicated when the communication is asynchronous or involves multiple nodes. Take a look at the example in the following figure:","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The request/reply pattern might seem a trivial pattern to implement; however, we will see that it becomes more complicated when the communication is asynchronous or involves multiple nodes. Take a look at the example in the following figure:"}]},{"block_type":"element","block":"k5zy5cnj","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000016.jpg","alt":"One-way and request/reply patterns","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cnk","search_text":"With the setup shown in the preceding diagram, we can appreciate the complexity of some request/reply patterns. If we consider the direction of the communication between any two nodes, we can surely say that it is one-way. However, from a global point of view, the initiator sends a request and in turn receives an associated response, even if from a different node. In these situations, what really differentiates a request/reply pattern from a bare one-way loop is the relationship between the request and the reply, which is kept in the initiator. The reply is usually handled in the same context of the request.","text_count":615,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With the setup shown in the preceding diagram, we can appreciate the complexity of some request/reply patterns. If we consider the direction of the communication between any two nodes, we can surely say that it is one-way. However, from a global point of view, the initiator sends a request and in turn receives an associated response, even if from a different node. In these situations, what really differentiates a request/reply pattern from a bare one-way loop is the relationship between the request and the reply, which is kept in the initiator. The reply is usually handled in the same context"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"&nbsp;"}]},{"block_type":"text","content":"of the request."}]},{"block_type":"element","block":"k5zy5cnl","search_text":"Message types","text_count":13,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Message types"}]},{"block_type":"element","block":"k5zy5cnm","search_text":"A message is essentially a means to connect different software components and there are different reasons for doing so: it might be because we want to obtain some information held by another system or a component, to execute operations remotely, or to notify some peers that something has just happened. The message content will also vary depending on the reason for the communication. In general, we can identify three types of messages, depending on their purpose:","text_count":466,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"message"}]},{"block_type":"text","content":"is essentially a means to connect different software components and there are different reasons for doing so: it might be because we want to obtain some information held by another system or a component, to execute operations remotely, or to notify some peers that something has just happened. The message content will also vary depending on the reason for the communication. In general, we can identify three types of messages, depending on their purpose:"}]},{"block_type":"element","block":"k5zy5cnn","search_text":"Command Message Event Message Document Message ","text_count":47,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Command Message"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Message"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Document Message"}]}]}]},{"block_type":"element","block":"k5zy5cno","search_text":"Command Message","text_count":15,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Command Message"}]},{"block_type":"element","block":"k5zy5cnp","search_text":"The Command Message is already familiar to us; it's essentially a serialized command object as we described it in Chapter 6, Design Patterns . The purpose of this type of message is to trigger the execution of an action or a task on the receiver. For this to be possible, our message has to contain the essential information to run the task, which is usually the name of the operation and a list of arguments to provide when it's executed. The Command Message can be used to implement Remote Procedure Call ( RPC ) systems, distributed computations, or more simply used to request some data. RESTful HTTP calls are simple examples of commands; each HTTP verb has a specific meaning and is associated with a precise operation: GET, to retrieve the resource; POST, to create a new one; PUT, to update it; and DELETE, to destroy it.","text_count":829,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Command Message"}]},{"block_type":"text","content":"is already familiar to us; it's essentially a serialized command object as we described it in Chapter 6,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Design Patterns"}]},{"block_type":"text","content":". The purpose of this type of message is to trigger the execution of an action or a task on the receiver. For this to be possible, our message has to contain the essential information to run the task, which is usually the name of the operation and a list of arguments to provide when it's executed. The Command Message can be used to implement"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Remote Procedure&nbsp;Call"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"RPC"}]},{"block_type":"text","content":") systems, distributed computations, or more simply used to request some data. RESTful HTTP calls are simple examples of commands; each HTTP verb has a specific meaning and is associated with a precise operation: GET, to retrieve the resource; POST, to create a new one; PUT, to update it; and DELETE, to destroy it."}]},{"block_type":"element","block":"k5zy5cnq","search_text":"Event Message","text_count":13,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Event Message"}]},{"block_type":"element","block":"k5zy5cnr","search_text":"An Event Message is used to notify another component that something has occurred. It usually contains the type of the event and sometimes also some details such as the context, the subject, or the actor involved. In web development, we are using an Event Message in the browser when using long-polling or WebSockets to receive notifications from the server that something has just happened, as, for example, changes in the data or, in general, the state of the system. The use of events is a very important integration mechanism in distributed applications, as it enables us to keep all the nodes of the system on the same page.","text_count":628,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Event Message"}]},{"block_type":"text","content":"is used to notify another component that something has occurred. It usually contains the type of the event and sometimes also some details such as the context, the subject, or the actor involved. In web development, we are using an Event Message in the browser when using long-polling or WebSockets to receive notifications from the server that something has just happened, as, for example, changes in the data or, in general, the state of the system. The use of events is a very important integration mechanism in distributed applications, as it enables us to keep all the nodes of the system on the same page."}]},{"block_type":"element","block":"k5zy5cns","search_text":"Document Message","text_count":16,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Document Message"}]},{"block_type":"element","block":"k5zy5cnt","search_text":"The Document Message is primarily meant to transfer data between components and machines. The main characteristic that differentiates a document from a command (which might also contain data) is that the message does not contain any information that tells the receiver what to do with the data. On the other hand, the main difference from an Event Message is mainly the absence of an association with a particular occurrence, with something that happened. Often, the replies to the Command Messages are Document Messages, as they usually contain only the data that was requested or the result of an operation.","text_count":609,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Document Message"}]},{"block_type":"text","content":"is primarily meant to transfer data between components and machines. The main characteristic that differentiates a document from a command (which might also contain data) is that the message does not contain any information that tells the receiver what to do with the data. On the other hand, the main difference from an Event Message is mainly the absence of an association with a particular occurrence, with something that happened. Often, the replies to the Command Messages are Document Messages, as they usually contain only the data that was requested or the result of an operation."}]},{"block_type":"element","block":"k5zy5cnu","search_text":"Asynchronous messaging and queues","text_count":33,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Asynchronous messaging and queues"}]},{"block_type":"element","block":"k5zy5cnv","search_text":"As Node.js developers, we should already know the advantages of executing asynchronous operations. For messaging and communications, it's the same story.","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As Node.js developers, we should already know the advantages of executing asynchronous operations. For messaging and communications, it's the same story."}]},{"block_type":"element","block":"k5zy5cnw","search_text":"We can compare synchronous communication to a phone call: the two peers must be connected to the same channel at the same time and they should exchange messages in real time. Normally, if we want to call someone else, we either need another phone or to close the ongoing communication in order to start a new one.","text_count":313,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can compare synchronous communication to a phone call: the two peers must be connected to the same channel at the same time and they should exchange messages in real time. Normally, if we want to call someone else, we either need another phone or to close the ongoing communication in order to start a new one."}]},{"block_type":"element","block":"k5zy5cnx","search_text":"Asynchronous communication is similar to an SMS: it doesn't require the recipient to be connected to the network the moment we send it, we might receive a response immediately or after an unknown delay, or we might not receive a response at all. We might send multiple SMSes to multiple recipients one after the other, and receive their responses (if any) in any order. In short, we have a better parallelism with the use of fewer resources.","text_count":441,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Asynchronous communication is similar to an SMS: it doesn't require the recipient to be connected to the network the moment we send it, we might receive a response immediately or after an unknown delay, or we might not receive a response at all. We might send multiple SMSes to multiple recipients one after the other, and receive their responses (if any) in any order. In short, we have a better parallelism with the use of fewer resources."}]},{"block_type":"element","block":"k5zy5cny","search_text":"Another important advantage of asynchronous communications is that the messages can be stored and then delivered as soon as possible or at a later time. This might be useful when the receiver is too busy to handle new messages or when we want to guarantee delivery. In messaging systems, this is made possible using a message queue , a component that mediates the communication between the sender and the receiver, storing any message before it gets delivered to its destination, as shown in the following figure:","text_count":513,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another important advantage of asynchronous communications is that the messages can be stored and then delivered as soon as possible or at a later time. This might be useful when the receiver is too busy to handle new messages or when we want to guarantee delivery. In messaging systems, this is made possible using a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"message queue"}]},{"block_type":"text","content":", a component that mediates the communication between the sender and the receiver, storing any message before it gets delivered to its destination, as shown in the following figure:"}]},{"block_type":"element","block":"k5zy5cnz","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000006.jpg","alt":"Asynchronous messaging and queues","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5co0","search_text":"If for any reason the receiver crashes, disconnects from the network, or experiences a slowdown, the messages are accumulated in the queue and dispatched as soon as the receiver comes online and is fully working. The queue can be located in the sender, or split between the sender and receiver, or live in a dedicated external system acting as middleware for the communication.","text_count":377,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If for any reason the receiver crashes, disconnects from the network, or experiences a slowdown, the messages are accumulated in the queue and dispatched as soon as the receiver comes online and is fully working. The queue can be located in the sender, or split between the sender and receiver, or live in a dedicated external system acting as middleware for the communication."}]},{"block_type":"element","block":"k5zy5co1","search_text":"Peer-to-peer or broker-based messaging","text_count":38,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Peer-to-peer or broker-based messaging"}]},{"block_type":"element","block":"k5zy5co2","search_text":"Messages can be delivered directly to the receiver, in a peer-to-peer fashion or through a centralized intermediary system called a message broker . The main role of the broker is to decouple the receiver of the message from the sender. The following figure shows the architectural difference between the two approaches:","text_count":320,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Messages can be delivered directly to the receiver, in a peer-to-peer fashion or through a centralized intermediary system called a&nbsp;"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"message broker"}]},{"block_type":"text","content":". The main role of the broker is to decouple the receiver of the message from the sender. The following figure shows the architectural difference between the two approaches:"}]},{"block_type":"element","block":"k5zy5co3","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000040.jpg","alt":"Peer-to-peer or broker-based messaging","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5co4","search_text":"In a peer-to-peer architecture, every node is directly responsible for the delivery of the message to the receiver. This implies that the nodes have to know the address and port of the receiver and they have to agree on a protocol and message format. The broker eliminates these complexities from the equation: each node can be totally independent and can communicate with an undefined number of peers without directly knowing their details. A broker can also act as a bridge between the different communication protocols, for example, the popular RabbitMQ broker ( http://www.rabbitmq.com ) supports Advanced Message Queuing Protocol ( AMQP ), Message Queue Telemetry Transport ( MQTT ), and Simple/Streaming Text Orientated Messaging Protocol ( STOMP ), enabling multiple applications supporting different messaging protocols to interact.","text_count":840,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a peer-to-peer architecture, every node is directly responsible for the delivery of the message to the receiver. This implies that the nodes have to know the address and port of the receiver and they have to agree on a protocol and message format. The broker eliminates these complexities from the equation: each node can be totally independent and can communicate with an undefined number of peers without directly knowing their details. A broker can also act as a bridge between the different communication protocols, for example, the popular RabbitMQ broker ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.rabbitmq.com"},"children":[{"block_type":"text","content":"http://www.rabbitmq.com"}]},{"block_type":"text","content":") supports"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Advanced Message Queuing Protocol"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"AMQP"}]},{"block_type":"text","content":"),"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Message Queue Telemetry Transport"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"MQTT"}]},{"block_type":"text","content":"), and"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Simple/Streaming Text Orientated Messaging Protocol"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"STOMP"}]},{"block_type":"text","content":"), enabling multiple applications supporting different messaging protocols to interact."}]},{"block_type":"element","block":"k5zy5co5","search_text":"Note MQTT ( http://mqtt.org ) is a lightweight messaging protocol, specifically designed for machine-to-machine communications (Internet of Things). AMQP ( http://www.amqp.org ) is a more complex protocol, which is designed to be an open source alternative to proprietary messaging middleware. STOMP ( http://stomp.github.io ) is a lightweight text-based protocol, which comes from the HTTP school of design . All three are application layer protocols, and based on TCP/IP. ","text_count":474,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"MQTT ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://mqtt.org"},"children":[{"block_type":"text","content":"http://mqtt.org"}]},{"block_type":"text","content":") is a lightweight messaging protocol, specifically designed for machine-to-machine communications (Internet of Things). AMQP ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.amqp.org"},"children":[{"block_type":"text","content":"http://www.amqp.org"}]},{"block_type":"text","content":") is a more complex protocol, which is designed to be an open source alternative to proprietary messaging middleware. STOMP ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://stomp.github.io"},"children":[{"block_type":"text","content":"http://stomp.github.io"}]},{"block_type":"text","content":") is a lightweight text-based protocol, which comes from"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"the HTTP school of design"}]},{"block_type":"text","content":". All three are application layer protocols, and based on TCP/IP."}]}]},{"block_type":"element","block":"k5zy5co6","search_text":"Besides the decoupling and the interoperability, a broker can offer more advanced features such as persistent queues, routing, message transformations, and monitoring, without mentioning the broad range of messaging patterns that many brokers support out of the box. Of course, nothing stops us from implementing all these features using a peer-to-peer architecture, but unfortunately there is much more effort involved. Nonetheless, there might be different reasons to avoid a broker:","text_count":485,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Besides the decoupling and the interoperability, a broker can offer more advanced features such as persistent queues, routing, message transformations, and monitoring, without mentioning the broad range of messaging patterns that many brokers support out of the box. Of course, nothing stops us from implementing all these features using a peer-to-peer architecture, but unfortunately there is much more effort involved. Nonetheless, there might be different reasons to avoid a broker:"}]},{"block_type":"element","block":"k5zy5co7","search_text":"Removing a single point of failure A broker has to be scaled, while in a peer-to-peer architecture we only need to scale the single nodes Exchanging messages without intermediaries can greatly reduce the latency of the transmission ","text_count":232,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Removing a single point of failure"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A broker has to be scaled, while in a peer-to-peer architecture we only need to scale the single nodes"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Exchanging messages without intermediaries can greatly reduce the latency of the transmission"}]}]},{"block_type":"element","block":"k5zy5co8","search_text":"If we want to implement a peer-to-peer messaging system, we also have much more flexibility and power, because we are not bound to any particular technology, protocol, or architecture. The popularity of ØMQ ( http://zeromq.org ), which is a low-level library for building messaging systems, is a great demonstration of the flexibility that we can have by building custom peer-to-peer or hybrid architectures.","text_count":408,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we want to implement a peer-to-peer messaging system, we also have much more flexibility and power, because we are not bound to any particular technology, protocol, or architecture. The popularity of &Oslash;MQ ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://zeromq.org"},"children":[{"block_type":"text","content":"http://zeromq.org"}]},{"block_type":"text","content":"), which is a low-level library for building messaging systems, is a great demonstration of the flexibility that we can have by building custom peer-to-peer or hybrid architectures."}]},{"block_type":"element","block":"k5zy5co9","search_text":"Publish/subscribe pattern","text_count":25,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Publish/subscribe pattern"}]},{"block_type":"element","block":"k5zy5coa","search_text":"Publish/subscribe (often abbreviated to pub/sub) is probably the best-known one-way messaging pattern. We should already be familiar with it, as it's nothing more than a distributed observer pattern. As in the case of observer, we have a set of subscribers registering their interest in receiving a specific category of messages. On the other side, the publisher produces messages that are distributed across all the relevant subscribers. The following figure shows the two main variations of the pub/sub pattern, the first peer-to-peer, the second using a broker to mediate the communication:","text_count":593,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Publish/subscribe (often abbreviated to pub/sub) is probably the best-known one-way messaging pattern. We should already be familiar with it, as it's nothing more than a distributed observer pattern. As in the case of observer, we have a set of"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"subscribers"}]},{"block_type":"text","content":"registering their interest in receiving a specific category of messages. On the other side, the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"publisher"}]},{"block_type":"text","content":"produces messages that are distributed across all the relevant subscribers. The following figure shows the two main variations of the pub/sub pattern, the first peer-to-peer, the second using a broker to mediate the communication:"}]},{"block_type":"element","block":"k5zy5cob","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000020.jpg","alt":"Publish/subscribe pattern","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5coc","search_text":"What makes pub/sub so special is the fact that the publisher doesn't know who the recipients of the messages are in advance. As we said, it's the subscriber which has to register its interest to receive a particular message, allowing the publisher to work with an unknown number of receivers. In other words, the two sides of the pub/sub pattern are loosely coupled , which makes this an ideal pattern to integrate the nodes of an evolving distributed system.","text_count":459,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What makes pub/sub so special is the fact that the publisher doesn't know who the recipients of the messages are in advance. As we said, it's the subscriber which has to register its interest to receive a particular message, allowing the publisher to work with an unknown number of receivers. In other words, the two sides of the pub/sub pattern are"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"loosely coupled"}]},{"block_type":"text","content":", which makes this an ideal pattern to integrate the nodes of an evolving distributed system."}]},{"block_type":"element","block":"k5zy5cod","search_text":"The presence of a broker further improves the decoupling between the nodes of the system because the subscribers interact only with the broker, not knowing which node is the publisher of a message. As we will see later, a broker can also provide a message queuing system, allowing reliable delivery even in the presence of connectivity problems between the nodes.","text_count":363,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The presence of a broker further improves the decoupling between the nodes of the system because the subscribers interact only with the broker, not knowing which node is the publisher of a message. As we will see later, a broker can also provide a message queuing system, allowing reliable delivery even in the presence of connectivity problems between the nodes."}]},{"block_type":"element","block":"k5zy5coe","search_text":"Now, let's work on an example to demonstrate this pattern.","text_count":58,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's work on an example to demonstrate this pattern."}]},{"block_type":"element","block":"k5zy5cof","search_text":"Building a minimalist real-time chat application","text_count":48,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Building a minimalist real-time chat application"}]},{"block_type":"element","block":"k5zy5cog","search_text":"To show a real example of how the pub/sub pattern can help us integrate a distributed architecture, we are now going to build a very basic real-time chat application using pure WebSockets. Then, we will try to scale it by running multiple instances and using a messaging system to put them in communication.","text_count":307,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To show a real example of how the pub/sub pattern can help us integrate a distributed architecture, we are now going to build a very basic real-time chat application using pure WebSockets. Then, we will try to scale it by running multiple instances and using a messaging system to put them in communication."}]},{"block_type":"element","block":"k5zy5coh","search_text":"Implementing the server side","text_count":28,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing the server side"}]},{"block_type":"element","block":"k5zy5coi","search_text":"Now, let's take one step at a time. Let's first build our chat application; to do this, we will rely on the ws package ( https://npmjs.org/package/ws ), which is a pure WebSocket implementation for Node.js. As we know, implementing real-time applications in Node.js is pretty simple, and our code will confirm this assumption. Let's then create the server side of our chat; its content is as follows (in the app.js file):","text_count":421,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's take one step at a time. Let's first build our chat application; to do this, we will rely on the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ws"}]},{"block_type":"text","content":"&nbsp;package ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/ws"},"children":[{"block_type":"text","content":"https://npmjs.org/package/ws"}]},{"block_type":"text","content":"), which is a pure WebSocket implementation for Node.js. As we know, implementing real-time applications in Node.js is pretty simple, and our code will confirm this assumption. Let's then create the server side of our chat; its content is as follows (in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"file):"}]},{"block_type":"element","block":"k5zy5coj","search_text":"const WebSocketServer = require('ws').Server; //static file server const server = require('http').createServer( //[1] require('ecstatic')({root: `${__dirname}/www`}) ); const wss = new WebSocketServer({server: server}); //[2] wss.on('connection', ws => { console.log('Client connected'); ws.on('message', msg => { //[3] console.log(`Message: ${msg}`); broadcast(msg); }); }); function broadcast(msg) { //[4] wss.clients.forEach(client => { client.send(msg); }); } server.listen(process.argv[2] || 8080); ","text_count":504,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const WebSocketServer = require('ws').Server; \n \n//static file server \nconst server = require('http').createServer(        //[1] \n  require('ecstatic')({root: `${__dirname}/www`}) \n); \n \nconst wss = new WebSocketServer({server: server});  //[2] \nwss.on('connection', ws =&gt; { \n  console.log('Client connected'); \n  ws.on('message', msg =&gt; {                         //[3] \n    console.log(`Message: ${msg}`); \n    broadcast(msg); \n  }); \n}); \n \nfunction broadcast(msg) {                           //[4] \n  wss.clients.forEach(client =&gt; { \n    client.send(msg); \n  }); \n} \n \nserver.listen(process.argv[2] || 8080);"}]}]},{"block_type":"element","block":"k5zy5cok","search_text":"That's it! That's all we need to implement our chat application on the server. This is the way it works:","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's it! That's all we need to implement our chat application on the server. This is the way it works:"}]},{"block_type":"element","block":"k5zy5col","search_text":"We first create an HTTP server and attach middleware called ecstatic ( https://npmjs.org/package/ecstatic ) to serve static files. This is needed to serve the client-side resources of our application (JavaScript and CSS). We create a new instance of the WebSocket server and we attach it to our existing HTTP server. We then start listening for incoming WebSocket connections, by attaching an event listener for the connection event. Each time a new client connects to our server, we start listening for incoming messages. When a new message arrives, we broadcast it to all the connected clients. The broadcast() function is a simple iteration over all the connected clients, where the send() function is invoked on each one of them. ","text_count":734,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We first create an HTTP server and attach middleware called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ecstatic"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/ecstatic"},"children":[{"block_type":"text","content":"https://npmjs.org/package/ecstatic"}]},{"block_type":"text","content":") to serve static files. This is needed to serve the client-side resources of our application (JavaScript and CSS)."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We create a new instance of the WebSocket server and we attach it to our existing HTTP server. We then start listening for incoming WebSocket connections, by attaching an event listener for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"connection"}]},{"block_type":"text","content":"event."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Each time a new client connects to our server, we start listening for incoming messages. When a new message arrives, we broadcast it to all the connected clients."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"broadcast()"}]},{"block_type":"text","content":"function is a simple iteration over all the connected clients, where the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"send()"}]},{"block_type":"text","content":"function is invoked on each one of them."}]}]},{"block_type":"element","block":"k5zy5com","search_text":"This is the magic of Node.js! Of course, the server that we implemented is very minimal and basic, but as we will see, it does its job.","text_count":135,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is the magic of Node.js! Of course, the server that we implemented is very minimal and basic, but as we will see, it does its job."}]},{"block_type":"element","block":"k5zy5con","search_text":"Implementing the client side","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Implementing the client side"}]},{"block_type":"element","block":"k5zy5coo","search_text":"Next, it's time to implement the client side of our chat; this is also a very small and simple fragment of code, essentially a minimal HTML page with some basic JavaScript code. Let's create this page in a file named www/index.html as follows:","text_count":243,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, it's time to implement the client side of our chat; this is also a very small and simple fragment of code, essentially a minimal HTML page with some basic JavaScript code. Let's create this page in a file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"www/index.html"}]},{"block_type":"text","content":"as follows:"}]},{"block_type":"element","block":"k5zy5cop","search_text":"<html> <head> <script> var ws = new WebSocket('ws://' + window.document. location.host); ws.onmessage = function(message) { var msgDiv = document.createElement('div'); msgDiv.innerHTML = message.data; document.getElementById('messages').appendChild(msgDiv); }; function sendMessage() { var message = document.getElementById('msgBox').value; ws.send(message); } </script> </head> <body> Messages: <div id='messages'></div> <input type='text' placeholder='Send a message' id='msgBox'> <input type='button' onclick='sendMessage()' value='Send'> </body> </html> ","text_count":558,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"&lt;html&gt; \n  &lt;head&gt; \n    &lt;script&gt; \n      var ws = new WebSocket('ws://' + window.document. location.host); \n      ws.onmessage = function(message) { \n        var msgDiv = document.createElement('div'); \n        msgDiv.innerHTML = message.data; \n        document.getElementById('messages').appendChild(msgDiv); \n      }; \n \n      function sendMessage() { \n        var message = document.getElementById('msgBox').value; \n        ws.send(message); \n      } \n     &lt;/script&gt; \n  &lt;/head&gt; \n  &lt;body&gt; \n    Messages: \n    &lt;div id='messages'&gt;&lt;/div&gt; \n    &lt;input type='text' placeholder='Send a message' id='msgBox'&gt; \n    &lt;input type='button' onclick='sendMessage()' value='Send'&gt; \n  &lt;/body&gt; \n&lt;/html&gt;"}]}]},{"block_type":"element","block":"k5zy5coq","search_text":"The HTML page we created doesn't really need many comments; it is just a piece of straightforward web development. We use the native WebSocket object to initialize a connection to our Node.js server, and then start listening for messages from the server, displaying them in new div elements as they arrive. For sending messages, instead, we use a simple textbox and a button.","text_count":375,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The HTML page we created doesn't really need many comments; it is just a piece of straightforward web development. We use the native WebSocket object to initialize a connection to our Node.js server, and then start listening for messages from the server, displaying them in new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"div"}]},{"block_type":"text","content":"elements as they arrive. For sending messages, instead, we use a simple textbox and a button."}]},{"block_type":"element","block":"k5zy5cor","search_text":"Note When stopping or restarting the chat server, the WebSocket connection is closed and it will not reconnect automatically (as it would be using high-level libraries such as Socket.io ). This means that it is necessary to refresh the browser after a server restart, to re-establish the connection (or implement a reconnection mechanism, which we will not cover here). ","text_count":370,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When stopping or restarting the chat server, the WebSocket connection is closed and it will not reconnect automatically (as it would be using high-level libraries such as"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"Socket.io"}]},{"block_type":"text","content":"). This means that it is necessary to refresh the browser after a server restart, to re-establish the connection (or implement a reconnection mechanism, which we will not cover here)."}]}]},{"block_type":"element","block":"k5zy5cos","search_text":"Running and scaling the chat application","text_count":40,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Running and scaling the chat application"}]},{"block_type":"element","block":"k5zy5cot","search_text":"We can try running our application immediately; just launch the server with a command such as the following:","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can try running our application immediately; just launch the server with a command such as the following:"}]},{"block_type":"element","block":"k5zy5cou","search_text":"node app 8080 ","text_count":14,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app 8080"}]}]},{"block_type":"element","block":"k5zy5cov","search_text":"Note To run this demo, you will need a recent browser which supports native WebSockets. There is a list of compatible browsers here: http://caniuse.com/#feat=websockets . ","text_count":171,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To run this demo, you will need a recent browser which supports native WebSockets. There is a list of compatible browsers here:"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://caniuse.com/#feat=websockets"},"children":[{"block_type":"text","content":"http://caniuse.com/#feat=websockets"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cow","search_text":"Pointing a browser to http://localhost:8080 should present an interface similar to the following:","text_count":97,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Pointing a browser to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:8080"}]},{"block_type":"text","content":"should present an interface similar to the following:"}]},{"block_type":"element","block":"k5zy5cox","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000021.jpg","alt":"Running and scaling the chat application","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5coy","search_text":"What we want to show now is what happens when we try to scale our application by launching multiple instances. Let's try to do this, let's start another server on another port:","text_count":176,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"What we want to show now is what happens when we try to scale our application by launching multiple instances. Let's try to do this, let's start another server on another port:"}]},{"block_type":"element","block":"k5zy5coz","search_text":"node app 8081 ","text_count":14,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app 8081"}]}]},{"block_type":"element","block":"k5zy5cp0","search_text":"The desired outcome of scaling our chat application should be that the two clients connecting to the two different servers should be able to exchange chat messages. Unfortunately, this is not what happens with our current implementation; we can try that by opening another browser tab to http://localhost:8081 .","text_count":311,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The desired outcome of scaling our chat application should be that the two clients connecting to the two different servers should be able to exchange chat messages. Unfortunately, this is not what happens with our current implementation; we can try that by opening another browser tab to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"http://localhost:8081"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5cp1","search_text":"When sending a chat message on one instance, we broadcast a message locally, distributing it to only the clients connected to that particular server. In practice, the two servers don't talk to each other. We need to integrate them.","text_count":231,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When sending a chat message on one instance, we broadcast a message locally, distributing it to only the clients connected to that particular server. In practice, the two servers don't talk to each other. We need to integrate them."}]},{"block_type":"element","block":"k5zy5cp2","search_text":"Note In a real application, we will use a load balancer to distribute the load across our instances, but for this demo, we will not use one. This allows us to access each server in a deterministic way to verify how it interacts with the other instances. ","text_count":254,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a real application, we will use a load balancer to distribute the load across our instances, but for this demo, we will not use one. This allows us to access each server in a deterministic way to verify how it interacts with the other instances."}]}]},{"block_type":"element","block":"k5zy5cp3","search_text":"Using Redis as a message broker","text_count":31,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Using Redis as a message broker"}]},{"block_type":"element","block":"k5zy5cp4","search_text":"We start our analysis of the most important pub/sub implementations by introducing Redis ( http://redis.io ), which is a very fast and flexible key/value store, also defined by many as a data structure server . Redis is more a database than a message broker; however, among its many features there is a pair of commands specifically designed to implement a centralized pub/sub pattern.","text_count":385,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We start our analysis of the most important pub/sub implementations by introducing"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Redis"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://redis.io"},"children":[{"block_type":"text","content":"http://redis.io"}]},{"block_type":"text","content":"), which is a very fast and flexible key/value store, also defined by many as a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"data structure server"}]},{"block_type":"text","content":". Redis is more a database than a message broker; however, among its many features there is a pair of commands specifically designed to implement a centralized pub/sub pattern."}]},{"block_type":"element","block":"k5zy5cp5","search_text":"Of course, this implementation is very simple and basic, compared to more advanced message-oriented middleware, but this is one of the main reasons for its popularity. Often, in fact, Redis is already available in an existing infrastructure, for example, as a caching server or session store; its speed and flexibility make it a very popular choice for sharing data in a distributed system. So, as soon as the need for a publish/subscribe broker arises in a project, the most simple and immediate choice is to reuse Redis itself, avoiding the need to install and maintain a dedicated message broker. Let's work on an example to demonstrate its simplicity and power.","text_count":665,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Of course, this implementation is very simple and basic, compared to more advanced message-oriented middleware, but this is one of the main reasons for its popularity. Often, in fact, Redis is already available in an existing infrastructure, for example, as a caching server or session store; its speed and flexibility make it a very popular choice for sharing data in a distributed system. So, as soon as the need for a publish/subscribe broker arises in a project, the most simple and immediate choice is to reuse Redis itself, avoiding the need to install and maintain a dedicated message broker. Let's work on an example to demonstrate its simplicity and power."}]},{"block_type":"element","block":"k5zy5cp6","search_text":"Note This example requires a working installation of Redis, listening on its default port. You can find more details at http://redis.io/topics/quickstart . ","text_count":156,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This example requires a working installation of Redis, listening on its default port. You can find more details at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://redis.io/topics/quickstart"},"children":[{"block_type":"text","content":"http://redis.io/topics/quickstart"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cp7","search_text":"Our plan of action is to integrate our chat servers using Redis as a message broker. Each instance publishes any message received from its clients to the broker, and at the same time it subscribes for any message coming from other server instances. As we can see, each server in our architecture is both a subscriber and a publisher. The following figure shows a representation of the architecture that we want to obtain:","text_count":421,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our plan of action is to integrate our chat servers using Redis as a message broker. Each instance publishes any message received from its clients to the broker, and at the same time it subscribes for any message coming from other server instances. As we can see, each server in our architecture is both a subscriber and a publisher. The following figure shows a representation of the architecture that we want to obtain:"}]},{"block_type":"element","block":"k5zy5cp8","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000007.jpg","alt":"Using Redis as a message broker","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cp9","search_text":"By looking at the preceding figure, we can sum up the journey of a message as follows:","text_count":86,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"By looking at the preceding figure, we can sum up the journey of a message as follows:"}]},{"block_type":"element","block":"k5zy5cpa","search_text":"The message is typed into the textbox of the web page and sent to the connected instance of our chat server. The message is then published to the broker. The broker dispatches the message to all the subscribers, which in our architecture are all the instances of the chat server. In each instance, the message is distributed to all the connected clients. ","text_count":355,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The message is typed into the textbox of the web page and sent to the connected instance of our chat server."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The message is then published to the broker."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The broker dispatches the message to all the subscribers, which in our architecture are all the instances of the chat server."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"In each instance, the message is distributed to all the connected clients."}]}]},{"block_type":"element","block":"k5zy5cpb","search_text":"Note Redis allows publishing and subscribing to channels, which are identified by a string, for example, chat.nodejs . It also allows us to use glob-style patterns to define subscriptions that can potentially match multiple channels, for example, chat.* . ","text_count":256,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Redis"}]},{"block_type":"text","content":"allows publishing and subscribing to channels, which are identified by a string, for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat.nodejs"}]},{"block_type":"text","content":". It also allows us to use glob-style patterns to define subscriptions that can potentially match multiple channels, for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat.*"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cpc","search_text":"Let's see in practice how this works. Let's modify the server code by adding the publish/subscribe logic:","text_count":105,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see in practice how this works. Let's modify the server code by adding the publish/subscribe logic:"}]},{"block_type":"element","block":"k5zy5cpd","search_text":"const WebSocketServer = require('ws').Server; const redis = require(\"redis\"); // [1] const redisSub = redis.createClient(); const redisPub = redis.createClient(); //static file server const server = require('http').createServer( require('ecstatic')({root: `${__dirname}/www`}) ); const wss = new WebSocketServer({server: server}); wss.on('connection', ws => { console.log('Client connected'); ws.on('message', msg => { console.log(`Message: ${msg}`); redisPub.publish('chat_messages', msg); // [2] }); }); redisSub.subscribe('chat_messages'); // [3] redisSub.on('message', (channel, msg) => { wss.clients.forEach((client) => { client.send(msg); }); }); server.listen(process.argv[2] || 8080);","text_count":692,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const WebSocketServer = require('ws').Server; \nconst redis = require(\"redis\");                // [1] \nconst redisSub = redis.createClient(); \nconst redisPub = redis.createClient(); \n \n//static file server \nconst server = require('http').createServer( \n  require('ecstatic')({root: `${__dirname}/www`}) \n); \n \nconst wss = new WebSocketServer({server: server}); \nwss.on('connection', ws =&gt; { \n  console.log('Client connected'); \n  ws.on('message', msg =&gt; { \n    console.log(`Message: ${msg}`); \n    redisPub.publish('chat_messages', msg);    // [2] \n  }); \n}); \n \nredisSub.subscribe('chat_messages');           // [3] \nredisSub.on('message', (channel, msg) =&gt; { \n  wss.clients.forEach((client) =&gt; { \n    client.send(msg); \n  }); \n}); \n \nserver.listen(process.argv[2] || 8080);"}]}]},{"block_type":"element","block":"k5zy5cpe","search_text":"The changes that we made to our original chat server are highlighted in the preceding code; this is how it works:","text_count":113,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The changes that we made to our original chat server are highlighted in the preceding code; this is how it works:"}]},{"block_type":"element","block":"k5zy5cpf","search_text":"To connect our Node.js application to the Redis server, we use the redis package ( https://npmjs.org/package/redis ), which is a complete client that supports all the available Redis commands. Next, we instantiate two different connections, one used to subscribe to a channel, the other to publish messages. This is necessary in Redis, because once a connection is put in subscriber mode , only commands related to the subscription can be used. This means that we need a second connection for publishing messages. When a new message is received from a connected client, we publish a message in the chat_messages channel. We don't directly broadcast the message to our clients because our server is subscribed to the same channel (as we will see in a moment), so it will come back to us through Redis. For the scope of this example, this is a simple and effective mechanism. As we said, our server also has to subscribe to the chat_messages channel, so we register a listener to receive all the messages published into that channel (either by the current server or any other chat server). When a message is received, we simply broadcast it to all the clients connected to the current WebSocket server. ","text_count":1201,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"To connect our Node.js application to the Redis server, we use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"redis"}]},{"block_type":"text","content":"&nbsp;package ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/redis"},"children":[{"block_type":"text","content":"https://npmjs.org/package/redis"}]},{"block_type":"text","content":"), which is a complete client that supports all the available Redis commands. Next, we instantiate two different connections, one used to subscribe to a channel, the other to publish messages. This is necessary in Redis, because once a connection is put in"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"subscriber mode"}]},{"block_type":"text","content":", only commands related to the subscription can be used. This means that we need a second connection for publishing messages."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When a new message is received from a connected client, we publish a message in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat_messages"}]},{"block_type":"text","content":"channel. We don't directly broadcast the message to our clients because our server is subscribed to the same channel (as we will see in a moment), so it will come back to us through Redis. For the scope of this example, this is a simple and effective mechanism."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"As we said, our server also has to subscribe to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat_messages"}]},{"block_type":"text","content":"channel, so we register a listener to receive all the messages published into that channel (either by the current server or any other chat server). When a message is received, we simply broadcast it to all the clients connected to the current WebSocket server."}]}]},{"block_type":"element","block":"k5zy5cpg","search_text":"These few changes are enough to integrate all the chat servers that we might decide to start. To prove this, we can try starting multiple instances of our application:","text_count":167,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"These few changes are enough to integrate all the chat servers that we might decide to start. To prove this, we can try starting multiple instances of our application:"}]},{"block_type":"element","block":"k5zy5cph","search_text":"node app 8080 node app 8081 node app 8082 ","text_count":42,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app 8080\nnode app 8081\nnode app 8082"}]}]},{"block_type":"element","block":"k5zy5cpi","search_text":"We can then connect multiple browsers' tabs to each instance and verify that the messages we send to one server are successfully received by all the other clients connected to different servers. Congratulations! We just integrated a distributed real-time application using the publish/subscribe pattern.","text_count":303,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can then connect multiple browsers' tabs to each instance and verify that the messages we send to one server are successfully received by all the other clients connected to different servers. Congratulations! We just integrated a distributed real-time application using the publish/subscribe pattern."}]},{"block_type":"element","block":"k5zy5cpj","search_text":"Peer-to-peer publish/subscribe with ØMQ","text_count":39,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Peer-to-peer publish/subscribe with &Oslash;MQ"}]},{"block_type":"element","block":"k5zy5cpk","search_text":"The presence of a broker can considerably simplify the architecture of a messaging system; however, there are circumstances where it is not an optimal solution, such as, for example, when latency is critical, when scaling complex distributed systems, or when the presence of a single point of failure is not an option.","text_count":318,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The presence of a broker can considerably simplify the architecture of a messaging system; however, there are circumstances where it is not an optimal solution, such as, for example, when latency is critical, when scaling complex distributed systems, or when the presence of a single point of failure is not an option."}]},{"block_type":"element","block":"k5zy5cpl","search_text":"Introducing ØMQ","text_count":15,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Introducing &Oslash;MQ"}]},{"block_type":"element","block":"k5zy5cpm","search_text":"If our project falls in the category of possible candidates for a peer-to-peer message exchange, the best solution to evaluate is certainly ØMQ ( http://zeromq.org , also known as zmq, ZeroMQ, or 0MQ); we already mentioned this library earlier in the book. ØMQ is a networking library that provides the basic tools to build a large variety of messaging patterns. It is low-level, extremely fast, and has a minimalistic API but it offers all the basic building blocks of a messaging system, such as atomic messages, load balancing, queues, and many more. It supports many types of transport, such as in-process channels ( inproc:// ), inter-process communication ( ipc:// ), multicast using the PGM protocol ( pgm:// or epgm:// ), and, of course, the classic TCP ( tcp:// ).","text_count":773,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If our project falls in the category of possible candidates for a peer-to-peer message exchange, the best solution to evaluate is certainly"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"&Oslash;MQ"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://zeromq.org"},"children":[{"block_type":"text","content":"http://zeromq.org"}]},{"block_type":"text","content":", also known as zmq, ZeroMQ, or 0MQ); we already mentioned this library earlier in the book. &Oslash;MQ is a networking library that provides the basic tools to build a large variety of messaging patterns. It is low-level, extremely fast, and has a minimalistic API but it offers all the basic building blocks of a messaging system, such as atomic messages, load balancing, queues, and many more. It supports many types of transport, such as in-process channels ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inproc://"}]},{"block_type":"text","content":"), inter-process communication ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ipc://"}]},{"block_type":"text","content":"), multicast using the PGM protocol ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"pgm://"}]},{"block_type":"text","content":"or"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"epgm://"}]},{"block_type":"text","content":"), and, of course, the classic TCP ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"tcp://"}]},{"block_type":"text","content":")."}]},{"block_type":"element","block":"k5zy5cpn","search_text":"Among the features of ØMQ, we can also find tools to implement a publish/subscribe pattern, exactly what we need for our example. So, what we are going to do now is remove the broker (Redis) from the architecture of our chat application and let the various nodes communicate in a peer-to-peer fashion, leveraging the publish/subscribe sockets of ØMQ.","text_count":350,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Among the features of &Oslash;MQ, we can also find tools to implement a publish/subscribe pattern, exactly what we need for our example. So, what we are going to do now is remove the broker (Redis) from the architecture of our chat application and let the various nodes communicate in a peer-to-peer fashion, leveraging the publish/subscribe sockets of &Oslash;MQ."}]},{"block_type":"element","block":"k5zy5cpo","search_text":"Note A ØMQ socket can be considered a network socket on steroids, which provides additional abstractions to help implement the most common messaging patterns. For example, we can find sockets designed to implement publish/subscribe, request/reply, or one-way communications. ","text_count":275,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A &Oslash;MQ socket can be considered a network socket on steroids, which provides additional abstractions to help implement the most common messaging patterns. For example, we can find sockets designed to implement publish/subscribe, request/reply, or one-way communications."}]}]},{"block_type":"element","block":"k5zy5cpp","search_text":"Designing a peer-to-peer architecture for the chat server","text_count":57,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Designing a peer-to-peer architecture for the chat server"}]},{"block_type":"element","block":"k5zy5cpq","search_text":"When we remove the broker from our architecture, each instance of the chat application has to directly connect to the other available instances in order to receive the messages they publish. In ØMQ, we have two types of sockets specifically designed for this purpose: PUB and SUB . The typical pattern is to bind a PUB socket to a port that will start listening for subscriptions coming from the other SUB sockets.","text_count":414,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When we remove the broker from our architecture, each instance of the chat application has to directly connect to the other available instances in order to receive the messages they publish. In &Oslash;MQ, we have two types of sockets specifically designed for this purpose:"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SUB"}]},{"block_type":"text","content":". The typical pattern is to bind a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"socket to a port that will start listening for subscriptions coming from the other"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SUB"}]},{"block_type":"text","content":"sockets."}]},{"block_type":"element","block":"k5zy5cpr","search_text":"A subscription can have a filter that specifies what messages will be delivered to the SUB sockets. The filter is a simple binary buffer (so it can also be a string), which will be matched against the beginning of the message (which is also a binary buffer). When a message is sent through the PUB socket it is broadcast to all the connected SUB sockets, but only after their subscription filters are applied. The filters will be applied to the publisher side only if a connected protocol is used, such as, for example, TCP.","text_count":524,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A subscription can have a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"filter"}]},{"block_type":"text","content":"that specifies what messages will be delivered to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SUB"}]},{"block_type":"text","content":"sockets. The filter is a simple"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"binary buffer"}]},{"block_type":"text","content":"(so it can also be a string), which will be matched against the beginning of the message (which is also a binary buffer). When a message is sent through the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"socket it is broadcast to all the connected"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SUB"}]},{"block_type":"text","content":"sockets, but only after their subscription filters are applied. The filters will be applied to the publisher side only if a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"connected"}]},{"block_type":"text","content":"protocol is used, such as, for example, TCP."}]},{"block_type":"element","block":"k5zy5cps","search_text":"The following figure shows the pattern applied to our distributed chat server architecture (with only two instances, for simplicity):","text_count":133,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following figure shows the pattern applied to our distributed chat server architecture (with only two instances, for simplicity):"}]},{"block_type":"element","block":"k5zy5cpt","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000005.jpg","alt":"Designing a peer-to-peer architecture for the chat server","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cpu","search_text":"The preceding figure shows us the flow of information when we have two instances of the chat application, but the same concept can be applied for N instances. The architecture tells us that each node must be aware of the other nodes in the system, to be able to establish all the necessary connections. It also shows us how the subscriptions go from a SUB socket to a PUB socket, while messages travel in the opposite direction.","text_count":428,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding figure shows us the flow of information when we have two instances of the chat application, but the same concept can be applied for"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"N"}]},{"block_type":"text","content":"instances. The architecture tells us that each node must be aware of the other nodes in the system, to be able to establish all the necessary connections. It also shows us how the subscriptions go from a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SUB"}]},{"block_type":"text","content":"socket to a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"socket, while messages travel in the opposite direction."}]},{"block_type":"element","block":"k5zy5cpv","search_text":"Note To run the example in this section, you need to install the native ØMQ binaries on your system. You can find more information at http://zeromq.org/intro:get-the-software . Note: this example was tested against the 4.0 branch of ØMQ. ","text_count":238,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To run the example in this section, you need to install the native &Oslash;MQ binaries on your system. You can find more information at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://zeromq.org/intro:get-the-software"},"children":[{"block_type":"text","content":"http://zeromq.org/intro:get-the-software"}]},{"block_type":"text","content":". Note: this example was tested against the 4.0 branch of &Oslash;MQ."}]}]},{"block_type":"element","block":"k5zy5cpw","search_text":"Using the ØMQ PUB/SUB sockets","text_count":29,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Using the &Oslash;MQ PUB/SUB sockets"}]},{"block_type":"element","block":"k5zy5cpx","search_text":"Let's see how this works in practice by modifying our chat server (we will show you only the changed parts):","text_count":108,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see how this works in practice by modifying our chat server (we will show you only the changed parts):"}]},{"block_type":"element","block":"k5zy5cpy","search_text":"// ... const args = require('minimist')(process.argv.slice(2)); //[1] const zmq = require('zmq'); const pubSocket = zmq.socket('pub'); //[2] pubSocket.bind(`tcp://127.0.0.1:${args['pub']}`); const subSocket = zmq.socket('sub'); //[3] const subPorts = [].concat(args['sub']); subPorts.forEach(p => { console.log(`Subscribing to ${p}`); subSocket.connect(`tcp://127.0.0.1:${p}`); }); subSocket.subscribe('chat'); // ... ws.on('message', msg => { //[4] console.log(`Message: ${msg}`); broadcast(msg); pubSocket.send(`chat ${msg}`); }); //... subSocket.on('message', msg => { //[5] console.log(`From other server: ${msg}`); broadcast(msg.toString().split(' ')[1]); }); // ... server.listen(args['http'] || 8080); ","text_count":709,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \nconst args = require('minimist')(process.argv.slice(2));   //[1] \nconst zmq = require('zmq'); \n \nconst pubSocket = zmq.socket('pub');                       //[2] \npubSocket.bind(`tcp://127.0.0.1:${args['pub']}`); \n \nconst subSocket = zmq.socket('sub');                       //[3] \nconst subPorts = [].concat(args['sub']); \nsubPorts.forEach(p =&gt; { \n  console.log(`Subscribing to ${p}`); \n  subSocket.connect(`tcp://127.0.0.1:${p}`); \n}); \nsubSocket.subscribe('chat'); \n \n// ... \nws.on('message', msg =&gt; {                                  //[4] \n  console.log(`Message: ${msg}`); \n  broadcast(msg); \n  pubSocket.send(`chat ${msg}`); \n}); \n//... \n \nsubSocket.on('message', msg =&gt; {                           //[5] \n  console.log(`From other server: ${msg}`); \n  broadcast(msg.toString().split(' ')[1]); \n}); \n \n// ... \nserver.listen(args['http'] || 8080);"}]}]},{"block_type":"element","block":"k5zy5cpz","search_text":"The preceding code clearly shows that the logic of our application became slightly more complicated; however, it's still straightforward considering that we are implementing a distributed and peer-to-peer publish/subscribe pattern. Let's see how all the pieces come together:","text_count":275,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding code clearly shows that the logic of our application became slightly more complicated; however, it's still straightforward considering that we are implementing a distributed and peer-to-peer publish/subscribe pattern. Let's see how all the pieces come together:"}]},{"block_type":"element","block":"k5zy5cq0","search_text":"We require the zmq package ( https://npmjs.org/package/zmq ), which is essentially the Node.js binding for the ØMQ native library. We also require minimist ( https://npmjs.org/package/minimist ), which is a command-line argument parser; we need this to be able to easily accept named arguments. We immediately create our PUB socket and bind it to the port provided in the --pub command-line argument. We create the SUB socket and we connect it to the PUB sockets of the other instances of our application. The ports of the target PUB sockets are provided in the --sub command-line arguments (there might be more than one). We then create the actual subscription, by providing chat as a filter, which means that we will receive only the messages beginning with chat . When a new message is received by our WebSocket, we broadcast it to all the connected clients but we also publish it through our PUB socket. We use chat as a prefix followed by a space, so the message will be published to all the subscriptions using chat as a filter. We start listening for messages that arrive at our SUB socket, we do some simple parsing of the message to remove the chat prefix, and then we broadcast it to all the clients connected to the current WebSocket server. ","text_count":1253,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We require the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"zmq"}]},{"block_type":"text","content":"package ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/zmq"},"children":[{"block_type":"text","content":"https://npmjs.org/package/zmq"}]},{"block_type":"text","content":"), which is essentially the Node.js binding for the &Oslash;MQ native library. We also require"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"minimist"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/minimist"},"children":[{"block_type":"text","content":"https://npmjs.org/package/minimist"}]},{"block_type":"text","content":"), which is a command-line argument parser; we need this to be able to easily accept named arguments."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We immediately create our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"socket and bind it to the port provided in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"--pub"}]},{"block_type":"text","content":"command-line argument."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We create the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SUB"}]},{"block_type":"text","content":"socket and we connect it to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"sockets of the other instances of our application. The ports of the target"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"sockets are provided in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"--sub"}]},{"block_type":"text","content":"command-line arguments (there might be more than one). We then create the actual subscription, by providing"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat"}]},{"block_type":"text","content":"as a filter, which means that we will receive only the messages beginning with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat"}]},{"block_type":"text","content":"."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"When a new message is received by our WebSocket, we broadcast it to all the connected clients but we also publish it through our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"socket. We use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat"}]},{"block_type":"text","content":"as a prefix followed by a space, so the message will be published to all the subscriptions using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat"}]},{"block_type":"text","content":"as a filter."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We start listening for messages that arrive at our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SUB"}]},{"block_type":"text","content":"socket, we do some simple parsing of the message to remove the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat"}]},{"block_type":"text","content":"prefix, and then we broadcast it to all the clients connected to the current WebSocket server."}]}]},{"block_type":"element","block":"k5zy5cq1","search_text":"We have now built a simple distributed system, integrated using a peer-to-peer publish/subscribe pattern!","text_count":105,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We have now built a simple distributed system, integrated using a peer-to-peer publish/subscribe pattern!"}]},{"block_type":"element","block":"k5zy5cq2","search_text":"Let's fire it up, let's start three instances of our application by making sure to connect their PUB and SUB sockets properly:","text_count":126,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's fire it up, let's start three instances of our application by making sure to connect their"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SUB"}]},{"block_type":"text","content":"sockets properly:"}]},{"block_type":"element","block":"k5zy5cq3","search_text":"node app --http 8080 --pub 5000 --sub 5001 --sub 5002 node app --http 8081 --pub 5001 --sub 5000 --sub 5002 node app --http 8082 --pub 5002 --sub 5000 --sub 5001 ","text_count":162,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app --http 8080 --pub 5000 --sub 5001 --sub 5002\nnode app --http 8081 --pub 5001 --sub 5000 --sub 5002\nnode app --http 8082 --pub 5002 --sub 5000 --sub 5001"}]}]},{"block_type":"element","block":"k5zy5cq4","search_text":"The first command will start an instance with an HTTP server listening on port 8080 , while binding a PUB socket on port 5000 and connecting the SUB socket to ports 5001 and 5002 , which is where the PUB sockets of the other two instances should be listening at. The other two commands work in a similar way.","text_count":308,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first command will start an instance with an HTTP server listening on port"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"8080"}]},{"block_type":"text","content":", while binding a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"socket on port"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"5000"}]},{"block_type":"text","content":"and connecting the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SUB"}]},{"block_type":"text","content":"socket to ports"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"5001"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"5002"}]},{"block_type":"text","content":", which is where the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"sockets of the other two instances should be listening at. The other two commands work in a similar way."}]},{"block_type":"element","block":"k5zy5cq5","search_text":"Now, the first thing we can see is that ØMQ will not complain if a port corresponding to a PUB socket is not available. For example, at the time of the first command, there is nobody listening on ports 5001 and 5002 ; however, ØMQ is not throwing any error. This is because ØMQ has a reconnection mechanism that will automatically try to establish a connection to these ports at regular time intervals. This feature also comes in particularly handy if any node goes down or is restarted. The same forgiving logic applies to the PUB socket: if there are no subscriptions, it will simply drop all the messages, but it will continue working.","text_count":638,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, the first thing we can see is that &Oslash;MQ will not complain if a port corresponding to a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"socket is not available. For example, at the time of the first command, there is nobody listening on ports"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"5001"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"5002"}]},{"block_type":"text","content":"; however, &Oslash;MQ is not throwing any error. This is because &Oslash;MQ has a reconnection mechanism that will automatically try to establish a connection to these ports at regular time intervals. This feature also comes in particularly handy if any node goes down or is restarted. The same"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"forgiving"}]},{"block_type":"text","content":"logic applies to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"socket: if there are no subscriptions, it will simply drop all the messages, but it will continue working."}]},{"block_type":"element","block":"k5zy5cq6","search_text":"At this point, we can try to navigate with a browser to any of the server instances that we started and verify that the messages are properly broadcast to all the chat servers.","text_count":176,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"At this point, we can try to navigate with a browser to any of the server instances that we started and verify that the messages are properly broadcast to all the chat servers."}]},{"block_type":"element","block":"k5zy5cq7","search_text":"Tip In the previous example, we assumed a static architecture, where the number of instances and their addresses are known in advance. We can introduce a service registry, as explained in the previous chapter, to connect our instances dynamically. It is also important to point out that ØMQ can be used to implement a broker using the same primitives we demonstrated here. ","text_count":373,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous example, we assumed a static architecture, where the number of instances and their addresses are known in advance. We can introduce a service registry, as explained in the previous chapter, to connect our instances dynamically. It is also important to point out that &Oslash;MQ can be used to implement a broker using the same primitives we demonstrated here."}]}]},{"block_type":"element","block":"k5zy5cq8","search_text":"Durable subscribers","text_count":19,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Durable subscribers"}]},{"block_type":"element","block":"k5zy5cq9","search_text":"An important abstraction in a messaging system is the message queue ( MQ ). With a message queue, the sender and the receiver(s) of the message don't necessarily need to be active and connected at the same time to establish a communication, because the queuing system takes care of storing the messages until the destination is able to receive them. This behavior is opposed to the set and forget paradigm, where a subscriber can receive messages only during the time it is connected to the messaging system.","text_count":508,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"An important abstraction in a messaging system is the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"message queue&nbsp;"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"MQ"}]},{"block_type":"text","content":"). With a message queue, the sender and the receiver(s) of the message don't necessarily need to be active and connected at the same time to establish a communication, because the queuing system takes care of storing the messages until the destination is able to receive them. This behavior is opposed to the set and forget paradigm, where a subscriber can receive messages only during the time it is connected to the messaging system."}]},{"block_type":"element","block":"k5zy5cqa","search_text":"A subscriber that is able to always reliably receive all the messages, even those sent when it's not listening for them, is called a durable subscriber .","text_count":153,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A subscriber that is able to always reliably receive all the messages, even those sent when it's not listening for them, is called a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"durable subscriber"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5cqb","search_text":"Tip The MQTT protocol defines a level of Quality of Service ( QoS ) for the messages exchanged between the sender and receiver. These levels are also very useful to describe the reliability of any other messaging system (not only MQTT). These are as follows: ","text_count":259,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The MQTT protocol defines a level of"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Quality of Service"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"QoS"}]},{"block_type":"text","content":") for the messages exchanged between the sender and receiver. These levels are also very useful to describe the reliability of any other messaging system (not only MQTT). These are as follows:"}]}]},{"block_type":"element","block":"k5zy5cqc","search_text":"QoS0, at most once : Also known as set and forget, the message is not persisted, and the delivery is not acknowledged. This means that the message can be lost in cases of crashes or disconnections of the receiver. QoS1, at least once : The message is guaranteed to be received at least once, but duplicates might occur if, for example, the receiver crashes before notifying the sender. This implies that the message has to be persisted in the eventuality it has to be sent again. QoS2, exactly once : This is the most reliable QoS; it guarantees that the message is received once and only once. This comes at the expense of a slower and more data-intensive mechanism for acknowledging the delivery of messages. ","text_count":711,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"QoS0, at most once"}]},{"block_type":"text","content":": Also known as set and forget, the message is not persisted, and the delivery is not acknowledged. This means that the message can be lost in cases of crashes or disconnections of the receiver."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"QoS1, at least once"}]},{"block_type":"text","content":": The message is guaranteed to be received at least once, but duplicates might occur if, for example, the receiver crashes before notifying the sender. This implies that the message has to be persisted in the eventuality it has to be sent again."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"QoS2, exactly once"}]},{"block_type":"text","content":": This is the most reliable QoS; it guarantees that the message is received once and only once. This comes at the expense of a slower and more data-intensive mechanism for acknowledging the delivery of messages."}]}]},{"block_type":"element","block":"k5zy5cqd","search_text":"Tip Find out more in the MQTT specifications at http://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html#qos-flows . ","text_count":133,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Find out more in the MQTT specifications at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html#qos-flows"},"children":[{"block_type":"text","content":"http://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html#qos-flows"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cqe","search_text":"As we said, to allow durable subscribers, our system has to use a message queue to accumulate the messages while the subscriber is disconnected. The queue can be stored in memory or persisted on disk to allow the recovery of its messages even if the broker restarts or crashes. The following figure shows a graphical representation of a durable subscriber backed by a message queue:","text_count":382,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we said, to allow durable subscribers, our system has to use a message queue to accumulate the messages while the subscriber is disconnected. The queue can be stored in memory or persisted on disk to allow the recovery of its messages even if the broker restarts or crashes. The following figure shows a graphical representation of a durable subscriber backed by a message queue:"}]},{"block_type":"element","block":"k5zy5cqf","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000053.jpg","alt":"Durable subscribers","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cqg","search_text":"The durable subscriber is probably the most important pattern enabled by a message queue, but it's certainly not the only one, as we will see later in the chapter.","text_count":163,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The durable subscriber is probably the most important pattern enabled by a message queue, but it's certainly not the only one, as we will see later in the chapter."}]},{"block_type":"element","block":"k5zy5cqh","search_text":"Tip The Redis publish/subscribe commands implement a set and forget mechanism (QoS0). However, Redis can still be used to implement a durable subscriber using a combination of other commands (without relying directly on its publish/subscribe implementation). You can find a description of this technique in the following blog posts: http://davidmarquis.wordpress.com/2013/01/03/reliable-delivery-message-queues-with-redis http://www.ericjperry.com/redis-message-queue ØMQ defines some patterns to support durable subscribers as well, but it's mostly up to us to implement this mechanism. ","text_count":588,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The Redis publish/subscribe commands implement a set and forget mechanism (QoS0). However, Redis can still be used to implement a durable subscriber using a combination of other commands (without relying directly on its publish/subscribe implementation). You can find a description of this technique in the following blog posts:"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"http://davidmarquis.wordpress.com/2013/01/03/reliable-delivery-message-queues-with-redis"},"children":[{"block_type":"text","content":"http://davidmarquis.wordpress.com/2013/01/03/reliable-delivery-message-queues-with-redis"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.ericjperry.com/redis-message-queue"},"children":[{"block_type":"text","content":"http://www.ericjperry.com/redis-message-queue"}]}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"&Oslash;MQ defines some patterns to support durable subscribers as well, but it's mostly up to us to implement this mechanism."}]}]},{"block_type":"element","block":"k5zy5cqi","search_text":"Introducing AMQP","text_count":16,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Introducing AMQP"}]},{"block_type":"element","block":"k5zy5cqj","search_text":"A message queue is normally used in situations where message can't be lost, which includes mission-critical applications such as banking or financial systems. This usually means that the typical enterprise-grade message queue is a very complex piece of software, which utilizes bulletproof protocols and persistent storage to guarantee the delivery of the message even in the presence of malfunctions. For this reason, enterprise messaging middleware has been, for many years, a prerogative of giants such as Oracle and IBM, each one of them usually implementing its own proprietary protocol, resulting in a strong customer lock-in. Fortunately, it's been a few years now since messaging systems entered the mainstream, thanks to the growth of open protocols such as AMQP, STOMP, and MQTT. To understand how a message queuing system works, we are now going to give an overview of AMQP; this is fundamental to understand how to use a typical API based on this protocol.","text_count":968,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A message queue is normally used in situations where message can't be lost, which includes mission-critical applications such as banking or financial systems. This usually means that the typical enterprise-grade message queue is a very complex piece of software, which utilizes bulletproof protocols and persistent storage to guarantee the delivery of the message even in the presence of malfunctions. For this reason, enterprise messaging middleware has been, for many years, a prerogative of giants such as Oracle and IBM, each one of them usually implementing its own proprietary protocol, resulting in a strong customer lock-in. Fortunately, it's been a few years now since messaging systems entered the mainstream, thanks to the growth of open protocols such as AMQP, STOMP, and MQTT. To understand how a message queuing system works, we are now going to give an overview of AMQP; this is fundamental to understand how to use a typical API based on this protocol."}]},{"block_type":"element","block":"k5zy5cqk","search_text":"AMQP is an open standard protocol supported by many message-queuing systems. Besides defining a common communication protocol, it also provides a model for describing routing, filtering, queuing, reliability, and security. In AMQP, there are three essential components:","text_count":269,"tag_name":"p","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"AMQP&nbsp;"}]},{"block_type":"text","content":"is an open standard protocol supported by many message-queuing systems. Besides defining a common communication protocol, it also provides a model for describing routing, filtering, queuing, reliability, and security. In AMQP, there are three essential components:"}]},{"block_type":"element","block":"k5zy5cql","search_text":"Queue : The data structure responsible for storing the messages consumed by the clients. The messages from a queue are pushed (or pulled) to one or more consumers essentially, our applications. If multiple consumers are attached to the same queue, the messages are load balanced across them. A queue can be one of the following: Durable : This means that the queue is automatically recreated if the broker restarts. A durable queue does not imply that its contents are preserved as well; in fact, only messages that are marked as persistent are saved to the disk and restored in case of a restart. Exclusive : This means that the queue is bound to only one particular subscriber connection. When the connection is closed, the queue is destroyed. Auto-delete : This will cause the queue to be deleted when the last subscriber disconnects. Exchange : This is where a message is published. An exchange routes the messages to one or more queues depending on the algorithm it implements: Direct exchange : It routes the messages by matching an entire routing key (for example, chat.msg ). Topic exchange : It distributes the messages using a glob-like pattern matched against the routing key (for example, chat.# matches all the routing keys starting with chat ). Fanout exchange : It broadcasts a message to all the connected queues, ignoring any routing key provided. Binding : This is the link between exchanges and queues. It also defines the routing key or the pattern used to filter the messages that arrive from the exchange. ","text_count":1528,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Queue"}]},{"block_type":"text","content":": The data structure responsible for storing the messages consumed by the clients. The messages from a queue are pushed (or pulled) to one or more consumers essentially, our applications. If multiple consumers are attached to the same queue, the messages are load balanced across them. A queue can be one of the following:"},{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Durable"}]},{"block_type":"text","content":": This means that the queue is automatically recreated if the broker restarts. A durable queue does not imply that its contents are preserved as well; in fact, only messages that are marked as persistent are saved to the disk and restored in case of a restart."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Exclusive"}]},{"block_type":"text","content":": This means that the queue is bound to only one particular subscriber connection. When the connection is closed, the queue is destroyed."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Auto-delete"}]},{"block_type":"text","content":": This will cause the queue to be deleted when the last subscriber disconnects."}]}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Exchange"}]},{"block_type":"text","content":": This is where a message is published. An exchange routes the messages to one or more queues depending on the algorithm it implements:"},{"block_type":"element","tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Direct exchange"}]},{"block_type":"text","content":": It routes the messages by matching an entire routing key (for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat.msg"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Topic exchange"}]},{"block_type":"text","content":": It distributes the messages using a glob-like pattern matched against the routing key (for example,"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat.#"}]},{"block_type":"text","content":"matches all the routing keys starting with"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat"}]},{"block_type":"text","content":")."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Fanout exchange"}]},{"block_type":"text","content":": It broadcasts a message to all the connected queues, ignoring any routing key provided."}]}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"Binding"}]},{"block_type":"text","content":": This is the link between exchanges and queues. It also defines the routing key or the pattern used to filter the messages that arrive from the exchange."}]}]},{"block_type":"element","block":"k5zy5cqm","search_text":"These components are managed by a broker, which exposes an API for creating and manipulating them. When connecting to a broker, a client creates a channel—an abstraction of a connection—which is responsible for maintaining the state of the communication with the broker.","text_count":270,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"These components are managed by a broker, which exposes an API for creating and manipulating them. When connecting to a broker, a client creates a channel&mdash;an abstraction of a connection&mdash;which is responsible for maintaining the state of the communication with the broker."}]},{"block_type":"element","block":"k5zy5cqn","search_text":"Note In AMQP, the durable subscriber pattern can be obtained by creating any type of queue that is not exclusive or auto-delete. ","text_count":129,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In AMQP, the durable subscriber pattern can be obtained by creating any type of queue that is not exclusive or auto-delete."}]}]},{"block_type":"element","block":"k5zy5cqo","search_text":"The following figure shows us all these components put together:","text_count":64,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following figure shows us all these components put together:"}]},{"block_type":"element","block":"k5zy5cqp","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000013.jpg","alt":"Introducing AMQP","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cqq","search_text":"The AMQP model is way more complex than the messaging systems we have used so far (Redis and ØMQ); however, it offers a set of features and a reliability that would be very hard to obtain using only primitive publish/subscribe mechanisms.","text_count":238,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The AMQP model is way more complex than the messaging systems we have used so far (Redis and &Oslash;MQ); however, it offers a set of features and a reliability that would be very hard to obtain using only primitive publish/subscribe mechanisms."}]},{"block_type":"element","block":"k5zy5cqr","search_text":"Tip You can find a detailed introduction to the AMQP model on the RabbitMQ website: https://www.rabbitmq.com/tutorials/amqp-concepts.html . ","text_count":140,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"You can find a detailed introduction to the AMQP model on the RabbitMQ website:"},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.rabbitmq.com/tutorials/amqp-concepts.html"},"children":[{"block_type":"text","content":"https://www.rabbitmq.com/tutorials/amqp-concepts.html"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cqs","search_text":"Durable subscribers with AMQP and RabbitMQ","text_count":42,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Durable subscribers with AMQP and RabbitMQ"}]},{"block_type":"element","block":"k5zy5cqt","search_text":"Let's now practice what we learned about durable subscribers and AMQP and work on a small example. A typical scenario where it's important to not lose any message is when we want to keep the different services of a microservice architecture in sync; we already described this integration pattern in the previous chapter. If we want to use a broker to keep all our services on the same page, it's important that we don't lose any information, otherwise we might end up in an inconsistent state.","text_count":493,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now practice what we learned about durable subscribers and AMQP and work on a small example. A typical scenario where it's important to not lose any message is when we want to keep the different services of a microservice architecture in sync; we already described this integration pattern in the previous chapter. If we want to use a broker to keep all our services on the same page, it's important that we don't lose any information, otherwise we might end up in an inconsistent state."}]},{"block_type":"element","block":"k5zy5cqu","search_text":"Designing a history service for the chat application","text_count":52,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Designing a history service for the chat application"}]},{"block_type":"element","block":"k5zy5cqv","search_text":"Let's now extend our small chat application using a microservice approach. Let's add a history service that persists our chat messages inside a database, so that when a client connects, we can query the service and retrieve the entire chat history. We are going to integrate the history service with the chat server using the RabbitMQ broker ( https://www.rabbitmq.com ) and AMQP.","text_count":380,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now extend our small chat application using a microservice approach. Let's add a history service that persists our chat messages inside a database, so that when a client connects, we can query the service and retrieve the entire chat history. We are going to integrate the history service with the chat server using the RabbitMQ broker ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://www.rabbitmq.com"},"children":[{"block_type":"text","content":"https://www.rabbitmq.com"}]},{"block_type":"text","content":") and AMQP."}]},{"block_type":"element","block":"k5zy5cqw","search_text":"The next figure shows our planned architecture:","text_count":47,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The next figure shows our planned architecture:"}]},{"block_type":"element","block":"k5zy5cqx","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000036.jpg","alt":"Designing a history service for the chat application","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cqy","search_text":"As described in the preceding architecture, we are going to use a single fanout exchange; we don't need any particular routing, so our scenario does not require any exchange more complex than that. Next, we will create one queue for each instance of the chat server. These queues are exclusive; we are not interested in receiving any missed message when a chat server is offline, that's the job of our history service, which eventually can also implement more complicated queries against the stored messages. In practice, this means that our chat servers are not durable subscribers and their queues will be destroyed as soon as the connection is closed.","text_count":654,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As described in the preceding architecture, we are going to use a single fanout exchange; we don't need any particular routing, so our scenario does not require any exchange more complex than that. Next, we will create one queue for each instance of the chat server. These queues are exclusive; we are not interested in receiving any missed message when a chat server is offline, that's the job of our history service, which eventually can also implement more complicated queries against the stored messages. In practice, this means that our chat servers are not durable subscribers and their queues will be destroyed as soon as the connection is closed."}]},{"block_type":"element","block":"k5zy5cqz","search_text":"On the contrary, the history service cannot afford to lose any messages; otherwise, it would not fulfill its very purpose. The queue we are going to create for it has to be durable, so that any message that is published while the history service is disconnected will be kept in the queue and delivered when it comes back online.","text_count":328,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the contrary, the history service cannot afford to lose any messages; otherwise, it would not fulfill its very purpose. The queue we are going to create for it has to be durable, so that any message that is published while the history service is disconnected will be kept in the queue and delivered when it comes back online."}]},{"block_type":"element","block":"k5zy5cr0","search_text":"We are going to use the familiar LevelUP as the storage engine for the history service, while we will use the amqplib package ( https://npmjs.org/package/amqplib ) to connect to RabbitMQ using the AMQP protocol.","text_count":211,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are going to use the familiar LevelUP as the storage engine for the history service, while we will use the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"amqplib"}]},{"block_type":"text","content":"package ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/amqplib"},"children":[{"block_type":"text","content":"https://npmjs.org/package/amqplib"}]},{"block_type":"text","content":") to connect to RabbitMQ using the AMQP protocol."}]},{"block_type":"element","block":"k5zy5cr1","search_text":"Note The following example requires a working RabbitMQ server, listening on its default port. For more information, please refer to its official installation guide at http://www.rabbitmq.com/download.html . ","text_count":207,"tag_name":"div","attributes":{"class":"box note"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Note"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following example requires a working RabbitMQ server, listening on its default port. For more information, please refer to its official installation guide at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://www.rabbitmq.com/download.html"},"children":[{"block_type":"text","content":"http://www.rabbitmq.com/download.html"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cr2","search_text":"Implementing a reliable history service using AMQP","text_count":50,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing a reliable history service using AMQP"}]},{"block_type":"element","block":"k5zy5cr3","search_text":"Let's now implement our history service! We are going to create a standalone application (a typical microservice), which is implemented in the module historySvc.js . The module is made up of two parts: an HTTP server to expose the chat history to clients, and an AMQP consumer which is responsible for capturing the chat messages and storing them in a local database.","text_count":367,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now implement our history service! We are going to create a standalone application (a typical microservice), which is implemented in the module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"historySvc.js"}]},{"block_type":"text","content":". The module is made up of two parts: an HTTP server to expose the chat history to clients, and an AMQP consumer which is responsible for capturing the chat messages and storing them in a local database."}]},{"block_type":"element","block":"k5zy5cr4","search_text":"Let's see what this looks like in the code that follows:","text_count":56,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see what this looks like in the code that follows:"}]},{"block_type":"element","block":"k5zy5cr5","search_text":"const level = require('level'); const timestamp = require('monotonic-timestamp'); const JSONStream = require('JSONStream'); const amqp = require('amqplib'); const db = level('./msgHistory'); require('http').createServer((req, res) => { res.writeHead(200); db.createValueStream() .pipe(JSONStream.stringify()) .pipe(res); }).listen(8090); let channel, queue; amqp .connect('amqp://localhost') // [1] .then(conn => conn.createChannel()) .then(ch => { channel = ch; return channel.assertExchange('chat', 'fanout'); // [2] }) .then(() => channel.assertQueue('chat_history')) // [3] .then((q) => { queue = q.queue; return channel.bindQueue(queue, 'chat'); // [4] }) .then(() => { return channel.consume(queue, msg => { // [5] const content = msg.content.toString(); console.log(`Saving message: ${content}`); db.put(timestamp(), content, err => { if (!err) channel.ack(msg); }); }); }) .catch(err => console.log(err)); ","text_count":914,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const level = require('level'); \nconst timestamp = require('monotonic-timestamp'); \nconst JSONStream = require('JSONStream'); \nconst amqp = require('amqplib'); \nconst db = level('./msgHistory'); \n \nrequire('http').createServer((req, res) =&gt; { \n  res.writeHead(200); \n  db.createValueStream() \n    .pipe(JSONStream.stringify()) \n    .pipe(res); \n}).listen(8090); \n \nlet channel, queue; \namqp \n  .connect('amqp://localhost')                            // [1] \n  .then(conn =&gt; conn.createChannel()) \n  .then(ch =&gt; { \n    channel = ch; \n    return channel.assertExchange('chat', 'fanout');      // [2] \n  }) \n  .then(() =&gt; channel.assertQueue('chat_history'))        // [3] \n  .then((q) =&gt; { \n    queue = q.queue; \n    return channel.bindQueue(queue, 'chat');              // [4] \n  }) \n  .then(() =&gt; { \n    return channel.consume(queue, msg =&gt; {                // [5] \n      const content = msg.content.toString(); \n      console.log(`Saving message: ${content}`); \n      db.put(timestamp(), content, err =&gt; { \n        if (!err) channel.ack(msg); \n      }); \n    }); \n  }) \n  .catch(err =&gt; console.log(err));"}]}]},{"block_type":"element","block":"k5zy5cr6","search_text":"We can immediately see that AMQP requires a little bit of setting up, which is necessary to create and connect all the components of the model. It's also interesting to observe that amqplib supports Promises by default, so we leveraged them heavily to streamline the asynchronous steps of the application. Let's see in detail how it works:","text_count":339,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can immediately see that AMQP requires a little bit of setting up, which is necessary to create and connect all the components of the model. It's also interesting to observe that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"amqplib"}]},{"block_type":"text","content":"supports Promises by default, so we leveraged them heavily to streamline the asynchronous steps of the application. Let's see in detail how it works:"}]},{"block_type":"element","block":"k5zy5cr7","search_text":"We first establish a connection with the AMQP broker, which is RabbitMQ in our case. Then, we create a channel, which is similar to a session that will maintain the state of our communications. Next, we set up our exchange, named chat . As we already mentioned, it is a fanout exchange. The assertExchange() command will make sure that the exchange exists on the broker, otherwise it will create it. We also create our queue, called chat_history . By default, the queue is durable; not exclusive and not auto-delete , so we don't need to pass any extra options to support durable subscribers. Next, we bind the queue to the exchange we previously created. Here, we don't need any other particular option, for example, a routing key or pattern, as the exchange is of the type fanout, so it doesn't perform any filtering. Finally, we can begin to listen for messages coming from the queue we just created. We save every message that we receive in a LevelDB database using a monotonic timestamp as key ( https://npmjs.org/package/monotonic-timestamp ), to keep the messages sorted by date. It's also interesting to see that we are acknowledging every message using channel.ack(msg) , and only after the message is successfully saved into the database. If the ACK (acknowledgment) is not received by the broker, the message is kept in the queue for being processed again. This is another great feature of AMQP for bringing the reliability of our service to a whole new level. If we are not interested in sending explicit acknowledgments, we can pass the option {noAck:true} to the channel.consume() API. ","text_count":1600,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We first establish a connection with the AMQP broker, which is RabbitMQ in our case. Then, we create a channel, which is similar to a session that will maintain the state of our communications."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Next, we set up our exchange, named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat"}]},{"block_type":"text","content":". As we already mentioned, it is a fanout exchange. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"assertExchange()"}]},{"block_type":"text","content":"command will make sure that the exchange exists on the broker, otherwise it will create it."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We also create our queue, called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat_history"}]},{"block_type":"text","content":". By default, the queue is durable; not"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"exclusive"}]},{"block_type":"text","content":"and not"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"auto-delete"}]},{"block_type":"text","content":",&nbsp;so we don't need to pass any extra options to support durable subscribers."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Next, we bind the queue to the exchange we previously created. Here, we don't need any other particular option, for example, a routing key or pattern, as the exchange is of the type&nbsp;fanout, so it doesn't perform any filtering."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, we can begin to listen for messages coming from the queue we just created. We save every message that we receive in a LevelDB database using a monotonic timestamp as key ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/monotonic-timestamp"},"children":[{"block_type":"text","content":"https://npmjs.org/package/monotonic-timestamp"}]},{"block_type":"text","content":"), to keep the messages sorted by date. It's also interesting to see that we are acknowledging every message using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"channel.ack(msg)"}]},{"block_type":"text","content":", and only after the message is successfully saved into the database. If the ACK (acknowledgment) is not received by the broker, the message is kept in the queue for being processed again. This is another great feature of AMQP for bringing the reliability of our service to a whole new level. If we are not interested in sending explicit acknowledgments, we can pass the option"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{noAck:true}"}]},{"block_type":"text","content":"to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"channel.consume()"}]},{"block_type":"text","content":"API."}]}]},{"block_type":"element","block":"k5zy5cr8","search_text":"Integrating the chat application with AMQP","text_count":42,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Integrating the chat application with AMQP"}]},{"block_type":"element","block":"k5zy5cr9","search_text":"To integrate the chat servers using AMQP, we have to use a setup very similar to the one we implemented in the history service, so we are not going to repeat it here in full. However, it's still interesting to see how the queue is created and how a new message is published into the exchange. The relevant parts of the new app.js file are the following:","text_count":353,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To integrate the chat servers using AMQP, we have to use a setup very similar to the one we implemented in the history service, so we are not going to repeat it here in full. However, it's still interesting to see how the queue is created and how a new message is published into the exchange. The relevant parts of the new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"app.js"}]},{"block_type":"text","content":"file are the following:"}]},{"block_type":"element","block":"k5zy5cra","search_text":"// ... .then(() => { return channel.assertQueue(`chat_srv_${httpPort}`, {exclusive: true}); }) // ... ws.on('message', msg => { console.log(`Message: ${msg}`); channel.publish('chat', '', new Buffer(msg)); }); // ... ","text_count":217,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"// ... \n  .then(() =&gt; { \n    return channel.assertQueue(`chat_srv_${httpPort}`, {exclusive: true}); \n  }) \n// ... \n  ws.on('message', msg =&gt; { \n    console.log(`Message: ${msg}`); \n    channel.publish('chat', '', new Buffer(msg)); \n  }); \n// ..."}]}]},{"block_type":"element","block":"k5zy5crb","search_text":"As we mentioned, our chat server does not need to be a durable subscriber, a set and forget paradigm is enough. So when we create our queue, we pass the option {exclusive:true} , indicating that the queue is scoped to the current connection and therefore it will be destroyed as soon as the chat server shuts down.","text_count":314,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we mentioned, our chat server does not need to be a durable subscriber, a set and forget paradigm is enough. So when we create our queue, we pass the option"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"{exclusive:true}"}]},{"block_type":"text","content":", indicating that the queue is scoped to the current connection and therefore it will be destroyed as soon as the chat server shuts down."}]},{"block_type":"element","block":"k5zy5crc","search_text":"Publishing a new message is also very easy; we simply have to specify the target exchange ( chat ) and a routing key, which in our case is empty ( '' ) because we are using a fanout exchange.","text_count":191,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Publishing a new message is also very easy; we simply have to specify the target exchange ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"chat"}]},{"block_type":"text","content":") and a routing key, which in our case is empty ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"''"}]},{"block_type":"text","content":") because we are using a fanout exchange."}]},{"block_type":"element","block":"k5zy5crd","search_text":"We can now run our improved chat architecture; to do that, let's start two chat servers and the history service:","text_count":112,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We can now run our improved chat architecture; to do that, let's start two chat servers and the history service:"}]},{"block_type":"element","block":"k5zy5cre","search_text":"node app 8080 node app 8081 node historySvc ","text_count":44,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node app 8080\nnode app 8081\nnode historySvc"}]}]},{"block_type":"element","block":"k5zy5crf","search_text":"It is now interesting to see how our system, and in particular the history service, behaves in case of downtime. If we stop the history server and continue to send messages using the web UI of the chat application, we will see that when the history server is restarted, it will immediately receive all the messages it missed. This is a perfect demonstration of how the durable subscriber pattern works!","text_count":402,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is now interesting to see how our system, and in particular the history service, behaves in case of downtime. If we stop the history server and continue to send messages using the web UI of the chat application, we will see that when the history server is restarted, it will immediately receive all the messages it missed. This is a perfect demonstration of how the durable subscriber pattern works!"}]},{"block_type":"element","block":"k5zy5crg","search_text":"Tip It is nice to see how the microservice approach allows our system to survive even without one of its components—the history service. There would be a temporary reduction of functionality (no chat history available) but people would still be able to exchange chat messages in real time. Awesome! ","text_count":299,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It is nice to see how the microservice approach allows our system to survive even without one of its components&mdash;the history service. There would be a temporary reduction of functionality (no chat history available) but people would still be able to exchange chat messages in real time. Awesome!"}]}]},{"block_type":"element","block":"k5zy5crh","search_text":"Pipelines and task distribution patterns","text_count":40,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Pipelines and task distribution patterns"}]},{"block_type":"element","block":"k5zy5cri","search_text":"In Chapter 9, Advanced Asynchronous Recipes , we learned how to delegate costly tasks to multiple local processes, but even though this was an effective approach, it cannot be scaled beyond the boundaries of a single machine. In this section, we are going to see how it's possible to use a similar pattern in a distributed architecture, using remote workers located anywhere in a network.","text_count":388,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In Chapter 9,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Advanced Asynchronous&nbsp;Recipes"}]},{"block_type":"text","content":", we learned how to delegate costly tasks to multiple local processes, but even though this was an effective approach, it cannot be scaled beyond the boundaries of a single machine. In this section, we are going to see how it's possible to use a similar pattern in a distributed architecture, using remote workers located anywhere in a network."}]},{"block_type":"element","block":"k5zy5crj","search_text":"The idea is to have a messaging pattern that allows us to spread tasks across multiple machines. These tasks might be individual chunks of work or pieces of a bigger task split using a divide and conquer technique.","text_count":214,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The idea is to have a messaging pattern that allows us to spread tasks across multiple machines. These tasks might be individual chunks of work or pieces of a bigger task split using a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"divide and conquer"}]},{"block_type":"text","content":"technique."}]},{"block_type":"element","block":"k5zy5crk","search_text":"If we look at the logical architecture represented in the following figure, we should be able to recognize a familiar pattern:","text_count":126,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we look at the logical architecture represented in the following figure, we should be able to recognize a familiar pattern:"}]},{"block_type":"element","block":"k5zy5crl","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000004.jpg","alt":"Pipelines and task distribution patterns","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5crm","search_text":"As we can see from the preceding diagram, the publish/subscribe pattern is not suitable for this type of application, as we absolutely don't want a task to be received by multiple workers. What we need instead is a message distribution pattern similar to a load balancer, that dispatches each message to a different consumer (also called worker, in this case). In the messaging system terminology, this pattern is known as competing consumers , fanout distribution, or ventilator .","text_count":481,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see from the preceding diagram, the publish/subscribe pattern is not suitable for this type of application, as we absolutely don't want a task to be received by multiple workers. What we need instead is a message distribution pattern similar to a load balancer, that dispatches each message to a different consumer (also called worker, in this case). In the messaging system terminology, this pattern is known as"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"competing consumers"}]},{"block_type":"text","content":", fanout distribution, or"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"ventilator"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5crn","search_text":"One important difference with the HTTP load balancers we have seen in the previous chapter is that, here, the consumers have a more active role. In fact, as we will see later, most of the time it's not the producer that connects to the consumers, but the consumers themselves that connect to the task producer or the task queue in order to receive new jobs. This is a great advantage in a scalable system as it allows us to seamlessly increase the number of workers without modifying the producer or adopting a service registry.","text_count":528,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One important difference with the HTTP load balancers we have seen in the previous chapter is that, here, the consumers have a more active role. In fact, as we will see later, most of the time it's not the producer that connects to the consumers, but the consumers themselves that connect to the task producer or the task queue in order to receive new jobs. This is a great advantage in a scalable system as it allows us to seamlessly increase the number of workers without modifying the producer or adopting a service registry."}]},{"block_type":"element","block":"k5zy5cro","search_text":"Also, in a generic messaging system, we don't necessarily have a request/reply communication between the producer and workers. Instead, most of the time, the preferred approach is to use one-way asynchronous communication, which enables a better parallelism and scalability. In such an architecture, messages can potentially always travel in one direction, creating pipelines , as shown in the following figure:","text_count":411,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Also, in a generic messaging system, we don't necessarily have a request/reply communication between the producer and workers. Instead, most of the time, the preferred approach is to use one-way asynchronous communication, which enables a better parallelism and scalability. In such an architecture, messages can potentially always travel in one direction, creating pipelines"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":","}]},{"block_type":"text","content":"as shown in the following figure:"}]},{"block_type":"element","block":"k5zy5crp","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000018.jpg","alt":"Pipelines and task distribution patterns","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5crq","search_text":"Pipelines allow us to build very complex processing architectures without the burden of a synchronous request/reply communication, often resulting in lower latency and higher throughput. In the preceding figure, we can see how messages can be distributed across a set of workers (fanout), forwarded to other processing units, and then aggregated into a single node (fanin), usually called sink .","text_count":395,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Pipelines allow us to build very complex processing architectures without the burden of a synchronous request/reply communication, often resulting in lower latency and higher throughput. In the preceding figure, we can see how messages can be distributed across a set of workers (fanout), forwarded to other processing units, and then aggregated into a single node (fanin), usually called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"sink"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5crr","search_text":"In this section, we are going to focus on the building blocks of these kinds of architectures, by analyzing the two most important variations: peer-to-peer and broker-based.","text_count":173,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In this section, we are going to focus on the building blocks of these kinds of architectures, by analyzing the two most important variations: peer-to-peer and broker-based."}]},{"block_type":"element","block":"k5zy5crs","search_text":"Tip The combination of a pipeline with a task distribution pattern is also called a parallel pipeline . ","text_count":104,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The combination of a pipeline with a task distribution pattern is also called a"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"parallel pipeline"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5crt","search_text":"The ØMQ fanout/fanin pattern","text_count":28,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"The &Oslash;MQ fanout/fanin pattern"}]},{"block_type":"element","block":"k5zy5cru","search_text":"We have already discovered some of the capabilities of ØMQ for building peer-to-peer distributed architectures. In the previous section, we used PUB and SUB sockets to disseminate a single message to multiple consumers; now we are going to see how it's possible to build parallel pipelines using another pair of sockets called PUSH and PULL .","text_count":342,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We have already discovered some of the capabilities of &Oslash;MQ for building peer-to-peer distributed architectures. In the previous section, we used"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUB"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"SUB"}]},{"block_type":"text","content":"sockets to disseminate a single message to multiple consumers; now we are going to see how it's possible to build parallel pipelines using another pair of sockets called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"and"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5crv","search_text":"PUSH/PULL sockets","text_count":17,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"PUSH/PULL sockets"}]},{"block_type":"element","block":"k5zy5crw","search_text":"Intuitively, we can say that the PUSH sockets are made for sending messages, while the PULL sockets are meant for receiving . It might seem a trivial combination; however, they have some nice characteristics that make them perfect for building one-way communication systems:","text_count":274,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Intuitively, we can say that the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"sockets are made for"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"sending"}]},{"block_type":"text","content":"messages, while the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"sockets are meant for"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"receiving"}]},{"block_type":"text","content":". It might seem a trivial combination; however, they have some nice characteristics that make them perfect for building one-way communication systems:"}]},{"block_type":"element","block":"k5zy5crx","search_text":"Both can work in connect mode or bind mode. In other words, we can build a PUSH socket and bind it to a local port listening for the incoming connections from a PULL socket, or vice versa, a PULL socket might listen for connections from a PUSH socket. The messages always travel in the same direction, from PUSH to PULL ; it's only the initiator of the connection that can be different. The bind mode is the best solution for durable nodes, such as, for example, the task producer and the sink, while the connect mode is perfect for transient nodes, such as, for example, the task workers. This allows the number of transient nodes to vary arbitrarily without affecting the more durable nodes. If there are multiple PULL sockets connected to a single PUSH socket, the messages are evenly distributed across all the PULL sockets; in practice, they are load balanced (peer-to-peer load balancing!). On the other hand, a PULL socket that receives messages from multiple PUSH sockets will process the messages using a fair queuing system, which means that they are consumed evenly from all the sources—a round robin applied to inbound messages. The messages sent over a PUSH socket that doesn't have any connected PULL socket do not get lost; they are instead queued up on the producer until a node comes online and starts pulling the messages. ","text_count":1341,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Both can work in"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"connect"}]},{"block_type":"text","content":"mode or"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"bind"}]},{"block_type":"text","content":"mode. In other words, we can build a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"socket and bind it to a local port listening for the incoming connections from a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"socket, or vice versa, a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"socket might listen for connections from a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"socket. The messages always travel in the same direction, from"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"to"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"; it's only the initiator of the connection that can be different. The bind mode is the best solution for"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"durable"}]},{"block_type":"text","content":"nodes, such as, for example, the task producer and the sink, while the connect mode is perfect for"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"transient"}]},{"block_type":"text","content":"nodes, such as, for example, the task workers. This allows the number of transient nodes to vary arbitrarily without affecting the more durable nodes."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"If there are multiple"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"sockets connected to a single"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"socket, the messages are evenly distributed across all the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"sockets; in practice, they are load balanced (peer-to-peer load balancing!). On the other hand, a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"socket that receives messages from multiple"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"sockets will process the messages using a fair queuing system, which means that they are consumed evenly from all the sources&mdash;a round robin applied to inbound messages."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The messages sent over a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"socket that doesn't have any connected"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"socket do not get lost; they are instead queued up on the producer until a node comes online and starts pulling the messages."}]}]},{"block_type":"element","block":"k5zy5cry","search_text":"We are now starting to understand how ØMQ is different from traditional web services and why it's a perfect tool for building any kind of messaging system.","text_count":155,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are now starting to understand how &Oslash;MQ is different from traditional web services and why it's a perfect tool for building any kind of messaging system."}]},{"block_type":"element","block":"k5zy5crz","search_text":"Building a distributed hashsum cracker with ØMQ","text_count":47,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Building a distributed hashsum cracker with &Oslash;MQ"}]},{"block_type":"element","block":"k5zy5cs0","search_text":"Now it's time to build a sample application to see in action the properties of the PUSH / PULL sockets we just described.","text_count":121,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now it's time to build a sample application to see in action the properties of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"/"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"sockets we just described."}]},{"block_type":"element","block":"k5zy5cs1","search_text":"A simple and fascinating application to work with would be a hashsum cracker , a system that uses a brute-force technique to try to match a given hashsum (MD5, SHA1, and so on) to every possible variation of characters of a given alphabet. This is an embarrassingly parallel workload ( http://en.wikipedia.org/wiki/Embarrassingly_parallel ), which is perfect for building an example demonstrating the power of parallel pipelines.","text_count":429,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"A simple and fascinating application to work with would be a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"hashsum cracker"}]},{"block_type":"text","content":", a system that uses a brute-force technique to try to match a given hashsum (MD5, SHA1, and so on) to every possible variation of characters of a given alphabet. This is an"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"embarrassingly parallel"}]},{"block_type":"text","content":"workload ("},{"block_type":"element","tag_name":"a","attributes":{"href":"http://en.wikipedia.org/wiki/Embarrassingly_parallel"},"children":[{"block_type":"text","content":"http://en.wikipedia.org/wiki/Embarrassingly_parallel"}]},{"block_type":"text","content":"), which is perfect for building an example demonstrating the power of parallel pipelines."}]},{"block_type":"element","block":"k5zy5cs2","search_text":"For our application, we want to implement a typical parallel pipeline with a node to create and distribute tasks across multiple workers, plus a node to collect all the results. The system we just described can be implemented in ØMQ using the following architecture:","text_count":266,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For our application, we want to implement a typical parallel pipeline with a node to create and distribute tasks across multiple workers, plus a node to collect all the results. The system we just described can be implemented in &Oslash;MQ using the following architecture:"}]},{"block_type":"element","block":"k5zy5cs3","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000047.jpg","alt":"Building a distributed hashsum cracker with &Oslash;MQ","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cs4","search_text":"In our architecture, we have a ventilator generating all the possible variations of characters in a given alphabet and distributing them to a set of workers, which in turn calculate the hashsum of every given variation and try to match it against the hashsum given as the input. If a match is found, the result is sent to a results collector node (sink).","text_count":354,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In our architecture, we have a"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"ventilator"}]},{"block_type":"text","content":"generating all the possible variations of characters in a given alphabet and distributing them to a set of workers, which in turn calculate the hashsum of every given variation and try to match it against the hashsum given as the input. If a match is found, the result is sent to a results collector node (sink)."}]},{"block_type":"element","block":"k5zy5cs5","search_text":"The durable nodes of our architecture are the ventilator and the sink, while the transient nodes are the workers. This means that each worker connects its PULL socket to the ventilator and its PUSH socket to the sink; this way, we can start and stop how many workers we want without changing any parameter in the ventilator or the sink.","text_count":336,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The durable nodes of our architecture are the ventilator and the sink, while the transient nodes are the workers. This means that each worker connects its"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"socket to the ventilator and its"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"socket to the sink; this way, we can start and stop how many workers we want without changing any parameter in the ventilator or the sink."}]},{"block_type":"element","block":"k5zy5cs6","search_text":"Implementing the ventilator","text_count":27,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing the ventilator"}]},{"block_type":"element","block":"k5zy5cs7","search_text":"Now, let's start to implement our system by creating a new module for the ventilator, in a file named ventilator.js :","text_count":117,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, let's start to implement our system by creating a new module for the ventilator, in a file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ventilator.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cs8","search_text":"const zmq = require('zmq'); const variationsStream = require('variations-stream'); const alphabet = 'abcdefghijklmnopqrstuvwxyz'; const batchSize = 10000; const maxLength = process.argv[2]; const searchHash = process.argv[3]; const ventilator = zmq.socket('push'); // [1] ventilator.bindSync(\"tcp://*:5000\"); let batch = []; variationsStream(alphabet, maxLength) .on('data', combination => { batch.push(combination); if (batch.length === batchSize) { // [2] const msg = {searchHash: searchHash, variations: batch}; ventilator.send(JSON.stringify(msg)); batch = []; } }) .on('end', () => { //send remaining combinations const msg = {searchHash: searchHash, variations: batch}; ventilator.send(JSON.stringify(msg)); }); ","text_count":718,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const zmq = require('zmq'); \nconst variationsStream = require('variations-stream'); \nconst alphabet = 'abcdefghijklmnopqrstuvwxyz'; \nconst batchSize = 10000; \nconst maxLength = process.argv[2]; \nconst searchHash = process.argv[3]; \n \nconst ventilator = zmq.socket('push');             // [1] \nventilator.bindSync(\"tcp://*:5000\"); \n \nlet batch = []; \nvariationsStream(alphabet, maxLength) \n  .on('data', combination =&gt; { \n    batch.push(combination); \n    if (batch.length === batchSize) {              // [2] \n      const msg = {searchHash: searchHash, variations: batch}; \n      ventilator.send(JSON.stringify(msg)); \n      batch = []; \n    } \n  }) \n  .on('end', () =&gt; { \n    //send remaining combinations \n    const msg = {searchHash: searchHash, variations: batch}; \n    ventilator.send(JSON.stringify(msg)); \n  });"}]}]},{"block_type":"element","block":"k5zy5cs9","search_text":"To avoid generating too many variations, our generator uses only the lowercase letters of the English alphabet and sets a limit on the size of the words generated. This limit is provided in input as a command-line argument ( maxLength ) together with the hashsum to match ( searchHash ). We use a library called variations-stream ( https://npmjs.org/package/variations-stream ) to generate all the variations using a streaming interface.","text_count":437,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To avoid generating too many variations, our generator uses only the lowercase letters of the English alphabet and sets a limit on the size of the words generated. This limit is provided in input as a command-line argument ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"maxLength"}]},{"block_type":"text","content":") together with the hashsum to match ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"searchHash"}]},{"block_type":"text","content":"). We use a library called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"variations-stream"}]},{"block_type":"text","content":"("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/variations-stream"},"children":[{"block_type":"text","content":"https://npmjs.org/package/variations-stream"}]},{"block_type":"text","content":") to generate all the variations using a streaming interface."}]},{"block_type":"element","block":"k5zy5csa","search_text":"But the part that we are most interested in analyzing is how we distribute the tasks across the workers:","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"But the part that we are most interested in analyzing is how we distribute the tasks across the workers:"}]},{"block_type":"element","block":"k5zy5csb","search_text":"We first create a PUSH socket and we bind it to local port 5000 ; this is where the PULL socket of the workers will connect to receive their tasks. We group the generated variations in batches of 10,000 items each and then we craft a message that contains the hash to match and the batch of words to check. This is essentially the task object that the workers will receive. When we invoke send() over the ventilator socket, the message will be passed to the next available worker, following a round robin distribution. ","text_count":519,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We first create a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"socket and we bind it to local port"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"5000"}]},{"block_type":"text","content":"; this is where the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"socket of the workers will connect to receive their tasks."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We group the generated variations in batches of 10,000 items each and then we craft a message that contains the hash to match and the batch of words to check. This is essentially the task object that the workers will receive. When we invoke"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"send()"}]},{"block_type":"text","content":"over the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"ventilator"}]},{"block_type":"text","content":"socket, the message will be passed to the next available worker, following a round robin distribution."}]}]},{"block_type":"element","block":"k5zy5csc","search_text":"Implementing the worker","text_count":23,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing the worker"}]},{"block_type":"element","block":"k5zy5csd","search_text":"Now it's time to implement the worker ( worker.js ):","text_count":52,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now it's time to implement the worker ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"worker.js"}]},{"block_type":"text","content":"):"}]},{"block_type":"element","block":"k5zy5cse","search_text":"const zmq = require('zmq'); const crypto = require('crypto'); const fromVentilator = zmq.socket('pull'); const toSink = zmq.socket('push'); fromVentilator.connect('tcp://localhost:5016'); toSink.connect('tcp://localhost:5017'); fromVentilator.on('message', buffer => { const msg = JSON.parse(buffer); const variations = msg.variations; variations.forEach( word => { console.log(`Processing: ${word}`); const shasum = crypto.createHash('sha1'); shasum.update(word); const digest = shasum.digest('hex'); if (digest === msg.searchHash) { console.log(`Found! => ${word}`); toSink.send(`Found! ${digest} => ${word}`); } }); }); ","text_count":623,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const zmq = require('zmq'); \nconst crypto = require('crypto'); \nconst fromVentilator = zmq.socket('pull'); \nconst toSink = zmq.socket('push'); \n \nfromVentilator.connect('tcp://localhost:5016'); \ntoSink.connect('tcp://localhost:5017'); \n \nfromVentilator.on('message', buffer =&gt; { \n  const msg = JSON.parse(buffer); \n  const variations = msg.variations; \n  variations.forEach( word =&gt; { \n    console.log(`Processing: ${word}`); \n    const shasum = crypto.createHash('sha1'); \n    shasum.update(word); \n    const digest = shasum.digest('hex'); \n    if (digest === msg.searchHash) { \n      console.log(`Found! =&gt; ${word}`); \n      toSink.send(`Found! ${digest} =&gt; ${word}`); \n    } \n  }); \n});"}]}]},{"block_type":"element","block":"k5zy5csf","search_text":"As we said, our worker represents a transient node in our architecture, therefore, its sockets should connect to a remote node instead of listening for the incoming connections. That's exactly what we do in our worker, we create two sockets:","text_count":241,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we said, our worker represents a transient node in our architecture, therefore, its sockets should connect to a remote node instead of listening for the incoming connections. That's exactly what we do in our worker, we create two sockets:"}]},{"block_type":"element","block":"k5zy5csg","search_text":"A PULL socket that connects to the ventilator, for receiving the tasks A PUSH socket that connects to the sink, for propagating the results ","text_count":140,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"socket that connects to the ventilator, for receiving the tasks"}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"A"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"socket that connects to the sink, for propagating the results"}]}]},{"block_type":"element","block":"k5zy5csh","search_text":"Besides this, the job done by our worker is very simple: for each message received, we iterate over the batch of words it contains, then for each word we calculate the SHA1 checksum and we try to match it against searchHash passed with the message. When a match is found, the result is forwarded to the sink.","text_count":308,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Besides this, the job done by our worker is very simple: for each message received, we iterate over the batch of words it contains, then for each word we calculate the SHA1 checksum and we try to match it against&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"searchHash"}]},{"block_type":"text","content":"passed with the message. When a match is found, the result is forwarded to the sink."}]},{"block_type":"element","block":"k5zy5csi","search_text":"Implementing the sink","text_count":21,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing the sink"}]},{"block_type":"element","block":"k5zy5csj","search_text":"For our example, the sink is a very basic result collector, which simply prints the messages received by the workers to the console. The contents of the file sink.js are as follows:","text_count":181,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"For our example, the sink is a very basic result collector, which simply prints the messages received by the workers to the console. The contents of the file"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"sink.js"}]},{"block_type":"text","content":"are as follows:"}]},{"block_type":"element","block":"k5zy5csk","search_text":"const zmq = require('zmq'); const sink = zmq.socket('pull'); sink.bindSync(\"tcp://*:5017\"); sink.on('message', buffer => { console.log('Message from worker: ', buffer.toString()); }); ","text_count":184,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const zmq  = require('zmq'); \nconst sink = zmq.socket('pull'); \nsink.bindSync(\"tcp://*:5017\"); \n \nsink.on('message', buffer =&gt; { \n  console.log('Message from worker: ', buffer.toString()); \n});"}]}]},{"block_type":"element","block":"k5zy5csl","search_text":"It's interesting to see that the sink (as the ventilator) is also a durable node of our architecture and therefore we bind its PULL socket instead of connecting it explicitly to the PUSH socket of the workers.","text_count":209,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's interesting to see that the sink (as the ventilator) is also a durable node of our architecture and therefore we bind its"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PULL"}]},{"block_type":"text","content":"socket instead of connecting it explicitly to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"PUSH"}]},{"block_type":"text","content":"socket of the workers."}]},{"block_type":"element","block":"k5zy5csm","search_text":"Running the application","text_count":23,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Running the application"}]},{"block_type":"element","block":"k5zy5csn","search_text":"We are now ready to launch our application; let's start a couple of workers and the sink:","text_count":89,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are now ready to launch our application; let's start a couple of workers and the sink:"}]},{"block_type":"element","block":"k5zy5cso","search_text":"node worker node worker node sink ","text_count":34,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node worker\nnode worker\nnode sink"}]}]},{"block_type":"element","block":"k5zy5csp","search_text":"Then it's time to start the ventilator, specifying the maximum length of the words to generate and the SHA1 checksum that we want to match. The following is a sample list of arguments:","text_count":184,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then it's time to start the ventilator, specifying the maximum length of the words to generate and the SHA1 checksum that we want to match. The following is a sample list of arguments:"}]},{"block_type":"element","block":"k5zy5csq","search_text":"node ventilator 4 f8e966d1e207d02c44511a58dccff2f5429e9a3b ","text_count":59,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node ventilator 4 f8e966d1e207d02c44511a58dccff2f5429e9a3b"}]}]},{"block_type":"element","block":"k5zy5csr","search_text":"When the preceding command is run, the ventilator will start generating all the possible words that have a length of, at most, four characters, distributing them to the set of workers we started, along with the checksum we provided. The results of the computation, if any, will appear in the terminal of the sink application.","text_count":325,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When the preceding command is run, the ventilator will start generating all the possible words that have a length of, at most, four characters, distributing them to the set of workers we started, along with the checksum we provided. The results of the computation, if any, will appear in the terminal of the sink application."}]},{"block_type":"element","block":"k5zy5css","search_text":"Pipelines and competing consumers in AMQP","text_count":41,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Pipelines and competing consumers in AMQP"}]},{"block_type":"element","block":"k5zy5cst","search_text":"In the previous section, we saw how a parallel pipeline can be implemented in a peer-to-peer context. Now we are going to explore this pattern when applied to a fully-fledged message broker, such as RabbitMQ.","text_count":208,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the previous section, we saw how a parallel pipeline can be implemented in a peer-to-peer context. Now we are going to explore this pattern when applied to a fully-fledged message broker, such as RabbitMQ."}]},{"block_type":"element","block":"k5zy5csu","search_text":"Point-to-point communications and competing consumers","text_count":53,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Point-to-point communications and competing consumers"}]},{"block_type":"element","block":"k5zy5csv","search_text":"In a peer-to-peer configuration, a pipeline is a very straightforward concept to picture in mind. With a message broker in the middle though, the relationship between the various nodes of the system are a little bit harder to understand; the broker itself acts as an intermediary for our communications and, often, we don't really know who is on the other side listening for messages. For example, when we send a message using AMQP, we don't deliver it directly to its destination, but instead to an exchange and then to a queue. Finally, it will be for the broker to decide where to route the message, based on the rules defined in the exchange, the bindings, and the destination queues.","text_count":688,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a peer-to-peer configuration, a pipeline is a very straightforward concept to picture in mind. With a message broker in the middle though, the relationship between the various nodes of the system are a little bit harder to understand; the broker itself acts as an intermediary for our communications and, often, we don't really know who is on the other side listening for messages. For example, when we send a message using AMQP, we don't deliver it directly to its destination, but instead to an exchange and then to a queue. Finally, it will be for the broker to decide where to route the message, based on the rules defined in the exchange, the bindings, and the destination queues."}]},{"block_type":"element","block":"k5zy5csw","search_text":"If we want to implement a pipeline and a task distribution pattern using a system like AMQP, we have to make sure that each message is received by only one consumer, but this is impossible to guarantee if an exchange can potentially be bound to more than one queue. The solution, then, is to send a message directly to the destination queue, bypassing the exchange altogether; this way, we can make sure that only one queue will receive the message. This communication pattern is called point-to-point .","text_count":503,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If we want to implement a pipeline and a task distribution pattern using a system like AMQP, we have to make sure that each message is received by only one consumer, but this is impossible to guarantee if an exchange can potentially be bound to more than one queue. The solution, then, is to send a message directly to the destination queue, bypassing the exchange altogether; this way, we can make sure that only one queue will receive the message. This communication pattern is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"point-to-point"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5csx","search_text":"Once we are able to send a set of messages directly to a single queue, we are already half-way to implementing our task distribution pattern. In fact, the next step comes naturally: when multiple consumers are listening on the same queue, the messages will be distributed evenly across them, implementing a fan-out distribution. In the context of message brokers, this is better known as the competing consumers pattern.","text_count":420,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Once we are able to send a set of messages directly to a single queue, we are already half-way to implementing our task distribution pattern. In fact, the next step comes naturally: when multiple consumers are listening on the same queue, the messages will be distributed evenly across them, implementing a fan-out distribution. In the context of message brokers, this is better known as the"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"competing consumers"}]},{"block_type":"text","content":"pattern."}]},{"block_type":"element","block":"k5zy5csy","search_text":"Implementing the hashsum cracker using AMQP","text_count":43,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Implementing the hashsum cracker using AMQP"}]},{"block_type":"element","block":"k5zy5csz","search_text":"We just learned that exchanges are the point in a broker where a message is multicast to a set of consumers, while queues are the place where messages are load balanced. With this knowledge in mind, let's now implement our brute-force hashsum cracker on top of an AMQP broker (such as, for example, RabbitMQ). The following figure gives an overview of the system we want to obtain:","text_count":381,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We just learned that exchanges are the point in a broker where a message is multicast to a set of consumers, while queues are the place where messages are load balanced. With this knowledge in mind, let's now implement our brute-force hashsum cracker on top of an AMQP broker (such as, for example, RabbitMQ). The following figure gives an overview of the system we want to obtain:"}]},{"block_type":"element","block":"k5zy5ct0","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000025.jpg","alt":"Implementing the hashsum cracker using AMQP","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5ct1","search_text":"As we discussed, to distribute a set of tasks across multiple workers, we need to use a single queue. In the preceding figure, we called this the jobs queue . On the other side of the jobs queue, we have a set of workers, which are competing consumers ; in other words, each one will pull a different message from the queue. The result is that multiple tasks will execute in parallel on different workers.","text_count":405,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we discussed, to distribute a set of tasks across multiple workers, we need to use a single queue. In the preceding figure, we called this the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"jobs queue"}]},{"block_type":"text","content":". On the other side of the jobs queue, we have a set of workers, which are"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"competing consumers"}]},{"block_type":"text","content":"; in other words, each one will pull a different message from the queue. The result is that multiple tasks will execute in parallel on different workers."}]},{"block_type":"element","block":"k5zy5ct2","search_text":"Any result generated by the workers is published into another queue, which we called the results queue , and then consumed by the results collector; this is actually equivalent to a sink, or fanin distribution. In the entire architecture, we don't make use of any exchange; we only send messages directly to their destination queue, implementing a point-to-point communication.","text_count":377,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Any result generated by the workers is published into another queue, which we called the&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"results queue"}]},{"block_type":"text","content":", and then consumed by the results collector; this is actually equivalent to a sink, or fanin distribution. In the entire architecture, we don't make use of any exchange; we only send messages directly to their destination queue, implementing a point-to-point communication."}]},{"block_type":"element","block":"k5zy5ct3","search_text":"Implementing the producer","text_count":25,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing the producer"}]},{"block_type":"element","block":"k5zy5ct4","search_text":"Let's see how to implement such a system, starting from the producer (the variation generator). Its code is identical to the sample we saw in the previous section except for the parts concerning the message exchange. The producer.js file will look as follows:","text_count":259,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's see how to implement such a system, starting from the producer (the variation generator). Its code is identical to the sample we saw in the previous section except for the parts concerning the message exchange. The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"producer.js"}]},{"block_type":"text","content":"file will look as follows:"}]},{"block_type":"element","block":"k5zy5ct5","search_text":"const amqp = require('amqplib'); //... let connection, channel; amqp .connect('amqp://localhost') .then(conn => { connection = conn; return conn.createChannel(); }) .then(ch => { channel = ch; produce(); }) .catch(err => console.log(err)); function produce() { //... variationsStream(alphabet, maxLength) .on('data', combination => { //... const msg = {searchHash: searchHash, variations: batch}; channel.sendToQueue('jobs_queue', new Buffer(JSON.stringify(msg))); //... }) //... } ","text_count":482,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const amqp = require('amqplib'); \n//... \n \nlet connection, channel; \namqp \n  .connect('amqp://localhost') \n  .then(conn =&gt; { \n    connection = conn; \n    return conn.createChannel(); \n  }) \n  .then(ch =&gt; { \n    channel = ch; \n    produce(); \n  }) \n  .catch(err =&gt; console.log(err)); \n \nfunction produce() { \n  //... \n  variationsStream(alphabet, maxLength) \n    .on('data', combination =&gt; { \n      //... \n      const msg = {searchHash: searchHash, variations: batch}; \n      channel.sendToQueue('jobs_queue', \n        new Buffer(JSON.stringify(msg))); \n      //... \n    }) \n  //... \n}"}]}]},{"block_type":"element","block":"k5zy5ct6","search_text":"As we can see, the absence of any exchange or binding makes the setup of an AMQP communication much simpler. In the preceding code, we didn't even need a queue, as we are interested only in publishing a message.","text_count":211,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"As we can see, the absence of any exchange or binding makes the setup of an AMQP communication much simpler. In the preceding code, we didn't even need a queue, as we are interested only in publishing a message."}]},{"block_type":"element","block":"k5zy5ct7","search_text":"The most important detail, though, is the channel.sendToQueue() API, which is actually new to us. As its name says, that's the API responsible for delivering a message straight to a queue— jobs_queue in our example—bypassing any exchange or routing.","text_count":249,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The most important detail, though, is the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"channel.sendToQueue()"}]},{"block_type":"text","content":"&nbsp;API, which is actually new to us. As its name says, that's the API responsible for delivering a message straight to a queue&mdash;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"jobs_queue"}]},{"block_type":"text","content":"in our example&mdash;bypassing any exchange or routing."}]},{"block_type":"element","block":"k5zy5ct8","search_text":"Implementing the worker","text_count":23,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing the worker"}]},{"block_type":"element","block":"k5zy5ct9","search_text":"On the other side of jobs_queue , we have the workers listening for the incoming tasks. Let's implement their code in a file called worker.js , as follows:","text_count":155,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other side of&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"jobs_queue"}]},{"block_type":"text","content":", we have the workers listening for the incoming tasks. Let's implement their code in a file called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"worker.js"}]},{"block_type":"text","content":", as follows:"}]},{"block_type":"element","block":"k5zy5cta","search_text":"const amqp = require('amqplib'); //... let channel, queue; amqp .connect('amqp://localhost') .then(conn => conn.createChannel()) .then(ch => { channel = ch; return channel.assertQueue('jobs_queue'); }) .then(q => { queue = q.queue; consume(); }) //... function consume() { channel.consume(queue, msg => { //... variations.forEach(word => { //... if(digest === data.searchHash) { console.log(`Found! => ${word}`); channel.sendToQueue('results_queue', new Buffer(`Found! ${digest} => ${word}`)); } //... }); channel.ack(msg); }); }; ","text_count":531,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const amqp = require('amqplib'); \n//... \n \nlet channel, queue; \namqp \n  .connect('amqp://localhost') \n  .then(conn =&gt; conn.createChannel()) \n  .then(ch =&gt; { \n    channel = ch; \n    return channel.assertQueue('jobs_queue'); \n  }) \n  .then(q =&gt; { \n    queue = q.queue; \n    consume(); \n  }) \n \n//... \n \nfunction consume() { \n  channel.consume(queue, msg =&gt; { \n    //... \n    variations.forEach(word =&gt; { \n      //... \n      if(digest === data.searchHash) { \n        console.log(`Found! =&gt; ${word}`); \n        channel.sendToQueue('results_queue', \n          new Buffer(`Found! ${digest} =&gt; ${word}`)); \n      } \n     //... \n    }); \n    channel.ack(msg); \n  }); \n};"}]}]},{"block_type":"element","block":"k5zy5ctb","search_text":"Our new worker is also very similar to the one we implemented in the previous section using ØMQ, except for the part related to the message exchange. In the preceding code, we can see how we first make sure that jobs_queue exists and then we start listening for incoming tasks using channel.consume() . Then, every time a match is found, we send the result to the collector via results_queue , using again a point-to-point communication.","text_count":437,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our new worker is also very similar to the one we implemented in the previous section using &Oslash;MQ, except for the part related to the message exchange. In the preceding code, we can see how we first make sure that"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"jobs_queue"}]},{"block_type":"text","content":"exists and then we start listening for incoming tasks using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"channel.consume()"}]},{"block_type":"text","content":". Then, every time a match is found, we send the result to the collector via"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"results_queue"}]},{"block_type":"text","content":", using again a point-to-point communication."}]},{"block_type":"element","block":"k5zy5ctc","search_text":"If multiple workers are started, they will all listen on the same queue, resulting in the messages being load balanced between them.","text_count":132,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"If multiple workers are started, they will all listen on the same queue, resulting in the messages being load balanced between them."}]},{"block_type":"element","block":"k5zy5ctd","search_text":"Implementing the result collector","text_count":33,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing the result collector"}]},{"block_type":"element","block":"k5zy5cte","search_text":"The results collector is again a trivial module, simply printing any message received to the console. This is implemented in the collector.js file, as follows:","text_count":159,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The results collector is again a trivial module, simply printing any message received to the console. This is implemented in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"collector.js"}]},{"block_type":"text","content":"file, as follows:"}]},{"block_type":"element","block":"k5zy5ctf","search_text":"//... .then(ch => { channel = ch; return channel.assertQueue('results_queue'); }) .then(q => { queue = q.queue; channel.consume(queue, msg => { console.log('Message from worker: ', msg.content.toString()); }); }) //... ","text_count":219,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"//... \n  .then(ch =&gt; { \n    channel = ch; \n    return channel.assertQueue('results_queue'); \n  }) \n  .then(q =&gt; { \n    queue = q.queue; \n    channel.consume(queue, msg =&gt; { \n      console.log('Message from worker: ', msg.content.toString()); \n    }); \n  }) \n//..."}]}]},{"block_type":"element","block":"k5zy5ctg","search_text":"Running the application","text_count":23,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Running the application"}]},{"block_type":"element","block":"k5zy5cth","search_text":"Now everything is ready to give our new system a try, we can start by running a couple of workers, which will both connect to the same queue ( jobs_queue ), so that every message will be load balanced between them:","text_count":214,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now everything is ready to give our new system a try, we can start by running a couple of workers, which will both connect to the same queue ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"jobs_queue"}]},{"block_type":"text","content":"), so that every message will be load balanced between them:"}]},{"block_type":"element","block":"k5zy5cti","search_text":"node worker node worker ","text_count":24,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node worker\nnode worker"}]}]},{"block_type":"element","block":"k5zy5ctj","search_text":"Then, we can run the collector module and then producer (by providing the maximum word length and the hash to crack):","text_count":117,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Then, we can run the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"collector"}]},{"block_type":"text","content":"module and then"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"producer"}]},{"block_type":"text","content":"(by providing the maximum word length and the hash to crack):"}]},{"block_type":"element","block":"k5zy5ctk","search_text":"node collector node producer 4 f8e966d1e207d02c44511a58dccff2f5429e9a3b ","text_count":72,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node collector\nnode producer 4 f8e966d1e207d02c44511a58dccff2f5429e9a3b"}]}]},{"block_type":"element","block":"k5zy5ctl","search_text":"With this, we implemented a message pipeline and the competing consumers pattern using nothing but AMQP.","text_count":104,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"With this, we implemented a message pipeline and the competing consumers pattern using nothing but AMQP."}]},{"block_type":"element","block":"k5zy5ctm","search_text":"Request/reply patterns","text_count":22,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Request/reply patterns"}]},{"block_type":"element","block":"k5zy5ctn","search_text":"Dealing with a messaging system often means using a one-way asynchronous communication; publish/subscribe is a perfect example.","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Dealing with a messaging system often means using a one-way asynchronous communication; publish/subscribe is a perfect example."}]},{"block_type":"element","block":"k5zy5cto","search_text":"One-way communications can give us great advantages in terms of parallelism and efficiency, but alone they are not able to solve all our integration and communication problems. Sometimes, a good old request/reply pattern might just be the perfect tool for the job. Therefore, in all those situations where an asynchronous one-way channel is all that we have, it's important to know how to build an abstraction that allows us to exchange messages in a request/reply fashion. That's exactly what we are going to learn next.","text_count":521,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"One-way communications can give us great advantages in terms of parallelism and efficiency, but alone they are not able to solve all our integration and communication problems. Sometimes, a good old request/reply pattern might just be the perfect tool for the job. Therefore, in all those situations where an asynchronous one-way channel is all that we have, it's important to know how to build an abstraction that allows us to exchange messages in a request/reply fashion. That's exactly what we are going to learn next."}]},{"block_type":"element","block":"k5zy5ctp","search_text":"Correlation identifier","text_count":22,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Correlation identifier"}]},{"block_type":"element","block":"k5zy5ctq","search_text":"The first request/reply pattern we are going to learn is called correlation identifier and it represents the basic block for building a request/reply abstraction on top of a one-way channel.","text_count":190,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first request/reply pattern we are going to learn is called"},{"block_type":"element","tag_name":"strong","attributes":{},"children":[{"block_type":"text","content":"correlation identifier"}]},{"block_type":"text","content":"and it represents the basic block for building a request/reply abstraction on top of a one-way channel."}]},{"block_type":"element","block":"k5zy5ctr","search_text":"The pattern consists of marking each request with an identifier, which is then attached to the response by the receiver; this way, the sender of the request can correlate the two messages and return the response to the right handler. This elegantly solves the problem with the presence of a one-way asynchronous channel, where messages can travel in any direction at any time. Let's take a look at the example in the following figure:","text_count":434,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The pattern consists of marking each request with an identifier, which is then attached to the response by the receiver; this way, the sender of the request can correlate the two messages and return the response to the right handler. This elegantly solves the problem with the presence of a one-way asynchronous channel, where messages can travel in any direction at any time. Let's take a look at the example in the following figure:"}]},{"block_type":"element","block":"k5zy5cts","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000009.jpg","alt":"Correlation identifier","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5ctt","search_text":"The preceding scenario shows how using a correlation ID allows us to match each response with the right request, even if those are sent and then received in a different order.","text_count":175,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The preceding scenario shows how using a correlation ID allows us to match each response with the right request, even if those are sent and then received in a different order."}]},{"block_type":"element","block":"k5zy5ctu","search_text":"Implementing a request/reply abstraction using correlation identifiers","text_count":70,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing a request/reply abstraction using correlation identifiers"}]},{"block_type":"element","block":"k5zy5ctv","search_text":"Let's now start working on an example by choosing the most simple type of one-way channel, one that is point-to-point (which directly connects two nodes of the system) and full-duplex (messages can travel in both directions).","text_count":225,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now start working on an example by choosing the most simple type of one-way channel, one that is point-to-point (which directly connects two nodes of the system) and full-duplex (messages can travel in both directions)."}]},{"block_type":"element","block":"k5zy5ctw","search_text":"In the simple channel category, we can find, for example, WebSockets: they establish a point-to-point connection between the server and browser, and the messages can travel in any direction. Another example is the communication channel that is created when a child process is spawned using child_process.fork() ; we should already know about it, we saw this API in Chapter 9, Advanced Asynchronous Recipes . This channel too is asynchronous: it connects the parent only with the child process and it allows messages to travel in any direction. This is probably the most basic channel of this category, so that's what we are going to use in our next example.","text_count":657,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"simple channel"}]},{"block_type":"text","content":"category, we can find, for example, WebSockets: they establish a point-to-point connection between the server and browser, and the messages can travel in any direction. Another example is the communication channel that is created when a child process is spawned using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":"; we should already know about it, we saw this API in Chapter 9,"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Advanced Asynchronous Recipes"}]},{"block_type":"text","content":". This channel too is asynchronous: it connects the parent only with the child process and it allows messages to travel in any direction. This is probably the most basic channel of this category, so that's what we are going to use in our next example."}]},{"block_type":"element","block":"k5zy5ctx","search_text":"The plan for the next application is to build an abstraction in order to wrap the channel created between the parent and child processes. This abstraction should provide a request/reply communication by automatically marking each request with a correlation identifier and then matching the ID of any incoming reply against the list of request handlers awaiting a response.","text_count":372,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The plan for the next application is to build an abstraction in order to wrap the channel created between the parent and child processes. This abstraction should provide a request/reply communication by automatically marking each request with a correlation identifier and then matching the ID of any incoming reply against the list of request handlers awaiting a response."}]},{"block_type":"element","block":"k5zy5cty","search_text":"From Chapter 9, Advanced Asynchronous Recipes , we should remember that the parent process can access the channel with the child using two primitives:","text_count":150,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"From Chapter 9,&nbsp;"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"Advanced Asynchronous Recipes"}]},{"block_type":"text","content":", we should remember that the parent process can access the channel with the child using two primitives:"}]},{"block_type":"element","block":"k5zy5ctz","search_text":"child.send(message) child.on('message',callback) ","text_count":49,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child.send(message)"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child.on('message',callback)"}]}]}]},{"block_type":"element","block":"k5zy5cu0","search_text":"In a similar way, the child can access the channel to the parent process using:","text_count":79,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In a similar way, the child can access the channel to the parent process using:"}]},{"block_type":"element","block":"k5zy5cu1","search_text":"process.send(message) process.on('message',callback) ","text_count":53,"tag_name":"ul","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.send(message)"}]}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"process.on('message',callback)"}]}]}]},{"block_type":"element","block":"k5zy5cu2","search_text":"This means that the interface of the channel available in the parent is identical to the one available in the child; this will allow us to build a common abstraction, so that the requests can be sent from both ends of the channel.","text_count":230,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This means that the interface of the channel available in the parent is identical to the one available in the child; this will allow us to build a common abstraction, so that the requests can be sent from both ends of the channel."}]},{"block_type":"element","block":"k5zy5cu3","search_text":"Abstracting the request","text_count":23,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Abstracting the request"}]},{"block_type":"element","block":"k5zy5cu4","search_text":"Let's start building this abstraction by considering the part responsible for sending new requests; let's create a new file called request.js :","text_count":143,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start building this abstraction by considering the part responsible for sending new requests; let's create a new file called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cu5","search_text":"const uuid = require('node-uuid'); module.exports = channel => { const idToCallbackMap = {}; // [1] channel.on('message', message => { // [2] const handler = idToCallbackMap[message.inReplyTo]; if(handler) { handler(message.data); } }); return function sendRequest(req, callback) { // [3] const correlationId = uuid.v4(); idToCallbackMap[correlationId] = callback; channel.send({ type: 'request', data: req, id: correlationId }); }; }; ","text_count":436,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const uuid = require('node-uuid'); \n \nmodule.exports = channel =&gt; { \n  const idToCallbackMap = {};                           // [1] \n \n  channel.on('message', message =&gt; {                    // [2] \n    const handler = idToCallbackMap[message.inReplyTo]; \n    if(handler) { \n      handler(message.data); \n    } \n  }); \n \n  return function sendRequest(req, callback) {          // [3] \n    const correlationId = uuid.v4(); \n    idToCallbackMap[correlationId] = callback; \n    channel.send({ \n      type: 'request', \n      data: req, \n      id: correlationId \n    }); \n  }; \n};"}]}]},{"block_type":"element","block":"k5zy5cu6","search_text":"This is how our request abstraction works:","text_count":42,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This is how our request abstraction works:"}]},{"block_type":"element","block":"k5zy5cu7","search_text":"The one that follows is a closure created around our request function. The magic of the pattern lies in the idToCallbackMap variable, which stores the association between the outgoing requests and their reply handlers. As soon as the factory is invoked, the first thing we do is start listening for incoming messages. If the correlation ID of the message (contained in the inReplyTo property) matches any of the IDs contained in the idToCallbackMap variable, we know that we just received a reply, so we obtain the reference to the associated response handler and we invoke it with the data contained in the message. Finally, we return the function we will use to send new requests. Its job is to generate a correlation ID using the node-uuid package ( https://npmjs.org/package/node-uuid ) and then wrap the request data in an envelope that allows us to specify the correlation ID and the type of the message. ","text_count":911,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"The one that follows is a closure created around our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request"}]},{"block_type":"text","content":"function. The magic of the pattern lies in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"idToCallbackMap"}]},{"block_type":"text","content":"variable, which stores the association between the outgoing requests and their reply handlers."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"As soon as the factory is invoked, the first thing we do is start listening for incoming messages. If the correlation ID of the message (contained in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inReplyTo"}]},{"block_type":"text","content":"property) matches any of the IDs contained in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"idToCallbackMap"}]},{"block_type":"text","content":"variable, we know that we just received a reply, so we obtain the reference to the associated response handler and we invoke it with the data contained in the message."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Finally, we return the function we will use to send new requests. Its job is to generate a correlation ID using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"node-uuid"}]},{"block_type":"text","content":"package ("},{"block_type":"element","tag_name":"a","attributes":{"href":"https://npmjs.org/package/node-uuid"},"children":[{"block_type":"text","content":"https://npmjs.org/package/node-uuid"}]},{"block_type":"text","content":") and then wrap the request data in an envelope that allows us to specify the correlation ID and the type of the message."}]}]},{"block_type":"element","block":"k5zy5cu8","search_text":"That's it for the request module; let's move to the next part.","text_count":62,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's it for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request"}]},{"block_type":"text","content":"module; let's move to the next part."}]},{"block_type":"element","block":"k5zy5cu9","search_text":"Abstracting the reply","text_count":21,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Abstracting the reply"}]},{"block_type":"element","block":"k5zy5cua","search_text":"We are just a step away from implementing the full pattern, so let's see how the counterpart of the request.js module works. Let's create another file called reply.js , which will contain the abstraction for wrapping the reply handler:","text_count":235,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We are just a step away from implementing the full pattern, so let's see how the counterpart of the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request.js"}]},{"block_type":"text","content":"module works. Let's create another file called"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reply.js"}]},{"block_type":"text","content":", which will contain the abstraction for wrapping the reply handler:"}]},{"block_type":"element","block":"k5zy5cub","search_text":"module.exports = channel => { return function registerHandler(handler) { channel.on('message', message => { if (message.type !== 'request') return; handler(message.data, reply => { channel.send({ type: 'response', data: reply, inReplyTo: message.id }); }); }); }; }; ","text_count":267,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"module.exports = channel =&gt; \n{ \n  return function registerHandler(handler) { \n    channel.on('message', message =&gt; { \n      if (message.type !== 'request') return; \n      handler(message.data, reply =&gt; { \n        channel.send({ \n          type: 'response', \n          data: reply, \n          inReplyTo: message.id \n        }); \n      }); \n    }); \n  }; \n};"}]}]},{"block_type":"element","block":"k5zy5cuc","search_text":"Our reply module is again a factory that returns a function to register new reply handlers. This is what happens when a new handler is registered:","text_count":146,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reply"}]},{"block_type":"text","content":"module is again a factory that returns a function to register new reply handlers. This is what happens when a new handler is registered:"}]},{"block_type":"element","block":"k5zy5cud","search_text":"We start listening for incoming requests and, when we receive one, we immediately invoke the handler by passing the data of the message and a callback function to collect the reply from the handler. Once the handler has done its work, it will invoke the callback that we provided, returning its reply. We then build an envelope by attaching the correlation ID of the request (the inReplyTo property), then we put everything back into the channel. ","text_count":447,"tag_name":"ol","attributes":{},"children":[{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"We start listening for incoming requests and, when we receive one, we immediately invoke the handler by passing the data of the message and a callback function to collect the reply from the handler."}]},{"block_type":"element","tag_name":"li","attributes":{},"children":[{"block_type":"text","content":"Once the handler has done its work, it will invoke the callback that we provided, returning its reply. We then build an envelope by attaching the correlation ID of the request (the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"inReplyTo"}]},{"block_type":"text","content":"property), then we put everything back into the channel."}]}]},{"block_type":"element","block":"k5zy5cue","search_text":"The amazing thing about this pattern is that in Node.js, it comes very easily; everything for us is already asynchronous, so an asynchronous request/reply communication built on top of a one-way channel is not very different from any other asynchronous operation, especially if we build an abstraction to hide its implementation details.","text_count":337,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The amazing thing about this pattern is that in Node.js, it comes very easily; everything for us is already asynchronous, so an asynchronous request/reply communication built on top of a one-way channel is not very different from any other asynchronous operation, especially if we build an abstraction to hide its implementation details."}]},{"block_type":"element","block":"k5zy5cuf","search_text":"Trying the full request/reply cycle","text_count":35,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Trying the full request/reply cycle"}]},{"block_type":"element","block":"k5zy5cug","search_text":"Now we are ready to try our new asynchronous request/reply abstraction. Let's create a sample replier in a file named replier.js :","text_count":130,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we are ready to try our new asynchronous request/reply abstraction. Let's create a sample"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"replier"}]},{"block_type":"text","content":"in a file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"replier.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cuh","search_text":"const reply = require('./reply')(process); reply((req, cb) => { setTimeout(() => { cb({sum: req.a + req.b}); }, req.delay); }); ","text_count":128,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const reply = require('./reply')(process); \n \nreply((req, cb) =&gt; { \n  setTimeout(() =&gt; { \n    cb({sum: req.a + req.b}); \n  }, req.delay); \n});"}]}]},{"block_type":"element","block":"k5zy5cui","search_text":"Our replier simply calculates the sum between the two numbers received and returns the result after a certain delay (which is also specified in the request). This will allow us to verify that the order of the responses can also be different from the order in which we sent the requests, to confirm that our pattern is working.","text_count":326,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our replier simply calculates the sum between the two numbers received and returns the result after a certain delay (which is also specified in the request). This will allow us to verify that the order of the responses can also be different from the order in which we sent the requests, to confirm that our pattern is working."}]},{"block_type":"element","block":"k5zy5cuj","search_text":"The final step to complete the sample is to create the requestor in a file named requestor.js , which also has the task of starting the replier using child_process.fork() :","text_count":172,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The final step to complete the sample is to create the requestor in a file named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"requestor.js"}]},{"block_type":"text","content":", which also has the task of starting the replier using"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"child_process.fork()"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cuk","search_text":"const replier = require('child_process') .fork(`${__dirname}/replier.js`; const request = require('./request')(replier); request({a: 1, b: 2, delay: 500}, res => { console.log('1 + 2 = ', res.sum); replier.disconnect(); }); request({a: 6, b: 1, delay: 100}, res => { console.log('6 + 1 = ', res.sum); }); ","text_count":305,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const replier = require('child_process') \n                .fork(`${__dirname}/replier.js`; \nconst request = require('./request')(replier); \n \nrequest({a: 1, b: 2, delay: 500}, res =&gt; { \n  console.log('1 + 2 = ', res.sum); \n  replier.disconnect(); \n}); \n \nrequest({a: 6, b: 1, delay: 100}, res =&gt; { \n  console.log('6 + 1 = ', res.sum); \n});"}]}]},{"block_type":"element","block":"k5zy5cul","search_text":"The requestor starts the replier and then passes its reference to our request abstraction. We then run a couple of sample requests and verify that the correlation with the response they receive is right.","text_count":203,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The requestor starts the replier and then passes its reference to our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request"}]},{"block_type":"text","content":"abstraction. We then run a couple of sample requests and verify that the correlation with the response they receive is right."}]},{"block_type":"element","block":"k5zy5cum","search_text":"To try out the sample, simply launch the requestor.js module; the output should be something similar to the following:","text_count":118,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To try out the sample, simply launch the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"requestor.js"}]},{"block_type":"text","content":"module; the output should be something similar to the following:"}]},{"block_type":"element","block":"k5zy5cun","search_text":"6 + 1 = 7 1 + 2 = 3 ","text_count":20,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"6 + 1 =  7\n1 + 2 =  3"}]}]},{"block_type":"element","block":"k5zy5cuo","search_text":"This confirms that our pattern works perfectly well and that the replies are correctly associated with their own requests, no matter in what order they are sent or received.","text_count":173,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This confirms that our pattern works perfectly well and that the replies are correctly associated with their own requests, no matter in what order they are sent or received."}]},{"block_type":"element","block":"k5zy5cup","search_text":"Return address","text_count":14,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Return address"}]},{"block_type":"element","block":"k5zy5cuq","search_text":"The correlation identifier is the fundamental pattern for creating a request/reply communication on top of a one-way channel; however, it's not enough when our messaging architecture has more than one channel or queue, or when there can be potentially more than one requestor. In these situations, in addition to a correlation ID, we also need to know the return address , a piece of information which allows the replier to send the response back to the original sender of the request.","text_count":485,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The correlation identifier is the fundamental pattern for creating a request/reply communication on top of a one-way channel; however, it's not enough when our messaging architecture has more than one channel or queue, or when there can be potentially more than one requestor. In these situations, in addition to a correlation ID, we also need to know the"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"return address"}]},{"block_type":"text","content":", a piece of information which allows the replier to send the response back to the original sender of the request."}]},{"block_type":"element","block":"k5zy5cur","search_text":"Implementing the return address pattern in AMQP","text_count":47,"tag_name":"h3","attributes":{},"children":[{"block_type":"text","content":"Implementing the return address pattern in AMQP"}]},{"block_type":"element","block":"k5zy5cus","search_text":"In AMQP, the return address is the queue where the requestor is listening for incoming replies. Because the response is meant to be received by only one requestor, it's important that the queue is private and not shared across different consumers. From these properties, we can infer that we are going to need a transient queue, scoped to the connection of the requestor and that the replier has to establish a point-to-point communication with the return queue, to be able to deliver its responses.","text_count":499,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In AMQP, the return address is the queue where the requestor is listening for incoming replies. Because the response is meant to be received by only one requestor, it's important that the queue is private and not shared across different consumers. From these properties, we can infer that we are going to need a transient queue, scoped to the connection of the requestor and that the replier has to establish a point-to-point communication with the return queue, to be able to deliver its responses."}]},{"block_type":"element","block":"k5zy5cut","search_text":"The following image gives us an example of this scenario:","text_count":57,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The following image gives us an example of this scenario:"}]},{"block_type":"element","block":"k5zy5cuu","search_text":"","text_count":0,"tag_name":"p","attributes":{"class":"f-center"},"children":[{"block_type":"element","tag_name":"img","attributes":{"src":"https://learnable-static.s3.amazonaws.com/premium/reeedr/books/node-js/images/000071.jpg","alt":"Implementing the return address pattern in AMQP","class":"lazyload"},"children":[]}]},{"block_type":"element","block":"k5zy5cuv","search_text":"To create a request/reply pattern on top of AMQP, all that we need to do is to specify the name of the response queue in the message properties; this way, the replier knows where the response message has to be delivered. The theory seems very straightforward, so let's see how to implement this in a real application.","text_count":317,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"To create a request/reply pattern on top of AMQP, all that we need to do is to specify the name of the response queue in the message properties; this way, the replier knows where the response message has to be delivered. The theory seems very straightforward, so let's see how to implement this in a real application."}]},{"block_type":"element","block":"k5zy5cuw","search_text":"Implementing the request abstraction","text_count":36,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing the request abstraction"}]},{"block_type":"element","block":"k5zy5cux","search_text":"Let's now build a request/reply abstraction on top of AMQP. We will use RabbitMQ as a broker, but any compatible AMQP broker should do the job. Let's start with the request abstraction (implemented in the amqpRequest.js module); we will show here only the relevant parts.","text_count":271,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's now build a request/reply abstraction on top of AMQP. We will use RabbitMQ as a broker, but any compatible AMQP broker should do the job. Let's start with the request abstraction (implemented in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"amqpRequest.js"}]},{"block_type":"text","content":"module); we will show here only the relevant parts."}]},{"block_type":"element","block":"k5zy5cuy","search_text":"The first interesting thing to observe is how we create the queue to hold the responses; this is the code responsible for that:","text_count":127,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The first interesting thing to observe is how we create the queue to hold the responses; this is the code responsible for that:"}]},{"block_type":"element","block":"k5zy5cuz","search_text":"channel.assertQueue('', {exclusive: true}); ","text_count":44,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"channel.assertQueue('', {exclusive: true});"}]}]},{"block_type":"element","block":"k5zy5cv0","search_text":"When we create the queue, we don't specify any name, which means that a random one will be chosen for us; in addition to this, the queue is exclusive , which means that it's bound to the active AMQP connection and it will be destroyed when the connection closes. There is no need to bind the queue to an exchange, as we don't need any routing or distribution to the multiple queues; this means that the messages have to be delivered straight into our response queue.","text_count":466,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When we create the queue, we don't specify any name, which means that a random one will be chosen for us; in addition to this, the queue is"},{"block_type":"element","tag_name":"em","attributes":{},"children":[{"block_type":"text","content":"exclusive"}]},{"block_type":"text","content":", which means that it's bound to the active AMQP connection and it will be destroyed when the connection closes. There is no need to bind the queue to an exchange, as we don't need any routing or distribution to the multiple queues; this means that the messages have to be delivered straight into our response queue."}]},{"block_type":"element","block":"k5zy5cv1","search_text":"Next, let's see how we can generate a new request:","text_count":50,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Next, let's see how we can generate a new request:"}]},{"block_type":"element","block":"k5zy5cv2","search_text":"classAMQPRequest { //... request(queue, message, callback) { const id = uuid.v4(); this.idToCallbackMap[id] = callback; this.channel.sendToQueue(queue,new Buffer(JSON.stringify(message)), {correlationId: id, replyTo: this.replyQueue} ); } } ","text_count":241,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"classAMQPRequest { \n  //... \n  request(queue, message, callback) { \n    const id = uuid.v4(); \n    this.idToCallbackMap[id] = callback; \n    this.channel.sendToQueue(queue,new Buffer(JSON.stringify(message)), \n      {correlationId: id, replyTo: this.replyQueue} \n    ); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5cv3","search_text":"The request() method accepts as input, the name of the request queue and the message to send. As we learned in the previous section, we need to generate a correlation ID and associate it to the callback function. Finally, we send the message, specifying the correlationId and the replyTo property as metadata.","text_count":309,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"request()"}]},{"block_type":"text","content":"method accepts as input, the name of the request&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"queue"}]},{"block_type":"text","content":"and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"message"}]},{"block_type":"text","content":"to send. As we learned in the previous section, we need to generate a correlation ID and associate it to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"callback"}]},{"block_type":"text","content":"function. Finally, we send the message, specifying the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"correlationId"}]},{"block_type":"text","content":"and the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"replyTo"}]},{"block_type":"text","content":"property as metadata."}]},{"block_type":"element","block":"k5zy5cv4","search_text":"It's interesting to see that for sending the message we are using the channel.sentToQueue() API instead of channel.publish() ; this is because we are not interested in implementing any publish/subscribe distribution using exchanges, but a more basic point-to-point delivery straight into the destination queue.","text_count":310,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's interesting to see that for sending the message we are using the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"channel.sentToQueue()"}]},{"block_type":"text","content":"API instead of"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"channel.publish()"}]},{"block_type":"text","content":"; this is because we are not interested in implementing any publish/subscribe distribution using exchanges, but a more basic point-to-point delivery straight into the destination queue."}]},{"block_type":"element","block":"k5zy5cv5","search_text":"Tip In AMQP, we can specify a set of properties (or metadata) to be passed to the consumer, together with the main message. ","text_count":124,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In AMQP, we can specify a set of properties (or metadata) to be passed to the consumer, together with the main message."}]}]},{"block_type":"element","block":"k5zy5cv6","search_text":"The last important piece of our amqpRequest prototype is where we listen for incoming responses:","text_count":96,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"The last important piece of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"amqpRequest"}]},{"block_type":"text","content":"prototype is where we listen for incoming responses:"}]},{"block_type":"element","block":"k5zy5cv7","search_text":"_listenForResponses() { return this.channel.consume(this.replyQueue, msg => { const correlationId = msg.properties.correlationId; const handler = this.idToCallbackMap[correlationId]; if (handler) { handler(JSON.parse(msg.content.toString())); } }, {noAck: true}); } ","text_count":266,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"_listenForResponses() { \n    return this.channel.consume(this.replyQueue, msg =&gt; { \n      const correlationId = msg.properties.correlationId; \n      const handler = this.idToCallbackMap[correlationId]; \n      if (handler) { \n        handler(JSON.parse(msg.content.toString())); \n      } \n    }, {noAck: true}); \n  }"}]}]},{"block_type":"element","block":"k5zy5cv8","search_text":"In the preceding code, we listen for messages on the queue we created explicitly for receiving responses, then for each incoming message we read the correlation ID and we match it against the list of handlers awaiting a reply. Once we have the handler, we only need to invoke it by passing the reply message.","text_count":308,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"In the preceding code, we listen for messages on the queue we created explicitly for receiving responses, then for each incoming message we read the correlation ID and we match it against the list of handlers awaiting a reply. Once we have the handler, we only need to invoke it by passing the reply message."}]},{"block_type":"element","block":"k5zy5cv9","search_text":"Implementing the reply abstraction","text_count":34,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing the reply abstraction"}]},{"block_type":"element","block":"k5zy5cva","search_text":"That's it for the amqpRequest module; now it's time to implement the response abstraction in a new module named amqpReply.js .","text_count":126,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"That's it for the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"amqpRequest"}]},{"block_type":"text","content":"module; now it's time to implement the response abstraction in a new module named"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"amqpReply.js"}]},{"block_type":"text","content":"."}]},{"block_type":"element","block":"k5zy5cvb","search_text":"Here, we have to create the queue that will receive the incoming requests; we can use a simple durable queue for this purpose. We won't show this part, since it's again all AMQP boilerplate. What we are interested in seeing instead is how we handle a request and then send it back to the right queue:","text_count":300,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Here, we have to create the queue that will receive the incoming requests; we can use a simple durable queue for this purpose. We won't show this part, since it's again all AMQP boilerplate. What we are interested in seeing instead is how we handle a request and then send it back to the right queue:"}]},{"block_type":"element","block":"k5zy5cvc","search_text":"class AMQPReply { //... handleRequest(handler) { return this.channel.consume(this.queue, msg => { const content = JSON.parse(msg.content.toString()); handler(content, reply => { this.channel.sendToQueue( msg.properties.replyTo, new Buffer(JSON.stringify(reply)), {correlationId: msg.properties.correlationId} ); this.channel.ack(msg); }); }); } } ","text_count":347,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"class AMQPReply { \n  //... \n \n  handleRequest(handler) { \n    return this.channel.consume(this.queue, msg =&gt; { \n      const content = JSON.parse(msg.content.toString()); \n      handler(content, reply =&gt; { \n        this.channel.sendToQueue( \n          msg.properties.replyTo, \n          new Buffer(JSON.stringify(reply)), \n          {correlationId: msg.properties.correlationId} \n        ); \n        this.channel.ack(msg); \n      }); \n    }); \n  } \n}"}]}]},{"block_type":"element","block":"k5zy5cvd","search_text":"When sending back a reply, we use channel.sendToQueue() to publish the message straight into the queue specified in the replyTo property of the message (our return address). Another important task of our amqpReply object is to set a correlationId in the reply, so that the receiver can match the message with the list of pending requests.","text_count":338,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"When sending back a reply, we use"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"channel.sendToQueue()"}]},{"block_type":"text","content":"to publish the message straight into the queue specified in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"replyTo"}]},{"block_type":"text","content":"property of the message (our return address). Another important task of our"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"amqpReply"}]},{"block_type":"text","content":"object is to set a"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"correlationId"}]},{"block_type":"text","content":"in the reply, so that the receiver can match the message with the list of pending requests."}]},{"block_type":"element","block":"k5zy5cve","search_text":"Implementing the requestor and the replier","text_count":42,"tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Implementing the requestor and the replier"}]},{"block_type":"element","block":"k5zy5cvf","search_text":"Everything is now ready to give our system a try, but first, let's build a sample requestor and replier to see how to use our new abstraction.","text_count":142,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Everything is now ready to give our system a try, but first, let's build a sample requestor and replier to see how to use our new abstraction."}]},{"block_type":"element","block":"k5zy5cvg","search_text":"Let's start from the module replier.js :","text_count":40,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Let's start from the module"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"replier.js"}]},{"block_type":"text","content":":"}]},{"block_type":"element","block":"k5zy5cvh","search_text":"const Reply = require('./amqpReply'); const reply = Reply('requests_queue'); reply.initialize().then(() => { reply.handleRequest((req, cb) => { console.log('Request received', req); cb({sum: req.a + req.b}); }); }); ","text_count":216,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const Reply = require('./amqpReply'); \nconst reply = Reply('requests_queue'); \n \nreply.initialize().then(() =&gt; { \n  reply.handleRequest((req, cb) =&gt; { \n    console.log('Request received', req); \n    cb({sum: req.a + req.b}); \n  }); \n});"}]}]},{"block_type":"element","block":"k5zy5cvi","search_text":"It's nice to see how the abstraction we built allows us to hide all the mechanisms that handle the correlation ID and the return address; all we need to do is to initialize a new reply object, specifying the name of the queue where we want to receive our requests ( 'requests_queue' ). The rest of the code is just trivial; our sample replier simply calculates the sum of the two numbers received as input and sends back the result using the provided callback.","text_count":460,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"It's nice to see how the abstraction we built allows us to hide all the mechanisms that handle the correlation ID and the return address; all we need to do is to initialize a new"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"reply"}]},{"block_type":"text","content":"object, specifying the name of the queue where we want to receive our requests ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"'requests_queue'"}]},{"block_type":"text","content":"). The rest of the code is just trivial; our sample replier simply calculates the sum of the two numbers received as input and sends back the result using the provided callback."}]},{"block_type":"element","block":"k5zy5cvj","search_text":"On the other side, we have a sample requestor implemented in the requestor.js file:","text_count":83,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"On the other side, we have a sample requestor implemented in the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"requestor.js"}]},{"block_type":"text","content":"file:"}]},{"block_type":"element","block":"k5zy5cvk","search_text":"const req = require('./amqpRequest')(); req.initialize().then(() => { for (let i = 100; i> 0; i--) { sendRandomRequest(); } }); function sendRandomRequest() { const a = Math.round(Math.random() * 100); const b = Math.round(Math.random() * 100); req.request('requests_queue', {a: a, b: b}, res => { console.log(`${a} + ${b} = ${res.sum}`); } ); } ","text_count":346,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"const req = require('./amqpRequest')(); \n \nreq.initialize().then(() =&gt; { \n  for (let i = 100; i&gt; 0; i--) { \n    sendRandomRequest(); \n  } \n}); \n \nfunction sendRandomRequest() { \n  const a = Math.round(Math.random() * 100); \n  const b = Math.round(Math.random() * 100); \n  req.request('requests_queue', {a: a, b: b},  \n    res =&gt; { \n      console.log(`${a} + ${b} = ${res.sum}`); \n    } \n  ); \n}"}]}]},{"block_type":"element","block":"k5zy5cvl","search_text":"Our sample requestor sends 100 random requests to the requests_queue queue. In this case too, it's interesting to see that our abstraction is doing its job perfectly, hiding all the details of the asynchronous request/reply pattern.","text_count":232,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Our sample requestor sends 100 random requests to the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"requests_queue"}]},{"block_type":"text","content":"&nbsp;queue. In this case too, it's interesting to see that our abstraction is doing its job perfectly, hiding all the details of the asynchronous request/reply pattern."}]},{"block_type":"element","block":"k5zy5cvm","search_text":"Now, to try out the system, simply run the replier module followed by the requestor module:","text_count":91,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now, to try out the system, simply run the"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"replier"}]},{"block_type":"text","content":"module followed by the&nbsp;"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"requestor"}]},{"block_type":"text","content":"module:"}]},{"block_type":"element","block":"k5zy5cvn","search_text":"node replier node requestor ","text_count":28,"tag_name":"pre","attributes":{},"children":[{"block_type":"element","tag_name":"code","attributes":{"language":"python"},"children":[{"block_type":"text","content":"node replier\nnode requestor"}]}]},{"block_type":"element","block":"k5zy5cvo","search_text":"We will see a set of operations published by the requestor and then received by the replier, which in turn will send back the responses.","text_count":136,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We will see a set of operations published by the requestor and then received by the replier, which in turn will send back the responses."}]},{"block_type":"element","block":"k5zy5cvp","search_text":"Now we can try other experiments. Once the replier is started for the first time, it creates a durable queue; this means that, if we now stop it and then run the requestor again, no request will be lost. All the messages will be stored in the queue until the replier is started again!","text_count":284,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Now we can try other experiments. Once the replier is started for the first time, it creates a durable queue; this means that, if we now stop it and then run the requestor again, no request will be lost. All the messages will be stored in the queue until the replier is started again!"}]},{"block_type":"element","block":"k5zy5cvq","search_text":"Another nice feature that we get for free using AMQP is the fact that our replier is scalable out-of-the-box. To test this assumption, we can try to start two or more instances of the replier, and watch the requests being load balanced between them. This works because, every time a requestor starts, it attaches itself as a listener to the same durable queue, and as a result, the broker will load balance the messages across all the consumers of the queue (competing consumers pattern). Sweet!","text_count":495,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"Another nice feature that we get for free using AMQP is the fact that our replier is scalable out-of-the-box. To test this assumption, we can try to start two or more instances of the replier, and watch the requests being load balanced between them. This works because, every time a requestor starts, it attaches itself as a listener to the same durable queue, and as a result, the broker will load balance the messages across all the consumers of the queue (competing consumers pattern). Sweet!"}]},{"block_type":"element","block":"k5zy5cvr","search_text":"Tip ØMQ has a pair of sockets specifically meant for implementing request/reply patterns ( REQ / REP ); however, they are synchronous (only one request/response at a time). More complex request/reply patterns are possible with more sophisticated techniques. For more information, you can read the official guide at http://zguide.zeromq.org/page:all#advanced-request-reply . ","text_count":374,"tag_name":"div","attributes":{"class":"box tip"},"children":[{"block_type":"element","tag_name":"h4","attributes":{},"children":[{"block_type":"text","content":"Tip"}]},{"block_type":"element","tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"&Oslash;MQ has a pair of sockets specifically meant for implementing request/reply patterns ("},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"REQ"}]},{"block_type":"text","content":"/"},{"block_type":"element","tag_name":"code","attributes":{},"children":[{"block_type":"text","content":"REP"}]},{"block_type":"text","content":"); however, they are synchronous (only one request/response at a time). More complex request/reply patterns are possible with more sophisticated techniques. For more information, you can read the official guide at"},{"block_type":"element","tag_name":"a","attributes":{"href":"http://zguide.zeromq.org/page:all#advanced-request-reply"},"children":[{"block_type":"text","content":"http://zguide.zeromq.org/page:all#advanced-request-reply"}]},{"block_type":"text","content":"."}]}]},{"block_type":"element","block":"k5zy5cvs","search_text":"Summary","text_count":7,"tag_name":"h2","attributes":{},"children":[{"block_type":"text","content":"Summary"}]},{"block_type":"element","block":"k5zy5cvt","search_text":"We have reached the end of this chapter. Here, we learned the most important messaging and integration patterns and the role they play in the design of distributed systems. We made our acquaintance with the three major types of message exchange patterns: publish/subscribe, pipelines, and request/reply, and we saw how they can be implemented using a peer-to-peer architecture or a message broker. We analyzed their pros and cons, and we saw that by using AMQP and a fully-fledged message broker, we can implement reliable and scalable applications with little developmental effort but at a cost of having one more system to maintain and scale. Also, we saw how ØMQ allows us to build distributed systems where we can have total control over every aspect of the architecture, fine tuning its properties around our very own requirements.","text_count":836,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"We have reached the end of this chapter. Here, we learned the most important messaging and integration patterns and the role they play in the design of distributed systems. We made our acquaintance with the three major types of message exchange patterns: publish/subscribe, pipelines, and request/reply, and we saw how they can be implemented using a peer-to-peer architecture or a message broker. We analyzed their pros and cons, and we saw that by using AMQP and a fully-fledged message broker, we can implement reliable and scalable applications with little developmental effort but at a cost of having one more system to maintain and scale. Also, we saw how &Oslash;MQ allows us to build distributed systems where we can have total control over every aspect of the architecture, fine tuning its properties around our very own requirements."}]},{"block_type":"element","block":"k5zy5cvu","search_text":"This chapter also closes the book; by now, we should have a tool belt full of patterns and techniques we can go and apply in our projects. We should also have a deeper understanding of how Node.js development works and what its strengths and weaknesses are. Throughout the book, we also had the chance to work with a myriad of packages and solutions developed by many extraordinary developers. In the end, this is the most beautiful aspect of Node.js: its people, a community where everybody plays their part in giving back something.","text_count":534,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"This chapter also closes the book; by now, we should have a tool belt full of patterns and techniques we can go and apply in our projects. We should also have a deeper understanding of how Node.js development works and what its strengths and weaknesses are. Throughout the book, we also had the chance to work with a myriad of packages and solutions developed by many extraordinary developers. In the end, this is the most beautiful aspect of Node.js: its people, a community where everybody plays their part in giving back something."}]},{"block_type":"element","block":"k5zy5cvv","search_text":"I hope you enjoyed our small contribution.","text_count":42,"tag_name":"p","attributes":{},"children":[{"block_type":"text","content":"I hope you enjoyed our small contribution."}]}]}]}